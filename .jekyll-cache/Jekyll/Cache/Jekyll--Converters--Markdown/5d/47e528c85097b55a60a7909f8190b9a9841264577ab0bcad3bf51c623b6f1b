I"…‡<h1 id="1-actor-askä»‹ç»">1. Actor askä»‹ç»</h1>

<p>ä¸å¤–éƒ¨çš„Ackorè¿›è¡Œäº¤äº’ï¼Œå¯ä»¥ä½¿ç”¨sendå‘é€åä¸ç®¡ï¼Œå‰é¢æ–‡ç« å·²ç»ä»‹ç»sendäº¤äº’æ–¹å¼ï¼Œsendä¸ºæœ€å¸¸ç”¨çš„äº¤äº’æ–¹å¼å‘é€åä¸ç®¡ï¼Œä½†æ˜¯è¿™é‡Œéœ€è¦ç»™å¤–éƒ¨Actorå‘ç”Ÿä¸€ä¸ªæ¶ˆæ¯ï¼Œå¹¶è¦æ±‚è¿”å›CompletionState[Response]ã€‚ä¸ºæ­¤æˆ‘ä»¬ä½¿ç”¨akka.actor.type.javadsl.askpattern.askã€‚è¯·æ±‚å‘é€ä¸€æ¡æ¶ˆæ¯ç»™ä¸€ä¸ªActorå¹¶è·å¾—ä¸€ä¸ªCompletionState[Response] è¿”å›ã€‚å¯é€šè¿‡å¯è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœåœ¨å¦‚æœæ—¶é—´å†…æ²¡æœ‰å“åº”åˆ™è¿”å›çš„å¤±è´¥CompletionStageã€‚</p>

<dl>
  <dt>å®ä¾‹æµç¨‹å›¾</dt>
  <dd><img src="https://liulv.work/images/img/20200805213553.png" alt="20200805213553" /></dd>
</dl>

<h1 id="2-ä½¿ç”¨åœºæ™¯å’Œç¼ºé™·">2. ä½¿ç”¨åœºæ™¯å’Œç¼ºé™·</h1>

<dl>
  <dt>é€‚ç”¨åœºæ™¯</dt>
  <dd>ä»Actorç³»ç»Ÿå¤–éƒ¨æŸ¥è¯¢Actor</dd>
  <dt>ç¼ºé™·å’Œé—®é¢˜</dt>
  <dd>
    <ul>
      <li>åœ¨è¿”å›çš„CompletionStageä¸Šçš„å›è°ƒå¾ˆå®¹æ˜“æ„å¤–åœ°å…³é—­å’Œä¸å®‰å…¨çš„å¯å˜çŠ¶æ€ï¼Œå› ä¸ºè¿™äº›å›è°ƒå°†åœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚</li>
    </ul>
  </dd>
  <dd>
    <ul>
      <li>å¯¹ä¸€ä¸ªè¯·æ±‚åªèƒ½æœ‰ä¸€ä¸ªå•ä¸€çš„å“åº”(å‚è§<a href="https://doc.akka.io/docs/akka/current/typed/interaction-patterns.html#per-session-child-actor">æ¯ä¸ªä¼šè¯child Actor</a>)ã€‚</li>
    </ul>
  </dd>
  <dd>
    <ul>
      <li>å½“è¯·æ±‚è¶…æ—¶æ—¶ï¼Œæ¥æ”¶æ–¹å¹¶ä¸çŸ¥é“ï¼Œå¯èƒ½ä»ç„¶å¤„ç†å®ƒç›´åˆ°å®Œæˆï¼Œç”šè‡³åœ¨äº‹åå¼€å§‹å¤„ç†å®ƒã€‚</li>
    </ul>
  </dd>
</dl>

<h1 id="3-ä½¿ç”¨ç¤ºä¾‹">3. ä½¿ç”¨ç¤ºä¾‹</h1>

<h2 id="31-è€ç‰ˆæœ¬abstractactor">3.1. è€ç‰ˆæœ¬AbstractActor</h2>

<p>åœ¨åˆ›å»ºActorSystemçš„ç±»æ·»åŠ æ ¹æ®æŒ‡å®šåœ°å€æ„é€ Actoræ–¹æ³•ï¼Œè¿”å›ActorSelection</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>
 <span class="kd">public</span> <span class="kd">static</span> <span class="nc">ActorSystem</span> <span class="n">actorSystem</span><span class="o">;</span>

 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>

     <span class="nc">Config</span> <span class="n">akkaBasicConfig</span> <span class="o">=</span> <span class="nc">ConfigFactory</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="s">"oms-server.akka.conf"</span><span class="o">);</span>
     <span class="n">actorSystem</span> <span class="o">=</span> <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">"oms-server"</span><span class="o">,</span> <span class="n">akkaBasicConfig</span><span class="o">);</span>
 <span class="o">}</span>

 <span class="kd">public</span> <span class="kd">static</span> <span class="nc">ActorSelection</span> <span class="nf">getFriendActor</span><span class="o">(</span><span class="nc">String</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"akka://%s@%s/user/%s"</span><span class="o">,</span> <span class="s">"oms-server"</span><span class="o">,</span> <span class="n">address</span><span class="o">,</span> <span class="s">"friend_actor"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">actorSystem</span><span class="o">.</span><span class="na">actorSelection</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è·å–è¿œç¨‹Actor</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">ActorSelection</span> <span class="n">serverActor</span> <span class="o">=</span> <span class="nc">OhMyServer</span><span class="o">.</span><span class="na">getFriendActor</span><span class="o">(</span><span class="n">serverAddress</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Actor ask</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nc">Ping</span> <span class="n">ping</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Ping</span><span class="o">();</span>
<span class="n">ping</span><span class="o">.</span><span class="na">setCurrentTime</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
<span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">askCS</span> <span class="o">=</span> <span class="nc">Patterns</span><span class="o">.</span><span class="na">ask</span><span class="o">(</span><span class="n">serverActor</span><span class="o">,</span> <span class="n">ping</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">ofMillis</span><span class="o">(</span><span class="mi">1000</span><span class="o">));</span>
<span class="nc">AskResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="nc">AskResponse</span><span class="o">)</span> <span class="n">askCS</span><span class="o">.</span><span class="na">toCompletableFuture</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">1000</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>

<span class="c1">//downServerCache.remove(serverAddress);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="32-æ–°ç‰ˆæœ¬abstractbehavior">3.2. æ–°ç‰ˆæœ¬AbstractBehavior</h2>

<p>æˆ‘ä»¬ä½¿ç”¨akka.actor.type.javadsl.askpattern.askè¯·æ±‚å‘é€ä¸€æ¡æ¶ˆæ¯ç»™ä¸€ä¸ªActorå¹¶è·å¾—ä¸€ä¸ªCompletionState[Response] è¿”å›ã€‚</p>

<p><img src="https://liulv.work/images/img/20200805213553.png" alt="20200805213553" /></p>

<p><strong>æ„å»ºActorå¤„ç†askè¯·æ±‚ï¼Œå“åº”æ¶ˆæ¯</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.tcfuture.akka.actor.interactionpatterns.ask</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.Behavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.AbstractBehavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.ActorContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Behaviors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Receive</span><span class="o">;</span>

<span class="cm">/**
 * @author liulv
 *
 * GiveMeCookiesè¯·æ±‚å¯ä»¥ç”¨cookieæˆ–InvalidRequestè¿›è¡Œå“åº”ã€‚è¯·æ±‚è€…å¿…é¡»å†³å®šå¦‚ä½•å¤„ç†InvalidRequeståº”ç­”ã€‚
 * æœ‰æ—¶åº”è¯¥å°†å…¶è§†ä¸ºå¤±è´¥çš„æœªæ¥ï¼Œå› æ­¤å¯ä»¥å°†åº”ç­”æ˜ å°„åˆ°è¯·æ±‚è€…ç«¯ã€‚è¿˜è¯·å‚é˜…é€šç”¨å“åº”åŒ…è£…å™¨ï¼Œäº†è§£æˆåŠŸæˆ–é”™è¯¯çš„å“åº”ã€‚
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CookieFabric</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">GiveMeCookies</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">GiveMeCookies</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * å›å¤æ¶ˆæ¯æ¥å£
     */</span>
    <span class="kd">interface</span> <span class="nc">Reply</span> <span class="o">{}</span>

    <span class="cm">/**
     * å›å¤æ¶ˆæ¯-Cookieæ•°é‡
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Cookies</span> <span class="kd">implements</span> <span class="nc">Reply</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Cookies</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * å›å¤æ¶ˆæ¯-æ— æ•ˆçš„è¯·æ±‚
     *
     * æ— æ•ˆè¯·æ±‚åŸå› 
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">InvalidRequest</span> <span class="kd">implements</span> <span class="nc">Reply</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">reason</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">InvalidRequest</span><span class="o">(</span><span class="nc">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reason</span> <span class="o">=</span> <span class="n">reason</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * åˆ›å»ºActorå…¥å£æ–¹æ³•
     *
     * @return Behavior&lt;Command&gt;
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">CookieFabric:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nf">CookieFabric</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">GiveMeCookies</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onGiveMeCookies</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * å¤„ç†GiveMeCookiesæ¶ˆæ¯ï¼Œè¿”å›Cookiesä¿¡æ¯ï¼Œå¦‚æœè¶…è¿‡è¶…è¿‡5æ¬¡åè¿”å›æ— æ•ˆçš„è¯·æ±‚InvalidRequest
     *
     * @param request GiveMeCookies
     * @return è¿”å›å¯¹åº”è¡Œä¸º
     */</span>
    <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onGiveMeCookies</span><span class="o">(</span><span class="nc">GiveMeCookies</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">count</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="o">)</span> <span class="n">request</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">InvalidRequest</span><span class="o">(</span><span class="s">"Too many cookies."</span><span class="o">));</span>
        <span class="k">else</span> <span class="n">request</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Cookies</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">count</span><span class="o">));</span>

        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>æ„å»ºAskè¯·æ±‚å’Œå“åº”å¤„ç†</strong></p>

<p>æ³¨æ„ï¼ŒéªŒè¯é”™è¯¯åœ¨æ¶ˆæ¯åè®®ä¸­ä¹Ÿæ˜¯æ˜¾å¼çš„ã€‚GiveMeCookiesè¯·æ±‚å¯ä»¥ç”¨cookieæˆ–InvalidRequestè¿›è¡Œå“åº”ã€‚è¯·æ±‚è€…å¿…é¡»å†³å®šå¦‚ä½•å¤„ç†InvalidRequeståº”ç­”ã€‚æœ‰æ—¶åº”è¯¥å°†å…¶è§†ä¸ºå¤±è´¥çš„æœªæ¥ï¼Œå› æ­¤å¯ä»¥å°†åº”ç­”æ˜ å°„åˆ°è¯·æ±‚è€…ç«¯ã€‚è¿˜è¯·å‚é˜…<a href="https://doc.akka.io/docs/akka/current/typed/interaction-patterns.html#generic-response-wrapper">é€šç”¨å“åº”åŒ…è£…å™¨</a>ï¼Œäº†è§£æˆåŠŸæˆ–é”™è¯¯çš„å“åº”ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.tcfuture.akka.actor.interactionpatterns.ask</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorSystem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.Behavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.AskPattern</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Behaviors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.Duration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.CompletableFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.CompletionStage</span><span class="o">;</span>

<span class="cm">/**
 * @author liulv
 * @since 1.0.0
 *
 * Actor Askè¯·æ±‚å“åº”ç¤ºä¾‹ä»£ç 
 *
 * æœ‰æ—¶æ‚¨éœ€è¦ä¸actorç³»ç»Ÿå¤–éƒ¨çš„actorè¿›è¡Œäº¤äº’ï¼Œè¿™å¯ä»¥é€šè¿‡å¦‚ä¸Šæ‰€è¿°çš„â€œä¸€åŠ³æ°¸é€¸â€æ“ä½œæˆ–é€šè¿‡askè¿”å›açš„å¦ä¸€ä¸ªç‰ˆæœ¬æ¥å®Œæˆï¼Œ
 * è¯¥å“åº”è¦ä¹ˆæˆåŠŸå®Œæˆï¼Œè¦ä¹ˆå¤±è´¥ï¼Œå¦‚æœæˆåŠŸï¼Œåœ¨æŒ‡å®šçš„è¶…æ—¶æ—¶é—´å†…æ²¡æœ‰å“åº”ã€‚CompletionStage&lt;Response&gt;TimeoutException
 *
 * ä¸ºæ­¤ï¼Œæˆ‘ä»¬ç”¨äºakka.actor.typed.javadsl.AskPattern.askå‘Actorå‘é€æ¶ˆæ¯å¹¶è·å¾—CompletionState[Response]å›å¤ã€‚
 */</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">App</span> <span class="o">{</span>
    <span class="c1">//mainæ–¹æ³•åˆ›å»ºRootBehavior Actor</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ActorSystem</span> <span class="n">actorSystem</span> <span class="o">=</span> <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">RootBehavior</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"RequestResponseAsk"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * è€ŒRootBehavior åˆ›å»ºCookieFabric actorï¼Œ å¹¶ä¸”è°ƒç”¨askè¯·æ±‚å°è£…çš„æ–¹æ³•
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">RootBehavior</span> <span class="o">{</span>
        <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="n">context</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="c1">//åˆ›å»ºCookieFabric Actor</span>
                <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">cookieFabric</span> <span class="o">=</span>
                        <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"CookieFabric"</span><span class="o">);</span>

                <span class="c1">//ask è¯·æ±‚æ–¹æ³•</span>
                <span class="nc">App</span> <span class="n">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">App</span><span class="o">();</span>
                <span class="c1">//æ¯”è¾ƒå…¨çš„å¤„ç†å“åº”</span>
                <span class="c1">//app.askAndMapInvalid(context.getSystem(), cookieFabric);</span>
                <span class="c1">//ç›´æ¥æ‰“å°å¤„ç†</span>
                <span class="n">app</span><span class="o">.</span><span class="na">askAndPrint</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getSystem</span><span class="o">(),</span> <span class="n">cookieFabric</span><span class="o">);</span>

                <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * æ‰§è¡Œaskè¯·æ±‚ï¼Œå¹¶ä¸”å¤„ç†
     *
     * @param system ActorSystem
     * @param cookieFabric CookieFabric Actor
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">askAndMapInvalid</span><span class="o">(</span><span class="nc">ActorSystem</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">system</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">cookieFabric</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// #standalone-ask-fail-future</span>
        <span class="c1">//è®¾ç½® å‚æ•°count &gt;=5 åˆ™æ¨¡æ‹Ÿè¿”å›CookieFabric.InvalidRequest</span>
        <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Reply</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="nc">AskPattern</span><span class="o">.</span><span class="na">ask</span><span class="o">(</span><span class="n">cookieFabric</span><span class="o">,</span>
                <span class="n">replyTo</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="na">GiveMeCookies</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">),</span>
                <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span> <span class="n">system</span><span class="o">.</span><span class="na">scheduler</span><span class="o">());</span>

        <span class="c1">//ask å“åº”ç»“æœä¸­é—´å¤„ç†ï¼Œæ­£å¸¸å“åº”ã€æ¨¡æ‹Ÿå­˜å‚¨å¼‚å¸¸ã€ç›´æ¥æŠ›å‡ºå¼‚å¸¸</span>
        <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Cookies</span><span class="o">&gt;</span> <span class="n">cookies</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">thenCompose</span><span class="o">((</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Reply</span> <span class="n">reply</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">reply</span> <span class="k">instanceof</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Cookies</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">completedFuture</span><span class="o">((</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Cookies</span><span class="o">)</span> <span class="n">reply</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">reply</span> <span class="k">instanceof</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="na">InvalidRequest</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"æ— æ•ˆçš„è¯·æ±‚ï¼ŒåŸå› ï¼š{}"</span><span class="o">,</span> <span class="o">((</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">InvalidRequest</span><span class="o">)</span> <span class="n">reply</span><span class="o">).</span><span class="na">reason</span><span class="o">);</span>
                <span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Cookies</span><span class="o">&gt;</span> <span class="n">failed</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CompletableFuture</span><span class="o">&lt;&gt;();</span>
                <span class="n">failed</span><span class="o">.</span><span class="na">completeExceptionally</span><span class="o">(</span><span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">(((</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">InvalidRequest</span><span class="o">)</span> <span class="n">reply</span><span class="o">).</span><span class="na">reason</span><span class="o">));</span>
                <span class="k">return</span> <span class="n">failed</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Unexpected reply: "</span> <span class="o">+</span> <span class="n">reply</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">});</span>

        <span class="c1">///ask å“åº”ç»“æœå¤„ç†ï¼ŒæˆåŠŸå€¼æ‰“å°ï¼Œæˆ–æ¨¡æ‹Ÿå¤±è´¥æ‰“å°ã€æˆ–è¯·æ±‚è¶…æ—¶æ— å“åº”å¤„ç†ç­‰</span>
        <span class="n">cookies</span><span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">cookiesReply</span><span class="o">,</span> <span class="n">failure</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">cookies</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                <span class="k">if</span><span class="o">(</span><span class="n">cookiesReply</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Yay, "</span> <span class="o">+</span> <span class="n">cookiesReply</span><span class="o">.</span><span class="na">count</span> <span class="o">+</span> <span class="s">" cookies!"</span><span class="o">);</span>
                <span class="k">else</span> <span class="o">{</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="n">failure</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Boo! didn't get cookies in time. "</span> <span class="o">+</span> <span class="n">failure</span><span class="o">);</span>
        <span class="o">});</span>
        <span class="c1">// #standalone-ask-fail-future</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">askAndPrint</span><span class="o">(</span><span class="nc">ActorSystem</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">system</span><span class="o">,</span>
                            <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">cookieFabric</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Reply</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span>
                <span class="nc">AskPattern</span><span class="o">.</span><span class="na">ask</span><span class="o">(</span>
                        <span class="n">cookieFabric</span><span class="o">,</span>
                        <span class="n">replyTo</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="na">GiveMeCookies</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">),</span>
                        <span class="c1">// asking someone requires a timeout and a scheduler, if the timeout hits without</span>
                        <span class="c1">// response the ask is failed with a TimeoutException</span>
                        <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span>
                        <span class="n">system</span><span class="o">.</span><span class="na">scheduler</span><span class="o">());</span>
        <span class="c1">//ä¹Ÿå¯ä»¥ä½¿ç”¨, ä½†æ˜¯ç¬¬äºŒä¸ªå‚æ•°æ˜¯Objectï¼Œä¸æ˜¯Function</span>
        <span class="c1">//CompletionStage&lt;Object&gt; askCS = Patterns.ask(</span>
        <span class="c1">//        cookieFabric,</span>
        <span class="c1">//        new CookieFabric.GiveMeCookies(3, cookieFabric),</span>
        <span class="c1">//        Duration.ofSeconds(3));</span>

        <span class="n">result</span><span class="o">.</span><span class="na">whenComplete</span><span class="o">(</span>
                <span class="o">(</span><span class="n">reply</span><span class="o">,</span> <span class="n">failure</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">reply</span> <span class="k">instanceof</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Cookies</span><span class="o">)</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Yay, "</span> <span class="o">+</span> <span class="o">((</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Cookies</span><span class="o">)</span> <span class="n">reply</span><span class="o">).</span><span class="na">count</span> <span class="o">+</span> <span class="s">" cookies!"</span><span class="o">);</span>
                    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">reply</span> <span class="k">instanceof</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="na">InvalidRequest</span><span class="o">)</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span>
                                <span class="s">"No cookies for me. "</span> <span class="o">+</span> <span class="o">((</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">InvalidRequest</span><span class="o">)</span> <span class="n">reply</span><span class="o">).</span><span class="na">reason</span><span class="o">);</span>
                    <span class="k">else</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Boo! didn't get cookies in time. "</span> <span class="o">+</span> <span class="n">failure</span><span class="o">);</span>
                <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>ä½¿ç”¨åœºæ™¯</strong>
ä»Actorç³»ç»Ÿå¤–éƒ¨æŸ¥è¯¢Actor</p>

<p><strong>å­˜åœ¨é—®é¢˜</strong></p>
<ul>
  <li>åœ¨è¿”å›çš„CompletionStageä¸Šçš„å›è°ƒå¾ˆå®¹æ˜“æ„å¤–åœ°å…³é—­å’Œä¸å®‰å…¨çš„å¯å˜çŠ¶æ€ï¼Œå› ä¸ºè¿™äº›å›è°ƒå°†åœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚</li>
  <li>å¯¹ä¸€ä¸ªè¯·æ±‚åªèƒ½æœ‰ä¸€ä¸ªå•ä¸€çš„å“åº”(å‚è§<a href="https://doc.akka.io/docs/akka/current/typed/interaction-patterns.html#per-session-child-actor">æ¯ä¸ªä¼šè¯child Actor</a>)ã€‚</li>
  <li>å½“è¯·æ±‚è¶…æ—¶æ—¶ï¼Œæ¥æ”¶æ–¹å¹¶ä¸çŸ¥é“ï¼Œå¯èƒ½ä»ç„¶å¤„ç†å®ƒè®¾ç½®çš„è¶…æ—¶æ—¶é—´å†…ç›´åˆ°å®Œæˆï¼Œç”šè‡³åœ¨äº‹åå¼€å§‹å¤„ç†å®ƒä¸å®æ—¶ã€‚</li>
</ul>

:ET