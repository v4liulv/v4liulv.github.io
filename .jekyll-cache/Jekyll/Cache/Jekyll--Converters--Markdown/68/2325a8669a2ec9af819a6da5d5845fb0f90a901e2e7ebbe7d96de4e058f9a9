I"có<h1 id="1-å®‰è£…å¯åŠ¨è®¿é—®">1. å®‰è£…å¯åŠ¨è®¿é—®</h1>

<p><strong>Step 1: ä¸‹è½½</strong></p>

<p>ä¸‹è½½åœ°å€ï¼šhttps://www.apache.org/dyn/closer.cgi?path=/druid/
ä¸‹è½½æœ€æ–°ç‰ˆçš„Druid</p>

<p><strong>Step 2: ä¸Šä¼ å¹¶è§£å‹</strong></p>

<p>ä¸Šä¼ åˆ°éƒ¨ç½²æœåŠ¡å™¨ä¸‹ï¼Œåœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æå–Druid</p>

<p>mkdir /var/lib/druid
tar -xzf apache-druid-0.20.0-bin.tar.gz -C /var/lib/druid</p>

<p><strong>Step 3:è®¾ç½®ç¯å¢ƒå˜é‡</strong></p>

<p>sudo echo â€˜export DRUID_HOME=/var/lib/druidâ€™Â Â» /etc/profile
source /etc/profile</p>

<p><strong>Step 4ï¼šå¯åŠ¨</strong>
cd $DRUID_HOME
./bin/start-micro-quickstart</p>

<p><strong>Step 4ï¼šè®¿é—®Druidæ§åˆ¶å°</strong></p>

<p>å¯ä»¥è®¿é—®http://ip:8888/unified-console.htmlæ¥Druidæ§åˆ¶å°ï¼Œæ§åˆ¶å°ç”±Druid Routerè¿›ç¨‹å¯åŠ¨ã€‚</p>

<h1 id="2-ä»æœ¬åœ°å¯¼å…¥æ•°æ®">2. ä»æœ¬åœ°å¯¼å…¥æ•°æ®</h1>

<h2 id="21-ä½¿ç”¨druidæ§åˆ¶å°-data-loaderæ¥åŠ è½½æ•°æ®">2.1. ä½¿ç”¨Druidæ§åˆ¶å°-Data Loaderæ¥åŠ è½½æ•°æ®</h2>

<p><strong>Step 1ï¼šè¿›å…¥Load data</strong></p>

<p>ç‚¹å‡»æ§åˆ¶å°ä¸­çš„ Load data</p>

<p><img src="https://liulv.work/images/img/20201209161135.png" alt="20201209161135" /></p>

<p><strong>Step 2ï¼šé€‰æ‹©æœ¬åœ°ç£ç›˜</strong></p>

<p>é€‰æ‹© Local disk ç„¶åç‚¹å‡» Connect data</p>

<p><img src="https://liulv.work/images/img/20201209161340.png" alt="20201209161340" /></p>

<p><strong>Step 3: è®¾ç½®Connect</strong></p>

<p>åœ¨ Base directory ä¸­è¾“å…¥ quickstart/tutorial/, åœ¨ File filter ä¸­è¾“å…¥ wikiticker-2015-09-12-sampled.json.gzã€‚ Base directory å’Œ File filter åˆ†å¼€æ˜¯å› ä¸ºå¯èƒ½éœ€è¦åŒæ—¶ä»å¤šä¸ªæ–‡ä»¶ä¸­æ‘„å–æ•°æ®ã€‚ç„¶åç‚¹å‡»applyç¡®ä¿æ‚¨çœ‹åˆ°çš„æ•°æ®æ˜¯æ­£ç¡®çš„ï¼Œå†ç‚¹å‡»Next: Parse data</p>

<p><img src="https://liulv.work/images/img/20201209161603.png" alt="20201209161603" /></p>

<p><img src="https://liulv.work/images/img/20201209161703.png" alt="20201209161703" /></p>

<p><strong>Step 4: è®¾ç½®Parse data</strong></p>

<p>è¾“å…¥æ ¼å¼è®¾ç½®json, ç‚¹å‡»ä¸‹ä¸€æ­¥</p>

<p><img src="https://liulv.work/images/img/20201209161858.png" alt="20201209161858" /></p>

<p><strong>Step 5: è®¾ç½®Parse time</strong></p>

<p>è®¾ç½®çš„åˆ†åŒºåˆ—ï¼Œè¿™æ˜¯é»˜è®¤è®¾ç½®timeåˆ—å³å¯ï¼Œç‚¹å‡»ä¸‹ä¸€æ­¥</p>

<p><img src="https://liulv.work/images/img/20201209162047.png" alt="20201209162047" /></p>

<p><strong>Step 6: è®¾ç½®è½¬æ¢</strong></p>

<p>å¯ç‚¹å‡»å¯¹åº”åˆ—ï¼Œè¿›è¡Œè°ƒæ•´è½¬æ¢ï¼Œè¿™é‡Œä¸éœ€è¦ä»»ä½•è½¬æ¢ï¼Œå¯ç›´æ¥ä¸‹ä¸€æ­¥</p>

<p><img src="https://liulv.work/images/img/20201209162311.png" alt="20201209162311" /></p>

<p><strong>Step 7: è®¾ç½®è¿‡æ»¤</strong></p>

<p>å¯ç‚¹å‡»å¯¹åº”åˆ—è¿›è¡Œè¿‡æ»¤è®¾ç½®ï¼Œè®¾ç½®è¿‡æ»¤å€¼ï¼Œè¿™é‡Œä¸éœ€è¦ä»»ä½•è¿‡æ»¤ï¼Œå¯ç›´æ¥ä¸‹ä¸€æ­¥</p>

<p><img src="https://liulv.work/images/img/20201209162435.png" alt="20201209162435" /></p>

<p><strong>Step 7: è°ƒæ•´schema-åˆ—åå’Œç±»å‹ç­‰</strong></p>

<p>å¯é€‰æ‹©å¯¹åº”åˆ—è¿›è¡Œä¿®æ”¹ï¼Œè¿™é‡Œå…¨éƒ¨ä½¿ç”¨jsoné»˜è®¤çš„ï¼Œå¯ç›´æ¥ä¸‹ä¸€æ­¥</p>

<p><img src="https://liulv.work/images/img/20201209162654.png" alt="20201209162654" /></p>

<p><strong>Step 8: è®¾ç½®åˆ†åŒº</strong></p>

<p>åˆ†åŒºç±»å‹å¯è®¾ç½®ç»Ÿä¸€çš„å’Œä»»æ„çš„ï¼Œè¿™é‡Œè®¾ç½®ç»Ÿä¸€çš„ï¼Œå¹¶ä¸”æŒ‰å¤©è¿›è¡Œåˆ†åŒº</p>

<p><img src="https://liulv.work/images/img/20201209162852.png" alt="20201209162852" /></p>

<p><strong>Step 9: è°ƒä¼˜è®¾ç½®</strong></p>

<p>è¿™é‡Œä¸è¿›è¡Œä»»ä½•ä¼˜åŒ–ï¼Œç›´æ¥ä¸‹ä¸€æ­¥æäº¤</p>

<p><img src="https://liulv.work/images/img/20201209163005.png" alt="20201209163005" /></p>

<p><strong>Step 10: æäº¤è®¾ç½®</strong></p>

<p>ä¿®æ”¹æ•°æ®æºåç§°</p>

<p><img src="https://liulv.work/images/img/20201209163119.png" alt="20201209163119" /></p>

<p><strong>Step 11: ä¿®æ”¹jsonè§„èŒƒ</strong></p>

<p>è¿™é‡Œæš‚æ—¶ä¸éœ€è¦ä¿®æ”¹ï¼Œç›´æ¥æäº¤å³å¯</p>

<p><img src="https://liulv.work/images/img/20201209163217.png" alt="20201209163217" /></p>

<p><strong>Step 12: æäº¤å®Œæˆä¼šè¿›å…¥åˆ°ä»»åŠ¡åˆ—è¡¨</strong></p>

<p><img src="https://liulv.work/images/img/20201209163811.png" alt="20201209163811" /></p>

<p>å¯ç‚¹å‡»è¯¦æƒ…æŒ‰é’®æŸ¥çœ‹è¿è¡Œæƒ…å†µ</p>

<p><img src="https://liulv.work/images/img/20201209163914.png" alt="20201209163914" /></p>

<p><img src="https://liulv.work/images/img/20201209164006.png" alt="20201209164006" /></p>

<p><strong>Step 13: æŸ¥çœ‹æ•°æ®æºå¹¶æŸ¥è¯¢æ•°æ®</strong></p>

<p>ç‚¹å‡»Datasourceæ˜¯å¦å·²ç»æ–°å¢wikiticker-test</p>

<p><img src="https://liulv.work/images/img/20201209164137.png" alt="20201209164137" /></p>

<p>ç‚¹å‡»Queryè¿›è¡Œæ•°æ®æŸ¥è¯¢</p>

<p><img src="https://liulv.work/images/img/20201209164235.png" alt="20201209164235" /></p>

<h2 id="22-ä½¿ç”¨å‘½ä»¤è¡Œæ–¹å¼åŠ è½½æ•°æ®">2.2. ä½¿ç”¨å‘½ä»¤è¡Œæ–¹å¼åŠ è½½æ•°æ®</h2>

<p>ä¸ºäº†æ–¹ä¾¿ï¼Œåœ¨Druidçš„è½¯ä»¶åŒ…ä¸­æä¾›äº†ä¸€ä¸ªæ‰¹æ‘„å–çš„å¸®åŠ©è„šæœ¬ bin/post-index-task</p>

<p>è¯¥è„šæœ¬ä¼šå°†æ•°æ®æ‘„å–ä»»åŠ¡å‘å¸ƒåˆ°Druid Overlordå¹¶è½®è¯¢Druidï¼Œç›´åˆ°å¯ä»¥æŸ¥è¯¢æ•°æ®ä¸ºæ­¢ã€‚</p>

<p>åœ¨Druidæ ¹ç›®å½•è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">bin/post-index-task</span><span class="w"> </span><span class="nt">--file</span><span class="w"> </span><span class="nx">quickstart/tutorial/wikipedia-index.json</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ä»¥ä¸‹çš„è¾“å‡ºï¼š</p>

<pre><code class="language-log">Beginning indexing data for wikipedia
Task started: index_wikipedia_2018-07-27T06:37:44.323Z
Task log:     http://localhost:8081/druid/indexer/v1/task/index_wikipedia_2018-07-27T06:37:44.323Z/log
Task status:  http://localhost:8081/druid/indexer/v1/task/index_wikipedia_2018-07-27T06:37:44.323Z/status
Task index_wikipedia_2018-07-27T06:37:44.323Z still running...
Task index_wikipedia_2018-07-27T06:37:44.323Z still running...
Task finished with status: SUCCESS
Completed indexing data for wikipedia. Now loading indexed data onto the cluster...
wikipedia loading complete! You may now query your data
</code></pre>

<p>æäº¤ä»»åŠ¡è§„èŒƒåï¼Œæ‚¨å¯ä»¥æŒ‰ç…§ä¸Šè¿°ç›¸åŒçš„è§„èŒƒç­‰å¾…æ•°æ®åŠ è½½ç„¶åæŸ¥è¯¢</p>

<h2 id="23-ä½¿ç”¨httpè¯·æ±‚åŠ è½½æ•°æ®">2.3. ä½¿ç”¨HTTPè¯·æ±‚åŠ è½½æ•°æ®</h2>

<p>æˆ‘ä»¬ç®€çŸ­åœ°è®¨è®ºä¸€ä¸‹å¦‚ä½•åœ¨ä¸ä½¿ç”¨è„šæœ¬çš„æƒ…å†µä¸‹æäº¤æ•°æ®æ‘„å–ä»»åŠ¡ï¼Œæ‚¨å°†ä¸éœ€è¦è¿è¡Œè¿™äº›å‘½ä»¤ã€‚</p>

<p>è¦æäº¤ä»»åŠ¡ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªæ–°çš„ç»ˆç«¯ä¸­é€šè¿‡ä»¥ä¸‹æ–¹å¼æäº¤ä»»åŠ¡åˆ°Druidï¼š</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">curl</span><span class="w"> </span><span class="nt">-X</span><span class="w"> </span><span class="s1">'POST'</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="s1">'Content-Type:application/json'</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="err">@</span><span class="nx">quickstart/tutorial/wikipedia-index.json</span><span class="w"> </span><span class="nx">http://localhost:8081/druid/indexer/v1/task</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>å½“ä»»åŠ¡æäº¤æˆåŠŸåä¼šæ‰“å°å‡ºæ¥ä»»åŠ¡çš„ID</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre> {"task":"index_wikipedia_2018-06-09T21:30:32.802Z"}
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ‚¨å¯ä»¥å¦‚ä¸Šæ‰€è¿°ä»æ§åˆ¶å°ç›‘è§†æ­¤ä»»åŠ¡çš„çŠ¶æ€</p>

<h1 id="3-ä»hadoopåŠ è½½æ•°æ®">3. ä»HadoopåŠ è½½æ•°æ®</h1>

<p>æœ¬ç« èŠ‚ä»‹ç»å¦‚ä½•ä½¿ç”¨è¿œç¨‹Hadoopé›†ç¾¤å°†æ•°æ®æ–‡ä»¶åŠ è½½åˆ°Apache Druidä¸­ã€‚</p>

<h2 id="31-å‰æ">3.1. å‰æ</h2>

<p>å·²ç»åœ¨åŒä¸€å¯ä»¥äº’é€šç½‘ç»œ<a href="#å®‰è£…å¯åŠ¨è®¿é—®">å®‰è£…äº†Druid</a>å’Œ<a href="https://liulv.work/2020/12/15/hadoop-install/">å®‰è£…äº†Hadoop</a> å¹¶ä¸”éƒ½å·²ç»å¯åŠ¨</p>

<h2 id="32-æ‹·è´æ•°æ®åˆ°sharedç›®å½•">3.2. æ‹·è´æ•°æ®åˆ°sharedç›®å½•</h2>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">cp</span><span class="w"> </span><span class="nv">$DRUID_HOME</span><span class="nx">/quickstart/tutorial/wikiticker-2015-09-12-sampled.json.gz</span><span class="w"> </span><span class="nx">/tmp/shared/wikiticker-2015-09-12-sampled.json.gz</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="33-è®¾ç½®hadoopç›®å½•">3.3. è®¾ç½®Hadoopç›®å½•</h2>

<p>åœ¨Hadoopå®¹å™¨shellä¸­ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥è®¾ç½®æœ¬æ¬¡æ•™ç¨‹éœ€è¦çš„HDFSç›®å½•ï¼ŒåŒæ—¶æ‹·è´è¾“å…¥æ•°æ®åˆ°HDFSä¸Š</p>

<p>hdfs dfs -mkdir /druid
hdfs dfs -mkdir /druid/segments
hdfs dfs -mkdir /quickstart
hdfs dfs -chmod 777 /druid
hdfs dfs -chmod 777 /druid/segments
hdfs dfs -chmod 777 /quickstart
hdfs dfs -chmod -R 777 /tmp
hdfs dfs -chmod -R 777 /user
hdfs dfs -put /shared/wikiticker-2015-09-12-sampled.json.gz /quickstart/wikiticker-2015-09-12-sampled.json.gz</p>

<h1 id="4-æŸ¥è¯¢æ•°æ®">4. æŸ¥è¯¢æ•°æ®</h1>

<p>æœ¬æ•™ç¨‹å°†ä»¥Druid SQLå’ŒDruidçš„åŸç”ŸæŸ¥è¯¢æ ¼å¼çš„ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•åœ¨Apache Druidä¸­æŸ¥è¯¢æ•°æ®ã€‚</p>

<p>æœ¬æ•™ç¨‹å‡å®šæ‚¨å·²ç»å®Œæˆäº†æ‘„å–æ•™ç¨‹ä¹‹ä¸€ï¼Œå› ä¸ºæˆ‘ä»¬å°†æŸ¥è¯¢Wikipediaç¼–è¾‘æ ·ä¾‹æ•°æ®ã€‚</p>

<p>Druidæ”¯æŒSQLæŸ¥è¯¢ã€‚</p>

<p>è¯¥æŸ¥è¯¢æ£€ç´¢äº†2015å¹´9æœˆ12æ—¥è¢«ç¼–è¾‘æœ€å¤šçš„10ä¸ªç»´åŸºç™¾ç§‘é¡µé¢</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">SELECT</span> <span class="n">page</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Edits</span>
<span class="k">FROM</span> <span class="n">wikipedia</span>
<span class="k">WHERE</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2015-09-12 00:00:00'</span> <span class="o">&lt;=</span> <span class="nv">"__time"</span> <span class="k">AND</span> <span class="nv">"__time"</span> <span class="o">&lt;</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2015-09-13 00:00:00'</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">page</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">Edits</span> <span class="k">DESC</span>
<span class="k">LIMIT</span> <span class="mi">10</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è®©æˆ‘ä»¬æ¥çœ‹å‡ ç§ä¸åŒçš„æŸ¥è¯¢æ–¹æ³•</p>

<h2 id="41-é€šè¿‡æ§åˆ¶å°queryæŸ¥è¯¢">4.1. é€šè¿‡æ§åˆ¶å°QueryæŸ¥è¯¢</h2>

<p><img src="https://liulv.work/images/img/20201209165417.png" alt="20201209165417" /></p>

<h2 id="42-é€šè¿‡dsqlæŸ¥è¯¢sql">4.2. é€šè¿‡dsqlæŸ¥è¯¢SQL</h2>

<p>ä¸ºæ–¹ä¾¿èµ·è§ï¼ŒDruidè½¯ä»¶åŒ…ä¸­åŒ…æ‹¬äº†ä¸€ä¸ªSQLå‘½ä»¤è¡Œå®¢æˆ·ç«¯ï¼Œä½äºDruidæ ¹ç›®å½•ä¸­çš„ bin/dsql</p>

<p>è¿è¡Œ bin/dsql, å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ï¼š</p>

<p>Welcome to dsql, the command-line client for Druid SQL.
Type â€œ\hâ€ for help.
dsql&gt;</p>

<p><img src="https://liulv.work/images/img/20201209165626.png" alt="20201209165626" /></p>

<h2 id="43-é€šè¿‡httpæŸ¥è¯¢sql">4.3. é€šè¿‡HTTPæŸ¥è¯¢SQL</h2>

<p>SQLæŸ¥è¯¢ä½œä¸ºJSONé€šè¿‡HTTPæäº¤</p>

<p>æ•™ç¨‹åŒ…æ‹¬ä¸€ä¸ªç¤ºä¾‹æ–‡ä»¶, è¯¥æ–‡ä»¶quickstart/tutorial/wikipedia-top-pages-sql.jsonåŒ…å«ä¸Šé¢æ˜¾ç¤ºçš„SQLæŸ¥è¯¢, æˆ‘ä»¬å°†è¯¥æŸ¥è¯¢æäº¤ç»™Druid Brokerã€‚</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="err">curl -X 'POST' -H 'Content-Type:application/json' -d @quickstart/tutorial/wikipedia-top-pages-sql.json http://localhost:8888/druid/v2/sql
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="44-æ›´å¤šdruid-sqlç¤ºä¾‹">4.4. æ›´å¤šDruid SQLç¤ºä¾‹</h2>

<h3 id="441-æ—¶é—´æŸ¥è¯¢">4.4.1. æ—¶é—´æŸ¥è¯¢</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">SELECT</span> <span class="n">FLOOR</span><span class="p">(</span><span class="n">__time</span> <span class="k">to</span> <span class="n">HOUR</span><span class="p">)</span> <span class="k">AS</span> <span class="n">HourTime</span><span class="p">,</span> <span class="k">SUM</span><span class="p">(</span><span class="n">deleted</span><span class="p">)</span> <span class="k">AS</span> <span class="n">LinesDeleted</span>
<span class="k">FROM</span> <span class="n">wikipedia</span> <span class="k">WHERE</span> <span class="nv">"__time"</span> <span class="k">BETWEEN</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2015-09-12 00:00:00'</span> <span class="k">AND</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2015-09-13 00:00:00'</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://liulv.work/images/img/20201209165956.png" alt="20201209165956" /></p>

<h3 id="442-èšåˆæŸ¥è¯¢">4.4.2. èšåˆæŸ¥è¯¢</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="k">SELECT</span> <span class="n">channel</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="k">SUM</span><span class="p">(</span><span class="n">added</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">wikipedia</span> <span class="k">WHERE</span> <span class="nv">"__time"</span> <span class="k">BETWEEN</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2015-09-12 00:00:00'</span> <span class="k">AND</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2015-09-13 00:00:00'</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">channel</span><span class="p">,</span> <span class="n">page</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">SUM</span><span class="p">(</span><span class="n">added</span><span class="p">)</span> <span class="k">DESC</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://liulv.work/images/img/20201209170146.png" alt="20201209170146" /></p>

<h3 id="443-æŸ¥è¯¢åŸå§‹æ•°æ®">4.4.3. æŸ¥è¯¢åŸå§‹æ•°æ®</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">SELECT</span> <span class="k">user</span><span class="p">,</span> <span class="n">page</span>
<span class="k">FROM</span> <span class="n">wikipedia</span> <span class="k">WHERE</span> <span class="nv">"__time"</span> <span class="k">BETWEEN</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2015-09-12 02:00:00'</span> <span class="k">AND</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2015-09-12 03:00:00'</span>
<span class="k">LIMIT</span> <span class="mi">5</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://liulv.work/images/img/20201209172941.png" alt="20201209172941" /></p>

<h3 id="444-æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’">4.4.4. æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’</h3>

<p>ç‚¹å‡»è¿è¡Œæ—è¾¹â€¦ Explain SQL query</p>

<p><img src="https://liulv.work/images/img/20201209173045.png" alt="20201209173045" /></p>

<p><img src="https://liulv.work/images/img/20201209173114.png" alt="20201209173114" /></p>

<p>å¦‚æœæ‚¨ä»¥å…¶ä»–æ–¹å¼æŸ¥è¯¢ï¼Œåˆ™å¯ä»¥é€šè¿‡åœ¨Druid SQLæŸ¥è¯¢ä¹‹å‰æ·»åŠ  EXPLAIN PLAN FOR æ¥è·å¾—æŸ¥è¯¢è®¡åˆ’ã€‚</p>

<p>ä½¿ç”¨ä¸Šè¾¹çš„ä¸€ä¸ªç¤ºä¾‹ï¼š</p>

<p>EXPLAIN PLAN FOR SELECT page, COUNT(*) AS Edits FROM wikipedia WHERE â€œ__timeâ€ BETWEEN TIMESTAMP â€˜2015-09-12 00:00:00â€™ AND TIMESTAMP â€˜2015-09-13 00:00:00â€™ GROUP BY page ORDER BY Edits DESC LIMIT 10;</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="n">dsql</span><span class="o">&gt;</span> <span class="k">EXPLAIN</span> <span class="n">PLAN</span> <span class="k">FOR</span> <span class="k">SELECT</span> <span class="n">page</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Edits</span> <span class="k">FROM</span> <span class="n">wikipedia</span> <span class="k">WHERE</span> <span class="nv">"__time"</span> <span class="k">BETWEEN</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2015-09-12 00:00:00'</span> <span class="k">AND</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2015-09-13 00:00:00'</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">page</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">Edits</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span> <span class="n">PLAN</span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span> <span class="n">DruidQueryRel</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="p">[</span><span class="err">{</span><span class="nv">"queryType"</span><span class="p">:</span><span class="nv">"topN"</span><span class="p">,</span><span class="nv">"dataSource"</span><span class="p">:</span><span class="err">{</span><span class="nv">"type"</span><span class="p">:</span><span class="nv">"table"</span><span class="p">,</span><span class="nv">"name"</span><span class="p">:</span><span class="nv">"wikipedia"</span><span class="err">}</span><span class="p">,</span><span class="nv">"virtualColumns"</span><span class="p">:[],</span><span class="nv">"dimension"</span><span class="p">:</span><span class="err">{</span><span class="nv">"type"</span><span class="p">:</span><span class="nv">"default"</span><span class="p">,</span><span class="nv">"dimension"</span><span class="p">:</span><span class="nv">"page"</span><span class="p">,</span><span class="nv">"outputName"</span><span class="p">:</span><span class="nv">"d0"</span><span class="p">,</span><span class="nv">"outputType"</span><span class="p">:</span><span class="nv">"STRING"</span><span class="err">}</span><span class="p">,</span><span class="nv">"metric"</span><span class="p">:</span><span class="err">{</span><span class="nv">"type"</span><span class="p">:</span><span class="nv">"numeric"</span><span class="p">,</span><span class="nv">"metric"</span><span class="p">:</span><span class="nv">"a0"</span><span class="err">}</span><span class="p">,</span><span class="nv">"threshold"</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="nv">"intervals"</span><span class="p">:</span><span class="err">{</span><span class="nv">"type"</span><span class="p">:</span><span class="nv">"intervals"</span><span class="p">,</span><span class="nv">"intervals"</span><span class="p">:[</span><span class="nv">"2015-09-12T00:00:00.000Z/2015-09-13T00:00:00.001Z"</span><span class="p">]</span><span class="err">}</span><span class="p">,</span><span class="nv">"filter"</span><span class="p">:</span><span class="k">null</span><span class="p">,</span><span class="nv">"granularity"</span><span class="p">:</span><span class="err">{</span><span class="nv">"type"</span><span class="p">:</span><span class="nv">"all"</span><span class="err">}</span><span class="p">,</span><span class="nv">"aggregations"</span><span class="p">:[</span><span class="err">{</span><span class="nv">"type"</span><span class="p">:</span><span class="nv">"count"</span><span class="p">,</span><span class="nv">"name"</span><span class="p">:</span><span class="nv">"a0"</span><span class="err">}</span><span class="p">],</span><span class="nv">"postAggregations"</span><span class="p">:[],</span><span class="nv">"context"</span><span class="p">:</span><span class="err">{}</span><span class="p">,</span><span class="nv">"descending"</span><span class="p">:</span><span class="k">false</span><span class="err">}</span><span class="p">],</span> <span class="n">signature</span><span class="o">=</span><span class="p">[</span><span class="err">{</span><span class="n">d0</span><span class="p">:</span><span class="n">STRING</span><span class="p">,</span> <span class="n">a0</span><span class="p">:</span><span class="n">LONG</span><span class="err">}</span><span class="p">])</span> <span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="n">Retrieved</span> <span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="mi">0</span><span class="p">.</span><span class="mi">03</span><span class="n">s</span><span class="p">.</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="5-ç‰¹åˆ«æ³¨æ„1">5. ç‰¹åˆ«æ³¨æ„1</h1>

<p>Druid Hadoop Dockerå®‰è£…ä¹‹å‰éœ€è¦å…³é—­SELinux</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>getenforce
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿”å›
Enforcing</p>

<p>æ‰§è¡Œå…³é—­SELinux</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>setenforce 0
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/SELINUX=enforcing/SELINUX=disabled/g'</span> /etc/selinux/config
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ£€æŸ¥SELinux</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>getenforce
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="6-roll-upèšåˆæ“ä½œ">6. Roll-upèšåˆæ“ä½œ</h1>

<p>Apache Druidå¯ä»¥é€šè¿‡roll-upåœ¨æ•°æ®æ‘„å–é˜¶æ®µå¯¹åŸå§‹æ•°æ®è¿›è¡Œæ±‡æ€»ã€‚ Roll-upæ˜¯å¯¹é€‰å®šåˆ—é›†çš„ä¸€çº§èšåˆæ“ä½œï¼Œå®ƒå¯ä»¥å‡å°å­˜å‚¨æ•°æ®çš„å¤§å°ã€‚</p>

<p>æœ¬æ•™ç¨‹ä¸­å°†è®¨è®ºåœ¨ä¸€ä¸ªç¤ºä¾‹æ•°æ®é›†ä¸Šè¿›è¡Œroll-upçš„ç»“æœã€‚</p>

<p>æœ¬æ•™ç¨‹æˆ‘ä»¬å‡è®¾æ‚¨å·²ç»æŒ‰ç…§å•æœåŠ¡å™¨éƒ¨ç½²ä¸­æè¿°ä¸‹è½½äº†Druidï¼Œå¹¶è¿è¡Œåœ¨æœ¬åœ°æœºå™¨ä¸Šã€‚</p>

<p>å®ŒæˆåŠ è½½æœ¬åœ°æ–‡ä»¶å’Œæ•°æ®æŸ¥è¯¢ä¸¤éƒ¨åˆ†å†…å®¹ä¹Ÿæ˜¯éå¸¸æœ‰å¸®åŠ©çš„ã€‚</p>

<h2 id="61-æ•°æ®å‡†å¤‡">6.1. æ•°æ®å‡†å¤‡</h2>

<p>ä½¿ç”¨ä¸€ä¸ªç½‘ç»œæµäº‹ä»¶æ•°æ®çš„å°æ ·æœ¬ï¼Œè¡¨ç¤ºåœ¨ç‰¹å®šæ—¶é—´å†…ä»æºåˆ°ç›®æ ‡IPåœ°å€çš„æµé‡çš„æ•°æ®åŒ…å’Œå­—èŠ‚è®¡æ•°ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T01:01:35Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">9024</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T01:01:51Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">255</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">21133</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T01:01:59Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">5780</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T01:02:14Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">38</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">6289</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T01:02:29Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">377</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">359971</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T01:03:29Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">49</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">10204</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-02T21:33:14Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"7.7.7.7"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"8.8.8.8"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">38</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">6289</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-02T21:33:45Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"7.7.7.7"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"8.8.8.8"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">123</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">93999</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-02T21:35:45Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"7.7.7.7"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"8.8.8.8"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">2818</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>ç¤ºä¾‹æ•°æ®åœ¨Druidå®‰è£…ç›®å½•<code class="language-plaintext highlighter-rouge">quickstart/tutorial/rollup-data.json</code>ä¸‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ­¤æ¥å…¥æ•°æ®è§„èŒƒæ¥æ¥å…¥æ•°æ®ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"spec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dataSchema"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"dataSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"rollup-tutorial"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"dimensionsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"dimensions"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"srcIP"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"dstIP"</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"timestampSpec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"column"</span><span class="p">:</span><span class="w"> </span><span class="s2">"timestamp"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"iso"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"metricsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"uniform"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"segmentGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"week"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"queryGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"minute"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"intervals"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"2018-01-01/2018-01-03"</span><span class="p">],</span><span class="w">
        </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"ioConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"inputSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"local"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"baseDir"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"quickstart/tutorial"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"filter"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"rollup-data.json"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"inputFormat"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"json"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"appendToExisting"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"tuningConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxRowsPerSegment"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">5000000</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxRowsInMemory"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">25000</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>é€šè¿‡åœ¨ granularitySpec é€‰é¡¹ä¸­è®¾ç½® rollup : true æ¥å¯ç”¨Roll-up</p>

<p>æ³¨æ„ï¼Œæˆ‘ä»¬å°†srcIPå’ŒdstIPå®šä¹‰ä¸ºç»´åº¦ï¼Œå°†packetså’Œbytesåˆ—å®šä¹‰ä¸ºäº†longSumç±»å‹çš„æŒ‡æ ‡ï¼Œå¹¶å°† queryGranularity é…ç½®å®šä¹‰ä¸º minuteã€‚</p>

<p>åŠ è½½è¿™äº›æ•°æ®åï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•ä½¿ç”¨è¿™äº›å®šä¹‰ã€‚</p>

<h2 id="62-åŠ è½½æ•°æ®">6.2. åŠ è½½æ•°æ®</h2>

<p>åœ¨Druidçš„æ ¹ç›®å½•ä¸‹è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">bin/post-index-task</span><span class="w"> </span><span class="nt">--file</span><span class="w"> </span><span class="nx">quickstart/tutorial/rollup-index.json</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>è„šæœ¬è¿è¡Œå®Œæˆä»¥åï¼Œæˆ‘ä»¬å°†æŸ¥è¯¢æ•°æ®ã€‚</p>

<p><img src="https://liulv.work/images/img/20201210145621.png" alt="20201210145621" /></p>

<h2 id="63-æŸ¥è¯¢æ•°æ®">6.3. æŸ¥è¯¢æ•°æ®</h2>

<p>ç°åœ¨è¿è¡Œ bin/dsql ç„¶åæ‰§è¡ŒæŸ¥è¯¢ select * from â€œrollup-tutorialâ€; æ¥æŸ¥çœ‹å·²ç»è¢«æ‘„å…¥çš„æ•°æ®</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="kt">root</span><span class="err">@</span><span class="kt">localhost</span><span class="w"> </span><span class="kt">apache</span><span class="nt">-druid-0</span><span class="mf">.20.0</span><span class="p">]</span><span class="c"># bin/dsql</span><span class="w">
</span><span class="nf">Welcome</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">dsql</span><span class="p">,</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">command-line</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">Druid</span><span class="w"> </span><span class="nx">SQL.</span><span class="w">
</span><span class="nf">Connected</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="p">[</span><span class="kt">http</span><span class="p">:</span><span class="nf">//localhost:8082/</span><span class="p">]</span><span class="o">.</span><span class="w">

</span><span class="kt">Type</span><span class="w"> </span><span class="s2">"\h"</span><span class="w"> </span><span class="kt">for</span><span class="w"> </span><span class="no">help.</span><span class="w">
</span><span class="kt">dsql</span><span class="err">&gt;</span><span class="w"> </span><span class="kt">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kt">from</span><span class="w"> </span><span class="s2">"rollup-tutorial"</span><span class="p">;</span><span class="w">
</span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">
</span><span class="err">â”‚</span><span class="w"> </span><span class="nf">__time</span><span class="w">                   </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">bytes</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">dstIP</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">packets</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">srcIP</span><span class="w">   </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><span class="w">
</span><span class="err">â”‚</span><span class="w"> </span><span class="mi">2018</span><span class="nt">-01-01T01</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mf">00.000</span><span class="nf">Z</span><span class="w"> </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">35937</span><span class="w"> </span><span class="err">â”‚</span><span class="w">     </span><span class="nx">3</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">2.2.2.2</span><span class="w"> </span><span class="err">â”‚</span><span class="w">     </span><span class="nx">286</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">1.1.1.1</span><span class="w"> </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w"> </span><span class="mi">2018</span><span class="nt">-01-01T01</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mf">00.000</span><span class="nf">Z</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">366260</span><span class="w"> </span><span class="err">â”‚</span><span class="w">     </span><span class="nx">2</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">2.2.2.2</span><span class="w"> </span><span class="err">â”‚</span><span class="w">     </span><span class="nx">415</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">1.1.1.1</span><span class="w"> </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w"> </span><span class="mi">2018</span><span class="nt">-01-01T01</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mf">00.000</span><span class="nf">Z</span><span class="w"> </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">10204</span><span class="w"> </span><span class="err">â”‚</span><span class="w">     </span><span class="nx">1</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">2.2.2.2</span><span class="w"> </span><span class="err">â”‚</span><span class="w">      </span><span class="nx">49</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">1.1.1.1</span><span class="w"> </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w"> </span><span class="mi">2018</span><span class="nt">-01-02T21</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">00.000</span><span class="nf">Z</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">100288</span><span class="w"> </span><span class="err">â”‚</span><span class="w">     </span><span class="nx">2</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">8.8.8.8</span><span class="w"> </span><span class="err">â”‚</span><span class="w">     </span><span class="nx">161</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">7.7.7.7</span><span class="w"> </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w"> </span><span class="mi">2018</span><span class="nt">-01-02T21</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mf">00.000</span><span class="nf">Z</span><span class="w"> </span><span class="err">â”‚</span><span class="w">   </span><span class="nx">2818</span><span class="w"> </span><span class="err">â”‚</span><span class="w">     </span><span class="nx">1</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">8.8.8.8</span><span class="w"> </span><span class="err">â”‚</span><span class="w">      </span><span class="nx">12</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">7.7.7.7</span><span class="w"> </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">
</span><span class="kt">Retrieved</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="kt">rows</span><span class="w"> </span><span class="kt">in</span><span class="w"> </span><span class="mf">0.18</span><span class="nf">s.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>æˆ‘ä»¬æ¥çœ‹å‘ç”Ÿåœ¨ 2018-01-01T01:01 çš„ä¸‰æ¡åŸå§‹æ•°æ®ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T01:01:35Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">9024</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T01:01:51Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">255</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">21133</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T01:01:59Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">5780</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™ä¸‰æ¡æ•°æ®å·²ç»è¢«roll upä¸ºä»¥ä¸‹ä¸€è¡Œæ•°æ®ï¼š</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">
</span><span class="err">â”‚</span><span class="w"> </span><span class="nf">__time</span><span class="w">                   </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">bytes</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">dstIP</span><span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">packets</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">srcIP</span><span class="w">   </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><span class="w">
</span><span class="err">â”‚</span><span class="w"> </span><span class="mi">2018</span><span class="nt">-01-01T01</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mf">00.000</span><span class="nf">Z</span><span class="w"> </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">35937</span><span class="w"> </span><span class="err">â”‚</span><span class="w">     </span><span class="nx">3</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">2.2.2.2</span><span class="w"> </span><span class="err">â”‚</span><span class="w">     </span><span class="nx">286</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">1.1.1.1</span><span class="w"> </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™è¾“å…¥çš„æ•°æ®è¡Œå·²ç»è¢«æŒ‰ç…§æ—¶é—´åˆ—å’Œç»´åº¦åˆ— {timestamp, srcIP, dstIP} åœ¨æŒ‡æ ‡åˆ— {packages, bytes} ä¸Šåšæ±‚å’Œèšåˆ.</p>

<p>åœ¨è¿›è¡Œåˆ†ç»„ä¹‹å‰ï¼ŒåŸå§‹è¾“å…¥æ•°æ®çš„æ—¶é—´æˆ³æŒ‰åˆ†é’Ÿè¿›è¡Œæ ‡è®°/å¸ƒå±€ï¼Œè¿™æ˜¯ç”±äºæ‘„å–è§„èŒƒä¸­çš„ â€œqueryGranularityâ€ï¼šâ€minuteâ€ è®¾ç½®é€ æˆçš„ã€‚ åŒæ ·ï¼Œ2018-01-01T01:02 æœŸé—´å‘ç”Ÿçš„è¿™ä¸¤èµ·äº‹ä»¶ä¹Ÿå·²ç»æ±‡æ€»ã€‚</p>

<h1 id="7-é…ç½®æ•°æ®ä¿ç•™è§„åˆ™">7. é…ç½®æ•°æ®ä¿ç•™è§„åˆ™</h1>

<p>å‡è®¾æˆ‘ä»¬æƒ³åˆ é™¤2015å¹´9æœˆ12æ—¥å‰12å°æ—¶çš„æ•°æ®ï¼Œä¿ç•™2015å¹´9æœˆ12æ—¥å12å°æ—¶çš„æ•°æ®ã€‚</p>

<p>è¿›å…¥åˆ°Datasourcesè§†å›¾ï¼Œç‚¹å‡»ç¼–è¾‘æŒ‰é’®-ç„¶åå†ç‚¹å‡»Edit retention rules</p>

<p><img src="https://liulv.work/images/img/20201210150714.png" alt="20201210150714" /></p>

<p>ä¸€ä¸ªè§„åˆ™é…ç½®çª—å£å‡ºç°äº†ï¼š</p>

<p><img src="https://liulv.work/images/img/20201210150821.png" alt="20201210150821" /></p>

<p>ç°åœ¨ç‚¹å‡» + New rule æŒ‰é’®ä¸¤æ¬¡</p>

<p>åœ¨ä¸Šè¾¹çš„è§„åˆ™æ¡†ä¸­ï¼Œé€‰æ‹© Load å’Œ by Interval ç„¶åè¾“å…¥åœ¨ by Interval æ—è¾¹çš„è¾“å…¥æ¡†ä¸­è¾“å…¥ 2015-09-12T12:00:00.000Z/2015-09-13T00:00:00.000Z, å‰¯æœ¬å¯ä»¥é€‰æ‹©ä¿æŒ2ï¼Œåœ¨ _default_tier ä¸­</p>

<p>åœ¨ä¸‹è¾¹çš„è§„åˆ™æ¡†ä¸­ï¼Œé€‰æ‹© Drop å’Œ forever</p>

<p>è§„åˆ™çœ‹ä¸Šå»æ˜¯è¿™æ ·çš„ï¼š</p>

<p><img src="https://liulv.work/images/img/20201210151143.png" alt="20201210151143" /></p>

<p>ç°åœ¨ç‚¹å‡» Next, è§„åˆ™é…ç½®è¿‡ç¨‹å°†è¦æ±‚æä¾›ç”¨æˆ·åå’Œæ³¨é‡Šï¼Œä»¥ä¾¿è¿›è¡Œæ›´æ”¹æ—¥å¿—è®°å½•ã€‚æ‚¨å¯ä»¥åŒæ—¶è¾“å…¥æ•™ç¨‹ã€‚</p>

<p>ç°åœ¨ç‚¹å‡» Save, å¯ä»¥åœ¨Datasourcesè§†å›¾ä¸­çœ‹åˆ°æ–°çš„è§„åˆ™</p>

<p><img src="https://liulv.work/images/img/20201210151757.png" alt="20201210151757" /></p>

<p>ç»™é›†ç¾¤å‡ åˆ†é’Ÿæ—¶é—´åº”ç”¨è§„åˆ™æ›´æ”¹ï¼Œç„¶åè½¬åˆ°Druidæ§åˆ¶å°ä¸­çš„segmentsè§†å›¾ã€‚2015å¹´9æœˆ12æ—¥å‰12å°æ—¶çš„æ®µæ–‡ä»¶ç°å·²æ¶ˆå¤±</p>

<p><img src="https://liulv.work/images/img/20201210151931.png" alt="20201210151931" /></p>

<p>ç”Ÿæˆçš„ä¿ç•™è§„åˆ™é“¾å¦‚ä¸‹:</p>

<p>loadByInterval 2015-09-12T12/2015-09-13 (12 hours)
dropForever
loadForever (é»˜è®¤è§„åˆ™)
è§„åˆ™é“¾æ˜¯è‡ªä¸Šè€Œä¸‹è®¡ç®—çš„ï¼Œé»˜è®¤è§„åˆ™é“¾å§‹ç»ˆæ·»åŠ åœ¨åº•éƒ¨</p>

<p>æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„æ•™ç¨‹è§„åˆ™é“¾åœ¨æŒ‡å®šçš„12å°æ—¶é—´éš”å†…åŠ è½½æ•°æ®</p>

<p>å¦‚æœæ•°æ®ä¸åœ¨12å°æ—¶çš„é—´éš”å†…ï¼Œåˆ™è§„åˆ™é“¾ä¸‹ä¸€æ­¥å°†è®¡ç®— dropForeverï¼Œè¿™å°†åˆ é™¤ä»»ä½•æ•°æ®</p>

<p>dropForever ç»ˆæ­¢äº†è§„åˆ™é“¾ï¼Œæœ‰æ•ˆåœ°è¦†ç›–äº†é»˜è®¤çš„ loadForever è§„åˆ™ï¼Œåœ¨è¿™ä¸ªè§„åˆ™é“¾ä¸­æ°¸è¿œä¸ä¼šåˆ°è¾¾è¯¥è§„åˆ™</p>

<p>æ³¨æ„ï¼Œåœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç‰¹å®šé—´éš”çš„åŠ è½½è§„åˆ™</p>

<p>ç›¸åï¼Œå¦‚æœå¸Œæœ›æ ¹æ®æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸä¿ç•™æ•°æ®ï¼ˆä¾‹å¦‚ï¼Œä¿ç•™ä»è¿‡å»3ä¸ªæœˆåˆ°ç°åœ¨3ä¸ªæœˆçš„æ•°æ®ï¼‰ï¼Œåˆ™åº”å®šä¹‰ä¸€ä¸ªå‘¨æœŸæ€§åŠ è½½è§„åˆ™</p>

<h1 id="8-æ•°æ®æ›´æ–°">8. æ•°æ®æ›´æ–°</h1>

<p>æœ¬æ•™ç¨‹æ¼”ç¤ºå¦‚ä½•æ›´æ–°ç°æœ‰æ•°æ®ï¼ŒåŒæ—¶å±•ç¤ºè¦†ç›–(Overwrite)å’Œè¿½åŠ (append)çš„ä¸¤ä¸ªæ–¹å¼ã€‚</p>

<h2 id="81-æ•°æ®è¦†ç›–overwrite">8.1. æ•°æ®è¦†ç›–Overwrite</h2>

<h3 id="811-åŠ è½½åˆå§‹æ•°æ®">8.1.1. åŠ è½½åˆå§‹æ•°æ®</h3>

<p>æœ¬èŠ‚æ•™ç¨‹ä½¿ç”¨çš„ä»»åŠ¡æ‘„å–è§„èŒƒä½äº quickstart/tutorial/updates-init-index.json, æœ¬è§„èŒƒä» quickstart/tutorial/updates-data.json è¾“å…¥æ–‡ä»¶åˆ›å»ºä¸€ä¸ªåç§°ä¸º updates-tutorial çš„æ•°æ®æº</p>

<p>æäº¤ä»»åŠ¡ï¼š</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">bin/post-index-task</span><span class="w"> </span><span class="nt">--file</span><span class="w"> </span><span class="nx">quickstart/tutorial/updates-init-index.json</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>æˆ‘ä»¬æœ‰ä¸‰ä¸ªåŒ…å«â€åŠ¨ç‰©â€ç»´åº¦å’Œâ€æ•°å­—â€æŒ‡æ ‡çš„åˆå§‹è¡Œï¼š</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="nv">"updates-tutorial"</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://liulv.work/images/img/20201210153051.png" alt="20201210153051" /></p>

<h3 id="812-å°†æ—§æ•°æ®ä¸æ–°æ•°æ®åˆå¹¶å¹¶è¦†ç›–">8.1.2. å°†æ—§æ•°æ®ä¸æ–°æ•°æ®åˆå¹¶å¹¶è¦†ç›–</h3>

<p>ç°åœ¨æˆ‘ä»¬å°è¯•åœ¨ updates-tutorial æ•°æ®æºè¿½åŠ ä¸€äº›æ–°çš„æ•°æ®ï¼Œæˆ‘ä»¬å°†ä» quickstart/tutorial/updates-data3.json å¢åŠ æ–°çš„æ•°æ®</p>

<p>quickstart/tutorial/updates-append-index.json ä»»åŠ¡è§„èŒƒé…ç½®ä¸ºä»ç°æœ‰çš„ updates-tutorial æ•°æ®æºå’Œ quickstart/tutorial/updates-data3.json æ–‡ä»¶è¯»å–æ•°æ®ï¼Œè¯¥ä»»åŠ¡å°†ç»„åˆæ¥è‡ªä¸¤ä¸ªè¾“å…¥æºçš„æ•°æ®ï¼Œç„¶åç”¨æ–°çš„ç»„åˆæ•°æ®è¦†ç›–åŸå§‹æ•°æ®ã€‚</p>

<p>æäº¤ä»»åŠ¡ï¼š</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">bin</span><span class="o">/</span><span class="n">post</span><span class="o">-</span><span class="k">index</span><span class="o">-</span><span class="n">task</span> <span class="c1">--file quickstart/tutorial/updates-append-index.json --url http://localhost:8081</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æŸ¥è¯¢åˆå¹¶åçš„æ•°æ®</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="nv">"updates-tutorial"</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å½“Druidå®Œæˆä»è¿™ä¸ªè¦†ç›–ä»»åŠ¡åŠ è½½æ–°æ®µæ—¶ï¼Œæ–°è¡Œå°†è¢«æ·»åŠ åˆ°æ•°æ®æºä¸­ã€‚è¯·æ³¨æ„ï¼Œâ€œLionâ€è¡Œå‘ç”Ÿäº†roll upï¼š</p>

<pre><code class="language-log">[root@localhost apache-druid-0.20.0]# bin/dsql

Welcome to dsql, the command-line client for Druid SQL.
Connected to [http://localhost:8082/].

Type "\h" for help.
dsql&gt; 
dsql&gt; 
dsql&gt; select * from "updates-tutorial";
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ __time                   â”‚ animal   â”‚ count â”‚ number â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2018-01-01T01:01:00.000Z â”‚ lion     â”‚     1 â”‚    300 â”‚
â”‚ 2018-01-01T01:01:00.000Z â”‚ tiger    â”‚     1 â”‚    100 â”‚
â”‚ 2018-01-01T03:01:00.000Z â”‚ aardvark â”‚     1 â”‚     42 â”‚
â”‚ 2018-01-01T03:01:00.000Z â”‚ giraffe  â”‚     1 â”‚  14124 â”‚
â”‚ 2018-01-01T05:01:00.000Z â”‚ mongoose â”‚     1 â”‚    737 â”‚
â”‚ 2018-01-01T06:01:00.000Z â”‚ snake    â”‚     1 â”‚   1234 â”‚
â”‚ 2018-01-01T07:01:00.000Z â”‚ octopus  â”‚     1 â”‚    115 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Retrieved 7 rows in 0.13s.
</code></pre>

<h3 id="813-è¿½åŠ æ•°æ®">8.1.3. è¿½åŠ æ•°æ®</h3>

<p>ç°åœ¨å°è¯•å¦ä¸€ç§è¿½åŠ æ•°æ®çš„æ–¹å¼</p>

<p>quickstart/tutorial/updates-append-index2.json ä»»åŠ¡è§„èŒƒä» quickstart/tutorial/updates-data4.json æ–‡ä»¶è¯»å–æ•°æ®ï¼Œç„¶åè¿½åŠ åˆ° updates-tutorial æ•°æ®æºã€‚æ³¨æ„åˆ°åœ¨è§„èŒƒä¸­ appendToExisting è®¾ç½®ä¸º true</p>

<p>æäº¤ä»»åŠ¡ï¼š</p>

<p>bin/post-index-task â€“file quickstart/tutorial/updates-append-index2.json â€“url http://localhost:8081</p>

<p>åŠ è½½æ–°æ•°æ®åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°â€octopusâ€åé¢é¢å¤–çš„ä¸¤è¡Œã€‚è¯·æ³¨æ„ï¼Œç¼–å·ä¸º222çš„æ–°â€bearâ€è¡Œå°šæœªä¸ç°æœ‰çš„bear-111è¡Œåˆå¹¶ï¼Œå› ä¸ºæ–°æ•°æ®ä¿å­˜åœ¨å•ç‹¬çš„æ®µä¸­ã€‚</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="nv">"updates-tutorial"</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="9-åˆå¹¶æ®µæ–‡ä»¶">9. åˆå¹¶æ®µæ–‡ä»¶</h1>

<p>å› ä¸ºæ¯ä¸€ä¸ªæ®µéƒ½æœ‰ä¸€äº›å†…å­˜å’Œå¤„ç†å¼€é”€ï¼Œæ‰€ä»¥æœ‰æ—¶å‡å°‘æ®µçš„æ€»æ•°æ˜¯æœ‰ç›Šçš„ï¼Œæœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥é˜…æ®µå¤§å°ä¼˜åŒ–ï¼Œæ‰€ä»¥éœ€è¦åˆå¹¶æ®µæ–‡ä»¶ã€‚</p>

<h2 id="91-åŠ è½½åˆå§‹åŒ–æ–‡ä»¶">9.1. åŠ è½½åˆå§‹åŒ–æ–‡ä»¶</h2>

<p>æˆ‘ä»¬å°†ä½¿ç”¨Wikipediaç¼–è¾‘æ•°æ®ï¼Œå¹¶ä½¿ç”¨åˆ›å»ºæ¯å°æ—¶æ®µçš„ç´¢å¼•è§„èŒƒ</p>

<p>è¿™ä»½è§„èŒƒä½äº quickstart/tutorial/ompaction-init-index.json, å®ƒå°†åˆ›å»ºä¸€ä¸ªåç§°ä¸º ompaction-tutorial çš„æ•°æ®æº</p>

<p>ç°åœ¨åŠ è½½è¿™ä»½åˆå§‹æ•°æ®ï¼š</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">bin/post-index-task</span><span class="w"> </span><span class="nt">--file</span><span class="w"> </span><span class="nx">quickstart/tutorial/compaction-init-index.json</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>![WARNING] è¯·æ³¨æ„ï¼Œæ‘„å–è§„èŒƒä¸­çš„ maxRowsPerSegment è®¾ç½®ä¸º1000, è¿™æ˜¯ä¸ºäº†æ¯å°æ—¶ç”Ÿæˆå¤šä¸ªæ®µï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨ã€‚é»˜è®¤ä¸º5000000ï¼Œå¯èƒ½éœ€è¦è¿›è¡Œè°ƒæ•´ä»¥ä¼˜åŒ–æ‚¨çš„æ®µæ–‡ä»¶ã€‚</p>
</blockquote>

<p>æå‰æ•°æ®å®Œæˆåï¼Œå¯ä»¥åˆ° http://localhost:8888/unified-console.html#datasources Druidæ§åˆ¶å°æŸ¥çœ‹æ–°çš„æ•°æ®æºã€‚</p>

<p><img src="https://liulv.work/images/img/20201214151548.png" alt="20201214151548" /></p>

<p>æŸ¥çœ‹Availabilityæ ï¼Œç‚¹å‡»å¯¹åº”çš„æ•°æ®æºçš„segmentæŸ¥çœ‹æ®µ</p>

<p><img src="https://liulv.work/images/img/20201214151916.png" alt="20201214151916" /></p>

<p>è¯¥æ•°æ®æºæœ‰51ä¸ªæ®µæ–‡ä»¶ï¼Œè¾“å…¥æ•°æ®æ¯å°æ—¶1-3ä¸ªæ®µ</p>

<p><img src="https://liulv.work/images/img/20201214152009.png" alt="20201214152009" /></p>

<p>å¯¹è¯¥æ•°æ®æºæ‰§è¡Œä¸€ä¸ª COUNT(*) æŸ¥è¯¢å¯ä»¥çœ‹åˆ°39244è¡Œæ•°æ®ï¼š</p>

<p><img src="https://liulv.work/images/img/20201214152151.png" alt="20201214152151" /></p>

<h2 id="92-åˆå¹¶æ•°æ®æŒ‰å°æ—¶">9.2. åˆå¹¶æ•°æ®ï¼ˆæŒ‰å°æ—¶ï¼‰</h2>

<p>ç°åœ¨æˆ‘ä»¬å°†åˆå¹¶è¿™51ä¸ªå°çš„æ®µï¼Œåœ¨ quickstart/tutorial/compaction-keep-granularity.json æ–‡ä»¶ä¸­æˆ‘ä»¬åŒ…å«äº†ä¸€ä¸ªæœ¬æ•™ç¨‹æ•°æ®æºçš„åˆå¹¶ä»»åŠ¡è§„èŒƒã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"compact"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"dataSource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"compaction-tutorial"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"interval"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-09-12/2015-09-13"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"tuningConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"maxRowsPerSegment"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">5000000</span><span class="p">,</span><span class="w">
    </span><span class="nl">"maxRowsInMemory"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">25000</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>è¯¥ä»»åŠ¡ä¼šåˆå¹¶ compaction-tutorial æ•°æ®æºåœ¨ 2015-09-12/2015-09-13 æ—¶é—´èŒƒå›´å†…çš„æ‰€æœ‰çš„æ®µ</p>

<p>tuningConfig ä¸­çš„å‚æ•°æ§åˆ¶åˆå¹¶åçš„æ®µæ–‡ä»¶é›†åˆä¸­æœ‰å¤šå°‘ä¸ªæ®µã€‚</p>

<p>åœ¨æœ¬æ•™ç¨‹ç¤ºä¾‹ä¸­ï¼Œæ¯å°æ—¶åªåˆ›å»ºä¸€ä¸ªåˆå¹¶æ®µï¼Œå› ä¸ºæ¯å°æ—¶çš„è¡Œæ•°å°‘äº5000000 maxRowsPerSegmentï¼ˆè¯·æ³¨æ„ï¼Œè¡Œæ€»æ•°ä¸º39244ï¼‰ã€‚</p>

<p>ç°åœ¨æäº¤è¿™ä¸ªä»»åŠ¡ï¼š</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">bin/post-index-task</span><span class="w"> </span><span class="nt">--file</span><span class="w"> </span><span class="nx">quickstart/tutorial/compaction-keep-granularity.json</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»»åŠ¡è¿è¡Œç»“æŸåï¼ŒæŸ¥çœ‹datasource,å‘ç°åªæœ‰24ä¸ªsegments</p>

<p><img src="https://liulv.work/images/img/20201214152843.png" alt="20201214152843" /></p>

<p>åˆ·æ–° Segments è§†å›¾, â€œSegmentsâ€è§†å›¾åº”æ˜¾ç¤ºæœ‰24ä¸ªåˆ†æ®µï¼Œæ¯å°æ—¶ä¸€ä¸ªï¼š</p>

<p><img src="https://liulv.work/images/img/20201214152909.png" alt="20201214152909" /></p>

<h2 id="93-ç”¨æ–°çš„æ®µç²’åº¦åˆå¹¶æ•°æ®æŒ‰å¤©">9.3. ç”¨æ–°çš„æ®µç²’åº¦åˆå¹¶æ•°æ®(æŒ‰å¤©)</h2>

<p>åˆå¹¶ä»»åŠ¡è¿˜å¯ä»¥ç”Ÿæˆä¸åŒäºè¾“å…¥æ®µç²’åº¦çš„åˆå¹¶æ®µ</p>

<p>æˆ‘ä»¬åœ¨ quickstart/tutorial/compaction-day-granularity.json æ–‡ä»¶ä¸­åŒ…å«äº†ä¸€ä¸ªå¯ä»¥åˆ›å»º DAY ç²’åº¦çš„åˆå¹¶ä»»åŠ¡æ‘„å–è§„èŒƒï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"compact"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"dataSource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"compaction-tutorial"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"interval"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-09-12/2015-09-13"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"segmentGranularity"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DAY"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"tuningConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"maxRowsPerSegment"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">5000000</span><span class="p">,</span><span class="w">
    </span><span class="nl">"maxRowsInMemory"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">25000</span><span class="p">,</span><span class="w">
    </span><span class="nl">"forceExtendableShardSpecs"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>è¯·æ³¨æ„è¿™ä¸ªåˆå¹¶ä»»åŠ¡è§„èŒƒä¸­ segmentGranularity é…ç½®é¡¹è®¾ç½®ä¸ºäº† DAY, ç°åœ¨æäº¤è¿™ä¸ªä»»åŠ¡ï¼š</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">bin/post-index-task</span><span class="w"> </span><span class="nt">--file</span><span class="w"> </span><span class="nx">quickstart/tutorial/compaction-day-granularity.json</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>Coordinatorå°†æ—§çš„è¾“å…¥æ®µæ ‡è®°ä¸ºæœªä½¿ç”¨éœ€è¦ä¸€æ®µæ—¶é—´ï¼Œå› æ­¤æ‚¨å¯èƒ½ä¼šçœ‹åˆ°æ€»å…±æœ‰25ä¸ªæ®µçš„ä¸­é—´çŠ¶æ€ã€‚æœ€ç»ˆï¼Œåªæœ‰ä¸€ä¸ªå¤©ç²’åº¦çš„æ®µ</p>

<p><img src="https://liulv.work/images/img/20201214154047.png" alt="20201214154047" /></p>

<h1 id="10-æ•°æ®åˆ é™¤">10. æ•°æ®åˆ é™¤</h1>

<h2 id="101-åŠ è½½åˆå§‹æ•°æ®">10.1. åŠ è½½åˆå§‹æ•°æ®</h2>

<p>æˆ‘ä»¬å°†ä½¿ç”¨Wikipediaç¼–è¾‘æ•°æ®ï¼Œå¹¶ä½¿ç”¨åˆ›å»ºæ¯å°æ—¶æ®µçš„ç´¢å¼•è§„èŒƒ, è¿™ä»½è§„èŒƒä½äº quickstart/tutorial/deletion-index.json, å®ƒå°†åˆ›å»ºä¸€ä¸ªåç§°ä¸º deletion-tutorial çš„æ•°æ®æº</p>

<p>ç°åœ¨åŠ è½½è¿™ä»½åˆå§‹æ•°æ®ï¼š</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">bin/post-index-task</span><span class="w"> </span><span class="nt">--file</span><span class="w"> </span><span class="nx">quickstart/tutorial/deletion-index.json</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>å½“åŠ è½½å®Œæˆåï¼Œåœ¨æµè§ˆå™¨ä¸­è®¿é—®http://localhost:8888/unified-console.html#datasources</p>

<p><img src="https://liulv.work/images/img/20201214154326.png" alt="20201214154326" /></p>

<h2 id="102-å¦‚ä½•æ°¸ä¹…åˆ é™¤æ•°æ®">10.2. å¦‚ä½•æ°¸ä¹…åˆ é™¤æ•°æ®</h2>

<p>æ°¸ä¹…åˆ é™¤ä¸€ä¸ªæ®µéœ€è¦ä¸¤æ­¥ï¼š</p>

<ol>
  <li>æ®µå¿…é¡»é¦–å…ˆæ ‡è®°ä¸ºâ€æœªä½¿ç”¨â€ã€‚å½“ç”¨æˆ·é€šè¿‡Coordinator APIæ‰‹åŠ¨ç¦ç”¨æ®µæ—¶ï¼Œå°±ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µ</li>
  <li>åœ¨æ®µè¢«æ ‡è®°ä¸ºâ€æœªä½¿ç”¨â€ä¹‹åï¼Œä¸€ä¸ªKillä»»åŠ¡å°†ä»Druidçš„å…ƒæ•°æ®å­˜å‚¨å’Œæ·±å±‚å­˜å‚¨ä¸­åˆ é™¤ä»»ä½•â€œæœªä½¿ç”¨â€çš„æ®µ</li>
</ol>

<p>ç°åœ¨è®©æˆ‘ä»¬é€šè¿‡ä½¿ç”¨Coordinator APIæŒ‰æ—¶é—´é—´éš”å’Œæ®µidåˆ é™¤ä¸€äº›æ®µã€‚</p>

<h2 id="103-é€šè¿‡æ—¶é—´é—´éš”ç¦ç”¨æ®µ">10.3. é€šè¿‡æ—¶é—´é—´éš”ç¦ç”¨æ®µ</h2>

<p>è®©æˆ‘ä»¬åœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”å†…ç¦ç”¨æ®µã€‚è¿™ä¼šå°†é—´éš”ä¸­çš„æ‰€æœ‰æ®µæ ‡è®°ä¸ºâ€æœªä½¿ç”¨â€ï¼Œä½†ä¸ä¼šå°†å®ƒä»¬ä»æ·±å±‚å­˜å‚¨ä¸­ç§»é™¤ã€‚è®©æˆ‘ä»¬ç¦ç”¨é—´éš” 2015-09-12T18:00:00.000Z/2015-09-12T20:00:00.000Zä¸­çš„æ®µï¼Œå³åœ¨18åˆ°20å°æ—¶ä¹‹é—´</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">curl</span><span class="w"> </span><span class="nt">-X</span><span class="w"> </span><span class="s1">'POST'</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="s1">'Content-Type:application/json'</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="s1">'{ "interval" : "2015-09-12T18:00:00.000Z/2015-09-12T20:00:00.000Z" }'</span><span class="w"> </span><span class="nx">http://localhost:8081/druid/coordinator/v1/datasources/deletion-tutorial/markUnused</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>è¯¥å‘½ä»¤å®Œæˆåï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ç¬¬18å’Œ19å°æ—¶çš„æ®µå·²è¢«ç¦ç”¨ï¼š</p>

<p><img src="https://liulv.work/images/img/20201214154809.png" alt="20201214154809" /></p>

<p>è¯·æ³¨æ„ï¼Œç¬¬18å°æ—¶å’Œç¬¬19å°æ—¶çš„æ•°æ®æ®µä»åœ¨æ·±å±‚å­˜å‚¨ä¸­å‘½ä»¤:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">ls</span><span class="w"> </span><span class="nt">-l1</span><span class="w"> </span><span class="nx">var/druid/segments/deletion-tutorial/</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://liulv.work/images/img/20201214154902.png" alt="20201214154902" /></p>

<h2 id="104-é€šè¿‡æ®µidç¦ç”¨æ®µ">10.4. é€šè¿‡æ®µIDç¦ç”¨æ®µ</h2>

<p>è®©æˆ‘ä»¬æŒ‰æ®µidç¦ç”¨ä¸€äº›æ®µã€‚è¿™å°†å†æ¬¡å°†æ®µæ ‡è®°ä¸ºâ€œæœªä½¿ç”¨â€ï¼Œä½†ä¸ä¼šå°†å®ƒä»¬ä»æ·±å±‚å­˜å‚¨ä¸­ç§»é™¤ã€‚æ‚¨å¯ä»¥ä»UIä¸­çœ‹åˆ°å®Œæ•´çš„æ®µidï¼Œå¦‚ä¸‹æ‰€è¿°ã€‚</p>

<p>åœ¨â€Segmentsâ€è§†å›¾ä¸­ï¼Œå•å‡»â€¦æ“ä½œæŒ‰é’®è¿›å…¥View SQL query for table</p>

<p><img src="https://liulv.work/images/img/20201214155933.png" alt="20201214155933" /></p>

<p>æŸ¥è¯¢ç»“æœé¡µæ‹‰ä¼¸segment_id</p>

<p><img src="https://liulv.work/images/img/1607932812(1).png" alt="1607932812(1)" /></p>

<p><img src="https://liulv.work/images/img/1607932900(1).png" alt="1607932900(1)" /></p>

<p>ä¿¡æ¯æ¡†çš„é¡¶éƒ¨æ˜¾ç¤ºå®Œæ•´çš„æ®µIDï¼Œä¾‹å¦‚ deletion-tutorial_2015-09-12T14:00:00.000Z_2015-09-12T15:00:00.000Z_2019-02-28T01:11:51.606Zï¼Œç¬¬14å°æ—¶çš„æ®µã€‚</p>

<p>è®©æˆ‘ä»¬å‘Coordinatorå‘é€ä¸€ä¸ªPOSTè¯·æ±‚æ¥ç¦ç”¨13ç‚¹å’Œ14ç‚¹çš„æ®µ</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"segmentIds"</span><span class="p">:</span><span class="w">
  </span><span class="p">[</span><span class="w">
    </span><span class="s2">"deletion-tutorial_2015-09-12T13:00:00.000Z_2015-09-12T14:00:00.000Z_2019-05-01T17:38:46.961Z"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"deletion-tutorial_2015-09-12T14:00:00.000Z_2015-09-12T15:00:00.000Z_2019-05-01T17:38:46.961Z"</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>jsonæ–‡ä»¶ä½äºquickstart/tutorial/deletion-disable-segments.json, å¦‚ä¸‹å‘Coordinatoræäº¤ä¸€ä¸ªPOSTè¯·æ±‚ï¼š</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="s1">'POST'</span> <span class="o">-</span><span class="n">H</span> <span class="s1">'Content-Type:application/json'</span> <span class="o">-</span><span class="n">d</span> <span class="o">@</span><span class="n">quickstart</span><span class="o">/</span><span class="n">tutorial</span><span class="o">/</span><span class="n">deletion</span><span class="o">-</span><span class="n">disable</span><span class="o">-</span><span class="n">segments</span><span class="p">.</span><span class="n">json</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8081</span><span class="o">/</span><span class="n">druid</span><span class="o">/</span><span class="n">coordinator</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">datasources</span><span class="o">/</span><span class="n">deletion</span><span class="o">-</span><span class="n">tutorial</span><span class="o">/</span><span class="n">markUnused</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://liulv.work/images/img/1607933017(1).png" alt="1607933017(1)" /></p>

<p>å‘½ä»¤æ‰§è¡Œå®Œæˆåï¼Œå¯ä»¥çœ‹åˆ°13æ—¶å’Œ14æ—¶çš„æ®µå·²ç»è¢«ç¦ç”¨ï¼š</p>

<p><strong>ä½†æ˜¯ ä½†æ˜¯ï¼Œ æˆ‘è¿™é‡Œæ‰§è¡Œç¦ç”¨ä¸äº†</strong></p>

<h2 id="105-è¿è¡Œkillä»»åŠ¡">10.5. è¿è¡ŒKillä»»åŠ¡</h2>

<p>ç°åœ¨æˆ‘ä»¬å·²ç»ç¦ç”¨äº†ä¸€äº›æ®µï¼Œæˆ‘ä»¬å¯ä»¥æäº¤ä¸€ä¸ªKillä»»åŠ¡ï¼Œå®ƒå°†ä»å…ƒæ•°æ®å’Œæ·±å±‚å­˜å‚¨ä¸­åˆ é™¤ç¦ç”¨çš„æ®µã€‚</p>

<p>åœ¨ quickstart/tutorial/deletion-kill.json æä¾›äº†ä¸€ä¸ªKillä»»åŠ¡çš„è§„èŒƒ</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kill"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"dataSource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"deletion-tutorial"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"interval"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-09-12/2015-09-13"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>é€šè¿‡ä»¥ä¸‹çš„å‘½ä»¤å°†ä»»åŠ¡æäº¤åˆ°Overlordï¼š</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">curl</span><span class="w"> </span><span class="nt">-X</span><span class="w"> </span><span class="s1">'POST'</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="s1">'Content-Type:application/json'</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="err">@</span><span class="nx">quickstart/tutorial/deletion-kill.json</span><span class="w"> </span><span class="nx">http://localhost:8081/druid/indexer/v1/task</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œå¯ä»¥çœ‹åˆ°å·²ç»ç¦ç”¨çš„æ®µå·²ç»è¢«ä»æ·±åº¦å­˜å‚¨ä¸­ç§»é™¤äº†ï¼š</p>

<p><img src="https://liulv.work/images/img/1607933796(1).png" alt="1607933796(1)" /></p>

<h1 id="11-æ•°æ®æ¥å…¥çš„è§„èŒƒ">11. æ•°æ®æ¥å…¥çš„è§„èŒƒ</h1>

<p>æœ¬ç« èŠ‚å°†æŒ‡å¯¼è¯»è€…å®šä¹‰æ‘„å–è§„èŒƒçš„è¿‡ç¨‹ï¼ŒæŒ‡å‡ºå…³é”®çš„æ³¨æ„äº‹é¡¹å’ŒæŒ‡å¯¼åŸåˆ™ã€‚</p>

<h2 id="111-ç¤ºä¾‹æ•°æ®">11.1. ç¤ºä¾‹æ•°æ®</h2>

<p>å‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹çš„ç½‘ç»œæµæ•°æ®ï¼š</p>

<ul>
  <li>srcIP: å‘é€ç«¯çš„IPåœ°å€</li>
  <li>srcPort: å‘é€ç«¯çš„ç«¯å£</li>
  <li>dstIP: æ¥æ”¶ç«¯çš„IPåœ°å€</li>
  <li>dstPort: æ¥æ”¶ç«¯çš„ç«¯å£</li>
  <li>protocol: IPåè®®å·ç </li>
  <li>packets: ä¼ è¾“çš„æ•°æ®åŒ…æ•°</li>
  <li>bytes: ä¼ è¾“çš„å­—èŠ‚æ•°</li>
  <li>cost: å‘é€æµé‡çš„æˆæœ¬</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T01:01:35Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">2000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">3000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.4</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T01:01:51Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">2000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">3000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">2000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">3.1</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T01:01:59Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">2000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">3000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">3000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.4</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T01:02:14Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">7000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">4000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">7.9</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T01:02:29Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">7000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">10.2</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T01:03:29Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">7000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">6000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">4.3</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T02:33:14Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"7.7.7.7"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"8.8.8.8"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">4000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">17</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">10000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">22.4</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T02:33:45Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"7.7.7.7"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"8.8.8.8"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">4000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">17</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">20000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">34.5</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T02:35:45Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"7.7.7.7"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"8.8.8.8"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">4000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">17</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">300</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">30000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">46.3</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>å°†ä¸Šé¢çš„JSONå†…å®¹ä¿å­˜åˆ° quickstart/ ä¸­åä¸ºinsertion-tutorial-data.json çš„æ–‡ä»¶ä¸­ã€‚</p>

<p>è®©æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹å®šä¹‰å¯åŠ è½½æ­¤æ•°æ®çš„æ‘„å–è§„èŒƒçš„è¿‡ç¨‹ã€‚</p>

<p>å¯¹äºæœ¬æ•™ç¨‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æœ¬åœ°æ‰¹ç´¢å¼•ä»»åŠ¡ã€‚ä½¿ç”¨å…¶ä»–ä»»åŠ¡ç±»å‹æ—¶ï¼Œæ‘„å–è§„èŒƒçš„æŸäº›æ–¹é¢ä¼šæœ‰æ‰€ä¸åŒï¼Œæœ¬æ•™ç¨‹å°†æŒ‡å‡ºè¿™äº›æ–¹é¢ã€‚</p>

<h2 id="112-å®šä¹‰schema">11.2. å®šä¹‰schema</h2>

<p>Druidæ‘„å–è§„èŒƒä¸­æœ€æ ¸å¿ƒçš„å…ƒç´ æ˜¯ dataSchemaã€‚ dataSchema å®šä¹‰äº†å¦‚ä½•å°†è¾“å…¥æ•°æ®è§£æä¸ºä¸€ç»„åˆ—ï¼Œè¿™äº›åˆ—å°†å­˜å‚¨åœ¨Druidä¸­ã€‚</p>

<p>è®©æˆ‘ä»¬ä»ä¸€ä¸ªç©ºçš„ dataSchema å¼€å§‹ï¼Œå¹¶åœ¨å®Œæˆæ•™ç¨‹çš„è¿‡ç¨‹ä¸­å‘å®ƒæ·»åŠ å­—æ®µã€‚</p>

<p>åœ¨ quickstart/ ä¸­åˆ›å»ºä¸€ä¸ªåä¸º insertion-tutorial-index.json çš„æ–°æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nl">"dataSchema"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="1121-æ•°æ®æºåç§°">11.2.1. æ•°æ®æºåç§°</h3>

<p>æ•°æ®æºçš„åç§°é€šè¿‡ dataSource å­—æ®µæ¥åœ¨ dataSchema ä¸­è¢«æŒ‡å®šï¼š</p>

<p>â€œdataSchemaâ€ : {
  â€œdataSourceâ€ : â€œingestion-tutorialâ€,
}</p>

<h3 id="1122-æ—¶é—´åˆ—">11.2.2. æ—¶é—´åˆ—</h3>

<p>dataSchema éœ€è¦çŸ¥é“å¦‚ä½•ä»è¾“å…¥æ•°æ®ä¸­æå–ä¸»æ—¶é—´æˆ³å­—æ®µã€‚</p>

<p>è¾“å…¥æ•°æ®ä¸­çš„timestampåˆ—åä¸ºâ€tsâ€ï¼ŒåŒ…å«ISO 8601æ—¶é—´æˆ³ï¼Œå› æ­¤è®©æˆ‘ä»¬å°†åŒ…å«è¯¥ä¿¡æ¯çš„ timestampSpec æ·»åŠ åˆ° dataSchemaï¼š</p>

<p>â€œdataSchemaâ€ : {
  â€œdataSourceâ€ : â€œingestion-tutorialâ€,
  â€œtimestampSpecâ€ : {
    â€œformatâ€ : â€œisoâ€,
    â€œcolumnâ€ : â€œtsâ€
  }
}</p>

<h2 id="113-rollup">11.3. Rollup</h2>
<p>åœ¨æ¥æ”¶æ•°æ®æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»è€ƒè™‘æ˜¯å¦è¦ä½¿ç”¨rollup</p>

<ul>
  <li>å¦‚æœå¯ç”¨äº†rollupï¼Œæˆ‘ä»¬éœ€è¦å°†è¾“å…¥åˆ—åˆ†ä¸ºä¸¤ç±»ï¼Œâ€dimensionsâ€å’Œâ€metricsâ€ã€‚â€dimensionsâ€ æ˜¯ç”¨äºrollupçš„åˆ†ç»„åˆ—ï¼Œâ€metricsâ€æ˜¯å°†è¦èšåˆçš„åˆ—ã€‚</li>
  <li>å¦‚æœç¦ç”¨äº†rollupï¼Œåˆ™æ‰€æœ‰åˆ—éƒ½è¢«è§†ä¸ºâ€dimensionsâ€ï¼Œå¹¶ä¸”ä¸ä¼šå‘ç”Ÿé¢„èšåˆã€‚</li>
</ul>

<p>å¯¹äºæœ¬æ•™ç¨‹ï¼Œè®©æˆ‘ä»¬å¯ç”¨rollupã€‚è¿™æ˜¯ç”¨ dataSchema ä¸ŠgranularitySpec æŒ‡å®šçš„ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»¼åˆ</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="err">'</span><span class="nl">"dataSchema"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"dataSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ingestion-tutorial"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timestampSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"format"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"iso"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"column"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ts"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="1131-é€‰æ‹©dimensionå’Œmetrics">11.3.1. é€‰æ‹©dimensionå’ŒMetrics</h3>

<p>å¯¹äºè¿™ä¸ªç¤ºä¾‹æ•°æ®é›†ï¼Œä»¥ä¸‹æ˜¯å¯¹â€dimensionsâ€å’Œâ€metricsâ€çš„åˆç†åˆ’åˆ†ï¼š</p>

<ul>
  <li>Dimensions: srcIP, srcPort, dstIP, dstPort, protocol</li>
  <li>Metrics: packets, bytes, cost</li>
</ul>

<p>è¿™é‡Œçš„ç»´åº¦æ˜¯ä¸€ç»„å±æ€§ï¼Œç”¨äºæ ‡è¯†IPæµé‡çš„å•å‘æµï¼Œè€Œåº¦é‡åˆ™è¡¨ç¤ºç”±ç»´åº¦åˆ†ç»„æŒ‡å®šçš„IPæµé‡çš„äº‹å®ã€‚</p>

<p>è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åœ¨æ‘„å–è§„èŒƒä¸­å®šä¹‰è¿™äº›ç»´åº¦å’Œåº¦é‡ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="nl">"dimensionsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dimensions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"srcIP"</span><span class="p">,</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"srcPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstIP"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"protocol"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="err">,</span><span class="w">
  </span><span class="nl">"metricsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"doubleSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cost"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cost"</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="err">,</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>æ¯ä¸ªç»´åº¦éƒ½æœ‰ä¸€ä¸ª åç§° å’Œä¸€ä¸ª ç±»å‹ï¼Œå…¶ä¸­ ç±»å‹ å¯ä»¥æ˜¯â€longâ€ã€â€floatâ€ã€â€doubleâ€æˆ–â€stringâ€ã€‚</p>

<p>æ³¨æ„ï¼ŒsrcIP æ˜¯ä¸€ä¸ªâ€stringâ€ç»´åº¦ï¼›å¯¹äºstringç»´åº¦ï¼Œåªéœ€æŒ‡å®šä¸€ä¸ªç»´åº¦åç§°å°±è¶³å¤Ÿäº†ï¼Œå› ä¸ºâ€stringâ€æ˜¯é»˜è®¤çš„ç»´åº¦ç±»å‹ã€‚</p>

<p>è¿˜è¦æ³¨æ„ï¼Œprotocol æ˜¯è¾“å…¥æ•°æ®ä¸­çš„ä¸€ä¸ªæ•°å€¼ï¼Œä½†æˆ‘ä»¬å°†å…¶ä½œä¸ºâ€stringâ€åˆ—æ‘„å–ï¼›Druidå°†åœ¨æ‘„å–æœŸé—´å°†è¾“å…¥longå¼ºåˆ¶ä¸ºstringã€‚</p>

<p>å®šä¹‰Metricsæ—¶ï¼Œéœ€è¦æŒ‡å®šåœ¨rollupæœŸé—´å¯¹è¯¥åˆ—æ‰§è¡Œä½•ç§ç±»å‹çš„èšåˆ</p>

<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åœ¨ä¸¤ä¸ªLongç±»å‹çš„Metricsåˆ—ï¼ˆæ•°æ®åŒ…å’Œå­—èŠ‚ï¼‰ä¸Šå®šä¹‰äº†longSumèšåˆï¼Œå¹¶ä¸ºcoståˆ—å®šä¹‰äº†ä¸€ä¸ªdoubleSumèšåˆ</p>

<p>æ³¨æ„ï¼ŒmetricsSpec ä¸ dimensionSpec æˆ– parseSpec ä½äºä¸åŒçš„åµŒå¥—çº§åˆ«ï¼›å®ƒä¸ dataSchema ä¸­çš„ parser å±äºç›¸åŒçš„åµŒå¥—çº§åˆ«</p>

<p>æ³¨æ„ï¼Œæˆ‘ä»¬è¿˜å®šä¹‰äº†ä¸€ä¸ª count èšåˆå™¨ã€‚è®¡æ•°èšåˆå™¨å°†è·Ÿè¸ªåŸå§‹è¾“å…¥æ•°æ®ä¸­æœ‰å¤šå°‘è¡Œè´¡çŒ®ç»™æœ€ç»ˆæ¥æ”¶æ•°æ®ä¸­çš„â€roll upâ€è¡Œã€‚</p>

<p>ç»¼åˆ</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="nl">"dataSchema"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"dataSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ingestion-tutorial"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timestampSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"format"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"iso"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"column"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ts"</span><span class="w">
  </span><span class="p">},</span><span class="w">
    </span><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"dimensionsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dimensions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"srcIP"</span><span class="p">,</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"srcPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstIP"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"protocol"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"metricsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"doubleSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cost"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cost"</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">

</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="114-no-rollup">11.4. No Rollup</h2>

<p>å¦‚æœæˆ‘ä»¬æ²¡ä½¿ç”¨rollupï¼Œæ‰€æœ‰çš„åˆ—éƒ½å°†åœ¨ dimensionsSpec ä¸­æŒ‡å®šï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="w">   </span><span class="nl">"dimensionsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"dimensions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"srcIP"</span><span class="p">,</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"srcPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstIP"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"protocol"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"srcPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"double"</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="err">,</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»¼åˆ</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="nl">"dataSchema"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"dataSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ingestion-tutorial"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timestampSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"format"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"iso"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"column"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ts"</span><span class="w">
  </span><span class="p">},</span><span class="w">
    </span><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"dimensionsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dimensions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"srcIP"</span><span class="p">,</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"srcPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstIP"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"protocol"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"srcPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"double"</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="115-å®šä¹‰ç²’åº¦">11.5. å®šä¹‰ç²’åº¦</h2>

<p>åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæˆ‘ä»¬å·²ç»åœ¨ dataSchema ä¸­å®šä¹‰äº† parser å’ŒmetricsSpecï¼Œå¹¶ä¸”æˆ‘ä»¬å‡ ä¹å·²ç»å®Œæˆäº†æ‘„å–è§„èŒƒçš„ç¼–å†™</p>

<p>æˆ‘ä»¬éœ€è¦åœ¨ granularitySpec ä¸­è®¾ç½®ä¸€äº›å±æ€§ï¼š</p>

<ul>
  <li>granularitySpecç±»å‹ï¼šuniform å’Œ arbitrary æ˜¯ä¸¤ç§æ”¯æŒçš„ç±»å‹ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ uniform ç²’åº¦è§„èŒƒï¼Œå…¶ä¸­æ‰€æœ‰æ®µéƒ½å…·æœ‰ç»Ÿä¸€çš„é—´éš”ï¼ˆä¾‹å¦‚ï¼šæ‰€æœ‰æ®µéƒ½åŒ…å«ä¸€å°æ—¶çš„æ•°æ®ï¼‰</li>
  <li>æ®µç²’åº¦ï¼šå•ä¸ªæ®µä¸­åŒ…å«çš„æ•°æ®çš„æ—¶é—´é—´éš”å¤§å°ï¼Ÿä¾‹å¦‚ï¼šDAY, WEEK</li>
  <li>æ—¶é—´åˆ—ä¸­æ—¶é—´æˆ³çš„bucketingç²’åº¦ï¼ˆç§°ä¸ºqueryGranularity)</li>
</ul>

<h3 id="1151-æ®µç²’åº¦">11.5.1. æ®µç²’åº¦</h3>

<p>æ®µç²’åº¦ç”± granularitySpec ä¸­çš„ SegmentGranularity å±æ€§é…ç½®ã€‚å¯¹äºæœ¬æ•™ç¨‹ï¼Œæˆ‘ä»¬å°†åˆ›å»ºå°æ—¶æ®µï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"uniform"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"segmentGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"HOUR"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>æˆ‘ä»¬çš„è¾“å…¥æ•°æ®æœ‰ä¸¤ä¸ªç‹¬ç«‹å°æ—¶çš„äº‹ä»¶ï¼Œå› æ­¤æ­¤ä»»åŠ¡å°†ç”Ÿæˆä¸¤ä¸ªæ®µã€‚</p>

<h3 id="1152-æŸ¥è¯¢ç²’åº¦">11.5.2. æŸ¥è¯¢ç²’åº¦</h3>

<p>æŸ¥è¯¢ç²’åº¦ç”± granularitySpec ä¸­çš„ queryGranularity å±æ€§é…ç½®ã€‚å¯¹äºæœ¬æ•™ç¨‹ï¼Œæˆ‘ä»¬ä½¿ç”¨åˆ†é’Ÿç²’åº¦:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"uniform"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"segmentGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"HOUR"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"queryGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"MINUTE"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>è¦æŸ¥çœ‹æŸ¥è¯¢ç²’åº¦çš„å½±å“ï¼Œè®©æˆ‘ä»¬ä»åŸå§‹è¾“å…¥æ•°æ®ä¸­æŸ¥çœ‹è¿™ä¸€è¡Œ:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T01:03:29Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">7000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">6000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">4.3</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>å½“è¿™ä¸€è¡Œä»¥åˆ†é’ŸæŸ¥è¯¢ç²’åº¦æ‘„å–æ—¶ï¼ŒDruidä¼šå°†è¯¥è¡Œçš„æ—¶é—´æˆ³è®¾ç½®ä¸ºåˆ†é’Ÿæ¡¶ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T01:03:00Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">7000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">6000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">4.3</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="1153-å®šä¹‰æ—¶é—´é—´éš”batch-only">11.5.3. å®šä¹‰æ—¶é—´é—´éš”ï¼ˆbatch onlyï¼‰</h3>

<p>å¯¹äºæ‰¹å¤„ç†ä»»åŠ¡ï¼Œéœ€è¦å®šä¹‰æ—¶é—´é—´éš”ã€‚æ—¶é—´æˆ³è¶…å‡ºæ—¶é—´é—´éš”çš„è¾“å…¥è¡Œå°†ä¸ä¼šè¢«æ¥æ”¶ã€‚</p>

<p>æ—¶é—´é—´éš”æŒ‡å®šåœ¨ granularitySpec é…ç½®é¡¹ä¸­intervalsçš„é…ç½®æ—¶é—´èŒƒå›´ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"uniform"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"segmentGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"HOUR"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"queryGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"MINUTE"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"intervals"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"2018-01-01/2018-01-02"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»¼åˆ</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="nl">"dataSchema"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"dataSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ingestion-tutorial"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timestampSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"format"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"iso"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"column"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ts"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"dimensionsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dimensions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"srcIP"</span><span class="p">,</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"srcPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstIP"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"protocol"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"metricsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"doubleSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cost"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cost"</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"uniform"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"segmentGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"HOUR"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"queryGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"MINUTE"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"intervals"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"2018-01-01/2018-01-02"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="116-å®šä¹‰ä»»åŠ¡ç±»å‹">11.6. å®šä¹‰ä»»åŠ¡ç±»å‹</h2>

<p>æˆ‘ä»¬ç°åœ¨å·²ç»å®Œæˆäº† dataSchema çš„å®šä¹‰ã€‚å‰©ä¸‹çš„æ­¥éª¤æ˜¯å°†æˆ‘ä»¬åˆ›å»ºçš„æ•°æ®æ¨¡å¼æ”¾å…¥ä¸€ä¸ªæ‘„å–ä»»åŠ¡è§„èŒƒä¸­ï¼Œå¹¶æŒ‡å®šè¾“å…¥æºã€‚</p>

<p>dataSchema åœ¨æ‰€æœ‰ä»»åŠ¡ç±»å‹ä¹‹é—´å…±äº«ï¼Œä½†æ¯ä¸ªä»»åŠ¡ç±»å‹éƒ½æœ‰è‡ªå·±çš„è§„èŒƒæ ¼å¼ã€‚å¯¹äºæœ¬æ•™ç¨‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æœ¬æœºæ‰¹å¤„ç†æ‘„å–ä»»åŠ¡typeç±»å‹å®šä¹‰ä¸ºï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"spec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dataSchema"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="err">....</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="117-å®šä¹‰è¾“å…¥æº">11.7. å®šä¹‰è¾“å…¥æº</h2>

<p>ç°åœ¨è®©æˆ‘ä»¬å®šä¹‰è¾“å…¥æºï¼Œå®ƒåœ¨ ioConfig å¯¹è±¡ä¸­æŒ‡å®šã€‚æ¯ä¸ªä»»åŠ¡ç±»å‹éƒ½æœ‰è‡ªå·±çš„ ioConfig ç±»å‹ã€‚è¦è¯»å–è¾“å…¥æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šä¸€ä¸ªinputSourceã€‚æˆ‘ä»¬å‰é¢ä¿å­˜çš„ç¤ºä¾‹ç½‘ç»œæµæ•°æ®éœ€è¦ä»æœ¬åœ°æ–‡ä»¶ä¸­è¯»å–ï¼Œè¯¥æ–‡ä»¶é…ç½®å¦‚ä¸‹ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="nl">"ioConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"inputSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"local"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"baseDir"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"quickstart/"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"filter"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ingestion-tutorial-data.json"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="118-å®šä¹‰æ•°æ®æ ¼å¼">11.8. å®šä¹‰æ•°æ®æ ¼å¼</h2>

<p>å®šä¹‰æ•°æ®æ ¼å¼ä¹Ÿæ˜¯åœ¨ ioConfig å¯¹è±¡ä¸­æŒ‡å®šï¼Œå› ä¸ºæˆ‘ä»¬çš„è¾“å…¥æ•°æ®ä¸ºJSONå­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬ä½¿ç”¨jsonçš„ inputFormat:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="nl">"ioConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"inputFormat"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"json"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»¼åˆï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"spec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dataSchema"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"dataSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ingestion-tutorial"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"timestampSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"format"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"iso"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"column"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ts"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"dimensionsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"dimensions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"srcIP"</span><span class="p">,</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"srcPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstIP"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"protocol"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"metricsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"doubleSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cost"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cost"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"uniform"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"segmentGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"HOUR"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"queryGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"MINUTE"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"intervals"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"2018-01-01/2018-01-02"</span><span class="p">],</span><span class="w">
        </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"ioConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"inputSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"local"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"baseDir"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"quickstart/"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"filter"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ingestion-tutorial-data.json"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"inputFormat"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"json"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="119-é¢å¤–çš„è°ƒæ•´">11.9. é¢å¤–çš„è°ƒæ•´</h2>

<p>æ¯ä¸€ä¸ªæ‘„å…¥ä»»åŠ¡éƒ½æœ‰ä¸€ä¸ª tuningConfig éƒ¨åˆ†ï¼Œè¯¥éƒ¨åˆ†å…è®¸ç”¨æˆ·å¯ä»¥è°ƒæ•´ä¸åŒçš„æ‘„å…¥å‚æ•°</p>

<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ª tuningConfigï¼Œå®ƒä¸ºæœ¬åœ°æ‰¹å¤„ç†æ‘„å–ä»»åŠ¡è®¾ç½®ç›®æ ‡æ®µå¤§å°ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nl">"tuningConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"maxRowsPerSegment"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">5000000</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>æ³¨æ„ï¼šæ¯ä¸€ç±»æ‘„å…¥ä»»åŠ¡éƒ½æœ‰è‡ªå·±çš„ tuningConfig ç±»å‹</p>

<h2 id="1110-æœ€ç»ˆå½¢æˆçš„è§„èŒƒ">11.10. æœ€ç»ˆå½¢æˆçš„è§„èŒƒ</h2>

<p>æˆ‘ä»¬å·²ç»å®šä¹‰äº†æ‘„å–è§„èŒƒï¼Œç°åœ¨åº”è¯¥å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"spec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dataSchema"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"dataSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ingestion-tutorial"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"timestampSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"format"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"iso"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"column"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ts"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"dimensionsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"dimensions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"srcIP"</span><span class="p">,</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"srcPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstIP"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"protocol"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"metricsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"doubleSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cost"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cost"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"uniform"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"segmentGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"HOUR"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"queryGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"MINUTE"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"intervals"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"2018-01-01/2018-01-02"</span><span class="p">],</span><span class="w">
        </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"ioConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"inputSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"local"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"baseDir"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"quickstart/"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"filter"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ingestion-tutorial-data.json"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"inputFormat"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"json"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"tuningConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxRowsPerSegment"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">5000000</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="1111-æäº¤ä»»åŠ¡å’ŒæŸ¥è¯¢æ•°æ®">11.11. æäº¤ä»»åŠ¡å’ŒæŸ¥è¯¢æ•°æ®</h2>

<p>åœ¨Druidæ ¹ç›®å½•ä¸‹æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">bin/post-index-task</span><span class="w"> </span><span class="nt">--file</span><span class="w"> </span><span class="nx">quickstart/ingestion-tutorial-index.json</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>è„šæœ¬è¿è¡Œå®Œæˆåæˆ‘ä»¬å¯ä»¥æŸ¥è¯¢æ•°æ®ã€‚</p>

<p>è¿è¡Œ bin/dsql ä¸­è¿è¡Œ select * from â€œingestion-tutorialâ€ æŸ¥è¯¢æˆ‘ä»¬æ‘„å…¥ä»€ä¹ˆæ ·çš„æ•°æ®</p>

<p><img src="https://liulv.work/images/img/20201215115911.png" alt="20201215115911" /></p>

<h1 id="12-è¾“å…¥æ•°æ®å˜æ¢">12. è¾“å…¥æ•°æ®å˜æ¢</h1>

<p>æœ¬ç« èŠ‚å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨è½¬æ¢è§„èŒƒåœ¨æ¥æ”¶æœŸé—´è¿‡æ»¤å’Œè½¬æ¢è¾“å…¥æ•°æ®ã€‚</p>

<h2 id="121-æ ·ä¾‹æ•°æ®">12.1. æ ·ä¾‹æ•°æ®</h2>

<p>æˆ‘ä»¬åœ¨ quickstart/tutorial/transform-data.json ä¸­åŒ…æ‹¬äº†æ ·ä¾‹æ•°æ®ï¼Œä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬å±•ç¤ºä¸€ä¸‹ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T07:01:35Z"</span><span class="p">,</span><span class="nl">"animal"</span><span class="p">:</span><span class="s2">"octopus"</span><span class="p">,</span><span class="w">  </span><span class="nl">"location"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nl">"number"</span><span class="p">:</span><span class="mi">100</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T05:01:35Z"</span><span class="p">,</span><span class="nl">"animal"</span><span class="p">:</span><span class="s2">"mongoose"</span><span class="p">,</span><span class="w"> </span><span class="nl">"location"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nl">"number"</span><span class="p">:</span><span class="mi">200</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T06:01:35Z"</span><span class="p">,</span><span class="nl">"animal"</span><span class="p">:</span><span class="s2">"snake"</span><span class="p">,</span><span class="w"> </span><span class="nl">"location"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nl">"number"</span><span class="p">:</span><span class="mi">300</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T01:01:35Z"</span><span class="p">,</span><span class="nl">"animal"</span><span class="p">:</span><span class="s2">"lion"</span><span class="p">,</span><span class="w"> </span><span class="nl">"location"</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nl">"number"</span><span class="p">:</span><span class="mi">300</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="122-ä½¿ç”¨è½¬æ¢è§„èŒƒåŠ è½½æ•°æ®">12.2. ä½¿ç”¨è½¬æ¢è§„èŒƒåŠ è½½æ•°æ®</h2>

<p>åœ¨è½¬æ¢è§„èŒƒä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªè¡¨è¾¾å¼è½¬æ¢ï¼š</p>

<ul>
  <li>super-animal: åœ¨ â€œanimalâ€ åˆ—çš„å€¼å‰åŠ ä¸Šâ€super-â€œã€‚è¿™å°†ç”¨è½¬æ¢åçš„ç‰ˆæœ¬è¦†ç›– animal åˆ—ï¼Œå› ä¸ºè½¬æ¢çš„åç§°æ˜¯ animal</li>
  <li>triple-number: å°†æ•°å­—åˆ—ä¹˜ä»¥3, è¿™å°†åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸‰ä½æ•°åˆ—ã€‚æ³¨æ„ï¼Œæˆ‘ä»¬åŒæ—¶æ¥æ”¶åŸå§‹åˆ—å’Œè½¬æ¢åˆ—</li>
</ul>

<p>å¦å¤–ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªåŒ…å«ä¸‰ä¸ªå­å¥çš„ORè¿‡æ»¤å™¨ï¼š</p>

<ul>
  <li>super-animal å€¼åŒ¹é…â€super-mongooseâ€</li>
  <li>triple-number å€¼åŒ¹é…300</li>
  <li>locationå€¼åŒ¹é…3</li>
</ul>

<p>è¿™ä¸ªè¿‡æ»¤å™¨é€‰æ‹©å‰3è¡Œï¼Œå®ƒå°†æ’é™¤è¾“å…¥æ•°æ®ä¸­çš„æœ€åä¸€ä¸ªâ€lionâ€è¡Œã€‚è¯·æ³¨æ„ï¼Œè¿‡æ»¤å™¨æ˜¯åœ¨è½¬æ¢ä¹‹ååº”ç”¨çš„ã€‚è¿™ä¸ªåœ¨spec - dataSchema -transformSpec èŠ‚ç‚¹ä¸‹é…ç½®ï¼Œå¦‚ä¸‹ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="nl">"transformSpec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"transforms"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"expression"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"animal"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"expression"</span><span class="p">:</span><span class="w"> </span><span class="s2">"concat('super-', animal)"</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"expression"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"triple-number"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"expression"</span><span class="p">:</span><span class="w"> </span><span class="s2">"number * 3"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"filter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"or"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"selector"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dimension"</span><span class="p">:</span><span class="w"> </span><span class="s2">"animal"</span><span class="p">,</span><span class="w"> </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"super-mongoose"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"selector"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dimension"</span><span class="p">:</span><span class="w"> </span><span class="s2">"triple-number"</span><span class="p">,</span><span class="w"> </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"300"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"selector"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dimension"</span><span class="p">:</span><span class="w"> </span><span class="s2">"location"</span><span class="p">,</span><span class="w"> </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3"</span><span class="w"> </span><span class="p">}</span><span class="w">
          </span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>å®Œæ•´</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"spec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dataSchema"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"dataSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"transform-tutorial"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"timestampSpec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"column"</span><span class="p">:</span><span class="w"> </span><span class="s2">"timestamp"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"iso"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"dimensionsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"dimensions"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"animal"</span><span class="p">,</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"location"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"metricsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"number"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"number"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"triple-number"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"triple-number"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"uniform"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"segmentGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"week"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"queryGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"minute"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"intervals"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"2018-01-01/2018-01-03"</span><span class="p">],</span><span class="w">
        </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"transformSpec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"transforms"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"expression"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"animal"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"expression"</span><span class="p">:</span><span class="w"> </span><span class="s2">"concat('super-', animal)"</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"expression"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"triple-number"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"expression"</span><span class="p">:</span><span class="w"> </span><span class="s2">"number * 3"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"filter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"or"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"selector"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dimension"</span><span class="p">:</span><span class="w"> </span><span class="s2">"animal"</span><span class="p">,</span><span class="w"> </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"super-mongoose"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"selector"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dimension"</span><span class="p">:</span><span class="w"> </span><span class="s2">"triple-number"</span><span class="p">,</span><span class="w"> </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"300"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"selector"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dimension"</span><span class="p">:</span><span class="w"> </span><span class="s2">"location"</span><span class="p">,</span><span class="w"> </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3"</span><span class="w"> </span><span class="p">}</span><span class="w">
          </span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"ioConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"inputSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"local"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"baseDir"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"quickstart/tutorial"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"filter"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"transform-data.json"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"inputFormat"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="s2">"json"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"appendToExisting"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"tuningConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxRowsPerSegment"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">5000000</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxRowsInMemory"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">25000</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="123-æäº¤ä»»åŠ¡">12.3. æäº¤ä»»åŠ¡</h2>

<p>ç°åœ¨æäº¤ä½äº quickstart/tutorial/transform-index.json çš„ä»»åŠ¡ï¼š</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">bin/post-index-task</span><span class="w"> </span><span class="nt">--file</span><span class="w"> </span><span class="nx">quickstart/tutorial/transform-index.json</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="124-æŸ¥è¯¢å·²è½¬æ¢çš„æ•°æ®">12.4. æŸ¥è¯¢å·²è½¬æ¢çš„æ•°æ®</h2>

<p>è¿è¡Œ bin/dsql æäº¤ select * from â€œtransform-tutorialâ€ æŸ¥è¯¢æ¥çœ‹æ‘„å…¥çš„æ•°æ®ï¼š</p>

<p><img src="https://liulv.work/images/img/20201215161618.png" alt="20201215161618" /></p>

<h1 id="13-æ¶æ„è®¾è®¡">13. æ¶æ„è®¾è®¡</h1>

<p>Druidæœ‰ä¸€ä¸ªå¤šè¿›ç¨‹ã€åˆ†å¸ƒå¼çš„æ¶æ„ï¼Œè¯¥æ¶æ„è®¾è®¡ä¸ºäº‘å‹å¥½ä¸”æ˜“äºæ“ä½œã€‚æ¯ä¸ªDruidè¿›ç¨‹éƒ½å¯ä»¥ç‹¬ç«‹é…ç½®å’Œæ‰©å±•ï¼Œåœ¨é›†ç¾¤ä¸Šæä¾›æœ€å¤§çš„çµæ´»æ€§ã€‚è¿™ç§è®¾è®¡è¿˜æä¾›äº†å¢å¼ºçš„å®¹é”™èƒ½åŠ›ï¼šä¸€ä¸ªç»„ä»¶çš„ä¸­æ–­ä¸ä¼šç«‹å³å½±å“å…¶ä»–ç»„ä»¶ã€‚</p>

<h2 id="131-è¿›ç¨‹ä¸æœåŠ¡">13.1. è¿›ç¨‹ä¸æœåŠ¡</h2>

<p>Druidæœ‰è‹¥å¹²ä¸åŒç±»å‹çš„è¿›ç¨‹ï¼Œç®€å•æè¿°å¦‚ä¸‹ï¼š</p>

<ul>
  <li><a href="#">Coordinator</a> è¿›ç¨‹ç®¡ç†é›†ç¾¤ä¸­æ•°æ®çš„å¯ç”¨æ€§</li>
  <li><a href="#">Overlord</a> è¿›ç¨‹æ§åˆ¶æ•°æ®æ‘„å–è´Ÿè½½çš„åˆ†é…</li>
  <li><a href="#">Broker</a> è¿›ç¨‹å¤„ç†æ¥è‡ªå¤–éƒ¨å®¢æˆ·ç«¯çš„æŸ¥è¯¢è¯·æ±‚</li>
  <li><a href="#">Router</a> è¿›ç¨‹æ˜¯ä¸€ä¸ªå¯é€‰è¿›ç¨‹ï¼Œå¯ä»¥å°†è¯·æ±‚è·¯ç”±åˆ°Brokersã€Coordinatorså’ŒOverlords</li>
  <li><a href="#">Historical</a> è¿›ç¨‹å­˜å‚¨å¯æŸ¥è¯¢çš„æ•°æ®</li>
  <li><a href="#">MiddleManager</a> è¿›ç¨‹è´Ÿè´£æ‘„å–æ•°æ®</li>
</ul>

<p>Druidè¿›ç¨‹å¯ä»¥æŒ‰ç…§æ‚¨å–œæ¬¢çš„æ–¹å¼éƒ¨ç½²ï¼Œä½†æ˜¯ä¸ºäº†ä¾¿äºéƒ¨ç½²ï¼Œæˆ‘ä»¬å»ºè®®å°†å®ƒä»¬ç»„ç»‡æˆä¸‰ç§æœåŠ¡å™¨ç±»å‹ï¼šMasterã€Queryå’ŒDataã€‚</p>

<ul>
  <li><strong>Master</strong>: è¿è¡ŒCoordinatorå’ŒOverlordè¿›ç¨‹ï¼Œç®¡ç†æ•°æ®å¯ç”¨æ€§å’Œæ‘„å–</li>
  <li><strong>Query:</strong> è¿è¡ŒBrokerå’Œå¯é€‰çš„Routerè¿›ç¨‹ï¼Œå¤„ç†æ¥è‡ªå¤–éƒ¨å®¢æˆ·ç«¯çš„è¯·æ±‚</li>
  <li><strong>Data:</strong> è¿è¡ŒHistoricalå’ŒMiddleManagerè¿›ç¨‹ï¼Œæ‰§è¡Œæ‘„å–è´Ÿè½½å’Œå­˜å‚¨æ‰€æœ‰å¯æŸ¥è¯¢çš„æ•°æ®</li>
</ul>

<p>å…³äºè¿›ç¨‹å’ŒæœåŠ¡ç»„ç»‡çš„æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥æŸ¥çœ‹Druid<a href="#">è¿›ç¨‹ä¸æœåŠ¡</a></p>

<h2 id="132-å¤–éƒ¨ä¾èµ–">13.2. å¤–éƒ¨ä¾èµ–</h2>

<p>é™¤äº†å†…ç½®çš„è¿›ç¨‹ç±»å‹å¤–ï¼ŒDruidåŒæ—¶æœ‰ä¸‰ä¸ªå¤–éƒ¨ä¾èµ–ï¼Œå®ƒä»¬æ—¨åœ¨åˆ©ç”¨ç°æœ‰çš„åŸºç¡€è®¾æ–½ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚</p>

<h2 id="133-æ·±åº¦å­˜å‚¨">13.3. æ·±åº¦å­˜å‚¨</h2>

<p>æ¯ä¸ªDruidæœåŠ¡å™¨éƒ½å¯ä»¥è®¿é—®çš„å…±äº«æ–‡ä»¶å­˜å‚¨ã€‚åœ¨é›†ç¾¤éƒ¨ç½²ä¸­ï¼Œé€šå¸¸ä½¿ç”¨ä¸€ä¸ªåƒS3æˆ–HDFSè¿™æ ·çš„åˆ†å¸ƒå¼å¯¹è±¡å­˜å‚¨ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªç½‘ç»œæŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿã€‚åœ¨å•æœåŠ¡å™¨éƒ¨ç½²ä¸­ï¼Œé€šå¸¸ä½¿ç”¨æœ¬åœ°ç£ç›˜ã€‚Druidä½¿ç”¨æ·±åº¦å­˜å‚¨æ¥å­˜å‚¨ä»»ä½•å·²è¢«ç³»ç»Ÿæ¥æ”¶çš„æ•°æ®ã€‚</p>

<p>Druidåªä½¿ç”¨æ·±åº¦å­˜å‚¨ä½œä¸ºæ•°æ®å¤‡ä»½ï¼Œå¹¶ä½œä¸ºåœ¨åå°Druidè¿›ç¨‹ä¹‹é—´ä¼ è¾“æ•°æ®çš„ä¸€ç§æ–¹å¼ã€‚ä¸ºäº†å“åº”æŸ¥è¯¢ï¼ŒHistoricalè¿›ç¨‹ä¸ä¼šä»æ·±å±‚å­˜å‚¨ä¸­è¯»å–æ•°æ®ï¼Œè€Œæ˜¯ä»æœ¬åœ°ç£ç›˜è¯»å–åœ¨æ‰§è¡Œä»»ä½•æŸ¥è¯¢ä¹‹å‰é¢„ç¼“å­˜çš„æ®µï¼Œè¿™æ„å‘³ç€Druidåœ¨æŸ¥è¯¢æœŸé—´ä¸éœ€è¦è®¿é—®æ·±å±‚å­˜å‚¨ï¼Œè¿™æœ‰åŠ©äºå®ƒæä¾›å°½å¯èƒ½æœ€å¥½çš„æŸ¥è¯¢å»¶è¿Ÿã€‚è¿™ä¹Ÿæ„å‘³ç€æ‚¨å¿…é¡»åœ¨æ·±å±‚å­˜å‚¨å’Œæ‰€æœ‰Historicalè¿›ç¨‹ä¸­éƒ½æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´æ¥å­˜å‚¨è®¡åˆ’åŠ è½½çš„æ•°æ®ã€‚</p>

<p>æ·±åº¦å­˜å‚¨æ˜¯Druidå¼¹æ€§ã€å®¹é”™è®¾è®¡çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚å³ä½¿æ¯ä¸ªæ•°æ®æœåŠ¡å™¨éƒ½ä¸¢å¤±å¹¶é‡æ–°é…ç½®ï¼ŒDruidä¹Ÿå¯ä»¥ä»æ·±å±‚å­˜å‚¨å¯åŠ¨ã€‚</p>

<p>æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§æ·±åº¦å­˜å‚¨</p>

<h2 id="134-å…ƒæ•°æ®å­˜å‚¨">13.4. å…ƒæ•°æ®å­˜å‚¨</h2>

<p>å…ƒæ•°æ®å­˜å‚¨åŒ…å«å„ç§å…±äº«çš„ç³»ç»Ÿå…ƒæ•°æ®ï¼Œå¦‚æ®µå¯ç”¨æ€§ä¿¡æ¯å’Œä»»åŠ¡ä¿¡æ¯ã€‚åœ¨é›†ç¾¤éƒ¨ç½²ä¸­ï¼Œé€šå¸¸ä½¿ç”¨åƒPostgreSQLæˆ–MySQLè¿™æ ·çš„ä¼ ç»ŸRDBMSã€‚åœ¨å•æœåŠ¡å™¨éƒ¨ç½²ä¸­ï¼Œé€šå¸¸ä½¿ç”¨æœ¬åœ°å­˜å‚¨çš„Apache Derbyæ•°æ®åº“ã€‚</p>

<p>æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§å…ƒæ•°æ®å­˜å‚¨.</p>

<h2 id="135-zookeeper">13.5. Zookeeper</h2>

<p>ç”¨äºå†…éƒ¨æœåŠ¡å‘ç°ã€åè°ƒå’Œé¢†å¯¼é€‰ä¸¾ã€‚</p>

<p>æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§Zookeeper</p>

<h2 id="136-æ¶æ„å›¾">13.6. æ¶æ„å›¾</h2>

<p>ä¸‹å›¾æ˜¾ç¤ºäº†ä½¿ç”¨å»ºè®®çš„Master/Query/DataæœåŠ¡ç»„ç»‡ï¼ŒæŸ¥è¯¢å’Œæ•°æ®å¦‚ä½•é€šè¿‡æ­¤ä½“ç³»ç»“æ„æµåŠ¨ï¼š</p>

<p><img src="https://liulv.work/images/img/20201215180836.png" alt="20201215180836" /></p>

<h2 id="137-å­˜å‚¨è®¾è®¡">13.7. å­˜å‚¨è®¾è®¡</h2>

<p><strong>æ•°æ®æºå’Œæ®µ</strong></p>

<p>Druidæ•°æ®è¢«å­˜å‚¨åœ¨â€datasourcesâ€ä¸­ï¼Œç±»ä¼¼äºä¼ ç»ŸRDBMSä¸­çš„è¡¨ã€‚æ¯ä¸€ä¸ªæ•°æ®æºå¯ä»¥æ ¹æ®æ—¶é—´è¿›è¡Œåˆ†åŒºï¼Œå¯é€‰åœ°è¿˜å¯ä»¥è¿›ä¸€æ­¥æ ¹æ®å…¶ä»–å±æ€§è¿›è¡Œåˆ†åŒºã€‚æ¯ä¸€ä¸ªæ—¶é—´èŒƒå›´ç§°ä¸ºä¸€ä¸ªâ€å—ï¼ˆchunkï¼‰â€(ä¾‹å¦‚ï¼Œå¦‚æœæ•°æ®æºæŒ‰å¤©åˆ†åŒºï¼Œåˆ™ä¸ºä¸€å¤©)ã€‚åœ¨ä¸€ä¸ªå—ä¸­ï¼Œæ•°æ®è¢«åˆ†ä¸ºä¸€ä¸ªæˆ–è€…å¤šä¸ªâ€æ®µï¼ˆsegmentsï¼‰â€ã€‚æ¯ä¸ªæ®µæ˜¯ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ç”±æ•°ç™¾ä¸‡æ¡æ•°æ®ç»„æˆã€‚ç”±äºæ®µè¢«ç»„ç»‡æˆæ—¶é—´å—ï¼Œå› æ­¤æœ‰æ—¶å°†æ®µè§†ä¸ºå­˜åœ¨äºå¦‚ä¸‹æ—¶é—´çº¿ä¸Šæ˜¯æœ‰å¸®åŠ©çš„ï¼š</p>

<p><img src="https://liulv.work/images/img/20201215181028.png" alt="20201215181028" /></p>

<p>ä¸€ä¸ªæ•°æ®æºå¯èƒ½æœ‰å‡ ä¸ªæ®µåˆ°å‡ åä¸‡ç”šè‡³å‡ ç™¾ä¸‡ä¸ªæ®µã€‚æ¯ä¸ªæ®µéƒ½æ˜¯åœ¨MiddleManagerä¸Šåˆ›å»ºçš„ï¼Œä½†æ­¤æ—¶æ®µæ˜¯å¯å˜çš„å’Œæœªæäº¤çš„ã€‚æ®µæ„å»ºè¿‡ç¨‹åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼Œæ—¨åœ¨ç”Ÿæˆä¸€ä¸ªç´§å‡‘ä¸”æ”¯æŒå¿«é€ŸæŸ¥è¯¢çš„æ•°æ®æ–‡ä»¶ï¼š</p>

<ul>
  <li>è½¬æ¢ä¸ºåˆ—æ ¼å¼</li>
  <li>æ„å»ºä½å›¾ç´¢å¼•</li>
  <li>ä½¿ç”¨ä¸åŒçš„ç®—æ³•è¿›è¡Œå‹ç¼©
    <ul>
      <li>å­—ç¬¦ä¸²åˆ—idå­˜å‚¨æœ€å°åŒ–çš„å­—å…¸ç¼–ç </li>
      <li>å¯¹ä½å›¾ç´¢å¼•åšå‹ç¼©</li>
      <li>æ‰€æœ‰åˆ—çš„ç±»å‹æ„ŸçŸ¥å‹ç¼©</li>
    </ul>
  </li>
</ul>

:ET