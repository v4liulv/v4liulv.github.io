I"Zş<h1 id="1-akkaç®€ä»‹">1. Akkaç®€ä»‹</h1>

<ul>
  <li>ä¸ºä»€ä¹ˆè¦ç”¨Akka/å¥½å¤„</li>
  <li>Akkaä»‹ç»</li>
</ul>

<h2 id="11-ä¸ºä»€ä¹ˆè¦ç”¨akka">1.1. ä¸ºä»€ä¹ˆè¦ç”¨Akka</h2>

<p>Akkaæä¾›å¯æ‰©å±•çš„å®æ—¶äº‹åŠ¡å¤„ç†ã€‚</p>

<p>Akkaæ˜¯ä¸€ä¸ªè¿è¡Œæ—¶ä¸ç¼–ç¨‹æ¨¡å‹ä¸€è‡´çš„ç³»ç»Ÿï¼Œä¸ºä»¥ä¸‹ç›®æ ‡è®¾è®¡ï¼š</p>

<ul>
  <li>å‚ç›´æ‰©å±•ï¼ˆå¹¶å‘ï¼‰</li>
  <li>æ°´å¹³æ‰©å±•ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰</li>
  <li>é«˜å®¹é”™</li>
</ul>

<p>åœ¨Akkaçš„ä¸–ç•Œé‡Œï¼Œåªæœ‰ä¸€ä¸ªå†…å®¹éœ€è¦å­¦ä¹ å’Œç®¡ç†ï¼Œå…·æœ‰é«˜å†…èšå’Œé«˜ä¸€è‡´çš„è¯­ä¹‰ã€‚</p>

<p>Akkaæ˜¯ä¸€ç§é«˜åº¦å¯æ‰©å±•çš„è½¯ä»¶ï¼Œè¿™ä¸ä»…ä»…è¡¨ç°åœ¨æ€§èƒ½æ–¹é¢ï¼Œä¹Ÿè¡¨ç°åœ¨å®ƒæ‰€é€‚ç”¨çš„åº”ç”¨çš„å¤§å°ã€‚Akkaçš„æ ¸å¿ƒï¼ŒAkka-actoræ˜¯éå¸¸å°çš„ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿åœ°æ”¾è¿›ä½ çš„åº”ç”¨ä¸­ï¼Œæä¾›ä½ éœ€è¦çš„å¼‚æ­¥æ— é”å¹¶è¡ŒåŠŸèƒ½ï¼Œä¸ä¼šæœ‰ä»»ä½•å›°æ‰°ã€‚</p>

<p>ä½ å¯ä»¥ä»»æ„é€‰æ‹©Akkaçš„æŸäº›éƒ¨åˆ†é›†æˆåˆ°ä½ çš„åº”ç”¨ä¸­ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å®Œæ•´çš„åŒ…â€”â€”Akka å¾®å†…æ ¸ï¼Œå®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å®¹å™¨ï¼Œå¯ä»¥ç›´æ¥éƒ¨ç½²ä½ çš„Akkaåº”ç”¨ã€‚éšç€CPUæ ¸æ•°è¶Šæ¥è¶Šå¤šï¼Œå³ä½¿ä½ åªä½¿ç”¨ä¸€å°ç”µè„‘ï¼ŒAkkaä¹Ÿå¯ä½œä¸ºä¸€ç§æä¾›å“è¶Šæ€§èƒ½çš„é€‰æ‹©ã€‚ Akkaè¿˜åŒæ—¶æä¾›å¤šç§å¹¶å‘èŒƒå‹ï¼Œå…è®¸ç”¨æˆ·é€‰æ‹©æ­£ç¡®çš„å·¥å…·æ¥å®Œæˆå·¥ä½œã€‚</p>

<h2 id="12-ä½¿ç”¨akkaå¸¦æ¥çš„å¥½å¤„">1.2. ä½¿ç”¨Akkaå¸¦æ¥çš„å¥½å¤„</h2>

<ul>
  <li>
    <p>Akkaæä¾›ä¸€ç§Actorå¹¶å‘æ¨¡å‹ï¼Œå…¶ç²’åº¦æ¯”çº¿ç¨‹å°å¾ˆå¤šï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥åœ¨é¡¹ç›®ä¸­ä½¿ç”¨å¤§é‡çš„Actorã€‚</p>
  </li>
  <li>
    <p>Akkaæä¾›äº†ä¸€å¥—å®¹é”™æœºåˆ¶ï¼Œå…è®¸åœ¨Actorå‡ºé”™æ—¶è¿›è¡Œä¸€äº›æ¢å¤æˆ–è€…é‡ç½®æ“ä½œ</p>
  </li>
  <li>
    <p>AKKAä¸ä»…å¯ä»¥åœ¨å•å‡»ä¸Šæ„å»ºé«˜å¹¶å‘ç¨‹åºï¼Œä¹Ÿå¯ä»¥åœ¨ç½‘ç»œä¸­æ„å»ºåˆ†å¸ƒå¼ç¨‹åºï¼Œå¹¶æä¾›ä½ç½®é€æ˜çš„Actorå®šä½æœåŠ¡</p>
  </li>
</ul>

<h2 id="13-actor">1.3. Actor</h2>

<p>actoræ˜¯akkaæ‰§è¡Œçš„åŸºæœ¬å•å…ƒï¼Œæ¯”çº¿ç¨‹æ›´è½»é‡çº§ï¼Œä½¿ç”¨akkaå¯ä»¥å¿˜æ‰çº¿ç¨‹äº†ã€‚äº‹å®ä¸Šï¼Œçº¿ç¨‹è°ƒåº¦å·²ç»è¢«akkaå°è£…ã€‚</p>

<p>actorç”Ÿå‘½å‘¨æœŸ</p>

<h2 id="14-æ¶ˆæ¯æŠ•é€’">1.4. æ¶ˆæ¯æŠ•é€’</h2>

<ul>
  <li>
    <p>Akkaåº”ç”¨æ˜¯æœ‰æ¶ˆæ¯é©±åŠ¨çš„ï¼Œæ¶ˆæ¯æ˜¯é™¤äº†Actorä¹‹å¤–æœ€é‡è¦çš„æ ¸å¿ƒç»„ä»¶ã€‚åœ¨Actorä¹‹å‰æŠ•é€’æ¶ˆæ¯åº”è¯¥æ»¡è¶³ä¸å¯å˜æ€§ï¼Œä¹Ÿå°±æ˜¯ä¸ä¾¿æ¨¡å¼ã€‚</p>
  </li>
  <li>
    <p>æ¶ˆæ¯æŠ•é€’æœ‰3ç§ç­–ç•¥ï¼šä¹‹å¤šä¸€æ¬¡æŠ•é€’ï¼Œè‡³å°‘ä¸€æ¬¡æŠ•é€’ï¼Œç²¾ç¡®çš„æ¶ˆæ¯æŠ•é€’ã€‚BUT ï¼Œæ²¡å¿…è¦åœ¨akkaå±‚é¢ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ï¼Œä¸€èˆ¬åœ¨ä¸šåŠ¡å±‚åœ¨ä¿è¯ã€‚</p>
  </li>
  <li>
    <p>Akkaå¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¿è¯é¡ºåºæ€§ï¼Œä½†ä¸å…·å¤‡ä¼ é€’æ€§ï¼Œè§ã€Šjavaé«˜å¹¶å‘ç¨‹åºè®¾è®¡ P295ã€‹ã€‚</p>
  </li>
</ul>

<h2 id="15-æ¨¡å—">1.5. æ¨¡å—</h2>

<p>Akkaçš„æ¨¡å—åŒ–åšå¾—éå¸¸å¥½ï¼Œå®ƒä¸ºä¸åŒçš„åŠŸèƒ½æä¾›äº†ä¸åŒçš„JaråŒ…ã€‚</p>

<ul>
  <li>akka-actor-2.0.jar â€“ æ ‡å‡†Actor, æœ‰ç±»å‹Actorï¼Œç­‰ç­‰</li>
  <li>akka-remote-2.0.jar â€“ è¿œç¨‹Actor</li>
  <li>akka-slf4j-2.0.jar â€“ SLF4Jäº‹ä»¶å¤„ç†ç›‘å¬å™¨</li>
  <li>akka-testkit-2.0.jar â€“ ç”¨äºæµ‹è¯•Actorçš„å·¥å…·åŒ…</li>
  <li>akka-kernel-2.0.jar â€“ Akkaå¾®å†…æ ¸ï¼Œå¯è¿è¡Œä¸€ä¸ªåŸºæœ¬çš„æœ€å°åº”ç”¨æœåŠ¡å™¨</li>
  <li>akkaâ€“mailbox-2.0.jar â€“ Akkaå¯å®¹é”™é‚®ç®±</li>
</ul>

<p>è¦æŸ¥çœ‹æ¯ä¸ªAkkaæ¨¡å—çš„jaråŒ…ä¾èµ–è§ <a href="http://www.gtan.com/akka_doc/dev/building-akka.html#dependencies">ä¾èµ–</a> ç« èŠ‚. è™½ç„¶ä¸é‡è¦ä¸è¿‡
akka-actor æ²¡æœ‰å¤–éƒ¨ä¾èµ– (é™¤äº†scala-library.jar JARåŒ…).</p>

<h2 id="16-å¦‚ä½•ä½¿ç”¨å’Œéƒ¨ç½²akka">1.6. å¦‚ä½•ä½¿ç”¨å’Œéƒ¨ç½²Akka</h2>

<p>Akka å¯ä»¥æœ‰å‡ ç§ä½¿ç”¨æ–¹å¼:</p>

<ul>
  <li>
    <p>ä½œä¸ºä¸€ä¸ªåº“: ä»¥æ™®é€šjaråŒ…çš„å½¢å¼æ”¾åœ¨classpathä¸Šï¼Œæˆ–æ”¾åˆ°webåº”ç”¨ä¸­çš„ WEB-INF/libä½ç½®</p>
  </li>
  <li>
    <p>ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„åº”ç”¨ç¨‹åºï¼Œä½¿ç”¨ Microkernelï¼ˆå¾®å†…æ ¸ï¼‰ï¼Œè‡ªå·±æœ‰ä¸€ä¸ªmainç±»æ¥åˆå§‹åŒ–Actorç³»ç»Ÿ</p>
  </li>
</ul>

<h2 id="17-å‚è€ƒèµ„æ–™">1.7. å‚è€ƒèµ„æ–™</h2>

<ul>
  <li>ä¹¦ç±ã€Šjavaé«˜å¹¶å‘ç¨‹åºè®¾è®¡ã€‹</li>
  <li><a href="https://akka.io/docs/">AKKAå®˜æ–¹æ–‡æ¡£</a></li>
</ul>

<h1 id="2-å…¥é—¨ç¤ºä¾‹">2. å…¥é—¨ç¤ºä¾‹</h1>

<p>ä¸»è¦å­¦ä¹ akkaçš„actorå’Œremoteæ¨¡å—ï¼Œé‚£ä¹ˆå·¥ç¨‹ä¹Ÿåˆ†ä¸¤ä¸ªmodel:</p>

<ul>
  <li>akkahello-actor æ¨¡å—</li>
  <li>akkahello-remote æ¨¡å—</li>
</ul>

<h2 id="21-ç¤ºä¾‹æ¨¡å—">2.1. ç¤ºä¾‹æ¨¡å—</h2>

<blockquote>
  <p>Actoræ¨¡å—ç›®å‰æœ‰ä¸¤ä¸ªç¤ºä¾‹ï¼š</p>
  <ul>
    <li>Hello Word ç¤ºä¾‹ç¨‹åº<a href="#22-HelloWordAkka">HelloWordAkka</a></li>
    <li>ç‰©è”ç½‘ç¤ºä¾‹<a href="#23-ç‰©è”ç½‘ç¤ºä¾‹[ç”¨ä¾‹">ç”¨ä¾‹</a></li>
  </ul>
</blockquote>

<h2 id="22-hellowordakka">2.2. HelloWordAkka</h2>

<p>æœ¬ç¤ºä¾‹æ¥è‡ªäº<a href="http://doc.akka.io/docs/akka/2.6/java/guide/introduction.html">å®˜æ–¹ç¤ºä¾‹</a>, æ–‡ä¸­æ‰¾åˆ° Using Akka with Maven ã€‚ç‚¹å‡»â€œAkka Main in Javaâ€ä¸‹è½½ç¤ºä¾‹ã€‚</p>

<p>ç¤ºä¾‹ç¨‹åºåŒ…packageï¼šcom.tcfuture.akka.actor.hello</p>

<h3 id="221-hellowordåŠŸèƒ½">2.2.1. HelloWordåŠŸèƒ½</h3>

<p>è¯¥ç¤ºä¾‹ç”±ä¸‰ä¸ªactorsç»„æˆ:</p>

<ul>
  <li>Greeter: æ¥æ”¶åˆ°æŸäººçš„é—®å€™ï¼ˆGreetï¼‰å‘½ä»¤ï¼Œç„¶åç”¨ä¸€ä¸ªï¼ˆGreetedï¼‰æ¥å›åº”ï¼Œä»¥ç¡®è®¤é—®å€™å·²ç»å‘ç”Ÿã€‚</li>
  <li>GreeterBot: æ¥æ”¶æ¥è‡ªGreeterçš„å›å¤ï¼Œå¹¶å‘é€ä¸€äº›é¢å¤–çš„é—®å€™ä¿¡æ¯ï¼Œå¹¶æ”¶é›†å›å¤ï¼Œç›´åˆ°è¾¾åˆ°ç»™å®šçš„æœ€å¤§æ•°é‡çš„æ¶ˆæ¯ã€‚</li>
  <li>GreeterMain: ç›‘æŠ¤çš„actor, è¿æ¥ä¸€åˆ‡ã€‚</li>
</ul>

<h3 id="222-å®šä¹‰actorå’Œæ¶ˆæ¯">2.2.2. å®šä¹‰Actorå’Œæ¶ˆæ¯</h3>

<p>æ¯ä¸ªActorä¸ºå®ƒå¯ä»¥æ¥æ”¶çš„æ¶ˆæ¯å®šä¹‰äº†ä¸€ä¸ªç±»å‹Tã€‚Caseç±»å’ŒCaseå¯¹è±¡æ˜¯éå¸¸å¥½çš„æ¶ˆæ¯ï¼Œå› ä¸ºå®ƒä»¬æ˜¯ä¸å¯å˜çš„ï¼Œå¹¶ä¸”æ”¯æŒæ¨¡å¼åŒ¹é…ï¼Œæˆ‘ä»¬å°†åœ¨Actorä¸­åˆ©ç”¨è¿™ä¸€ç‚¹æ¥åŒ¹é…å®ƒæ¥æ”¶åˆ°çš„æ¶ˆæ¯ã€‚</p>

<p>HelloWord Actorä¸­ä½¿ç”¨äº†ä¸‰ç§ä¸åŒçš„æ¶ˆæ¯ï¼š</p>

<ul>
  <li>Greet: å‘½ä»¤å‘ç”Ÿåˆ°Greeter actorçš„é—®å€™</li>
  <li>Greeted: ä»Greeter actorç¡®è®¤é—®å€™å·²ç»å‘ç”Ÿçš„å›å¤</li>
  <li>SayHello: å‘½ä»¤GreeterMainå¼€å§‹é—®å€™è¿‡ç¨‹</li>
</ul>

<p>åœ¨å®šä¹‰actorå’Œä»–ä»¬çš„æ¶ˆæ¯æ—¶ï¼Œè¯·è®°ä½ä»¥ä¸‹å»ºè®®:</p>

<ul>
  <li>
    <p>ç”±äºæ¶ˆæ¯æ˜¯Actorçš„å…¬å…±APIï¼Œæ‰€ä»¥ç”¨å¥½çš„åç§°å’Œä¸°å¯Œçš„è¯­ä¹‰å’Œç‰¹å®šé¢†åŸŸçš„å«ä¹‰å®šä¹‰æ¶ˆæ¯æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å®è·µï¼Œå³ä½¿å®ƒä»¬åªæ˜¯åŒ…è£…äº†æ‚¨çš„æ•°æ®ç±»å‹ã€‚è¿™å°†ä½¿å®ƒæ›´å®¹æ˜“ä½¿ç”¨ã€ç†è§£å’Œè°ƒè¯•åŸºäºactorçš„ç³»ç»Ÿã€‚</p>
  </li>
  <li>
    <p>æ¶ˆæ¯åº”è¯¥æ˜¯ä¸å¯å˜çš„ï¼Œå› ä¸ºå®ƒä»¬åœ¨ä¸åŒçš„çº¿ç¨‹ä¹‹é—´å…±äº«ã€‚</p>
  </li>
  <li>
    <p>é€šè¿‡é™æ€å·¥å‚æ–¹æ³•è·å–Actorçš„åˆå§‹è¡Œä¸ºæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å®è·µã€‚</p>
  </li>
  <li>
    <p>å°†actorå…³è”çš„æ¶ˆæ¯ä½œä¸ºé™æ€ç±»æ”¾åœ¨AbstractBehaaviorçš„ç±»ä¸­æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å®è·µã€‚è¿™ä½¿å¾—æ›´å®¹æ˜“ç†è§£ActoræœŸæœ›å’Œå¤„ç†çš„æ¶ˆæ¯ç±»å‹ã€‚</p>
  </li>
</ul>

<h4 id="2221-æœ€ä½³å®è·µ">2.2.2.1. æœ€ä½³å®è·µ</h4>

<p>è®©æˆ‘ä»¬çœ‹çœ‹Greeterã€GreeterBotå’ŒGreeterMainçš„å®ç°æ˜¯å¦‚ä½•æ¼”ç¤ºè¿™äº›æœ€ä½³å®è·µçš„:</p>

<h5 id="22211-the-greeter-actor">2.2.2.1.1. The Greeter actor</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Greeter</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">Greet</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Greet</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">whom</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Greeted</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Greet</span><span class="o">(</span><span class="nc">String</span> <span class="n">whom</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Greeted</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">whom</span> <span class="o">=</span> <span class="n">whom</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Greeted</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">whom</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Greet</span><span class="o">&gt;</span> <span class="n">from</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Greeted</span><span class="o">(</span><span class="nc">String</span> <span class="n">whom</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Greet</span><span class="o">&gt;</span> <span class="n">from</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">whom</span> <span class="o">=</span> <span class="n">whom</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">from</span> <span class="o">=</span> <span class="n">from</span><span class="o">;</span>
    <span class="o">}</span>

  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Greet</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">Greeter:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nf">Greeter</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Greet</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Greet</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Greet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onGreet</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Greet</span><span class="o">&gt;</span> <span class="nf">onGreet</span><span class="o">(</span><span class="nc">Greet</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Hello {}!"</span><span class="o">,</span> <span class="n">command</span><span class="o">.</span><span class="na">whom</span><span class="o">);</span>
    <span class="n">command</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Greeted</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">whom</span><span class="o">,</span> <span class="n">getContext</span><span class="o">().</span><span class="na">getSelf</span><span class="o">()));</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™ä¸€å°æ®µä»£ç å®šä¹‰äº†ä¸¤ç§æ¶ˆæ¯ç±»å‹ï¼Œä¸€ç§ç”¨äºå‘½ä»¤Actorå‘æŸäººæ‰“æ‹›å‘¼ï¼Œå¦ä¸€ç§ç”¨äºActorç¡®è®¤å®ƒå·²ç»è¿™æ ·åšäº†ã€‚Greetç±»å‹ä¸ä»…åŒ…å«è¦æ‰“æ‹›å‘¼çš„å¯¹è±¡çš„ä¿¡æ¯ï¼Œå®ƒè¿˜åŒ…å«æ¶ˆæ¯å‘é€è€…æä¾›çš„ActorRefï¼Œä»¥ä¾¿Greeter Actorå¯ä»¥å‘é€å›ç¡®è®¤æ¶ˆæ¯ã€‚</p>

<p>åœ¨newReceiveBuilderè¡Œä¸ºå·¥å‚çš„å¸®åŠ©ä¸‹ï¼ŒActorçš„è¡Œä¸ºè¢«å®šä¹‰ä¸ºGreeter AbstractBehaviorã€‚å¤„ç†ä¸‹ä¸€æ¡æ¶ˆæ¯ä¼šå¯¼è‡´å¯èƒ½ä¸æ­¤æ¶ˆæ¯ä¸åŒçš„æ–°è¡Œä¸ºã€‚å¯ä»¥é€šè¿‡
ä¿®æ”¹å½“å‰å®ä¾‹æ¥æ›´æ–°çŠ¶æ€ï¼Œå› ä¸ºå®ƒæ˜¯å¯å˜çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ›´æ–°ä»»ä½•çŠ¶æ€ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿”å›è¿™ä¸ªæ²¡æœ‰ä»»ä½•å­—æ®µæ›´æ–°ï¼Œè¿™æ„å‘³ç€ä¸‹ä¸€ä¸ªè¡Œä¸ºâ€œä¸å½“å‰è¡Œä¸ºç›¸åŒâ€ã€‚</p>

<p>æ­¤è¡Œä¸ºå¤„ç†çš„æ¶ˆæ¯ç±»å‹è¢«å£°æ˜ä¸ºç±»Greetã€‚é€šå¸¸ï¼ŒActorå¤„ç†ä¸æ­¢ä¸€ç§ç‰¹å®šçš„æ¶ˆæ¯ç±»å‹ï¼Œç„¶åå°±ä¼šæœ‰ä¸€ä¸ªé€šç”¨æ¥å£ï¼Œactorå¯ä»¥å¤„ç†çš„æ‰€æœ‰æ¶ˆæ¯éƒ½å¯ä»¥å®ç°è¿™ä¸ªæ¥å£ã€‚</p>

<p>åœ¨æœ€åä¸€è¡Œä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°Greeter Actorå‘å¦ä¸€ä¸ªActorå‘é€æ¶ˆæ¯ï¼Œè¿™æ˜¯ä½¿ç”¨tellæ–¹æ³•å®Œæˆçš„ã€‚å®ƒæ˜¯ä¸€ä¸ªä¸é˜»å¡è°ƒç”¨è€…çº¿ç¨‹çš„å¼‚æ­¥æ“ä½œã€‚</p>

<p>ç”±äºreplyToåœ°å€è¢«å£°æ˜ä¸ºActorRef<Greeted>ç±»å‹ï¼Œç¼–è¯‘å™¨å°†åªå…è®¸æˆ‘ä»¬å‘é€è¿™ç§ç±»å‹çš„æ¶ˆæ¯ï¼Œå…¶ä»–ç”¨æ³•å°†æ˜¯ç¼–è¯‘å™¨é”™è¯¯ã€‚</Greeted></p>

<p>Actoræ¥å—çš„æ¶ˆæ¯ç±»å‹ä¸æ‰€æœ‰åº”ç­”ç±»å‹ä¸€èµ·å®šä¹‰äº†è¯¥Actoræ‰€è¯´çš„åè®®; åœ¨æœ¬ä¾‹ä¸­ï¼Œå®ƒæ˜¯ä¸€ä¸ªç®€å•çš„è¯·æ±‚-åº”ç­”åè®®ï¼Œä½†Actorå¯ä»¥åœ¨éœ€è¦æ—¶å»ºæ¨¡ä»»æ„å¤æ‚çš„åè®®ã€‚åè®®
ä¸åœ¨ä¸€ä¸ªç²¾å¿ƒåŒ…è£…çš„èŒƒå›´å†…å®ç°å®ƒçš„è¡Œä¸ºæ†ç»‘åœ¨ä¸€èµ·â€”Greeterç±»ã€‚</p>

<h5 id="22212-the-greeter-bot-actor">2.2.2.1.2. The Greeter bot actor</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="err">$</span><span class="nn">package</span><span class="err">$</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">akka.actor.typed.Behavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GreeterBot</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">Greeted</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">Greeted</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span><span class="kt">int</span> <span class="n">max</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="n">context</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">GreeterBot</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">max</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">max</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">greetingCounter</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">GreeterBot</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">Greeted</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span> <span class="kt">int</span> <span class="n">max</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">max</span> <span class="o">=</span> <span class="n">max</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">Greeted</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">Greeted</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onGreeted</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">Greeted</span><span class="o">&gt;</span> <span class="nf">onGreeted</span><span class="o">(</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">Greeted</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">greetingCounter</span><span class="o">++;</span>
        <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Greeting {} for {}"</span><span class="o">,</span> <span class="n">greetingCounter</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">whom</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">greetingCounter</span> <span class="o">==</span> <span class="n">max</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">stopped</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">message</span><span class="o">.</span><span class="na">from</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Greeter</span><span class="o">.</span><span class="na">Greet</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">whom</span><span class="o">,</span> <span class="n">getContext</span><span class="o">().</span><span class="na">getSelf</span><span class="o">()));</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¯·æ³¨æ„è¯¥Actoræ˜¯å¦‚ä½•ä½¿ç”¨å®ä¾‹å˜é‡ç®¡ç†è®¡æ•°å™¨çš„ã€‚ç”±äºActorå®ä¾‹ä¸€æ¬¡åªå¤„ç†ä¸€æ¡æ¶ˆæ¯ï¼Œå› æ­¤ä¸éœ€è¦åƒsynchronizedæˆ–AtomicIntegerè¿™æ ·çš„å¹¶å‘ä¿æŠ¤ã€‚</p>

<h5 id="22213-the-greeter-main-actor">2.2.2.1.3. The Greeter main actor</h5>

<p>ç¬¬ä¸‰ä¸ªActorç”ŸæˆGreeterå’ŒGreeterBotï¼Œå¹¶å¼€å§‹äº¤äº’ï¼Œåˆ›å»ºActorï¼Œä¸‹é¢å°†è®¨è®ºspawnæ‰€åšçš„äº‹æƒ…ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="err">$</span><span class="nn">package</span><span class="err">$</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.Behavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GreeterMain</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">GreeterMain</span><span class="o">.</span><span class="na">SayHello</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SayHello</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">SayHello</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">Greet</span><span class="o">&gt;</span> <span class="n">greeter</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">SayHello</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">GreeterMain:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nf">GreeterMain</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">SayHello</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="n">greeter</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"greeter"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">SayHello</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">SayHello</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onSayHello</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">SayHello</span><span class="o">&gt;</span> <span class="nf">onSayHello</span><span class="o">(</span><span class="nc">SayHello</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">Greeted</span><span class="o">&gt;</span> <span class="n">replyTo</span> <span class="o">=</span>
                <span class="n">getContext</span><span class="o">().</span><span class="na">spawn</span><span class="o">(</span><span class="nc">GreeterBot</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span> <span class="n">command</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
        <span class="n">greeter</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Greeter</span><span class="o">.</span><span class="na">Greet</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">));</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="223-åˆ›å»ºactors">2.2.3. åˆ›å»ºActors</h3>

<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†ActoråŠå…¶æ¶ˆæ¯çš„å®šä¹‰ã€‚ç°åœ¨è®©æˆ‘ä»¬æ›´æ·±å…¥åœ°äº†è§£ä¸€ä¸‹ä½ç½®é€æ˜æ€§çš„å¼ºå¤§åŠŸèƒ½ï¼Œå¹¶çœ‹çœ‹å¦‚ä½•åˆ›å»ºActorå®ä¾‹ã€‚</p>

<h4 id="2231-ä½ç½®é€æ˜åº¦çš„åŠ›é‡">2.2.3.1. ä½ç½®é€æ˜åº¦çš„åŠ›é‡</h4>

<p>åœ¨Akkaä¸­ï¼Œä¸èƒ½ä½¿ç”¨newå…³é”®å­—åˆ›å»ºActorçš„å®ä¾‹ã€‚ç›¸åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å·¥å‚spawnæ–¹æ³•åˆ›å»ºActorå®ä¾‹ã€‚Spawnä¸è¿”å›ä¸€ä¸ªactorå®ä¾‹ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªå¼•ç”¨akka.actor.typed. ActorRefï¼Œå®ƒæŒ‡å‘actorå®ä¾‹ã€‚è¿™ç§çº§åˆ«çš„é—´æ¥å¢åŠ äº†åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¼ºå¤§åŠŸèƒ½å’Œçµæ´»æ€§ã€‚</p>

<p>åœ¨Akkaçš„ä½ç½®å¹¶ä¸é‡è¦ã€‚ä½ç½®é€æ˜æ€§æ„å‘³ç€ActorRefå¯ä»¥åœ¨ä¿ç•™ç›¸åŒè¯­ä¹‰çš„åŒæ—¶ï¼Œè¡¨ç¤ºæ­£åœ¨è¿è¡Œçš„actoråœ¨è¿›ç¨‹ä¸­æˆ–åœ¨è¿œç¨‹æœºå™¨ä¸Šçš„å®ä¾‹ã€‚å¦‚æœéœ€è¦ï¼Œè¿è¡Œæ—¶å¯ä»¥é€šè¿‡chä¼˜åŒ–ç³»ç»Ÿã€‚</p>

<h4 id="2232-akka-actorsystem">2.2.3.2. Akka-ActorSystem</h4>

<p>ActorSystemæ˜¯Akkaçš„åˆå§‹å…¥å£ç‚¹ï¼Œé€šå¸¸æ¯ä¸ªåº”ç”¨ç¨‹åºåªåˆ›å»ºä¸€ä¸ªActorSystemã€‚ActorSystemæœ‰ä¸€ä¸ªåå­—å’Œä¸€ä¸ªç›‘æ§Actorã€‚åº”ç”¨ç¨‹åºçš„å¼•å¯¼é€šå¸¸åœ¨ç›‘æŠ¤äººActorä¸­å®Œæˆã€‚</p>

<p>è¿™ä¸ªç¤ºä¾‹æ¼”å‘˜æ˜¯GreeterMainã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">final</span> <span class="nc">ActorSystem</span><span class="o">&lt;</span><span class="nc">GreeterMain</span><span class="o">.</span><span class="na">SayHello</span><span class="o">&gt;</span> <span class="n">greeterMain</span> <span class="o">=</span> <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">GreeterMain</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"helloakka"</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä½¿ç”¨Behaviors.setupå¼•å¯¼åº”ç”¨ç¨‹åº</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="err">$</span><span class="nn">package</span><span class="err">$</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.Behavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GreeterMain</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">GreeterMain</span><span class="o">.</span><span class="na">SayHello</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SayHello</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">SayHello</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">Greet</span><span class="o">&gt;</span> <span class="n">greeter</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">SayHello</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">GreeterMain:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nf">GreeterMain</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">SayHello</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="n">greeter</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"greeter"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">SayHello</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">SayHello</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onSayHello</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">SayHello</span><span class="o">&gt;</span> <span class="nf">onSayHello</span><span class="o">(</span><span class="nc">SayHello</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">Greeted</span><span class="o">&gt;</span> <span class="n">replyTo</span> <span class="o">=</span>
                <span class="n">getContext</span><span class="o">().</span><span class="na">spawn</span><span class="o">(</span><span class="nc">GreeterBot</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span> <span class="n">command</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
        <span class="n">greeter</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Greeter</span><span class="o">.</span><span class="na">Greet</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">));</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="2233-ç”Ÿäº§å­actors">2.2.3.3. ç”Ÿäº§å­Actors</h4>

<p>å…¶ä»–çš„Actoræ˜¯ä½¿ç”¨ActorContextä¸Šçš„spawnæ–¹æ³•åˆ›å»ºçš„ã€‚GreeterMainåœ¨å¯åŠ¨æ—¶ä»¥è¿™ç§æ–¹å¼åˆ›å»ºä¸€ä¸ªGreeter actorï¼Œå¹¶åœ¨æ¯æ¬¡æ”¶åˆ°SayHelloæ¶ˆæ¯æ—¶åˆ›å»ºä¸€ä¸ªæ–°çš„GreeterBotã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">greeter</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"greeter"</span><span class="o">);</span>
<span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">Greeted</span><span class="o">&gt;</span> <span class="n">replyTo</span> <span class="o">=</span>
        <span class="n">getContext</span><span class="o">().</span><span class="na">spawn</span><span class="o">(</span><span class="nc">GreeterBot</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span> <span class="n">command</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
<span class="n">greeter</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Greeter</span><span class="o">.</span><span class="na">Greet</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="2234-å¼‚æ­¥é€šä¿¡">2.2.3.4. å¼‚æ­¥é€šä¿¡</h4>

<p>Actoræ˜¯è¢«åŠ¨çš„å’Œæ¶ˆæ¯é©±åŠ¨çš„ã€‚Actoråœ¨æ”¶åˆ°æ¶ˆæ¯ä¹‹å‰ä¸ä¼šåšä»»ä½•äº‹æƒ…ã€‚Actorä½¿ç”¨å¼‚æ­¥æ¶ˆæ¯è¿›è¡Œé€šä¿¡ã€‚è¿™ç¡®ä¿äº†å‘é€æ–¹ä¸ä¼šä¸€ç›´ç­‰å¾…æ”¶ä»¶äººå¤„ç†å®ƒä»¬çš„æ¶ˆæ¯ã€‚ç›¸åï¼Œå‘ä»¶äººå°†é‚®ä»¶æ”¾å…¥æ”¶ä»¶äººçš„é‚®ç®±ï¼Œå¯ä»¥è‡ªç”±åœ°åšå…¶ä»–å·¥ä½œã€‚Actorçš„é‚®ç®±æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå…·æœ‰æ’åºè¯­ä¹‰çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚åŒä¸€Actorå‘é€çš„å¤šä¸ªæ¶ˆæ¯çš„é¡ºåºè¢«ä¿ç•™ï¼Œä½†æ˜¯å¯ä»¥ä¸å¦ä¸€ä¸ªActorå‘é€çš„æ¶ˆæ¯äº¤ç»‡åœ¨ä¸€èµ·ã€‚</p>

<p>æ‚¨å¯èƒ½æƒ³çŸ¥é“ï¼Œå½“Actorä¸å¤„ç†æ¶ˆæ¯æ—¶ï¼Œä¹Ÿå°±æ˜¯åœ¨åšå®é™…çš„å·¥ä½œæ—¶ï¼Œå®ƒåœ¨åšä»€ä¹ˆ? å®ƒå¤„äºæŒ‚èµ·çŠ¶æ€ï¼Œåœ¨è¿™ç§çŠ¶æ€ä¸‹ï¼Œå®ƒä¸æ¶ˆè€—é™¤å†…å­˜ä»¥å¤–çš„ä»»ä½•èµ„æºã€‚å†æ¬¡å±•ç¤ºäº†Actorè½»é‡çº§ã€é«˜æ•ˆçš„ç‰¹æ€§ã€‚</p>

<h4 id="2235-å‘actorå‘é€æ¶ˆæ¯">2.2.3.5. å‘Actorå‘é€æ¶ˆæ¯</h4>

<p>è¦å°†æ¶ˆæ¯æ”¾å…¥Actorçš„é‚®ç®±ï¼Œè¯·ä½¿ç”¨ActorRefä¸Šçš„tellæ–¹æ³•ã€‚ä¾‹å¦‚ï¼ŒHello Worldçš„ä¸»ç±»å‘Greeter Actorå‘é€è¿™æ ·çš„æ¶ˆæ¯:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">greeterMain</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">GreeterMain</span><span class="o">.</span><span class="na">SayHello</span><span class="o">(</span><span class="s">"Charles"</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Greeter Actorä¹Ÿä¼šå‘Printer Actorå‘é€ä¸€æ¡æ¶ˆæ¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">command</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Greeted</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">whom</span><span class="o">,</span> <span class="n">getContext</span><span class="o">().</span><span class="na">getSelf</span><span class="o">()));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="224-actoræµ‹è¯•">2.2.4. Actoræµ‹è¯•</h3>

<p>Hello Worldç¤ºä¾‹ä¸­çš„æµ‹è¯•æ¼”ç¤ºäº†JUnitæ¡†æ¶çš„ä½¿ç”¨ã€‚æµ‹è¯•è¦†ç›–ä¸å®Œæ•´ã€‚å®ƒå±•ç¤ºäº†å¦‚ä½•æµ‹è¯•Actorä»£ç ï¼Œå¹¶æä¾›äº†ä¸€äº›åŸºæœ¬æ¦‚å¿µã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="err">$</span><span class="nn">package</span><span class="err">$</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">akka.actor.testkit.typed.javadsl.TestKitJunitResource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.testkit.typed.javadsl.TestProbe</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.ClassRule</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AkkaQuickstartTest</span> <span class="o">{</span>

    <span class="nd">@ClassRule</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">TestKitJunitResource</span> <span class="n">testKit</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TestKitJunitResource</span><span class="o">();</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGreeterActorSendingOfGreeting</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">Greeted</span><span class="o">&gt;</span> <span class="n">testProbe</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">();</span>
        <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">Greet</span><span class="o">&gt;</span> <span class="n">underTest</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"greeter"</span><span class="o">);</span>
        <span class="n">underTest</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Greeter</span><span class="o">.</span><span class="na">Greet</span><span class="o">(</span><span class="s">"Charles"</span><span class="o">,</span> <span class="n">testProbe</span><span class="o">.</span><span class="na">getRef</span><span class="o">()));</span>
        <span class="n">testProbe</span><span class="o">.</span><span class="na">expectMessage</span><span class="o">(</span><span class="k">new</span> <span class="nc">Greeter</span><span class="o">.</span><span class="na">Greeted</span><span class="o">(</span><span class="s">"Charles"</span><span class="o">,</span> <span class="n">underTest</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="2241-æµ‹è¯•ç±»çš„å®šä¹‰">2.2.4.1. æµ‹è¯•ç±»çš„å®šä¹‰</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AkkaQuickstartTest</span> <span class="o">{</span>

    <span class="nd">@ClassRule</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">TestKitJunitResource</span> <span class="n">testKit</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TestKitJunitResource</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é€šè¿‡ä½¿ç”¨TestKitJunitResource JUnitè§„åˆ™ï¼Œå¯ä»¥åŒ…å«å¯¹JUnitçš„æ”¯æŒã€‚è¿™å°†è‡ªåŠ¨åˆ›å»ºå¹¶æ¸…é™¤ActorTestKitã€‚è¦äº†è§£å¦‚ä½•ä½¿ç”¨testkitï¼Œè¯·ç›´æ¥æŸ¥çœ‹<a href="https://doc.akka.io/docs/akka/2.6/typed/testing-async.html">å®Œæ•´çš„æ–‡æ¡£</a>ã€‚</p>

<h5 id="22411-æµ‹è¯•æ–¹æ³•">2.2.4.1.1. æµ‹è¯•æ–¹æ³•</h5>

<p>æµ‹è¯•ä½¿ç”¨TestProbeæ¥è¯¢é—®å’ŒéªŒè¯é¢„æœŸçš„è¡Œä¸ºã€‚è®©æˆ‘ä»¬çœ‹ä¸€çœ‹æºä»£ç ç‰‡æ®µ:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGreeterActorSendingOfGreeting</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">Greeted</span><span class="o">&gt;</span> <span class="n">testProbe</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">();</span>
    <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">Greet</span><span class="o">&gt;</span> <span class="n">underTest</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">Greeter</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"greeter"</span><span class="o">);</span>
    <span class="n">underTest</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Greeter</span><span class="o">.</span><span class="na">Greet</span><span class="o">(</span><span class="s">"Charles"</span><span class="o">,</span> <span class="n">testProbe</span><span class="o">.</span><span class="na">getRef</span><span class="o">()));</span>
    <span class="n">testProbe</span><span class="o">.</span><span class="na">expectMessage</span><span class="o">(</span><span class="k">new</span> <span class="nc">Greeter</span><span class="o">.</span><span class="na">Greeted</span><span class="o">(</span><span class="s">"Charles"</span><span class="o">,</span> <span class="n">underTest</span><span class="o">));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœ‰äº†å¯¹TestProbeçš„å¼•ç”¨åï¼Œæˆ‘ä»¬å°†å…¶ä½œä¸ºGreetæ¶ˆæ¯çš„ä¸€éƒ¨åˆ†ä¼ é€’ç»™Greeterã€‚ç„¶åï¼Œæˆ‘ä»¬éªŒè¯Greeterå›åº”è¯´é—®å€™å·²ç»å‘ç”Ÿã€‚</p>

<p>ç¤ºä¾‹ä»£ç åªæ˜¯è§¦åŠäº†ActorTestKitä¸­å¯ç”¨åŠŸèƒ½çš„è¡¨é¢ã€‚Akkaæµ‹è¯•è¯¦ç»†ç¤ºä¾‹è¯·æŸ¥çœ‹<a href="https://developer.lightbend.com/guides/akka-quickstart-java/testing-actors.html">å®Œæ•´çš„æµ‹è¯•æ¦‚è¿°</a>ç›¸å…³å†…å®¹ã€‚</p>

<h2 id="23-ç‰©è”ç½‘ç¤ºä¾‹ç”¨ä¾‹">2.3. ç‰©è”ç½‘ç¤ºä¾‹ç”¨ä¾‹</h2>

<h3 id="231-ç¤ºä¾‹ç®€ä»‹">2.3.1. ç¤ºä¾‹ç®€ä»‹</h3>

<h4 id="2311-ç¤ºä¾‹æ€è·¯">2.3.1.1. ç¤ºä¾‹æ€è·¯</h4>

<p>å†™æ•£æ–‡æ—¶ï¼Œæœ€éš¾çš„éƒ¨åˆ†å¾€å¾€æ˜¯å†™å¼€å¤´å‡ å¥ã€‚åœ¨å¼€å§‹æ„å»ºAkkaç³»ç»Ÿæ—¶ï¼Œä¹Ÿæœ‰ç±»ä¼¼çš„â€œç©ºç™½ç”»å¸ƒâ€çš„æ„Ÿè§‰ã€‚ä½ å¯èƒ½ä¼šæƒ³:å“ªä¸ªåº”è¯¥æ˜¯ç¬¬ä¸€ä¸ªActor?å®ƒåº”è¯¥ä½åœ¨å“ªé‡Œ?å®ƒåº”è¯¥åšä»€ä¹ˆ?å¹¸è¿çš„æ˜¯ï¼Œä¸æ•£æ–‡ä½“ä¸åŒçš„æ˜¯ï¼Œå·²æœ‰çš„æœ€ä½³å®è·µå¯ä»¥æŒ‡å¯¼æˆ‘ä»¬å®Œæˆè¿™äº›åˆå§‹æ­¥éª¤ã€‚åœ¨æœ¬æ–‡æ¡£çš„å…¶ä½™éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†ç ”ç©¶ä¸€ä¸ªç®€å•Akkaåº”ç”¨ç¨‹åºçš„æ ¸å¿ƒé€»è¾‘ï¼Œå‘æ‚¨ä»‹ç»Actorï¼Œå¹¶å‘æ‚¨å±•ç¤ºå¦‚ä½•ä½¿ç”¨å®ƒä»¬æ¥åˆ¶å®šè§£å†³æ–¹æ¡ˆã€‚è¿™ä¸ªç¤ºä¾‹æ¼”ç¤ºäº†ä¸€äº›å¸¸è§çš„æ¨¡å¼ï¼Œè¿™äº›æ¨¡å¼å°†å¸®åŠ©æ‚¨å¯åŠ¨Akkaé¡¹ç›®ã€‚</p>

<h4 id="2312-å…ˆå†³æ¡ä»¶">2.3.1.2. å…ˆå†³æ¡ä»¶</h4>

<p>æ‚¨åº”è¯¥å·²ç»ä¸‹è½½<a href="https://gitlab.tcfuture.tech/akka/akka-hello">Hello Word Akkaç¤ºä¾‹</a>ç¨‹åºä¸­Actoræ¨¡å—çš„<code class="language-plaintext highlighter-rouge">java/com/tcfuture/akka/actor/hello</code>åŒ…ï¼Œå¹¶å‚è€ƒæœ¬æ–‡æ¡£<a href="#33-HelloWordAkka">HelloWordAkkaç¤ºä¾‹ä»‹ç»</a>ã€‚æ‚¨å°†ä½¿ç”¨å®ƒä½œä¸ºä¸€ä¸ªç§å­é¡¹ç›®ï¼Œå¹¶æ·»åŠ æœ¬æ•™ç¨‹ä¸­æè¿°çš„åŠŸèƒ½ã€‚</p>

<blockquote>
  <p><strong>è¯·æ³¨æ„</strong><br />
Akkaæ¨¡å—çš„Javaå’ŒScala dsléƒ½æ†ç»‘åœ¨åŒä¸€ä¸ªJARä¸­ã€‚ä¸ºäº†è·å¾—å¹³ç¨³çš„å¼€å‘ä½“éªŒï¼Œåœ¨ä½¿ç”¨Eclipseæˆ–IntelliJè¿™æ ·çš„IDEæ—¶ï¼Œæ‚¨å¯ä»¥ç¦ç”¨è‡ªåŠ¨å¯¼å…¥å™¨ï¼Œä½¿å…¶åœ¨ä½¿ç”¨Scalaæ—¶ä¸å»ºè®®javadslå¯¼å…¥ï¼Œæˆ–è€…ç›¸åã€‚çœ‹åˆ°IDEçš„æŠ€å·§ã€‚</p>
</blockquote>

<h4 id="2313-ç¤ºä¾‹èŒƒå›´">2.3.1.3. ç¤ºä¾‹èŒƒå›´</h4>

<p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨Akkaæ„å»ºç‰©è”ç½‘(IoT)ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œè¯¥ç³»ç»ŸæŠ¥å‘Šæ¥è‡ªå®¢æˆ·å®¶ä¸­å®‰è£…çš„ä¼ æ„Ÿå™¨è®¾å¤‡çš„æ•°æ®ã€‚è¿™ä¸ªä¾‹å­ç€é‡äº<strong>æ¸©åº¦è¯»æ•°</strong>ã€‚ç›®æ ‡ç”¨ä¾‹å…è®¸å®¢æˆ·ç™»å½•å¹¶æŸ¥çœ‹æ¥è‡ªå®¶ä¸­ä¸åŒåŒºåŸŸçš„æœ€åæŠ¥å‘Šçš„æ¸©åº¦ã€‚æ‚¨å¯ä»¥æƒ³è±¡ï¼Œè¿™ç§ä¼ æ„Ÿå™¨è¿˜å¯ä»¥æ”¶é›†ç›¸å¯¹æ¹¿åº¦æˆ–å…¶ä»–æœ‰è¶£çš„æ•°æ®ï¼Œåº”ç”¨ç¨‹åºå¯èƒ½æ”¯æŒè¯»å–å’Œæ›´æ”¹è®¾å¤‡é…ç½®ï¼Œç”šè‡³å¯èƒ½åœ¨ä¼ æ„Ÿå™¨çŠ¶æ€è¶…å‡ºç‰¹å®šèŒƒå›´æ—¶å‘æˆ¿ä¸»å‘å‡ºè­¦æŠ¥ã€‚</p>

<p>åœ¨çœŸå®çš„ç³»ç»Ÿä¸­ï¼Œåº”ç”¨ç¨‹åºå°†é€šè¿‡ç§»åŠ¨åº”ç”¨ç¨‹åºæˆ–æµè§ˆå™¨å‘å®¢æˆ·å…¬å¼€ã€‚æœ¬æ–‡åªå…³æ³¨å­˜å‚¨æ¸©åº¦çš„æ ¸å¿ƒé€»è¾‘ï¼Œè¿™äº›æ¸©åº¦å¯ä»¥é€šè¿‡ç½‘ç»œåè®®(å¦‚HTTP)è°ƒç”¨ã€‚å®ƒè¿˜åŒ…æ‹¬ç¼–å†™æµ‹è¯•æ¥å¸®åŠ©æ‚¨é€‚åº”å¹¶ç†Ÿç»ƒåœ°ä½¿ç”¨æµ‹è¯•è§’è‰²ã€‚</p>

<h4 id="2314-ç»„æˆéƒ¨åˆ†">2.3.1.4. ç»„æˆéƒ¨åˆ†</h4>

<p>åº”ç”¨ç¨‹åºç”±ä¸¤ä¸ªä¸»è¦ç»„ä»¶ç»„æˆ:</p>

<ul>
  <li>
    <p><strong>è®¾å¤‡æ•°æ®æ”¶é›†:</strong> â€” ç»´æŠ¤è¿œç¨‹è®¾å¤‡çš„æœ¬åœ°è¡¨ç¤ºã€‚ä¸€ä¸ªå®¶åº­çš„å¤šä¸ªä¼ æ„Ÿå™¨è®¾å¤‡è¢«ç»„ç»‡æˆä¸€ä¸ªè®¾å¤‡ã€‚</p>
  </li>
  <li>
    <p><strong>ç”¨æˆ·æ§åˆ¶é¢æ¿:</strong> â€” å®šæœŸä»ç™»å½•ç”¨æˆ·å®¶ä¸­çš„è®¾å¤‡æ”¶é›†æ•°æ®ï¼Œå¹¶ä»¥æŠ¥å‘Šçš„å½¢å¼æ˜¾ç¤ºç»“æœã€‚</p>
  </li>
</ul>

<h4 id="2315-ä½“ç³»ç»“æ„">2.3.1.5. ä½“ç³»ç»“æ„</h4>

<p>ä¸‹å›¾æ¼”ç¤ºäº†ç¤ºä¾‹åº”ç”¨ç¨‹åºä½“ç³»ç»“æ„ã€‚å› ä¸ºæˆ‘ä»¬å¯¹æ¯ä¸ªä¼ æ„Ÿå™¨è®¾å¤‡çš„çŠ¶æ€æ„Ÿå…´è¶£ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†è®¾å¤‡å»ºæ¨¡ä¸ºActorã€‚è¿è¡Œä¸­çš„åº”ç”¨ç¨‹åºå°†æ ¹æ®éœ€è¦åˆ›å»ºå°½å¯èƒ½å¤šçš„è®¾å¤‡Actorå’Œè®¾å¤‡ç»„å®ä¾‹ã€‚</p>

<p><img src="https://liulv.work/images/img/123.png" alt="123" /></p>

<h4 id="2316-åº”ç”¨æŠ€èƒ½">2.3.1.6. åº”ç”¨æŠ€èƒ½</h4>

<p>ç¤ºä¾‹å°†ä½¿ç”¨åˆ°Actorçš„é‚£äº›å¼€å‘æŠ€èƒ½ï¼š</p>

<ul>
  <li>Actorå±‚æ¬¡ç»“æ„ä»¥åŠå®ƒå¦‚ä½•å½±å“Actorçš„è¡Œä¸º</li>
  <li>å¦‚ä½•ä¸ºActoré€‰æ‹©åˆé€‚çš„ç²’åº¦</li>
  <li>å¦‚ä½•å°†åè®®å®šä¹‰ä¸ºæ¶ˆæ¯</li>
  <li>å…¸å‹çš„è°ˆè¯æ–¹å¼</li>
</ul>

<h3 id="232-actoræ¶æ„">2.3.2. Actoræ¶æ„</h3>

<h4 id="2321-mavenä¾èµ–">2.3.2.1. Mavenä¾èµ–</h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;properties&gt;</span>
  <span class="nt">&lt;akka.version&gt;</span>2.6.8<span class="nt">&lt;/akka.version&gt;</span>
  <span class="nt">&lt;scala.binary.version&gt;</span>2.13<span class="nt">&lt;/scala.binary.version&gt;</span>
<span class="nt">&lt;/properties&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.typesafe.akka<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>akka-actor-typed_${scala.binary.version}<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>${akka.version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="2322-ä»‹ç»">2.3.2.2. ä»‹ç»</h4>

<p>ä½¿ç”¨Akkaä½¿æ‚¨ä¸å¿…ä¸ºactorç³»ç»Ÿåˆ›å»ºåŸºç¡€è®¾æ–½ï¼Œä¹Ÿä¸å¿…ç¼–å†™æ§åˆ¶åŸºæœ¬è¡Œä¸ºæ‰€éœ€çš„åº•å±‚ä»£ç ã€‚ä¸ºäº†ç†è§£è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹æ‚¨åœ¨ä»£ç ä¸­åˆ›å»ºçš„Actorä¸Akkaåœ¨å†…éƒ¨ä¸ºæ‚¨åˆ›å»ºå’Œç®¡ç†çš„Actorä¹‹é—´çš„å…³ç³»ï¼ŒActorç”Ÿå‘½å‘¨æœŸå’Œå¤±è´¥å¤„ç†ã€‚</p>

<h4 id="2323-actorå±‚æ¬¡ç»“æ„">2.3.2.3. Actorå±‚æ¬¡ç»“æ„</h4>

<p>åœ¨Akkaä¸­Actoræ°¸è¿œå±äºçˆ¶Actorã€‚æ‚¨å¯ä»¥é€šè¿‡è°ƒç”¨ActorContext.spawn()æ¥åˆ›å»ºä¸€ä¸ªactorã€‚åˆ›å»ºè€…Actoræˆä¸ºæ–°åˆ›å»ºçš„å­Actorçš„çˆ¶Actorã€‚æ‚¨å¯èƒ½ä¼šé—®ï¼Œæ‚¨åˆ›å»ºçš„ç¬¬ä¸€ä¸ªactorçš„çˆ¶å…ƒç´ æ˜¯è°?</p>

<p>å¦‚ä¸‹æ‰€ç¤ºï¼Œæ‰€æœ‰Actorséƒ½æœ‰ä¸€ä¸ªå…±åŒçš„çˆ¶Actorï¼Œå³ç”¨æˆ·ç›‘æŠ¤äººï¼Œå®ƒæ˜¯åœ¨å¯åŠ¨ActorSystemæ—¶å®šä¹‰å’Œåˆ›å»ºçš„ã€‚æ­£å¦‚æˆ‘ä»¬åœ¨ã€Šå¿«é€Ÿå…¥é—¨æŒ‡å—ã€‹ä¸­æåˆ°çš„ï¼Œactorçš„åˆ›å»ºå°†è¿”å›ä¸€ä¸ªå¼•ç”¨ï¼Œè¯¥å¼•ç”¨æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„URLã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬ä»ç”¨æˆ·guardianä¸­ä½¿ç”¨<code class="language-plaintext highlighter-rouge">context.spawn(someBehavior, "someActor")</code>åˆ›å»ºä¸€ä¸ªåä¸ºsomeActorçš„actorï¼Œå…¶å¼•ç”¨å°†åŒ…æ‹¬è·¯å¾„<code class="language-plaintext highlighter-rouge">/user/someActor</code>ã€‚</p>

<p><img src="https://liulv.work/images/img/20200802224604.png" alt="20200802224604" /></p>

<p>å®é™…ä¸Šï¼Œåœ¨å¯åŠ¨ç¬¬ä¸€ä¸ªActorä¹‹å‰ï¼ŒAkkaå·²ç»åœ¨ç³»ç»Ÿä¸­åˆ›å»ºäº†ä¸¤ä¸ªActorã€‚è¿™äº›å†…ç½®Actorçš„åç§°åŒ…å«ç›‘æŠ¤äºº(guardian)ã€‚ç›‘æ§ActoråŒ…æ‹¬:</p>

<ul>
  <li>
    <p>/ æ‰€è°“çš„æ ¹ç›‘æŠ¤è€…ï¼ˆguardianï¼‰- å®ƒæ˜¯ç³»ç»Ÿä¸­æ‰€æœ‰è§’è‰²çš„çˆ¶çº§ï¼Œä¹Ÿæ˜¯ç³»ç»Ÿæœ¬èº«ç»ˆæ­¢æ—¶æœ€åä¸€ä¸ªåœæ­¢çš„è§’è‰²ã€‚</p>
  </li>
  <li>
    <p>/system ç³»ç»Ÿçš„ç›‘æŠ¤è€… - Akkaæˆ–æ„å»ºåœ¨Akkaä¹‹ä¸Šçš„å…¶ä»–åº“å¯ä»¥åœ¨ç³»ç»Ÿåç§°ç©ºé—´ä¸­åˆ›å»ºActorã€‚</p>
  </li>
  <li>
    <p>/user ç”¨æˆ·çš„ç›‘æŠ¤è€… - è¿™æ˜¯æ‚¨ä¸ºå¯åŠ¨åº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰å…¶ä»–Actorè€Œæä¾›çš„é¡¶çº§Actorã€‚</p>
  </li>
</ul>

<p>æŸ¥çœ‹actorå±‚æ¬¡ç»“æ„çš„æœ€ç®€å•æ–¹æ³•æ˜¯æ‰“å°ActorRefå®ä¾‹ã€‚åœ¨è¿™ä¸ªå°å®éªŒä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªactorï¼Œæ‰“å°å®ƒçš„å¼•ç”¨ï¼Œåˆ›å»ºè¿™ä¸ªactorçš„å­å…ƒç´ ï¼Œç„¶åæ‰“å°å­å…ƒç´ çš„å¼•ç”¨ã€‚æˆ‘ä»¬ä»Hello Worldé¡¹ç›®å¼€å§‹ï¼Œå¦‚æœæ‚¨è¿˜æ²¡æœ‰ä¸‹è½½å®ƒï¼Œè¯·ä»LightbendæŠ€æœ¯ä¸­å¿ƒä¸‹è½½Quickstarté¡¹ç›®ã€‚</p>

<p>åœ¨Hello Worldé¡¹ç›®ä¸­ï¼Œå¯¼èˆªåˆ°<code class="language-plaintext highlighter-rouge">com.tcfuture.akka.actor.architecture</code>ç¤ºä¾‹åŒ…ï¼Œå¹¶ä¸ºä¸‹é¢ä»£ç ç‰‡æ®µä¸­çš„æ¯ä¸ªç±»åˆ›å»ºä¸€ä¸ªJavaæ–‡ä»¶ï¼Œå¹¶å¤åˆ¶å„è‡ªçš„å†…å®¹ã€‚ä¿å­˜æ–‡ä»¶å¹¶è¿è¡Œ<code class="language-plaintext highlighter-rouge">com.tcfuture.akka.actor.hello.PrintMyActorRefActor.ActorHierarchyExperiments</code>ä»æ„å»ºå·¥å…·æˆ–IDEä¸­è§‚å¯Ÿè¾“å‡ºã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">akka.actor.typed.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorSystem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.Behavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.AbstractBehavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.ActorContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Behaviors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Receive</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">PrintMyActorRefActor</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">PrintMyActorRefActor:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nf">PrintMyActorRefActor</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onMessageEquals</span><span class="o">(</span><span class="s">"printit"</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">printIt</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">printIt</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">secondRef</span> <span class="o">=</span> <span class="n">getContext</span><span class="o">().</span><span class="na">spawn</span><span class="o">(</span><span class="nc">Behaviors</span><span class="o">.</span><span class="na">empty</span><span class="o">(),</span> <span class="s">"second-actor"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Second: "</span> <span class="o">+</span> <span class="n">secondRef</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Main</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">Main:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nf">Main</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onMessageEquals</span><span class="o">(</span><span class="s">"start"</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">start</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">firstRef</span> <span class="o">=</span> <span class="n">getContext</span><span class="o">().</span><span class="na">spawn</span><span class="o">(</span><span class="nc">PrintMyActorRefActor</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"first-actor"</span><span class="o">);</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"First: "</span> <span class="o">+</span> <span class="n">firstRef</span><span class="o">);</span>
    <span class="n">firstRef</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="s">"printit"</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ActorHierarchyExperiments</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">testSystem</span> <span class="o">=</span> <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">Main</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"testSystem"</span><span class="o">);</span>
    <span class="n">testSystem</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="s">"start"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¯·æ³¨æ„æ¶ˆæ¯è¦æ±‚ç¬¬ä¸€ä¸ªactoræ‰§è¡Œå…¶å·¥ä½œçš„æ–¹å¼ã€‚æˆ‘ä»¬ä½¿ç”¨çˆ¶èŠ‚ç‚¹çš„å¼•ç”¨å‘é€æ¶ˆæ¯:<code class="language-plaintext highlighter-rouge">firstRef.tell("printit", ActorRef.noSender())</code>ã€‚å½“ä»£ç æ‰§è¡Œæ—¶ï¼Œè¾“å‡ºåŒ…æ‹¬å¯¹ç¬¬ä¸€ä¸ªactorçš„å¼•ç”¨ä»¥åŠå®ƒä½œä¸ºprintitå¤§å°å†™çš„ä¸€éƒ¨åˆ†åˆ›å»ºçš„å­å…ƒç´ ã€‚æ‚¨çš„è¾“å‡ºåº”è¯¥ç±»ä¼¼äºä»¥ä¸‹å†…å®¹:</p>

<pre><code class="language-log">First: Actor[akka://testSystem/user/first-actor#1053618476]
Second: Actor[akka://testSystem/user/first-actor/second-actor#-1544706041]
</code></pre>

<p>è¾“å‡ºæ‰“å°å¦‚ä¸‹ï¼š</p>

<p><img src="https://liulv.work/images/img/20200802230207.png" alt="20200802230207" /></p>

<p>æ³¨æ„å¼•ç”¨çš„ç»“æ„:</p>

<ul>
  <li>
    <p>ä¸¤ä¸ªè·¯å¾„éƒ½ä»<code class="language-plaintext highlighter-rouge">akka://testSystem/</code>å¼€å§‹ã€‚å› ä¸ºæ‰€æœ‰çš„actorå¼•ç”¨éƒ½æ˜¯æœ‰æ•ˆçš„urlï¼Œæ‰€ä»¥akka://æ˜¯åè®®å­—æ®µçš„å€¼ã€‚</p>
  </li>
  <li>
    <p>æ¥ä¸‹æ¥ï¼Œå°±åƒåœ¨ä¸‡ç»´ç½‘ä¸Šä¸€æ ·ï¼ŒURLæ ‡è¯†ç³»ç»Ÿã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œç³»ç»Ÿè¢«å‘½åä¸ºtestSystemï¼Œä½†å®ƒå¯ä»¥æ˜¯ä»»ä½•å…¶ä»–åç§°ã€‚å¦‚æœå¯ç”¨äº†å¤šä¸ªç³»ç»Ÿä¹‹é—´çš„è¿œç¨‹é€šä¿¡ï¼ŒURLçš„è¿™ä¸€éƒ¨åˆ†å°†åŒ…å«ä¸»æœºåï¼Œä»¥ä¾¿å…¶ä»–ç³»ç»Ÿå¯ä»¥åœ¨ç½‘ç»œä¸Šæ‰¾åˆ°å®ƒã€‚</p>
  </li>
  <li>
    <p>å› ä¸ºç¬¬äºŒä¸ªActorçš„å¼•ç”¨åŒ…å«è·¯å¾„<code class="language-plaintext highlighter-rouge">/first-actor/</code>ï¼Œæ‰€ä»¥å®ƒå°†å…¶æ ‡è¯†ä¸ºç¬¬ä¸€ä¸ªActorçš„å­å…ƒç´ ã€‚</p>
  </li>
  <li>
    <p>actorå¼•ç”¨çš„æœ€åä¸€éƒ¨åˆ†#1053618476æˆ–#-1544706041æ˜¯ä¸€ä¸ªåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å¯ä»¥å¿½ç•¥çš„æƒŸä¸€æ ‡è¯†ç¬¦ã€‚</p>
  </li>
</ul>

<p>ç°åœ¨æ‚¨å·²ç»äº†è§£äº†actorå±‚æ¬¡ç»“æ„çš„æ ·å­ï¼Œæ‚¨å¯èƒ½æƒ³çŸ¥é“:ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦è¿™ä¸ªå±‚æ¬¡ç»“æ„?å®ƒæ˜¯ç”¨æ¥åšä»€ä¹ˆçš„?</p>

<p>å±‚æ¬¡ç»“æ„çš„ä¸€ä¸ªé‡è¦è§’è‰²æ˜¯å®‰å…¨åœ°ç®¡ç†Actorçš„ç”Ÿå‘½å‘¨æœŸã€‚æ¥ä¸‹æ¥è®©æˆ‘ä»¬è€ƒè™‘è¿™ä¸ªé—®é¢˜ï¼Œçœ‹çœ‹è¿™äº›çŸ¥è¯†å¦‚ä½•å¸®åŠ©æˆ‘ä»¬ç¼–å†™æ›´å¥½çš„ä»£ç ã€‚</p>

<h4 id="2324-actorç”Ÿå‘½å‘¨æœŸ">2.3.2.4. Actorç”Ÿå‘½å‘¨æœŸ</h4>

<p>Actoråœ¨åˆ›å»ºæ—¶å‡ºç°ï¼Œç„¶ååœ¨ç”¨æˆ·è¯·æ±‚æ—¶åœæ­¢ã€‚å½“ä¸€ä¸ªActorè¢«åœæ­¢æ—¶ï¼Œå®ƒçš„æ‰€æœ‰å­Actorä¹Ÿä¼šè¢«é€’å½’åœ°åœæ­¢ã€‚æ­¤è¡Œä¸ºæå¤§åœ°ç®€åŒ–äº†èµ„æºæ¸…ç†å·¥ä½œï¼Œå¹¶æœ‰åŠ©äºé¿å…èµ„æºæ³„æ¼ï¼Œæ¯”å¦‚ç”±äºæ‰“å¼€å¥—æ¥å­—å’Œæ–‡ä»¶è€Œå¯¼è‡´çš„æ³„æ¼ã€‚äº‹å®ä¸Šï¼Œåœ¨å¤„ç†ä½çº§å¤šçº¿ç¨‹ä»£ç æ—¶ï¼Œä¸€ä¸ªç»å¸¸è¢«å¿½è§†çš„å›°éš¾æ˜¯å„ç§å¹¶å‘èµ„æºçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚</p>

<p>ä¸ºäº†åœæ­¢ä¸€ä¸ªActorï¼Œæ¨èçš„æ¨¡å¼æ˜¯åœ¨actorå†…éƒ¨è¿”å›Behaviors.stopped()æ¥åœæ­¢å®ƒè‡ªå·±ï¼Œé€šå¸¸ä½œä¸ºå¯¹ä¸€äº›ç”¨æˆ·å®šä¹‰çš„åœæ­¢æ¶ˆæ¯çš„å“åº”ï¼Œæˆ–è€…å½“actorå®Œæˆå®ƒçš„å·¥ä½œæ—¶ã€‚ä»çˆ¶èŠ‚ç‚¹è°ƒç”¨context.stop(childRef)æ¥åœæ­¢å­èŠ‚ç‚¹ä»æŠ€æœ¯ä¸Šè®²æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯ä¸å¯èƒ½é€šè¿‡è¿™ç§æ–¹å¼åœæ­¢ä»»æ„çš„(éå­èŠ‚ç‚¹)èŠ‚ç‚¹ã€‚</p>

<p>Akka actor APIå…¬å¼€äº†ä¸€äº›ç”Ÿå‘½å‘¨æœŸä¿¡å·ï¼Œä¾‹å¦‚PostStopæ˜¯åœ¨actoråœæ­¢ä¹‹åå‘é€çš„ã€‚åœ¨æ­¤ä¹‹åä¸å¤„ç†ä»»ä½•æ¶ˆæ¯ã€‚</p>

<p>è®©æˆ‘ä»¬åœ¨ä¸€ä¸ªç®€å•çš„å®éªŒä¸­ä½¿ç”¨PostStopç”Ÿå‘½å‘¨æœŸä¿¡å·æ¥è§‚å¯Ÿåœæ­¢Actoræ—¶çš„è¡Œä¸ºã€‚é¦–å…ˆï¼Œåœ¨æ‚¨çš„é¡¹ç›®ä¸­æ·»åŠ ä»¥ä¸‹2ä¸ªactorç±»:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">StartStopActor1</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">StartStopActor1:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nf">StartStopActor1</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"first started"</span><span class="o">);</span>

    <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">StartStopActor2</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"second"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessageEquals</span><span class="o">(</span><span class="s">"stop"</span><span class="o">,</span> <span class="nl">Behaviors:</span><span class="o">:</span><span class="n">stopped</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onSignal</span><span class="o">(</span><span class="nc">PostStop</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">signal</span> <span class="o">-&gt;</span> <span class="n">onPostStop</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">onPostStop</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"first stopped"</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">StartStopActor2</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">StartStopActor2:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nf">StartStopActor2</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"second started"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onSignal</span><span class="o">(</span><span class="nc">PostStop</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">signal</span> <span class="o">-&gt;</span> <span class="n">onPostStop</span><span class="o">()).</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">onPostStop</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"second stopped"</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åˆ›å»ºä¸€ä¸ªåƒä¸Šé¢é‚£æ ·çš„â€œmainâ€ç±»å¯åŠ¨actorï¼Œç„¶åå‘é€ä¸€ä¸ªâ€œstopâ€æ¶ˆæ¯:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">first</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">StartStopActor1</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"first"</span><span class="o">);</span>
<span class="n">first</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="s">"stop"</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>first started
second started
second stopped
first stopped
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.jsdelivr.net/gh/v4liulv/PicPed/img/20200803002422.png" alt="20200803002422" /></p>

<p>å½“æˆ‘ä»¬å…ˆåœæ­¢actoræ—¶ï¼Œå®ƒä¼šå…ˆåœæ­¢å®ƒçš„child actorï¼Œç„¶åå†åœæ­¢å®ƒè‡ªå·±ã€‚è¿™ç§é¡ºåºæ˜¯ä¸¥æ ¼çš„ï¼Œå­èŠ‚ç‚¹çš„æ‰€æœ‰ååœæ­¢ä¿¡å·éƒ½åœ¨çˆ¶èŠ‚ç‚¹çš„ååœæ­¢ä¿¡å·å¤„ç†ä¹‹å‰å¤„ç†ã€‚</p>

<h4 id="2325-æ•…éšœå¤„ç†">2.3.2.5. æ•…éšœå¤„ç†</h4>

<p>çˆ¶Actorå’Œå­Actoråœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­éƒ½æ˜¯ç›¸äº’è”ç³»çš„ã€‚æ¯å½“ä¸€ä¸ªActorå¤±è´¥æ—¶(æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸æˆ–ä¸€ä¸ªæœªå¤„ç†çš„å¼‚å¸¸ä»æ¥æ”¶ä¸­å†’å‡º)ï¼Œå¤±è´¥ä¿¡æ¯å°±ä¼šä¼ æ’­åˆ°ç›‘ç£ç­–ç•¥ï¼Œç„¶åç”±å…¶å†³å®šå¦‚ä½•å¤„ç†ç”±Actorå¼•èµ·çš„å¼‚å¸¸ã€‚ç›‘æ§ç­–ç•¥é€šå¸¸ç”±çˆ¶actoråœ¨ç”Ÿæˆå­actoræ—¶å®šä¹‰ã€‚è¿™æ ·ï¼Œçˆ¶æ¯å°±æˆäº†å­©å­çš„ç›‘ç£è€…ã€‚é»˜è®¤çš„ç®¡ç†ç­–ç•¥æ˜¯é˜»æ­¢å­©å­ã€‚å¦‚æœä½ ä¸å®šä¹‰ç­–ç•¥ï¼Œæ‰€æœ‰çš„å¤±è´¥éƒ½ä¼šå¯¼è‡´åœæ­¢ã€‚</p>

<p>è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„å®éªŒæ¥è§‚å¯Ÿé‡å¯ç›‘ç®¡ç­–ç•¥ã€‚æ·»åŠ ä»¥ä¸‹ç±»åˆ°ä½ çš„é¡¹ç›®ï¼Œå°±åƒä½ åšçš„å‰é¢çš„:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">SupervisingActor</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">SupervisingActor:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">child</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nf">SupervisingActor</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="n">child</span> <span class="o">=</span>
        <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span>
            <span class="nc">Behaviors</span><span class="o">.</span><span class="na">supervise</span><span class="o">(</span><span class="nc">SupervisedActor</span><span class="o">.</span><span class="na">create</span><span class="o">()).</span><span class="na">onFailure</span><span class="o">(</span><span class="nc">SupervisorStrategy</span><span class="o">.</span><span class="na">restart</span><span class="o">()),</span>
            <span class="s">"supervised-actor"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onMessageEquals</span><span class="o">(</span><span class="s">"failChild"</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onFailChild</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">onFailChild</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">child</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="s">"fail"</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">SupervisedActor</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">SupervisedActor:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nf">SupervisedActor</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"supervised actor started"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessageEquals</span><span class="o">(</span><span class="s">"fail"</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">fail</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onSignal</span><span class="o">(</span><span class="nc">PreRestart</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">signal</span> <span class="o">-&gt;</span> <span class="n">preRestart</span><span class="o">())</span>
        <span class="o">.</span><span class="na">onSignal</span><span class="o">(</span><span class="nc">PostStop</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">signal</span> <span class="o">-&gt;</span> <span class="n">postStop</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">fail</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"supervised actor fails now"</span><span class="o">);</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"I failed!"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">preRestart</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"second will be restarted"</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">postStop</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"second stopped"</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¹¶è¿è¡Œï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">supervisingActor</span> <span class="o">=</span>
    <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">SupervisingActor</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"supervising-actor"</span><span class="o">);</span>
<span class="n">supervisingActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="s">"failChild"</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ‚¨åº”è¯¥ä¼šçœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹çš„è¾“å‡º:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre>First: Actor[akka://ActorSystem/user/supervising-actor#637280321]
supervised actor started
supervised actor fails now
second will be restarted
[2020-08-03 00:29:08,938] [ERROR] [akka.actor.typed.Behavior$] [ActorSystem-akka.actor.default-dispatcher-3] [akka://ActorSystem/user/supervising-actor/supervised-actor] - Supervisor RestartSupervisor saw failure: I failed!
java.lang.RuntimeException: I failed!
	at com.tcfuture.akka.actor.architecture.SupervisedActor.fail(FailureHandling.java:103)
	at akka.actor.typed.javadsl.ReceiveBuilder$$anon$2.apply(ReceiveBuilder.scala:88)
	at akka.actor.typed.javadsl.ReceiveBuilder$$anon$2.apply(ReceiveBuilder.scala:86)
	at akka.actor.typed.javadsl.BuiltReceive.receive(ReceiveBuilder.scala:213)
	at akka.actor.typed.javadsl.BuiltReceive.receiveMessage(ReceiveBuilder.scala:204)
	at akka.actor.typed.javadsl.Receive.receive(Receive.scala:53)
	at akka.actor.typed.javadsl.AbstractBehavior.receive(AbstractBehavior.scala:64)
	at akka.actor.typed.Behavior$.interpret(Behavior.scala:274)
	at akka.actor.typed.Behavior$.interpretMessage(Behavior.scala:230)
	at akka.actor.typed.internal.InterceptorImpl$$anon$2.apply(InterceptorImpl.scala:57)
	at akka.actor.typed.internal.RestartSupervisor.aroundReceive(Supervision.scala:263)
	at akka.actor.typed.internal.InterceptorImpl.receive(InterceptorImpl.scala:85)
	at akka.actor.typed.Behavior$.interpret(Behavior.scala:274)
	at akka.actor.typed.Behavior$.interpretMessage(Behavior.scala:230)
	at akka.actor.typed.internal.adapter.ActorAdapter.handleMessage(ActorAdapter.scala:129)
	at akka.actor.typed.internal.adapter.ActorAdapter.aroundReceive(ActorAdapter.scala:106)
	at akka.actor.ActorCell.receiveMessage(ActorCell.scala:577)
	at akka.actor.ActorCell.invoke(ActorCell.scala:547)
	at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:270)
	at akka.dispatch.Mailbox.run(Mailbox.scala:231)
	at akka.dispatch.Mailbox.exec(Mailbox.scala:243)
	at java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:289)
	at java.util.concurrent.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1056)
	at java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1692)
	at java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:157)
supervised actor started
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨å¤±è´¥åï¼Œè¢«ç›‘ç£çš„Actorè¢«åœæ­¢å¹¶ç«‹å³é‡æ–°å¯åŠ¨ã€‚æˆ‘ä»¬è¿˜ä¼šçœ‹åˆ°ä¸€ä¸ªæ—¥å¿—æ¡ç›®æŠ¥å‘Šæ‰€å¤„ç†çš„å¼‚å¸¸ï¼Œåœ¨æœ¬ä¾‹ä¸­æ˜¯æˆ‘ä»¬çš„æµ‹è¯•å¼‚å¸¸ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬è¿˜ä½¿ç”¨äº†PreRestartä¿¡å·ï¼Œè¯¥ä¿¡å·åœ¨é‡å¯ä¹‹å‰è¢«å¤„ç†ã€‚</p>

<h4 id="2326-æ€»ç»“">2.3.2.6. æ€»ç»“</h4>

<p>æˆ‘ä»¬å·²ç»äº†è§£äº†Akkaæ˜¯å¦‚ä½•åœ¨å±‚æ¬¡ç»“æ„ä¸­ç®¡ç†Actorçš„ï¼Œåœ¨å±‚æ¬¡ç»“æ„ä¸­çˆ¶æ¯ç›‘ç£ä»–ä»¬çš„å­©å­å¹¶å¤„ç†å¼‚å¸¸ã€‚æˆ‘ä»¬çœ‹åˆ°äº†å¦‚ä½•åˆ›å»ºä¸€ä¸ªéå¸¸ç®€å•çš„actorå’Œchildã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†é€šè¿‡å¯¹ä»è®¾å¤‡Actorè·å–ä¿¡æ¯æ‰€éœ€çš„é€šä¿¡è¿›è¡Œå»ºæ¨¡ï¼Œå°†è¿™äº›çŸ¥è¯†åº”ç”¨åˆ°ç¤ºä¾‹ç”¨ä¾‹ä¸­ã€‚ç¨åï¼Œæˆ‘ä»¬å°†å¤„ç†å¦‚ä½•åœ¨ç»„ä¸­ç®¡ç†Actorã€‚</p>

<h3 id="233-ç‰©è”ç½‘åº”ç”¨actor">2.3.3. ç‰©è”ç½‘åº”ç”¨Actor</h3>

<h4 id="2331-ä»‹ç»">2.3.3.1. ä»‹ç»</h4>

<p>äº†è§£äº†Actorçš„å±‚æ¬¡ç»“æ„å’Œè¡Œä¸ºä¹‹åï¼Œå‰©ä¸‹çš„é—®é¢˜æ˜¯å¦‚ä½•å°†ç‰©è”ç½‘ç³»ç»Ÿçš„é¡¶å±‚ç»„ä»¶æ˜ å°„åˆ°Actorã€‚ç”¨æˆ·ç›‘æŠ¤äºº(/ root guardian)å¯ä»¥æ˜¯ä»£è¡¨æ•´ä¸ªåº”ç”¨ç¨‹åºçš„Actorã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬å°†åœ¨æˆ‘ä»¬çš„ç‰©è”ç½‘ç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªå•ä¸€çš„é¡¶çº§Actorã€‚åˆ›å»ºå’Œç®¡ç†è®¾å¤‡å’Œä»ªè¡¨æ¿çš„ç»„ä»¶å°†æ˜¯è¯¥Actorçš„å­ç»„ä»¶ã€‚è¿™å…è®¸æˆ‘ä»¬å°†ç¤ºä¾‹ç”¨ä¾‹æ¶æ„å›¾é‡æ„ä¸ºä¸€ä¸ªè§’è‰²æ ‘:</p>

<p><img src="https://cdn.jsdelivr.net/gh/v4liulv/PicPed/img/arch_tree_diagram.png" alt="arch_tree_diagram" /></p>

<p>æˆ‘ä»¬å¯ä»¥ç”¨å‡ è¡Œä»£ç å®šä¹‰ç¬¬ä¸€ä¸ªActorIotSupervisorã€‚å¼€å§‹ä½ çš„æ•™ç¨‹åº”ç”¨:</p>

<p>åœ¨com.tcfuture.akka.actor.iotåŒ…ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„IotSupervisoræºæ–‡ä»¶ã€‚ç¤ºä¾‹åŒ…ä¸­å°†ä»¥ä¸‹ä»£ç ç²˜è´´åˆ°æ–°æ–‡ä»¶ä¸­ä»¥å®šä¹‰IotSupervisorã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">akka.actor.typed.Behavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.PostStop</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.AbstractBehavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.ActorContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Behaviors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Receive</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IotSupervisor</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">IotSupervisor:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nf">IotSupervisor</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="n">context</span><span class="o">.</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"IoT Application started"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">// No need to handle any messages</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onSignal</span><span class="o">(</span><span class="nc">PostStop</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">signal</span> <span class="o">-&gt;</span> <span class="n">onPostStop</span><span class="o">()).</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">IotSupervisor</span> <span class="nf">onPostStop</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"IoT Application stopped"</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»£ç ç±»ä¼¼äºæˆ‘ä»¬åœ¨å‰é¢çš„å®éªŒä¸­ä½¿ç”¨çš„actorç¤ºä¾‹ï¼Œä½†æ˜¯è¯·æ³¨æ„ï¼Œæˆ‘ä»¬ä¸æ˜¯ä½¿ç”¨println()ï¼Œè€Œæ˜¯é€šè¿‡context.getLog()ä½¿ç”¨Akkaçš„å†…ç½®æ—¥å¿—è®°å½•å·¥å…·ã€‚</p>

<p>è¦æä¾›åˆ›å»ºactorç³»ç»Ÿçš„ä¸»å…¥å£ç‚¹ï¼Œè¯·å‘æ–°çš„IotMainç±»æ·»åŠ ä»¥ä¸‹ä»£ç ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">akka.actor.typed.ActorSystem</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IotMain</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Create ActorSystem and top level supervisor</span>
    <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">IotSupervisor</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"iot-system"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é™¤äº†è®°å½•å®ƒçš„å¯åŠ¨ï¼Œåº”ç”¨ç¨‹åºå‡ ä¹ä¸åšå…¶ä»–äº‹æƒ…ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†ç¬¬ä¸€ä¸ªActorï¼Œå¹¶ä¸”å‡†å¤‡æ·»åŠ å…¶ä»–Actorã€‚</p>

<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>

<pre><code class="language-log">[2020-08-03 00:42:51,904] [INFO] [com.tcfuture.akka.actor.iot.IotSupervisor] [iot-system-akka.actor.default-dispatcher-3] [akka://iot-system/user] - IoT Application started
</code></pre>

<h4 id="2332-æ¥ä¸‹æ¥æ€ä¹ˆåš">2.3.3.2. æ¥ä¸‹æ¥æ€ä¹ˆåš</h4>

<p>åœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†é€æ­¥å‘å±•åº”ç”¨ç¨‹åºï¼Œé€šè¿‡:</p>
<ol>
  <li>ä¸ºè®¾å¤‡åˆ›å»ºè¡¨ç¤ºå½¢å¼ã€‚</li>
  <li>åˆ›å»ºè®¾å¤‡ç®¡ç†ç»„ä»¶ã€‚</li>
  <li>å‘è®¾å¤‡ç»„æ·»åŠ æŸ¥è¯¢åŠŸèƒ½ã€‚</li>
</ol>

<h3 id="234-è®¾å¤‡working">2.3.4. è®¾å¤‡Working</h3>

<h4 id="2341-ä»‹ç»">2.3.4.1. ä»‹ç»</h4>

<p>åœ¨å‰é¢çš„ä¸»é¢˜ä¸­ï¼Œæˆ‘ä»¬è§£é‡Šäº†å¦‚ä½•æŸ¥çœ‹å¤§å‹çš„Actorç³»ç»Ÿï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç»„ä»¶åº”è¯¥å¦‚ä½•è¡¨ç¤ºï¼ŒActoråº”è¯¥å¦‚ä½•åœ¨å±‚æ¬¡ç»“æ„ä¸­è¿›è¡Œå®‰æ’ã€‚åœ¨æœ¬éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡å®ç°è®¾å¤‡Actoræ¥äº†è§£å°å‹Actorã€‚</p>

<p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨å¯¹è±¡ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå°†APIè®¾è®¡ä¸ºæ¥å£ï¼Œå³ç”±å®é™…å®ç°å¡«å……çš„æŠ½è±¡æ–¹æ³•é›†åˆã€‚åœ¨Actorçš„ä¸–ç•Œä¸­ï¼Œåè®®å–ä»£äº†æ¥å£ã€‚è™½ç„¶åœ¨ç¼–ç¨‹è¯­è¨€ä¸­ä¸å¯èƒ½å½¢å¼åŒ–é€šç”¨åè®®ï¼Œä½†æˆ‘ä»¬å¯ä»¥ç»„æˆå®ƒä»¬æœ€åŸºæœ¬çš„å…ƒç´ ï¼Œæ¶ˆæ¯ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†ä»è¯†åˆ«æˆ‘ä»¬æƒ³è¦å‘é€ç»™è®¾å¤‡Actorçš„æ¶ˆæ¯å¼€å§‹ã€‚</p>

<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯å¯ä»¥åˆ†ä¸ºç±»åˆ«æˆ–æ¨¡å¼ã€‚é€šè¿‡è¯†åˆ«è¿™äº›æ¨¡å¼ï¼Œæ‚¨å°†å‘ç°åœ¨å®ƒä»¬ä¹‹é—´è¿›è¡Œé€‰æ‹©å’Œå®ç°å°†å˜å¾—æ›´åŠ å®¹æ˜“ã€‚ç¬¬ä¸€ä¸ªç¤ºä¾‹æ¼”ç¤ºäº†è¯·æ±‚-å“åº”æ¶ˆæ¯æ¨¡å¼ã€‚</p>

<h4 id="2342-è®¾å¤‡çš„æ ‡è¯†æ¶ˆæ¯">2.3.4.2. è®¾å¤‡çš„æ ‡è¯†æ¶ˆæ¯</h4>

<p>è®¾å¤‡Actorçš„ä»»åŠ¡å¾ˆç®€å•:</p>

<ul>
  <li>æ”¶é›†æ¸©åº¦æµ‹é‡</li>
  <li>å½“è¢«é—®åŠæ—¶ï¼ŒæŠ¥å‘Šæœ€åæµ‹é‡çš„æ¸©åº¦</li>
</ul>

<p>ç„¶è€Œï¼Œè®¾å¤‡å¯èƒ½åœ¨æ²¡æœ‰ç«‹å³æµ‹é‡æ¸©åº¦çš„æƒ…å†µä¸‹å¯åŠ¨ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘æ¸©åº¦ä¸å­˜åœ¨çš„æƒ…å†µã€‚è¿™è¿˜å…è®¸æˆ‘ä»¬åœ¨æ²¡æœ‰å†™å…¥éƒ¨åˆ†çš„æƒ…å†µä¸‹æµ‹è¯•actorçš„æŸ¥è¯¢éƒ¨åˆ†ï¼Œå› ä¸ºè®¾å¤‡actorå¯ä»¥æŠ¥å‘Šä¸€ä¸ªç©ºç»“æœã€‚æ‰€ä»¥ä½¿ç”¨æˆ‘ä»¬ä½¿ç”¨**Optional<Double>**æ¥è®°å½•æ¸©åº¦ä¸ç›´æ¥ä½¿ç”¨Doubleï¼Œå…è®¸ä¸ºç©ºç»“æœã€‚</Double></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Device</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ReadTemperature</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">RespondTemperature</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ReadTemperature</span><span class="o">(</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">RespondTemperature</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RespondTemperature</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">value</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">RespondTemperature</span><span class="o">(</span><span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¯·æ³¨æ„ï¼ŒReadTemperatureæ¶ˆæ¯åŒ…å«è®¾å¤‡Actoråœ¨å“åº”è¯·æ±‚æ—¶å°†ä½¿ç”¨çš„ActorRef<RespondTemperature>ã€‚</RespondTemperature></p>

<p>è¿™ä¸¤æ¡æ¶ˆæ¯ä¼¼ä¹æ¶µç›–äº†æ‰€éœ€çš„åŠŸèƒ½ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬é€‰æ‹©çš„æ–¹æ³•å¿…é¡»è€ƒè™‘åˆ°åº”ç”¨ç¨‹åºçš„åˆ†å¸ƒå¼ç‰¹æ€§ã€‚è™½ç„¶ä¸æœ¬åœ°JVMä¸Šçš„actoré€šä¿¡çš„åŸºæœ¬æœºåˆ¶ä¸ä¸è¿œç¨‹actoré€šä¿¡çš„åŸºæœ¬æœºåˆ¶æ˜¯ç›¸åŒçš„ï¼Œä½†æˆ‘ä»¬éœ€è¦è®°ä½ä»¥ä¸‹å‡ ç‚¹:</p>

<ul>
  <li>
    <p>ç”±äºç½‘ç»œé“¾è·¯å¸¦å®½å’Œæ¶ˆæ¯å¤§å°ç­‰å› ç´ ä¹Ÿä¼šèµ·ä½œç”¨ï¼Œå› æ­¤åœ¨æœ¬åœ°æ¶ˆæ¯å’Œè¿œç¨‹æ¶ˆæ¯çš„ä¼ é€’å»¶è¿Ÿæ–¹é¢ä¼šæœ‰æ˜æ˜¾çš„å·®å¼‚ã€‚</p>
  </li>
  <li>
    <p>å¯é æ€§æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºè¿œç¨‹æ¶ˆæ¯å‘é€æ¶‰åŠåˆ°æ›´å¤šçš„æ­¥éª¤ï¼Œè¿™æ„å‘³ç€å¯èƒ½å‡ºç°æ›´å¤šçš„é”™è¯¯ã€‚</p>
  </li>
  <li>
    <p>æœ¬åœ°å‘é€å°†ä¼ é€’å¯¹åŒä¸€JVMä¸­çš„æ¶ˆæ¯çš„å¼•ç”¨ï¼Œè€Œå¯¹å‘é€çš„åŸºç¡€å¯¹è±¡æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œè€Œè¿œç¨‹ä¼ è¾“å°†å¯¹æ¶ˆæ¯å¤§å°è¿›è¡Œé™åˆ¶ã€‚</p>
  </li>
</ul>

<p>æ­¤å¤–ï¼Œè™½ç„¶åœ¨åŒä¸€ä¸ªJVMä¸­å‘é€æ¶ˆæ¯è¦å¯é å¾—å¤šï¼Œä½†å¦‚æœactoråœ¨å¤„ç†æ¶ˆæ¯æ—¶ç”±äºç¨‹åºå‘˜é”™è¯¯è€Œå¤±è´¥ï¼Œå…¶æ•ˆæœä¸åœ¨å¤„ç†æ¶ˆæ¯æ—¶ç”±äºè¿œç¨‹ä¸»æœºå´©æºƒè€Œå¯¼è‡´è¿œç¨‹ç½‘ç»œè¯·æ±‚å¤±è´¥çš„æ•ˆæœç›¸åŒã€‚å³ä½¿åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼ŒæœåŠ¡åœ¨ä¸€æ®µæ—¶é—´åæ¢å¤(Actorç”±å…¶ç›‘ç®¡è€…é‡æ–°å¯åŠ¨ï¼Œä¸»æœºç”±æ“ä½œå‘˜æˆ–ç›‘è§†ç³»ç»Ÿé‡æ–°å¯åŠ¨)ï¼Œä¸ªåˆ«è¯·æ±‚åœ¨å´©æºƒæœŸé—´ä¼šä¸¢å¤±ã€‚å› æ­¤ï¼Œå°†Actorç¼–å†™æˆæ¯æ¡æ¶ˆæ¯éƒ½æœ‰å¯èƒ½ä¸¢å¤±çš„æ ·å­æ˜¯ä¸€ç§å®‰å…¨è€Œæ‚²è§‚çš„åšæ³•ã€‚</p>

<p>ä½†æ˜¯ä¸ºäº†è¿›ä¸€æ­¥ç†è§£åè®®ä¸­çµæ´»æ€§çš„éœ€è¦ï¼Œè€ƒè™‘Akkaæ¶ˆæ¯é¡ºåºå’Œæ¶ˆæ¯ä¼ é€’ä¿è¯å°†æœ‰æ‰€å¸®åŠ©ã€‚Akkaä¸ºæ¶ˆæ¯å‘é€æä¾›ä»¥ä¸‹è¡Œä¸º:</p>

<ul>
  <li>æœ€å¤šä¸€æ¬¡äº¤è´§ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ä¿è¯äº¤è´§ã€‚</li>
  <li>æŒ‰å‘é€æ–¹ã€æ¥æ”¶æ–¹å¯¹ç»´æŠ¤æ¶ˆæ¯é¡ºåºã€‚</li>
</ul>

<p>ä¸‹é¢å‡ èŠ‚å°†æ›´è¯¦ç»†åœ°è®¨è®ºè¿™ç§è¡Œä¸º:</p>

<ul>
  <li><a href="https://doc.akka.io/docs/akka/current/typed/guide/tutorial_3.html#message-delivery">Message delivery</a></li>
  <li><a href="https://doc.akka.io/docs/akka/current/typed/guide/tutorial_3.html#message-ordering">Message ordering</a></li>
</ul>

<h4 id="2343-æ¶ˆæ¯ä¼ é€’">2.3.4.3. æ¶ˆæ¯ä¼ é€’</h4>

<p>æ¶ˆæ¯ä¼ é€’å­ç³»ç»Ÿæä¾›çš„ä¼ é€’è¯­ä¹‰é€šå¸¸å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç±»:</p>

<ul>
  <li>
    <p>At-most-once delivery â€”â€” æ¯æ¡æ¶ˆæ¯è¢«å‘é€é›¶æ¬¡æˆ–ä¸€æ¬¡;ä»æ›´å› æœçš„è§’åº¦æ¥è¯´ï¼Œå®ƒæ„å‘³ç€ä¿¡æ¯å¯èƒ½ä¼šä¸¢å¤±ï¼Œä½†ä¸ä¼šè¢«å¤åˆ¶ã€‚</p>
  </li>
  <li>
    <p>At-least-once delivery â€”â€” å¯èƒ½ä¼šå¤šæ¬¡å°è¯•ä¼ é€’æ¯æ¡æ¶ˆæ¯ï¼Œç›´åˆ°è‡³å°‘æœ‰ä¸€æ¡æˆåŠŸä¸ºæ­¢;åŒæ ·ï¼Œä»æ›´å› æœçš„è§’åº¦æ¥è¯´ï¼Œè¿™æ„å‘³ç€ä¿¡æ¯å¯ä»¥è¢«å¤åˆ¶ï¼Œä½†ä¸ä¼šä¸¢å¤±ã€‚</p>
  </li>
  <li>
    <p>Exactly-once delivery â€”â€” æ¯æ¡ä¿¡æ¯åªä¼ é€’ä¸€æ¬¡ç»™æ”¶ä»¶äºº;ä¿¡æ¯æ—¢ä¸èƒ½ä¸¢å¤±ä¹Ÿä¸èƒ½å¤åˆ¶ã€‚</p>
  </li>
</ul>

<p>ç¬¬ä¸€ç§è¡Œä¸ºæ˜¯Akkaæ‰€ä½¿ç”¨çš„ï¼Œå®ƒæ˜¯æœ€ä¾¿å®œçš„ï¼Œå¹¶ä¸”å…·æœ‰æœ€é«˜çš„æ€§èƒ½ã€‚å®ƒçš„å®ç°å¼€é”€æœ€å°ï¼Œå› ä¸ºå®ƒå¯ä»¥ä»¥â€œå‘å®Œå°±å¿˜è®°â€çš„æ–¹å¼å®Œæˆï¼Œè€Œæ— éœ€åœ¨å‘é€ç«¯æˆ–ä¼ è¾“æœºåˆ¶ä¸­ä¿ç•™çŠ¶æ€ã€‚</p>

<p>ç¬¬äºŒç§ï¼Œè‡³å°‘ä¸€æ¬¡æˆåŠŸï¼Œéœ€è¦é‡è¯•ä»¥å¼¥è¡¥è¿è¾“æŸå¤±ã€‚è¿™å¢åŠ äº†åœ¨å‘é€ç«¯ä¿æŒçŠ¶æ€å’Œåœ¨æ¥æ”¶ç«¯æ‹¥æœ‰ä¸€ä¸ªç¡®è®¤æœºåˆ¶çš„å¼€é”€ã€‚</p>

<p>ç¬¬ä¸‰ç§ï¼Œç¡®åˆ‡åœ°è¯´ï¼Œä¸€æ¬¡äº¤ä»˜å¿…é¡»æˆåŠŸä¸ä¸¢å¤±æ˜¯æœ€æ˜‚è´µçš„ï¼Œå¹¶å¯¼è‡´æœ€å·®çš„æ€§èƒ½:é™¤äº†è‡³å°‘ä¸€æ¬¡äº¤ä»˜æ‰€å¢åŠ çš„å¼€é”€ä¹‹å¤–ï¼Œå®ƒè¿˜è¦æ±‚åœ¨æ¥æ”¶ç«¯ä¿æŒçŠ¶æ€ï¼Œä»¥ä¾¿è¿‡æ»¤é‡å¤äº¤ä»˜ã€‚</p>

<p>åœ¨ä¸€ä¸ªè¡Œä¸ºäººç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç¡®å®šä¿è¯çš„ç¡®åˆ‡å«ä¹‰-åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ç³»ç»Ÿè®¤ä¸ºäº¤ä»˜å·²å®Œæˆ:</p>

<ol>
  <li>ä»€ä¹ˆæ—¶å€™åœ¨ç½‘ç»œä¸Šå‘é€æ¶ˆæ¯?</li>
  <li>ç›®æ ‡actorçš„ä¸»æœºä½•æ—¶æ¥æ”¶åˆ°æ¶ˆæ¯?</li>
  <li>ä½•æ—¶å°†æ¶ˆæ¯æ”¾å…¥ç›®æ ‡Actorçš„é‚®ç®±?</li>
  <li>æ¶ˆæ¯ç›®æ ‡actorä½•æ—¶å¼€å§‹å¤„ç†æ¶ˆæ¯?</li>
  <li>ç›®æ ‡actorä½•æ—¶æˆåŠŸå¤„ç†äº†æ¶ˆæ¯?</li>
</ol>

<p>å¤§å¤šæ•°å£°ç§°ä¿è¯äº¤ä»˜çš„æ¡†æ¶å’Œåè®®å®é™…ä¸Šæä¾›äº†ç±»ä¼¼äºç¬¬4ç‚¹å’Œç¬¬5ç‚¹çš„å†…å®¹ã€‚è™½ç„¶è¿™å¬èµ·æ¥å¾ˆåˆç†ï¼Œä½†å®ƒçœŸçš„æœ‰ç”¨å—?ä¸ºäº†ç†è§£å…¶ä¸­çš„å«ä¹‰ï¼Œè€ƒè™‘ä¸€ä¸ªç®€å•çš„å®é™…ç¤ºä¾‹:ä¸€ä¸ªç”¨æˆ·è¯•å›¾ä¸‹è®¢å•ï¼Œè€Œæˆ‘ä»¬åªæƒ³åœ¨è®¢å•å®é™…ä¸Šåœ¨ordersæ•°æ®åº“çš„ç£ç›˜ä¸Šæ—¶å£°æ˜å®ƒå·²æˆåŠŸå¤„ç†ã€‚</p>

<p>å¦‚æœæˆ‘ä»¬ä¾èµ–äºæ¶ˆæ¯çš„æˆåŠŸå¤„ç†ï¼Œé‚£ä¹ˆä¸€æ—¦è®¢å•è¢«æäº¤ç»™è´Ÿè´£éªŒè¯ã€å¤„ç†å¹¶å°†å…¶æ”¾å…¥æ•°æ®åº“çš„å†…éƒ¨API, actorå°±ä¼šæŠ¥å‘ŠæˆåŠŸã€‚ä¸å¹¸çš„æ˜¯ï¼Œåœ¨APIè¢«è°ƒç”¨åç«‹å³ä¼šå‘ç”Ÿä»¥ä¸‹ä»»ä½•æƒ…å†µ:</p>

<ul>
  <li>ä¸»æœºå¯èƒ½ä¼šå´©æºƒã€‚</li>
  <li>ååºåˆ—åŒ–å¯ä»¥å¤±è´¥ã€‚</li>
  <li>éªŒè¯å¤±è´¥ã€‚</li>
  <li>æ•°æ®åº“å¯èƒ½ä¸å¯ç”¨ã€‚</li>
  <li>å¯èƒ½ä¼šå‡ºç°ç¼–ç¨‹é”™è¯¯ã€‚</li>
</ul>

<p>è¿™è¯´æ˜äº†äº¤ä»˜çš„ä¿è¯ä¸ä¼šè½¬æ¢ä¸ºåŸŸçº§åˆ«çš„ä¿è¯ã€‚æˆ‘ä»¬åªå¸Œæœ›åœ¨è®¢å•å®é™…ä¸Šå·²å®Œå…¨å¤„ç†å¹¶æŒä¹…åŒ–åæŠ¥å‘ŠæˆåŠŸã€‚æƒŸä¸€èƒ½å¤ŸæŠ¥å‘ŠæˆåŠŸçš„å®ä½“æ˜¯åº”ç”¨ç¨‹åºæœ¬èº«ï¼Œå› ä¸ºåªæœ‰å®ƒäº†è§£æ‰€éœ€çš„åŸŸä¿è¯ã€‚æ²¡æœ‰ä¸€ä¸ªé€šç”¨çš„æ¡†æ¶èƒ½å¤ŸæŒ‡å‡ºç‰¹å®šé¢†åŸŸçš„ç»†èŠ‚ï¼Œä»¥åŠåœ¨è¯¥é¢†åŸŸä¸­ä»€ä¹ˆè¢«è®¤ä¸ºæ˜¯æˆåŠŸçš„ã€‚</p>

<p>åœ¨è¿™ä¸ªç‰¹å®šçš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åªå¸Œæœ›åœ¨æ•°æ®åº“å†™å…¥æˆåŠŸåå‘å‡ºæˆåŠŸçš„ä¿¡å·ï¼Œå…¶ä¸­æ•°æ®åº“ç¡®è®¤è®¢å•ç°åœ¨å·²å®‰å…¨å­˜å‚¨ã€‚ç”±äºè¿™äº›åŸå› ï¼ŒAkkaå°†ä¿è¯çš„è´£ä»»æ¨ç»™äº†åº”ç”¨ç¨‹åºæœ¬èº«ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‚¨å¿…é¡»è‡ªå·±ä½¿ç”¨Akkaæä¾›çš„å·¥å…·æ¥å®ç°å®ƒä»¬ã€‚è¿™ä½¿æ‚¨å¯ä»¥å®Œå…¨æ§åˆ¶æ‚¨æƒ³è¦æä¾›çš„ä¿è¯ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹Akkaæä¾›çš„æ¶ˆæ¯é¡ºåºï¼Œå®ƒå¯ä»¥æ–¹ä¾¿åœ°æ¨æ–­åº”ç”¨ç¨‹åºé€»è¾‘ã€‚</p>

<h4 id="2344-æ¶ˆæ¯æ’åº">2.3.4.4. æ¶ˆæ¯æ’åº</h4>

<p>åœ¨Akkaä¸­ï¼Œå¯¹äºç»™å®šçš„ä¸€å¯¹Actorï¼Œä»ç¬¬ä¸€ä¸ªActorç›´æ¥å‘é€åˆ°ç¬¬äºŒä¸ªActorçš„æ¶ˆæ¯å°†ä¸ä¼šè¢«æ— åºåœ°æ¥æ”¶ã€‚è¿™ä¸ªè¯ç›´æ¥å¼ºè°ƒäº†è¿™ç§ä¿è¯åªé€‚ç”¨äºä¸tellæ“ä½œå‘˜ç›´æ¥å‘é€åˆ°æœ€ç»ˆç›®çš„åœ°ï¼Œä½†ä¸é€‚ç”¨äºé›‡ç”¨è°ƒè§£äººã€‚</p>

<p>å¦‚æœï¼š</p>

<ul>
  <li>Actor A1 sends messages M1, M2, M3 to A2.</li>
  <li>Actor A3 sends messages M4, M5, M6 to A2.</li>
</ul>

<p>è¿™æ„å‘³ç€ï¼Œå¯¹äºAkkaæ¶ˆæ¯:</p>

<ul>
  <li>å¦‚æœäº¤ä»˜M1ï¼Œå¿…é¡»åœ¨M2å’ŒM3ä¹‹å‰äº¤ä»˜ã€‚</li>
  <li>å¦‚æœM2äº¤ä»˜ï¼Œå¿…é¡»åœ¨M3ä¹‹å‰äº¤ä»˜ã€‚</li>
  <li>å¦‚æœè¦äº¤ä»˜M4ï¼Œåˆ™å¿…é¡»åœ¨M5å’ŒM6ä¹‹å‰äº¤ä»˜ã€‚</li>
  <li>å¦‚æœè¦äº¤ä»˜M5ï¼Œåˆ™å¿…é¡»åœ¨M6ä¹‹å‰äº¤ä»˜ã€‚</li>
  <li>A2å¯ä»¥çœ‹åˆ°æ¥è‡ªA1çš„æ¶ˆæ¯ä¸æ¥è‡ªA3çš„æ¶ˆæ¯äº¤ç»‡åœ¨ä¸€èµ·ã€‚</li>
  <li>ç”±äºæ²¡æœ‰ä¼ é€’çš„ä¿è¯ï¼Œä»»ä½•æ¶ˆæ¯éƒ½å¯èƒ½è¢«ä¸¢å¼ƒï¼Œä¹Ÿå°±æ˜¯è¯´æ²¡æœ‰åˆ°è¾¾A2ã€‚</li>
</ul>

<p>è¿™äº›ä¿è¯å®ç°äº†è‰¯å¥½çš„å¹³è¡¡:è®©æ¥è‡ªä¸€ä¸ªActorçš„æ¶ˆæ¯æŒ‰é¡ºåºåˆ°è¾¾æœ‰åˆ©äºæ„å»ºæ˜“äºæ¨ç†çš„ç³»ç»Ÿï¼Œè€Œå¦ä¸€æ–¹é¢ï¼Œå…è®¸æ¥è‡ªä¸åŒActorçš„æ¶ˆæ¯äº¤é”™åˆ°è¾¾ï¼Œä¸ºActorç³»ç»Ÿçš„æœ‰æ•ˆå®ç°æä¾›äº†è¶³å¤Ÿçš„è‡ªç”±ã€‚</p>

<p>æœ‰å…³é€è´§ä¿è¯çš„è¯¦æƒ…ï¼Œè¯·å‚é˜…<a href="https://doc.akka.io/docs/akka/current/general/message-delivery-reliability.html">å‚è€ƒç½‘é¡µ</a></p>

<h4 id="2345-è®¾å¤‡æ¶ˆæ¯å¢åŠ çµæ´»æ€§">2.3.4.5. è®¾å¤‡æ¶ˆæ¯å¢åŠ çµæ´»æ€§</h4>

<p>æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæŸ¥è¯¢åè®®æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯æ²¡æœ‰è€ƒè™‘åˆ°åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„æ‰§è¡Œã€‚å¦‚æœæˆ‘ä»¬æƒ³åœ¨æŸ¥è¯¢è®¾å¤‡Actor(å› ä¸ºè¶…æ—¶è¯·æ±‚)çš„Actorä¸­å®ç°resendsï¼Œæˆ–è€…å¦‚æœæˆ‘ä»¬æƒ³æŸ¥è¯¢å¤šä¸ªActorï¼Œæˆ‘ä»¬éœ€è¦èƒ½å¤Ÿå…³è”è¯·æ±‚å’Œå“åº”ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨æˆ‘ä»¬çš„æ¶ˆæ¯ä¸­å¢åŠ äº†ä¸€ä¸ªå­—æ®µï¼Œä»¥ä¾¿è¯·æ±‚è€…æä¾›ä¸€ä¸ªIDå³requestId(æˆ‘ä»¬å°†åœ¨åé¢çš„æ­¥éª¤ä¸­æ·»åŠ è¿™ä¸ªä»£ç åˆ°æˆ‘ä»¬çš„åº”ç”¨ä¸­):</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Device</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ReadTemperature</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">RespondTemperature</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ReadTemperature</span><span class="o">(</span><span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">RespondTemperature</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RespondTemperature</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">value</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">RespondTemperature</span><span class="o">(</span><span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="2346-å®ç°è®¾å¤‡actoråŠå…¶è¯»å–åè®®">2.3.4.6. å®ç°è®¾å¤‡actoråŠå…¶è¯»å–åè®®</h4>

<p>æ­£å¦‚æˆ‘ä»¬åœ¨Hello Worldç¤ºä¾‹ä¸­äº†è§£åˆ°çš„ï¼Œæ¯ä¸ªActoréƒ½å®šä¹‰äº†å®ƒå°†æ¥å—çš„æ¶ˆæ¯ç±»å‹ã€‚æˆ‘ä»¬çš„è®¾å¤‡Actoræœ‰è´£ä»»ä¸ºç»™å®šæŸ¥è¯¢çš„å“åº”ä½¿ç”¨ç›¸åŒçš„IDå‚æ•°ï¼Œè¿™å°†ä½¿å®ƒçœ‹èµ·æ¥å¦‚ä¸‹æ‰€ç¤ºã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">akka.actor.typed.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.Behavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.PostStop</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.AbstractBehavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.ActorContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Behaviors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Receive</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Device</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ReadTemperature</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">RespondTemperature</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ReadTemperature</span><span class="o">(</span><span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">RespondTemperature</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RespondTemperature</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">value</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">RespondTemperature</span><span class="o">(</span><span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span><span class="nc">String</span> <span class="n">groupId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">deviceId</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="n">context</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">Device</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">deviceId</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">lastTemperatureReading</span> <span class="o">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>

  <span class="kd">private</span> <span class="nf">Device</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">deviceId</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">groupId</span> <span class="o">=</span> <span class="n">groupId</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">deviceId</span> <span class="o">=</span> <span class="n">deviceId</span><span class="o">;</span>

    <span class="n">context</span><span class="o">.</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Device actor {}-{} started"</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">ReadTemperature</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onReadTemperature</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onSignal</span><span class="o">(</span><span class="nc">PostStop</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">signal</span> <span class="o">-&gt;</span> <span class="n">onPostStop</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onReadTemperature</span><span class="o">(</span><span class="nc">ReadTemperature</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">r</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">requestId</span><span class="o">,</span> <span class="n">lastTemperatureReading</span><span class="o">));</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Device</span> <span class="nf">onPostStop</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Device actor {}-{} stopped"</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨ä»£ç ä¸­è¯·æ³¨æ„:</p>

<ul>
  <li>
    <p>é™æ€åˆ›å»ºæ–¹æ³•å®šä¹‰äº†å¦‚ä½•ä¸ºè®¾å¤‡Actoræ„é€ è¡Œä¸ºã€‚è¿™äº›å‚æ•°åŒ…æ‹¬è®¾å¤‡çš„IDå’Œå®ƒæ‰€å±çš„ç»„ï¼Œæˆ‘ä»¬å°†åœ¨åé¢ä½¿ç”¨ã€‚</p>
  </li>
  <li>
    <p>æˆ‘ä»¬å‰é¢è®¨è®ºçš„æ¶ˆæ¯æ˜¯åœ¨å‰é¢æ˜¾ç¤ºçš„Deviceç±»ä¸­å®šä¹‰çš„ã€‚</p>
  </li>
  <li>
    <p>åœ¨è®¾å¤‡ç±»ä¸­ï¼ŒlastTemperatureReadingçš„å€¼æœ€åˆè®¾ç½®ä¸ºoption.empty()ï¼Œå¦‚æœè¢«æŸ¥è¯¢ï¼ŒActorå°†æŠ¥å‘Šå®ƒã€‚</p>
  </li>
</ul>

<h4 id="2347-æµ‹è¯•actor">2.3.4.7. æµ‹è¯•Actor</h4>

<p>åŸºäºä¸Šé¢çš„Actorï¼Œåœ¨é¡¹ç›®çš„com.tcfuture.akka.actor.iotåŒ…ä¸‹æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªæµ‹è¯•ã€‚å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°DeviceTest.javaæ–‡ä»¶ä¸­ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">akka.actor.testkit.typed.javadsl.TestKitJunitResource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.testkit.typed.javadsl.TestProbe</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.ClassRule</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">;</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DeviceTest</span> <span class="o">{</span>

  <span class="nd">@ClassRule</span> <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">TestKitJunitResource</span> <span class="n">testKit</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TestKitJunitResource</span><span class="o">();</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testReplyWithEmptyReadingIfNoTemperatureIsKnown</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">RespondTemperature</span><span class="o">&gt;</span> <span class="n">probe</span> <span class="o">=</span>
        <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">RespondTemperature</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">deviceActor</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">"group"</span><span class="o">,</span> <span class="s">"device"</span><span class="o">));</span>
    <span class="n">deviceActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Device</span><span class="o">.</span><span class="na">ReadTemperature</span><span class="o">(</span><span class="mi">42L</span><span class="o">,</span> <span class="n">probe</span><span class="o">.</span><span class="na">getRef</span><span class="o">()));</span>
    <span class="nc">Device</span><span class="o">.</span><span class="na">RespondTemperature</span> <span class="n">response</span> <span class="o">=</span> <span class="n">probe</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">();</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="mi">42L</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">requestId</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">(),</span> <span class="n">response</span><span class="o">.</span><span class="na">value</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æµ‹è¯•æ–¹æ³•æ‰§è¡Œç»“æœ</p>

<pre><code class="language-log">[2020-08-03 01:45:52,355] [INFO] [com.tcfuture.akka.actor.iot.Device] [DeviceTest-akka.actor.default-dispatcher-9] [akka://DeviceTest/user/$a] - Device actor group-device started
[2020-08-03 01:45:52,364] [INFO] [com.tcfuture.akka.actor.iot.Device] [DeviceTest-akka.actor.default-dispatcher-9] [akka://DeviceTest/user/$a] - Reading temperature read Optional.empty with 42
</code></pre>

<p>ç°åœ¨ï¼Œå½“Actoræ”¶åˆ°æ¥è‡ªä¼ æ„Ÿå™¨çš„æ¶ˆæ¯æ—¶ï¼Œå®ƒéœ€è¦ä¸€ç§æ–¹æ³•æ¥æ”¹å˜æ¸©åº¦çš„çŠ¶æ€ã€‚</p>

<h4 id="2348-æ·»åŠ å†™åè®®">2.3.4.8. æ·»åŠ å†™åè®®</h4>

<p>å†™åè®®çš„ç›®çš„æ˜¯åœ¨actoræ¥æ”¶åˆ°åŒ…å«æ¸©åº¦çš„æ¶ˆæ¯æ—¶æ›´æ–°currentTemperatureå­—æ®µã€‚åŒæ ·ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å°†writeåè®®å®šä¹‰ä¸ºä¸€ä¸ªéå¸¸ç®€å•çš„æ¶ˆæ¯ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RecordTemperature</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
  <span class="kd">final</span> <span class="kt">double</span> <span class="n">value</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">RecordTemperature</span><span class="o">(</span><span class="kt">double</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä½†æ˜¯ï¼Œè¿™ç§æ–¹æ³•æ²¡æœ‰è€ƒè™‘åˆ°è®°å½•æ¸©åº¦æ¶ˆæ¯çš„å‘é€è€…æ°¸è¿œä¸èƒ½ç¡®å®šè¯¥æ¶ˆæ¯æ˜¯å¦å·²è¢«å¤„ç†ã€‚æˆ‘ä»¬å·²ç»çœ‹åˆ°ï¼ŒAkkaå¹¶ä¸ä¿è¯è¿™äº›æ¶ˆæ¯çš„ä¼ é€’ï¼Œè€Œæ˜¯è®©åº”ç”¨ç¨‹åºæä¾›æˆåŠŸé€šçŸ¥ã€‚åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œä¸€æ—¦æˆ‘ä»¬æ›´æ–°äº†ä¸Šæ¬¡çš„æ¸©åº¦è®°å½•ï¼Œæˆ‘ä»¬å°±ä¼šå‘å‘é€è€…å‘é€ç¡®è®¤ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼Œå›å¤ä¸€æ¡æ¸©åº¦æ¢å¤è®°å½•ä¿¡æ¯ã€‚ä¸æ¸©åº¦æŸ¥è¯¢å’Œå“åº”ä¸€æ ·ï¼ŒåŒ…å«è¯·æ±‚IDå­—æ®µä»¥æä¾›æœ€å¤§çš„çµæ´»æ€§ä¹Ÿæ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RecordTemperature</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
  <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>
  <span class="kd">final</span> <span class="kt">double</span> <span class="n">value</span><span class="o">;</span>
  <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">TemperatureRecorded</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">RecordTemperature</span><span class="o">(</span><span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span> <span class="kt">double</span> <span class="n">value</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">TemperatureRecorded</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TemperatureRecorded</span> <span class="o">{</span>
  <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">TemperatureRecorded</span><span class="o">(</span><span class="kt">long</span> <span class="n">requestId</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="2349-actorè¯»å†™æ¶ˆæ¯">2.3.4.9. Actorè¯»å†™æ¶ˆæ¯</h4>

<p>æŠŠè¯»å†™åè®®æ”¾åœ¨ä¸€èµ·ï¼Œè®¾å¤‡Actorçœ‹èµ·æ¥åƒä¸‹é¢çš„ä¾‹å­:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.Behavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.PostStop</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.AbstractBehavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.ActorContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Behaviors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Receive</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Device</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RecordTemperature</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">double</span> <span class="n">value</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">TemperatureRecorded</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">RecordTemperature</span><span class="o">(</span><span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span> <span class="kt">double</span> <span class="n">value</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">TemperatureRecorded</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TemperatureRecorded</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">TemperatureRecorded</span><span class="o">(</span><span class="kt">long</span> <span class="n">requestId</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ReadTemperature</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">RespondTemperature</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ReadTemperature</span><span class="o">(</span><span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">RespondTemperature</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RespondTemperature</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">value</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">RespondTemperature</span><span class="o">(</span><span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span><span class="nc">String</span> <span class="n">groupId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">deviceId</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="n">context</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">Device</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">deviceId</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">lastTemperatureReading</span> <span class="o">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>

  <span class="kd">private</span> <span class="nf">Device</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">deviceId</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">groupId</span> <span class="o">=</span> <span class="n">groupId</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">deviceId</span> <span class="o">=</span> <span class="n">deviceId</span><span class="o">;</span>

    <span class="n">context</span><span class="o">.</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Device actor {}-{} started"</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">RecordTemperature</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onRecordTemperature</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">ReadTemperature</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onReadTemperature</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onSignal</span><span class="o">(</span><span class="nc">PostStop</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">signal</span> <span class="o">-&gt;</span> <span class="n">onPostStop</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onRecordTemperature</span><span class="o">(</span><span class="nc">RecordTemperature</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Recorded temperature reading {} with {}"</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">value</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">requestId</span><span class="o">);</span>
    <span class="n">lastTemperatureReading</span> <span class="o">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">value</span><span class="o">);</span>
    <span class="n">r</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">TemperatureRecorded</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">requestId</span><span class="o">));</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onReadTemperature</span><span class="o">(</span><span class="nc">ReadTemperature</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">r</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">requestId</span><span class="o">,</span> <span class="n">lastTemperatureReading</span><span class="o">));</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onPostStop</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Device actor {}-{} stopped"</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">stopped</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æˆ‘ä»¬ç°åœ¨ä¹Ÿåº”è¯¥å†™ä¸€ä¸ªæ–°çš„æµ‹è¯•ç”¨ä¾‹ï¼ŒåŒæ—¶ä½¿ç”¨è¯»/æŸ¥è¯¢å’Œå†™/è®°å½•åŠŸèƒ½:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testReplyWithLatestTemperatureReading</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">TemperatureRecorded</span><span class="o">&gt;</span> <span class="n">recordProbe</span> <span class="o">=</span>
      <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">TemperatureRecorded</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">RespondTemperature</span><span class="o">&gt;</span> <span class="n">readProbe</span> <span class="o">=</span>
      <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">RespondTemperature</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">deviceActor</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">"group"</span><span class="o">,</span> <span class="s">"device"</span><span class="o">));</span>

  <span class="n">deviceActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Device</span><span class="o">.</span><span class="na">RecordTemperature</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mf">24.0</span><span class="o">,</span> <span class="n">recordProbe</span><span class="o">.</span><span class="na">getRef</span><span class="o">()));</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="n">recordProbe</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">().</span><span class="na">requestId</span><span class="o">);</span>

  <span class="n">deviceActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Device</span><span class="o">.</span><span class="na">ReadTemperature</span><span class="o">(</span><span class="mi">2L</span><span class="o">,</span> <span class="n">readProbe</span><span class="o">.</span><span class="na">getRef</span><span class="o">()));</span>
  <span class="nc">Device</span><span class="o">.</span><span class="na">RespondTemperature</span> <span class="n">response1</span> <span class="o">=</span> <span class="n">readProbe</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">();</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">2L</span><span class="o">,</span> <span class="n">response1</span><span class="o">.</span><span class="na">requestId</span><span class="o">);</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mf">24.0</span><span class="o">),</span> <span class="n">response1</span><span class="o">.</span><span class="na">value</span><span class="o">);</span>

  <span class="n">deviceActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Device</span><span class="o">.</span><span class="na">RecordTemperature</span><span class="o">(</span><span class="mi">3L</span><span class="o">,</span> <span class="mf">55.0</span><span class="o">,</span> <span class="n">recordProbe</span><span class="o">.</span><span class="na">getRef</span><span class="o">()));</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">3L</span><span class="o">,</span> <span class="n">recordProbe</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">().</span><span class="na">requestId</span><span class="o">);</span>

  <span class="n">deviceActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Device</span><span class="o">.</span><span class="na">ReadTemperature</span><span class="o">(</span><span class="mi">4L</span><span class="o">,</span> <span class="n">readProbe</span><span class="o">.</span><span class="na">getRef</span><span class="o">()));</span>
  <span class="nc">Device</span><span class="o">.</span><span class="na">RespondTemperature</span> <span class="n">response2</span> <span class="o">=</span> <span class="n">readProbe</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">();</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">4L</span><span class="o">,</span> <span class="n">response2</span><span class="o">.</span><span class="na">requestId</span><span class="o">);</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mf">55.0</span><span class="o">),</span> <span class="n">response2</span><span class="o">.</span><span class="na">value</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æµ‹è¯•æƒ…å†µå¦‚ä¸‹</p>

<pre><code class="language-log">[2020-08-03 02:09:13,147] [INFO] [com.tcfuture.akka.actor.iot.Device] [DeviceTest-akka.actor.default-dispatcher-8] [akka://DeviceTest/user/$a] - Device actor group-device started
[2020-08-03 02:09:13,156] [INFO] [com.tcfuture.akka.actor.iot.Device] [DeviceTest-akka.actor.default-dispatcher-8] [akka://DeviceTest/user/$a] - Recorded temperature reading 24.0 with 1
[2020-08-03 02:09:13,158] [INFO] [com.tcfuture.akka.actor.iot.Device] [DeviceTest-akka.actor.default-dispatcher-8] [akka://DeviceTest/user/$a] - Reading temperature read Optional[24.0] with 2
[2020-08-03 02:09:13,159] [INFO] [com.tcfuture.akka.actor.iot.Device] [DeviceTest-akka.actor.default-dispatcher-3] [akka://DeviceTest/user/$a] - Recorded temperature reading 55.0 with 3
[2020-08-03 02:09:13,160] [INFO] [com.tcfuture.akka.actor.iot.Device] [DeviceTest-akka.actor.default-dispatcher-8] [akka://DeviceTest/user/$a] - Reading temperature read Optional[55.0] with 4
</code></pre>

<h4 id="23410-ä¸‹ä¸€æ­¥åšå•¥">2.3.4.10. ä¸‹ä¸€æ­¥åšå•¥ï¼Ÿ</h4>

<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å¼€å§‹è®¾è®¡æˆ‘ä»¬çš„æ€»ä½“æ¶æ„ï¼Œå¹¶ä¸”æˆ‘ä»¬ç¼–å†™äº†ç›´æ¥å¯¹åº”äºé¢†åŸŸçš„ç¬¬ä¸€ä¸ªActorã€‚ç°åœ¨æˆ‘ä»¬å¿…é¡»åˆ›å»ºè´Ÿè´£ç»´æŠ¤è®¾å¤‡ç»„å’Œè®¾å¤‡Actoræœ¬èº«çš„ç»„ä»¶ã€‚</p>

<h3 id="235-è®¾å¤‡ç»„working">2.3.5. è®¾å¤‡ç»„Working</h3>

<h4 id="2351-ä»‹ç»">2.3.5.1. ä»‹ç»</h4>

<p>è®©æˆ‘ä»¬ä»”ç»†çœ‹çœ‹ç”¨ä¾‹æ‰€éœ€çš„ä¸»è¦åŠŸèƒ½ã€‚åœ¨ç”¨äºç›‘è§†å®¶åº­æ¸©åº¦çš„å®Œæ•´IoTç³»ç»Ÿä¸­ï¼Œå°†è®¾å¤‡ä¼ æ„Ÿå™¨è¿æ¥åˆ°æˆ‘ä»¬çš„ç³»ç»Ÿçš„æ­¥éª¤å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<ol>
  <li>å®¶åº­ä¸­çš„ä¼ æ„Ÿå™¨è®¾å¤‡é€šè¿‡æŸç§åè®®è¿›è¡Œè¿æ¥ã€‚</li>
  <li>ç®¡ç†ç½‘ç»œè¿æ¥çš„ç»„ä»¶æ¥å—è¯¥è¿æ¥ã€‚</li>
  <li>ä¼ æ„Ÿå™¨æä¾›å…¶ç»„å’Œè®¾å¤‡IDï¼Œä»¥å‘æˆ‘ä»¬ç³»ç»Ÿçš„è®¾å¤‡ç®¡ç†å™¨ç»„ä»¶æ³¨å†Œã€‚</li>
  <li>è®¾å¤‡ç®¡ç†å™¨ç»„ä»¶é€šè¿‡æŸ¥æ‰¾æˆ–åˆ›å»ºè´Ÿè´£ä¿æŒä¼ æ„Ÿå™¨çŠ¶æ€çš„Actoræ¥å¤„ç†æ³¨å†Œã€‚</li>
  <li>Actorä»¥ä¸€ä¸ªç¡®è®¤å›åº”ï¼Œå…¬å¼€äº†å®ƒçš„ActorRefã€‚</li>
  <li>ç°åœ¨ï¼Œç½‘ç»œç»„ä»¶ActorRefæ— éœ€é€šè¿‡è®¾å¤‡ç®¡ç†å™¨å³å¯ä½¿ç”¨ä¼ æ„Ÿå™¨å’Œè®¾å¤‡Actorä¹‹é—´çš„é€šä¿¡ã€‚</li>
</ol>

<p>æ­¥éª¤1å’Œ2åœ¨æˆ‘ä»¬çš„æ•™ç¨‹ç³»ç»Ÿçš„èŒƒå›´ä¹‹å¤–è¿›è¡Œã€‚åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†å¼€å§‹å¤„ç†æ­¥éª¤3-6ï¼Œå¹¶ä¸ºä¼ æ„Ÿå™¨åˆ›å»ºä¸€ç§å‘æˆ‘ä»¬çš„ç³»ç»Ÿæ³¨å†Œå¹¶ä¸Actorè¿›è¡Œé€šä¿¡çš„æ–¹å¼ã€‚ä½†æ˜¯é¦–å…ˆï¼Œæˆ‘ä»¬è¦åšå‡ºå¦ä¸€ä¸ªä½“ç³»ç»“æ„å†³ç­–-æˆ‘ä»¬åº”è¯¥ä½¿ç”¨å¤šå°‘çº§Actoræ¥è¡¨ç¤ºè®¾å¤‡ç»„å’Œè®¾å¤‡ä¼ æ„Ÿå™¨ï¼Ÿ</p>

<p>Akkaç¨‹åºå‘˜é¢ä¸´çš„ä¸»è¦è®¾è®¡æŒ‘æˆ˜ä¹‹ä¸€æ˜¯ä¸ºè§’è‰²é€‰æ‹©æœ€ä½³ç²’åº¦ã€‚åœ¨å®è·µä¸­ï¼Œæ ¹æ®Actorä¹‹é—´äº¤äº’çš„ç‰¹å¾ï¼Œé€šå¸¸æœ‰å‡ ç§æœ‰æ•ˆçš„æ–¹æ³•æ¥ç»„ç»‡ç³»ç»Ÿã€‚ä¾‹å¦‚ï¼Œåœ¨æˆ‘ä»¬çš„ç”¨ä¾‹ä¸­ï¼Œæœ‰å¯èƒ½è®©ä¸€ä¸ªActorç»´æŠ¤æ‰€æœ‰ç»„å’Œè®¾å¤‡-ä¹Ÿè®¸ä½¿ç”¨å“ˆå¸Œæ˜ å°„ã€‚æ¯ä¸ªç»„éƒ½æœ‰ä¸€ä¸ªActoræ¥è·Ÿè¸ªåŒä¸€å®¶åº­ä¸­æ‰€æœ‰è®¾å¤‡çš„çŠ¶æ€ä¹Ÿæ˜¯åˆç†çš„ã€‚</p>

<p>ä»¥ä¸‹å‡†åˆ™å¯å¸®åŠ©æˆ‘ä»¬é€‰æ‹©æœ€åˆé€‚çš„Actorå±‚æ¬¡ç»“æ„ï¼š</p>

<ul>
  <li>é€šå¸¸ï¼Œæ›´å–œæ¬¢è¾ƒå¤§çš„ç²’åº¦ã€‚å¼•å…¥æ¯”éœ€è¦çš„æ›´å¤šçš„ç»†ç²’åº¦actorä¼šå¯¼è‡´æ›´å¤šçš„é—®é¢˜è€Œä¸æ˜¯è§£å†³çš„é—®é¢˜ã€‚</li>
  <li>å½“ç³»ç»Ÿéœ€è¦ä»¥ä¸‹æ¡ä»¶æ—¶ï¼Œè¯·æ·»åŠ æ›´ç²¾ç»†çš„ç²’åº¦ï¼š</li>
  <li>æ›´é«˜çš„å¹¶å‘æ€§ã€‚</li>
  <li>å…·æœ‰è®¸å¤šçŠ¶æ€çš„Actorä¹‹é—´çš„å¤æ‚å¯¹è¯ã€‚åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚</li>
  <li>æœ‰è¶³å¤Ÿçš„çŠ¶æ€å¯ä»¥åˆ’åˆ†æˆè¾ƒå°çš„Actorã€‚</li>
  <li>å¤šé‡æ— å…³çš„è´£ä»»ã€‚ä½¿ç”¨å•ç‹¬çš„è§’è‰²å¯ä»¥ä½¿ä¸ªäººå¤±è´¥å¹¶å¾—åˆ°æ¢å¤ï¼Œè€Œå¯¹ä»–äººçš„å½±å“å¾ˆå°ã€‚</li>
</ul>

<h4 id="2352-è®¾å¤‡ç®¡ç†å™¨å±‚æ¬¡ç»“æ„">2.3.5.2. è®¾å¤‡ç®¡ç†å™¨å±‚æ¬¡ç»“æ„</h4>

<p>è€ƒè™‘åˆ°ä¸Šä¸€èŠ‚ä¸­æ¦‚è¿°çš„åŸç†ï¼Œæˆ‘ä»¬å°†è®¾å¤‡ç®¡ç†å™¨ç»„ä»¶å»ºæ¨¡ä¸ºå…·æœ‰ä¸‰ä¸ªçº§åˆ«çš„Actoræ ‘ï¼š</p>

<ul>
  <li>
    <p>é¡¶çº§ä¸»ç®¡Actorä»£è¡¨è®¾å¤‡çš„ç³»ç»Ÿç»„ä»¶ã€‚å®ƒä¹Ÿæ˜¯æŸ¥æ‰¾å’Œåˆ›å»ºè®¾å¤‡ç»„å’Œè®¾å¤‡Actorçš„å…¥å£ã€‚</p>
  </li>
  <li>
    <p>åœ¨ä¸‹ä¸€ä¸ªçº§åˆ«ï¼Œç»„Actoråˆ†åˆ«ç›‘ç£è®¾å¤‡Actorçš„ä¸€ä¸ªç»„IDï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªä½æ‰€ï¼‰ã€‚ä»–ä»¬è¿˜æä¾›æœåŠ¡ï¼Œä¾‹å¦‚æŸ¥è¯¢å…¶ç»„ä¸­æ‰€æœ‰å¯ç”¨è®¾å¤‡çš„æ¸©åº¦è¯»æ•°ã€‚</p>
  </li>
  <li>
    <p>è®¾å¤‡Actorè´Ÿè´£ç®¡ç†ä¸å®é™…è®¾å¤‡ä¼ æ„Ÿå™¨çš„æ‰€æœ‰äº¤äº’ï¼Œä¾‹å¦‚å­˜å‚¨æ¸©åº¦è¯»æ•°ã€‚</p>
  </li>
</ul>

<p><img src="https://liulv.work/images/img/device_manager_tree.png" alt="device_manager_tree" /></p>

<p>å‡ºäºä»¥ä¸‹åŸå› ï¼Œæˆ‘ä»¬é€‰æ‹©äº†è¿™ç§ä¸‰å±‚ä½“ç³»ç»“æ„ï¼š</p>

<ul>
  <li>
    <p>ç”±ä¸ªåˆ«Actorç»„æˆçš„å°ç»„ï¼š</p>

    <ul>
      <li>éš”ç¦»ç»„ä¸­å‘ç”Ÿçš„æ•…éšœã€‚å¦‚æœå•ä¸ªè§’è‰²ç®¡ç†äº†æ‰€æœ‰è®¾å¤‡ç»„ï¼Œåˆ™ä¸€ä¸ªç»„ä¸­çš„é”™è¯¯å¯¼è‡´é‡å¯ï¼Œå°†æ¸…é™¤å…¶ä»–æƒ…å†µä¸‹æ— æ•…éšœçš„ç»„çš„çŠ¶æ€ã€‚</li>
      <li>ç®€åŒ–äº†æŸ¥è¯¢å±äºä¸€ä¸ªç»„çš„æ‰€æœ‰è®¾å¤‡çš„é—®é¢˜ã€‚æ¯ä¸ªå°ç»„Actorä»…åŒ…å«ä¸å…¶å°ç»„ç›¸å…³çš„çŠ¶æ€ã€‚</li>
      <li>å¢åŠ ç³»ç»Ÿä¸­çš„å¹¶è¡Œæ€§ã€‚ç”±äºæ¯ä¸ªç»„éƒ½æœ‰ä¸“é—¨çš„Actorï¼Œå› æ­¤å®ƒä»¬å¯ä»¥åŒæ—¶è¿è¡Œï¼Œæˆ‘ä»¬å¯ä»¥åŒæ—¶æŸ¥è¯¢å¤šä¸ªç»„ã€‚</li>
    </ul>
  </li>
  <li>
    <p>å°†ä¼ æ„Ÿå™¨å»ºæ¨¡ä¸ºå•ç‹¬çš„è®¾å¤‡Actorã€‚</p>
    <ul>
      <li>å°†ä¸€ä¸ªè®¾å¤‡Actorçš„æ•…éšœä¸ç»„ä¸­çš„å…¶ä»–è®¾å¤‡éš”ç¦»ã€‚</li>
      <li>å¢åŠ äº†æ”¶é›†æ¸©åº¦è¯»æ•°çš„å¹¶è¡Œåº¦ã€‚æ¥è‡ªä¸åŒä¼ æ„Ÿå™¨çš„ç½‘ç»œè¿æ¥ç›´æ¥ä¸å…¶å„è‡ªçš„è®¾å¤‡Actorè¿›è¡Œé€šä¿¡ï¼Œä»è€Œå‡å°‘äº†äº‰ç”¨ç‚¹ã€‚</li>
    </ul>
  </li>
</ul>

<p>ä½¿ç”¨å®šä¹‰çš„ä½“ç³»ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹ç ”ç©¶ç”¨äºæ³¨å†Œä¼ æ„Ÿå™¨çš„åè®®ã€‚</p>

<h4 id="2353-æ³¨å†Œåè®®">2.3.5.3. æ³¨å†Œåè®®</h4>

<p>ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦è®¾è®¡ç”¨äºæ³¨å†Œè®¾å¤‡ä»¥åŠåˆ›å»ºè´Ÿè´£è¯¥è®¾å¤‡çš„ç»„å’Œè®¾å¤‡Actorçš„åè®®ã€‚è¯¥åè®®å°†ç”±DeviceManagerç»„ä»¶æœ¬èº«æä¾›ï¼Œå› ä¸ºè¿™æ˜¯å”¯ä¸€å·²çŸ¥çš„ä¸”å¯é¢„å…ˆè·å¾—çš„Actorï¼šè®¾å¤‡ç»„å’Œè®¾å¤‡Actoræ˜¯æŒ‰éœ€åˆ›å»ºçš„ã€‚</p>

<p>è¯¦ç»†æŸ¥çœ‹æ³¨å†Œï¼Œæˆ‘ä»¬å¯ä»¥æ¦‚è¿°å¿…è¦çš„åŠŸèƒ½ï¼š</p>

<ol>
  <li>å½“DeviceManageræ”¶åˆ°å…·æœ‰ç»„å’Œè®¾å¤‡IDçš„è¯·æ±‚æ—¶ï¼š
    <blockquote>
      <ul>
        <li>å¦‚æœç®¡ç†è€…å·²ç»æœ‰è¯¥è®¾å¤‡ç»„çš„Actorï¼Œåˆ™å°†è¯·æ±‚è½¬å‘ç»™å®ƒã€‚</li>
        <li>å¦åˆ™ï¼Œå®ƒå°†åˆ›å»ºä¸€ä¸ªæ–°çš„è®¾å¤‡ç»„Actorï¼Œç„¶åè½¬å‘è¯¥è¯·æ±‚ã€‚</li>
      </ul>
    </blockquote>
  </li>
  <li>DeviceGroupActoræ¥æ”¶ä¸ºç»™å®šè®¾å¤‡æ³¨å†ŒActorçš„è¯·æ±‚:
    <blockquote>
      <ul>
        <li>å¦‚æœç»„ä¸­å·²ç»æœ‰è¯¥è®¾å¤‡çš„actorï¼Œåˆ™ä½¿ç”¨ActorRefç°æœ‰è®¾å¤‡actorçš„ç­”å¤ã€‚</li>
        <li>å¦åˆ™ï¼ŒDeviceGroupactoré¦–å…ˆåˆ›å»ºä¸€ä¸ªè®¾å¤‡actorï¼Œå¹¶ç”¨ActorRefæ–°åˆ›å»ºçš„è®¾å¤‡actorçš„ç­”å¤ã€‚</li>
      </ul>
    </blockquote>
  </li>
  <li>ä¼ æ„Ÿå™¨ç°åœ¨å°†å…·æœ‰ActorRefè®¾å¤‡è§’è‰²çš„æƒé™ï¼Œå¯ä»¥ç›´æ¥å‘å…¶å‘é€æ¶ˆæ¯ã€‚</li>
</ol>

<p>æˆ‘ä»¬å°†ç”¨äºä¼ è¾¾æ³¨å†Œè¯·æ±‚åŠå…¶ç¡®è®¤çš„æ¶ˆæ¯å…·æœ‰ä»¥ä¸‹å®šä¹‰ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DeviceManager</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">DeviceManager</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="cm">/**
    * è¯·æ±‚è·Ÿè¸ªç›‘æ§è®¾å¤‡
    */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RequestTrackDevice</span>
          <span class="kd">implements</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">Command</span><span class="o">,</span> <span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">Command</span> <span class="o">{</span>
      <span class="c1">//è®¾å¤‡ç»„ID</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">;</span>
      <span class="c1">//è®¾å¤‡ID</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">deviceId</span><span class="o">;</span>
      <span class="c1">//æ³¨å†ŒActorRef</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">DeviceRegistered</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

      <span class="kd">public</span> <span class="nf">RequestTrackDevice</span><span class="o">(</span><span class="nc">String</span> <span class="n">groupId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">deviceId</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">DeviceRegistered</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">this</span><span class="o">.</span><span class="na">groupId</span> <span class="o">=</span> <span class="n">groupId</span><span class="o">;</span>
          <span class="k">this</span><span class="o">.</span><span class="na">deviceId</span> <span class="o">=</span> <span class="n">deviceId</span><span class="o">;</span>
          <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
      <span class="o">}</span>
  <span class="o">}</span>

  <span class="cm">/**
    * å·²ç»æ³¨å†Œçš„è®¾å¤‡
    */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">DeviceRegistered</span> <span class="o">{</span>
      <span class="c1">//è®¾å¤‡ActorRef</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">device</span><span class="o">;</span>

      <span class="kd">public</span> <span class="nf">DeviceRegistered</span><span class="o">(</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">device</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">this</span><span class="o">.</span><span class="na">device</span> <span class="o">=</span> <span class="n">device</span><span class="o">;</span>
      <span class="o">}</span>
  <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åœ¨æ¶ˆæ¯ä¸­æ²¡æœ‰åŒ…å«è¯·æ±‚IDå­—æ®µã€‚ç”±äºæ³¨å†Œä»…å‘ç”Ÿä¸€æ¬¡ï¼Œå› æ­¤å½“ç»„ä»¶å°†ç³»ç»Ÿè¿æ¥åˆ°æŸä¸ªç½‘ç»œåè®®æ—¶ï¼Œè¯¥IDå¹¶ä¸é‡è¦ã€‚ä½†æ˜¯ï¼Œé€šå¸¸æœ€å¥½çš„åšæ³•æ˜¯åŒ…æ‹¬è¯·æ±‚IDã€‚</p>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä»å¤´å¼€å§‹å®ç°åè®®ã€‚åœ¨å®è·µä¸­ï¼Œè‡ªä¸Šè€Œä¸‹å’Œè‡ªä¸‹è€Œä¸Šçš„æ–¹æ³•éƒ½å¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬å—ç›Šäºè‡ªä¸‹è€Œä¸Šçš„æ–¹æ³•ï¼Œå› ä¸ºå®ƒä½¿æˆ‘ä»¬å¯ä»¥ç«‹å³ç¼–å†™æ–°åŠŸèƒ½çš„æµ‹è¯•ï¼Œè€Œæ— éœ€æ¨¡æ‹Ÿå‡ºéœ€è¦çš„éƒ¨åˆ†ã€‚ä»¥åå†å»ºã€‚</p>

<h4 id="2354-å‘è®¾å¤‡ç»„actoræ·»åŠ æ³¨å†Œæ”¯æŒ">2.3.5.4. å‘è®¾å¤‡ç»„Actoræ·»åŠ æ³¨å†Œæ”¯æŒ</h4>

<p>å°ç»„Actoråœ¨æ³¨å†Œæ–¹é¢æœ‰ä¸€äº›å·¥ä½œè¦åšï¼ŒåŒ…æ‹¬ï¼š</p>

<ul>
  <li>å¤„ç†å¯¹ç°æœ‰è®¾å¤‡Actorçš„æ³¨å†Œè¯·æ±‚æˆ–é€šè¿‡åˆ›å»ºæ–°Actorã€‚</li>
  <li>è·Ÿè¸ªç»„ä¸­å­˜åœ¨å“ªäº›è®¾å¤‡Actorï¼Œå¹¶åœ¨ä»–ä»¬åœæ­¢æ—¶å°†å…¶ä»ç»„ä¸­åˆ é™¤ã€‚</li>
</ul>

<p>å®ç°å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DeviceGroup</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">private</span> <span class="kd">class</span> <span class="nc">DeviceTerminated</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">device</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">deviceId</span><span class="o">;</span>

    <span class="nc">DeviceTerminated</span><span class="o">(</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">device</span><span class="o">,</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">deviceId</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">device</span> <span class="o">=</span> <span class="n">device</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">groupId</span> <span class="o">=</span> <span class="n">groupId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">deviceId</span> <span class="o">=</span> <span class="n">deviceId</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span><span class="nc">String</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="n">context</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">DeviceGroup</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">groupId</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;&gt;</span> <span class="n">deviceIdToActor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

  <span class="kd">private</span> <span class="nf">DeviceGroup</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">groupId</span> <span class="o">=</span> <span class="n">groupId</span><span class="o">;</span>
    <span class="n">context</span><span class="o">.</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"DeviceGroup {} started"</span><span class="o">,</span> <span class="n">groupId</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">DeviceGroup</span> <span class="nf">onTrackDevice</span><span class="o">(</span><span class="nc">DeviceManager</span><span class="o">.</span><span class="na">RequestTrackDevice</span> <span class="n">trackMsg</span><span class="o">)</span> <span class="o">{</span>
    
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">groupId</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">trackMsg</span><span class="o">.</span><span class="na">groupId</span><span class="o">))</span> <span class="o">{</span>
      <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">deviceActor</span> <span class="o">=</span> <span class="n">deviceIdToActor</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">trackMsg</span><span class="o">.</span><span class="na">deviceId</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">deviceActor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">trackMsg</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">DeviceRegistered</span><span class="o">(</span><span class="n">deviceActor</span><span class="o">));</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Creating device actor for {}"</span><span class="o">,</span> <span class="n">trackMsg</span><span class="o">.</span><span class="na">deviceId</span><span class="o">);</span>
        <span class="n">deviceActor</span> <span class="o">=</span>
            <span class="n">getContext</span><span class="o">()</span>
                <span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">groupId</span><span class="o">,</span> <span class="n">trackMsg</span><span class="o">.</span><span class="na">deviceId</span><span class="o">),</span> <span class="s">"device-"</span> <span class="o">+</span> <span class="n">trackMsg</span><span class="o">.</span><span class="na">deviceId</span><span class="o">);</span>
        <span class="n">deviceIdToActor</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">trackMsg</span><span class="o">.</span><span class="na">deviceId</span><span class="o">,</span> <span class="n">deviceActor</span><span class="o">);</span>
        <span class="n">trackMsg</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">DeviceRegistered</span><span class="o">(</span><span class="n">deviceActor</span><span class="o">));</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">getContext</span><span class="o">()</span>
          <span class="o">.</span><span class="na">getLog</span><span class="o">()</span>
          <span class="o">.</span><span class="na">warn</span><span class="o">(</span>
              <span class="s">"Ignoring TrackDevice request for {}. This actor is responsible for {}."</span><span class="o">,</span>
              <span class="n">groupId</span><span class="o">,</span>
              <span class="k">this</span><span class="o">.</span><span class="na">groupId</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>


  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">DeviceManager</span><span class="o">.</span><span class="na">RequestTrackDevice</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onTrackDevice</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">DeviceGroup</span> <span class="nf">onPostStop</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"DeviceGroup {} stopped"</span><span class="o">,</span> <span class="n">groupId</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å°±åƒæˆ‘ä»¬å¯¹è®¾å¤‡æ‰€åšçš„ä¸€æ ·ï¼Œæˆ‘ä»¬æµ‹è¯•äº†è¿™ä¸€æ–°åŠŸèƒ½ã€‚æˆ‘ä»¬è¿˜æµ‹è¯•äº†è¿”å›çš„ä¸¤ä¸ªä¸åŒIDçš„Actorå®é™…ä¸Šæ˜¯å¦ä¸åŒï¼Œå¹¶ä¸”æˆ‘ä»¬è¿˜å°è¯•è®°å½•æ¯ä¸ªè®¾å¤‡çš„æ¸©åº¦è¯»æ•°ï¼Œä»¥æŸ¥çœ‹Actoræ˜¯å¦åœ¨å“åº”ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testReplyToRegistrationRequests</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">DeviceRegistered</span><span class="o">&gt;</span> <span class="n">probe</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">DeviceRegistered</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">groupActor</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">"group"</span><span class="o">));</span>

  <span class="n">groupActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="s">"group"</span><span class="o">,</span> <span class="s">"device"</span><span class="o">,</span> <span class="n">probe</span><span class="o">.</span><span class="na">getRef</span><span class="o">()));</span>
  <span class="nc">DeviceRegistered</span> <span class="n">registered1</span> <span class="o">=</span> <span class="n">probe</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">();</span>

  <span class="c1">// another deviceId</span>
  <span class="n">groupActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="s">"group"</span><span class="o">,</span> <span class="s">"device3"</span><span class="o">,</span> <span class="n">probe</span><span class="o">.</span><span class="na">getRef</span><span class="o">()));</span>
  <span class="nc">DeviceRegistered</span> <span class="n">registered2</span> <span class="o">=</span> <span class="n">probe</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">();</span>
  <span class="n">assertNotEquals</span><span class="o">(</span><span class="n">registered1</span><span class="o">.</span><span class="na">device</span><span class="o">,</span> <span class="n">registered2</span><span class="o">.</span><span class="na">device</span><span class="o">);</span>

  <span class="c1">// Check that the device actors are working</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">TemperatureRecorded</span><span class="o">&gt;</span> <span class="n">recordProbe</span> <span class="o">=</span>
      <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">TemperatureRecorded</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">registered1</span><span class="o">.</span><span class="na">device</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Device</span><span class="o">.</span><span class="na">RecordTemperature</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="mf">1.0</span><span class="o">,</span> <span class="n">recordProbe</span><span class="o">.</span><span class="na">getRef</span><span class="o">()));</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="n">recordProbe</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">().</span><span class="na">requestId</span><span class="o">);</span>
  <span class="n">registered2</span><span class="o">.</span><span class="na">device</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Device</span><span class="o">.</span><span class="na">RecordTemperature</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mf">2.0</span><span class="o">,</span> <span class="n">recordProbe</span><span class="o">.</span><span class="na">getRef</span><span class="o">()));</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="n">recordProbe</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">().</span><span class="na">requestId</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testIgnoreWrongRegistrationRequests</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">DeviceRegistered</span><span class="o">&gt;</span> <span class="n">probe</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">DeviceRegistered</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">groupActor</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">"group"</span><span class="o">));</span>
  <span class="n">groupActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="s">"wrongGroup"</span><span class="o">,</span> <span class="s">"device1"</span><span class="o">,</span> <span class="n">probe</span><span class="o">.</span><span class="na">getRef</span><span class="o">()));</span>
  <span class="n">probe</span><span class="o">.</span><span class="na">expectNoMessage</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¦‚æœå·²ç»å­˜åœ¨ç”¨äºæ³¨å†Œè¯·æ±‚çš„è®¾å¤‡Actorï¼Œæˆ‘ä»¬æƒ³ä½¿ç”¨ç°æœ‰çš„Actorè€Œä¸æ˜¯æ–°çš„Actorã€‚æˆ‘ä»¬å°šæœªå¯¹æ­¤è¿›è¡Œæµ‹è¯•ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è§£å†³æ­¤é—®é¢˜ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testReturnSameActorForSameDeviceId</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">DeviceRegistered</span><span class="o">&gt;</span> <span class="n">probe</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">DeviceRegistered</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">groupActor</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">"group"</span><span class="o">));</span>

  <span class="n">groupActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="s">"group"</span><span class="o">,</span> <span class="s">"device"</span><span class="o">,</span> <span class="n">probe</span><span class="o">.</span><span class="na">getRef</span><span class="o">()));</span>
  <span class="nc">DeviceRegistered</span> <span class="n">registered1</span> <span class="o">=</span> <span class="n">probe</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">();</span>

  <span class="c1">// registering same again should be idempotent</span>
  <span class="n">groupActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="s">"group"</span><span class="o">,</span> <span class="s">"device"</span><span class="o">,</span> <span class="n">probe</span><span class="o">.</span><span class="na">getRef</span><span class="o">()));</span>
  <span class="nc">DeviceRegistered</span> <span class="n">registered2</span> <span class="o">=</span> <span class="n">probe</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">();</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="n">registered1</span><span class="o">.</span><span class="na">device</span><span class="o">,</span> <span class="n">registered2</span><span class="o">.</span><span class="na">device</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="2355-è·Ÿè¸ªç»„å†…çš„è®¾å¤‡actor">2.3.5.5. è·Ÿè¸ªç»„å†…çš„è®¾å¤‡Actor</h4>

<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†åœ¨ç»„ä¸­æ³¨å†Œè®¾å¤‡Actorçš„é€»è¾‘ã€‚ä½†æ˜¯ï¼Œè®¾å¤‡å¢å¢å‡å‡ï¼ˆcome and goï¼‰ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥ä»Map&lt;String, ActorRef&gt;ä¸­åˆ é™¤è®¾å¤‡Actorã€‚æˆ‘ä»¬å‡å®šå½“è®¾å¤‡è¢«åˆ é™¤æ—¶ï¼Œå…¶ç›¸åº”çš„è®¾å¤‡Actorè¢«åœæ­¢ã€‚æ­£å¦‚æˆ‘ä»¬å‰é¢æ‰€è®¨è®ºçš„ï¼Œç›‘ç£åªèƒ½å¤„ç†é”™è¯¯æƒ…å†µï¼Œè€Œä¸èƒ½ä¼˜é›…çš„åœæ­¢ã€‚å› æ­¤ï¼Œå½“å…¶ä¸­ä¸€ä¸ªè®¾å¤‡Actoråœæ­¢æ—¶ï¼Œæˆ‘ä»¬éœ€è¦é€šçŸ¥çˆ¶ Actorã€‚</p>

<p>Akkaæä¾›äº†ä¸€ä¸ªâ€œæ­»äº¡è§‚å¯Ÿâ€åŠŸèƒ½ï¼ˆDeath Watch featureï¼‰ï¼Œè¯¥åŠŸèƒ½å…è®¸ä¸€ä¸ª Actor è§‚å¯Ÿå¦ä¸€ä¸ª Actorï¼Œå¹¶åœ¨å¦ä¸€ä¸ª Actir åœæ­¢æ—¶å¾—åˆ°é€šçŸ¥ã€‚ä¸ç›‘ç£ä¸åŒï¼Œè§‚å¯Ÿï¼ˆwatchingï¼‰å¹¶ä¸å±€é™äºçˆ¶å­å…³ç³»ï¼Œä»»ä½• Actor åªè¦çŸ¥é“ ActorRef å°±å¯ä»¥è§‚çœ‹å…¶ä»– Actorã€‚åœ¨è¢«è§‚å¯Ÿçš„Actor åœæ­¢åï¼Œè§‚å¯Ÿè€…ä¼šæ”¶åˆ°ä¸€æ¡ Terminated(actorRef) æ¶ˆæ¯ï¼Œè¯¥æ¶ˆæ¯è¿˜åŒ…å«å¯¹è¢«è§‚å¯Ÿçš„ Actor çš„å¼•ç”¨ã€‚è§‚å¯Ÿè€…å¯ä»¥æ˜¾å¼å¤„ç†æ­¤æ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥å¤±è´¥å¹¶å‡ºç°DeathPactExceptionã€‚å¦‚æœåœ¨è¢«è§‚å¯Ÿçš„ Actor è¢«åœæ­¢åï¼Œè¯¥ Actor ä¸èƒ½å†å±¥è¡Œè‡ªå·±çš„èŒè´£ï¼Œåˆ™åè€…å¾ˆæœ‰ç”¨ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œç»„åº”è¯¥åœ¨ä¸€ä¸ªè®¾å¤‡åœæ­¢åç»§ç»­å·¥ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¤„ç†Terminated(actorRef)æ¶ˆæ¯ã€‚</p>

<p>æˆ‘ä»¬çš„è®¾å¤‡ç»„ Actor éœ€è¦åŒ…æ‹¬ä»¥ä¸‹åŠŸèƒ½ï¼š</p>

<ul>
  <li>å½“æ–°è®¾å¤‡ Actor è¢«åˆ›å»ºæ—¶å¼€å§‹è§‚å¯Ÿï¼ˆwatchingï¼‰ã€‚</li>
  <li>å½“é€šçŸ¥æŒ‡ç¤ºè®¾å¤‡å·²åœæ­¢æ—¶ï¼Œä»æ˜ å°„Map&lt;String, ActorRef&gt;ä¸­åˆ é™¤è®¾å¤‡ Actorã€‚</li>
</ul>

<p>ä¸å¹¸çš„æ˜¯ï¼ŒTerminatedçš„æ¶ˆæ¯åªåŒ…å«å­ Actor çš„ActorRefã€‚æˆ‘ä»¬éœ€è¦ Actor çš„ ID å°†å…¶ä»ç°æœ‰è®¾å¤‡åˆ°è®¾å¤‡çš„ Actor æ˜ å°„ä¸­åˆ é™¤ã€‚ä¸ºäº†èƒ½å¤Ÿè¿›è¡Œåˆ é™¤ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥å¦ä¸€ä¸ªå ä½ç¬¦Map&lt;ActorRef, String&gt;ï¼Œå®ƒå…è®¸æˆ‘ä»¬æ‰¾åˆ°ä¸ç»™å®šActorRefå¯¹åº”çš„è®¾å¤‡ IDã€‚</p>

<p>æ·»åŠ ç”¨äºæ ‡è¯† Actor çš„åŠŸèƒ½åï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DeviceGroup</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">private</span> <span class="kd">class</span> <span class="nc">DeviceTerminated</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">device</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">deviceId</span><span class="o">;</span>

    <span class="nc">DeviceTerminated</span><span class="o">(</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">device</span><span class="o">,</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">deviceId</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">device</span> <span class="o">=</span> <span class="n">device</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">groupId</span> <span class="o">=</span> <span class="n">groupId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">deviceId</span> <span class="o">=</span> <span class="n">deviceId</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span><span class="nc">String</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="n">context</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">DeviceGroup</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">groupId</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;&gt;</span> <span class="n">deviceIdToActor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

  <span class="kd">private</span> <span class="nf">DeviceGroup</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">groupId</span> <span class="o">=</span> <span class="n">groupId</span><span class="o">;</span>
    <span class="n">context</span><span class="o">.</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"DeviceGroup {} started"</span><span class="o">,</span> <span class="n">groupId</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">DeviceGroup</span> <span class="nf">onTrackDevice</span><span class="o">(</span><span class="nc">DeviceManager</span><span class="o">.</span><span class="na">RequestTrackDevice</span> <span class="n">trackMsg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">groupId</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">trackMsg</span><span class="o">.</span><span class="na">groupId</span><span class="o">))</span> <span class="o">{</span>
      <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">deviceActor</span> <span class="o">=</span> <span class="n">deviceIdToActor</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">trackMsg</span><span class="o">.</span><span class="na">deviceId</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">deviceActor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">trackMsg</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">DeviceRegistered</span><span class="o">(</span><span class="n">deviceActor</span><span class="o">));</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Creating device actor for {}"</span><span class="o">,</span> <span class="n">trackMsg</span><span class="o">.</span><span class="na">deviceId</span><span class="o">);</span>
        <span class="n">deviceActor</span> <span class="o">=</span>
            <span class="n">getContext</span><span class="o">()</span>
                <span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">groupId</span><span class="o">,</span> <span class="n">trackMsg</span><span class="o">.</span><span class="na">deviceId</span><span class="o">),</span> <span class="s">"device-"</span> <span class="o">+</span> <span class="n">trackMsg</span><span class="o">.</span><span class="na">deviceId</span><span class="o">);</span>
        <span class="n">getContext</span><span class="o">()</span>
            <span class="o">.</span><span class="na">watchWith</span><span class="o">(</span><span class="n">deviceActor</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DeviceTerminated</span><span class="o">(</span><span class="n">deviceActor</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">trackMsg</span><span class="o">.</span><span class="na">deviceId</span><span class="o">));</span>
        <span class="n">deviceIdToActor</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">trackMsg</span><span class="o">.</span><span class="na">deviceId</span><span class="o">,</span> <span class="n">deviceActor</span><span class="o">);</span>
        <span class="n">trackMsg</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">DeviceRegistered</span><span class="o">(</span><span class="n">deviceActor</span><span class="o">));</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">getContext</span><span class="o">()</span>
          <span class="o">.</span><span class="na">getLog</span><span class="o">()</span>
          <span class="o">.</span><span class="na">warn</span><span class="o">(</span>
              <span class="s">"Ignoring TrackDevice request for {}. This actor is responsible for {}."</span><span class="o">,</span>
              <span class="n">groupId</span><span class="o">,</span>
              <span class="k">this</span><span class="o">.</span><span class="na">groupId</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰åŠæ³•è·å¾—ç»„è®¾å¤‡ Actor è·Ÿè¸ªçš„è®¾å¤‡ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬è¿˜ä¸èƒ½æµ‹è¯•æˆ‘ä»¬çš„æ–°åŠŸèƒ½ã€‚ä¸ºäº†ä½¿å…¶å¯æµ‹è¯•ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªæ–°çš„æŸ¥è¯¢åŠŸèƒ½ï¼ˆæ¶ˆæ¯RequestDeviceListï¼‰ï¼Œå…¶ä¸­åˆ—å‡ºäº†å½“å‰æ´»åŠ¨çš„è®¾å¤‡ IDï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RequestDeviceList</span>
    <span class="kd">implements</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">Command</span><span class="o">,</span> <span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">Command</span> <span class="o">{</span>
  <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>
  <span class="kd">final</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">;</span>
  <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">ReplyDeviceList</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">RequestDeviceList</span><span class="o">(</span><span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">ReplyDeviceList</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">groupId</span> <span class="o">=</span> <span class="n">groupId</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ReplyDeviceList</span> <span class="o">{</span>
  <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>
  <span class="kd">final</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">ids</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">ReplyDeviceList</span><span class="o">(</span><span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">ids</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æˆ‘ä»¬å‡ ä¹å‡†å¤‡å¥½æµ‹è¯•ç§»é™¤è®¾å¤‡ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦ä»¥ä¸‹èƒ½åŠ›:</p>

<ul>
  <li>è¦ä»æˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹å¤–éƒ¨åœæ­¢è®¾å¤‡Actorï¼Œæˆ‘ä»¬å¿…é¡»å‘å®ƒå‘é€ä¸€æ¡æ¶ˆæ¯ã€‚æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé’åŒ–æ¶ˆæ¯ï¼ŒæŒ‡ç¤ºActoråœæ­¢ã€‚</li>
  <li>ä¸€æ—¦è®¾å¤‡Actoråœæ­¢ï¼Œå°±ä¼šæ”¶åˆ°é€šçŸ¥ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨æ­»äº¡çœ‹æŠ¤æ¥åšè¿™ä¸ªã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">static</span> <span class="kd">enum</span> <span class="nc">Passivate</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
  <span class="no">INSTANCE</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.Behavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.PostStop</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.AbstractBehavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.ActorContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Behaviors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Receive</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Device</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RecordTemperature</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">double</span> <span class="n">value</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">TemperatureRecorded</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">RecordTemperature</span><span class="o">(</span><span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span> <span class="kt">double</span> <span class="n">value</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">TemperatureRecorded</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TemperatureRecorded</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">TemperatureRecorded</span><span class="o">(</span><span class="kt">long</span> <span class="n">requestId</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ReadTemperature</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">RespondTemperature</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ReadTemperature</span><span class="o">(</span><span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">RespondTemperature</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RespondTemperature</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">value</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">RespondTemperature</span><span class="o">(</span><span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">static</span> <span class="kd">enum</span> <span class="nc">Passivate</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="no">INSTANCE</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span><span class="nc">String</span> <span class="n">groupId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">deviceId</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="n">context</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">Device</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">deviceId</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">lastTemperatureReading</span> <span class="o">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>

  <span class="kd">private</span> <span class="nf">Device</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">deviceId</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">groupId</span> <span class="o">=</span> <span class="n">groupId</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">deviceId</span> <span class="o">=</span> <span class="n">deviceId</span><span class="o">;</span>

    <span class="n">context</span><span class="o">.</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Device actor {}-{} started"</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">RecordTemperature</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onRecordTemperature</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">ReadTemperature</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onReadTemperature</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Passivate</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">stopped</span><span class="o">())</span>
        <span class="o">.</span><span class="na">onSignal</span><span class="o">(</span><span class="nc">PostStop</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">signal</span> <span class="o">-&gt;</span> <span class="n">onPostStop</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onRecordTemperature</span><span class="o">(</span><span class="nc">RecordTemperature</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Recorded temperature reading {} with {}"</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">value</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">requestId</span><span class="o">);</span>
    <span class="n">lastTemperatureReading</span> <span class="o">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">value</span><span class="o">);</span>
    <span class="n">r</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">TemperatureRecorded</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">requestId</span><span class="o">));</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onReadTemperature</span><span class="o">(</span><span class="nc">ReadTemperature</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">r</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">requestId</span><span class="o">,</span> <span class="n">lastTemperatureReading</span><span class="o">));</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onPostStop</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Device actor {}-{} stopped"</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">stopped</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æˆ‘ä»¬ç°åœ¨å†æ·»åŠ ä¸¤ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚åœ¨ç¬¬ä¸€ä¸ªæµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬æµ‹è¯•åœ¨æ·»åŠ äº†ä¸€äº›è®¾å¤‡ä¹‹åï¼Œæ˜¯å¦èƒ½è¿”å›æ­£ç¡®çš„ ID åˆ—è¡¨ã€‚ç¬¬äºŒä¸ªæµ‹è¯•ç”¨ä¾‹ç¡®ä¿åœ¨è®¾å¤‡ Actor åœæ­¢åæ­£ç¡®åˆ é™¤è®¾å¤‡ ID</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre></td><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testListActiveDevices</span><span class="o">()</span> <span class="o">{</span>

  <span class="c1">//åˆ›å»º test probe å¿«æ·æ–¹å¼ç”¨äºtestkit actor system, åº”è¯¥æ¥å—çš„æ¶ˆæ¯ç±»å‹ä¸ºDeviceRegistered</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">DeviceRegistered</span><span class="o">&gt;</span> <span class="n">registeredProbe</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">DeviceRegistered</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="c1">//testKit</span>
  <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">groupActor</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">"group"</span><span class="o">));</span>

  <span class="n">groupActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="s">"group"</span><span class="o">,</span> <span class="s">"device1"</span><span class="o">,</span> <span class="n">registeredProbe</span><span class="o">.</span><span class="na">getRef</span><span class="o">()));</span>
  <span class="n">registeredProbe</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">();</span>

  <span class="n">groupActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="s">"group"</span><span class="o">,</span> <span class="s">"device2"</span><span class="o">,</span> <span class="n">registeredProbe</span><span class="o">.</span><span class="na">getRef</span><span class="o">()));</span>
  <span class="n">registeredProbe</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">();</span>

  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">ReplyDeviceList</span><span class="o">&gt;</span> <span class="n">deviceListProbe</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">ReplyDeviceList</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

  <span class="n">groupActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">RequestDeviceList</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="s">"group"</span><span class="o">,</span> <span class="n">deviceListProbe</span><span class="o">.</span><span class="na">getRef</span><span class="o">()));</span>
  <span class="nc">ReplyDeviceList</span> <span class="n">reply</span> <span class="o">=</span> <span class="n">deviceListProbe</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">();</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="n">reply</span><span class="o">.</span><span class="na">requestId</span><span class="o">);</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"device1"</span><span class="o">,</span> <span class="s">"device2"</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toSet</span><span class="o">()),</span> <span class="n">reply</span><span class="o">.</span><span class="na">ids</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testListActiveDevicesAfterOneShutsDown</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">DeviceRegistered</span><span class="o">&gt;</span> <span class="n">registeredProbe</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">DeviceRegistered</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">groupActor</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">"group"</span><span class="o">));</span>

  <span class="n">groupActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="s">"group"</span><span class="o">,</span> <span class="s">"device1"</span><span class="o">,</span> <span class="n">registeredProbe</span><span class="o">.</span><span class="na">getRef</span><span class="o">()));</span>
  <span class="nc">DeviceRegistered</span> <span class="n">registered1</span> <span class="o">=</span> <span class="n">registeredProbe</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">();</span>

  <span class="n">groupActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="s">"group"</span><span class="o">,</span> <span class="s">"device2"</span><span class="o">,</span> <span class="n">registeredProbe</span><span class="o">.</span><span class="na">getRef</span><span class="o">()));</span>
  <span class="nc">DeviceRegistered</span> <span class="n">registered2</span> <span class="o">=</span> <span class="n">registeredProbe</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">();</span>

  <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">toShutDown</span> <span class="o">=</span> <span class="n">registered1</span><span class="o">.</span><span class="na">device</span><span class="o">;</span>

  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">ReplyDeviceList</span><span class="o">&gt;</span> <span class="n">deviceListProbe</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">ReplyDeviceList</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

  <span class="n">groupActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">RequestDeviceList</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="s">"group"</span><span class="o">,</span> <span class="n">deviceListProbe</span><span class="o">.</span><span class="na">getRef</span><span class="o">()));</span>
  <span class="nc">ReplyDeviceList</span> <span class="n">reply</span> <span class="o">=</span> <span class="n">deviceListProbe</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">();</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="n">reply</span><span class="o">.</span><span class="na">requestId</span><span class="o">);</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"device1"</span><span class="o">,</span> <span class="s">"device2"</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toSet</span><span class="o">()),</span> <span class="n">reply</span><span class="o">.</span><span class="na">ids</span><span class="o">);</span>

  <span class="n">toShutDown</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">Passivate</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>
  <span class="n">registeredProbe</span><span class="o">.</span><span class="na">expectTerminated</span><span class="o">(</span><span class="n">toShutDown</span><span class="o">,</span> <span class="n">registeredProbe</span><span class="o">.</span><span class="na">getRemainingOrDefault</span><span class="o">());</span>

  <span class="c1">// using awaitAssert to retry because it might take longer for the groupActor</span>
  <span class="c1">// to see the Terminated, that order is undefined</span>
  <span class="n">registeredProbe</span><span class="o">.</span><span class="na">awaitAssert</span><span class="o">(</span>
      <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">groupActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">RequestDeviceList</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="s">"group"</span><span class="o">,</span> <span class="n">deviceListProbe</span><span class="o">.</span><span class="na">getRef</span><span class="o">()));</span>
        <span class="nc">ReplyDeviceList</span> <span class="n">r</span> <span class="o">=</span> <span class="n">deviceListProbe</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">();</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">requestId</span><span class="o">);</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"device2"</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toSet</span><span class="o">()),</span> <span class="n">r</span><span class="o">.</span><span class="na">ids</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
      <span class="o">});</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="236-åˆ›å»ºè®¾å¤‡ç®¡ç†å™¨-actor">2.3.6. åˆ›å»ºè®¾å¤‡ç®¡ç†å™¨ Actor</h3>

<p>åœ¨æˆ‘ä»¬çš„å±‚æ¬¡ç»“æ„ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åœ¨DeviceManageræºæ–‡ä»¶ä¸­ä¸ºè®¾å¤‡ç®¡ç†å™¨ç»„ä»¶åˆ›å»ºå…¥å£ç‚¹ã€‚æ­¤ Actor ä¸è®¾å¤‡ç»„ Actor éå¸¸ç›¸ä¼¼ï¼Œä½†åˆ›å»ºçš„æ˜¯è®¾å¤‡ç»„ Actor è€Œä¸æ˜¯è®¾å¤‡ Actorï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DeviceManager</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">DeviceManager</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RequestTrackDevice</span>
      <span class="kd">implements</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">Command</span><span class="o">,</span> <span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">Command</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">deviceId</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">DeviceRegistered</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">RequestTrackDevice</span><span class="o">(</span><span class="nc">String</span> <span class="n">groupId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">deviceId</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">DeviceRegistered</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">groupId</span> <span class="o">=</span> <span class="n">groupId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">deviceId</span> <span class="o">=</span> <span class="n">deviceId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">DeviceRegistered</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">device</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">DeviceRegistered</span><span class="o">(</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">device</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">device</span> <span class="o">=</span> <span class="n">device</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RequestDeviceList</span>
      <span class="kd">implements</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">Command</span><span class="o">,</span> <span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">Command</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">ReplyDeviceList</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">RequestDeviceList</span><span class="o">(</span><span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">ReplyDeviceList</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">groupId</span> <span class="o">=</span> <span class="n">groupId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ReplyDeviceList</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">ids</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ReplyDeviceList</span><span class="o">(</span><span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">ids</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DeviceGroupTerminated</span> <span class="kd">implements</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">Command</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">;</span>

    <span class="nc">DeviceGroupTerminated</span><span class="o">(</span><span class="nc">String</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">groupId</span> <span class="o">=</span> <span class="n">groupId</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">DeviceManager:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;&gt;</span> <span class="n">groupIdToActor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

  <span class="kd">private</span> <span class="nf">DeviceManager</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="n">context</span><span class="o">.</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"DeviceManager started"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">DeviceManager</span> <span class="nf">onTrackDevice</span><span class="o">(</span><span class="nc">RequestTrackDevice</span> <span class="n">trackMsg</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">groupId</span> <span class="o">=</span> <span class="n">trackMsg</span><span class="o">.</span><span class="na">groupId</span><span class="o">;</span>
    <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">groupIdToActor</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">groupId</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">ref</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">trackMsg</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Creating device group actor for {}"</span><span class="o">,</span> <span class="n">groupId</span><span class="o">);</span>
      <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">groupActor</span> <span class="o">=</span>
          <span class="n">getContext</span><span class="o">().</span><span class="na">spawn</span><span class="o">(</span><span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">groupId</span><span class="o">),</span> <span class="s">"group-"</span> <span class="o">+</span> <span class="n">groupId</span><span class="o">);</span>
      <span class="n">getContext</span><span class="o">().</span><span class="na">watchWith</span><span class="o">(</span><span class="n">groupActor</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DeviceGroupTerminated</span><span class="o">(</span><span class="n">groupId</span><span class="o">));</span>
      <span class="n">groupActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">trackMsg</span><span class="o">);</span>
      <span class="n">groupIdToActor</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">groupId</span><span class="o">,</span> <span class="n">groupActor</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">DeviceManager</span> <span class="nf">onRequestDeviceList</span><span class="o">(</span><span class="nc">RequestDeviceList</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">groupIdToActor</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">groupId</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">ref</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">request</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">ReplyDeviceList</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">requestId</span><span class="o">,</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">emptySet</span><span class="o">()));</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">DeviceManager</span> <span class="nf">onTerminated</span><span class="o">(</span><span class="nc">DeviceGroupTerminated</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Device group actor for {} has been terminated"</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">groupId</span><span class="o">);</span>
    <span class="n">groupIdToActor</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">groupId</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">RequestTrackDevice</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onTrackDevice</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">RequestDeviceList</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onRequestDeviceList</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">DeviceGroupTerminated</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onTerminated</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onSignal</span><span class="o">(</span><span class="nc">PostStop</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">signal</span> <span class="o">-&gt;</span> <span class="n">onPostStop</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">DeviceManager</span> <span class="nf">onPostStop</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"DeviceManager stopped"</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æˆ‘ä»¬å°†è®¾å¤‡ç®¡ç†å™¨çš„æµ‹è¯•ç•™ç»™ä½ ä½œä¸ºç»ƒä¹ ï¼Œå› ä¸ºå®ƒä¸æˆ‘ä»¬ä¸ºè®¾å¤‡ç»„ Actor ç¼–å†™çš„æµ‹è¯•éå¸¸ç›¸ä¼¼ã€‚</p>

<h4 id="2361-ä¸‹ä¸€æ­¥åšä»€ä¹ˆ">2.3.6.1. ä¸‹ä¸€æ­¥åšä»€ä¹ˆ</h4>

<p>æˆ‘ä»¬ç°åœ¨æœ‰äº†ä¸€ä¸ªç”¨äºæ³¨å†Œå’Œè·Ÿè¸ªè®¾å¤‡ä»¥åŠè®°å½•æµ‹é‡å€¼çš„åˆ†å±‚ç»„ä»¶ã€‚æˆ‘ä»¬å·²ç»äº†è§£äº†å¦‚ä½•å®ç°ä¸åŒç±»å‹çš„å¯¹è¯æ¨¡å¼ï¼Œä¾‹å¦‚ï¼š</p>

<ul>
  <li>è¯·æ±‚å“åº”ï¼ˆRequest-respondï¼‰ï¼Œç”¨äºæ¸©åº¦è®°å½•ã€‚</li>
  <li>ä»£ç†å“åº”ï¼ˆDelegate-respondï¼‰ï¼Œç”¨äºè®¾å¤‡æ³¨å†Œã€‚</li>
  <li>åˆ›å»ºç›‘è§†ç»ˆæ­¢ï¼ˆCreate-watch-terminateï¼‰ï¼Œç”¨äºå°†ç»„å’Œè®¾å¤‡ Actor åˆ›å»ºä¸ºå­çº§ã€‚</li>
</ul>

<p>åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»ç»„æŸ¥è¯¢åŠŸèƒ½ï¼Œè¿™å°†å»ºç«‹ä¸€ç§æ–°çš„åˆ†æ•£æ”¶é›†ï¼ˆscatter-gatherï¼‰å¯¹è¯æ¨¡å¼ã€‚ç‰¹åˆ«åœ°ï¼Œæˆ‘ä»¬å°†å®ç°å…è®¸ç”¨æˆ·æŸ¥è¯¢å±äºä¸€ä¸ªç»„çš„æ‰€æœ‰è®¾å¤‡çš„çŠ¶æ€çš„åŠŸèƒ½ã€‚</p>

<h3 id="237-æŸ¥è¯¢è®¾å¤‡ç»„">2.3.7. æŸ¥è¯¢è®¾å¤‡ç»„</h3>

<h4 id="2371-ç®€ä»‹">2.3.7.1. ç®€ä»‹</h4>

<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬æ‰€çœ‹åˆ°çš„å¯¹è¯æ¨¡å¼å¾ˆç®€å•ï¼Œå› ä¸ºå®ƒä»¬è¦æ±‚ Actor ä¿æŒå¾ˆå°‘æˆ–æ ¹æœ¬å°±æ²¡æœ‰çŠ¶æ€ã€‚æ˜ç¡®åœ°ï¼š</p>

<ul>
  <li>è®¾å¤‡ Actor è¿”å›ä¸€ä¸ªä¸éœ€è¦çŠ¶æ€æ›´æ”¹çš„è¯»å–</li>
  <li>è®°å½•æ¸©åº¦ï¼Œæ›´æ–°å•ä¸ªå­—æ®µ</li>
  <li>è®¾å¤‡ç»„ Actor é€šè¿‡æ·»åŠ æˆ–åˆ é™¤æ˜ å°„ä¸­çš„æ¡ç›®æ¥ç»´æŠ¤ç»„æˆå‘˜èº«ä»½</li>
</ul>

<p>åœ¨æœ¬éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªæ›´å¤æ‚çš„ç¤ºä¾‹ã€‚ç”±äºæˆ¿ä¸»ä¼šå¯¹æ•´ä¸ªå®¶åº­çš„æ¸©åº¦æ„Ÿå…´è¶£ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯èƒ½å¤ŸæŸ¥è¯¢ä¸€ä¸ªç»„ä¸­çš„æ‰€æœ‰è®¾å¤‡ Actorã€‚è®©æˆ‘ä»¬å…ˆç ”ç©¶ä¸€ä¸‹è¿™æ ·çš„æŸ¥è¯¢ API åº”è¯¥å¦‚ä½•å·¥ä½œã€‚</p>

<h4 id="2372-å¤„ç†å¯èƒ½çš„æƒ…å†µ">2.3.7.2. å¤„ç†å¯èƒ½çš„æƒ…å†µ</h4>

<p>æˆ‘ä»¬é¢ä¸´çš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œä¸€ä¸ªç»„çš„æˆå‘˜æ˜¯åŠ¨æ€çš„ã€‚æ¯ä¸ªä¼ æ„Ÿå™¨è®¾å¤‡éƒ½ç”±ä¸€ä¸ªå¯ä»¥éšæ—¶åœæ­¢çš„ Actor è¡¨ç¤ºã€‚åœ¨æŸ¥è¯¢å¼€å§‹æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è¯¢é—®æ‰€æœ‰ç°æœ‰è®¾å¤‡ Actor å½“å‰çš„æ¸©åº¦ã€‚ä½†æ˜¯ï¼Œåœ¨æŸ¥è¯¢çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼š</p>

<ul>
  <li>è®¾å¤‡ Actor å¯èƒ½ä¼šåœæ­¢å·¥ä½œï¼Œæ— æ³•ç”¨æ¸©åº¦è¯»æ•°åšå‡ºå“åº”ã€‚</li>
  <li>ä¸€ä¸ªæ–°çš„è®¾å¤‡ Actor å¯èƒ½ä¼šå¯åŠ¨ï¼Œå¹¶ä¸”ä¸ä¼šåŒ…å«åœ¨æŸ¥è¯¢ä¸­ï¼Œå› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“å®ƒã€‚</li>
</ul>

<p>è¿™äº›é—®é¢˜å¯ä»¥ç”¨è®¸å¤šä¸åŒçš„æ–¹å¼æ¥è§£å†³ï¼Œä½†é‡è¦çš„æ˜¯è¦è§£å†³æ‰€æœŸæœ›çš„è¡Œä¸ºã€‚ä»¥ä¸‹å·¥ä½œå¯¹äºæˆ‘ä»¬çš„ç”¨ä¾‹æ˜¯å¾ˆæœ‰ç”¨çš„ï¼š</p>

<ul>
  <li>å½“æŸ¥è¯¢åˆ°è¾¾æ—¶ï¼Œç»„ Actor å°†è·å–ç°æœ‰è®¾å¤‡ Actor çš„å¿«ç…§ï¼ˆsnapshotï¼‰ï¼Œå¹¶ä¸”åªå‘è¿™äº› Actor è¯¢é—®æ¸©åº¦ã€‚</li>
  <li>æŸ¥è¯¢åˆ°è¾¾åå¯åŠ¨çš„ Actor å¯ä»¥è¢«å¿½ç•¥ã€‚</li>
  <li>å¦‚æœå¿«ç…§ä¸­çš„æŸä¸ª Actor åœ¨æŸ¥è¯¢æœŸé—´åœæ­¢è€Œæ²¡æœ‰åº”ç­”ï¼Œæˆ‘ä»¬å°†å‘æŸ¥è¯¢æ¶ˆæ¯çš„å‘é€è€…æŠ¥å‘Šå®ƒåœæ­¢çš„äº‹å®ã€‚</li>
</ul>

<p>é™¤äº†è®¾å¤‡ Actor åŠ¨æ€åœ°å˜åŒ–ä¹‹å¤–ï¼Œä¸€äº› Actor å¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´æ¥å“åº”ã€‚ä¾‹å¦‚ï¼Œå®ƒä»¬å¯èƒ½è¢«å›°åœ¨ä¸€ä¸ªæ„å¤–çš„æ— é™å¾ªç¯ä¸­ï¼Œæˆ–è€…ç”±äºä¸€ä¸ª bug è€Œå¤±è´¥ï¼Œå¹¶æ”¾å¼ƒæˆ‘ä»¬çš„è¯·æ±‚ã€‚æˆ‘ä»¬ä¸å¸Œæœ›æŸ¥è¯¢æ— é™æœŸåœ°ç»§ç»­ï¼Œå› æ­¤åœ¨ä»¥ä¸‹ä»»ä½•ä¸€ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½ä¼šè®¤ä¸ºå®ƒæ˜¯å®Œæˆçš„ï¼š</p>

<ul>
  <li>å¿«ç…§ä¸­çš„æ‰€æœ‰ Actor è¦ä¹ˆå·²å“åº”ï¼Œè¦ä¹ˆç¡®è®¤å·²åœæ­¢ã€‚</li>
  <li>æˆ‘ä»¬è¾¾åˆ°äº†é¢„å®šçš„ï¼ˆpre-definedï¼‰æœ€åæœŸé™ã€‚</li>
</ul>

<p>è€ƒè™‘åˆ°è¿™äº›å†³å®šï¼Œå†åŠ ä¸Šå¿«ç…§ä¸­çš„è®¾å¤‡å¯èƒ½åˆšåˆšå¯åŠ¨ä½†å°šæœªæ¥æ”¶åˆ°è¦è®°å½•çš„æ¸©åº¦ï¼Œæˆ‘ä»¬å¯ä»¥é’ˆå¯¹æ¸©åº¦æŸ¥è¯¢ä¸ºæ¯ä¸ªè®¾å¤‡ Actor å®šä¹‰å››ç§çŠ¶æ€ï¼š</p>

<ul>
  <li>å®ƒæœ‰ä¸€ä¸ªå¯ç”¨çš„æ¸©åº¦ï¼šTemperatureã€‚</li>
  <li>å®ƒå·²ç»å“åº”ï¼Œä½†è¿˜æ²¡æœ‰å¯ç”¨çš„æ¸©åº¦ï¼šTemperatureNotAvailableã€‚</li>
  <li>å®ƒåœ¨å“åº”ä¹‹å‰å·²åœæ­¢ï¼šDeviceNotAvailableã€‚</li>
  <li>å®ƒåœ¨æœ€åæœŸé™ä¹‹å‰æ²¡æœ‰å“åº”ï¼šDeviceTimedOutã€‚</li>
</ul>

<p>åœ¨æ¶ˆæ¯ç±»å‹ä¸­æ±‡æ€»è¿™äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°DeviceGroupï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RequestAllTemperatures</span>
    <span class="kd">implements</span> <span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">Command</span><span class="o">,</span> <span class="nc">DeviceGroup</span><span class="o">.</span><span class="na">Command</span><span class="o">,</span> <span class="nc">Command</span> <span class="o">{</span>

  <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>
  <span class="kd">final</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">;</span>
  <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">RespondAllTemperatures</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">RequestAllTemperatures</span><span class="o">(</span>
      <span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">groupId</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">RespondAllTemperatures</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">groupId</span> <span class="o">=</span> <span class="n">groupId</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RespondAllTemperatures</span> <span class="o">{</span>
  <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>
  <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">TemperatureReading</span><span class="o">&gt;</span> <span class="n">temperatures</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">RespondAllTemperatures</span><span class="o">(</span><span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">TemperatureReading</span><span class="o">&gt;</span> <span class="n">temperatures</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">temperatures</span> <span class="o">=</span> <span class="n">temperatures</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TemperatureReading</span> <span class="o">{}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Temperature</span> <span class="kd">implements</span> <span class="nc">TemperatureReading</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="kt">double</span> <span class="n">value</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Temperature</span><span class="o">(</span><span class="kt">double</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">o</span><span class="o">)</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">getClass</span><span class="o">()</span> <span class="o">!=</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

    <span class="nc">Temperature</span> <span class="n">that</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Temperature</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>

    <span class="k">return</span> <span class="nc">Double</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="n">that</span><span class="o">.</span><span class="na">value</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">long</span> <span class="n">temp</span> <span class="o">=</span> <span class="nc">Double</span><span class="o">.</span><span class="na">doubleToLongBits</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
    <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">temp</span> <span class="o">^</span> <span class="o">(</span><span class="n">temp</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">32</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s">"Temperature{"</span> <span class="o">+</span> <span class="s">"value="</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="sc">'}'</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">enum</span> <span class="nc">TemperatureNotAvailable</span> <span class="kd">implements</span> <span class="nc">TemperatureReading</span> <span class="o">{</span>
  <span class="no">INSTANCE</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">enum</span> <span class="nc">DeviceNotAvailable</span> <span class="kd">implements</span> <span class="nc">TemperatureReading</span> <span class="o">{</span>
  <span class="no">INSTANCE</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">enum</span> <span class="nc">DeviceTimedOut</span> <span class="kd">implements</span> <span class="nc">TemperatureReading</span> <span class="o">{</span>
  <span class="no">INSTANCE</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="2373-å®ç°æŸ¥è¯¢åŠŸèƒ½">2.3.7.3. å®ç°æŸ¥è¯¢åŠŸèƒ½</h4>

<p>å®ç°æŸ¥è¯¢çš„ä¸€ç§æ–¹æ³•æ˜¯å‘ç»„è®¾å¤‡ Actor æ·»åŠ ä»£ç ã€‚ç„¶è€Œï¼Œåœ¨å®è·µä¸­ï¼Œè¿™å¯èƒ½éå¸¸éº»çƒ¦å¹¶ä¸”å®¹æ˜“å‡ºé”™ã€‚è¯·è®°ä½ï¼Œå½“æˆ‘ä»¬å¯åŠ¨æŸ¥è¯¢æ—¶ï¼Œæˆ‘ä»¬éœ€è¦è·å–å½“å‰è®¾å¤‡çš„å¿«ç…§å¹¶å¯åŠ¨è®¡æ—¶å™¨ï¼Œä»¥ä¾¿å¼ºåˆ¶æ‰§è¡Œæˆªæ­¢æ—¶é—´ã€‚åŒæ—¶ï¼Œå¦ä¸€ä¸ªæŸ¥è¯¢å¯ä»¥åˆ°è¾¾ã€‚å¯¹äºç¬¬äºŒä¸ªæŸ¥è¯¢ï¼Œæˆ‘ä»¬éœ€è¦è·Ÿè¸ªå®Œå…¨ç›¸åŒçš„ä¿¡æ¯ï¼Œä½†ä¸å‰ä¸€ä¸ªæŸ¥è¯¢éš”ç¦»ã€‚è¿™å°†è¦æ±‚æˆ‘ä»¬åœ¨æŸ¥è¯¢å’Œè®¾å¤‡ Actor ä¹‹é—´ç»´æŠ¤å•ç‹¬çš„æ˜ å°„ã€‚</p>

<p>ç›¸åï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ç§æ›´ç®€å•ã€æ›´ä¼˜é›…çš„æ–¹æ³•ã€‚æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªè¡¨ç¤ºå•ä¸ªæŸ¥è¯¢çš„ Actorï¼Œå¹¶ä»£è¡¨ç»„ Actor æ‰§è¡Œå®ŒæˆæŸ¥è¯¢æ‰€éœ€çš„ä»»åŠ¡ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»åˆ›å»ºäº†å±äºå…¸å‹åŸŸå¯¹è±¡ï¼ˆclassical domainï¼‰çš„ Actorï¼Œä½†æ˜¯ç°åœ¨ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªè¡¨ç¤ºæµç¨‹æˆ–ä»»åŠ¡è€Œä¸æ˜¯å®ä½“çš„ Actorã€‚æˆ‘ä»¬é€šè¿‡ä¿æŒæˆ‘ä»¬çš„ç»„è®¾å¤‡ Actor ç®€å•å’Œèƒ½å¤Ÿæ›´å¥½åœ°éš”ç¦»æµ‹è¯•æŸ¥è¯¢åŠŸèƒ½è€Œå—ç›Šã€‚</p>

<h5 id="23731-å®šä¹‰æŸ¥è¯¢-actor">2.3.7.3.1. å®šä¹‰æŸ¥è¯¢ Actor</h5>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è®¾è®¡æŸ¥è¯¢ Actor çš„ç”Ÿå‘½å‘¨æœŸã€‚è¿™åŒ…æ‹¬è¯†åˆ«å…¶åˆå§‹çŠ¶æ€ã€å°†è¦é‡‡å–çš„ç¬¬ä¸€ä¸ªæ“ä½œä»¥åŠæ¸…é™¤ï¼ˆå¦‚æœéœ€è¦ï¼‰ã€‚æŸ¥è¯¢ Actor éœ€è¦ä»¥ä¸‹ä¿¡æ¯ï¼š</p>

<ul>
  <li>è¦æŸ¥è¯¢çš„æ´»åŠ¨è®¾å¤‡ Actor çš„å¿«ç…§å’Œ IDã€‚</li>
  <li>å¯åŠ¨æŸ¥è¯¢çš„è¯·æ±‚çš„ IDï¼ˆä»¥ä¾¿æˆ‘ä»¬å¯ä»¥åœ¨å“åº”ä¸­åŒ…å«å®ƒï¼‰ã€‚</li>
  <li>å‘é€æŸ¥è¯¢çš„ Actor çš„å¼•ç”¨ã€‚æˆ‘ä»¬ä¼šç›´æ¥ç»™è¿™ä¸ª Actor å“åº”ã€‚</li>
  <li>æŒ‡ç¤ºæŸ¥è¯¢ç­‰å¾…å“åº”çš„æœŸé™ã€‚å°†å…¶ä½œä¸ºå‚æ•°å°†ç®€åŒ–æµ‹è¯•ã€‚</li>
</ul>

<h5 id="23732-è®¾ç½®æŸ¥è¯¢è¶…æ—¶">2.3.7.3.2. è®¾ç½®æŸ¥è¯¢è¶…æ—¶</h5>

<p>ç”±äºæˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥æŒ‡ç¤ºæˆ‘ä»¬æ„¿æ„ç­‰å¾…å“åº”çš„æ—¶é—´ï¼Œç°åœ¨æ˜¯æ—¶å€™å¼•å…¥ä¸€ä¸ªæˆ‘ä»¬è¿˜æ²¡æœ‰ä½¿ç”¨çš„æ–°çš„ Akka ç‰¹æ€§ï¼Œå³å†…ç½®çš„è°ƒåº¦å™¨ï¼ˆbuilt-in schedulerï¼‰åŠŸèƒ½äº†ã€‚ä½¿ç”¨è°ƒåº¦å™¨ï¼ˆschedulerï¼‰å¾ˆç®€å•ï¼š</p>

<ul>
  <li>æˆ‘ä»¬å¯ä»¥ä»ActorSystemä¸­è·å–è°ƒåº¦å™¨ï¼Œè€ŒActorSystemåˆå¯ä»¥ä» Actor çš„ä¸Šä¸‹æ–‡ä¸­è®¿é—®ï¼šgetContext().getSystem().scheduler()ã€‚è¿™éœ€è¦ä¸€ä¸ªExecutionContextï¼Œå®ƒæ˜¯å°†æ‰§è¡Œè®¡æ—¶å™¨ä»»åŠ¡æœ¬èº«çš„çº¿ç¨‹æ± ã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä¼ å…¥getContext().dispatcher()æ¥ä½¿ç”¨ä¸ Actor ç›¸åŒçš„è°ƒåº¦å™¨ã€‚</li>
  <li>scheduler.scheduleOnce(time, actorRef, message, executor, sender)æ–¹æ³•å°†åœ¨æŒ‡å®šçš„timeå°†æ¶ˆæ¯messageè°ƒåº¦åˆ°Futureï¼Œå¹¶å°†å…¶å‘é€ç»™ Actor çš„ActorRefã€‚</li>
</ul>

<p>æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªè¡¨ç¤ºæŸ¥è¯¢è¶…æ—¶çš„æ¶ˆæ¯ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ²¡æœ‰ä»»ä½•å‚æ•°çš„ç®€å•æ¶ˆæ¯CollectionTimeoutã€‚scheduleOnceçš„è¿”å›å€¼æ˜¯Cancellableï¼Œå¦‚æœæŸ¥è¯¢åŠæ—¶æˆåŠŸå®Œæˆï¼Œå¯ä»¥ä½¿ç”¨å®ƒå–æ¶ˆå®šæ—¶å™¨ã€‚åœ¨æŸ¥è¯¢å¼€å§‹æ—¶ï¼Œæˆ‘ä»¬éœ€è¦è¯¢é—®æ¯ä¸ªè®¾å¤‡ Actor å½“å‰çš„æ¸©åº¦ã€‚ä¸ºäº†èƒ½å¤Ÿå¿«é€Ÿæ£€æµ‹é‚£äº›åœ¨ReadTemperatureä¿¡æ¯ä¹‹å‰åœæ­¢çš„è®¾å¤‡ï¼Œæˆ‘ä»¬è¿˜å°†è§‚å¯Ÿæ¯ä¸ª Actorã€‚è¿™æ ·ï¼Œå¯¹äºé‚£äº›åœ¨æŸ¥è¯¢ç”Ÿå‘½å‘¨æœŸä¸­åœæ­¢çš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°Terminatedæ¶ˆæ¯ï¼Œå› æ­¤æˆ‘ä»¬ä¸éœ€è¦ç­‰åˆ°è¶…æ—¶æ—¶å†å°†è¿™äº›æ¶ˆæ¯æ ‡è®°ä¸ºä¸å¯ç”¨ã€‚</p>

<p>ç»¼ä¸Šæ‰€è¿°ï¼ŒDeviceGroupQuery Actor çš„ä»£ç å¤§è‡´å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DeviceGroupQuery</span> <span class="kd">extends</span> <span class="nc">AbstractActor</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">CollectionTimeout</span> <span class="o">{</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">LoggingAdapter</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">Logging</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">getContext</span><span class="o">().</span><span class="na">getSystem</span><span class="o">(),</span> <span class="k">this</span><span class="o">);</span>

  <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">ActorRef</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">actorToDeviceId</span><span class="o">;</span>
  <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>
  <span class="kd">final</span> <span class="nc">ActorRef</span> <span class="n">requester</span><span class="o">;</span>

  <span class="nc">Cancellable</span> <span class="n">queryTimeoutTimer</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">DeviceGroupQuery</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">ActorRef</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">actorToDeviceId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span> <span class="nc">ActorRef</span> <span class="n">requester</span><span class="o">,</span> <span class="nc">FiniteDuration</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">actorToDeviceId</span> <span class="o">=</span> <span class="n">actorToDeviceId</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">requester</span> <span class="o">=</span> <span class="n">requester</span><span class="o">;</span>

    <span class="n">queryTimeoutTimer</span> <span class="o">=</span> <span class="n">getContext</span><span class="o">().</span><span class="na">getSystem</span><span class="o">().</span><span class="na">scheduler</span><span class="o">().</span><span class="na">scheduleOnce</span><span class="o">(</span>
            <span class="n">timeout</span><span class="o">,</span> <span class="n">getSelf</span><span class="o">(),</span> <span class="k">new</span> <span class="nc">CollectionTimeout</span><span class="o">(),</span> <span class="n">getContext</span><span class="o">().</span><span class="na">dispatcher</span><span class="o">(),</span> <span class="n">getSelf</span><span class="o">()</span>
    <span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Props</span> <span class="nf">props</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">ActorRef</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">actorToDeviceId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span> <span class="nc">ActorRef</span> <span class="n">requester</span><span class="o">,</span> <span class="nc">FiniteDuration</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Props</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">DeviceGroupQuery</span><span class="o">(</span><span class="n">actorToDeviceId</span><span class="o">,</span> <span class="n">requestId</span><span class="o">,</span> <span class="n">requester</span><span class="o">,</span> <span class="n">timeout</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">preStart</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">ActorRef</span> <span class="n">deviceActor</span> <span class="o">:</span> <span class="n">actorToDeviceId</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">getContext</span><span class="o">().</span><span class="na">watch</span><span class="o">(</span><span class="n">deviceActor</span><span class="o">);</span>
      <span class="n">deviceActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Device</span><span class="o">.</span><span class="na">ReadTemperature</span><span class="o">(</span><span class="mi">0L</span><span class="o">),</span> <span class="n">getSelf</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">postStop</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">queryTimeoutTimer</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h5 id="23733-è·Ÿè¸ª-actor-çŠ¶æ€">2.3.7.3.3. è·Ÿè¸ª Actor çŠ¶æ€</h5>

<p>é™¤äº†æŒ‚èµ·çš„è®¡æ—¶å™¨ä¹‹å¤–ï¼ŒæŸ¥è¯¢actorè¿˜æœ‰ä¸€ä¸ªæœ‰çŠ¶æ€çš„æ–¹é¢ï¼Œå³è·Ÿè¸ªå·²å“åº”ã€å·²åœæ­¢æˆ–æœªå“åº”çš„actoré›†ã€‚æˆ‘ä»¬åœ¨actorä¸­çš„å¯å˜HashMapä¸­è·Ÿè¸ªæ­¤çŠ¶æ€ã€‚</p>

<p>å¯¹äºæˆ‘ä»¬çš„ç”¨ä¾‹:</p>

<ol>
  <li>æˆ‘ä»¬è·Ÿè¸ªçŠ¶æ€
    <blockquote>
      <ul>
        <li>ç”¨ä¸€ä¸ªMapæ”¶é›†å·²ç»æ”¶åˆ°å›å¤çš„Actor</li>
        <li>ç”¨ä¸€ä¸ªSetæ”¶é›†æˆ‘ä»¬ä»åœ¨ç­‰å¾…çš„Actor</li>
      </ul>
    </blockquote>
  </li>
  <li>æˆ‘ä»¬æœ‰ä¸‰ä»¶äº‹è¦åš
    <blockquote>
      <ul>
        <li>æˆ‘ä»¬å¯ä»¥ä»å…¶ä¸­ä¸€ä¸ªè®¾å¤‡æ¥æ”¶åˆ° RespondTemperature ä¿¡æ¯ã€‚</li>
        <li>æˆ‘ä»¬å¯ä»¥æ”¶åˆ°ä¸€ä¸ªDeviceTerminatedæ¶ˆæ¯çš„è®¾å¤‡Actorå·²ç»åœæ­¢åœ¨æ­¤æœŸé—´ã€‚</li>
        <li>æˆ‘ä»¬å¯ä»¥åœ¨æˆªæ­¢æ—¥æœŸå‰æ”¶åˆ° CollectionTimeoutã€‚</li>
      </ul>
    </blockquote>
  </li>
</ol>

<p>è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæ·»åŠ ä»¥ä¸‹åˆ°æ‚¨çš„DeviceGroupQueryæºæ–‡ä»¶:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">TemperatureReading</span><span class="o">&gt;</span> <span class="n">repliesSoFar</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">stillWaiting</span><span class="o">;</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
      <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">WrappedRespondTemperature</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onRespondTemperature</span><span class="o">)</span>
      <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">DeviceTerminated</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onDeviceTerminated</span><span class="o">)</span>
      <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">CollectionTimeout</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onCollectionTimeout</span><span class="o">)</span>
      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onRespondTemperature</span><span class="o">(</span><span class="nc">WrappedRespondTemperature</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">TemperatureReading</span> <span class="n">reading</span> <span class="o">=</span>
      <span class="n">r</span><span class="o">.</span><span class="na">response</span>
          <span class="o">.</span><span class="na">value</span>
          <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">v</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nc">DeviceManager</span><span class="o">.</span><span class="na">TemperatureReading</span><span class="o">)</span> <span class="k">new</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">Temperature</span><span class="o">(</span><span class="n">v</span><span class="o">))</span>
          <span class="o">.</span><span class="na">orElse</span><span class="o">(</span><span class="nc">DeviceManager</span><span class="o">.</span><span class="na">TemperatureNotAvailable</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>

  <span class="nc">String</span> <span class="n">deviceId</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">response</span><span class="o">.</span><span class="na">deviceId</span><span class="o">;</span>
  <span class="n">repliesSoFar</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">deviceId</span><span class="o">,</span> <span class="n">reading</span><span class="o">);</span>
  <span class="n">stillWaiting</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">deviceId</span><span class="o">);</span>

  <span class="k">return</span> <span class="nf">respondWhenAllCollected</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onDeviceTerminated</span><span class="o">(</span><span class="nc">DeviceTerminated</span> <span class="n">terminated</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">stillWaiting</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">terminated</span><span class="o">.</span><span class="na">deviceId</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">repliesSoFar</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">terminated</span><span class="o">.</span><span class="na">deviceId</span><span class="o">,</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">DeviceNotAvailable</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>
    <span class="n">stillWaiting</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">terminated</span><span class="o">.</span><span class="na">deviceId</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="nf">respondWhenAllCollected</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onCollectionTimeout</span><span class="o">(</span><span class="nc">CollectionTimeout</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">deviceId</span> <span class="o">:</span> <span class="n">stillWaiting</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">repliesSoFar</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">deviceId</span><span class="o">,</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">DeviceTimedOut</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="n">stillWaiting</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
  <span class="k">return</span> <span class="nf">respondWhenAllCollected</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯¹äºRespondTemperatureå’ŒDeviceTerminatedï¼Œæˆ‘ä»¬é€šè¿‡æ›´æ–°repliessoæ¥è·Ÿè¸ªå›å¤ï¼Œå¹¶ä»stillWaitingä¸­åˆ é™¤actorã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å·²ç»å‡ºç°åœ¨DeviceTerminatedæ¶ˆæ¯ä¸­çš„actoræ ‡è¯†ç¬¦ã€‚å¯¹äºæˆ‘ä»¬çš„RespondTemperatureä¿¡æ¯ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ å¦‚ä¸‹ä¿¡æ¯:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RespondTemperature</span> <span class="o">{</span>
  <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>
  <span class="kd">final</span> <span class="nc">String</span> <span class="n">deviceId</span><span class="o">;</span>
  <span class="kd">final</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">value</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">RespondTemperature</span><span class="o">(</span><span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">deviceId</span><span class="o">,</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">deviceId</span> <span class="o">=</span> <span class="n">deviceId</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onReadTemperature</span><span class="o">(</span><span class="nc">ReadTemperature</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">r</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">requestId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">,</span> <span class="n">lastTemperatureReading</span><span class="o">));</span>
  <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨å¤„ç†å®Œæ¯æ¡æ¶ˆæ¯åï¼Œæˆ‘ä»¬å°†å§”æ‰˜ç»™respondWhenAllCollectedæ–¹æ³•ï¼Œæˆ‘ä»¬å°†å¾ˆå¿«è®¨è®ºè¿™ä¸ªæ–¹æ³•ã€‚</p>

<p>åœ¨è¶…æ—¶çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦è·å–æ‰€æœ‰è¿˜æ²¡æœ‰å›å¤çš„Actor(é›†åˆä¸­çš„æˆå‘˜ä»ç„¶åœ¨ç­‰å¾…)ï¼Œå¹¶åœ¨æœ€ç»ˆçš„å›å¤ä¸­æ”¾ç½®ä¸€ä¸ªDeviceTimedOutä½œä¸ºçŠ¶æ€ã€‚</p>

<p>ç°åœ¨æˆ‘ä»¬å¿…é¡»å¼„æ¸…æ¥šåœ¨respondWhenAllCollectedä¸­è¦åšä»€ä¹ˆã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨repliesSoFarçš„mapä¸­è®°å½•æ–°ç»“æœï¼Œå¹¶å°†actorä»é™æ­¢ç­‰å¾…ä¸­åˆ é™¤ã€‚ä¸‹ä¸€æ­¥æ˜¯æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æˆ‘ä»¬æ­£åœ¨ç­‰å¾…çš„Actorã€‚å¦‚æœæ²¡æœ‰ï¼Œæˆ‘ä»¬å°†æŸ¥è¯¢ç»“æœå‘é€ç»™åŸå§‹è¯·æ±‚è€…ï¼Œå¹¶åœæ­¢æŸ¥è¯¢actorã€‚å¦åˆ™ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–°repliesSoFarå’ŒstillWaitingç»“æ„å¹¶ç­‰å¾…æ›´å¤šæ¶ˆæ¯ã€‚</p>

<p>æœ‰äº†è¿™äº›çŸ¥è¯†ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºrespondWhenAllCollectedæ–¹æ³•:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">respondWhenAllCollected</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">stillWaiting</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">requester</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">RespondAllTemperatures</span><span class="o">(</span><span class="n">requestId</span><span class="o">,</span> <span class="n">repliesSoFar</span><span class="o">));</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">stopped</span><span class="o">();</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æˆ‘ä»¬çš„æŸ¥è¯¢actorç°åœ¨å·²ç»å®Œæˆ:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DeviceGroupQuery</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">enum</span> <span class="nc">CollectionTimeout</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="no">INSTANCE</span>
  <span class="o">}</span>

  <span class="kd">static</span> <span class="kd">class</span> <span class="nc">WrappedRespondTemperature</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">Device</span><span class="o">.</span><span class="na">RespondTemperature</span> <span class="n">response</span><span class="o">;</span>

    <span class="nc">WrappedRespondTemperature</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">RespondTemperature</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DeviceTerminated</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">String</span> <span class="n">deviceId</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">DeviceTerminated</span><span class="o">(</span><span class="nc">String</span> <span class="n">deviceId</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">deviceId</span> <span class="o">=</span> <span class="n">deviceId</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span>
      <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;&gt;</span> <span class="n">deviceIdToActor</span><span class="o">,</span>
      <span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span>
      <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">DeviceManager</span><span class="o">.</span><span class="na">RespondAllTemperatures</span><span class="o">&gt;</span> <span class="n">requester</span><span class="o">,</span>
      <span class="nc">Duration</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span>
        <span class="n">context</span> <span class="o">-&gt;</span>
            <span class="nc">Behaviors</span><span class="o">.</span><span class="na">withTimers</span><span class="o">(</span>
                <span class="n">timers</span> <span class="o">-&gt;</span>
                    <span class="k">new</span> <span class="nf">DeviceGroupQuery</span><span class="o">(</span>
                        <span class="n">deviceIdToActor</span><span class="o">,</span> <span class="n">requestId</span><span class="o">,</span> <span class="n">requester</span><span class="o">,</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">timers</span><span class="o">)));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">requestId</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">DeviceManager</span><span class="o">.</span><span class="na">RespondAllTemperatures</span><span class="o">&gt;</span> <span class="n">requester</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">TemperatureReading</span><span class="o">&gt;</span> <span class="n">repliesSoFar</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">stillWaiting</span><span class="o">;</span>


  <span class="kd">private</span> <span class="nf">DeviceGroupQuery</span><span class="o">(</span>
      <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;&gt;</span> <span class="n">deviceIdToActor</span><span class="o">,</span>
      <span class="kt">long</span> <span class="n">requestId</span><span class="o">,</span>
      <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">DeviceManager</span><span class="o">.</span><span class="na">RespondAllTemperatures</span><span class="o">&gt;</span> <span class="n">requester</span><span class="o">,</span>
      <span class="nc">Duration</span> <span class="n">timeout</span><span class="o">,</span>
      <span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span>
      <span class="nc">TimerScheduler</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">timers</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">requestId</span> <span class="o">=</span> <span class="n">requestId</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">requester</span> <span class="o">=</span> <span class="n">requester</span><span class="o">;</span>

    <span class="n">timers</span><span class="o">.</span><span class="na">startSingleTimer</span><span class="o">(</span><span class="nc">CollectionTimeout</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">,</span> <span class="n">timeout</span><span class="o">);</span>

    <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">RespondTemperature</span><span class="o">&gt;</span> <span class="n">respondTemperatureAdapter</span> <span class="o">=</span>
        <span class="n">context</span><span class="o">.</span><span class="na">messageAdapter</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">RespondTemperature</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nl">WrappedRespondTemperature:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>

    <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">deviceIdToActor</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">context</span><span class="o">.</span><span class="na">watchWith</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">(),</span> <span class="k">new</span> <span class="nc">DeviceTerminated</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">()));</span>
      <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Device</span><span class="o">.</span><span class="na">ReadTemperature</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="n">respondTemperatureAdapter</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="n">stillWaiting</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;(</span><span class="n">deviceIdToActor</span><span class="o">.</span><span class="na">keySet</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">WrappedRespondTemperature</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onRespondTemperature</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">DeviceTerminated</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onDeviceTerminated</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">CollectionTimeout</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onCollectionTimeout</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onRespondTemperature</span><span class="o">(</span><span class="nc">WrappedRespondTemperature</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">TemperatureReading</span> <span class="n">reading</span> <span class="o">=</span>
        <span class="n">r</span><span class="o">.</span><span class="na">response</span>
            <span class="o">.</span><span class="na">value</span>
            <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">v</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nc">DeviceManager</span><span class="o">.</span><span class="na">TemperatureReading</span><span class="o">)</span> <span class="k">new</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">Temperature</span><span class="o">(</span><span class="n">v</span><span class="o">))</span>
            <span class="o">.</span><span class="na">orElse</span><span class="o">(</span><span class="nc">DeviceManager</span><span class="o">.</span><span class="na">TemperatureNotAvailable</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>

    <span class="nc">String</span> <span class="n">deviceId</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">response</span><span class="o">.</span><span class="na">deviceId</span><span class="o">;</span>
    <span class="n">repliesSoFar</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">deviceId</span><span class="o">,</span> <span class="n">reading</span><span class="o">);</span>
    <span class="n">stillWaiting</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">deviceId</span><span class="o">);</span>

    <span class="k">return</span> <span class="nf">respondWhenAllCollected</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onDeviceTerminated</span><span class="o">(</span><span class="nc">DeviceTerminated</span> <span class="n">terminated</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">stillWaiting</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">terminated</span><span class="o">.</span><span class="na">deviceId</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">repliesSoFar</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">terminated</span><span class="o">.</span><span class="na">deviceId</span><span class="o">,</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">DeviceNotAvailable</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>
      <span class="n">stillWaiting</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">terminated</span><span class="o">.</span><span class="na">deviceId</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="nf">respondWhenAllCollected</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onCollectionTimeout</span><span class="o">(</span><span class="nc">CollectionTimeout</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">deviceId</span> <span class="o">:</span> <span class="n">stillWaiting</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">repliesSoFar</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">deviceId</span><span class="o">,</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">DeviceTimedOut</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">stillWaiting</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="k">return</span> <span class="nf">respondWhenAllCollected</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">respondWhenAllCollected</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">stillWaiting</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">requester</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">RespondAllTemperatures</span><span class="o">(</span><span class="n">requestId</span><span class="o">,</span> <span class="n">repliesSoFar</span><span class="o">));</span>
      <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">stopped</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h5 id="23734-æµ‹è¯•æŸ¥è¯¢-actor">2.3.7.3.4. æµ‹è¯•æŸ¥è¯¢ Actor</h5>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬éªŒè¯æŸ¥è¯¢ Actor å®ç°çš„æ­£ç¡®æ€§ã€‚æˆ‘ä»¬éœ€è¦å•ç‹¬æµ‹è¯•å„ç§åœºæ™¯ï¼Œä»¥ç¡®ä¿ä¸€åˆ‡éƒ½æŒ‰é¢„æœŸå·¥ä½œã€‚ä¸ºäº†èƒ½å¤Ÿåšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ä»¥æŸç§æ–¹å¼æ¨¡æ‹Ÿè®¾å¤‡ Actor æ¥è¿è¡Œå„ç§æ­£å¸¸æˆ–æ•…éšœåœºæ™¯ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å°†åˆä½œè€…ï¼ˆcollaboratorsï¼‰åˆ—è¡¨ï¼ˆå®é™…ä¸Šæ˜¯ä¸€ä¸ªMapï¼‰ä½œä¸ºæŸ¥è¯¢ Actor çš„å‚æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä¼ å…¥TestKitå¼•ç”¨ã€‚åœ¨æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬åœ¨æœ‰ä¸¤ä¸ªè®¾å¤‡çš„æƒ…å†µä¸‹è¿›è¡Œæµ‹è¯•ï¼Œä¸¤ä¸ªè®¾å¤‡éƒ½æŠ¥å‘Šäº†æ¸©åº¦ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testReturnTemperatureValueForWorkingDevices</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">RespondAllTemperatures</span><span class="o">&gt;</span> <span class="n">requester</span> <span class="o">=</span>
      <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">RespondAllTemperatures</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">device1</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">device2</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

  <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;&gt;</span> <span class="n">deviceIdToActor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
  <span class="n">deviceIdToActor</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"device1"</span><span class="o">,</span> <span class="n">device1</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span>
  <span class="n">deviceIdToActor</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"device2"</span><span class="o">,</span> <span class="n">device2</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span>

  <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">queryActor</span> <span class="o">=</span>
      <span class="n">testKit</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span>
          <span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
              <span class="n">deviceIdToActor</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span> <span class="n">requester</span><span class="o">.</span><span class="na">getRef</span><span class="o">(),</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">)));</span>

  <span class="n">device1</span><span class="o">.</span><span class="na">expectMessageClass</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">ReadTemperature</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">device2</span><span class="o">.</span><span class="na">expectMessageClass</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">ReadTemperature</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

  <span class="n">queryActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span>
      <span class="k">new</span> <span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">WrappedRespondTemperature</span><span class="o">(</span>
          <span class="k">new</span> <span class="nc">Device</span><span class="o">.</span><span class="na">RespondTemperature</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="s">"device1"</span><span class="o">,</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mf">1.0</span><span class="o">))));</span>

  <span class="n">queryActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span>
      <span class="k">new</span> <span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">WrappedRespondTemperature</span><span class="o">(</span>
          <span class="k">new</span> <span class="nc">Device</span><span class="o">.</span><span class="na">RespondTemperature</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="s">"device2"</span><span class="o">,</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mf">2.0</span><span class="o">))));</span>

  <span class="nc">RespondAllTemperatures</span> <span class="n">response</span> <span class="o">=</span> <span class="n">requester</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">();</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">requestId</span><span class="o">);</span>

  <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">TemperatureReading</span><span class="o">&gt;</span> <span class="n">expectedTemperatures</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
  <span class="n">expectedTemperatures</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"device1"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Temperature</span><span class="o">(</span><span class="mf">1.0</span><span class="o">));</span>
  <span class="n">expectedTemperatures</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"device2"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Temperature</span><span class="o">(</span><span class="mf">2.0</span><span class="o">));</span>

  <span class="n">assertEquals</span><span class="o">(</span><span class="n">expectedTemperatures</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">temperatures</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™æ˜¯ä»¤äººé«˜å…´çš„æƒ…å†µï¼Œä½†æˆ‘ä»¬çŸ¥é“ï¼Œæœ‰æ—¶è®¾å¤‡ä¸èƒ½æä¾›æ¸©åº¦æµ‹é‡ã€‚è¿™ä¸ªåœºæ™¯ä¸å‰ä¸€ä¸ªç¨æœ‰ä¸åŒ:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testReturnTemperatureNotAvailableForDevicesWithNoReadings</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">RespondAllTemperatures</span><span class="o">&gt;</span> <span class="n">requester</span> <span class="o">=</span>
      <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">RespondAllTemperatures</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">device1</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">device2</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

  <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;&gt;</span> <span class="n">deviceIdToActor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
  <span class="n">deviceIdToActor</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"device1"</span><span class="o">,</span> <span class="n">device1</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span>
  <span class="n">deviceIdToActor</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"device2"</span><span class="o">,</span> <span class="n">device2</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span>

  <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">queryActor</span> <span class="o">=</span>
      <span class="n">testKit</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span>
          <span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
              <span class="n">deviceIdToActor</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span> <span class="n">requester</span><span class="o">.</span><span class="na">getRef</span><span class="o">(),</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">)));</span>

  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="n">device1</span><span class="o">.</span><span class="na">expectMessageClass</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">ReadTemperature</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">requestId</span><span class="o">);</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="n">device2</span><span class="o">.</span><span class="na">expectMessageClass</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">ReadTemperature</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">requestId</span><span class="o">);</span>

  <span class="n">queryActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span>
      <span class="k">new</span> <span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">WrappedRespondTemperature</span><span class="o">(</span>
          <span class="k">new</span> <span class="nc">Device</span><span class="o">.</span><span class="na">RespondTemperature</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="s">"device1"</span><span class="o">,</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">())));</span>

  <span class="n">queryActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span>
      <span class="k">new</span> <span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">WrappedRespondTemperature</span><span class="o">(</span>
          <span class="k">new</span> <span class="nc">Device</span><span class="o">.</span><span class="na">RespondTemperature</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="s">"device2"</span><span class="o">,</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mf">2.0</span><span class="o">))));</span>

  <span class="nc">RespondAllTemperatures</span> <span class="n">response</span> <span class="o">=</span> <span class="n">requester</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">();</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">requestId</span><span class="o">);</span>

  <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">TemperatureReading</span><span class="o">&gt;</span> <span class="n">expectedTemperatures</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
  <span class="n">expectedTemperatures</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"device1"</span><span class="o">,</span> <span class="nc">TemperatureNotAvailable</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>
  <span class="n">expectedTemperatures</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"device2"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Temperature</span><span class="o">(</span><span class="mf">2.0</span><span class="o">));</span>

  <span class="n">assertEquals</span><span class="o">(</span><span class="n">expectedTemperatures</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">temperatures</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æˆ‘ä»¬ä¹ŸçŸ¥é“ï¼Œæœ‰æ—¶å€™è®¾å¤‡æ“ä½œè€…ä¼šåœ¨å›ç­”ä¹‹å‰åœä¸‹æ¥:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testReturnDeviceNotAvailableIfDeviceStopsBeforeAnswering</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">RespondAllTemperatures</span><span class="o">&gt;</span> <span class="n">requester</span> <span class="o">=</span>
      <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">RespondAllTemperatures</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">device1</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">device2</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

  <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;&gt;</span> <span class="n">deviceIdToActor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
  <span class="n">deviceIdToActor</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"device1"</span><span class="o">,</span> <span class="n">device1</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span>
  <span class="n">deviceIdToActor</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"device2"</span><span class="o">,</span> <span class="n">device2</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span>

  <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">queryActor</span> <span class="o">=</span>
      <span class="n">testKit</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span>
          <span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
              <span class="n">deviceIdToActor</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span> <span class="n">requester</span><span class="o">.</span><span class="na">getRef</span><span class="o">(),</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">)));</span>

  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="n">device1</span><span class="o">.</span><span class="na">expectMessageClass</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">ReadTemperature</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">requestId</span><span class="o">);</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="n">device2</span><span class="o">.</span><span class="na">expectMessageClass</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">ReadTemperature</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">requestId</span><span class="o">);</span>

  <span class="n">queryActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span>
      <span class="k">new</span> <span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">WrappedRespondTemperature</span><span class="o">(</span>
          <span class="k">new</span> <span class="nc">Device</span><span class="o">.</span><span class="na">RespondTemperature</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="s">"device1"</span><span class="o">,</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mf">1.0</span><span class="o">))));</span>

  <span class="n">device2</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>

  <span class="nc">RespondAllTemperatures</span> <span class="n">response</span> <span class="o">=</span> <span class="n">requester</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">();</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">requestId</span><span class="o">);</span>

  <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">TemperatureReading</span><span class="o">&gt;</span> <span class="n">expectedTemperatures</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
  <span class="n">expectedTemperatures</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"device1"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Temperature</span><span class="o">(</span><span class="mf">1.0</span><span class="o">));</span>
  <span class="n">expectedTemperatures</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"device2"</span><span class="o">,</span> <span class="nc">DeviceNotAvailable</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>

  <span class="n">assertEquals</span><span class="o">(</span><span class="n">expectedTemperatures</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">temperatures</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¦‚æœä½ è¿˜è®°å¾—ï¼Œè¿˜æœ‰å¦ä¸€ç§æƒ…å†µä¸è®¾å¤‡Actoråœæ­¢æœ‰å…³ã€‚æœ‰å¯èƒ½æˆ‘ä»¬ä»ä¸€ä¸ªè®¾å¤‡Actoré‚£é‡Œå¾—åˆ°ä¸€ä¸ªæ­£å¸¸çš„å›å¤ï¼Œä½†æ˜¯ä¹‹åä¼šæ”¶åˆ°ä¸€ä¸ªç»ˆæ­¢çš„ç›¸åŒActorçš„å›å¤ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›ä¿ç•™ç¬¬ä¸€ä¸ªå›å¤ï¼Œä¸å°†è¯¥è®¾å¤‡æ ‡è®°ä¸ºDeviceNotAvailableã€‚æˆ‘ä»¬ä¹Ÿåº”è¯¥æµ‹è¯•ä¸€ä¸‹:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testReturnTemperatureReadingEvenIfDeviceStopsAfterAnswering</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">RespondAllTemperatures</span><span class="o">&gt;</span> <span class="n">requester</span> <span class="o">=</span>
      <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">RespondAllTemperatures</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">device1</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">device2</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

  <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;&gt;</span> <span class="n">deviceIdToActor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
  <span class="n">deviceIdToActor</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"device1"</span><span class="o">,</span> <span class="n">device1</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span>
  <span class="n">deviceIdToActor</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"device2"</span><span class="o">,</span> <span class="n">device2</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span>

  <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">queryActor</span> <span class="o">=</span>
      <span class="n">testKit</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span>
          <span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
              <span class="n">deviceIdToActor</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span> <span class="n">requester</span><span class="o">.</span><span class="na">getRef</span><span class="o">(),</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">)));</span>

  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="n">device1</span><span class="o">.</span><span class="na">expectMessageClass</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">ReadTemperature</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">requestId</span><span class="o">);</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="n">device2</span><span class="o">.</span><span class="na">expectMessageClass</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">ReadTemperature</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">requestId</span><span class="o">);</span>

  <span class="n">queryActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span>
      <span class="k">new</span> <span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">WrappedRespondTemperature</span><span class="o">(</span>
          <span class="k">new</span> <span class="nc">Device</span><span class="o">.</span><span class="na">RespondTemperature</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="s">"device1"</span><span class="o">,</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mf">1.0</span><span class="o">))));</span>

  <span class="n">queryActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span>
      <span class="k">new</span> <span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">WrappedRespondTemperature</span><span class="o">(</span>
          <span class="k">new</span> <span class="nc">Device</span><span class="o">.</span><span class="na">RespondTemperature</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="s">"device2"</span><span class="o">,</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mf">2.0</span><span class="o">))));</span>

  <span class="n">device2</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>

  <span class="nc">RespondAllTemperatures</span> <span class="n">response</span> <span class="o">=</span> <span class="n">requester</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">();</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">requestId</span><span class="o">);</span>

  <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">TemperatureReading</span><span class="o">&gt;</span> <span class="n">expectedTemperatures</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
  <span class="n">expectedTemperatures</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"device1"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Temperature</span><span class="o">(</span><span class="mf">1.0</span><span class="o">));</span>
  <span class="n">expectedTemperatures</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"device2"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Temperature</span><span class="o">(</span><span class="mf">2.0</span><span class="o">));</span>

  <span class="n">assertEquals</span><span class="o">(</span><span class="n">expectedTemperatures</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">temperatures</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœ€åä¸€ç§æƒ…å†µæ˜¯ï¼Œä¸æ˜¯æ‰€æœ‰è®¾å¤‡éƒ½åŠæ—¶å“åº”ã€‚ä¸ºäº†ä¿æŒæˆ‘ä»¬çš„æµ‹è¯•ç›¸å¯¹å¿«é€Ÿï¼Œæˆ‘ä»¬å°†ç”¨æ›´å°çš„è¶…æ—¶æ„é€ DeviceGroupQuery actor:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testReturnDeviceTimedOutIfDeviceDoesNotAnswerInTime</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">RespondAllTemperatures</span><span class="o">&gt;</span> <span class="n">requester</span> <span class="o">=</span>
      <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">RespondAllTemperatures</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">device1</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="nc">TestProbe</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">device2</span> <span class="o">=</span> <span class="n">testKit</span><span class="o">.</span><span class="na">createTestProbe</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

  <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;&gt;</span> <span class="n">deviceIdToActor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
  <span class="n">deviceIdToActor</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"device1"</span><span class="o">,</span> <span class="n">device1</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span>
  <span class="n">deviceIdToActor</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"device2"</span><span class="o">,</span> <span class="n">device2</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span>

  <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">queryActor</span> <span class="o">=</span>
      <span class="n">testKit</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span>
          <span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
              <span class="n">deviceIdToActor</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span> <span class="n">requester</span><span class="o">.</span><span class="na">getRef</span><span class="o">(),</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">ofMillis</span><span class="o">(</span><span class="mi">200</span><span class="o">)));</span>

  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="n">device1</span><span class="o">.</span><span class="na">expectMessageClass</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">ReadTemperature</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">requestId</span><span class="o">);</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="n">device2</span><span class="o">.</span><span class="na">expectMessageClass</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="na">ReadTemperature</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">requestId</span><span class="o">);</span>

  <span class="n">queryActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span>
      <span class="k">new</span> <span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">WrappedRespondTemperature</span><span class="o">(</span>
          <span class="k">new</span> <span class="nc">Device</span><span class="o">.</span><span class="na">RespondTemperature</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="s">"device1"</span><span class="o">,</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mf">1.0</span><span class="o">))));</span>

  <span class="c1">// no reply from device2</span>

  <span class="nc">RespondAllTemperatures</span> <span class="n">response</span> <span class="o">=</span> <span class="n">requester</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">();</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">requestId</span><span class="o">);</span>

  <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">TemperatureReading</span><span class="o">&gt;</span> <span class="n">expectedTemperatures</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
  <span class="n">expectedTemperatures</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"device1"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Temperature</span><span class="o">(</span><span class="mf">1.0</span><span class="o">));</span>
  <span class="n">expectedTemperatures</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"device2"</span><span class="o">,</span> <span class="nc">DeviceTimedOut</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>

  <span class="n">assertEquals</span><span class="o">(</span><span class="n">expectedTemperatures</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">temperatures</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æˆ‘ä»¬çš„æŸ¥è¯¢ç°åœ¨æŒ‰é¢„æœŸå·¥ä½œï¼Œç°åœ¨åº”è¯¥åœ¨DeviceGroup actorä¸­åŒ…æ‹¬è¿™ä¸ªæ–°åŠŸèƒ½ã€‚</p>

<h4 id="2374-å‘ç»„æ·»åŠ æŸ¥è¯¢åŠŸèƒ½">2.3.7.4. å‘ç»„æ·»åŠ æŸ¥è¯¢åŠŸèƒ½</h4>

<p>ç°åœ¨åœ¨ç»„Actorä¸­åŒ…å«æŸ¥è¯¢ç‰¹æ€§ç›¸å½“ç®€å•ã€‚æˆ‘ä»¬åœ¨æŸ¥è¯¢actoræœ¬èº«ä¸­å®Œæˆäº†æ‰€æœ‰ç¹é‡çš„å·¥ä½œï¼Œç»„actoråªéœ€è¦ä½¿ç”¨æ­£ç¡®çš„åˆå§‹å‚æ•°åˆ›å»ºå®ƒï¼Œè€Œä¸éœ€è¦å…¶ä»–ä¸œè¥¿ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">DeviceGroup</span> <span class="nf">onAllTemperatures</span><span class="o">(</span><span class="nc">DeviceManager</span><span class="o">.</span><span class="na">RequestAllTemperatures</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// since Java collections are mutable, we want to avoid sharing them between actors (since</span>
    <span class="c1">// multiple Actors (threads)</span>
    <span class="c1">// modifying the same mutable data-structure is not safe), and perform a defensive copy of the</span>
    <span class="c1">// mutable map:</span>
    <span class="c1">//</span>
    <span class="c1">// Feel free to use your favourite immutable data-structures library with Akka in Java</span>
    <span class="c1">// applications!</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Device</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;&gt;</span> <span class="n">deviceIdToActorCopy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;(</span><span class="k">this</span><span class="o">.</span><span class="na">deviceIdToActor</span><span class="o">);</span>

    <span class="n">getContext</span><span class="o">()</span>
        <span class="o">.</span><span class="na">spawnAnonymous</span><span class="o">(</span>
            <span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
                <span class="n">deviceIdToActorCopy</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">requestId</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">replyTo</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">)));</span>

    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>


  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="c1">// ... other cases omitted</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span>
            <span class="nc">DeviceManager</span><span class="o">.</span><span class="na">RequestAllTemperatures</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="o">.</span><span class="na">groupId</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">groupId</span><span class="o">),</span>
            <span class="k">this</span><span class="o">::</span><span class="n">onAllTemperatures</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="2375-æ€»ç»“">2.3.7.5. æ€»ç»“</h4>

<p>åœ¨ç‰©è”ç½‘ï¼ˆ<code class="language-plaintext highlighter-rouge">IoT</code>ï¼‰ç³»ç»Ÿçš„èƒŒæ™¯ä¸‹ï¼Œæœ¬æŒ‡å—ä»‹ç»äº†ä»¥ä¸‹æ¦‚å¿µã€‚å¦‚æœ‰å¿…è¦ï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹é“¾æ¥è¿›è¡ŒæŸ¥çœ‹ï¼š</p>

<ul>
  <li><a href="https://github.com/guobinhit/akka-guide/blob/master/articles/getting-started-guide/tutorial_1.md">Actor çš„å±‚çº§ç»“æ„åŠå…¶ç”Ÿå‘½å‘¨æœŸ</a></li>
  <li><a href="https://github.com/guobinhit/akka-guide/blob/master/articles/getting-started-guide/tutorial_3.md">çµæ´»æ€§è®¾è®¡æ¶ˆæ¯çš„é‡è¦æ€§</a></li>
  <li><a href="https://github.com/guobinhit/akka-guide/blob/master/articles/getting-started-guide/tutorial_4.md">å¦‚ä½•ç›‘è§†å’Œåœæ­¢ Actor</a></li>
</ul>

<h3 id="238-ä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆ">2.3.8. ä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆï¼Ÿ</h3>
<p>è¦ç»§ç»­ä½ çš„ Akka ä¹‹æ—…ï¼Œæˆ‘ä»¬å»ºè®®ï¼š</p>

<ul>
  <li>å¼€å§‹ç”¨ Akka æ„å»ºä½ è‡ªå·±çš„åº”ç”¨ç¨‹åºï¼Œå¦‚æœä½ é™·å…¥å›°å¢ƒçš„è¯ï¼Œå¸Œæœ›ä½ èƒ½å‚ä¸åˆ°æˆ‘ä»¬çš„ã€Œ<a href="https://akka.io/get-involved/">ç¤¾åŒº</a>ã€ä¸­ï¼Œå¯»æ±‚å¸®åŠ©ã€‚</li>
  <li>å¦‚æœä½ æƒ³äº†è§£æ›´å¤šçš„èƒŒæ™¯çŸ¥è¯†ï¼Œè¯·é˜…è¯»å‚è€ƒæ–‡ä»¶çš„å…¶ä½™éƒ¨åˆ†ï¼Œå¹¶æŸ¥çœ‹ä¸€äº›å…³äº Akka çš„ã€Œ<a href="https://doc.akka.io/docs/akka/current/additional/books.html">ä¹¦ç±å’Œè§†é¢‘</a>ã€ã€‚</li>
</ul>

<p>è¦ä»æœ¬æŒ‡å—è·å¾—å®Œæ•´çš„åº”ç”¨ç¨‹åºï¼Œä½ å¯èƒ½éœ€è¦æä¾› UI æˆ– APIã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å»ºè®®ä½ æŸ¥çœ‹ä»¥ä¸‹æŠ€æœ¯ï¼Œçœ‹çœ‹å“ªäº›é€‚åˆä½ ï¼š</p>

<ul>
  <li>ã€Œ<a href="https://doc.akka.io/docs/akka/current/additional/books.html">Akka HTTP</a>ã€æ˜¯ä¸€ä¸ª HTTP æœåŠ¡å’Œå®¢æˆ·ç«¯çš„åº“ï¼Œä½¿å‘å¸ƒå’Œä½¿ç”¨ HTTP ç«¯ç‚¹ï¼ˆ<code class="language-plaintext highlighter-rouge">endpoints</code>ï¼‰æˆä¸ºå¯èƒ½ã€‚</li>
  <li>ã€Œ<a href="https://doc.akka.io/docs/akka/current/additional/books.html">Play Framework</a>ã€æ˜¯ä¸€ä¸ªæˆç†Ÿçš„ Web æ¡†æ¶ï¼Œå®ƒæ„å»ºåœ¨ Akka HTTP ä¹‹ä¸Šï¼Œå®ƒèƒ½ä¸ Akka å¾ˆå¥½åœ°é›†æˆï¼Œå¯ç”¨äºåˆ›å»ºä¸€ä¸ªå®Œæ•´çš„ç°ä»£ Web ç”¨æˆ·ç•Œé¢ã€‚</li>
  <li>ã€Œ<a href="https://doc.akka.io/docs/akka/current/additional/books.html">Lagom</a>ã€æ˜¯ä¸€ä¸ªåŸºäº Akka çš„ç‹¬ç«‹çš„å¾®æœåŠ¡æ¡†æ¶ï¼Œå®ƒç¼–ç äº† Akka å’Œ Play çš„è®¸å¤šæœ€ä½³å®è·µã€‚</li>
</ul>

<hr />

<p><strong>è‹±æ–‡åŸæ–‡é“¾æ¥</strong>ï¼š<a href="https://doc.akka.io/docs/akka/current/guide/tutorial_5.html">Part 5: Querying Device Groups</a>.</p>

<h1 id="3-é€šç”¨æ¦‚å¿µ">3. é€šç”¨æ¦‚å¿µ</h1>

<h2 id="31-æœ¯è¯­åŠæ¦‚å¿µ">3.1. æœ¯è¯­åŠæ¦‚å¿µ</h2>

<p>åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬è¯•å›¾å»ºç«‹ä¸€ä¸ªé€šç”¨çš„æœ¯è¯­æ¥å®šä¹‰ä¸€ä¸ªåšå®çš„åŸºç¡€ï¼Œç”¨äºäº¤æµ Akka æ‰€é’ˆå¯¹çš„å¹¶å‘å’Œåˆ†å¸ƒå¼ç³»ç»Ÿã€‚è¯·æ³¨æ„ï¼Œå¯¹äºè¿™å…¶ä¸­çš„è®¸å¤šæœ¯è¯­ï¼Œå¹¶æ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€çš„å®šä¹‰ã€‚æˆ‘ä»¬è¯•å›¾ç»™å‡ºå°†åœ¨ Akka æ–‡æ¡£èŒƒå›´å†…ä½¿ç”¨çš„å®šä¹‰ã€‚</p>

<h3 id="311-å¹¶å‘-vs-å¹¶è¡Œ">3.1.1. å¹¶å‘ vs. å¹¶è¡Œ</h3>
<p>å¹¶å‘å’Œå¹¶è¡Œæ˜¯ç›¸å…³çš„æ¦‚å¿µï¼Œä½†æœ‰ä¸€äº›å°çš„åŒºåˆ«ã€‚å¹¶å‘æ„å‘³ç€ä¸¤ä¸ªæˆ–å¤šä¸ªä»»åŠ¡æ­£åœ¨å–å¾—è¿›å±•ï¼Œå³ä½¿å®ƒä»¬å¯èƒ½ä¸ä¼šåŒæ—¶æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œè¿™å¯ä»¥é€šè¿‡æ—¶é—´åˆ‡ç‰‡æ¥å®ç°ï¼Œå…¶ä¸­éƒ¨åˆ†ä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œï¼Œå¹¶ä¸å…¶ä»–ä»»åŠ¡çš„éƒ¨åˆ†æ··åˆã€‚å¦ä¸€æ–¹é¢ï¼Œå½“æ‰§è¡Œçš„ä»»åŠ¡å¯ä»¥çœŸæ­£åŒæ—¶è¿›è¡Œæ—¶ï¼Œå°±ä¼šå‡ºç°å¹¶è¡Œã€‚</p>

<h3 id="312-å¼‚æ­¥-vs-åŒæ­¥">3.1.2. å¼‚æ­¥ vs. åŒæ­¥</h3>
<p>å¦‚æœè°ƒç”¨è€…åœ¨æ–¹æ³•è¿”å›å€¼æˆ–å¼•å‘å¼‚å¸¸ä¹‹å‰æ— æ³•å–å¾—è¿›å±•ï¼Œåˆ™è®¤ä¸ºæ–¹æ³•è°ƒç”¨æ˜¯åŒæ­¥çš„ã€‚å¦ä¸€æ–¹é¢ï¼Œå¼‚æ­¥è°ƒç”¨å…è®¸è°ƒç”¨è€…åœ¨æœ‰é™çš„æ­¥éª¤ä¹‹åç»§ç»­è¿›è¡Œï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ä¸€äº›é™„åŠ æœºåˆ¶ï¼ˆå®ƒå¯èƒ½æ˜¯å·²æ³¨å†Œçš„å›è°ƒã€Futureæˆ–æ¶ˆæ¯ï¼‰æ¥é€šçŸ¥æ–¹æ³•çš„å®Œæˆã€‚</p>

<p>åŒæ­¥ API å¯ä»¥ä½¿ç”¨é˜»å¡æ¥å®ç°åŒæ­¥ï¼Œä½†è¿™ä¸æ˜¯å¿…è¦çš„ã€‚CPU å¯†é›†å‹ä»»åŠ¡å¯èƒ½ä¼šäº§ç”Ÿç±»ä¼¼äºé˜»å¡çš„è¡Œä¸ºã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæœ€å¥½ä½¿ç”¨å¼‚æ­¥ APIï¼Œå› ä¸ºå®ƒä»¬ä¿è¯ç³»ç»Ÿèƒ½å¤Ÿè¿›è¡Œã€‚Actor æœ¬è´¨ä¸Šæ˜¯å¼‚æ­¥çš„ï¼šActor å¯ä»¥åœ¨æ¶ˆæ¯å‘é€ä¹‹åè¿›è¡Œå…¶ä»–ä»»åŠ¡ï¼Œè€Œä¸å¿…ç­‰å¾…å®é™…çš„ä¼ é€’å‘ç”Ÿã€‚</p>

<h3 id="313-éé˜»å¡-vs-é˜»å¡">3.1.3. éé˜»å¡ vs. é˜»å¡</h3>
<p>å¦‚æœä¸€ä¸ªçº¿ç¨‹çš„å»¶è¿Ÿå¯ä»¥æ— é™æœŸåœ°å»¶è¿Ÿå…¶ä»–ä¸€äº›çº¿ç¨‹ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬è®¨è®ºçš„é˜»å¡ã€‚ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­æ˜¯ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥ä½¿ç”¨äº’æ–¥æ¥ç‹¬å ä½¿ç”¨ä¸€ä¸ªèµ„æºã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹æ— é™æœŸåœ°å ç”¨èµ„æºï¼ˆä¾‹å¦‚æ„å¤–è¿è¡Œæ— é™å¾ªç¯ï¼‰ï¼Œåˆ™ç­‰å¾…è¯¥èµ„æºçš„å…¶ä»–çº¿ç¨‹å°†æ— æ³•è¿›è¡Œã€‚ç›¸åï¼Œéé˜»å¡æ„å‘³ç€æ²¡æœ‰çº¿ç¨‹èƒ½å¤Ÿæ— é™æœŸåœ°å»¶è¿Ÿå…¶ä»–çº¿ç¨‹ã€‚</p>

<p>éé˜»å¡æ“ä½œä¼˜å…ˆäºé˜»å¡æ“ä½œï¼Œå› ä¸ºå½“ç³»ç»ŸåŒ…å«é˜»å¡æ“ä½œæ—¶ï¼Œç³»ç»Ÿçš„æ€»ä½“è¿›åº¦å¹¶ä¸èƒ½å¾—åˆ°å¾ˆå¥½çš„ä¿è¯ã€‚</p>

<h3 id="314-æ­»é”-vs-é¥¥é¥¿-vs-æ´»é”">3.1.4. æ­»é” vs. é¥¥é¥¿ vs. æ´»é”</h3>
<p>å½“å¤šä¸ª Actor åœ¨ç­‰å¾…å¯¹æ–¹è¾¾åˆ°æŸä¸ªç‰¹å®šçš„çŠ¶æ€ä»¥ä¾¿èƒ½å¤Ÿå–å¾—è¿›å±•æ—¶ï¼Œå°±ä¼šå‡ºç°æ­»é”ï¼ˆDeadlockï¼‰ã€‚ç”±äºæ²¡æœ‰å…¶ä»– Actor è¾¾åˆ°æŸç§çŠ¶æ€ï¼ˆä¸€ä¸ªCatch-22é—®é¢˜ï¼‰ï¼Œæ‰€æœ‰å—å½±å“çš„å­ç³»ç»Ÿéƒ½æ— æ³•ç»§ç»­è¿è¡Œã€‚æ­»é”ä¸é˜»å¡å¯†åˆ‡ç›¸å…³ï¼Œå› ä¸º Actor çº¿ç¨‹èƒ½å¤Ÿæ— é™æœŸåœ°å»¶è¿Ÿå…¶ä»–çº¿ç¨‹çš„è¿›ç¨‹ã€‚</p>

<p>åœ¨æ­»é”çš„æƒ…å†µä¸‹ï¼Œæ²¡æœ‰ Actor å¯ä»¥å–å¾—è¿›å±•ï¼Œç›¸åï¼Œå½“æœ‰ Actor å¯ä»¥å–å¾—è¿›å±•ï¼Œä½†å¯èƒ½æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª Actor ä¸èƒ½å–å¾—è¿›å±•æ—¶ï¼Œå°±ä¼šå‘ç”Ÿé¥¥é¥¿ï¼ˆStarvationï¼‰ã€‚å…¸å‹çš„åœºæ™¯æ˜¯ä¸€ä¸ªè°ƒåº¦ç®—æ³•ï¼Œå®ƒæ€»æ˜¯é€‰æ‹©é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡è€Œä¸æ˜¯ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚å¦‚æœä¼ å…¥çš„é«˜ä¼˜å…ˆçº§ä»»åŠ¡çš„æ•°é‡ä¸€ç›´è¶³å¤Ÿå¤šï¼Œé‚£ä¹ˆä½ä¼˜å…ˆçº§ä»»åŠ¡å°†æ°¸è¿œä¸ä¼šå®Œæˆã€‚</p>

<p>æ´»é”ï¼ˆLivelockï¼‰ç±»ä¼¼äºæ­»é”ï¼Œå› ä¸ºæ²¡æœ‰ Actor å–å¾—è¿›å±•ã€‚ä¸åŒä¹‹å¤„åœ¨äºï¼ŒActor ä¸ä¼šè¢«å†»ç»“åœ¨ç­‰å¾…ä»–äººè¿›å±•çš„çŠ¶æ€ä¸­ï¼Œè€Œæ˜¯ä¸æ–­åœ°æ”¹å˜è‡ªå·±çš„çŠ¶æ€ã€‚ä¸€ä¸ªç¤ºä¾‹åœºæ™¯æ˜¯ï¼Œä¸¤ä¸ª Actor æœ‰ä¸¤ä¸ªç›¸åŒèµ„æºå¯ç”¨æ—¶ã€‚ä»–ä»¬æ¯ä¸€ä¸ªéƒ½è¯•å›¾è·å¾—èµ„æºï¼Œä½†ä»–ä»¬ä¹Ÿä¼šæ£€æŸ¥å¯¹æ–¹æ˜¯å¦ä¹Ÿéœ€è¦èµ„æºã€‚å¦‚æœèµ„æºæ˜¯ç”±å¦ä¸€ä¸ª Actor è¯·æ±‚çš„ï¼Œä»–ä»¬ä¼šå°è¯•è·å–è¯¥èµ„æºçš„å¦ä¸€ä¸ªå®ä¾‹ã€‚åœ¨ä¸å¹¸çš„æƒ…å†µä¸‹ï¼Œä¸¤ä¸ª Actor å¯èƒ½ä¼šåœ¨ä¸¤ç§èµ„æºä¹‹é—´â€œåå¼¹ï¼ˆbounceï¼‰â€ï¼Œä»ä¸è·å–èµ„æºï¼Œä½†æ€»æ˜¯å±ˆæœäºå¦ä¸€ç§èµ„æºã€‚</p>

<h3 id="315-ç«Ÿæ€æ¡ä»¶">3.1.5. ç«Ÿæ€æ¡ä»¶</h3>
<p>å½“ä¸€ç»„äº‹ä»¶çš„é¡ºåºçš„å‡è®¾å¯èƒ½è¢«å¤–éƒ¨çš„éç¡®å®šæ€§ï¼ˆnon-deterministicï¼‰å› ç´ å½±å“æ—¶ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºç«Ÿæ€æ¡ä»¶ï¼ˆRace conditionï¼‰ã€‚å½“å¤šä¸ªçº¿ç¨‹å…·æœ‰å…±äº«å¯å˜çŠ¶æ€æ—¶ï¼Œå¸¸å¸¸ä¼šå‡ºç°ç«Ÿæ€æ¡ä»¶ï¼Œå¹¶ä¸”çº¿ç¨‹åœ¨è¯¥çŠ¶æ€ä¸Šçš„æ“ä½œå¯èƒ½ä¼šäº¤é”™è¿›è¡Œï¼Œä»è€Œå¯¼è‡´æ„å¤–çš„è¡Œä¸ºã€‚è™½ç„¶è¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„æƒ…å†µï¼Œä½†æ˜¯å…±äº«çŠ¶æ€ä¸éœ€è¦æœ‰ç«Ÿæ€æ¡ä»¶ã€‚ä¾‹å¦‚ï¼Œå®¢æˆ·æœºå‘æœåŠ¡å™¨å‘é€æ— åºæ•°æ®åŒ…ï¼ˆå¦‚ UDP æ•°æ®æŠ¥ï¼‰P1å’ŒP2ã€‚ç”±äºæ•°æ®åŒ…å¯èƒ½é€šè¿‡ä¸åŒçš„ç½‘ç»œè·¯ç”±ä¼ è¾“ï¼Œå› æ­¤æœåŠ¡å™¨å¯èƒ½å…ˆæ¥æ”¶åˆ°P2ï¼Œç„¶åæ¥æ”¶åˆ°P1ã€‚å¦‚æœæ¶ˆæ¯ä¸åŒ…å«æœ‰å…³å…¶å‘é€é¡ºåºçš„ä¿¡æ¯ï¼Œåˆ™æœåŠ¡å™¨æ— æ³•ç¡®å®šå®ƒä»¬æ˜¯ä»¥ä¸åŒçš„é¡ºåºå‘é€çš„ã€‚æ ¹æ®åŒ…ï¼ˆpacketsï¼‰çš„å«ä¹‰ï¼Œè¿™å¯èƒ½å¯¼è‡´ç«Ÿæ€æ¡ä»¶ã€‚</p>

<p>æ³¨é‡Šï¼šAkka æä¾›çš„å…³äºåœ¨ç»™å®šçš„ä¸¤ä¸ª Actor ä¹‹é—´å‘é€çš„æ¶ˆæ¯çš„å”¯ä¸€ä¿è¯æ˜¯ï¼Œä»–ä»¬çš„é¡ºåºå§‹ç»ˆä¿æŒä¸å˜ã€‚è¯¦è§ã€Œæ¶ˆæ¯ä¼ é€’å¯é æ€§ã€ã€‚</p>

<h3 id="316-éé˜»å¡ä¿è¯è¿›åº¦æ¡ä»¶">3.1.6. éé˜»å¡ä¿è¯ï¼ˆè¿›åº¦æ¡ä»¶ï¼‰</h3>
<p>å¦‚å‰å‡ èŠ‚æ‰€è®¨è®ºçš„ï¼Œé˜»å¡æ˜¯ä¸å¯å–çš„ï¼ŒåŸå› æœ‰å‡ ä¸ªï¼ŒåŒ…æ‹¬æ­»é”çš„å±é™©å’Œç³»ç»Ÿä¸­ååé‡çš„é™ä½ã€‚åœ¨ä¸‹é¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå…·æœ‰ä¸åŒå¼ºåº¦çš„å„ç§éé˜»å¡ç‰¹æ€§ã€‚</p>

<h3 id="317-ç­‰å¾…è‡ªç”±">3.1.7. ç­‰å¾…è‡ªç”±</h3>
<p>å¦‚æœä¿è¯æ¯ä¸ªè°ƒç”¨éƒ½ä»¥æœ‰é™çš„æ­¥éª¤å®Œæˆï¼Œåˆ™æ–¹æ³•æ˜¯æ— ç­‰å¾…çš„ï¼Œå³ç­‰å¾…è‡ªç”±ï¼ˆwait-freedomï¼‰ã€‚å¦‚æœä¸€ä¸ªæ–¹æ³•æ˜¯æœ‰ç•Œâ€œæ— ç­‰å¾…â€çš„ï¼Œé‚£ä¹ˆæ­¥éª¤çš„æ•°é‡æœ‰ä¸€ä¸ªæœ‰é™çš„ä¸Šé™ã€‚</p>

<p>æ ¹æ®è¿™ä¸ªå®šä¹‰ï¼Œæ— ç­‰å¾…æ–¹æ³•æ°¸è¿œä¸ä¼šè¢«é˜»å¡ï¼Œå› æ­¤ä¸ä¼šå‘ç”Ÿæ­»é”ã€‚æ­¤å¤–ï¼Œç”±äºæ¯ä¸ª Actor éƒ½å¯ä»¥åœ¨æœ‰é™çš„æ­¥éª¤ä¹‹åï¼ˆè°ƒç”¨å®Œæˆæ—¶ï¼‰ç»§ç»­è¿›è¡Œï¼Œå› æ­¤æ— ç­‰å¾…æ–¹æ³•æ²¡æœ‰é¥¥é¥¿ã€‚</p>

<h3 id="318-é”è‡ªç”±">3.1.8. é”è‡ªç”±</h3>
<p>é”è‡ªç”±ï¼ˆlock-freedomï¼‰æ¯”ç­‰å¾…è‡ªç”±æ›´å¼±ã€‚åœ¨æ— é”è°ƒç”¨çš„æƒ…å†µä¸‹ï¼ŒæŸäº›æ–¹æ³•ä»¥æœ‰é™çš„æ­¥æ•°å®Œæˆå¯èƒ½å¯¼è‡´æ— é™çš„ç­‰å¾…ã€‚è¿™ä¸ªå®šä¹‰æ„å‘³ç€æ²¡æœ‰æ­»é”çš„è°ƒç”¨æ˜¯ä¸å¯èƒ½çš„ã€‚å¦ä¸€æ–¹é¢ï¼ŒæŸäº›è°ƒç”¨ä»¥æœ‰é™çš„æ­¥éª¤å®Œæˆçš„ä¿è¯ä¸è¶³ä»¥ä¿è¯æ‰€æœ‰è°ƒç”¨æœ€ç»ˆéƒ½å®Œæˆã€‚æ¢å¥è¯è¯´ï¼Œé”è‡ªç”±ä¸è¶³ä»¥ä¿è¯ä¸å‘ç”Ÿé¥¥é¥¿ã€‚</p>

<h3 id="319-éšœç¢è‡ªç”±">3.1.9. éšœç¢è‡ªç”±</h3>
<p>éšœç¢è‡ªç”±ï¼ˆobstruction-freedomï¼‰æ˜¯æœ¬æ–‡è®¨è®ºçš„æœ€è–„å¼±çš„éé˜»å¡ä¿è¯ã€‚å¦‚æœä¸€ä¸ªæ–¹æ³•åœ¨æŸä¸ªæ—¶é—´ç‚¹ä¹‹åç‹¬ç«‹æ‰§è¡Œï¼ˆå…¶ä»–çº¿ç¨‹ä¸æ‰§è¡Œä»»ä½•æ­¥éª¤ï¼Œä¾‹å¦‚ï¼šæŒ‚èµ·ï¼‰ï¼Œåˆ™è¯¥æ–¹æ³•ç§°ä¸ºæ— éšœç¢çš„ï¼Œå®ƒä»¥æœ‰é™çš„æ­¥éª¤å®Œæˆã€‚æ‰€æœ‰é”è‡ªç”±å¯¹è±¡éƒ½æ˜¯æ— éšœç¢çš„ï¼Œä½†ç›¸åçš„æƒ…å†µé€šå¸¸æ˜¯ä¸æ­£ç¡®çš„ã€‚</p>

<p>ä¹è§‚å¹¶å‘æ§åˆ¶ï¼ˆOCCï¼‰æ–¹æ³•é€šå¸¸æ˜¯æ— éšœç¢çš„ã€‚OCC æ–¹æ³•æ˜¯ï¼Œæ¯ä¸ª Actor éƒ½è¯•å›¾åœ¨å…±äº«å¯¹è±¡ä¸Šæ‰§è¡Œå…¶æ“ä½œï¼Œä½†å¦‚æœ Actor æ£€æµ‹åˆ°æ¥è‡ªå…¶ä»–å¯¹è±¡çš„å†²çªï¼Œåˆ™ä¼šå›æ»šä¿®æ”¹ï¼Œå¹¶æ ¹æ®æŸäº›è®¡åˆ’é‡è¯•ã€‚å¦‚æœæœ‰ä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œå…¶ä¸­ä¸€ä¸ª Actor æ˜¯å”¯ä¸€çš„å°è¯•è€…ï¼Œé‚£ä¹ˆæ“ä½œå°†æˆåŠŸ</p>

<h2 id="32-actorç³»ç»Ÿ">3.2. Actorç³»ç»Ÿ</h2>
<p>Actor æ˜¯å°è£…çŠ¶æ€å’Œè¡Œä¸ºçš„å¯¹è±¡ï¼Œå®ƒä»¬é€šè¿‡äº¤æ¢æ”¾åœ¨æ”¶ä»¶äººé‚®ç®±ä¸­çš„æ¶ˆæ¯è¿›è¡Œä¸“é—¨çš„é€šä¿¡ã€‚ä»æŸç§æ„ä¹‰ä¸Šè¯´ï¼ŒActor æ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹æœ€ä¸¥æ ¼çš„å½¢å¼ï¼Œä½†æœ€å¥½å°†å…¶è§†ä¸ºâ€œäººâ€ï¼šå½“ä¸ Actor ä¸€èµ·å»ºæ¨¡è§£å†³æ–¹æ¡ˆæ—¶ï¼Œè®¾æƒ³ä¸€ç»„äººå‘˜å¹¶ä¸ºå…¶åˆ†é…å­ä»»åŠ¡ï¼Œå°†å…¶åŠŸèƒ½å®‰æ’åˆ°ç»„ç»‡ç»“æ„ä¸­ï¼Œå¹¶è€ƒè™‘å¦‚ä½•å‡çº§å¤±è´¥ï¼ˆæ‰€æœ‰è¿™äº›éƒ½å¾—ç›Šäºéå®é™…åœ°ä¸äººæ‰“äº¤é“ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒä»–ä»¬çš„æƒ…æ„ŸçŠ¶æ€æˆ–é“å¾·é—®é¢˜ï¼‰ã€‚ç»“æœå¯ä»¥ä½œä¸ºæ„å»ºè½¯ä»¶å®ç°çš„ä¸€ä¸ªå¿ƒç†è„šæ‰‹æ¶ï¼ˆ<code class="language-plaintext highlighter-rouge">mental scaffolding</code>ï¼‰ã€‚</p>

<ul>
  <li><strong>æ³¨é‡Š</strong>ï¼š<code class="language-plaintext highlighter-rouge">ActorSystem</code>æ˜¯ä¸€ä¸ªé‡é‡çº§æ¶æ„ï¼Œå®ƒå°†åˆ†é…<code class="language-plaintext highlighter-rouge">1 â€¦ N</code>ä¸ªçº¿ç¨‹ï¼Œå› æ­¤ä¸ºæ¯ä¸ªé€»è¾‘åº”ç”¨ç¨‹åºéƒ½åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ã€‚</li>
</ul>

<h3 id="321-å±‚æ¬¡ç»“æ„">3.2.1. å±‚æ¬¡ç»“æ„</h3>
<p>å°±åƒåœ¨ç»æµç»„ç»‡ä¸­ä¸€æ ·ï¼ŒActor è‡ªç„¶å½¢æˆç­‰çº§åˆ¶åº¦ã€‚ä¸€ä¸ªè´Ÿè´£ç›‘ç£ç¨‹åºä¸­æŸä¸ªå‡½æ•°çš„ Actor å¯èƒ½å¸Œæœ›å°†å…¶ä»»åŠ¡æ‹†åˆ†ä¸ºæ›´å°ã€æ›´æ˜“äºç®¡ç†çš„éƒ¨åˆ†ã€‚ä¸ºæ­¤ï¼Œå®ƒå¯åŠ¨äº†ç”±å®ƒç›‘ç£çš„å­ Actorã€‚åœ¨ã€Œ<a href="https://github.com/guobinhit/akka-guide/blob/master/articles/general-concepts/supervision.md">è¿™é‡Œ</a>ã€è§£é‡Šç›‘ç£ç»†èŠ‚çš„åŒæ—¶ï¼Œæˆ‘ä»¬å°†é›†ä¸­è®¨è®ºæœ¬èŠ‚ä¸­çš„åŸºæœ¬æ¦‚å¿µã€‚å”¯ä¸€çš„å…ˆå†³æ¡ä»¶æ˜¯è¦çŸ¥é“æ¯ä¸ª Actor åªæœ‰ä¸€ä¸ªç›‘ç£è€…ï¼Œè¿™å°±æ˜¯åˆ›å»ºå®ƒçš„ Actorã€‚</p>

<p>Actor ç³»ç»Ÿçš„å…¸å‹ç‰¹å¾æ˜¯ï¼Œä»»åŠ¡è¢«æ‹†åˆ†å’Œå§”æ‰˜ï¼Œç›´åˆ°å®ƒä»¬å˜å¾—è¶³å¤Ÿå°ï¼Œå¯ä»¥ä¸€å—å¤„ç†ã€‚è¿™æ ·åšï¼Œä¸ä»…ä»»åŠ¡æœ¬èº«ç»“æ„æ¸…æ™°ï¼Œè€Œä¸”ç»“æœ Actor å¯ä»¥æ ¹æ®ä»–ä»¬åº”è¯¥å¤„ç†å“ªäº›æ¶ˆæ¯ã€åº”è¯¥å¦‚ä½•æ­£å¸¸ååº”ä»¥åŠåº”è¯¥å¦‚ä½•å¤„ç†å¤±è´¥æ¥è¿›è¡Œæ¨ç†ã€‚å¦‚æœä¸€ä¸ª Actor æ²¡æœ‰å¤„ç†ç‰¹å®šæƒ…å†µçš„æ–¹æ³•ï¼Œå®ƒä¼šå‘å…¶ç›‘ç£ Actor å‘é€ç›¸åº”çš„å¤±è´¥æ¶ˆæ¯ï¼Œè¯·æ±‚å¸®åŠ©ã€‚ç„¶åï¼Œé€’å½’ç»“æ„å…è®¸åœ¨æ­£ç¡®çš„çº§åˆ«å¤„ç†æ•…éšœã€‚</p>

<p>å°†å…¶ä¸æ˜“äºè½¬å…¥é˜²å¾¡ç¼–ç¨‹ï¼ˆ<code class="language-plaintext highlighter-rouge">defensive programming</code>ï¼‰çš„åˆ†å±‚è½¯ä»¶è®¾è®¡è¿›è¡Œæ¯”è¾ƒï¼Œç›®çš„æ˜¯ä¸æ³„æ¼ä»»ä½•æ•…éšœï¼šå¦‚æœé—®é¢˜ä¼ è¾¾ç»™äº†æ­£ç¡®çš„äººï¼Œé‚£ä¹ˆå¯ä»¥æ‰¾åˆ°æ¯”è¯•å›¾å°†æ‰€æœ‰äº‹æƒ…â€œéšè—â€åœ¨â€œåœ°æ¯¯ä¸‹â€æ›´å¥½çš„è§£å†³æ–¹æ¡ˆã€‚</p>

<p>ç°åœ¨ï¼Œè®¾è®¡è¿™æ ·ä¸€ä¸ªç³»ç»Ÿçš„å›°éš¾åœ¨äºå¦‚ä½•å†³å®šè°åº”è¯¥ç›‘ç£ä»€ä¹ˆã€‚æ²¡æœ‰å•ä¸€çš„æœ€ä½³è§£å†³æ–¹æ¡ˆï¼Œä½†æœ‰ä¸€äº›æŒ‡å¯¼æ–¹é’ˆå¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ï¼š</p>

<ul>
  <li>å¦‚æœä¸€ä¸ª Actor ç®¡ç†å¦ä¸€ä¸ª Actor æ­£åœ¨åšçš„å·¥ä½œï¼Œä¾‹å¦‚é€šè¿‡ä¼ é€’å­ä»»åŠ¡ï¼Œé‚£ä¹ˆç®¡ç† Actor åº”è¯¥ç›‘ç£å­ Actorã€‚åŸå› æ˜¯ç®¡ç† Actor çŸ¥é“é¢„æœŸçš„æ•…éšœç±»å‹ä»¥åŠå¦‚ä½•å¤„ç†ã€‚</li>
  <li>å¦‚æœä¸€ä¸ª Actor æºå¸¦éå¸¸é‡è¦çš„æ•°æ®ï¼ˆå³ï¼Œå¦‚æœå¯ä»¥é¿å…ï¼Œå…¶çŠ¶æ€ä¸ä¼šä¸¢å¤±ï¼‰ï¼Œåˆ™è¯¥ Actor åº”å‘å…¶ç›‘ç£çš„å­ Actor æ‰¾å‡ºä»»ä½•å¯èƒ½å±é™©çš„å­ä»»åŠ¡ï¼Œå¹¶å¤„ç†è¿™äº›å­ Actor çš„æ•…éšœã€‚æ ¹æ®è¯·æ±‚çš„æ€§è´¨ï¼Œæœ€å¥½ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªæ–°çš„å­çº§ï¼Œè¿™æ ·å¯ä»¥ç®€åŒ–æ”¶é›†ç­”å¤çš„çŠ¶æ€ç®¡ç†ã€‚è¿™å°±æ˜¯ Erlang çš„â€œé”™è¯¯å†…æ ¸æ¨¡å¼â€ã€‚</li>
  <li>å¦‚æœä¸€ä¸ª Actor ä¾é å¦ä¸€ä¸ª Actor æ¥å±¥è¡ŒèŒè´£ï¼Œå®ƒåº”è¯¥è§‚å¯Ÿå¦ä¸€ä¸ª Actor çš„æ´»åŠ¨ï¼Œå¹¶åœ¨æ¥åˆ°ç»ˆæ­¢é€šçŸ¥åé‡‡å–è¡ŒåŠ¨ã€‚è¿™ä¸ç›‘ç£ä¸åŒï¼Œå› ä¸ºç›‘ç£æ–¹å¯¹ç›‘ç£ç­–ç•¥æ²¡æœ‰å½±å“ï¼Œåº”è¯¥æ³¨æ„çš„æ˜¯ï¼Œå•ç‹¬çš„åŠŸèƒ½ä¾èµ–æ€§å¹¶ä¸æ˜¯å†³å®šå°†æŸä¸ªå­ Actor æ”¾åœ¨å±‚çº§ä¸­ä½•å¤„çš„æ ‡å‡†ã€‚</li>
</ul>

<p>è¿™äº›è§„åˆ™æ€»æ˜¯æœ‰ä¾‹å¤–çš„ï¼Œä½†æ˜¯ä¸ç®¡ä½ æ˜¯éµå®ˆè§„åˆ™è¿˜æ˜¯è¿åè§„åˆ™ï¼Œä½ éƒ½åº”è¯¥æœ‰ä¸€ä¸ªç†ç”±ã€‚</p>

<h3 id="322-é…ç½®å®¹å™¨">3.2.2. é…ç½®å®¹å™¨</h3>

<p>Actor ç³»ç»Ÿä½œä¸º Actor çš„åä½œé›†åˆï¼Œæ˜¯ç®¡ç†å…±äº«è®¾æ–½ï¼ˆå¦‚è°ƒåº¦æœåŠ¡ã€é…ç½®ã€æ—¥å¿—è®°å½•ç­‰ï¼‰çš„è‡ªç„¶å•å…ƒã€‚å…·æœ‰ä¸åŒé…ç½®çš„å¤šä¸ª Actor ç³»ç»Ÿå¯ä»¥åœ¨åŒä¸€ä¸ª JVM ä¸­å…±å­˜ï¼Œæ²¡æœ‰é—®é¢˜ï¼ŒAkka æœ¬èº«æ²¡æœ‰å…¨å±€å…±äº«çŠ¶æ€ã€‚å°†å…¶ä¸ä¸€ä¸ªèŠ‚ç‚¹å†…æˆ–é€šè¿‡ç½‘ç»œè¿æ¥çš„ Actor ç³»ç»Ÿä¹‹é—´çš„é€æ˜é€šä¿¡ç»“åˆèµ·æ¥ï¼Œå¯ä»¥çœ‹åˆ° Actor ç³»ç»Ÿæœ¬èº«å¯ä»¥ç”¨ä½œåŠŸèƒ½å±‚æ¬¡ç»“æ„ä¸­çš„æ„å»ºå—ã€‚</p>

<h3 id="323-actor-æœ€ä½³å®è·µ">3.2.3. Actor æœ€ä½³å®è·µ</h3>

<ol>
  <li>Actor åº”è¯¥åƒå¥½çš„åŒäº‹ä¸€æ ·ï¼šé«˜æ•ˆåœ°å·¥ä½œï¼Œè€Œä¸æ˜¯ä¸å¿…è¦åœ°æ‰“æ‰°å…¶ä»–äººï¼Œå¹¶ä¸”é¿å…å ç”¨èµ„æºã€‚ç¿»è¯‘æˆç¼–ç¨‹è¯­è¨€ï¼Œè¿™æ„å‘³ç€ä»¥äº‹ä»¶é©±åŠ¨çš„æ–¹å¼å¤„ç†äº‹ä»¶å¹¶ç”Ÿæˆå“åº”ï¼ˆæˆ–æ›´å¤šè¯·æ±‚ï¼‰ã€‚Actor ä¸åº”åœ¨å¯èƒ½æ˜¯é”ã€ç½‘ç»œå¥—æ¥å­—ç­‰å¤–éƒ¨å®ä½“ä¸Šé˜»å¡ï¼Œå³å ç”¨çº¿ç¨‹æ—¶è¢«åŠ¨ç­‰å¾…ï¼Œé™¤éè¿™æ˜¯ä¸å¯é¿å…çš„ï¼›å¯¹äºåä¸€ç§æƒ…å†µï¼Œè¯·å‚è§ä¸‹æ–‡ã€‚</li>
  <li>ä¸è¦åœ¨ Actor ä¹‹é—´ä¼ é€’å¯å˜å¯¹è±¡ã€‚ä¸ºäº†ç¡®ä¿è¿™ä¸€ç‚¹ï¼Œæœ€å¥½é€‰æ‹©ä¸å¯å˜çš„æ¶ˆæ¯ã€‚å¦‚æœé€šè¿‡å°†å®ƒä»¬çš„å¯å˜çŠ¶æ€æš´éœ²åˆ°å¤–éƒ¨æ¥ç ´å Actor çš„å°è£…ï¼Œåˆ™ä¼šè¿”å›æ­£å¸¸çš„ Java å¹¶å‘åŸŸï¼Œå¹¶å­˜åœ¨æ‰€æœ‰çš„ç¼ºç‚¹ã€‚</li>
  <li>Actor è¢«è®¾è®¡æˆè¡Œä¸ºå’ŒçŠ¶æ€çš„å®¹å™¨ï¼Œæ¥å—è¿™ä¸€ç‚¹æ„å‘³ç€ä¸ç»å¸¸åœ¨æ¶ˆæ¯ä¸­å‘é€è¡Œä¸ºï¼ˆä½¿ç”¨ Scala é—­åŒ…å¯èƒ½å¾ˆè¯±äººï¼‰ã€‚å…¶ä¸­ä¸€ä¸ªé£é™©æ˜¯ä¸å°å¿ƒåœ¨ Actor ä¹‹é—´å…±äº«å¯å˜çŠ¶æ€ï¼Œè€Œè¿™ç§å¯¹ Actor æ¨¡å‹çš„è¿åä¸å¹¸åœ°ç ´åäº†æ‰€æœ‰å±æ€§ã€‚</li>
  <li>é¡¶çº§ Actor æ˜¯é”™è¯¯å†…æ ¸çš„æœ€æ ¸å¿ƒéƒ¨åˆ†ï¼Œå› æ­¤è¦è°¨æ…åœ°åˆ›å»ºå®ƒä»¬ï¼Œå¹¶ä¸”æ›´å€¾å‘äºçœŸæ­£çš„åˆ†å±‚ç³»ç»Ÿã€‚è¿™å¯¹äºæ•…éšœå¤„ç†ï¼ˆåŒæ—¶è€ƒè™‘é…ç½®çš„ç²’åº¦å’Œæ€§èƒ½ï¼‰æœ‰å¥½å¤„ï¼Œè€Œä¸”å®ƒè¿˜å‡å°‘äº†å¯¹å®ˆæŠ¤è€… Actor çš„å‹åŠ›ï¼Œå¦‚æœä½¿ç”¨è¿‡åº¦ï¼Œè¿™æ˜¯ä¸€ä¸ªå•ä¸€çš„ç«äº‰ç‚¹ã€‚</li>
</ol>

<h3 id="324-ä½ ä¸åº”è¯¥å…³å¿ƒçš„äº‹">3.2.4. ä½ ä¸åº”è¯¥å…³å¿ƒçš„äº‹</h3>
<p>Actor ç³»ç»Ÿç®¡ç†é…ç½®ä½¿ç”¨çš„èµ„æºï¼Œä»¥ä¾¿è¿è¡Œå…¶åŒ…å«çš„ Actorã€‚åœ¨ä¸€ä¸ªè¿™æ ·çš„ç³»ç»Ÿä¸­ï¼Œå¯èƒ½æœ‰æ•°ç™¾ä¸‡çš„ Actorï¼Œæ¯•ç«Ÿæ‰€æœ‰çš„èµæ­Œï¼ˆ<code class="language-plaintext highlighter-rouge">mantra</code>ï¼‰éƒ½æ˜¯å°†ä»–ä»¬è§†ä¸ºä¸°å¯Œçš„ï¼Œå¹¶ä¸”ä»–ä»¬åœ¨æ¯ä¸ªå®ä¾‹çš„å¼€é”€åªæœ‰å¤§çº¦ 300 å­—èŠ‚ã€‚å½“ç„¶ï¼Œåœ¨å¤§å‹ç³»ç»Ÿä¸­å¤„ç†æ¶ˆæ¯çš„ç¡®åˆ‡é¡ºåºä¸å—åº”ç”¨ç¨‹åºä½œè€…çš„æ§åˆ¶ï¼Œä½†è¿™ä¹Ÿæ˜¯æ— æ„çš„ã€‚</p>

<h3 id="325-ç»ˆæ­¢-actorsystem">3.2.5. ç»ˆæ­¢ ActorSystem</h3>

<p>å½“ä½ çŸ¥é“åº”ç”¨ç¨‹åºçš„æ‰€æœ‰æ“ä½œéƒ½å·²å®Œæˆæ—¶ï¼Œå¯ä»¥è°ƒ<code class="language-plaintext highlighter-rouge">ActorSystem</code>çš„<code class="language-plaintext highlighter-rouge">terminate</code>æ–¹æ³•ã€‚è¿™å°†åœæ­¢å®ˆæŠ¤è€… Actorï¼Œè€Œå®ˆæŠ¤è€… Actor åˆå°†é€’å½’åœ°åœæ­¢å…¶æ‰€æœ‰å­ Actorï¼Œå³ç³»ç»Ÿå®ˆæŠ¤è€…ã€‚</p>

<p>å¦‚æœè¦åœ¨ç»ˆæ­¢<code class="language-plaintext highlighter-rouge">ActorSystem</code>æ—¶æ‰§è¡ŒæŸäº›æ“ä½œï¼Œè¯·æŸ¥çœ‹ã€Œ<a href="https://github.com/guobinhit/akka-guide/blob/master/articles/actors/actors.md#%E5%8D%8F%E8%B0%83%E5%85%B3%E9%97%AD">åè°ƒå…³é—­</a>ã€ã€‚</p>

<hr />

<p><strong>è‹±æ–‡åŸæ–‡é“¾æ¥</strong>ï¼š<a href="https://doc.akka.io/docs/akka/current/general/actor-systems.html">Actor Systems</a>.</p>

<hr />

<h2 id="33-ä»€ä¹ˆæ˜¯-actor">3.3. ä»€ä¹ˆæ˜¯ Actorï¼Ÿ</h2>
<p>åœ¨ã€Œ<a href="https://github.com/guobinhit/akka-guide/blob/master/articles/general-concepts/actor-systems.md">Actor ç³»ç»Ÿ</a>ã€è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† Actor æ˜¯å¦‚ä½•å½¢æˆå±‚æ¬¡ç»“æ„çš„ï¼Œä»¥åŠå…¶æ˜¯æ„å»ºåº”ç”¨ç¨‹åºçš„æœ€å°å•å…ƒã€‚æœ¬èŠ‚å°†å•ç‹¬åœ°ç ”ç©¶ Actorï¼Œè§£é‡Šåœ¨å®ç°å®ƒæ—¶é‡åˆ°çš„æ¦‚å¿µã€‚æœ‰å…³æ‰€æœ‰ç»†èŠ‚çš„æ›´æ·±å…¥æ¢è®¨ï¼Œè¯·å‚é˜…ã€Œ<a href="https://github.com/guobinhit/akka-guide/blob/master/articles/actors/actors.md">Actors</a>ã€ã€‚</p>

<p>Actor æ˜¯çŠ¶æ€ã€è¡Œä¸ºã€é‚®ç®±ã€å­ Actor å’Œç›‘ç£è€…ç­–ç•¥ï¼ˆ<code class="language-plaintext highlighter-rouge">Supervisor Strategy</code>ï¼‰çš„å®¹å™¨ã€‚æ‰€æœ‰è¿™äº›éƒ½å°è£…åœ¨ä¸€ä¸ª Actor çš„å¼•ç”¨ä¹‹åã€‚ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„æ–¹é¢æ˜¯ï¼ŒActor æœ‰ä¸€ä¸ªæ˜ç¡®çš„ç”Ÿå‘½å‘¨æœŸï¼Œå½“ä¸å†è¢«å¼•ç”¨æ—¶å®ƒä»¬ä¸ä¼šè¢«è‡ªåŠ¨é”€æ¯ï¼›åœ¨åˆ›å»ºäº†ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸä¹‹åï¼Œä½ æœ‰è´£ä»»ç¡®ä¿å®ƒæœ€ç»ˆä¼šè¢«ç»ˆæ­¢ï¼Œè¿™ä¹Ÿè®©ä½ èƒ½å¤Ÿæ§åˆ¶å½“ Actor ç»ˆæ­¢æ—¶å¦‚ä½•é‡Šæ”¾èµ„æºã€‚</p>

<h3 id="331-actor-å¼•ç”¨">3.3.1. Actor å¼•ç”¨</h3>
<p>å¦‚ä¸‹é¢è¯¦ç»†ä»‹ç»çš„ï¼Œä¸ºäº†ä» Actor æ¨¡å‹ä¸­è·ç›Šï¼Œéœ€è¦å°† Actor å¯¹è±¡ä»å¤–éƒ¨å±è”½ã€‚å› æ­¤ï¼Œä½¿ç”¨ Actor å¼•ç”¨å°† Actor è¡¨ç¤ºä¸ºå¤–éƒ¨å¯¹è±¡ï¼Œè¿™äº›å¼•ç”¨æ˜¯å¯ä»¥è‡ªç”±åœ°ä¼ é€’ä¸”ä¸å—é™åˆ¶çš„å¯¹è±¡ã€‚è¿™ç§åˆ†ä¸ºå†…éƒ¨å¯¹è±¡å’Œå¤–éƒ¨å¯¹è±¡çš„æ–¹æ³•å¯ä»¥å®ç°æ‰€æœ‰æ‰€éœ€æ“ä½œçš„é€æ˜æ€§ï¼šåœ¨ä¸éœ€è¦æ›´æ–°å…¶ä»–åœ°æ–¹å¼•ç”¨çš„æƒ…å†µä¸‹é‡æ–°å¯åŠ¨ Actorï¼Œå°†å®é™…çš„ Actor å¯¹è±¡æ”¾åœ¨è¿œç¨‹ä¸»æœºä¸Šï¼Œåœ¨å®Œå…¨ä¸åŒçš„åº”ç”¨ç¨‹åºä¸­å‘ Actor å‘é€æ¶ˆæ¯ã€‚ä½†æœ€é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œé™¤é Actor ä¸æ˜æ™ºåœ°å‘å¸ƒäº†è¿™äº›ä¿¡æ¯ï¼Œå¦åˆ™ä¸å¯èƒ½ä»å¤–éƒ¨è§‚å¯Ÿ Actor çš„å†…éƒ¨å¹¶æŒæ¡å…¶çŠ¶æ€ã€‚</p>

<h3 id="332-çŠ¶æ€">3.3.2. çŠ¶æ€</h3>
<p>Actor å¯¹è±¡é€šå¸¸åŒ…å«ä¸€äº›åæ˜  Actor å¯èƒ½å¤„äºçš„çŠ¶æ€çš„å˜é‡ã€‚è¿™å¯ä»¥æ˜¯ä¸€ä¸ªæ˜¾å¼çŠ¶æ€æœºï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨ã€Œ<a href="https://github.com/guobinhit/akka-guide/blob/master/articles/actors/fsm.md">FSM</a>ã€æ¨¡å—ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªè®¡æ•°å™¨ã€ä¸€ç»„ç›‘å¬å™¨ã€æŒ‚èµ·çš„è¯·æ±‚ç­‰ã€‚è¿™äº›æ•°æ®ä½¿ Actor æœ‰ä»·å€¼ï¼Œå¹¶ä¸”å¿…é¡»é˜²æ­¢å…¶ä»– Actor æŸåå®ƒä»¬ã€‚å¥½æ¶ˆæ¯æ˜¯ï¼Œä»æ¦‚å¿µä¸Šè®²ï¼ŒAkka çš„æ¯ä¸ª Actor éƒ½æœ‰è‡ªå·±çš„è½»é‡çº§çº¿ç¨‹ï¼Œè¿™å®Œå…¨ä¸ç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†éš”ç¦»å¼€æ¥ã€‚è¿™æ„å‘³ç€ï¼Œä¸å¿…ä½¿ç”¨é”æ¥åŒæ­¥è®¿é—®ï¼Œä½ å¯ä»¥ç¼–å†™ Actor ä»£ç ï¼Œè€Œä¸å¿…æ‹…å¿ƒå¹¶å‘æ€§ã€‚</p>

<p>åœ¨å¹•åï¼ŒAkka å°†åœ¨ä¸€ç»„çœŸæ­£çš„çº¿ç¨‹ä¸Šè¿è¡Œä¸€ç»„ Actorï¼Œåœ¨è¿™äº›çº¿ç¨‹ä¸­ï¼Œé€šå¸¸è®¸å¤š Actor å…±äº«ä¸€ä¸ªçº¿ç¨‹ï¼Œéšåå¯¹ä¸€ä¸ª Actor çš„è°ƒç”¨å¯èƒ½æœ€ç»ˆåœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šè¿›è¡Œå¤„ç†ã€‚Akka ç¡®ä¿è¿™ä¸ªå®ç°ç»†èŠ‚ä¸ä¼šå½±å“å¤„ç† Actor çš„çŠ¶æ€ã€‚</p>

<p>å› ä¸ºå†…éƒ¨çŠ¶æ€å¯¹ Actor çš„æ“ä½œè‡³å…³é‡è¦ï¼Œæ‰€ä»¥çŠ¶æ€ä¸ä¸€è‡´æ˜¯è‡´å‘½çš„ã€‚å› æ­¤ï¼Œå½“ Actor å¤±è´¥å¹¶ç”±å…¶ç›‘ç£è€…é‡æ–°å¯åŠ¨æ—¶ï¼Œå°†ä»å¤´å¼€å§‹åˆ›å»ºçŠ¶æ€ï¼Œå°±åƒç¬¬ä¸€æ¬¡åˆ›å»º Actor æ—¶ä¸€æ ·ã€‚è¿™æ˜¯ä¸ºäº†ä½¿ç³»ç»Ÿèƒ½å¤Ÿè‡ªæˆ‘ä¿®å¤ã€‚</p>

<p>æˆ–è€…ï¼Œå¯ä»¥é€šè¿‡æŒä¹…åŒ–æ¥æ”¶åˆ°çš„æ¶ˆæ¯å¹¶åœ¨é‡æ–°å¯åŠ¨åé‡æ’­ï¼ˆè¯·å‚è§ã€Œ<a href="https://github.com/guobinhit/akka-guide/blob/master/articles/actors/persistence.md">æŒä¹…åŒ–</a>ã€ï¼‰ï¼Œå°† Actor çš„çŠ¶æ€è‡ªåŠ¨æ¢å¤åˆ°é‡æ–°å¯åŠ¨å‰çš„çŠ¶æ€ã€‚</p>

<h3 id="333-è¡Œä¸º">3.3.3. è¡Œä¸º</h3>
<p>æ¯æ¬¡å¤„ç†æ¶ˆæ¯æ—¶ï¼Œå®ƒéƒ½ä¸ Actor çš„å½“å‰è¡Œä¸ºç›¸åŒ¹é…ã€‚è¡Œä¸ºï¼ˆ<code class="language-plaintext highlighter-rouge">Behavior</code>ï¼‰æŒ‡çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå®šä¹‰äº†åœ¨è¯¥æ—¶é—´ç‚¹å¯¹æ¶ˆæ¯åšå‡ºååº”æ—¶è¦é‡‡å–çš„æ“ä½œï¼Œä¾‹å¦‚ï¼Œå¦‚æœå®¢æˆ·ç«¯è¢«æˆæƒï¼Œå°±è½¬å‘ä¸€ä¸ªè¯·æ±‚ï¼Œå¦åˆ™å°±æ‹’ç»å®ƒã€‚è¿™ç§è¡Œä¸ºå¯èƒ½ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œæ”¹å˜ï¼Œä¾‹å¦‚ï¼Œç”±äºä¸åŒçš„å®¢æˆ·ç«¯éšç€æ—¶é—´çš„æ¨ç§»è€Œè·å¾—æˆæƒï¼Œæˆ–è€…å› ä¸º Actor å¯èƒ½ä¼šè¿›å…¥â€œåœæ­¢æœåŠ¡â€æ¨¡å¼ï¼Œç„¶åè¿”å›ã€‚è¿™äº›æ›´æ”¹æ˜¯é€šè¿‡ä»è¡Œä¸ºé€»è¾‘ä¸­è¯»å–çš„çŠ¶æ€å˜é‡ä¸­å¯¹å®ƒä»¬è¿›è¡Œç¼–ç æ¥å®ç°çš„ï¼Œæˆ–è€…å‡½æ•°æœ¬èº«å¯ä»¥åœ¨è¿è¡Œæ—¶äº¤æ¢å‡ºæ¥ï¼Œè¯·å‚é˜…<code class="language-plaintext highlighter-rouge">become</code>å’Œ<code class="language-plaintext highlighter-rouge">unbecome</code>æ“ä½œã€‚ä½†æ˜¯ï¼Œåœ¨æ„é€  Actor å¯¹è±¡æœŸé—´å®šä¹‰çš„åˆå§‹è¡Œä¸ºæ˜¯ç‰¹æ®Šçš„ï¼Œå› ä¸ºé‡æ–°å¯åŠ¨ Actor ä¼šå°†å…¶è¡Œä¸ºé‡ç½®ä¸ºåˆå§‹è¡Œä¸ºã€‚</p>

<h3 id="334-é‚®ç®±">3.3.4. é‚®ç®±</h3>
<p>Actor çš„ç›®çš„æ˜¯å¤„ç†æ¶ˆæ¯ï¼Œè¿™äº›æ¶ˆæ¯æ˜¯ä»å…¶ä»– Actorï¼ˆæˆ–ä» Actor ç³»ç»Ÿå¤–éƒ¨ï¼‰å‘é€ç»™ Actor çš„ã€‚è¿æ¥å‘é€æ–¹å’Œæ¥æ”¶æ–¹çš„éƒ¨åˆ†æ˜¯ Actor çš„é‚®ç®±ï¼šæ¯ä¸ª Actor åªæœ‰ä¸€ä¸ªé‚®ç®±ï¼Œæ‰€æœ‰å‘é€æ–¹éƒ½å°†å…¶ï¿½ï¿½ï¿½ï¿½æ¯æ’é˜Ÿã€‚æ’é˜Ÿæ˜¯æŒ‰å‘é€æ“ä½œçš„æ—¶é—´é¡ºåºå‘ç”Ÿçš„ï¼Œè¿™æ„å‘³ç€ç”±äºåœ¨çº¿ç¨‹é—´åˆ†å‘ Actor çš„æ˜æ˜¾éšæœºæ€§ï¼Œä¸åŒ Actor å‘é€çš„æ¶ˆæ¯åœ¨è¿è¡Œæ—¶å¯èƒ½æ²¡æœ‰å®šä¹‰é¡ºåºã€‚å¦ä¸€æ–¹é¢ï¼Œä»åŒä¸€ä¸ª Actor å‘åŒä¸€ä¸ªç›®æ ‡å‘é€å¤šæ¡æ¶ˆæ¯å°†ä»¥ç›¸åŒçš„é¡ºåºå°†å®ƒä»¬æ’é˜Ÿã€‚</p>

<p>æœ‰ä¸åŒçš„é‚®ç®±å®ç°å¯ä¾›é€‰æ‹©ï¼Œé»˜è®¤ä¸º<code class="language-plaintext highlighter-rouge">FIFO</code>ï¼šActor å¤„ç†çš„æ¶ˆæ¯çš„é¡ºåºä¸å®ƒä»¬æ’é˜Ÿçš„é¡ºåºåŒ¹é…ã€‚è¿™é€šå¸¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é»˜è®¤å€¼ï¼Œä½†æ˜¯åº”ç”¨ç¨‹åºå¯èƒ½éœ€è¦å°†æŸäº›æ¶ˆæ¯ä¼˜å…ˆäºå…¶ä»–æ¶ˆæ¯ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¼˜å…ˆçº§é‚®ç®±å°†ä¸æ€»æ˜¯åœ¨æœ«å°¾æ’é˜Ÿï¼Œè€Œæ˜¯åœ¨æ¶ˆæ¯ä¼˜å…ˆçº§æŒ‡å®šçš„ä½ç½®æ’é˜Ÿï¼Œç”šè‡³å¯èƒ½åœ¨å‰é¢ã€‚å½“ä½¿ç”¨è¿™æ ·çš„é˜Ÿåˆ—æ—¶ï¼Œå¤„ç†çš„æ¶ˆæ¯çš„é¡ºåºå°†è‡ªç„¶åœ°ç”±é˜Ÿåˆ—çš„ç®—æ³•å®šä¹‰ï¼Œé€šå¸¸ä¸æ˜¯<code class="language-plaintext highlighter-rouge">FIFO</code>ã€‚</p>

<p>Akka ä¸å…¶ä»–ä¸€äº› Actor æ¨¡å‹å®ç°ä¸åŒçš„ä¸€ä¸ªé‡è¦ç‰¹æ€§æ˜¯ï¼Œå½“å‰è¡Œä¸ºå¿…é¡»å§‹ç»ˆå¤„ç†ä¸‹ä¸€æ¡å‡ºåˆ—çš„æ¶ˆæ¯ï¼Œæ²¡æœ‰æ‰«æé‚®ç®±ä»¥æŸ¥æ‰¾ä¸‹ä¸€æ¡åŒ¹é…çš„æ¶ˆæ¯ã€‚é™¤éé‡å†™æ­¤è¡Œä¸ºï¼Œå¦åˆ™å¤„ç†æ¶ˆæ¯å¤±è´¥é€šå¸¸è¢«è§†ä¸ºå¤±è´¥ã€‚</p>

<h3 id="335-å­-actor">3.3.5. å­ Actor</h3>
<p>æ¯ä¸ª Actor éƒ½å¯èƒ½æ˜¯ä¸€ä¸ªç›‘ç£è€…ï¼šå¦‚æœå®ƒä¸ºåˆ†é…å­ä»»åŠ¡åˆ›å»ºå­ Actorï¼Œå®ƒå°†è‡ªåŠ¨å¯¹å®ƒä»¬è¿›è¡Œç›‘ç£ã€‚å­åˆ—è¡¨åœ¨ Actor çš„ä¸Šä¸‹æ–‡ä¸­ç»´æŠ¤ï¼Œå¹¶ä¸” Actor å¯ä»¥è®¿é—®å®ƒã€‚å¯¹åˆ—è¡¨çš„ä¿®æ”¹æ˜¯é€šè¿‡åˆ›å»º<code class="language-plaintext highlighter-rouge">(context.actorOf(...))</code>æˆ–åœæ­¢<code class="language-plaintext highlighter-rouge">(context.stop(child))</code>å­é¡¹æ¥å®Œæˆçš„ï¼Œè¿™äº›æ“ä½œä¼šç«‹å³åæ˜ å‡ºæ¥ã€‚å®é™…çš„åˆ›å»ºå’Œç»ˆæ­¢æ“ä½œä»¥å¼‚æ­¥æ–¹å¼åœ¨åå°å‘ç”Ÿï¼Œå› æ­¤å®ƒä»¬ä¸ä¼šâ€œé˜»å¡â€å…¶ç›‘ç£è€…ã€‚</p>

<h3 id="336-ç›‘ç£è€…ç­–ç•¥">3.3.6. ç›‘ç£è€…ç­–ç•¥</h3>
<p>Actor çš„æœ€åä¸€ä¸ªéƒ¨åˆ†æ˜¯å…¶å¤„ç†å­ Actor é”™è¯¯çš„ç­–ç•¥ã€‚å¯¹äºã€Œ<a href="https://github.com/guobinhit/akka-guide/blob/master/articles/general-concepts/supervision.md">ç›‘ç£å’Œç›‘æ§</a>ã€ä¸­æè¿°çš„æ¯ä¸€ä¸ªä¼ å…¥ç­–ç•¥ï¼ŒAkka å°†é€æ˜åœ°è¿›è¡Œæ•…éšœå¤„ç†ã€‚ç”±äºè¯¥ç­–ç•¥æ˜¯å¦‚ä½•æ„å»º Actor ç³»ç»Ÿçš„åŸºç¡€ï¼Œå› æ­¤ä¸€æ—¦åˆ›å»ºäº† Actorï¼Œå°±ä¸èƒ½æ›´æ”¹å®ƒã€‚</p>

<p>è€ƒè™‘åˆ°æ¯ä¸ª Actor åªæœ‰ä¸€ä¸ªè¿™æ ·çš„ç­–ç•¥ï¼Œè¿™æ„å‘³ç€å¦‚æœä¸åŒçš„ç­–ç•¥åº”ç”¨äºä¸€ä¸ª Actor çš„ä¸åŒå­ä»£ï¼Œé‚£ä¹ˆè¿™äº›å­ä»£åº”è¯¥æŒ‰ç…§åŒ¹é…çš„ç­–ç•¥åˆ†ç»„åˆ°ä¸­çº§ç›‘ç£è€…ä¹‹ä¸‹ï¼Œç„¶åæ ¹æ®ä»»åŠ¡æ‹†åˆ†ä¸ºå­ä»»åŠ¡ï¼Œå†ä¸€æ¬¡ç»„ç»‡ Actor ç³»ç»Ÿã€‚</p>

<h3 id="337-å½“-actor-ç»ˆæ­¢">3.3.7. å½“ Actor ç»ˆæ­¢</h3>
<p>ä¸€æ—¦ä¸€ä¸ª Actor ç»ˆæ­¢ï¼Œå³ä»¥ä¸€ç§ä¸è¢«é‡å¯å¤„ç†çš„æ–¹å¼å¤±è´¥ã€è‡ªè¡Œåœæ­¢æˆ–è¢«å…¶ç›‘ç£è€…åœæ­¢ï¼Œå®ƒå°†é‡Šæ”¾å…¶èµ„æºï¼Œå°†å…¶é‚®ç®±ä¸­çš„æ‰€æœ‰å‰©ä½™é‚®ä»¶æ’å…¥ç³»ç»Ÿçš„â€œæ­»ä¿¡é‚®ç®±â€ï¼Œè¯¥é‚®ç®±å°†å®ƒä»¬ä½œä¸ºæ­»ä¿¡ï¼ˆ<code class="language-plaintext highlighter-rouge">DeadLetters</code>ï¼‰è½¬å‘åˆ°äº‹ä»¶æµï¼ˆ<code class="language-plaintext highlighter-rouge">EventStream</code>ï¼‰ã€‚ç„¶ååœ¨ Actor å¼•ç”¨ä¸­ç”¨ç³»ç»Ÿé‚®ç®±æ›¿æ¢åŸ Actor çš„é‚®ç®±ï¼Œå°†æ‰€æœ‰æ–°æ¶ˆæ¯ä½œä¸ºæ­»ä¿¡é‡å®šå‘åˆ°äº‹ä»¶æµã€‚ä½†æ˜¯ï¼Œè¿™æ˜¯åœ¨å°½æœ€å¤§åŠªåŠ›çš„åŸºç¡€ä¸Šå®Œæˆçš„ï¼Œå› æ­¤ä¸è¦ä¾èµ–å®ƒæ¥æ„å»ºâ€œæœ‰ä¿è¯çš„æ¶ˆæ¯ä¼ é€’â€ã€‚</p>

<p>æˆ‘ä»¬çš„æµ‹è¯•å¯å‘äº†æˆ‘ä»¬ä¸åªæ˜¯é™é»˜åœ°è½¬å‚¨æ¶ˆæ¯çš„åŸå› ï¼šæˆ‘ä»¬åœ¨å‘é€æ­»ä¿¡çš„äº‹ä»¶æ€»çº¿ä¸Šæ³¨å†Œ<code class="language-plaintext highlighter-rouge">TestEventListener</code>ï¼Œå®ƒå°†è®°å½•æ”¶åˆ°çš„æ¯ä¸ªæ­»ä¿¡çš„è­¦å‘Šï¼Œè¿™å¯¹äºæ›´å¿«åœ°ç ´è¯‘æµ‹è¯•å¤±è´¥éå¸¸æœ‰å¸®åŠ©ã€‚å¯ä»¥æƒ³è±¡ï¼Œæ­¤åŠŸèƒ½ä¹Ÿå¯ä»¥ç”¨äºå…¶ä»–ç›®çš„ã€‚</p>

<hr />

<p><strong>è‹±æ–‡åŸæ–‡é“¾æ¥</strong>ï¼š<a href="https://doc.akka.io/docs/akka/current/general/actors.html">What is an Actor?</a>.</p>

<h2 id="34-ç›‘ç£å’Œç›‘æ§">3.4. ç›‘ç£å’Œç›‘æ§</h2>
<p>æœ¬ç« æ¦‚è¿°äº†ç›‘ç£ï¼ˆ<code class="language-plaintext highlighter-rouge">supervision</code>ï¼‰èƒŒåçš„æ¦‚å¿µã€æä¾›çš„åŸè¯­åŠå…¶è¯­ä¹‰ã€‚æœ‰å…³å¦‚ä½•è½¬æ¢ä¸ºçœŸå®ä»£ç çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… Scala å’Œ Java API çš„ç›¸åº”ç« èŠ‚ã€‚</p>

<h3 id="341-ç¤ºä¾‹é¡¹ç›®">3.4.1. ç¤ºä¾‹é¡¹ç›®</h3>
<p>ä½ å¯ä»¥æŸ¥çœ‹ã€Œ<a href="https://developer.lightbend.com/start/?group=akka&amp;project=akka-samples-supervision-java">ç›‘ç£ç¤ºä¾‹é¡¹ç›®</a>ã€ï¼Œä»¥äº†è§£å®é™…ä½¿ç”¨çš„æƒ…å†µã€‚</p>

<h3 id="342-ç›‘ç£æ„å‘³ç€ä»€ä¹ˆ">3.4.2. ç›‘ç£æ„å‘³ç€ä»€ä¹ˆï¼Ÿ</h3>
<p>æ­£å¦‚ã€Œ<a href="https://github.com/guobinhit/akka-guide/blob/master/articles/general-concepts/actor-systems.md">Actor ç³»ç»Ÿ</a>ã€ä¸­ç›‘ç£æ‰€æè¿°çš„ï¼ŒActor ä¹‹é—´çš„ä¾èµ–å…³ç³»æ˜¯ï¼š<code class="language-plaintext highlighter-rouge">supervisor</code>å°†ä»»åŠ¡å§”æ‰˜ç»™å­çº§ï¼Œå› æ­¤å¿…é¡»å¯¹å…¶å¤±è´¥ä½œå‡ºå“åº”ã€‚å½“å­çº§æ£€æµ‹åˆ°æ•…éšœï¼ˆå³æŠ›å‡ºå¼‚å¸¸ï¼‰æ—¶ï¼Œå®ƒä¼šæŒ‚èµ·è‡ªèº«åŠå…¶æ‰€æœ‰ä¸‹çº§ï¼Œå¹¶å‘å…¶ç›‘ç£è€…å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯æ•…éšœä¿¡å·ã€‚æ ¹æ®ç›‘ç£å·¥ä½œçš„æ€§è´¨å’Œå¤±è´¥çš„æ€§è´¨ï¼Œç›‘ç£è€…æœ‰ä»¥ä¸‹å››ç§é€‰æ‹©ï¼š</p>

<ul>
  <li>æ¢å¤å­çº§ï¼Œä¿æŒå…¶ç´¯ç§¯çš„å†…éƒ¨çŠ¶æ€</li>
  <li>é‡æ–°å¯åŠ¨å­çº§ï¼Œæ¸…é™¤å…¶ç´¯ç§¯çš„å†…éƒ¨çŠ¶æ€</li>
  <li>æ°¸ä¹…åœæ­¢å­çº§</li>
  <li>ä½¿å¤±è´¥å‡çº§ï¼Œä»è€Œä½¿è‡ªå·±å¤±è´¥ï¼ˆ<em>è¯‘è€…è¯´ï¼Œå³ç»§ç»­å‘ä¸Šä¸€çº§ç›‘ç£è€…å‘é€å¤±è´¥æ¶ˆæ¯</em>ï¼‰</li>
</ul>

<p>å§‹ç»ˆå°†ä¸€ä¸ª Actor è§†ä¸ºç›‘ç®¡å±‚çº§çš„ä¸€éƒ¨åˆ†æ˜¯å¾ˆé‡è¦çš„ï¼Œè¿™è§£é‡Šäº†ç¬¬å››ä¸ªé€‰æ‹©çš„å­˜åœ¨ï¼ˆä½œä¸ºä¸€ä¸ªç›‘ç£è€…ä¹Ÿä»å±äºä¸Šä¸€çº§çš„å¦ä¸€ä¸ªç›‘ç£è€…ï¼‰ï¼Œå¹¶å¯¹å‰ä¸‰ä¸ªæœ‰å½±å“ï¼šæ¢å¤ä¸€ä¸ª Actor æ¢å¤å…¶æ‰€æœ‰å­çº§ï¼Œé‡æ–°å¯åŠ¨ä¸€ä¸ª Actor éœ€è¦é‡æ–°å¯åŠ¨å…¶æ‰€æœ‰å­çº§ï¼ˆå¦‚éœ€æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ä¸‹æ–‡ï¼‰ï¼ŒåŒæ ·ï¼Œç»ˆæ­¢ Actor ä¹Ÿå°†ç»ˆæ­¢å…¶æ‰€æœ‰å­çº§ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code class="language-plaintext highlighter-rouge">Actor</code>ç±»çš„<code class="language-plaintext highlighter-rouge">preRestart</code>é’©å­çš„é»˜è®¤è¡Œä¸ºæ˜¯åœ¨é‡æ–°å¯åŠ¨ä¹‹å‰ç»ˆæ­¢å®ƒçš„æ‰€æœ‰å­çº§ï¼Œä½†æ˜¯è¿™ä¸ªé’©å­å¯ä»¥è¢«é‡å†™ï¼›é€’å½’é‡æ–°å¯åŠ¨åº”ç”¨äºæ‰§è¡Œè¿™ä¸ªé’©å­ä¹‹åå‰©ä¸‹çš„æ‰€æœ‰å­çº§ã€‚</p>

<p>æ¯ä¸ªç›‘ç£è€…éƒ½é…ç½®äº†ä¸€ä¸ªå‡½æ•°ï¼Œå°†æ‰€æœ‰å¯èƒ½çš„æ•…éšœåŸå› ï¼ˆå³å¼‚å¸¸ï¼‰è½¬æ¢ä¸ºä¸Šé¢ç»™å‡ºçš„å››ä¸ªé€‰é¡¹ä¹‹ä¸€ï¼›å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¯¥å‡½æ•°ä¸å°†æ•…éšœ Actor çš„èº«ä»½ï¼ˆ<code class="language-plaintext highlighter-rouge">identity</code>ï¼‰ä½œä¸ºè¾“å…¥ã€‚è¿™æ ·çš„ç»“æ„ä¼¼ä¹ä¸å¤Ÿçµæ´»ï¼Œå¾ˆå®¹æ˜“æ‰¾åˆ°ç±»ä¼¼çš„ä¾‹å­ï¼Œä¾‹å¦‚å¸Œæœ›å°†ä¸åŒçš„ç­–ç•¥åº”ç”¨äºä¸åŒçš„å­çº§ã€‚åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œé‡è¦çš„æ˜¯è¦ç†è§£ç›‘ç£æ˜¯å…³äºå½¢æˆä¸€ä¸ªé€’å½’çš„æ•…éšœå¤„ç†ç»“æ„ã€‚å¦‚æœä½ è¯•å›¾åœ¨ä¸€ä¸ªå±‚é¢ä¸Šåšçš„å¤ªå¤šï¼Œå°±å¾ˆéš¾è§£é‡Šäº†ï¼Œå› æ­¤åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå»ºè®®çš„æ–¹æ³•æ˜¯å¢åŠ ä¸€ä¸ªå±‚é¢ï¼ˆ<code class="language-plaintext highlighter-rouge">level</code>ï¼‰çš„ç›‘ç£ã€‚</p>

<p>Akka å®ç°äº†ä¸€ç§ç§°ä¸ºâ€œçˆ¶æ¯ç›‘ç£ï¼ˆ<code class="language-plaintext highlighter-rouge">parental supervision</code>ï¼‰â€çš„ç‰¹æ®Šå½¢å¼ã€‚Actor åªèƒ½ç”±å…¶ä»– Actor åˆ›å»ºï¼Œå…¶ä¸­é¡¶çº§ Actor ç”±åº“æä¾›ï¼Œæ¯ä¸ªåˆ›å»ºçš„ Actor éƒ½ç”±å…¶çˆ¶ Actor ç›‘ç£ã€‚è¿™ç§é™åˆ¶ä½¿å¾— Actor ç›‘ç£å±‚æ¬¡çš„å½¢æˆå˜å¾—å«è“„ï¼Œå¹¶é¼“åŠ±åšå‡ºåˆç†çš„è®¾è®¡å†³ç­–ã€‚åº”å½“æŒ‡å‡ºçš„æ˜¯ï¼Œè¿™ä¹Ÿä¿è¯äº† Actor ä¸èƒ½æˆä¸ºå­¤å„¿ï¼Œä¹Ÿä¸èƒ½ä»å¤–éƒ¨ä¾é™„äºç›‘ç®¡è€…ï¼Œå¦åˆ™ä»–ä»¬å¯èƒ½ä¼šä¸çŸ¥ä¸è§‰åœ°è¢«æŠ“èµ·æ¥ï¼ˆ<code class="language-plaintext highlighter-rouge">which might otherwise catch them unawares</code>ï¼‰ã€‚æ­¤å¤–ï¼Œè¿™ä¹Ÿä¸º Actor åº”ç”¨ç¨‹åºï¼ˆå­æ ‘ï¼Œ<code class="language-plaintext highlighter-rouge">sub-trees of</code>ï¼‰ç”Ÿæˆäº†ä¸€ä¸ªè‡ªç„¶ã€å¹²å‡€çš„å…³é—­è¿‡ç¨‹ã€‚</p>

<ul>
  <li><strong>è­¦å‘Š</strong>ï¼šä¸ç›‘ç£ï¼ˆ<code class="language-plaintext highlighter-rouge">supervision</code>ï¼‰ç›¸å…³çš„çˆ¶å­é€šä¿¡é€šè¿‡ç‰¹æ®Šçš„ç³»ç»Ÿæ¶ˆæ¯è¿›è¡Œï¼Œè¿™äº›æ¶ˆæ¯çš„é‚®ç®±ä¸ç”¨æˆ·æ¶ˆæ¯åˆ†å¼€ã€‚è¿™æ„å‘³ç€ä¸ç›‘ç£ç›¸å…³çš„äº‹ä»¶å¹¶ä¸æ˜¯ç›¸å¯¹äºæ™®é€šæ¶ˆæ¯ç¡®å®šçš„é¡ºåºã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç”¨æˆ·ä¸èƒ½å½±å“æ­£å¸¸æ¶ˆæ¯å’Œæ•…éšœé€šçŸ¥çš„é¡ºåºã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯å’Œç¤ºä¾‹ï¼Œè¯·å‚é˜…ã€Œ<a href="https://github.com/guobinhit/akka-guide/blob/master/articles/general-concepts/message-delivery-reliability.md#%E8%AE%A8%E8%AE%BA%E6%B6%88%E6%81%AF%E6%8E%92%E5%BA%8F">è®¨è®ºï¼šæ¶ˆæ¯æ’åº</a>ã€éƒ¨åˆ†ã€‚</li>
</ul>

<h3 id="343-é¡¶çº§ç›‘ç£è€…">3.4.3. é¡¶çº§ç›‘ç£è€…</h3>
<p><img src="https://github.com/guobinhit/akka-guide/blob/master/images/supervision/top-level-supervisors.png" alt="top-level-supervisors" /></p>

<p>ä¸€ä¸ª Actor ç³»ç»Ÿåœ¨åˆ›å»ºè¿‡ç¨‹ä¸­è‡³å°‘ä¼šå¯åŠ¨ä¸‰ä¸ª Actorï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºã€‚æœ‰å…³ Actor è·¯å¾„çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…ã€Œ<a href="https://github.com/guobinhit/akka-guide/blob/master/articles/general-concepts/addressing.md#actor-%E8%B7%AF%E5%BE%84%E7%9A%84%E9%A1%B6%E7%BA%A7%E8%8C%83%E5%9B%B4">Actor è·¯å¾„çš„é¡¶çº§èŒƒå›´</a>ã€ã€‚</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/user</code>: The Guardian Actorï¼Œæœ€å¯èƒ½ä¸ä¹‹äº¤äº’çš„ Actor æ˜¯æ‰€æœ‰ç”¨æˆ·åˆ›å»ºçš„ Actor çš„çˆ¶çº§ï¼Œå®ˆæŠ¤è€…åä¸º<code class="language-plaintext highlighter-rouge">/user</code>ã€‚ä½¿ç”¨<code class="language-plaintext highlighter-rouge">system.actorOf()</code>åˆ›å»ºçš„ Actor æ˜¯æ­¤ Actor çš„å­çº§ã€‚è¿™æ„å‘³ç€å½“è¿™ä¸ªå®ˆæŠ¤è€…ç»ˆæ­¢æ—¶ï¼Œç³»ç»Ÿä¸­çš„æ‰€æœ‰æ­£å¸¸ Actor ä¹Ÿå°†å…³é—­ã€‚è¿™ä¹Ÿæ„å‘³ç€å®ˆæŠ¤è€…çš„ç›‘ç®¡ç­–ç•¥å†³å®šäº†é¡¶çº§æ­£å¸¸ Actor çš„ç›‘ç£æ–¹å¼ã€‚è‡ª Akka 2.1 å¼€å§‹ï¼Œå¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">akka.actor.guardian-supervisor-strategy</code>æ¥é…ç½®å®ƒï¼Œè¯¥è®¾ç½®é‡‡ç”¨äº†ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">SupervisorStrategyConfigurator</code>çš„å®Œå…¨é™å®šç±»åã€‚å½“å®ˆæŠ¤è€…å‡çº§å¤±è´¥æ—¶ï¼Œæ ¹å®ˆæŠ¤è€…çš„å“åº”å°†ä¼šç»ˆæ­¢å®ˆæŠ¤è€…ï¼Œè¿™å®é™…ä¸Šå°†å…³é—­æ•´ä¸ª Actor ç³»ç»Ÿã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">/system</code>: The System Guardianï¼Œä¸ºäº†å®ç°æœ‰åºçš„å…³é—­é¡ºåºï¼Œå¼•å…¥äº†è¿™ä¸ªç‰¹æ®Šçš„å®ˆæŠ¤è€…ï¼Œå½“æ‰€æœ‰æ­£å¸¸çš„ Actor éƒ½ç»ˆæ­¢ï¼Œæ—¥å¿—è®°å½•ä¹Ÿä¿æŒæ´»åŠ¨çŠ¶æ€ï¼Œå³ä½¿æ—¥å¿—è®°å½•æœ¬èº«ä¹Ÿæ˜¯ä½¿ç”¨ Actor å®ç°çš„ã€‚è¿™æ˜¯é€šè¿‡è®©ç³»ç»Ÿå®ˆæŠ¤è€…ç›‘è§†ï¼ˆ<code class="language-plaintext highlighter-rouge">watch</code>ï¼‰ç”¨æˆ·å®ˆæŠ¤è€…å¹¶åœ¨æ¥æ”¶åˆ°<code class="language-plaintext highlighter-rouge">Terminated</code>æ¶ˆæ¯æ—¶å¯åŠ¨è‡ªå·±çš„å…³é—­æ¥å®ç°çš„ã€‚é¡¶å±‚ç³»ç»Ÿ Actor ä½¿ç”¨ä¸€ç§ç­–ç•¥è¿›è¡Œç›‘ç£ï¼Œè¯¥ç­–ç•¥å°†åœ¨æ‰€æœ‰ç±»å‹çš„<code class="language-plaintext highlighter-rouge">Exception</code>ï¼ˆå…¶ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">ActorInitializationException</code>å’Œ<code class="language-plaintext highlighter-rouge">ActorKilledException</code>é™¤å¤–ï¼‰ä¸Šæ— é™æœŸé‡æ–°å¯åŠ¨ï¼Œè¿™å°†ç»ˆæ­¢ç›¸å…³çš„å­çº§ã€‚æ‰€æœ‰å…¶ä»–å¯æŠ›çš„å¼‚å¸¸äº‹ä»¶éƒ½ä¼šå‡çº§ï¼Œè¿™å°†å…³é—­æ•´ä¸ª Actor ç³»ç»Ÿã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">/</code>: The Root Guardianï¼Œæ ¹å®ˆæŠ¤è€…æ˜¯æ‰€æœ‰æ‰€è°“çš„â€œé¡¶çº§â€ Actor çš„ç¥–çˆ¶ï¼ˆ<code class="language-plaintext highlighter-rouge">grand-parent</code>ï¼‰çº§ï¼Œå¹¶ä½¿ç”¨<code class="language-plaintext highlighter-rouge">SupervisorStrategy.stoppingStrategy</code>ç›‘ç£ã€Œ<a href="https://github.com/guobinhit/akka-guide/blob/master/articles/general-concepts/addressing.md#actor-%E8%B7%AF%E5%BE%84%E7%9A%84%E9%A1%B6%E7%BA%A7%E8%8C%83%E5%9B%B4">Actor è·¯å¾„çš„é¡¶çº§èŒƒå›´</a>ã€ä¸­æåˆ°çš„æ‰€æœ‰ç‰¹æ®Š Actorï¼Œå…¶ç›®çš„æ˜¯åœ¨ä»»ä½•ç±»å‹çš„<code class="language-plaintext highlighter-rouge">Exception</code>æƒ…å†µä¸‹ç»ˆæ­¢å­ Actorã€‚æ‰€æœ‰å…¶ä»–å¯æŠ›çš„å¼‚å¸¸éƒ½ä¼šå‡çº§â€¦â€¦ä½†æ˜¯ç»™è°ï¼Ÿå› ä¸ºæ¯ä¸ªçœŸæ­£çš„ Actor éƒ½æœ‰ä¸€ä¸ªç›‘ç£è€…ï¼Œæ‰€ä»¥æ ¹å®ˆæŠ¤è€…çš„ç›‘ç£è€…ä¸èƒ½æ˜¯çœŸæ­£çš„ Actorã€‚å› ä¸ºè¿™æ„å‘³ç€å®ƒæ˜¯åœ¨â€œæ°”æ³¡çš„å¤–é¢â€ï¼Œæ‰€ä»¥å®ƒè¢«ç§°ä¸ºâ€œæ°”æ³¡è¡Œè€…ï¼ˆ<code class="language-plaintext highlighter-rouge">bubble-walker</code>ï¼‰â€ã€‚è¿™æ˜¯ä¸€ä¸ªè™šæ„çš„<code class="language-plaintext highlighter-rouge">ActorRef</code>ï¼Œå®ƒåœ¨å‡ºç°é—®é¢˜çš„ç¬¬ä¸€ä¸ªå¾å…†æ—¶åœæ­¢å…¶å­ç³»ç»Ÿï¼Œå¹¶åœ¨æ ¹å®ˆæŠ¤ç¨‹åºå®Œå…¨ç»ˆæ­¢ï¼ˆæ‰€æœ‰å­ç³»ç»Ÿé€’å½’åœæ­¢ï¼‰åå°† Actor ç³»ç»Ÿçš„<code class="language-plaintext highlighter-rouge">isTerminated</code>çŠ¶æ€è®¾ç½®ä¸º<code class="language-plaintext highlighter-rouge">true</code>ã€‚</li>
</ul>

<h3 id="344-é‡å¯æ„å‘³ç€ä»€ä¹ˆ">3.4.4. é‡å¯æ„å‘³ç€ä»€ä¹ˆï¼Ÿ</h3>
<p>å½“ä¸å¤„ç†ç‰¹å®šæ¶ˆæ¯æ—¶å¤±è´¥çš„ Actor ä¸€èµ·å‡ºç°æ—¶ï¼Œå¤±è´¥çš„åŸå› åˆ†ä¸ºä¸‰ç±»ï¼š</p>

<ul>
  <li>æ¥æ”¶åˆ°ç‰¹å®šçš„ç³»ç»Ÿæ€§ï¼ˆå³ç¼–ç¨‹ï¼‰é”™è¯¯æ¶ˆæ¯</li>
  <li>å¤„ç†æ¶ˆæ¯è¿‡ç¨‹ä¸­ä½¿ç”¨çš„æŸäº›å¤–éƒ¨èµ„æºå‡ºç°æ•…éšœ</li>
  <li>Actor çš„å†…éƒ¨çŠ¶æ€å·²æŸå</li>
</ul>

<p>é™¤éèƒ½æ˜ç¡®è¯†åˆ«æ•…éšœï¼Œå¦åˆ™ä¸èƒ½æ’é™¤ç¬¬ä¸‰ç§åŸå› ï¼Œè¿™å°±å¯¼è‡´äº†å†…éƒ¨çŠ¶æ€éœ€è¦æ¸…é™¤çš„ç»“è®ºã€‚å¦‚æœç›‘ç£è€…å†³å®šå…¶å…¶ä»–å­çº§æˆ–æœ¬èº«ä¸å—æŸåçš„å½±å“ï¼Œä¾‹å¦‚ï¼Œç”±äºæœ‰æ„è¯†åœ°åº”ç”¨äº†é”™è¯¯å†…æ ¸æ¨¡å¼ï¼Œå› æ­¤æœ€å¥½é‡æ–°å¯åŠ¨å­çº§ã€‚è¿™æ˜¯é€šè¿‡åˆ›å»ºåº•å±‚<code class="language-plaintext highlighter-rouge">Actor</code>ç±»çš„æ–°å®ä¾‹å¹¶å°†å¤±è´¥çš„å®ä¾‹æ›¿æ¢ä¸ºå­<code class="language-plaintext highlighter-rouge">ActorRef</code>ä¸­çš„æ–°å®ä¾‹æ¥å®ç°çš„ï¼›è¿™æ ·åšçš„èƒ½åŠ›æ˜¯å°† Actor å°è£…åœ¨ç‰¹æ®Šå¼•ç”¨ä¸­çš„åŸå› ä¹‹ä¸€ã€‚ç„¶åï¼Œæ–°çš„ Actor å°†ç»§ç»­å¤„ç†å…¶é‚®ç®±ï¼Œè¿™æ„å‘³ç€é‡æ–°å¯åŠ¨åœ¨ Actor é™¤æœ¬èº«ä¹‹å¤–æ˜¯ä¸å¯è§çš„ï¼Œä½†æœ‰ä¸€ä¸ªæ˜æ˜¾çš„ä¾‹å¤–ï¼Œå³å‘ç”Ÿæ•…éšœçš„æ¶ˆæ¯ä¸ä¼šè¢«é‡æ–°å¤„ç†ã€‚</p>

<p>é‡æ–°å¯åŠ¨æœŸé—´äº‹ä»¶çš„ç²¾ç¡®é¡ºåºå¦‚ä¸‹ï¼š</p>

<ol>
  <li>æŒ‚èµ· Actorï¼ˆè¿™æ„å‘³ç€åœ¨æ¢å¤ä¹‹å‰å®ƒä¸ä¼šå¤„ç†æ­£å¸¸æ¶ˆæ¯ï¼‰ï¼Œå¹¶é€’å½’æŒ‚èµ·æ‰€æœ‰å­çº§</li>
  <li>è°ƒç”¨æ—§å®ä¾‹çš„<code class="language-plaintext highlighter-rouge">preRestart</code>é’©å­ï¼ˆé»˜è®¤ä¸ºå‘æ‰€æœ‰å­å®ä¾‹å‘é€ç»ˆæ­¢è¯·æ±‚å¹¶è°ƒç”¨<code class="language-plaintext highlighter-rouge">postStop</code>ï¼‰</li>
  <li>ç­‰å¾…åœ¨<code class="language-plaintext highlighter-rouge">preRestart</code>æœŸé—´è¢«è¯·æ±‚ç»ˆæ­¢ï¼ˆä½¿ç”¨<code class="language-plaintext highlighter-rouge">context.stop()</code>ï¼‰çš„æ‰€æœ‰å­çº§å®é™…ç»ˆæ­¢ï¼›å°±åƒæ‰€æœ‰ Actor æ“ä½œéƒ½æ˜¯éé˜»å¡çš„ä¸€æ ·ï¼Œæœ€åä¸€ä¸ªè¢«æ€æ­»çš„å­çº§çš„ç»ˆæ­¢é€šçŸ¥å°†å½±å“åˆ°ä¸‹ä¸€æ­¥çš„è¿›å±•ã€‚</li>
  <li>é€šè¿‡å†æ¬¡è°ƒç”¨æœ€åˆæä¾›çš„å·¥å‚æ¥åˆ›å»ºæ–°çš„ Actor å®ä¾‹</li>
  <li>åœ¨æ–°å®ä¾‹ä¸Šè°ƒç”¨<code class="language-plaintext highlighter-rouge">postRestart</code>ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥å®ä¾‹è¿˜è°ƒç”¨<code class="language-plaintext highlighter-rouge">preStart</code>ï¼‰</li>
  <li>å‘æ­¥éª¤ 3 ä¸­æœªæ€æ­»çš„æ‰€æœ‰å­çº§å‘é€é‡æ–°å¯åŠ¨è¯·æ±‚ï¼›ä»æ­¥éª¤ 2 å¼€å§‹ï¼Œé‡æ–°å¯åŠ¨çš„å­çº§å°†é€’å½’åœ°æ‰§è¡Œç›¸åŒçš„è¿‡ç¨‹ã€‚</li>
  <li>æ¢å¤ Actor</li>
</ol>

<h3 id="345-ç”Ÿå‘½å‘¨æœŸç›‘æ§æ„å‘³ç€ä»€ä¹ˆ">3.4.5. ç”Ÿå‘½å‘¨æœŸç›‘æ§æ„å‘³ç€ä»€ä¹ˆï¼Ÿ</h3>
<ul>
  <li><strong>æ³¨é‡Š</strong>ï¼šAkka ä¸­çš„ç”Ÿå‘½å‘¨æœŸç›‘æ§é€šå¸¸è¢«ç§°ä¸º<code class="language-plaintext highlighter-rouge">DeathWatch</code>ã€‚</li>
</ul>

<p>ä¸ä¸Šé¢æè¿°çš„çˆ¶æ¯å’Œå­å¥³ä¹‹é—´çš„ç‰¹æ®Šå…³ç³»ä¸åŒï¼Œæ¯ä¸ª Actor å¯ä»¥ç›‘è§†ï¼ˆ<code class="language-plaintext highlighter-rouge">monitor</code>ï¼‰ä»»ä½•å…¶ä»– Actorã€‚ç”±äº Actor ä»å®Œå…¨æ´»è·ƒåœ°åˆ›é€ ä¸­å‡ºç°ï¼Œå¹¶ä¸”åœ¨å—å½±å“çš„ç›‘ç£è€…ä¹‹å¤–æ— æ³•çœ‹åˆ°é‡æ–°å¯åŠ¨ï¼Œå› æ­¤å¯ç”¨äºç›‘æ§çš„å”¯ä¸€çŠ¶æ€æ›´æ”¹æ˜¯ä»æ´»è·ƒåˆ°æ­»äº¡çš„è¿‡æ¸¡ã€‚å› æ­¤ï¼Œç›‘æ§ï¼ˆ<code class="language-plaintext highlighter-rouge">Monitoring</code>ï¼‰è¢«ç”¨æ¥å°†ä¸€ä¸ª Actor ä¸å¦ä¸€ä¸ª Actor è”ç³»èµ·æ¥ï¼Œè¿™æ ·å®ƒå°±å¯ä»¥å¯¹å¦ä¸€ä¸ª Actor çš„ç»ˆæ­¢åšå‡ºååº”ï¼Œè€Œä¸æ˜¯å¯¹å¤±è´¥åšå‡ºååº”çš„ç›‘ç£ã€‚</p>

<p>ç”Ÿå‘½å‘¨æœŸç›‘æ§æ˜¯ä½¿ç”¨ç›‘æ§ Actor è¦æ¥æ”¶çš„<code class="language-plaintext highlighter-rouge">Terminated</code>æ¶ˆæ¯æ¥å®ç°çš„ï¼Œåœ¨è¯¥æ¶ˆæ¯ä¸­ï¼Œé»˜è®¤è¡Œä¸ºæ˜¯å¦‚æœä¸è¿›è¡Œå…¶ä»–å¤„ç†ï¼Œåˆ™æŠ›å‡ºä¸€ä¸ªç‰¹æ®Šçš„<code class="language-plaintext highlighter-rouge">DeathPactException</code>ã€‚ä¸ºäº†å¼€å§‹ç›‘å¬<code class="language-plaintext highlighter-rouge">Terminated</code>æ¶ˆæ¯ï¼Œéœ€è¦è°ƒç”¨<code class="language-plaintext highlighter-rouge">ActorContext.watch(targetActorRef)</code>ã€‚è‹¥è¦åœæ­¢ç›‘å¬ï¼Œåˆ™éœ€è¦è°ƒç”¨<code class="language-plaintext highlighter-rouge">ActorContext.unwatch(targetActorRef)</code>ã€‚ä¸€ä¸ªé‡è¦çš„å±æ€§æ˜¯ï¼Œä¸ç®¡ç›‘æ§è¯·æ±‚å’Œç›®æ ‡ç»ˆæ­¢çš„é¡ºåºå¦‚ä½•ï¼Œæ¶ˆæ¯éƒ½å°†è¢«ä¼ é€’ï¼Œå³ä½¿åœ¨æ³¨å†Œæ—¶ç›®æ ‡å·²ç»æ­»äº†ï¼Œä½ ä»ç„¶ä¼šæ”¶åˆ°æ¶ˆæ¯ã€‚</p>

<p>å¦‚æœç›‘ç£è€…æ— æ³•é‡æ–°å¯åŠ¨å…¶å­çº§ï¼Œå¹¶ä¸”å¿…é¡»ç»ˆæ­¢å®ƒä»¬ï¼ˆä¾‹å¦‚ï¼Œåœ¨ Actor åˆå§‹åŒ–æœŸé—´å‘ç”Ÿé”™è¯¯æ—¶ï¼‰ï¼Œåˆ™ç›‘æ§ç‰¹åˆ«æœ‰ç”¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒåº”è¯¥ç›‘æ§è¿™äº›å­çº§å¹¶é‡æ–°åˆ›å»ºå®ƒä»¬ï¼Œæˆ–è€…è®¡åˆ’è‡ªå·±åœ¨ç¨åé‡è¯•ã€‚</p>

<p>å¦ä¸€ä¸ªå¸¸è§çš„ç”¨ä¾‹æ˜¯ï¼ŒActor éœ€è¦åœ¨ç¼ºå°‘å¤–éƒ¨èµ„æºçš„æƒ…å†µä¸‹å¤±è´¥ï¼Œå¤–éƒ¨èµ„æºä¹Ÿå¯èƒ½æ˜¯å…¶è‡ªå·±çš„å­èµ„æºä¹‹ä¸€ã€‚å¦‚æœç¬¬ä¸‰æ–¹é€šè¿‡<code class="language-plaintext highlighter-rouge">system.stop(child)</code>æ–¹æ³•æˆ–å‘é€<code class="language-plaintext highlighter-rouge">PoisonPill</code>ç»ˆæ­¢å­çº§ï¼Œåˆ™ç›‘ç£è€…å¯èƒ½ä¼šå—åˆ°å½±å“ã€‚</p>

<h4 id="3451-ä½¿ç”¨-backoffsupervisor-æ¨¡å¼å»¶è¿Ÿé‡æ–°å¯åŠ¨">3.4.5.1. ä½¿ç”¨ BackoffSupervisor æ¨¡å¼å»¶è¿Ÿé‡æ–°å¯åŠ¨</h4>
<p>ä½œä¸ºå†…ç½®æ¨¡å¼æä¾›çš„<code class="language-plaintext highlighter-rouge">akka.pattern.BackoffSupervisor</code>å®ç°äº†æ‰€è°“çš„æŒ‡æ•°é€€é¿ç›‘ç£ç­–ç•¥ï¼Œåœ¨å¤±è´¥æ—¶å†æ¬¡å¯åŠ¨å­ Actorï¼Œå¹¶ä¸”æ¯æ¬¡é‡æ–°å¯åŠ¨ä¹‹é—´çš„æ—¶é—´å»¶è¿Ÿè¶Šæ¥è¶Šå¤§ã€‚</p>

<p>å½“å¯åŠ¨çš„ Actor å¤±è´¥ï¼ˆæ•…éšœå¯ä»¥ç”¨ä¸¤ç§ä¸åŒçš„æ–¹å¼æ¥è¡¨ç¤ºï¼Œé€šè¿‡ä¸€ä¸ª Actor åœæ­¢æˆ–å´©æºƒï¼‰æ—¶ï¼Œæ­¤æ¨¡å¼éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºæŸäº›å¤–éƒ¨èµ„æºä¸å¯ç”¨ï¼Œæˆ‘ä»¬éœ€è¦ç»™å®ƒä¸€äº›æ—¶é—´é‡æ–°å¯åŠ¨ã€‚ä¸€ä¸ªä¸»è¦ç¤ºä¾‹æ˜¯å½“ã€Œ<a href="https://github.com/guobinhit/akka-guide/blob/master/articles/actors/persistence.md">PersistentActor</a>ã€å› æŒä¹…æ€§å¤±è´¥è€Œå¤±è´¥ï¼ˆé€šè¿‡åœæ­¢ï¼‰æ—¶ï¼Œè¿™è¡¨æ˜æ•°æ®åº“å¯èƒ½å·²å…³é—­æˆ–è¿‡è½½ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåœ¨å¯åŠ¨æŒä¹…æ€§ Actor ä¹‹å‰ç»™å®ƒä¸€ç‚¹æ—¶é—´æ¥æ¢å¤æ˜¯å¾ˆæœ‰æ„ä¹‰çš„ã€‚</p>

<p>ä¸‹é¢çš„ Scala ç‰‡æ®µæ¼”ç¤ºäº†å¦‚ä½•åˆ›å»ºä¸€ä¸ªé€€é¿ç›‘ç£è€…ï¼Œåœ¨ç»™å®šçš„ EchoActor å› æ•…éšœåœæ­¢åï¼Œè¯¥ç›‘ç£è€…å°†ä»¥ 3ã€6ã€12ã€24 å’Œæœ€å 30 ç§’çš„é—´éš”å¯åŠ¨ï¼š</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">val</span> <span class="nv">childProps</span> <span class="k">=</span> <span class="nc">Props</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">EchoActor</span><span class="o">])</span>

<span class="k">val</span> <span class="nv">supervisor</span> <span class="k">=</span> <span class="nv">BackoffSupervisor</span><span class="o">.</span><span class="py">props</span><span class="o">(</span>
  <span class="nv">Backoff</span><span class="o">.</span><span class="py">onStop</span><span class="o">(</span>
    <span class="n">childProps</span><span class="o">,</span>
    <span class="n">childName</span> <span class="k">=</span> <span class="s">"myEcho"</span><span class="o">,</span>
    <span class="n">minBackoff</span> <span class="k">=</span> <span class="mf">3.</span><span class="n">seconds</span><span class="o">,</span>
    <span class="n">maxBackoff</span> <span class="k">=</span> <span class="mf">30.</span><span class="n">seconds</span><span class="o">,</span>
    <span class="n">randomFactor</span> <span class="k">=</span> <span class="mf">0.2</span><span class="o">,</span> <span class="c1">// adds 20% "noise" to vary the intervals slightly</span>
    <span class="n">maxNrOfRetries</span> <span class="k">=</span> <span class="o">-</span><span class="mi">1</span>
  <span class="o">))</span>

<span class="nv">system</span><span class="o">.</span><span class="py">actorOf</span><span class="o">(</span><span class="n">supervisor</span><span class="o">,</span> <span class="n">name</span> <span class="k">=</span> <span class="s">"echoSupervisor"</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ä¸ä¸Šè¿° Scala ä»£ç ç­‰ä»·çš„ Java ä»£ç ä¸ºï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">java.time.Duration</span><span class="o">;</span>

<span class="kd">final</span> <span class="nc">Props</span> <span class="n">childProps</span> <span class="o">=</span> <span class="nc">Props</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">EchoActor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="kd">final</span> <span class="nc">Props</span> <span class="n">supervisorProps</span> <span class="o">=</span>
    <span class="nc">BackoffSupervisor</span><span class="o">.</span><span class="na">props</span><span class="o">(</span>
        <span class="nc">Backoff</span><span class="o">.</span><span class="na">onStop</span><span class="o">(</span>
            <span class="n">childProps</span><span class="o">,</span>
            <span class="s">"myEcho"</span><span class="o">,</span>
            <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span>
            <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">30</span><span class="o">),</span>
            <span class="mf">0.2</span><span class="o">));</span> <span class="c1">// adds 20% "noise" to vary the intervals slightly</span>

<span class="n">system</span><span class="o">.</span><span class="na">actorOf</span><span class="o">(</span><span class="n">supervisorProps</span><span class="o">,</span> <span class="s">"echoSupervisor"</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ä¸ºäº†é¿å…å¤šä¸ª Actor åœ¨å®Œå…¨ç›¸åŒçš„æ—¶é—´ç‚¹é‡æ–°å¯åŠ¨ï¼Œä¾‹å¦‚ï¼Œç”±äºå…±äº«èµ„æºï¼ˆå¦‚æ•°æ®åº“åœ¨ç›¸åŒé…ç½®çš„æ—¶é—´é—´éš”åå…³é—­å’Œé‡æ–°å¯åŠ¨ï¼‰ï¼Œå› æ­¤å¼ºçƒˆå»ºè®®ä½¿ç”¨<code class="language-plaintext highlighter-rouge">randomFactor</code>ä¸ºå›é€€é—´éš”æ·»åŠ ä¸€ç‚¹é¢å¤–çš„å˜åŒ–ã€‚é€šè¿‡åœ¨é‡æ–°å¯åŠ¨é—´éš”ä¸­å¢åŠ é¢å¤–çš„éšæœºæ€§ï¼ŒActor å°†åœ¨ç¨å¾®ä¸åŒçš„æ—¶é—´ç‚¹å¼€å§‹ï¼Œä»è€Œé¿å…å¤§æµé‡å³°å€¼å†²å‡»æ¢å¤å…±äº«æ•°æ®åº“æˆ–ä»–ä»¬æ‰€éœ€çš„å…¶ä»–èµ„æºã€‚</p>

<p>è¿˜å¯ä»¥å°†<code class="language-plaintext highlighter-rouge">akka.pattern.BackoffSupervisor</code> Actor é…ç½®ä¸ºåœ¨ Actor å´©æºƒä¸”ç›‘æ§ç­–ç•¥å†³å®šåº”é‡æ–°å¯åŠ¨æ—¶ï¼Œåœ¨å»¶è¿Ÿä¹‹åé‡æ–°å¯åŠ¨ Actorã€‚</p>

<p>ä¸‹é¢çš„ Scala ç‰‡æ®µæ¼”ç¤ºäº†å¦‚ä½•åˆ›å»ºä¸€ä¸ªé€€é¿ç›‘ç£è€…ï¼Œåœ¨ç»™å®šçš„ EchoActor å› æŸäº›å¼‚å¸¸è€Œå´©æºƒåï¼Œè¯¥ç›‘ç£è€…å°†ä»¥ 3ã€6ã€12ã€24 å’Œæœ€å 30 ç§’çš„é—´éš”å¯åŠ¨ï¼š</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">val</span> <span class="nv">childProps</span> <span class="k">=</span> <span class="nc">Props</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">EchoActor</span><span class="o">])</span>

<span class="k">val</span> <span class="nv">supervisor</span> <span class="k">=</span> <span class="nv">BackoffSupervisor</span><span class="o">.</span><span class="py">props</span><span class="o">(</span>
  <span class="nv">Backoff</span><span class="o">.</span><span class="py">onFailure</span><span class="o">(</span>
    <span class="n">childProps</span><span class="o">,</span>
    <span class="n">childName</span> <span class="k">=</span> <span class="s">"myEcho"</span><span class="o">,</span>
    <span class="n">minBackoff</span> <span class="k">=</span> <span class="mf">3.</span><span class="n">seconds</span><span class="o">,</span>
    <span class="n">maxBackoff</span> <span class="k">=</span> <span class="mf">30.</span><span class="n">seconds</span><span class="o">,</span>
    <span class="n">randomFactor</span> <span class="k">=</span> <span class="mf">0.2</span><span class="o">,</span> <span class="c1">// adds 20% "noise" to vary the intervals slightly</span>
    <span class="n">maxNrOfRetries</span> <span class="k">=</span> <span class="o">-</span><span class="mi">1</span>
  <span class="o">))</span>

<span class="nv">system</span><span class="o">.</span><span class="py">actorOf</span><span class="o">(</span><span class="n">supervisor</span><span class="o">,</span> <span class="n">name</span> <span class="k">=</span> <span class="s">"echoSupervisor"</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ä¸ä¸Šè¿° Scala ä»£ç ç­‰ä»·çš„ Java ä»£ç ä¸ºï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">java.time.Duration</span><span class="o">;</span>

<span class="kd">final</span> <span class="nc">Props</span> <span class="n">childProps</span> <span class="o">=</span> <span class="nc">Props</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">EchoActor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="kd">final</span> <span class="nc">Props</span> <span class="n">supervisorProps</span> <span class="o">=</span>
    <span class="nc">BackoffSupervisor</span><span class="o">.</span><span class="na">props</span><span class="o">(</span>
        <span class="nc">Backoff</span><span class="o">.</span><span class="na">onFailure</span><span class="o">(</span>
            <span class="n">childProps</span><span class="o">,</span>
            <span class="s">"myEcho"</span><span class="o">,</span>
            <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span>
            <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">30</span><span class="o">),</span>
            <span class="mf">0.2</span><span class="o">));</span> <span class="c1">// adds 20% "noise" to vary the intervals slightly</span>

<span class="n">system</span><span class="o">.</span><span class="na">actorOf</span><span class="o">(</span><span class="n">supervisorProps</span><span class="o">,</span> <span class="s">"echoSupervisor"</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">akka.pattern.BackoffOptions</code>å¯ç”¨äºè‡ªå®šä¹‰é€€é¿ç›‘ç£è€… Actor çš„è¡Œä¸ºï¼Œä»¥ä¸‹æ˜¯ä¸€äº›ç¤ºä¾‹ï¼š</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">val</span> <span class="nv">supervisor</span> <span class="k">=</span> <span class="nv">BackoffSupervisor</span><span class="o">.</span><span class="py">props</span><span class="o">(</span>
  <span class="nv">Backoff</span><span class="o">.</span><span class="py">onStop</span><span class="o">(</span>
    <span class="n">childProps</span><span class="o">,</span>
    <span class="n">childName</span> <span class="k">=</span> <span class="s">"myEcho"</span><span class="o">,</span>
    <span class="n">minBackoff</span> <span class="k">=</span> <span class="mf">3.</span><span class="n">seconds</span><span class="o">,</span>
    <span class="n">maxBackoff</span> <span class="k">=</span> <span class="mf">30.</span><span class="n">seconds</span><span class="o">,</span>
    <span class="n">randomFactor</span> <span class="k">=</span> <span class="mf">0.2</span><span class="o">,</span> <span class="c1">// adds 20% "noise" to vary the intervals slightly</span>
    <span class="n">maxNrOfRetries</span> <span class="k">=</span> <span class="o">-</span><span class="mi">1</span>
  <span class="o">).</span><span class="py">withManualReset</span> <span class="c1">// the child must send BackoffSupervisor.Reset to its parent</span>
    <span class="o">.</span><span class="py">withDefaultStoppingStrategy</span> <span class="c1">// Stop at any Exception thrown</span>
<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ä¸Šé¢çš„ä»£ç è®¾ç½®äº†ä¸€ä¸ªé€€é¿ç›‘ç£è€…ï¼Œè¦æ±‚å­ Actor åœ¨æˆåŠŸå¤„ç†æ¶ˆæ¯æ—¶å‘å…¶çˆ¶çº§å‘é€<code class="language-plaintext highlighter-rouge">akka.pattern.BackoffSupervisor.Reset</code>æ¶ˆæ¯ï¼Œä»è€Œé‡ç½®åé€€ã€‚å®ƒè¿˜ä½¿ç”¨é»˜è®¤çš„åœæ­¢ç­–ç•¥ï¼Œä»»ä½•å¼‚å¸¸éƒ½ä¼šå¯¼è‡´å­ Actor åœæ­¢ã€‚</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">val</span> <span class="nv">supervisor</span> <span class="k">=</span> <span class="nv">BackoffSupervisor</span><span class="o">.</span><span class="py">props</span><span class="o">(</span>
  <span class="nv">Backoff</span><span class="o">.</span><span class="py">onFailure</span><span class="o">(</span>
    <span class="n">childProps</span><span class="o">,</span>
    <span class="n">childName</span> <span class="k">=</span> <span class="s">"myEcho"</span><span class="o">,</span>
    <span class="n">minBackoff</span> <span class="k">=</span> <span class="mf">3.</span><span class="n">seconds</span><span class="o">,</span>
    <span class="n">maxBackoff</span> <span class="k">=</span> <span class="mf">30.</span><span class="n">seconds</span><span class="o">,</span>
    <span class="n">randomFactor</span> <span class="k">=</span> <span class="mf">0.2</span><span class="o">,</span> <span class="c1">// adds 20% "noise" to vary the intervals slightly</span>
    <span class="n">maxNrOfRetries</span> <span class="k">=</span> <span class="o">-</span><span class="mi">1</span>
  <span class="o">).</span><span class="py">withAutoReset</span><span class="o">(</span><span class="mf">10.</span><span class="n">seconds</span><span class="o">)</span> <span class="c1">// reset if the child does not throw any errors within 10 seconds</span>
    <span class="o">.</span><span class="py">withSupervisorStrategy</span><span class="o">(</span>
      <span class="nc">OneForOneStrategy</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">case</span> <span class="k">_:</span> <span class="kt">MyException</span> <span class="k">â‡’</span> <span class="kt">SupervisorStrategy.Restart</span>
        <span class="k">case</span> <span class="k">_</span>              <span class="k">â‡’</span> <span class="nv">SupervisorStrategy</span><span class="o">.</span><span class="py">Escalate</span>
      <span class="o">}))</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ä¸Šé¢çš„ä»£ç è®¾ç½®äº†ä¸€ä¸ªé€€é¿ç›‘ç£è€…ï¼Œå¦‚æœæŠ›å‡º<code class="language-plaintext highlighter-rouge">MyException</code>ï¼Œåœ¨é€€é¿åé‡æ–°å¯åŠ¨å­çº§ï¼Œè€Œä»»ä½•å…¶ä»–å¼‚å¸¸éƒ½å°†è¢«å‡çº§ã€‚å¦‚æœå­ Actor åœ¨ 10 ç§’å†…æ²¡æœ‰æŠ›å‡ºä»»ä½•é”™è¯¯ï¼Œåˆ™ä¼šè‡ªåŠ¨é‡ç½®åé€€ã€‚</p>

<h3 id="346-one-for-one-ç­–ç•¥-vs-all-for-one-ç­–ç•¥">3.4.6. One-For-One ç­–ç•¥ vs. All-For-One ç­–ç•¥</h3>
<p>Akka æä¾›äº†ä¸¤ç§ç›‘ç®¡ç­–ç•¥ï¼šä¸€ç§æ˜¯<code class="language-plaintext highlighter-rouge">OneForOneStrategy</code>ï¼Œå¦ä¸€ç§æ˜¯<code class="language-plaintext highlighter-rouge">AllForOneStrategy</code>ã€‚ä¸¤è€…éƒ½é…ç½®äº†ä»å¼‚å¸¸ç±»å‹åˆ°ç›‘ç£æŒ‡ä»¤ï¼ˆè§ä¸Šæ–‡ï¼‰çš„æ˜ å°„ï¼Œå¹¶é™åˆ¶äº†åœ¨ç»ˆæ­¢ä¹‹å‰å…è®¸å­çº§å¤±è´¥çš„é¢‘ç‡ã€‚å®ƒä»¬ä¹‹é—´çš„åŒºåˆ«åœ¨äºå‰è€…åªå°†è·å¾—çš„æŒ‡ä»¤åº”ç”¨äºå¤±è´¥çš„å­çº§ï¼Œè€Œåè€…ä¹Ÿå°†å…¶åº”ç”¨äºæ‰€æœ‰çš„å­çº§ã€‚é€šå¸¸ï¼Œä½ åº”è¯¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">OneForOneStrategy</code>ï¼Œå¦‚æœæ²¡æœ‰æ˜ç¡®æŒ‡å®šï¼Œå®ƒä¹Ÿæ˜¯é»˜è®¤çš„ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">AllForOneStrategy</code>é€‚ç”¨äºå­çº§ç¾¤ä½“ä¹‹é—´æœ‰å¾ˆå¼ºçš„ä¾èµ–æ€§ï¼Œä»¥è‡³äºä¸€ä¸ªå­ Actor çš„å¤±è´¥ä¼šå½±å“å…¶ä»–å­ Actor çš„åŠŸèƒ½ï¼Œå³ä»–ä»¬ä¹‹é—´çš„è”ç³»æ˜¯ä¸å¯åˆ†å‰²çš„ã€‚ç”±äºé‡æ–°å¯åŠ¨æ— æ³•æ¸…é™¤é‚®ç®±ï¼Œå› æ­¤é€šå¸¸æœ€å¥½åœ¨å¤±è´¥æ—¶ç»ˆæ­¢å­çº§ï¼Œå¹¶åœ¨ç›‘ç£è€…ï¼ˆé€šè¿‡ç›‘è§†å­çº§çš„ç”Ÿå‘½å‘¨æœŸï¼‰ä¸­æ˜¾å¼åœ°é‡æ–°åˆ›å»ºå®ƒä»¬ï¼›å¦åˆ™ï¼Œä½ å¿…é¡»ç¡®ä¿ä»»ä½• Actor éƒ½å¯ä»¥æ¥å—åœ¨é‡æ–°å¯åŠ¨ä¹‹å‰æ’é˜Ÿä½†åœ¨é‡æ–°å¯åŠ¨ä¹‹åå¤„ç†æ¶ˆæ¯ã€‚</p>

<p>åœ¨<code class="language-plaintext highlighter-rouge">All-For-One</code>ç­–ç•¥ä¸­ï¼Œé€šå¸¸åœæ­¢ä¸€ä¸ªå­çº§å°†ä¸ä¼šè‡ªåŠ¨ç»ˆæ­¢å…¶ä»–å­çº§ï¼›é€šè¿‡ç›‘æ§ä»–ä»¬çš„ç”Ÿå‘½å‘¨æœŸå¯ä»¥å®Œæˆï¼šå¦‚æœç›‘ç£è€…ä¸å¤„ç†<code class="language-plaintext highlighter-rouge">Terminated</code>æ¶ˆæ¯ï¼Œå®ƒå°†æŠ›å‡º<code class="language-plaintext highlighter-rouge">DeathPactException</code>ï¼ˆè¿™å–å†³äºå®ƒçš„ç›‘ç£è€…ï¼‰ï¼Œå®ƒå°†é‡æ–°å¯åŠ¨ï¼Œé»˜è®¤çš„<code class="language-plaintext highlighter-rouge">preRestart</code>å°†ç»ˆæ­¢å…¶æ‰€æœ‰çš„å­çº§ã€‚</p>

<p>è¯·æ³¨æ„ï¼Œåˆ›å»ºçš„ä¸€æ¬¡æ€§ Actor æ¥è‡ªä¸€ä¸ª<code class="language-plaintext highlighter-rouge">all-for-one</code>ç›‘ç£è€…ï¼Œé€šè¿‡ä¸´æ—¶ Actor çš„å¤±è´¥å‡çº§å½±å“æ‰€æœ‰å…¶ä»–çš„ Actorã€‚å¦‚æœä¸éœ€è¦è¿™æ ·åšï¼Œå¯ä»¥å®‰è£…ä¸€ä¸ªä¸­é—´ç›‘ç£è€…ï¼›è¿™å¯ä»¥é€šè¿‡ä¸º<code class="language-plaintext highlighter-rouge">worker</code>å£°æ˜ä¸€ä¸ªå¤§å°ä¸º 1 çš„è·¯ç”±å™¨æ¥å®ç°ï¼Œè¯¦è§ã€Œ<a href="https://github.com/guobinhit/akka-guide/blob/master/articles/actors/routing.md">è·¯ç”±</a>ã€ã€‚</p>

<hr />

<p><strong>è‹±æ–‡åŸæ–‡é“¾æ¥</strong>ï¼š<a href="https://doc.akka.io/docs/akka/current/general/supervision.html">Supervision and Monitoring</a>.</p>

<h2 id="35-actorå¼•ç”¨è·¯å¾„å’Œåœ°å€">3.5. Actorå¼•ç”¨ã€è·¯å¾„å’Œåœ°å€</h2>

<p>æœ¬ç« æè¿°å¦‚ä½•åœ¨å¯èƒ½çš„åˆ†å¸ƒå¼ Actor ç³»ç»Ÿä¸­æ ‡è¯†å’Œå®šä½ Actorã€‚å®ƒä¸è¿™æ ·ä¸€ä¸ªæ ¸å¿ƒç†å¿µç´§å¯†ç›¸è¿ï¼šã€Œ<a href="https://github.com/guobinhit/akka-guide/blob/master/articles/general-concepts/actor-systems.md">Actor ç³»ç»Ÿ</a>ã€å½¢æˆäº†å†…åœ¨çš„ç›‘ç£å±‚æ¬¡ç»“æ„ï¼Œå¹¶ä¸” Actor ä¹‹é—´çš„é€šä¿¡åœ¨è·¨å¤šä¸ªç½‘ç»œèŠ‚ç‚¹çš„ä½ç½®æ–¹é¢æ˜¯é€æ˜çš„ã€‚</p>

<p><img src="https://liulv.work/images/img/20200805105312.png" alt="20200805105312" /></p>

<p>ä¸Šå›¾æ˜¾ç¤ºäº† Actor ç³»ç»Ÿä¸­æœ€é‡è¦çš„å®ä½“ä¹‹é—´çš„å…³ç³»ï¼Œæœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·ç»§ç»­é˜…è¯»ã€‚</p>

<h3 id="351-ä»€ä¹ˆæ˜¯-actor-çš„å¼•ç”¨">3.5.1. ä»€ä¹ˆæ˜¯ Actor çš„å¼•ç”¨ï¼Ÿ</h3>

<p>Actor å¼•ç”¨æ˜¯<code class="language-plaintext highlighter-rouge">ActorRef</code>çš„ä¸€ä¸ªå­ç±»å‹ï¼Œå…¶é¦–è¦ç›®çš„æ˜¯æ”¯æŒå°†æ¶ˆæ¯å‘é€ç»™å®ƒæ‰€ä»£è¡¨çš„ Actorã€‚æ¯ä¸ª Actor éƒ½å¯ä»¥é€šè¿‡<code class="language-plaintext highlighter-rouge">self</code>å­—æ®µè®¿é—®å…¶è§„èŒƒï¼ˆæœ¬åœ°ï¼‰å¼•ç”¨ï¼›é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹äºå‘é€ç»™å…¶ä»– Actor çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œæ­¤å¼•ç”¨ä¹Ÿä½œä¸ºå‘é€è€…å¼•ç”¨åŒ…å«åœ¨å†…ã€‚ç›¸åº”åœ°ï¼Œåœ¨æ¶ˆæ¯å¤„ç†æœŸé—´ï¼ŒActor å¯ä»¥é€šè¿‡<code class="language-plaintext highlighter-rouge">sender()</code>æ–¹æ³•è®¿é—®è¡¨ç¤ºå½“å‰æ¶ˆæ¯å‘é€è€…çš„å¼•ç”¨ã€‚</p>

<p>æ ¹æ® Actor ç³»ç»Ÿçš„é…ç½®ï¼Œæ”¯æŒå‡ ç§ä¸åŒç±»å‹çš„ Actor å¼•ç”¨ï¼š</p>

<ul>
  <li>çº¯æœ¬åœ° Actor å¼•ç”¨ç”±æœªé…ç½®ä¸ºæ”¯æŒç½‘ç»œåŠŸèƒ½çš„ Actor ç³»ç»Ÿä½¿ç”¨ã€‚å¦‚æœé€šè¿‡ç½‘ç»œè¿æ¥å‘é€åˆ°è¿œç¨‹ JVMï¼Œè¿™äº› Actor å¼•ç”¨å°†ä¸èµ·ä½œç”¨ã€‚</li>
  <li>å¯ç”¨è¿œç¨‹å¤„ç†æ—¶ï¼Œæ”¯æŒç½‘ç»œåŠŸèƒ½çš„ Actor ç³»ç»Ÿä½¿ç”¨æœ¬åœ° Actor å¼•ç”¨ï¼Œè¿™äº›å¼•ç”¨è¡¨ç¤ºåŒä¸€ä¸ª JVM ä¸­çš„ Actorã€‚ä¸ºäº†åœ¨å‘é€åˆ°å…¶ä»–ç½‘ç»œèŠ‚ç‚¹æ—¶ä¹Ÿå¯ä»¥è®¿é—®ï¼Œè¿™äº›å¼•ç”¨åŒ…æ‹¬åè®®å’Œè¿œç¨‹å¯»å€ä¿¡æ¯ã€‚</li>
  <li>æœ¬åœ° Actor å¼•ç”¨çš„ä¸€ä¸ªå­ç±»å‹ç”¨äºè·¯ç”±å™¨ï¼ˆå³ Actor æ··åˆåœ¨<code class="language-plaintext highlighter-rouge">Router</code>ç‰¹æ€§ä¸­ï¼‰ã€‚å®ƒçš„é€»è¾‘ç»“æ„ä¸å‰é¢æåˆ°çš„æœ¬åœ°å¼•ç”¨ç›¸åŒï¼Œä½†æ˜¯å‘å®ƒä»¬å‘é€æ¶ˆæ¯ä¼šç›´æ¥å‘é€ç»™å®ƒä»¬çš„ä¸€ä¸ªå­çº§ã€‚</li>
  <li>è¿œç¨‹ Actor å¼•ç”¨è¡¨ç¤ºå¯ä»¥ä½¿ç”¨è¿œç¨‹é€šä¿¡è®¿é—®çš„ Actorï¼Œå³å‘å…¶å‘é€æ¶ˆæ¯å°†é€æ˜åœ°åºåˆ—åŒ–æ¶ˆæ¯å¹¶å°†å…¶å‘é€åˆ°è¿œç¨‹ JVMã€‚</li>
  <li>æœ‰å‡ ç§ç‰¹æ®Šç±»å‹çš„ Actor å¼•ç”¨ï¼Œå…¶è¡Œä¸ºç±»ä¼¼äºæ‰€æœ‰å®é™…ç”¨é€”çš„æœ¬åœ° Actor å¼•ç”¨ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">PromiseActorRef</code>æ˜¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">Promise</code>ä¸ºäº†å®Œæˆ Actor å“åº”çš„ç‰¹æ®Šè¡¨ç¤ºã€‚<code class="language-plaintext highlighter-rouge">akka.pattern.ask</code>åˆ›å»ºè¿™ä¸ª Actor å¼•ç”¨ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">DeadLetterActorRef</code>æ˜¯æ­»ä¿¡æœåŠ¡çš„é»˜è®¤å®ç°ï¼ŒAkka å°†å…¶ç›®çš„åœ°å…³é—­æˆ–ä¸å­˜åœ¨çš„æ‰€æœ‰æ¶ˆæ¯è·¯ç”±åˆ°è¯¥æœåŠ¡ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">EmptyLocalActorRef</code>æ˜¯ Akka åœ¨æŸ¥æ‰¾ä¸å­˜åœ¨çš„æœ¬åœ° Actor è·¯å¾„æ—¶è¿”å›çš„ï¼šå®ƒç›¸å½“äºä¸€ä¸ª<code class="language-plaintext highlighter-rouge">DeadLetterActorRef</code>ï¼Œä½†å®ƒä¿ç•™äº†è‡ªå·±çš„è·¯å¾„ï¼Œä»¥ä¾¿ Akka å¯ä»¥é€šè¿‡ç½‘ç»œå‘é€å®ƒï¼Œå¹¶å°†å…¶ä¸è¯¥è·¯å¾„çš„å…¶ä»–ç°æœ‰ Actor å¼•ç”¨è¿›è¡Œæ¯”è¾ƒï¼Œå…¶ä¸­ä¸€äº›å¼•ç”¨å¯èƒ½æ˜¯åœ¨ Actor æ­»äº¡ä¹‹å‰è·å¾—çš„ã€‚</li>
    </ul>
  </li>
  <li>è¿˜æœ‰ä¸€äº›ä¸€æ¬¡æ€§ï¼ˆ<code class="language-plaintext highlighter-rouge">one-off</code>ï¼‰çš„å†…éƒ¨å®ç°ï¼Œä½ åº”è¯¥æ°¸è¿œéƒ½ä¸ä¼šçœŸæ­£çœ‹åˆ°ï¼š
    <ul>
      <li>æœ‰ä¸€ä¸ª Actor å¼•ç”¨ï¼Œå®ƒä¸ä»£è¡¨ä¸€ä¸ª Actorï¼Œåªä½œä¸ºæ ¹å®ˆæŠ¤è€…çš„ä¼ªç›‘ç£è€…ï¼ˆ<code class="language-plaintext highlighter-rouge">pseudo-supervisor</code>ï¼‰ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œåœ¨æ—¶ç©ºçš„æ°”æ³¡ä¸­è¡Œèµ°çš„äººâ€ã€‚</li>
      <li>åœ¨å®é™…å¯åŠ¨ Actor åˆ›å»ºå·¥å…·ä¹‹å‰å¯åŠ¨çš„ç¬¬ä¸€ä¸ªæ—¥å¿—è®°å½•æœåŠ¡æ˜¯ä¸€ä¸ªå‡ Actor å¼•ç”¨ï¼Œå®ƒæ¥å—æ—¥å¿—äº‹ä»¶å¹¶å°†å…¶ç›´æ¥æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºï¼›å®ƒæ˜¯<code class="language-plaintext highlighter-rouge">Logging.StandardOutLogger</code>ã€‚</li>
    </ul>
  </li>
</ul>

<h3 id="352-ä»€ä¹ˆæ˜¯-actor-è·¯å¾„">3.5.2. ä»€ä¹ˆæ˜¯ Actor è·¯å¾„ï¼Ÿ</h3>

<p>ç”±äº Actor æ˜¯ä»¥ä¸¥æ ¼çš„å±‚æ¬¡ç»“æ„æ–¹å¼åˆ›å»ºçš„ï¼Œå› æ­¤å­˜åœ¨ä¸€ä¸ªå”¯ä¸€çš„ Actor åç§°åºåˆ—ï¼Œè¯¥åºåˆ—é€šè¿‡é€’å½’åœ°æ²¿ç€å­çº§å’Œçˆ¶çº§ä¹‹é—´çš„ç›‘ç£é“¾æ¥å‘ä¸‹åˆ° Actor ç³»ç»Ÿçš„æ ¹æ¥ç»™å‡ºã€‚è¿™ä¸ªåºåˆ—å¯ä»¥çœ‹ä½œæ˜¯æ–‡ä»¶ç³»ç»Ÿä¸­çš„å°é—­æ–‡ä»¶å¤¹ï¼Œå› æ­¤æˆ‘ä»¬é‡‡ç”¨åç§°<code class="language-plaintext highlighter-rouge">path</code>æ¥å¼•ç”¨å®ƒï¼Œå°½ç®¡ Actor å±‚æ¬¡ç»“æ„ä¸æ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡ç»“æ„æœ‰ä¸€äº›åŸºæœ¬çš„åŒºåˆ«ã€‚</p>

<p>ä¸€ä¸ª Actor è·¯å¾„ç”±ä¸€ä¸ªé”šç‚¹ç»„æˆï¼Œè¯¥é”šç‚¹æ ‡è¯† Actor ç³»ç»Ÿï¼Œç„¶åè¿æ¥ä»æ ¹å®ˆæŠ¤è€…åˆ°æŒ‡å®šçš„ Actor çš„è·¯å¾„å…ƒç´ ï¼›è·¯å¾„å…ƒç´ æ˜¯è¢«éå†çš„ Actor çš„åç§°ï¼Œç”±æ–œçº¿åˆ†éš”ã€‚</p>

<h4 id="3521-actor-çš„å¼•ç”¨å’Œè·¯å¾„æœ‰ä»€ä¹ˆåŒºåˆ«">3.5.2.1. Actor çš„å¼•ç”¨å’Œè·¯å¾„æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h4>
<p>Actor å¼•ç”¨æŒ‡å®šä¸€ä¸ªå•ç‹¬çš„ Actorï¼Œå¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸä¸è¯¥ Actor çš„ç”Ÿå‘½å‘¨æœŸåŒ¹é…ï¼›Actor è·¯å¾„è¡¨ç¤ºä¸€ä¸ªå¯èƒ½ç”± Actor ä½ç½®æˆ–ä¸ç”± Actor ä½ç½®æ ‡è¯†çš„åç§°ï¼Œå¹¶ä¸”è·¯å¾„æœ¬èº«æ²¡æœ‰ç”Ÿå‘½å‘¨æœŸï¼Œå®ƒæ°¸è¿œä¸ä¼šå˜ä¸ºæ— æ•ˆã€‚ä½ å¯ä»¥åœ¨ä¸åˆ›å»º Actor çš„æƒ…å†µä¸‹åˆ›å»º Actor è·¯å¾„ï¼Œä½†åœ¨ä¸åˆ›å»ºç›¸åº”çš„ Actor çš„æƒ…å†µä¸‹æ— æ³•åˆ›å»º Actor å¼•ç”¨ã€‚</p>

<p>ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª Actorï¼Œç»ˆæ­¢å®ƒï¼Œç„¶åä½¿ç”¨ç›¸åŒçš„ Actor è·¯å¾„åˆ›å»ºä¸€ä¸ªæ–°çš„ Actorã€‚æ–°åˆ›å»ºçš„ Actor æ˜¯åŸ Actor çš„åŒ–èº«ã€‚ä»–ä»¬ä¸æ˜¯åŒä¸€ä¸ª Actorã€‚Actor å¼•ç”¨æ—§çš„åŒ–èº«å¯¹æ–°çš„åŒ–èº«æ— æ•ˆã€‚å‘é€åˆ°æ—§ Actor å¼•ç”¨çš„æ¶ˆæ¯å°†ä¸ä¼šä¼ é€’åˆ°æ–°çš„åŒ–èº«ï¼Œå³ä½¿å®ƒä»¬å…·æœ‰ç›¸åŒçš„è·¯å¾„ã€‚</p>

<h4 id="3522-actor-è·¯å¾„é”šç‚¹">3.5.2.2. Actor è·¯å¾„é”šç‚¹</h4>
<p>æ¯ä¸ª Actor è·¯å¾„éƒ½æœ‰ä¸€ä¸ªåœ°å€ç»„ä»¶ï¼Œæè¿°äº†åè®®å’Œä½ç½®ï¼Œé€šè¿‡è¿™äº›åè®®å’Œä½ç½®å¯ä»¥è®¿é—®ç›¸åº”çš„ Actorï¼Œè·¯å¾„ä¸­çš„å…ƒç´ æ˜¯ä»æ ¹ç›®å½•å‘ä¸Šçš„å±‚æ¬¡ç»“æ„ä¸­ Actor çš„åç§°ã€‚ä¾‹å¦‚ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>"akka://my-sys/user/service-a/worker1"                   // purely local
"akka.tcp://my-sys@host.example.com:5678/user/service-b" // remote
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨è¿™é‡Œï¼Œ<code class="language-plaintext highlighter-rouge">akka.tcp</code>æ˜¯ 2.4 ç‰ˆæœ¬çš„é»˜è®¤è¿œç¨‹ä¼ è¾“ï¼›å…¶ä»–ä¼ è¾“æ˜¯å¯æ’æ‹”çš„ã€‚ä¸»æœºå’Œç«¯å£éƒ¨åˆ†ï¼ˆå¦‚ç¤ºä¾‹ä¸­çš„<code class="language-plaintext highlighter-rouge">host.example.com:5678</code>ï¼‰çš„è§£é‡Šå–å†³äºæ‰€ä½¿ç”¨çš„ä¼ è¾“æœºåˆ¶ï¼Œä½†å¿…é¡»éµå®ˆ URI ç»“æ„è§„åˆ™ã€‚</p>

<h4 id="3523-é€»è¾‘-actor-è·¯å¾„">3.5.2.3. é€»è¾‘ Actor è·¯å¾„</h4>
<p>é€šè¿‡è·Ÿè¸ªæŒ‡å‘æ ¹å®ˆæŠ¤è€…çš„çˆ¶çº§ç›‘ç£é“¾æ¥è·å¾—çš„å”¯ä¸€è·¯å¾„ç§°ä¸ºé€»è¾‘ Actor è·¯å¾„ã€‚æ­¤è·¯å¾„ä¸ Actor çš„åˆ›å»ºç¥–å…ˆå®Œå…¨åŒ¹é…ï¼Œå› æ­¤åªè¦è®¾ç½®äº† Actor ç³»ç»Ÿçš„è¿œç¨‹å¤„ç†é…ç½®ï¼ˆä»¥åŠè·¯å¾„çš„åœ°å€ç»„ä»¶ï¼‰ï¼Œå®ƒå°±å®Œå…¨å…·æœ‰ç¡®å®šæ€§ã€‚</p>

<h4 id="3524-ç‰©ç†-actor-è·¯å¾„">3.5.2.4. ç‰©ç† Actor è·¯å¾„</h4>
<p>è™½ç„¶é€»è¾‘ Actor è·¯å¾„æè¿°äº†ä¸€ä¸ª Actor ç³»ç»Ÿä¸­çš„åŠŸèƒ½ä½ç½®ï¼Œä½†æ˜¯åŸºäºé…ç½®çš„è¿œç¨‹éƒ¨ç½²æ„å‘³ç€å¯ä»¥åœ¨ä¸å…¶çˆ¶ç³»ç»Ÿä¸åŒçš„ç½‘ç»œä¸»æœºä¸Šåˆ›å»º Actorï¼Œå³åœ¨ä¸åŒçš„ Actor ç³»ç»Ÿä¸­ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»æ ¹å®ˆæŠ¤è€…å‘ä¸Šéµå¾ª Actor è·¯å¾„éœ€è¦éå†ç½‘ç»œï¼Œè¿™æ˜¯ä¸€ä¸ªæ˜‚è´µçš„æ“ä½œã€‚å› æ­¤ï¼Œæ¯ä¸ª Actor ä¹Ÿæœ‰ä¸€ä¸ªç‰©ç†è·¯å¾„ï¼Œä»å®é™… Actor å¯¹è±¡æ‰€åœ¨çš„ Actor ç³»ç»Ÿçš„æ ¹å®ˆæŠ¤è€…å¼€å§‹ã€‚å½“æŸ¥è¯¢å…¶ä»– Actor æ—¶ï¼Œä½¿ç”¨æ­¤è·¯å¾„ä½œä¸ºå‘é€è€…å¼•ç”¨ï¼Œå°†å…è®¸ä»–ä»¬ç›´æ¥å›å¤æ­¤ Actorï¼Œä»è€Œæœ€å°åŒ–è·¯ç”±æ‰€å¯¼è‡´çš„å»¶è¿Ÿã€‚</p>

<p>ä¸€ä¸ªé‡è¦çš„æ–¹é¢æ˜¯ï¼Œç‰©ç† Actor è·¯å¾„ä»ä¸è·¨è¶Šå¤šä¸ª Actor ç³»ç»Ÿæˆ– JVMã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä¸€ä¸ª Actor çš„ç¥–å…ˆè¢«è¿œç¨‹ç›‘æ§ï¼Œé‚£ä¹ˆå®ƒçš„é€»è¾‘è·¯å¾„ï¼ˆç›‘ç£å±‚æ¬¡ï¼‰å’Œç‰©ç†è·¯å¾„ï¼ˆActor éƒ¨ç½²ï¼‰å¯èƒ½ä¼šå‘ç”Ÿåç¦»ã€‚</p>

<h4 id="3525-actor-è·¯å¾„åˆ«åæˆ–ç¬¦å·é“¾æ¥">3.5.2.5. Actor è·¯å¾„åˆ«åæˆ–ç¬¦å·é“¾æ¥ï¼Ÿ</h4>

<p>åœ¨ä¸€äº›å®é™…çš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä½ å¯èƒ½ä¼šæƒ³åˆ°ä¸€ä¸ª Actor çš„â€œè·¯å¾„åˆ«åâ€æˆ–â€œç¬¦å·é“¾æ¥â€ï¼Œå³ä¸€ä¸ª Actor å¯ä»¥ä½¿ç”¨å¤šä¸ªè·¯å¾„è®¿é—®ã€‚ä½†æ˜¯ï¼Œä½ åº”è¯¥æ³¨æ„ï¼ŒActor å±‚æ¬¡ç»“æ„ä¸åŒäºæ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡ç»“æ„ã€‚ä¸èƒ½è‡ªç”±åœ°åˆ›å»º Actor è·¯å¾„ï¼ˆå¦‚ç¬¦å·é“¾æ¥ï¼‰æ¥å¼•ç”¨ä»»æ„çš„ Actorã€‚å¦‚ä¸Šè¿°é€»è¾‘å’Œç‰©ç† Actor è·¯å¾„éƒ¨åˆ†æ‰€è¿°ï¼ŒActor è·¯å¾„å¿…é¡»æ˜¯è¡¨ç¤ºç›‘ç£å±‚æ¬¡ç»“æ„çš„é€»è¾‘è·¯å¾„ï¼Œæˆ–è€…æ˜¯è¡¨ç¤º Actor éƒ¨ç½²çš„ç‰©ç†è·¯å¾„ã€‚</p>

<h3 id="353-å¦‚ä½•è·å¾—-actor-å¼•ç”¨">3.5.3. å¦‚ä½•è·å¾— Actor å¼•ç”¨ï¼Ÿ</h3>
<p>å¯¹äºå¦‚ä½•è·å– Actor å¼•ç”¨ï¼Œæœ‰ä¸¤ä¸ªé€šç”¨çš„ç±»åˆ«ï¼šé€šè¿‡åˆ›å»º Actor æˆ–é€šè¿‡æŸ¥æ‰¾ Actorï¼Œåè€…çš„åŠŸèƒ½åŒ…æ‹¬ä»å…·ä½“çš„ Actor è·¯å¾„åˆ›å»º Actor å¼•ç”¨å’ŒæŸ¥è¯¢é€»è¾‘çš„ Actor å±‚æ¬¡ç»“æ„ã€‚</p>

<h4 id="3531-åˆ›å»º-actor">3.5.3.1. åˆ›å»º Actor</h4>
<p>Actor ç³»ç»Ÿé€šå¸¸æ˜¯é€šè¿‡ä½¿ç”¨<code class="language-plaintext highlighter-rouge">ActorSystem.actorOf</code>æ–¹æ³•åœ¨å®ˆæŠ¤ Actor ä¸‹åˆ›å»º Actorï¼Œç„¶åä»åˆ›å»ºçš„ Actor ä¸­ä½¿ç”¨<code class="language-plaintext highlighter-rouge">ActorContext.actorOf</code>æ¥ç”Ÿæˆ Actor æ ‘æ¥å¯åŠ¨çš„ã€‚è¿™äº›æ–¹æ³•è¿”å›å¯¹æ–°åˆ›å»ºçš„ Actor çš„å¼•ç”¨ã€‚æ¯ä¸ª Actor éƒ½å¯ä»¥ï¼ˆé€šè¿‡å…¶<code class="language-plaintext highlighter-rouge">ActorContext</code>ï¼‰ç›´æ¥è®¿é—®å…¶çˆ¶çº§ã€è‡ªèº«åŠå…¶å­çº§çš„å¼•ç”¨ã€‚è¿™äº›å¼•ç”¨å¯ä»¥åœ¨æ¶ˆæ¯ä¸­å‘é€ç»™å…¶ä»– Actorï¼Œä»è€Œä½¿è¿™äº› Actor èƒ½å¤Ÿç›´æ¥å›å¤ã€‚</p>

<h4 id="3532-ç”¨å…·ä½“çš„è·¯å¾„æŸ¥æ‰¾-actor">3.5.3.2. ç”¨å…·ä½“çš„è·¯å¾„æŸ¥æ‰¾ Actor</h4>
<p>æ­¤å¤–ï¼Œå¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">ActorSystem.actorSelection</code>æ–¹æ³•æŸ¥æ‰¾ Actor å¼•ç”¨ã€‚é€‰æ‹©ï¼ˆ<code class="language-plaintext highlighter-rouge">selection</code>ï¼‰å¯ç”¨äºä¸æ‰€è¿° Actor é€šä¿¡ï¼Œå¹¶ä¸”åœ¨ä¼ é€’æ¯æ¡æ¶ˆæ¯æ—¶æŸ¥æ‰¾æ‰€è¿°é€‰æ‹©å¯¹åº”çš„ Actorã€‚</p>

<p>è¦è·å–ç»‘å®šåˆ°ç‰¹å®š Actor ç”Ÿå‘½å‘¨æœŸçš„<code class="language-plaintext highlighter-rouge">ActorRef</code>ï¼Œä½ éœ€è¦å‘ Actor å‘é€æ¶ˆæ¯ï¼Œä¾‹å¦‚å†…ç½®æ ‡è¯†æ¶ˆæ¯ï¼Œå¹¶ä½¿ç”¨æ¥è‡ª Actor çš„ç­”å¤çš„<code class="language-plaintext highlighter-rouge">sender()</code>å¼•ç”¨ã€‚</p>

<h4 id="3533-ç»å¯¹è·¯å¾„-vs-ç›¸å¯¹è·¯å¾„">3.5.3.3. ç»å¯¹è·¯å¾„ vs. ç›¸å¯¹è·¯å¾„</h4>
<p>é™¤äº†<code class="language-plaintext highlighter-rouge">ActorSystem.actorSelection</code>ï¼Œè¿˜æœ‰<code class="language-plaintext highlighter-rouge">ActorContext.actorSelection</code>ï¼Œåœ¨ä»»ä½• Actor ä¸­éƒ½å¯ä»¥ä½œä¸º<code class="language-plaintext highlighter-rouge">context.actorSelection</code>ä½¿ç”¨ã€‚è¿™å°†ç”Ÿæˆä¸€ä¸ª Actor é€‰æ‹©ï¼Œä¸<code class="language-plaintext highlighter-rouge">ActorSystem</code>ä¸Šçš„å­ªç”Ÿå…„å¼Ÿéå¸¸ç›¸ä¼¼ï¼Œä½†å®ƒä¸æ˜¯ä» Actor æ ‘çš„æ ¹å¼€å§‹æŸ¥æ‰¾è·¯å¾„ï¼Œè€Œæ˜¯ä»å½“å‰ Actor å¼€å§‹ã€‚ç”±ä¸¤ä¸ªç‚¹ï¼ˆ<code class="language-plaintext highlighter-rouge">".."</code>ï¼‰ç»„æˆçš„è·¯å¾„å…ƒç´ å¯ç”¨äºè®¿é—®çˆ¶ Actorã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥å‘ç‰¹å®šçš„å…„å¼Ÿå§å¦¹ Actor å‘é€æ¶ˆæ¯ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>context.actorSelection("../brother") ! msg
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»å¯¹è·¯å¾„ä¹Ÿå¯ä»¥ç”¨é€šå¸¸çš„æ–¹å¼åœ¨ä¸Šä¸‹æ–‡ä¸­æŸ¥æ‰¾ï¼Œå³</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>context.actorSelection("/user/serviceA") ! msg
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™éƒ½å°†æŒ‰é¢„æœŸå·¥ä½œã€‚</p>

<h4 id="3534-æŸ¥è¯¢é€»è¾‘-actor-å±‚æ¬¡ç»“æ„">3.5.3.4. æŸ¥è¯¢é€»è¾‘ Actor å±‚æ¬¡ç»“æ„</h4>

<p>ç”±äº Actor ç³»ç»Ÿå½¢æˆäº†ç±»ä¼¼äºæ–‡ä»¶ç³»ç»Ÿçš„å±‚æ¬¡ç»“æ„ï¼Œå› æ­¤åœ¨è·¯å¾„ä¸Šè¿›è¡ŒåŒ¹é…çš„æ–¹å¼ä¸ Unix shells æ”¯æŒçš„æ–¹å¼ç›¸åŒï¼šä½ å¯ä»¥ç”¨é€šé…ç¬¦(<code class="language-plaintext highlighter-rouge">*Â«*Â»*</code>å’Œ<code class="language-plaintext highlighter-rouge">Â«?Â»</code>ï¼‰æ›¿æ¢ï¼ˆéƒ¨åˆ†ï¼‰è·¯å¾„å…ƒç´ ååˆ¶å®šä¸€ä¸ªå¯ä»¥åŒ¹é…é›¶ä¸ªæˆ–æ›´å¤šå®é™… Actor çš„é€‰æ‹©ã€‚å› ä¸ºç»“æœä¸æ˜¯å•ä¸ª Actor å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒå…·æœ‰ä¸åŒçš„<code class="language-plaintext highlighter-rouge">ActorSelection</code>ç±»å‹ï¼Œå¹¶ä¸”ä¸æ”¯æŒ<code class="language-plaintext highlighter-rouge">ActorRef</code>æ‰§è¡Œçš„å®Œæ•´æ“ä½œé›†ã€‚å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">ActorSystem.actorSelection</code>å’Œ<code class="language-plaintext highlighter-rouge">ActorContext.actorSelection</code>æ–¹æ³•æ¥åˆ¶å®šé€‰æ‹©ï¼Œå¹¶ä¸”ç¡®å®æ”¯æŒå‘é€æ¶ˆæ¯ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>context.actorSelection("../*") ! msg
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å°†å‘åŒ…æ‹¬å½“å‰ Actor åœ¨å†…çš„æ‰€æœ‰å…„å¼Ÿå§å¦¹ Actor å‘é€<code class="language-plaintext highlighter-rouge">msg</code>ã€‚å¯¹äºä½¿ç”¨<code class="language-plaintext highlighter-rouge">actorSelection</code>è·å–çš„å¼•ç”¨ï¼Œå°†éå†ç›‘ç£å±‚æ¬¡ç»“æ„ä»¥æ‰§è¡Œæ¶ˆæ¯å‘é€ã€‚ç”±äºä¸é€‰å®šå†…å®¹åŒ¹é…çš„ Actor çš„ç¡®åˆ‡é›†åˆå¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå³ä½¿æ¶ˆæ¯æ­£åœ¨ä¼ é€’ç»™æ”¶ä»¶äººï¼Œä¹Ÿä¸å¯èƒ½è§‚çœ‹é€‰å®šå†…å®¹çš„å®æ—¶å˜åŒ–ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œé€šè¿‡å‘é€ä¸€ä¸ªè¯·æ±‚å¹¶æ”¶é›†æ‰€æœ‰ç­”æ¡ˆï¼Œæå–å‘é€è€…å¼•ç”¨ï¼Œç„¶åè§‚å¯Ÿæ‰€æœ‰å‘ç°çš„å…·ä½“ Actor æ¥è§£å†³ä¸ç¡®å®šæ€§ã€‚è¿™ç§è§£å†³é€‰æ‹©çš„æ–¹æ¡ˆå¯ä»¥åœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­åŠ ä»¥æ”¹è¿›ã€‚</p>

<p>æ€»ç»“ï¼š<code class="language-plaintext highlighter-rouge">actorOf</code> vs. <code class="language-plaintext highlighter-rouge">actorSelection</code></p>

<ul>
  <li><strong>æ³¨é‡Š</strong>ï¼šä»¥ä¸Šéƒ¨åˆ†çš„è¯¦ç»†æè¿°å¯ä»¥æ€»ç»“å’Œè®°å¿†å¦‚ä¸‹ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">actorOf</code>åªåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ Actorï¼Œå®ƒå°†å…¶åˆ›å»ºä¸ºè°ƒç”¨æ­¤æ–¹æ³•çš„ä¸Šä¸‹æ–‡ï¼ˆå¯èƒ½æ˜¯ä»»ä½• Actor æˆ– Actor ç³»ç»Ÿï¼‰çš„ç›´æ¥å­çº§ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">actorSelection</code>ä»…åœ¨ä¼ é€’æ¶ˆæ¯æ—¶æŸ¥æ‰¾ç°æœ‰çš„ Actorï¼Œå³ä¸åˆ›å»º Actorï¼Œæˆ–åœ¨åˆ›å»ºé€‰æ‹©æ—¶éªŒè¯ Actor çš„å­˜åœ¨ã€‚</li>
    </ul>
  </li>
</ul>

<h3 id="354-actor-å¼•ç”¨å’Œè·¯å¾„ç›¸ç­‰">3.5.4. Actor å¼•ç”¨å’Œè·¯å¾„ç›¸ç­‰</h3>
<p><code class="language-plaintext highlighter-rouge">ActorRef</code>çš„ç›¸ç­‰ç¬¦åˆ<code class="language-plaintext highlighter-rouge">ActorRef</code>å¯¹åº”äºç›®æ ‡ Actor åŒ–èº«çš„æ„å›¾ã€‚å½“ä¸¤ä¸ª Actor å¼•ç”¨å…·æœ‰ç›¸åŒçš„è·¯å¾„å¹¶æŒ‡å‘ç›¸åŒçš„ Actor åŒ–èº«æ—¶ï¼Œå®ƒä»¬å°†è¢«æ¯”è¾ƒä¸ºç›¸ç­‰çš„ã€‚æŒ‡å‘ç»ˆæ­¢çš„ Actor çš„å¼•ç”¨ä¸æŒ‡å‘å…·æœ‰ç›¸åŒè·¯å¾„çš„å…¶ä»–ï¼ˆé‡æ–°åˆ›å»ºçš„ï¼‰Actor çš„å¼•ç”¨ä¸åŒã€‚è¯·æ³¨æ„ï¼Œç”±å¤±è´¥å¼•èµ·çš„ Actor é‡æ–°å¯åŠ¨ä»ç„¶æ„å‘³ç€å®ƒæ˜¯åŒä¸€ä¸ª Actor çš„åŒ–èº«ï¼Œå³å¯¹äº<code class="language-plaintext highlighter-rouge">ActorRef</code>çš„ä½¿ç”¨è€…æ¥è¯´ï¼Œé‡æ–°å¯åŠ¨æ˜¯ä¸å¯è§çš„ã€‚</p>

<p>å¦‚æœéœ€è¦è·Ÿè¸ªé›†åˆä¸­çš„ Actor å¼•ç”¨ï¼Œè€Œä¸å…³å¿ƒå…·ä½“çš„ Actor åŒ–èº«ï¼Œåˆ™å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">ActorPath</code>ä½œä¸ºé”®ï¼Œå› ä¸ºåœ¨æ¯”è¾ƒ Actor è·¯å¾„æ—¶ä¸è€ƒè™‘ç›®æ ‡ Actor çš„æ ‡è¯†ç¬¦ã€‚</p>

<h3 id="355-å¤ç”¨-actor-è·¯å¾„">3.5.5. å¤ç”¨ Actor è·¯å¾„</h3>
<p>å½“ä¸€ä¸ª Actor è¢«ç»ˆæ­¢æ—¶ï¼Œå®ƒçš„å¼•ç”¨å°†æŒ‡å‘æ­»ä¿¡é‚®ç®±ï¼Œ<code class="language-plaintext highlighter-rouge">DeathWatch</code>å°†å‘å¸ƒå…¶æœ€ç»ˆçš„è½¬æ¢ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå®ƒä¸ä¼šå†æ¬¡æ¢å¤ç”Ÿå‘½ï¼ˆå› ä¸º Actor çš„ç”Ÿå‘½å‘¨æœŸä¸å…è®¸è¿™æ ·åšï¼‰ã€‚è™½ç„¶å¯ä»¥åœ¨ä»¥åç”¨ç›¸åŒçš„è·¯å¾„åˆ›å»ºä¸€ä¸ª Actorï¼Œå› ä¸ºå¦‚æœä¸ä¿ç•™æ‰€æœ‰å·²åˆ›å»ºçš„ Actor é›†ï¼Œå°±ä¸å¯èƒ½æ‰§è¡Œç›¸åçš„æ“ä½œï¼Œä½†è¿™ä¸æ˜¯ä¸€ä¸ªå¥½çš„å®è·µï¼šç”¨<code class="language-plaintext highlighter-rouge">actorSelection</code>å‘ä¸€ä¸ªâ€œæ­»äº¡â€çš„ Actor å‘é€çš„æ¶ˆæ¯ä¼šçªç„¶é‡æ–°å¼€å§‹å·¥ä½œï¼Œä½†æ²¡æœ‰ä»»ä½•é¡ºåºä¿è¯ã€‚åœ¨è¿™ä¸ªè½¬æ¢å’Œä»»ä½•å…¶ä»–äº‹ä»¶ä¹‹é—´ï¼Œè¯¥è·¯å¾„æ‰€ä»£è¡¨çš„æ–° Actor å¯èƒ½ä¼šæ¥æ”¶åˆ°å‘å¾€è¯¥è·¯å¾„æ‰€ä»£è¡¨çš„å‰ä¸€ä¸ª Actor çš„æ¶ˆæ¯ã€‚</p>

<p>åœ¨éå¸¸ç‰¹æ®Šçš„æƒ…å†µä¸‹ï¼Œè¿™å¯èƒ½æ˜¯æ­£ç¡®çš„åšæ³•ï¼Œä½†ä¸€å®šè¦å°†å¤„ç†è¿™ä¸€ç‚¹ä¸¥æ ¼é™åˆ¶åœ¨ Actor çš„ç›‘ç£è€…èº«ä¸Šï¼Œå› ä¸ºåªæœ‰è¿™æ ·çš„ Actor æ‰èƒ½å¯é åœ°æ£€æµ‹åˆ°åå­—çš„æ­£ç¡®æ³¨é”€ï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œæ–°å­ Actor çš„åˆ›å»ºå°†å¤±è´¥ã€‚</p>

<p>å½“æµ‹è¯•å¯¹è±¡ä¾èµ–äºåœ¨ç‰¹å®šè·¯å¾„ä¸Šå®ä¾‹æ—¶ï¼Œä¹Ÿå¯èƒ½éœ€è¦åœ¨æµ‹è¯•æœŸé—´ä½¿ç”¨å®ƒã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ€å¥½æ¨¡æ‹Ÿå…¶ç›‘ç£è€…ï¼Œä»¥ä¾¿å°†<code class="language-plaintext highlighter-rouge">Terminated</code>æ¶ˆæ¯è½¬å‘åˆ°æµ‹è¯•è¿‡ç¨‹ä¸­çš„é€‚å½“ç‚¹ï¼Œä»¥ä¾¿åè€…ç­‰å¾…æ­£ç¡®çš„åç§°æ³¨é”€ã€‚</p>

<h3 id="356-è¿œç¨‹éƒ¨ç½²çš„äº¤äº’ä½œç”¨">3.5.6. è¿œç¨‹éƒ¨ç½²çš„äº¤äº’ä½œç”¨</h3>

<p>å½“ Actor åˆ›å»ºå­èŠ‚ç‚¹æ—¶ï¼ŒActor ç³»ç»Ÿçš„éƒ¨ç½²ç¨‹åºå°†å†³å®šæ–° Actor æ˜¯é©»ç•™åœ¨åŒä¸€ä¸ª JVM ä¸­ï¼Œè¿˜æ˜¯é©»ç•™åœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚åœ¨ç¬¬äºŒç§æƒ…å†µä¸‹ï¼ŒActor çš„åˆ›å»ºå°†é€šè¿‡ç½‘ç»œè¿æ¥è§¦å‘ï¼Œåœ¨ä¸åŒçš„ JVM ä¸­å‘ç”Ÿï¼Œä»è€Œåœ¨ä¸åŒçš„ Actor ç³»ç»Ÿä¸­å‘ç”Ÿã€‚è¿œç¨‹ç³»ç»Ÿå°†æŠŠæ–° Actor æ”¾åœ¨ä¸ºæ­¤ç›®çš„ä¿ç•™çš„ç‰¹æ®Šè·¯å¾„ä¸‹ï¼Œæ–° Actor çš„ç›‘ç£è€…å°†æ˜¯è¿œç¨‹ Actor å¼•ç”¨ï¼ˆè¡¨ç¤ºè§¦å‘å…¶åˆ›å»ºçš„ Actorï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code class="language-plaintext highlighter-rouge">context.parent</code>ï¼ˆç›‘ç£è€…å¼•ç”¨ï¼‰å’Œ<code class="language-plaintext highlighter-rouge">context.path.parent</code>ï¼ˆActor è·¯å¾„ä¸­çš„çˆ¶èŠ‚ç‚¹ï¼‰ä¸è¡¨ç¤ºåŒä¸€ä¸ª Actorã€‚ä½†æ˜¯ï¼Œåœ¨ç›‘ç£è€…ä¸­æŸ¥æ‰¾å­çº§çš„åç§°ä¼šåœ¨è¿œç¨‹èŠ‚ç‚¹ä¸Šæ‰¾åˆ°å®ƒï¼Œä¿ç•™é€»è¾‘ç»“æ„ï¼Œä¾‹å¦‚å‘é€åˆ°æœªè§£æçš„ Actor å¼•ç”¨æ—¶ã€‚</p>

<p><img src="https://github.com/guobinhit/akka-guide/blob/master/images/addressing/actor-path-in-system.png" alt="actor-path-in-system" /></p>

<h3 id="357-åœ°å€éƒ¨åˆ†ç”¨äºä»€ä¹ˆ">3.5.7. åœ°å€éƒ¨åˆ†ç”¨äºä»€ä¹ˆï¼Ÿ</h3>
<p>å½“é€šè¿‡ç½‘ç»œå‘é€ Actor å¼•ç”¨æ—¶ï¼Œå®ƒç”±å…¶è·¯å¾„è¡¨ç¤ºã€‚å› æ­¤ï¼Œè·¯å¾„å¿…é¡»å®Œå…¨ç¼–ç å‘åº•å±‚ Actor å‘é€æ¶ˆæ¯æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ã€‚è¿™æ˜¯é€šè¿‡åœ¨è·¯å¾„å­—ç¬¦ä¸²çš„åœ°å€éƒ¨åˆ†ç¼–ç åè®®ã€ä¸»æœºå’Œç«¯å£æ¥å®ç°çš„ã€‚å½“ Actor ç³»ç»Ÿä»è¿œç¨‹èŠ‚ç‚¹æ¥æ”¶åˆ° Actor è·¯å¾„æ—¶ï¼Œå®ƒæ£€æŸ¥è¯¥è·¯å¾„çš„åœ°å€æ˜¯å¦ä¸è¯¥ Actor ç³»ç»Ÿçš„åœ°å€åŒ¹é…ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒå°†è§£æä¸º Actor çš„æœ¬åœ°å¼•ç”¨ã€‚å¦åˆ™ï¼Œå®ƒå°†ç”±è¿œç¨‹ Actor å¼•ç”¨è¡¨ç¤ºã€‚</p>

<h3 id="358-actor-è·¯å¾„çš„é¡¶çº§èŒƒå›´">3.5.8. Actor è·¯å¾„çš„é¡¶çº§èŒƒå›´</h3>
<p>åœ¨è·¯å¾„å±‚æ¬¡ç»“æ„çš„æ ¹ç›®å½•ä¸‹ï¼Œå­˜åœ¨æ ¹ç›®å½•å®ˆæŠ¤è€…ï¼Œåœ¨å…¶ä¸Šå¯ä»¥æ‰¾åˆ°æ‰€æœ‰å…¶ä»– Actorï¼›å…¶åç§°ä¸º<code class="language-plaintext highlighter-rouge">"/"</code>ã€‚ä¸‹ä¸€çº§åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">"/user"</code>æ˜¯æ‰€æœ‰ç”¨æˆ·åˆ›å»ºçš„ Actor çš„é¡¶çº§å®ˆæŠ¤è€… Actorï¼›ä½¿ç”¨<code class="language-plaintext highlighter-rouge">ActorSystem.actorOf</code>åˆ›å»ºçš„ Actor ä½äºæ­¤ Actor çš„ä¸‹é¢ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">"/system"</code>æ˜¯æ‰€æœ‰ç³»ç»Ÿåˆ›å»ºçš„ Actor çš„é¡¶çº§å®ˆæŠ¤è€… Actorï¼Œä¾‹å¦‚åœ¨ Actor ç³»ç»Ÿå¼€å§‹æ—¶é€šè¿‡é…ç½®è‡ªåŠ¨éƒ¨ç½²æ—¥å¿—ç›‘å¬å™¨ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">"/deadletters"</code>æ˜¯æ­»ä¿¡ Actorï¼Œå³æ‰€æœ‰å‘é€åˆ°å·²åœæ­¢æˆ–ä¸å­˜åœ¨çš„ Actor çš„æ¶ˆæ¯éƒ½ä¼šé‡æ–°è·¯ç”±ï¼ˆåœ¨å°½æœ€å¤§åŠªåŠ›çš„åŸºç¡€ä¸Šï¼šæ¶ˆæ¯ä¹Ÿå¯èƒ½ä¼šä¸¢å¤±ï¼Œå³ä½¿æ˜¯åœ¨æœ¬åœ° JVM ä¸­ï¼‰ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">"/temp"</code>æ˜¯æ‰€æœ‰çŸ­æœŸç³»ç»Ÿåˆ›å»ºçš„ Actor çš„å®ˆæŠ¤è€… Actorï¼Œä¾‹å¦‚åœ¨<code class="language-plaintext highlighter-rouge">ActorRef.ask</code>çš„å®ç°ä¸­ä½¿ç”¨çš„ Actorã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">"/remote"</code>æ˜¯ä¸€ä¸ªäººå·¥è·¯å¾„ï¼Œå…¶ä¸‹é¢æ‰€æœ‰ Actor çš„ç›‘ç£è€…éƒ½æ˜¯è¿œç¨‹ Actor å¼•ç”¨ã€‚</li>
</ul>

<p>åƒè¿™æ ·ä¸º Actor æ„å»ºåç§°ç©ºé—´çš„éœ€è¦æºäºä¸€ä¸ªä¸­å¿ƒä¸”éå¸¸ç®€å•çš„è®¾è®¡ç›®æ ‡ï¼šå±‚æ¬¡ç»“æ„ä¸­çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯ä¸€ä¸ª Actorï¼Œå¹¶ä¸”æ‰€æœ‰ Actor éƒ½ä»¥ç›¸åŒçš„æ–¹å¼å·¥ä½œã€‚å› æ­¤ï¼Œä½ ä¸ä»…å¯ä»¥æŸ¥æ‰¾ä½ åˆ›å»ºçš„ Actorï¼Œè¿˜å¯ä»¥æŸ¥æ‰¾ç³»ç»Ÿå®ˆæŠ¤è€…å¹¶å‘å…¶å‘é€æ¶ˆæ¯ï¼ˆåœ¨æœ¬ä¾‹ä¸­ï¼Œå®ƒå°†å°½èŒå°½è´£åœ°ä¸¢å¼ƒè¯¥æ¶ˆæ¯ï¼‰ã€‚è¿™ä¸€å¼ºæœ‰åŠ›çš„åŸåˆ™æ„å‘³ç€ä¸éœ€è¦è®°ä½ä»»ä½•æ€ªç™–ï¼Œå®ƒä½¿æ•´ä¸ªç³»ç»Ÿæ›´åŠ ç»Ÿä¸€å’Œä¸€è‡´ã€‚</p>

<p>å¦‚æœä½ æƒ³æ›´å¤šåœ°äº†è§£ Actor çš„é¡¶å±‚ï¼ˆ<code class="language-plaintext highlighter-rouge">top-level</code>ï¼‰ç»“æ„ï¼Œå¯è§ã€Œ<a href="https://doc.akka.io/docs/akka/current/general/supervision.html#toplevel-supervisors">The Top-Level Supervisors</a>ã€ã€‚</p>

<h2 id="36-ä½ç½®é€æ˜">3.6. ä½ç½®é€æ˜</h2>
<p>ä¸Šä¸€èŠ‚æè¿°äº†å¦‚ä½•ä½¿ç”¨ Actor è·¯å¾„æ¥å¯ç”¨ä½ç½®é€æ˜ï¼ˆ<code class="language-plaintext highlighter-rouge">location transparency</code>ï¼‰ã€‚è¿™ä¸ªç‰¹æ®Šçš„ç‰¹æ€§éœ€è¦ä¸€äº›é¢å¤–çš„è§£é‡Šï¼Œå› ä¸ºåœ¨ç¼–ç¨‹è¯­è¨€ã€å¹³å°å’ŒæŠ€æœ¯çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œç›¸å…³æœ¯è¯­â€œé€æ˜è¿œç¨‹å¤„ç†â€çš„ä½¿ç”¨æ–¹å¼éå¸¸ä¸åŒã€‚</p>

<h3 id="361-é»˜è®¤åˆ†å¸ƒ">3.6.1. é»˜è®¤åˆ†å¸ƒ</h3>
<p>Akka ä¸­çš„æ‰€æœ‰å†…å®¹éƒ½è®¾è®¡æˆåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­å·¥ä½œï¼šActor çš„æ‰€æœ‰äº¤äº’éƒ½ä½¿ç”¨çº¯æ¶ˆæ¯ä¼ é€’ï¼Œè€Œæ‰€æœ‰å†…å®¹éƒ½æ˜¯å¼‚æ­¥çš„ã€‚è¿™é¡¹å·¥ä½œçš„ç›®çš„æ˜¯ç¡®ä¿åœ¨å•ä¸ª JVM ä¸­æˆ–åœ¨æˆç™¾ä¸Šåƒå°æœºå™¨çš„é›†ç¾¤ä¸Šè¿è¡Œæ—¶ï¼Œæ‰€æœ‰åŠŸèƒ½éƒ½å¯ä»¥å¹³ç­‰åœ°ä½¿ç”¨ã€‚å®ç°è¿™ä¸€ç‚¹çš„å…³é”®æ˜¯é€šè¿‡ä¼˜åŒ–ä»è¿œç¨‹åˆ°æœ¬åœ°ï¼Œè€Œä¸æ˜¯é€šè¿‡æ³›åŒ–ä»æœ¬åœ°åˆ°è¿œç¨‹ã€‚æœ‰å…³ç¬¬äºŒç§æ–¹æ³•å¿…ç„¶å¤±è´¥çš„åŸå› çš„è¯¦ç»†è®¨è®ºï¼Œè¯·å‚é˜…è¿™ç¯‡ã€Œ<a href="https://doc.akka.io/docs/misc/smli_tr-94-29.pdf">ç»å…¸</a>ã€æ–‡ç« ã€‚</p>

<h3 id="362-æ‰“ç ´é€æ˜çš„æ–¹æ³•">3.6.2. æ‰“ç ´é€æ˜çš„æ–¹æ³•</h3>
<p>Akka çš„çœŸå®æƒ…å†µä¸å¿…æ˜¯ä½¿ç”¨å®ƒçš„åº”ç”¨ç¨‹åºçš„çœŸå®æƒ…å†µï¼Œå› ä¸ºåˆ†å¸ƒå¼æ‰§è¡Œçš„è®¾è®¡å¯¹å¯èƒ½çš„æƒ…å†µæœ‰ä¸€äº›é™åˆ¶ã€‚æœ€æ˜æ˜¾çš„ä¸€ç‚¹æ˜¯ï¼Œé€šè¿‡çº¿è·¯å‘é€çš„æ‰€æœ‰æ¶ˆæ¯éƒ½å¿…é¡»æ˜¯å¯åºåˆ—åŒ–çš„ã€‚è™½ç„¶ä¸å¤ªæ˜æ˜¾ï¼Œä½†å¦‚æœè¦åœ¨è¿œç¨‹èŠ‚ç‚¹ä¸Šåˆ›å»º Actorï¼Œåˆ™åŒ…å«ç”¨ä½œ Actor å·¥å‚ï¼ˆå³åœ¨<code class="language-plaintext highlighter-rouge">Props</code>ä¸­ï¼‰çš„é—­åŒ…ã€‚</p>

<p>å¦ä¸€ä¸ªåæœæ˜¯ï¼Œæ¯ä»¶äº‹éƒ½éœ€è¦æ„è¯†åˆ°æ‰€æœ‰çš„äº¤äº’éƒ½æ˜¯å®Œå…¨å¼‚æ­¥çš„ï¼Œåœ¨è®¡ç®—æœºç½‘ç»œä¸­ï¼Œè¿™å¯èƒ½æ„å‘³ç€æ¶ˆæ¯åˆ°è¾¾æ”¶ä»¶äººå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼ˆå–å†³äºé…ç½®ï¼‰ã€‚è¿™è¿˜æ„å‘³ç€æ¶ˆæ¯ä¸¢å¤±çš„æ¦‚ç‡è¦æ¯”ä¸€ä¸ª JVM ä¸­çš„é«˜å¾ˆå¤šï¼Œåœ¨åŒä¸€ä¸ª JVM ä¸­ï¼Œå®ƒæ¥è¿‘äºé›¶ï¼Œä½†ä»ç„¶æ˜¯ï¼šæ²¡æœ‰ç¡¬ä¿è¯ï¼</p>

<h3 id="363-å¦‚ä½•ä½¿ç”¨è¿œç¨‹å¤„ç†">3.6.3. å¦‚ä½•ä½¿ç”¨è¿œç¨‹å¤„ç†ï¼Ÿ</h3>
<p>æˆ‘ä»¬å°†é€æ˜çš„æ¦‚å¿µé™åˆ¶åœ¨å‡ ä¹æ²¡æœ‰ç”¨äº Akka è¿œç¨‹å¤„ç†å±‚çš„ APIï¼šå®ƒçº¯ç²¹æ˜¯ç”±é…ç½®é©±åŠ¨çš„ã€‚åªéœ€æ ¹æ®å‰é¢å‡ èŠ‚ä¸­æ¦‚è¿°çš„åŸåˆ™ç¼–å†™åº”ç”¨ç¨‹åºï¼Œç„¶ååœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®š Actor å­æ ‘çš„è¿œç¨‹éƒ¨ç½²ã€‚è¿™æ ·ï¼Œä½ çš„åº”ç”¨ç¨‹åºå°±å¯ä»¥åœ¨ä¸éœ€è¦è§¦æ‘¸ä»£ç çš„æƒ…å†µä¸‹è¿›è¡Œæ‰©å±•ã€‚API ä¸­å”¯ä¸€å…è®¸å¯¹è¿œç¨‹éƒ¨ç½²äº§ç”Ÿç¼–ç¨‹å½±å“çš„éƒ¨åˆ†æ˜¯ï¼Œ<code class="language-plaintext highlighter-rouge">Props</code>åŒ…å«ä¸€ä¸ªå¯ä»¥è®¾ç½®ä¸ºç‰¹å®š<code class="language-plaintext highlighter-rouge">Deploy</code>å®ä¾‹çš„å­—æ®µï¼›è¿™ä¸å°†ç­‰æ•ˆéƒ¨ç½²æ”¾å…¥é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœä¸¤è€…éƒ½ç»™å‡ºï¼Œåˆ™é…ç½®æ–‡ä»¶è·èƒœï¼‰çš„æ•ˆæœç›¸åŒã€‚</p>

<h3 id="364-peer-to-peer-vs-client-server">3.6.4. Peer-to-Peer vs. Client-Server</h3>
<p>Akka è¿œç¨‹å¤„ç†æ˜¯ä¸€ç§ä»¥å¯¹ç­‰ï¼ˆ<code class="language-plaintext highlighter-rouge">peer-to-peer</code>ï¼Œæˆ–è€…ç§°ä¹‹ä¸ºâ€œç‚¹å¯¹ç‚¹â€ï¼‰æ–¹å¼è¿æ¥ Actor ç³»ç»Ÿçš„é€šä¿¡æ¨¡å—ï¼Œæ˜¯ Akka é›†ç¾¤çš„åŸºç¡€ã€‚è¿œç¨‹å¤„ç†çš„è®¾è®¡ç”±ä¸¤ä¸ªï¼ˆç›¸å…³çš„ï¼‰è®¾è®¡å†³ç­–é©±åŠ¨ï¼š</p>

<ol>
  <li>æ‰€æ¶‰åŠç³»ç»Ÿä¹‹é—´çš„é€šä¿¡æ˜¯å¯¹ç§°çš„ï¼šå¦‚æœç³»ç»Ÿ A å¯ä»¥è¿æ¥åˆ°ç³»ç»Ÿ Bï¼Œé‚£ä¹ˆç³»ç»Ÿ B ä¹Ÿå¿…é¡»èƒ½å¤Ÿç‹¬ç«‹åœ°è¿æ¥åˆ°ç³»ç»Ÿ Aã€‚</li>
  <li>å°±è¿æ¥æ¨¡å¼è€Œè¨€ï¼Œé€šä¿¡ç³»ç»Ÿçš„è§’è‰²æ˜¯å¯¹ç§°çš„ï¼šæ²¡æœ‰åªæ¥å—è¿æ¥çš„ç³»ç»Ÿï¼Œä¹Ÿæ²¡æœ‰åªå¯åŠ¨è¿æ¥çš„ç³»ç»Ÿã€‚</li>
</ol>

<p>è¿™äº›å†³ç­–çš„ç»“æœæ˜¯ä¸å¯èƒ½å®‰å…¨åœ°åˆ›å»ºå…·æœ‰é¢„å®šä¹‰è§’è‰²çš„çº¯â€œå®¢æˆ·ç«¯-æœåŠ¡å™¨â€è®¾ç½®ï¼ˆè¿åå‡è®¾ 2ï¼‰ã€‚å¯¹äºâ€œå®¢æˆ·ç«¯-æœåŠ¡å™¨â€è®¾ç½®ï¼Œæœ€å¥½ä½¿ç”¨ HTTP æˆ– Akka I/Oã€‚</p>

<ul>
  <li><strong>é‡è¦æç¤º</strong>ï¼šä½¿ç”¨æ¶‰åŠç½‘ç»œåœ°å€è½¬æ¢çš„è®¾ç½®ã€è´Ÿè½½å‡è¡¡å™¨æˆ– Docker å®¹å™¨è¿åå‡è®¾ 1ï¼Œé™¤éåœ¨ç½‘ç»œé…ç½®ä¸­é‡‡å–å…¶ä»–æ­¥éª¤ä»¥å…è®¸ç›¸å…³ç³»ç»Ÿä¹‹é—´çš„å¯¹ç§°é€šä¿¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥å°† Akka é…ç½®ä¸ºç»‘å®šåˆ°ä¸åŒäºç”¨äºåœ¨ Akka èŠ‚ç‚¹ä¹‹é—´å»ºç«‹è¿æ¥çš„ç½‘ç»œåœ°å€ã€‚è¯¦è§ã€Œ<a href="https://doc.akka.io/docs/akka/current/remoting.html#remote-configuration-nat"> Akka behind NAT or in a Docker container</a>ã€ã€‚</li>
</ul>

<h3 id="365-ç”¨è·¯ç”±å™¨æ‰©å®¹æ ‡è®°ç‚¹">3.6.5. ç”¨è·¯ç”±å™¨æ‰©å®¹æ ‡è®°ç‚¹</h3>

<p>é™¤äº†èƒ½å¤Ÿåœ¨é›†ç¾¤çš„ä¸åŒèŠ‚ç‚¹ä¸Šè¿è¡Œ Actor ç³»ç»Ÿçš„ä¸åŒéƒ¨åˆ†ä¹‹å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡å°†æ”¯æŒå¹¶è¡ŒåŒ–çš„ Actor å­æ ‘ï¼ˆä¾‹å¦‚ï¼Œæœç´¢å¼•æ“å¹¶è¡Œå¤„ç†ä¸åŒçš„æŸ¥è¯¢ï¼‰ç›¸ä¹˜ï¼Œæ‰©å±•åˆ°æ›´å¤šçš„æ ¸å¿ƒã€‚ç„¶åï¼Œå…‹éš†å¯ä»¥ä»¥ä¸åŒçš„æ–¹å¼è¢«è·¯ç”±åˆ°ï¼Œä¾‹å¦‚å¾ªç¯ã€‚å®ç°è¿™ä¸€ç‚¹çš„å”¯ä¸€å¿…è¦çš„æ˜¯ï¼Œå¼€å‘äººå‘˜éœ€è¦å°†æŸä¸ª Actor å£°æ˜ä¸º<code class="language-plaintext highlighter-rouge">withRouter</code>ï¼Œç„¶åå–è€Œä»£ä¹‹çš„æ˜¯ï¼Œå°†åˆ›å»ºä¸€ä¸ªè·¯ç”±å™¨ Actorï¼Œè¯¥ Actor å°†ç”Ÿæˆæ‰€éœ€ç±»å‹çš„å¯é…ç½®å­çº§ï¼Œå¹¶ä»¥é…ç½®çš„æ–¹å¼è·¯ç”±åˆ°è¿™äº›å­çº§ã€‚ä¸€æ—¦å£°æ˜äº†è¿™æ ·çš„è·¯ç”±å™¨ï¼Œå°±å¯ä»¥ä»é…ç½®æ–‡ä»¶ä¸­è‡ªç”±åœ°è¦†ç›–å…¶é…ç½®ï¼ŒåŒ…æ‹¬å°†å…¶ä¸ï¼ˆéƒ¨åˆ†ï¼‰å­çº§çš„è¿œç¨‹éƒ¨ç½²æ··åˆåœ¨ä¸€èµ·ã€‚åœ¨ã€Œ<a href="https://github.com/guobinhit/akka-guide/blob/master/articles/actors/routing.md">è·¯ç”±</a>ã€ä¸­å¯ä»¥é˜…è¯»æ›´å¤šå…³äºæ­¤çš„ä¿¡æ¯ã€‚</p>

<hr />

<p><strong>è‹±æ–‡åŸæ–‡é“¾æ¥</strong>ï¼š<a href="https://doc.akka.io/docs/akka/current/general/remoting.html">Location Transparency</a>.</p>

<h2 id="37-akkaå’Œjavaå†…å­˜æ¨¡å‹">3.7. Akkaå’ŒJavaå†…å­˜æ¨¡å‹</h2>

<p>ä½¿ç”¨Lightbendå¹³å°ï¼ˆåŒ…æ‹¬Scalaå’ŒAkkaï¼‰çš„ä¸»è¦å¥½å¤„åœ¨äºï¼Œå®ƒç®€åŒ–äº†ç¼–å†™å¹¶å‘è½¯ä»¶çš„è¿‡ç¨‹ã€‚æœ¬æ–‡è®¨è®ºäº†Lightbendå¹³å°ï¼ˆå°¤å…¶æ˜¯Akkaï¼‰å¦‚ä½•åœ¨å¹¶å‘åº”ç”¨ç¨‹åºä¸­å¤„ç†å…±äº«å†…å­˜ã€‚</p>

<h3 id="371-javaå†…å­˜æ¨¡å‹">3.7.1. Javaå†…å­˜æ¨¡å‹</h3>

<p>åœ¨Java 5ä¹‹å‰ï¼ŒJavaå†…å­˜æ¨¡å‹ï¼ˆJMMï¼‰å®šä¹‰ä¸æ­£ç¡®ã€‚å½“å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«å†…å­˜æ—¶ï¼Œå¯èƒ½ä¼šå¾—åˆ°å„ç§å¥‡æ€ªçš„ç»“æœï¼Œä¾‹å¦‚ï¼š</p>

<ul>
  <li>ä¸€ä¸ªçº¿ç¨‹çœ‹ä¸åˆ°å…¶ä»–çº¿ç¨‹å†™å…¥çš„å€¼ï¼šå¯è§æ€§é—®é¢˜</li>
  <li>çº¿ç¨‹è§‚å¯Ÿåˆ°å…¶ä»–çº¿ç¨‹çš„â€œä¸å¯èƒ½â€è¡Œä¸ºï¼Œè¿™æ˜¯ç”±äºæœªæŒ‰é¢„æœŸçš„é¡ºåºæ‰§è¡ŒæŒ‡ä»¤å¼•èµ·çš„ï¼šæŒ‡ä»¤é‡æ–°æ’åºé—®é¢˜ã€‚</li>
</ul>

<p>éšç€Java 5ä¸­JSR 133çš„å®ç°ï¼Œè®¸å¤šè¿™äº›é—®é¢˜å·²å¾—åˆ°è§£å†³ã€‚JMMæ˜¯åŸºäºâ€œå…ˆäºå‘ç”Ÿâ€å…³ç³»çš„ä¸€ç»„è§„åˆ™ï¼Œè¯¥è§„åˆ™çº¦æŸä½•æ—¶ä¸€ä¸ªå†…å­˜è®¿é—®å¿…é¡»åœ¨å¦ä¸€ä¸ªå†…å­˜è®¿é—®ä¹‹å‰å‘ç”Ÿï¼Œåä¹‹ï¼Œä½•æ—¶å…è®¸å®ƒä»¬æ— åºå‘ç”Ÿã€‚è¿™äº›è§„åˆ™çš„ä¸¤ä¸ªç¤ºä¾‹æ˜¯ï¼š</p>

<ul>
  <li><strong>ç›‘æ§å™¨é”å®šè§„åˆ™</strong>ï¼šåœ¨éšåæ¯æ¬¡è·å–ç›¸åŒé”å®šä¹‹å‰ï¼Œéƒ½ä¼šé‡Šæ”¾é”å®šã€‚</li>
  <li><strong>æ˜“å¤±æ€§å˜é‡è§„åˆ™</strong>ï¼šåœ¨æ¯æ¬¡åç»­è¯»å–åŒä¸€æ˜“å¤±æ€§å˜é‡ä¹‹å‰å‘ç”Ÿæ˜“å¤±æ€§å˜é‡çš„å†™æ“ä½œ</li>
</ul>

<p>å°½ç®¡JMMçœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œä½†è¯¥è§„èŒƒè¯•å›¾åœ¨æ˜“ç”¨æ€§ä¸å†™å…¥é«˜æ€§èƒ½å’Œå¯ä¼¸ç¼©å¹¶å‘æ•°æ®ç»“æ„çš„èƒ½åŠ›ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚</p>

<h3 id="372-actors-å’Œ-java-å†…å­˜æ¨¡å‹">3.7.2. Actors å’Œ Java å†…å­˜æ¨¡å‹</h3>

<p>åœ¨Akkaçš„Actorså®ç°ä¸­ï¼Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥è®©å¤šçº¿ç¨‹åœ¨å…±äº«å†…å­˜ä¸Šæ‰§è¡ŒåŠ¨ä½œ:</p>

<ul>
  <li>å¦‚æœä¸€ä¸ªæ¶ˆæ¯è¢«å‘é€ç»™ä¸€ä¸ªActor(ä¾‹å¦‚å¦ä¸€ä¸ªActor)ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯æ˜¯ä¸å¯å˜çš„ï¼Œä½†å¦‚æœæ¶ˆæ¯ä¸æ˜¯ä¸€ä¸ªæ­£ç¡®æ„é€ çš„ä¸å¯å˜å¯¹è±¡ï¼Œæ²¡æœ‰â€œhappens beforeâ€è§„åˆ™ï¼Œæ¥æ”¶è€…å¯èƒ½ä¼šçœ‹åˆ°éƒ¨åˆ†åˆå§‹åŒ–çš„æ•°æ®ç»“æ„ï¼Œç”šè‡³å¯èƒ½å‡­ç©ºçœ‹åˆ°å€¼(long /double)ã€‚</li>
  <li>å¦‚æœactoråœ¨å¤„ç†æ¶ˆæ¯æ—¶æ›´æ”¹äº†å…¶å†…éƒ¨çŠ¶æ€ï¼Œå¹¶åœ¨ç¨åå¤„ç†å¦ä¸€æ¡æ¶ˆæ¯æ—¶è®¿é—®è¯¥çŠ¶æ€ã€‚é‡è¦çš„æ˜¯è¦è®¤è¯†åˆ°ï¼Œå¯¹äºactoræ¨¡å‹ï¼Œæ‚¨ä¸èƒ½ä¿è¯ç›¸åŒçš„çº¿ç¨‹å°†ä¸ºä¸åŒçš„æ¶ˆæ¯æ‰§è¡Œç›¸åŒçš„actorã€‚</li>
</ul>

<p>ä¸ºäº†é˜²æ­¢actorä¸Šçš„å¯è§æ€§å’Œé‡æ–°æ’åºé—®é¢˜ï¼ŒAkkaä¿è¯äº†ä»¥ä¸‹ä¸¤ä¸ªâ€œhappens beforeâ€è§„åˆ™ï¼š</p>

<ul>
  <li>Actorå‘é€è§„åˆ™:å°†æ¶ˆæ¯å‘é€ç»™actorçš„è¿‡ç¨‹å‘ç”Ÿåœ¨åŒä¸€actoræ¥æ”¶æ¶ˆæ¯ä¹‹å‰ã€‚</li>
  <li>Actoråç»­å¤„ç†è§„åˆ™:åŒä¸€Actoråœ¨å¤„ç†ä¸‹ä¸€æ¡æ¶ˆæ¯ä¹‹å‰å¤„ç†ä¸€æ¡æ¶ˆæ¯ã€‚</li>
</ul>

<blockquote>
  <p><strong>è¯·æ³¨æ„</strong>
ç”¨å¤–è¡Œäººçš„è¯è¯´ï¼Œè¿™æ„å‘³ç€å½“actorå¤„ç†ä¸‹ä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œactorå†…éƒ¨å­—æ®µçš„æ›´æ”¹æ˜¯å¯è§çš„ã€‚å› æ­¤ï¼Œactorä¸­çš„å­—æ®µä¸éœ€è¦æ˜¯volatileæˆ–ç­‰æ•ˆçš„ã€‚</p>
</blockquote>

<p>è¿™ä¸¤ä¸ªè§„åˆ™ä»…é€‚ç”¨äºç›¸åŒçš„actorå®ä¾‹ï¼Œå¦‚æœä½¿ç”¨ä¸åŒçš„actoråˆ™æ— æ•ˆ</p>

<h3 id="373-futureså’Œjavaå†…å­˜">3.7.3. Futureså’ŒJAVAå†…å­˜</h3>

<p>æœªæ¥çš„å®Œæˆâ€œhappens beforeâ€å¯¹å…¶æ³¨å†Œçš„ä»»ä½•å›è°ƒè°ƒç”¨è¢«æ‰§è¡Œä¹‹å‰ã€‚</p>

<p>æˆ‘ä»¬å»ºè®®ä¸è¦å…³é—­éfinalå­—æ®µ(Javaä¸­çš„finalå’ŒScalaä¸­çš„val)ï¼Œå¦‚æœä½ é€‰æ‹©å…³é—­éfinalå­—æ®µï¼Œå®ƒä»¬å¿…é¡»è¢«æ ‡è®°ä¸ºvolatileï¼Œä»¥ä¾¿å­—æ®µçš„å½“å‰å€¼å¯¹å›è°ƒå¯è§ã€‚</p>

<p>å¦‚æœå…³é—­å¼•ç”¨ï¼Œè¿˜å¿…é¡»ç¡®ä¿å¼•ç”¨çš„å®ä¾‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚æˆ‘ä»¬å¼ºçƒˆå»ºè®®è¿œç¦»ä½¿ç”¨é”çš„å¯¹è±¡ï¼Œå› ä¸ºå®ƒä¼šå¸¦æ¥æ€§èƒ½é—®é¢˜ï¼Œåœ¨æœ€åçš„æƒ…å†µä¸‹ï¼Œè¿˜ä¼šå¯¼è‡´æ­»é”ã€‚</p>

<h3 id="374-actors-å’Œå…±äº«å¯å˜çŠ¶æ€">3.7.4. Actors å’Œå…±äº«å¯å˜çŠ¶æ€</h3>

<p>å› ä¸ºAkkaè¿è¡Œåœ¨JVMä¸Šï¼Œæ‰€ä»¥ä»ç„¶éœ€è¦éµå®ˆä¸€äº›è§„åˆ™ã€‚</p>

<p>æœ€é‡è¦çš„æ˜¯ï¼Œä½ ä¸èƒ½å…³é—­å†…éƒ¨ Actor çŠ¶æ€ï¼Œå¹¶æš´éœ²ç»™å…¶ä»–çº¿ç¨‹:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">MyActor</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">MyActor</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">class</span> <span class="nc">Message</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">otherActor</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Message</span><span class="o">(</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">otherActor</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">class</span> <span class="nc">UpdateState</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">newState</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">UpdateState</span><span class="o">(</span><span class="nc">String</span> <span class="n">newState</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">newState</span> <span class="o">=</span> <span class="n">newState</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">String</span> <span class="n">state</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">mySet</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>

  <span class="kd">public</span> <span class="nf">MyActor</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onMessage</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">UpdateState</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onUpdateState</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Very bad: shared mutable object allows</span>
    <span class="c1">// the other actor to mutate your own state,</span>
    <span class="c1">// or worse, you might get weird race conditions</span>
    <span class="n">message</span><span class="o">.</span><span class="na">otherActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">mySet</span><span class="o">);</span>

    <span class="c1">// Example of incorrect approach</span>
    <span class="c1">// Very bad: shared mutable state will cause your</span>
    <span class="c1">// application to break in weird ways</span>
    <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">runAsync</span><span class="o">(</span>
        <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="n">state</span> <span class="o">=</span> <span class="s">"This will race"</span><span class="o">;</span>
        <span class="o">});</span>

    <span class="c1">// Example of incorrect approach</span>
    <span class="c1">// Very bad: shared mutable state will cause your</span>
    <span class="c1">// application to break in weird ways</span>
    <span class="n">expensiveCalculation</span><span class="o">()</span>
        <span class="o">.</span><span class="na">whenComplete</span><span class="o">(</span>
            <span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">failure</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">state</span> <span class="o">=</span> <span class="s">"new state: "</span> <span class="o">+</span> <span class="n">result</span><span class="o">;</span>
            <span class="o">});</span>

    <span class="c1">// Example of correct approach</span>
    <span class="c1">// Turn the future result into a message that is sent to</span>
    <span class="c1">// self when future completes</span>
    <span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">futureResult</span> <span class="o">=</span> <span class="n">expensiveCalculation</span><span class="o">();</span>
    <span class="n">getContext</span><span class="o">()</span>
        <span class="o">.</span><span class="na">pipeToSelf</span><span class="o">(</span>
            <span class="n">futureResult</span><span class="o">,</span>
            <span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">failure</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="k">new</span> <span class="nc">UpdateState</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
              <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">failure</span><span class="o">);</span>
            <span class="o">});</span>

    <span class="c1">// Another example of incorrect approach</span>
    <span class="c1">// mutating actor state from ask future callback</span>
    <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span>
        <span class="nc">AskPattern</span><span class="o">.</span><span class="na">ask</span><span class="o">(</span>
            <span class="n">message</span><span class="o">.</span><span class="na">otherActor</span><span class="o">,</span>
            <span class="nl">Query:</span><span class="o">:</span><span class="k">new</span><span class="o">,</span>
            <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span>
            <span class="n">getContext</span><span class="o">().</span><span class="na">getSystem</span><span class="o">().</span><span class="na">scheduler</span><span class="o">());</span>
    <span class="n">response</span><span class="o">.</span><span class="na">whenComplete</span><span class="o">(</span>
        <span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">failure</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">state</span> <span class="o">=</span> <span class="s">"new state: "</span> <span class="o">+</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">});</span>

    <span class="c1">// use context.ask instead, turns the completion</span>
    <span class="c1">// into a message sent to self</span>
    <span class="n">getContext</span><span class="o">()</span>
        <span class="o">.</span><span class="na">ask</span><span class="o">(</span>
            <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">message</span><span class="o">.</span><span class="na">otherActor</span><span class="o">,</span>
            <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span>
            <span class="nl">Query:</span><span class="o">:</span><span class="k">new</span><span class="o">,</span>
            <span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">failure</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="k">new</span> <span class="nc">UpdateState</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
              <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">failure</span><span class="o">);</span>
            <span class="o">});</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onUpdateState</span><span class="o">(</span><span class="nc">UpdateState</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// safe as long as `newState` is immutable, if it is mutable we'd need to</span>
    <span class="c1">// make a defensive copy</span>
    <span class="k">this</span><span class="o">.</span><span class="na">state</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="na">newState</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ¶ˆæ¯åº”è¯¥æ˜¯ä¸å¯å˜çš„ï¼Œè¿™æ˜¯ä¸ºäº†é¿å…å…±äº«çš„å¯å˜çŠ¶æ€é™·é˜±ã€‚</p>

<h2 id="38-æ¶ˆæ¯ä¼ é€’å¯é æ€§">3.8. æ¶ˆæ¯ä¼ é€’å¯é æ€§</h2>

<p>Akka å¸®åŠ©ä½ æ„å»ºå¯é çš„åº”ç”¨ç¨‹åºï¼Œè¿™äº›åº”ç”¨ç¨‹åºå¯ä»¥åœ¨ä¸€å°æœºå™¨ä¸­ä½¿ç”¨å¤šä¸ªå¤„ç†å™¨æ ¸å¿ƒï¼ˆ<code class="language-plaintext highlighter-rouge">scaling up</code>ï¼Œçºµå‘æ‰©å±•ï¼‰æˆ–åˆ†å¸ƒåœ¨è®¡ç®—æœºç½‘ç»œä¸­ï¼ˆ<code class="language-plaintext highlighter-rouge">scaling out</code>ï¼Œæ¨ªå‘æ‰©å±•ï¼‰ã€‚å®ç°è¿™ä¸€ç‚¹çš„å…³é”®æŠ½è±¡æ˜¯ï¼Œä»£ç å•å…ƒ Actor ä¹‹é—´çš„æ‰€æœ‰äº¤äº’éƒ½æ˜¯é€šè¿‡æ¶ˆæ¯ä¼ é€’è¿›è¡Œçš„ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Actor ä¹‹é—´ä¼ é€’æ¶ˆæ¯çš„ç²¾ç¡®è¯­ä¹‰åº”è¯¥æœ‰è‡ªå·±çš„ç« èŠ‚ã€‚</p>

<p>ä¸ºäº†ç»™ä¸‹é¢çš„è®¨è®ºæä¾›ä¸€äº›ä¸Šä¸‹æ–‡ï¼Œè¯·è€ƒè™‘è·¨å¤šä¸ªç½‘ç»œä¸»æœºçš„åº”ç”¨ç¨‹åºã€‚æ— è®ºæ˜¯å‘é€åˆ°æœ¬åœ° JVM ä¸Šçš„ Actor è¿˜æ˜¯å‘é€åˆ°è¿œç¨‹ Actorï¼Œé€šä¿¡çš„åŸºæœ¬æœºåˆ¶éƒ½æ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯åœ¨ä¼ é€’å»¶è¿Ÿï¼ˆå¯èƒ½è¿˜å–å†³äºç½‘ç»œé“¾è·¯çš„å¸¦å®½å’Œæ¶ˆæ¯å¤§å°ï¼‰å’Œå¯é æ€§æ–¹é¢ä¼šæœ‰æ˜æ˜¾çš„å·®å¼‚ã€‚åœ¨è¿œç¨‹æ¶ˆæ¯å‘é€çš„æƒ…å†µä¸‹ï¼Œæ¶‰åŠåˆ°æ›´å¤šçš„æ­¥éª¤ï¼Œè¿™æ„å‘³ç€æ›´å¤šçš„æ­¥éª¤å¯èƒ½å‡ºé”™ã€‚å¦ä¸€ä¸ªæ–¹é¢æ˜¯æœ¬åœ°å‘é€å°†åœ¨åŒä¸€ä¸ª JVM ä¸­ä¼ é€’å¯¹æ¶ˆæ¯çš„å¼•ç”¨ï¼Œè€Œå¯¹å‘é€çš„åº•å±‚å¯¹è±¡æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œè€Œè¿œç¨‹ä¼ è¾“å°†é™åˆ¶æ¶ˆæ¯çš„å¤§å°ã€‚</p>

<p>å› æ­¤å‡è®¾ Actor ä¹‹é—´çš„è¿œç¨‹é€šä¿¡æ˜¯å®‰å…¨çš„ï¼Œè¿™ä¸ªä¸€ä¸ªæ‚²è§‚çš„èµŒæ³¨ã€‚å®ƒæ„å‘³ç€åªä¾èµ–äºé‚£äº›æ€»æ˜¯æœ‰ä¿è¯çš„å±æ€§ï¼Œè¿™äº›å±æ€§å°†åœ¨ä¸‹é¢è¯¦ç»†è®¨è®ºã€‚è¿™åœ¨ Actor çš„å®ç°ä¸­æœ‰ä¸€äº›å¼€é”€ã€‚å¦‚æœä½ æ„¿æ„ç‰ºç‰²å®Œæ•´çš„ä½ç½®é€æ˜æ€§ï¼Œä¾‹å¦‚åœ¨ä¸€ç»„ç´§å¯†åˆä½œçš„ Actor çš„æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥å°†ä»–ä»¬å§‹ç»ˆæ”¾åœ¨åŒä¸€ä¸ª JVM ä¸Šï¼Œå¹¶åœ¨æ¶ˆæ¯ä¼ é€’ä¸Šäº«å—æ›´ä¸¥æ ¼çš„ä¿è¯ã€‚ä¸‹æ–‡å°†è¿›ä¸€æ­¥è®¨è®ºè¿™ç§æƒè¡¡çš„ç»†èŠ‚ã€‚</p>

<p>ä½œä¸ºè¡¥å……éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯¹å¦‚ä½•åœ¨å†…ç½®çš„åŸºç¡€ä¸Šæ„å»ºæ›´å¼ºçš„å¯é æ€§ç»™å‡ºäº†ä¸€äº›å»ºè®®ã€‚æœ¬ç« æœ€åè®¨è®ºäº†â€œæ­»ä¿¡åŠå…¬å®¤ï¼ˆ<code class="language-plaintext highlighter-rouge">Dead Letter Office</code>ï¼‰â€çš„ä½œç”¨ã€‚</p>

<h3 id="381-ä¸€èˆ¬è§„åˆ™">3.8.1. ä¸€èˆ¬è§„åˆ™</h3>

<p>è¿™äº›æ˜¯å‘é€æ¶ˆæ¯çš„è§„åˆ™ï¼ˆå³ï¼Œ<code class="language-plaintext highlighter-rouge">tell</code>æˆ–<code class="language-plaintext highlighter-rouge">!</code>æ–¹æ³•ï¼Œä¹Ÿæ˜¯<code class="language-plaintext highlighter-rouge">ask</code>æ¨¡å¼çš„åŸºç¡€ï¼‰ï¼š</p>

<ul>
  <li>è‡³å¤šä¸€æ¬¡ä¼ é€’ï¼ˆ<code class="language-plaintext highlighter-rouge">at-most-once delivery</code>ï¼‰ï¼Œå³æ²¡æœ‰ä¿è¯çš„ä¼ é€’</li>
  <li>æ¯ä¸ª<code class="language-plaintext highlighter-rouge">senderâ€“receiver</code>å¯¹ï¼ˆ<code class="language-plaintext highlighter-rouge">pair</code>ï¼‰çš„æ¶ˆæ¯æ’åº</li>
</ul>

<p>ç¬¬ä¸€ä¸ªè§„åˆ™é€šå¸¸ä¹Ÿå­˜åœ¨äºå…¶ä»– Actor çš„å®ç°ä¸­ï¼Œè€Œç¬¬äºŒä¸ªè§„åˆ™åˆ™ç‰¹å®šäº Akkaã€‚</p>

<h4 id="3811-è®¨è®ºè‡³å¤šä¸€æ¬¡æ˜¯ä»€ä¹ˆæ„æ€">3.8.1.1. è®¨è®ºï¼šâ€œè‡³å¤šä¸€æ¬¡â€æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</h4>

<p>åœ¨æè¿°ä¼ é€’æœºåˆ¶çš„è¯­ä¹‰æ—¶ï¼Œæœ‰ä¸‰ä¸ªåŸºæœ¬ç±»åˆ«ï¼š</p>

<ul>
  <li>è‡³å¤šä¸€æ¬¡ä¼ é€’ï¼ˆ<code class="language-plaintext highlighter-rouge">at-most-once delivery</code>ï¼‰æ„å‘³ç€å¯¹äºä¼ é€’ç»™è¯¥æœºåˆ¶çš„æ¯ä¸ªæ¶ˆæ¯ï¼Œè¯¥æ¶ˆæ¯è¦ä¹ˆä¼ é€’ä¸€æ¬¡ï¼Œè¦ä¹ˆæ ¹æœ¬ä¸ä¼ é€’ï¼›æ›´éšæ„åœ°è¯´ï¼Œå®ƒæ„å‘³ç€æ¶ˆæ¯å¯èƒ½ä¼šä¸¢å¤±ã€‚</li>
  <li>è‡³å°‘ä¸€æ¬¡ä¼ é€’ï¼ˆ<code class="language-plaintext highlighter-rouge">at-least-once delivery</code>ï¼‰æ„å‘³ç€å¯¹äºä¼ é€’ç»™è¯¥æœºåˆ¶çš„æ¯ä¸ªæ¶ˆæ¯ï¼Œå¯èƒ½ä¼šå¤šæ¬¡å°è¯•ä¼ é€’å®ƒï¼Œä»è€Œè‡³å°‘ä¸€æ¬¡æˆåŠŸï¼›åŒæ ·ï¼Œåœ¨æ›´éšæ„çš„æƒ…å†µä¸‹ï¼Œè¿™æ„å‘³ç€æ¶ˆæ¯å¯èƒ½é‡å¤ï¼Œä½†ä¸ä¼šä¸¢å¤±ã€‚</li>
  <li>ç²¾ç¡®ä¸€æ¬¡ä¼ é€’ï¼ˆ<code class="language-plaintext highlighter-rouge">exactly-once delivery</code>ï¼‰æ„å‘³ç€å¯¹äºä¼ é€’ç»™è¯¥æœºåˆ¶çš„æ¯ä¸ªæ¶ˆæ¯ï¼Œåªå‘æ¥æ”¶è€…ä¼ é€’ä¸€æ¬¡ï¼›æ¶ˆæ¯æ—¢ä¸èƒ½ä¸¢å¤±ä¹Ÿä¸èƒ½é‡å¤ã€‚</li>
</ul>

<p>ç¬¬ä¸€ç§æ˜¯æœ€å»‰ä»·å’Œé«˜æ•ˆçš„ï¼Œè€Œä¸”æ‹¥æœ‰æœ€ä½çš„å®ç°å¼€é”€ï¼Œå› ä¸ºå®ƒå¯ä»¥åœ¨å‘é€ç«¯æˆ–ä¼ è¾“æœºåˆ¶ä¸­ä»¥ä¸ä¿æŒçŠ¶æ€çš„æƒ…å†µä¸‹ä»¥â€œå³å‘å³å¼ƒï¼ˆ<code class="language-plaintext highlighter-rouge">fire-and-forget</code>ï¼‰â€çš„æ–¹å¼å®Œæˆã€‚ç¬¬äºŒç§éœ€è¦é‡è¯•ä»¥åº”å¯¹ä¼ è¾“æŸå¤±ï¼Œè¿™æ„å‘³ç€åœ¨å‘é€ç«¯ä¿æŒçŠ¶æ€ï¼Œåœ¨æ¥æ”¶ç«¯å…·æœ‰ç¡®è®¤æœºåˆ¶ã€‚ç¬¬ä¸‰ç§æ˜¯æœ€æ˜‚è´µçš„ï¼Œå› æ­¤æ€§èƒ½æœ€å·®ï¼Œå› ä¸ºé™¤äº†ç¬¬äºŒç§ä¹‹å¤–ï¼Œå®ƒè¿˜è¦æ±‚çŠ¶æ€ä¿æŒåœ¨æ¥æ”¶ç«¯ï¼Œä»¥ä¾¿è¿‡æ»¤å‡ºé‡å¤çš„ä¼ é€’ã€‚</p>

<h4 id="3812-è®¨è®ºä¸ºä»€ä¹ˆä¸ä¿è¯ä¼ é€’">3.8.1.2. è®¨è®ºï¼šä¸ºä»€ä¹ˆä¸ä¿è¯ä¼ é€’ï¼Ÿ</h4>

<p>é—®é¢˜çš„æ ¸å¿ƒåœ¨äºè¿™ä¸ªä¿è¯åˆ°åº•æ„å‘³ç€ä»€ä¹ˆï¼š</p>

<ol>
  <li>æ¶ˆæ¯åœ¨ç½‘ç»œä¸Šå‘é€ï¼Ÿ</li>
  <li>æ¶ˆæ¯æ˜¯ç”±å¦ä¸€ä¸ªä¸»æœºæ¥æ”¶çš„ï¼Ÿ</li>
  <li>æ¶ˆæ¯è¢«æ”¾å…¥ç›®æ ‡ Actor çš„é‚®ç®±ï¼Ÿ</li>
  <li>ç›®æ ‡ Actor æ­£åœ¨å¼€å§‹å¤„ç†æ¶ˆæ¯ï¼Ÿ</li>
  <li>ç›®æ ‡ Actor æ˜¯å¦æˆåŠŸå¤„ç†äº†æ¶ˆæ¯ï¼Ÿ</li>
</ol>

<p>å…¶ä¸­æ¯ä¸€ä¸ªéƒ½æœ‰ä¸åŒçš„æŒ‘æˆ˜å’Œæˆæœ¬ï¼Œå¾ˆæ˜æ˜¾ï¼Œåœ¨æŸäº›æ¡ä»¶ä¸‹ï¼Œä»»ä½•é‚®ä»¶ä¼ é€’åº“éƒ½å°†æ— æ³•éµå®ˆï¼›ä¾‹å¦‚ï¼Œè€ƒè™‘å¯é…ç½®çš„é‚®ç®±ç±»å‹ä»¥åŠç»‘å®šé‚®ç®±å¦‚ä½•ä¸ç¬¬ä¸‰ç‚¹äº¤äº’ï¼Œç”šè‡³ç¬¬äº”ç‚¹è€ƒè™‘å†³å®šâ€œæˆåŠŸâ€éƒ¨åˆ†çš„æ„ä¹‰ã€‚</p>

<p>åŒæ ·çš„é“ç†æ˜¯ï¼Œã€Œ<a href="https://www.infoq.com/articles/no-reliable-messaging">æ²¡æœ‰äººéœ€è¦å¯é çš„æ¶ˆæ¯ä¼ é€’</a>ã€ã€‚å‘é€æ–¹äº†è§£äº¤äº’æ˜¯å¦æˆåŠŸçš„å”¯ä¸€æœ‰æ„ä¹‰çš„æ–¹æ³•æ˜¯æ¥æ”¶ä¸šåŠ¡çš„ç¡®è®¤æ¶ˆæ¯ï¼Œè¿™ä¸æ˜¯ Akka å¯ä»¥è‡ªå·±å®Œæˆçš„ï¼Œæˆ‘ä»¬æ—¢ä¸ç¼–å†™â€œæŒ‰æˆ‘çš„æ„æ€åšâ€çš„æ¡†æ¶ï¼Œä¹Ÿä¸å¸Œæœ›è¿™æ ·åšã€‚</p>

<p>Akka é‡‡ç”¨åˆ†å¸ƒå¼è®¡ç®—ï¼Œå¹¶é€šè¿‡æ¶ˆæ¯ä¼ é€’ä½¿é€šä¿¡çš„æ˜“å‡ºé”™æ€§å˜å¾—æ˜ç¡®ï¼Œå› æ­¤å®ƒä¸ä¼šè¯•å›¾æ’’è°å¹¶æ¨¡æ‹Ÿæ³„æ¼çš„æŠ½è±¡ã€‚è¿™æ˜¯ä¸€ä¸ªåœ¨ Erlang æˆåŠŸä½¿ç”¨çš„æ¨¡å‹ï¼Œéœ€è¦ç”¨æˆ·å›´ç»•å®ƒè®¾è®¡è‡ªå·±çš„åº”ç”¨ç¨‹åºã€‚ä½ å¯ä»¥åœ¨ã€Œ<a href="http://erlang.org/faq/academic.html">Erlang æ–‡æ¡£</a>ã€çš„ç¬¬ 10.9 èŠ‚å’Œç¬¬ 10.10 èŠ‚ä¸­äº†è§£æ›´å¤šå…³äºè¿™ç§æ–¹æ³•çš„ä¿¡æ¯ï¼ŒAkka å°†å¯†åˆ‡å…³æ³¨å®ƒã€‚</p>

<p>å…³äºè¿™ä¸ªé—®é¢˜çš„å¦ä¸€ä¸ªè§’åº¦æ˜¯ï¼Œåªæä¾›åŸºæœ¬çš„ä¿è¯ï¼Œé‚£äº›ä¸éœ€è¦æ›´é«˜å¯é æ€§çš„ç”¨ä¾‹ä¸éœ€è¦æ”¯ä»˜å®ƒä»¬çš„å®ç°æˆæœ¬ï¼›æ€»æ˜¯å¯ä»¥åœ¨åŸºæœ¬ç”¨ä¾‹ä¹‹ä¸Šæ·»åŠ æ›´é«˜çš„å¯é æ€§ï¼Œä½†æ˜¯ä¸å¯èƒ½ä¸ºäº†è·å¾—æ›´å¤šçš„æ€§èƒ½è€Œä¸»åŠ¨åœ°åˆ é™¤å¯é æ€§ã€‚</p>

<h4 id="3813-è®¨è®ºæ¶ˆæ¯æ’åº">3.8.1.3. è®¨è®ºï¼šæ¶ˆæ¯æ’åº</h4>

<p>æ›´å…·ä½“çš„è§„åˆ™æ˜¯ï¼Œå¯¹äºç»™å®šçš„ä¸€å¯¹ Actorï¼Œç›´æ¥ä»ç¬¬ä¸€ä¸ª Actor å‘é€åˆ°ç¬¬äºŒä¸ª Actor çš„æ¶ˆæ¯ä¸ä¼šè¢«æ— åºæ¥æ”¶ã€‚è¯¥è¯ç›´æ¥å¼ºè°ƒï¼Œè¯¥ä¿è¯ä»…é€‚ç”¨äºä¸<code class="language-plaintext highlighter-rouge">tell</code>è¿ç®—ç¬¦ä¸€èµ·å‘é€åˆ°æœ€ç»ˆç›®çš„åœ°æ—¶ï¼Œè€Œä¸é€‚ç”¨äºä½¿ç”¨ä¸­ä»‹æˆ–å…¶ä»–æ¶ˆæ¯åˆ†å‘åŠŸèƒ½æ—¶ï¼Œé™¤éå¦æœ‰è¯´æ˜ã€‚</p>

<p>ä¿è¯è¯´æ˜å¦‚ä¸‹ï¼š</p>

<ul>
  <li>Actor <code class="language-plaintext highlighter-rouge">A1</code>å‘<code class="language-plaintext highlighter-rouge">A2</code>å‘é€æ¶ˆæ¯<code class="language-plaintext highlighter-rouge">M1</code>ã€<code class="language-plaintext highlighter-rouge">M2</code>ã€<code class="language-plaintext highlighter-rouge">M3</code></li>
  <li>Actor <code class="language-plaintext highlighter-rouge">A3</code>å‘<code class="language-plaintext highlighter-rouge">A2</code>å‘é€æ¶ˆæ¯<code class="language-plaintext highlighter-rouge">M4</code>ã€<code class="language-plaintext highlighter-rouge">M5</code>ã€<code class="language-plaintext highlighter-rouge">M6</code></li>
</ul>

<p>è¿™æ„å‘³ç€ï¼š</p>

<ol>
  <li>å¦‚æœ<code class="language-plaintext highlighter-rouge">M1</code>è¢«æ¥æ”¶ï¼Œåˆ™å¿…é¡»åœ¨<code class="language-plaintext highlighter-rouge">M2</code>å’Œ<code class="language-plaintext highlighter-rouge">M3</code>ä¹‹å‰æ¥æ”¶ã€‚</li>
  <li>å¦‚æœ<code class="language-plaintext highlighter-rouge">M2</code>è¢«æ¥æ”¶ï¼Œå¿…é¡»åœ¨<code class="language-plaintext highlighter-rouge">M3</code>ä¹‹å‰æ¥æ”¶ã€‚</li>
  <li>å¦‚æœ<code class="language-plaintext highlighter-rouge">M4</code>è¢«æ¥æ”¶ï¼Œåˆ™å¿…é¡»åœ¨<code class="language-plaintext highlighter-rouge">M5</code>å’Œ<code class="language-plaintext highlighter-rouge">M6</code>ä¹‹å‰æ¥æ”¶ã€‚</li>
  <li>å¦‚æœ<code class="language-plaintext highlighter-rouge">M5</code>è¢«æ¥æ”¶ï¼Œåˆ™å¿…é¡»åœ¨<code class="language-plaintext highlighter-rouge">M6</code>ä¹‹å‰æ¥æ”¶ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">A2</code>å¯ä»¥çœ‹åˆ°<code class="language-plaintext highlighter-rouge">A1</code>çš„æ¶ˆæ¯ä¸<code class="language-plaintext highlighter-rouge">A3</code>çš„æ¶ˆæ¯äº¤ç»‡åœ¨ä¸€èµ·ã€‚</li>
  <li>ç”±äºæ²¡æœ‰ä¿è¯çš„ä¼ é€’ï¼Œä»»ä½•ä¿¡æ¯éƒ½å¯èƒ½è¢«ä¸¢å¼ƒï¼Œå³ä¸èƒ½åˆ°è¾¾<code class="language-plaintext highlighter-rouge">A2</code>ã€‚</li>
</ol>

<p>åœ¨æ­¤ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒAkka çš„ä¿è¯é€‚ç”¨äºé‚®ä»¶è¿›å…¥æ”¶ä»¶äººé‚®ç®±çš„é¡ºåºã€‚å¦‚æœé‚®ç®±å®ç°ä¸éµå¾ª<code class="language-plaintext highlighter-rouge">FIFO</code>é¡ºåºï¼ˆä¾‹å¦‚<code class="language-plaintext highlighter-rouge">PriorityMailbox</code>ï¼‰ï¼Œé‚£ä¹ˆ Actor çš„å¤„ç†é¡ºåºå¯èƒ½ä¼šåç¦»æ’é˜Ÿé¡ºåºã€‚</p>

<p>è¯·æ³¨æ„ï¼Œæ­¤è§„åˆ™ä¸å¯ä¼ é€’ï¼š</p>

<ul>
  <li>Actor <code class="language-plaintext highlighter-rouge">A</code>å°†æ¶ˆæ¯<code class="language-plaintext highlighter-rouge">M1</code>å‘é€ç»™ Actor <code class="language-plaintext highlighter-rouge">C</code></li>
  <li>Actor <code class="language-plaintext highlighter-rouge">A</code>å°†æ¶ˆæ¯<code class="language-plaintext highlighter-rouge">M2</code>å‘é€ç»™ Actor <code class="language-plaintext highlighter-rouge">B</code></li>
  <li>Actor <code class="language-plaintext highlighter-rouge">B</code>å°†æ¶ˆæ¯<code class="language-plaintext highlighter-rouge">M2</code>è½¬å‘ç»™ Actor <code class="language-plaintext highlighter-rouge">C</code></li>
  <li>Actor <code class="language-plaintext highlighter-rouge">C</code>å¯ä»¥æ¥å—ä»»ä½•é¡ºåºçš„<code class="language-plaintext highlighter-rouge">M1</code>å’Œ<code class="language-plaintext highlighter-rouge">M2</code></li>
</ul>

<p>å› æœä¼ é€’æ’åºï¼ˆ<code class="language-plaintext highlighter-rouge">Causal transitive ordering</code>ï¼‰æ„å‘³ç€<code class="language-plaintext highlighter-rouge">M2</code>åœ¨<code class="language-plaintext highlighter-rouge">M1</code>ä¹‹å‰ä»æœªåœ¨ Actor <code class="language-plaintext highlighter-rouge">C</code>æ”¶åˆ°è¿‡ï¼Œå°½ç®¡å…¶ä¸­ä»»ä½•ä¸€ä¸ªéƒ½å¯èƒ½ä¸¢å¤±ã€‚å½“<code class="language-plaintext highlighter-rouge">A</code>ã€<code class="language-plaintext highlighter-rouge">B</code>å’Œ<code class="language-plaintext highlighter-rouge">C</code>é©»ç•™åœ¨ä¸åŒçš„ç½‘ç»œä¸»æœºä¸Šæ—¶ï¼Œç”±äºä¸åŒçš„æ¶ˆæ¯ä¼ é€’å»¶è¿Ÿï¼Œå¯èƒ½ä¼šè¿åæ­¤é¡ºåºï¼Œå…·ä½“è¯·å‚é˜…ä¸‹é¢çš„è¯¦ç»†ä¿¡æ¯ã€‚</p>

<ul>
  <li><strong>æ³¨é‡Š</strong>ï¼šActor åˆ›å»ºè¢«è§†ä¸ºä»çˆ¶çº§å‘é€åˆ°å­çº§çš„æ¶ˆæ¯ï¼Œå…¶è¯­ä¹‰ä¸ä¸Šé¢è®¨è®ºçš„æ¶ˆæ¯ç›¸åŒã€‚ä»¥è¿™ç§åˆå§‹åˆ›å»ºæ¶ˆæ¯é‡æ–°æ’åºçš„æ–¹å¼å‘ Actor å‘é€æ¶ˆæ¯æ„å‘³ç€æ¶ˆæ¯å¯èƒ½ä¸ä¼šåˆ°è¾¾ï¼Œå› ä¸º Actor è¿˜ä¸å­˜åœ¨ã€‚æ¶ˆæ¯å¯èƒ½æ¥å¾—å¤ªæ—©çš„ä¸€ä¸ªä¾‹å­æ˜¯ï¼Œåˆ›å»ºä¸€ä¸ªè¿œç¨‹éƒ¨ç½²çš„ Actor <code class="language-plaintext highlighter-rouge">R1</code>ï¼Œå°†å…¶å¼•ç”¨å‘é€åˆ°å¦ä¸€ä¸ªè¿œç¨‹ Actor <code class="language-plaintext highlighter-rouge">R2</code>ï¼Œå¹¶è®©<code class="language-plaintext highlighter-rouge">R2</code>å‘<code class="language-plaintext highlighter-rouge">R1</code>å‘é€æ¶ˆæ¯ã€‚å®šä¹‰è‰¯å¥½çš„æ’åºç¤ºä¾‹æ˜¯çˆ¶çº§åˆ›å»º Actor å¹¶ç«‹å³å‘å…¶å‘é€æ¶ˆæ¯ã€‚</li>
</ul>

<h4 id="3814-é€šä¿¡æ•…éšœ">3.8.1.4. é€šä¿¡æ•…éšœ</h4>

<p>è¯·æ³¨æ„ï¼Œä¸Šé¢è®¨è®ºçš„æ’åºä¿è¯ä»…é€‚ç”¨äº Actor ä¹‹é—´çš„ç”¨æˆ·æ¶ˆæ¯ã€‚Actor çš„å­çº§çš„å¤±è´¥æ˜¯é€šè¿‡ç‰¹å®šçš„ç³»ç»Ÿæ¶ˆæ¯è¿›è¡Œé€šä¿¡çš„ï¼Œè¿™äº›æ¶ˆæ¯ä¸æ˜¯ç›¸å¯¹äºæ™®é€šç”¨æˆ·æ¶ˆæ¯è¿›è¡Œæ’åºçš„ã€‚ç‰¹åˆ«åœ°ï¼š</p>

<ul>
  <li>å­ Actor <code class="language-plaintext highlighter-rouge">C</code>å°†æ¶ˆæ¯<code class="language-plaintext highlighter-rouge">M</code>å‘é€åˆ°å…¶çˆ¶ Actor <code class="language-plaintext highlighter-rouge">P</code></li>
  <li>å­ Actor å› é”™è¯¯<code class="language-plaintext highlighter-rouge">F</code>å¯¼è‡´å¤±è´¥</li>
  <li>çˆ¶ Actor <code class="language-plaintext highlighter-rouge">P</code>å¯èƒ½æŒ‰<code class="language-plaintext highlighter-rouge">M</code>ã€<code class="language-plaintext highlighter-rouge">F</code>æˆ–<code class="language-plaintext highlighter-rouge">F</code>ã€<code class="language-plaintext highlighter-rouge">M</code>çš„é¡ºåºæ¥æ”¶è¿™ä¸¤ä¸ªäº‹ä»¶</li>
</ul>

<p>è¿™æ ·åšçš„åŸå› æ˜¯å†…éƒ¨ç³»ç»Ÿæ¶ˆæ¯æœ‰è‡ªå·±çš„é‚®ç®±ï¼Œå› æ­¤ç”¨æˆ·å’Œç³»ç»Ÿæ¶ˆæ¯çš„æ’é˜Ÿè°ƒç”¨é¡ºåºä¸èƒ½ä¿è¯å…¶å‡ºåˆ—æ—¶é—´çš„é¡ºåºã€‚</p>

<h3 id="382-åœ¨-jvmæœ¬åœ°æ¶ˆæ¯å‘é€çš„è§„åˆ™">3.8.2. åœ¨ JVMï¼ˆæœ¬åœ°ï¼‰æ¶ˆæ¯å‘é€çš„è§„åˆ™</h3>
<h4 id="3821-å°å¿ƒä½ å¯¹è¿™éƒ¨åˆ†çš„æ“ä½œ">3.8.2.1. å°å¿ƒä½ å¯¹è¿™éƒ¨åˆ†çš„æ“ä½œï¼</h4>

<p>ä¸å»ºè®®ä¾èµ–æœ¬èŠ‚ä¸­æ›´å¼ºçš„å¯é æ€§ï¼Œå› ä¸ºå®ƒä¼šå°†ä½ çš„åº”ç”¨ç¨‹åºç»‘å®šåˆ°ä»…æœ¬åœ°ï¼ˆ<code class="language-plaintext highlighter-rouge">local-only</code>ï¼‰éƒ¨ç½²ï¼šä¸ºäº†é€‚åˆåœ¨è®¡ç®—æœºé›†ç¾¤ä¸Šè¿è¡Œï¼Œå¯èƒ½å¿…é¡»å¯¹åº”ç”¨ç¨‹åºè¿›è¡Œä¸åŒçš„è®¾è®¡ï¼Œè€Œä¸æ˜¯ä»…ä½¿ç”¨æŸäº› Actor æœ¬åœ°çš„æŸäº›æ¶ˆæ¯äº¤æ¢æ¨¡å¼ã€‚æˆ‘ä»¬çš„ä¿¡æ¡æ˜¯â€œè®¾è®¡ä¸€æ¬¡ï¼Œä»¥ä»»ä½•ä½ æƒ³è¦çš„æ–¹å¼éƒ¨ç½²â€ï¼Œä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œä½ åº”è¯¥åªä¾èµ–äºã€Œ<a href="https://github.com/guobinhit/akka-guide/blob/master/articles/general-concepts/message-delivery-reliability.md#%E4%B8%80%E8%88%AC%E8%A7%84%E5%88%99">ä¸€èˆ¬è§„åˆ™</a>ã€ã€‚</p>

<h4 id="3822-æœ¬åœ°æ¶ˆæ¯å‘é€çš„å¯é æ€§">3.8.2.2. æœ¬åœ°æ¶ˆæ¯å‘é€çš„å¯é æ€§</h4>

<p>Akka æµ‹è¯•å¥—ä»¶ä¾èµ–äºåœ¨æœ¬åœ°ä¸Šä¸‹æ–‡ä¸­ä¸ä¸¢å¤±æ¶ˆæ¯ï¼ˆå¯¹äºéé”™è¯¯æ¡ä»¶æµ‹è¯•ä¹Ÿé€‚ç”¨äºè¿œç¨‹éƒ¨ç½²ï¼‰ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ç¡®å®å°½äº†æœ€å¤§åŠªåŠ›ä¿æŒæµ‹è¯•çš„ç¨³å®šæ€§ã€‚ä½†æ˜¯ï¼Œæœ¬åœ°<code class="language-plaintext highlighter-rouge">tell</code>æ“ä½œå¯èƒ½ä¼šå¤±è´¥ï¼ŒåŸå› ä¸åœ¨ JVM ä¸Šè¿›è¡Œå¸¸è§„æ–¹æ³•è°ƒç”¨ç›¸åŒï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">StackOverflowError</code></li>
  <li><code class="language-plaintext highlighter-rouge">OutOfMemoryError</code></li>
  <li>å…¶å®ƒ<code class="language-plaintext highlighter-rouge">VirtualMachineError</code></li>
</ul>

<p>æ­¤å¤–ï¼Œæœ¬åœ°å‘é€å¯èƒ½ä¼šä»¥ Akka ç‰¹å®šçš„æ–¹å¼å¤±è´¥ï¼š</p>

<ul>
  <li>å¦‚æœé‚®ç®±ä¸æ¥å—é‚®ä»¶ï¼ˆä¾‹å¦‚ï¼Œå®Œå…¨<code class="language-plaintext highlighter-rouge">BoundedMailbox</code>ï¼‰</li>
  <li>å¦‚æœæ¥æ”¶ Actor åœ¨å¤„ç†æ¶ˆæ¯æ—¶å¤±è´¥æˆ–å·²ç»ˆæ­¢</li>
</ul>

<p>è™½ç„¶ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯é…ç½®é—®é¢˜ï¼Œä½†ç¬¬äºŒä¸ªé—®é¢˜å€¼å¾—è€ƒè™‘ï¼šå¦‚æœåœ¨å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼Œåˆ™æ¶ˆæ¯çš„å‘é€è€…ä¸ä¼šå¾—åˆ°åé¦ˆï¼Œè€Œæ˜¯å°†è¯¥é€šçŸ¥å‘é€ç»™ç›‘ç£è€…ã€‚å¯¹äºå¤–éƒ¨è§‚å¯Ÿè€…æ¥è¯´ï¼Œè¿™é€šå¸¸ä¸ä¸¢å¤±çš„æ¶ˆæ¯æ²¡æœ‰åŒºåˆ«ã€‚</p>

<h4 id="3823-æœ¬åœ°æ¶ˆæ¯å‘é€é¡ºåº">3.8.2.3. æœ¬åœ°æ¶ˆæ¯å‘é€é¡ºåº</h4>

<p>å‡è®¾ä¸¥æ ¼çš„<code class="language-plaintext highlighter-rouge">FIFO</code>é‚®ç®±ï¼Œåœ¨æŸäº›æ¡ä»¶ä¸‹ï¼Œæ¶ˆé™¤äº†æ¶ˆæ¯æ’åºä¿è¯çš„éä¼ é€’æ€§ï¼ˆ<code class="language-plaintext highlighter-rouge">non-transitivity</code>ï¼‰çš„ä¸Šè¿°è­¦å‘Šã€‚æ­£å¦‚ä½ å°†è¦æ³¨æ„åˆ°çš„ï¼Œè¿™äº›éƒ½æ˜¯éå¸¸å¾®å¦™çš„ï¼Œè€Œä¸”å°†æ¥çš„æ€§èƒ½ä¼˜åŒ–ç”šè‡³æœ‰å¯èƒ½ä½¿æ•´ä¸ªæ®µè½ï¼ˆ<code class="language-plaintext highlighter-rouge">paragraph</code>ï¼‰å¤±æ•ˆã€‚å¯èƒ½çš„éè¯¦å°½çš„æŒ‡ç¤ºæ¸…å•æ˜¯ï¼š</p>

<ul>
  <li>åœ¨æ¥æ”¶åˆ°é¡¶çº§ Actor çš„ç¬¬ä¸€ä¸ªå›å¤ä¹‹å‰ï¼Œå­˜åœ¨ä¸€ä¸ªä¿æŠ¤å†…éƒ¨ä¸´æ—¶é˜Ÿåˆ—çš„é”ï¼Œè€Œè¿™ä¸ªé”æ˜¯ä¸å…¬å¹³çš„ï¼›è¿™æ„å‘³ç€ï¼Œæ ¹æ®ä½çº§çº¿ç¨‹è°ƒåº¦ï¼Œæ¥è‡ªä¸åŒå‘é€æ–¹çš„æ’é˜Ÿè¯·æ±‚åœ¨ Actor çš„æ„é€ è¿‡ç¨‹ä¸­åˆ°è¾¾ï¼Œå¯ä»¥é‡æ–°æ’åºã€‚å› ä¸ºåœ¨ JVM ä¸Šä¸å­˜åœ¨å®Œå…¨å…¬å¹³çš„é”ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸å¯ä¿®å¤çš„ã€‚</li>
  <li>åŒæ ·çš„æœºåˆ¶åœ¨<code class="language-plaintext highlighter-rouge">Router</code>çš„æ„å»ºè¿‡ç¨‹ä¸­ä½¿ç”¨ï¼Œæ›´ç²¾ç¡®åœ°è¯´æ˜¯è·¯ç”±çš„<code class="language-plaintext highlighter-rouge">ActorRef</code>ï¼Œå› æ­¤å¯¹äºéƒ¨ç½²äº†è·¯ç”±å™¨çš„ Actor æ¥è¯´ï¼ŒåŒæ ·çš„é—®é¢˜ä¹Ÿå­˜åœ¨ã€‚</li>
  <li>å¦‚ä¸Šæ‰€è¿°ï¼Œåœ¨æ’é˜Ÿè¿‡ç¨‹ä¸­æ¶‰åŠé”çš„ä»»ä½•åœ°æ–¹éƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œè¿™ä¹Ÿå¯èƒ½é€‚ç”¨äºè‡ªå®šä¹‰é‚®ç®±ã€‚</li>
</ul>

<p>è™½ç„¶æ­¤åˆ—è¡¨æˆ‘ä»¬å·²ç»ä»”ç»†è€ƒè™‘è¿‡äº†ï¼Œä½†ä»ç„¶å¯èƒ½å­˜åœ¨å…¶ä»–çš„æˆ‘ä»¬æ²¡æœ‰æƒ³åˆ°çš„é—®é¢˜ã€‚</p>

<h4 id="3824-æœ¬åœ°é¡ºåºä¸ç½‘ç»œé¡ºåºæœ‰ä»€ä¹ˆå…³ç³»">3.8.2.4. æœ¬åœ°é¡ºåºä¸ç½‘ç»œé¡ºåºæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</h4>

<p>å¯¹äºç»™å®šçš„ä¸€å¯¹ Actorï¼Œç›´æ¥ä»ç¬¬ä¸€ä¸ª Actor å‘é€åˆ°ç¬¬äºŒä¸ª Actor çš„æ¶ˆæ¯å°†ä¸ä¼šè¢«æ— åºæ¥æ”¶ï¼Œè¿™ä¸€è§„åˆ™é€‚ç”¨äºä½¿ç”¨åŸºäº TCP çš„ Akka è¿œç¨‹ä¼ è¾“åè®®é€šè¿‡ç½‘ç»œå‘é€çš„æ¶ˆæ¯ã€‚</p>

<p>å¦‚å‰ä¸€èŠ‚æ‰€è¿°ï¼Œæœ¬åœ°æ¶ˆæ¯åœ¨ç‰¹å®šæ¡ä»¶ä¸‹å‘é€æœä»ä¼ é€’å› æœæ’åºã€‚ç”±äºä¸åŒçš„é‚®ä»¶ä¼ é€’å»¶è¿Ÿï¼Œå¯èƒ½ä¼šè¿åæ­¤é¡ºåºã€‚ä¾‹å¦‚ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">node-1</code>ä¸Šçš„ Actor <code class="language-plaintext highlighter-rouge">A</code>å‘<code class="language-plaintext highlighter-rouge">node-3</code>ä¸Šçš„ Actor <code class="language-plaintext highlighter-rouge">C</code>å‘é€æ¶ˆæ¯<code class="language-plaintext highlighter-rouge">M1</code></li>
  <li><code class="language-plaintext highlighter-rouge">node-1</code>ä¸Šçš„ Actor <code class="language-plaintext highlighter-rouge">A</code>ç„¶åå‘<code class="language-plaintext highlighter-rouge">node-2</code>ä¸Šçš„ Actor <code class="language-plaintext highlighter-rouge">B</code>å‘é€æ¶ˆæ¯<code class="language-plaintext highlighter-rouge">M2</code></li>
  <li><code class="language-plaintext highlighter-rouge">node-2</code>ä¸Šçš„ Actor <code class="language-plaintext highlighter-rouge">B</code>å°†æ¶ˆæ¯<code class="language-plaintext highlighter-rouge">M2</code>è½¬å‘ç»™<code class="language-plaintext highlighter-rouge">node-3</code>ä¸Šçš„ Actor <code class="language-plaintext highlighter-rouge">C</code></li>
  <li>Actor <code class="language-plaintext highlighter-rouge">C</code>å¯ä»¥æ¥å—ä»»ä½•é¡ºåºçš„<code class="language-plaintext highlighter-rouge">M1</code>å’Œ<code class="language-plaintext highlighter-rouge">M2</code></li>
</ul>

<p><code class="language-plaintext highlighter-rouge">M1</code>åˆ°<code class="language-plaintext highlighter-rouge">node-3</code>çš„â€œä¼ è¾“â€æ—¶é—´å¯èƒ½æ¯”<code class="language-plaintext highlighter-rouge">M2</code>é€šè¿‡<code class="language-plaintext highlighter-rouge">node-2</code>åˆ°<code class="language-plaintext highlighter-rouge">node-3</code>çš„â€œä¼ è¾“â€æ—¶é—´è¦é•¿ã€‚</p>

<h3 id="383-é«˜çº§æŠ½è±¡">3.8.3. é«˜çº§æŠ½è±¡</h3>

<p>åŸºäº Akka æ ¸å¿ƒä¸­çš„ä¸€ä¸ªå°è€Œä¸€è‡´çš„å·¥å…·é›†ï¼ŒAkka è¿˜æä¾›äº†å¼ºå¤§çš„ã€æ›´é«˜çº§çš„æŠ½è±¡ã€‚</p>

<h4 id="3831-æ¶ˆæ¯æ¨¡å¼">3.8.3.1. æ¶ˆæ¯æ¨¡å¼</h4>

<p>å¦‚ä¸Šæ‰€è¿°ï¼Œå¯¹å¯é ä¼ é€’éœ€æ±‚çš„ç›´æ¥å›ç­”æ˜¯ä¸€ä¸ªæ˜ç¡®çš„<code class="language-plaintext highlighter-rouge">ACK-RETRY</code>åè®®ã€‚ä»¥æœ€ç®€å•çš„å½¢å¼ï¼Œè¿™éœ€è¦</p>

<ul>
  <li>è¯†åˆ«å•ä¸ªæ¶ˆæ¯ä»¥å°†æ¶ˆæ¯ä¸ç¡®è®¤å…³è”çš„æ–¹æ³•</li>
  <li>ä¸€ç§é‡è¯•æœºåˆ¶ï¼Œå¦‚æœä¸åŠæ—¶ç¡®è®¤ï¼Œå°†é‡æ–°å‘é€æ¶ˆæ¯</li>
  <li>æ¥æ”¶è€…æ£€æµ‹å’Œä¸¢å¼ƒé‡å¤æ•°æ®çš„ä¸€ç§æ–¹æ³•</li>
</ul>

<p>ç¬¬ä¸‰ä¸ªæ˜¯å¿…è¦çš„ï¼Œå› ä¸ºæ¶ˆæ¯ä¹Ÿä¸èƒ½ä¿è¯åˆ°è¾¾ã€‚Akka æŒä¹…æ€§æ¨¡å—çš„â€œè‡³å°‘ä¸€æ¬¡ä¼ é€’â€æ”¯æŒå…·æœ‰ä¸šåŠ¡çº§ç¡®è®¤çš„<code class="language-plaintext highlighter-rouge">ACK-RETRY</code>åè®®ã€‚é€šè¿‡è·Ÿè¸ªé€šè¿‡â€è‡³å°‘ä¸€æ¬¡ä¼ é€’â€å‘é€çš„æ¶ˆæ¯çš„æ ‡è¯†ç¬¦ï¼Œå¯ä»¥æ£€æµ‹åˆ°é‡å¤çš„æ¶ˆæ¯ã€‚å®ç°ç¬¬ä¸‰éƒ¨åˆ†çš„å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿æ¶ˆæ¯å¤„ç†åœ¨ä¸šåŠ¡é€»è¾‘çº§åˆ«ä¸Šæ˜¯ç­‰é‡çš„ã€‚</p>

<h4 id="3832-äº‹ä»¶æº">3.8.3.2. äº‹ä»¶æº</h4>

<p>äº‹ä»¶æºï¼ˆå’Œåˆ†ç‰‡ï¼‰æ˜¯å¤§å‹ç½‘ç«™æ‰©å±•åˆ°æ•°åäº¿ç”¨æˆ·çš„åŸå› ï¼Œå…¶æ€æƒ³éå¸¸ç®€å•ï¼šå½“ä¸€ä¸ªç»„ä»¶ï¼ˆæ€è€ƒ Actorï¼‰å¤„ç†ä¸€ä¸ªå‘½ä»¤æ—¶ï¼Œå®ƒå°†ç”Ÿæˆä¸€ä¸ªè¡¨ç¤ºå‘½ä»¤æ•ˆæœçš„äº‹ä»¶åˆ—è¡¨ã€‚é™¤äº†åº”ç”¨äºç»„ä»¶çš„çŠ¶æ€ä¹‹å¤–ï¼Œè¿˜å­˜å‚¨è¿™äº›äº‹ä»¶ã€‚è¿™ä¸ªæ–¹æ¡ˆçš„å¥½å¤„åœ¨äºï¼Œäº‹ä»¶åªä¼šè¢«é™„åŠ åˆ°å­˜å‚¨ä¸­ï¼Œä¸ä¼šå‘ç”Ÿä»»ä½•å˜åŒ–ï¼›è¿™æ ·å¯ä»¥å®Œç¾åœ°å¤åˆ¶å’Œæ‰©å±•è¿™ä¸ªäº‹ä»¶æµï¼ˆ<code class="language-plaintext highlighter-rouge">event stream</code>ï¼‰çš„ä½¿ç”¨è€…ï¼ˆå³ï¼Œå…¶ä»–ç»„ä»¶å¯èƒ½ä¼šä½¿ç”¨äº‹ä»¶æµä½œä¸ºåœ¨ä¸åŒåŒºåŸŸå¤åˆ¶ç»„ä»¶çŠ¶æ€æˆ–å¯¹æ›´æ”¹ä½œå‡ºååº”çš„æ‰‹æ®µï¼‰ã€‚å¦‚æœç»„ä»¶çš„çŠ¶æ€ç”±äºæœºå™¨æ•…éšœæˆ–è¢«æ¨å‡ºç¼“å­˜è€Œä¸¢å¤±ï¼Œåˆ™å¯ä»¥é€šè¿‡é‡æ”¾äº‹ä»¶æµï¼ˆé€šå¸¸ä½¿ç”¨å¿«ç…§æ¥åŠ å¿«è¿›ç¨‹ï¼‰æ¥é‡å»ºã€‚Akka æŒä¹…åŒ–æ”¯æŒã€Œ<a href="https://github.com/guobinhit/akka-guide/blob/master/articles/actors/persistence.md#%E4%BA%8B%E4%BB%B6%E6%BA%90">äº‹ä»¶æº</a>ã€ã€‚</p>

<h4 id="3833-å¸¦æ˜ç¡®ç¡®è®¤çš„é‚®ç®±">3.8.3.3. å¸¦æ˜ç¡®ç¡®è®¤çš„é‚®ç®±</h4>

<p>é€šè¿‡å®ç°è‡ªå®šä¹‰é‚®ç®±ç±»å‹ï¼Œå¯ä»¥åœ¨æ¥æ”¶ Actor ç«¯é‡è¯•æ¶ˆæ¯å¤„ç†ï¼Œä»¥å¤„ç†ä¸´æ—¶æ•…éšœã€‚æ­¤æ¨¡å¼åœ¨æœ¬åœ°é€šä¿¡ä¸Šä¸‹æ–‡ä¸­æœ€æœ‰ç”¨ï¼Œå› ä¸ºåœ¨æœ¬åœ°é€šä¿¡ä¸Šä¸‹æ–‡ä¸­ï¼Œä¼ é€’ä¿è¯åœ¨å…¶ä»–æ–¹é¢è¶³ä»¥æ»¡è¶³åº”ç”¨ç¨‹åºçš„éœ€æ±‚ã€‚</p>

<p>è¯·æ³¨æ„ï¼Œå¯¹äºã€Œ<a href="https://github.com/guobinhit/akka-guide/blob/master/articles/general-concepts/message-delivery-reliability.md#%E5%9C%A8-jvm%E6%9C%AC%E5%9C%B0%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E7%9A%84%E8%A7%84%E5%88%99">åœ¨ JVMï¼ˆæœ¬åœ°ï¼‰æ¶ˆæ¯å‘é€çš„è§„åˆ™</a>ã€çš„è­¦å‘Šç¡®å®é€‚ç”¨ã€‚</p>

<h3 id="384-æ­»ä¿¡">3.8.4. æ­»ä¿¡</h3>

<p>æ— æ³•ä¼ é€’ï¼ˆå¹¶ä¸”å¯ä»¥ç¡®å®šï¼‰çš„æ¶ˆæ¯å°†ä¼ é€’ç»™ç§°ä¸º<code class="language-plaintext highlighter-rouge">/deadLetters</code>çš„è™šæ‹Ÿ Actorã€‚è¿™ç§ä¼ é€’æ˜¯åœ¨å°½æœ€å¤§åŠªåŠ›çš„åŸºç¡€ä¸Šè¿›è¡Œçš„ï¼›å®ƒç”šè‡³å¯èƒ½åœ¨æœ¬åœ° JVM ä¸­å¤±è´¥ï¼ˆä¾‹å¦‚ï¼Œåœ¨ Actor ç»ˆæ­¢æœŸé—´ï¼‰ã€‚é€šè¿‡ä¸å¯é çš„ç½‘ç»œä¼ è¾“å‘é€çš„æ¶ˆæ¯å°†ä¸¢å¤±ï¼Œè€Œä¸ä¼šæ˜¾ç¤ºä¸ºæ­»ä¿¡ã€‚</p>

<h4 id="3841-åº”è¯¥ç”¨æ­»ä¿¡åšä»€ä¹ˆ">3.8.4.1. åº”è¯¥ç”¨æ­»ä¿¡åšä»€ä¹ˆï¼Ÿ</h4>

<p>æ­¤å·¥å…·çš„ä¸»è¦ç”¨é€”æ˜¯è°ƒè¯•ï¼Œç‰¹åˆ«æ˜¯å½“ Actor å‘é€çš„é‚®ä»¶ä¸ä¸€è‡´æ—¶ï¼ˆé€šå¸¸æ£€æŸ¥æ­»ä¿¡ä¼šå‘Šè¯‰ä½ å‘é€è€…æˆ–æ”¶ä»¶è€…åœ¨æŸä¸ªåœ°æ–¹è®¾ç½®é”™è¯¯ï¼‰ã€‚ä¸ºäº†æœ‰åŠ©äºå®ç°è¿™ä¸€ç›®çš„ï¼Œæœ€å¥½é¿å…åœ¨å¯èƒ½çš„æƒ…å†µä¸‹å‘é€æ­»ä¿¡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨åˆé€‚çš„æ­»ä¿¡è®°å½•å™¨ä¸æ—¶çš„è¿è¡Œåº”ç”¨ç¨‹åºï¼Œå¹¶æ¸…é™¤æ—¥å¿—è¾“å‡ºã€‚ä¸æ‰€æœ‰å…¶ä»–æ–¹æ³•ä¸€æ ·ï¼Œè¿™ä¸ªç»ƒä¹ éœ€è¦æ˜æ™ºåœ°åº”ç”¨å¸¸è¯†ï¼šå¾ˆå¯èƒ½é¿å…å‘é€åˆ°ç»ˆæ­¢çš„ Actor ä¼šä½¿å‘é€è€…çš„ä»£ç æ¯”è°ƒè¯•è¾“å‡ºçš„æ¸…æ™°æ€§æ›´å·®ã€‚</p>

<p>æ­»ä¿¡æœåŠ¡åœ¨ä¼ é€’ä¿è¯æ–¹é¢éµå¾ªä¸æ‰€æœ‰å…¶ä»–æ¶ˆæ¯å‘é€ç›¸åŒçš„è§„åˆ™ï¼Œå› æ­¤ä¸èƒ½ç”¨äºå®ç°ä¿è¯ä¼ é€’ã€‚</p>

<h4 id="3842-å¦‚ä½•æ”¶åˆ°æ­»ä¿¡">3.8.4.2. å¦‚ä½•æ”¶åˆ°æ­»ä¿¡ï¼Ÿ</h4>

<p>Actor å¯ä»¥è®¢é˜…äº‹ä»¶æµä¸Šçš„ç±»<code class="language-plaintext highlighter-rouge">akka.actor.DeadLetter</code>ï¼Œè¯·å‚é˜…ã€Œ<a href="https://github.com/guobinhit/akka-guide/blob/master/articles/index-utilities/event-bus.md#%E4%BA%8B%E4%BB%B6%E6%B5%81">äº‹ä»¶æµ</a>ã€äº†è§£å¦‚ä½•æ‰§è¡Œè¯¥æ“ä½œã€‚ç„¶åï¼Œè®¢é˜…çš„ Actor å°†æ”¶åˆ°ï¼ˆæœ¬åœ°ï¼‰ç³»ç»Ÿä¸­ä»é‚£æ—¶èµ·å‘å¸ƒçš„æ‰€æœ‰æ­»ä¿¡ã€‚æ­»ä¿¡ä¸ä¼šåœ¨ç½‘ç»œä¸Šä¼ æ’­ï¼Œå¦‚æœè¦åœ¨ä¸€ä¸ªä½ç½®æ”¶é›†æ­»ä¿¡ï¼Œåˆ™å¿…é¡»ä¸ºæ¯ä¸ªç½‘ç»œèŠ‚ç‚¹è®¢é˜…ä¸€ä¸ª Actorï¼Œç„¶åæ‰‹åŠ¨è½¬å‘å®ƒä»¬ã€‚è¿˜è¦è€ƒè™‘åœ¨è¯¥èŠ‚ç‚¹ä¸Šç”Ÿæˆæ­»ä¿¡ï¼Œå®ƒå¯ä»¥ç¡®å®šå‘é€æ“ä½œå¤±è´¥ï¼Œå¯¹äºè¿œç¨‹å‘é€ï¼Œæ­»ä¿¡å¯ä»¥æ˜¯æœ¬åœ°ç³»ç»Ÿï¼ˆå¦‚æœæ— æ³•å»ºç«‹ç½‘ç»œè¿æ¥ï¼‰æˆ–è¿œç¨‹ç³»ç»Ÿï¼ˆå¦‚æœä½ è¦å‘é€åˆ°çš„ Actor åœ¨è¯¥æ—¶é—´ç‚¹ä¸å­˜åœ¨ï¼‰ã€‚</p>

<h4 id="3843-é€šå¸¸ä¸ä»¤äººæ‹…å¿§çš„æ­»ä¿¡">3.8.4.3. é€šå¸¸ä¸ä»¤äººæ‹…å¿§çš„æ­»ä¿¡</h4>

<p>æ¯å½“ä¸€ä¸ª Actor ä¸å› è‡ªå·±çš„å†³å®šè€Œç»ˆæ­¢æ—¶ï¼Œå®ƒå‘é€ç»™è‡ªå·±çš„ä¸€äº›æ¶ˆæ¯å°±æœ‰å¯èƒ½ä¸¢å¤±ã€‚åœ¨é€šå¸¸æ˜¯è‰¯æ€§çš„å¤æ‚å…³é—­åœºæ™¯ä¸­ï¼Œæœ‰ä¸€ç§æƒ…å†µå¾ˆå®¹æ˜“å‘ç”Ÿï¼šçœ‹åˆ°<code class="language-plaintext highlighter-rouge">akka.dispatch.Terminate</code>æ¶ˆæ¯ä¸¢å¤±æ„å‘³ç€ç»™å‡ºäº†ä¸¤ä¸ªç»ˆæ­¢è¯·æ±‚ï¼Œä½†åªæœ‰ä¸€ä¸ªå¯ä»¥æˆåŠŸã€‚åŒæ ·ï¼Œä½ å¯èƒ½ä¼šçœ‹åˆ°<code class="language-plaintext highlighter-rouge">akka.actor.Terminated</code>æ¥è‡ªå­ Actor çš„æ¶ˆæ¯ï¼Œè€Œå¦‚æœçˆ¶çº§ Actor åœ¨çˆ¶çº§ç»ˆæ­¢æ—¶ä»åœ¨ç›‘è§†å­ Actorï¼Œåˆ™ä¼šé˜»æ­¢ä¸€ç³»åˆ—ä»¥æ­»ä¿¡å½¢å¼å‡ºç°çš„ Actorã€‚</p>

<hr />

<p><strong>è‹±æ–‡åŸæ–‡é“¾æ¥</strong>ï¼š<a href="https://doc.akka.io/docs/akka/current/general/message-delivery-reliability.html">Message Delivery Reliability</a>.</p>

<h2 id="39-é…ç½®">3.9. é…ç½®</h2>
<p>ä½ å¯ä»¥åœ¨ä¸å®šä¹‰ä»»ä½•é…ç½®çš„æƒ…å†µä¸‹å¼€å§‹ä½¿ç”¨ Akkaï¼Œå› ä¸ºæä¾›äº†åˆç†çš„é»˜è®¤å€¼ã€‚ç¨åï¼Œä½ å¯èƒ½éœ€è¦ä¿®æ”¹è®¾ç½®ä»¥æ›´æ”¹é»˜è®¤è¡Œä¸ºæˆ–é€‚åº”ç‰¹å®šçš„è¿è¡Œæ—¶ç¯å¢ƒã€‚ä½ å¯ä»¥ä¿®æ”¹çš„å…¸å‹è®¾ç½®ç¤ºä¾‹ï¼š</p>

<ul>
  <li>æ—¥å¿—çº§åˆ«å’Œæ—¥å¿—è®°å½•å™¨åç«¯</li>
  <li>å¯ç”¨è¿œç¨‹å¤„ç†</li>
  <li>æ¶ˆæ¯åºåˆ—åŒ–ç¨‹åº</li>
  <li>è·¯ç”±å™¨çš„å®šä¹‰</li>
  <li>è°ƒåº¦å‘˜è°ƒæ•´</li>
</ul>

<p>Akka ä½¿ç”¨ã€Œ<a href="https://github.com/lightbend/config">Typesafe Config Library</a>ã€ï¼Œè¿™å¯¹äºé…ç½®ä½ è‡ªå·±çš„åº”ç”¨ç¨‹åºæˆ–ä½¿ç”¨æˆ–ä¸ä½¿ç”¨ Akka æ„å»ºçš„åº“ä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚è¿™ä¸ªåº“æ˜¯ç”¨ Java å®ç°çš„ï¼Œæ²¡æœ‰å¤–éƒ¨ä¾èµ–å…³ç³»ï¼›ä½ åº”è¯¥çœ‹çœ‹å®ƒçš„æ–‡æ¡£ï¼Œç‰¹åˆ«æ˜¯å…³äºã€Œ<a href="https://lightbend.github.io/config/latest/api/com/typesafe/config/ConfigFactory.html">ConfigFactory</a>ã€ã€‚</p>

<ul>
  <li><strong>è­¦å‘Š</strong>ï¼šå¦‚æœä½ ä½¿ç”¨æ¥è‡ª<code class="language-plaintext highlighter-rouge">2.9.x</code>ç³»åˆ—çš„ Scala REPL çš„ Akkaï¼Œå¹¶ä¸”æ²¡æœ‰å‘<code class="language-plaintext highlighter-rouge">ActorSystem</code>æä¾›è‡ªå·±çš„<code class="language-plaintext highlighter-rouge">ClassLoader</code>ï¼Œé‚£ä¹ˆéœ€è¦ä½¿ç”¨<code class="language-plaintext highlighter-rouge">-Yrepl-sync</code>å¯åŠ¨ REPLï¼Œä»¥è§£å†³ REPLs æä¾›çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ä¸­çš„ç¼ºé™·ã€‚</li>
</ul>

<h3 id="391-ä»å“ªé‡Œè¯»å–é…ç½®">3.9.1. ä»å“ªé‡Œè¯»å–é…ç½®ï¼Ÿ</h3>
<p>Akka çš„æ‰€æœ‰é…ç½®ï¼ˆ<code class="language-plaintext highlighter-rouge">configuration</code>ï¼‰éƒ½ä¿å­˜åœ¨<code class="language-plaintext highlighter-rouge">ActorSystem</code>å®ä¾‹ä¸­ï¼Œæˆ–è€…æ¢å¥è¯è¯´ï¼Œä»å¤–éƒ¨çœ‹ï¼Œ<code class="language-plaintext highlighter-rouge">ActorSystem</code>æ˜¯é…ç½®ä¿¡æ¯çš„å”¯ä¸€ä½¿ç”¨è€…ã€‚åœ¨æ„é€  Actor ç³»ç»Ÿæ—¶ï¼Œå¯ä»¥ä¼ å…¥<code class="language-plaintext highlighter-rouge">Config</code>å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥ä¸ä¼ å…¥ï¼Œå…¶ä¸­ç¬¬äºŒç§æƒ…å†µç­‰åŒäºä¼ é€’<code class="language-plaintext highlighter-rouge">ConfigFactory.load()</code>ï¼Œä½¿ç”¨æ­£ç¡®çš„ç±»åŠ è½½å™¨ã€‚è¿™å¤§è‡´æ„å‘³ç€é»˜è®¤å€¼æ˜¯è§£æç±»è·¯å¾„æ ¹ç›®å½•ä¸‹çš„æ‰€æœ‰<code class="language-plaintext highlighter-rouge">application.conf</code>ã€<code class="language-plaintext highlighter-rouge">application.json</code>å’Œ<code class="language-plaintext highlighter-rouge">application.properties</code>æ–‡ä»¶ã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…ä¸Šè¿°æ–‡æ¡£ã€‚ç„¶åï¼ŒActor ç³»ç»Ÿåˆå¹¶åœ¨ç±»è·¯å¾„æ ¹ç›®å½•ä¸‹æ‰¾åˆ°çš„æ‰€æœ‰<code class="language-plaintext highlighter-rouge">reference.conf</code>èµ„æºï¼Œä»¥å½¢æˆæœ€ç»ˆçš„é…ç½®ï¼Œä»¥ä¾›å†…éƒ¨ä½¿ç”¨ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">appConfig</span><span class="o">.</span><span class="na">withFallback</span><span class="o">(</span><span class="nc">ConfigFactory</span><span class="o">.</span><span class="na">defaultReference</span><span class="o">(</span><span class="n">classLoader</span><span class="o">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>å…¶åŸç†æ˜¯ä»£ç ä»ä¸åŒ…å«é»˜è®¤å€¼ï¼Œè€Œæ˜¯ä¾èµ–äºå®ƒä»¬åœ¨ç›¸å…³åº“æä¾›çš„<code class="language-plaintext highlighter-rouge">reference.conf</code>ä¸­çš„å­˜åœ¨ã€‚</p>

<p>ä½œä¸ºç³»ç»Ÿå±æ€§ç»™å‡ºçš„è¦†ç›–å…·æœ‰æœ€é«˜ä¼˜å…ˆçº§ï¼Œè¯·å‚é˜…ã€Œ<a href="https://github.com/lightbend/config/blob/master/HOCON.md">HOCON</a>ã€è§„èŒƒï¼ˆé è¿‘åº•éƒ¨ï¼‰ã€‚å¦å¤–å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œé»˜è®¤ä¸ºåº”ç”¨ç¨‹åºçš„åº”ç”¨ç¨‹åºé…ç½®å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">config.resource</code>å±æ€§è¦†ç›–ï¼Œè¿˜æœ‰æ›´å¤šå†…å®¹ï¼Œè¯·å‚é˜…ã€Œ<a href="https://github.com/lightbend/config/blob/master/README.md">Config</a>ã€æ–‡æ¡£ã€‚</p>

<ul>
  <li><strong>æ³¨é‡Š</strong>ï¼šå¦‚æœä½ æ­£åœ¨ç¼–å†™ Akka åº”ç”¨ç¨‹åºï¼Œè¯·å°†ä½ çš„é…ç½®ä¿å­˜åœ¨ç±»è·¯å¾„æ ¹ç›®å½•ä¸‹çš„<code class="language-plaintext highlighter-rouge">application.conf</code>ä¸­ã€‚å¦‚æœä½ æ­£åœ¨ç¼–å†™åŸºäº Akka çš„åº“ï¼Œè¯·å°†å…¶é…ç½®ä¿å­˜åœ¨ JAR æ–‡ä»¶æ ¹ç›®å½•ä¸‹çš„<code class="language-plaintext highlighter-rouge">reference.conf</code>ä¸­ã€‚</li>
</ul>

<h3 id="392-ä½¿ç”¨-jarjaronejarassembly-æˆ–ä»»ä½•--jar-bundler-æ—¶">3.9.2. ä½¿ç”¨ JarJarã€OneJarã€Assembly æˆ–ä»»ä½•  jar-bundler æ—¶</h3>

<ul>
  <li><strong>è­¦å‘Š</strong>ï¼šAkka çš„é…ç½®æ–¹æ³•å¾ˆå¤§ç¨‹åº¦ä¸Šä¾èµ–äºæ¯ä¸ª<code class="language-plaintext highlighter-rouge">module/jar</code>éƒ½æœ‰è‡ªå·±çš„<code class="language-plaintext highlighter-rouge">reference.conf</code>æ–‡ä»¶çš„æ¦‚å¿µï¼Œæ‰€æœ‰è¿™äº›éƒ½å°†ç”±é…ï¿½ï¿½å‘ç°å¹¶åŠ è½½ã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¿™ä¹Ÿæ„å‘³ç€å¦‚æœä½ å°†å¤šä¸ª Jar æ”¾å…¥æˆ–åˆå¹¶åˆ°åŒä¸€ä¸ª Jar ä¸­ï¼Œé‚£ä¹ˆä½ è¿˜éœ€è¦åˆå¹¶æ‰€æœ‰<code class="language-plaintext highlighter-rouge">reference.conf</code>ã€‚å¦åˆ™ï¼Œæ‰€æœ‰é»˜è®¤å€¼å°†ä¸¢å¤±ï¼ŒAkka ï¿½ï¿½ä¸èµ·ä½œç”¨ã€‚</li>
</ul>

<p>å¦‚æœä½¿ç”¨ Maven æ‰“åŒ…åº”ç”¨ç¨‹åºï¼Œè¿˜å¯ä»¥ä½¿ç”¨ã€Œ<a href="http://maven.apache.org/plugins/maven-shade-plugin/">Apache Maven Shade Plugin</a>ã€çš„ã€Œ<a href="http://maven.apache.org/plugins/maven-shade-plugin/examples/resource-transformers.html#AppendingTransformer">Resource Transformers</a>ã€ï¼Œå…¶æ”¯æŒå°†æ„å»ºç±»è·¯å¾„ä¸Šçš„æ‰€æœ‰<code class="language-plaintext highlighter-rouge">reference.conf</code>åˆå¹¶ä¸ºä¸€ä¸ªã€‚</p>

<p>æ’ä»¶é…ç½®å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;plugin&gt;</span>
 <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
 <span class="nt">&lt;artifactId&gt;</span>maven-shade-plugin<span class="nt">&lt;/artifactId&gt;</span>
 <span class="nt">&lt;version&gt;</span>1.5<span class="nt">&lt;/version&gt;</span>
 <span class="nt">&lt;executions&gt;</span>
  <span class="nt">&lt;execution&gt;</span>
   <span class="nt">&lt;phase&gt;</span>package<span class="nt">&lt;/phase&gt;</span>
   <span class="nt">&lt;goals&gt;</span>
    <span class="nt">&lt;goal&gt;</span>shade<span class="nt">&lt;/goal&gt;</span>
   <span class="nt">&lt;/goals&gt;</span>
   <span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;shadedArtifactAttached&gt;</span>true<span class="nt">&lt;/shadedArtifactAttached&gt;</span>
    <span class="nt">&lt;shadedClassifierName&gt;</span>allinone<span class="nt">&lt;/shadedClassifierName&gt;</span>
    <span class="nt">&lt;artifactSet&gt;</span>
     <span class="nt">&lt;includes&gt;</span>
      <span class="nt">&lt;include&gt;</span>*:*<span class="nt">&lt;/include&gt;</span>
     <span class="nt">&lt;/includes&gt;</span>
    <span class="nt">&lt;/artifactSet&gt;</span>
    <span class="nt">&lt;transformers&gt;</span>
      <span class="nt">&lt;transformer</span>
       <span class="na">implementation=</span><span class="s">"org.apache.maven.plugins.shade.resource.AppendingTransformer"</span><span class="nt">&gt;</span>
       <span class="nt">&lt;resource&gt;</span>reference.conf<span class="nt">&lt;/resource&gt;</span>
      <span class="nt">&lt;/transformer&gt;</span>
      <span class="nt">&lt;transformer</span>
       <span class="na">implementation=</span><span class="s">"org.apache.maven.plugins.shade.resource.ManifestResourceTransformer"</span><span class="nt">&gt;</span>
       <span class="nt">&lt;manifestEntries&gt;</span>
        <span class="nt">&lt;Main-Class&gt;</span>akka.Main<span class="nt">&lt;/Main-Class&gt;</span>
       <span class="nt">&lt;/manifestEntries&gt;</span>
      <span class="nt">&lt;/transformer&gt;</span>
    <span class="nt">&lt;/transformers&gt;</span>
   <span class="nt">&lt;/configuration&gt;</span>
  <span class="nt">&lt;/execution&gt;</span>
 <span class="nt">&lt;/executions&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="393-è‡ªå®šä¹‰-applicationconf">3.9.3. è‡ªå®šä¹‰ application.conf</h3>
<p>ä¸€ä¸ªè‡ªå®šä¹‰çš„<code class="language-plaintext highlighter-rouge">application.conf</code>é…ç½®å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre>## In this file you can override any option defined in the reference files.
## Copy in parts of the reference files and modify as you please.

akka {

  ## Loggers to register at boot time (akka.event.Logging$DefaultLogger logs
  ## to STDOUT)
  loggers = ["akka.event.slf4j.Slf4jLogger"]

  ## Log level used by the configured loggers (see "loggers") as soon
  ## as they have been started; before that, see "stdout-loglevel"
  ## Options: OFF, ERROR, WARNING, INFO, DEBUG
  loglevel = "DEBUG"

  ## Log level for the very basic logger activated during ActorSystem startup.
  ## This logger prints the log messages to stdout (System.out).
  ## Options: OFF, ERROR, WARNING, INFO, DEBUG
  stdout-loglevel = "DEBUG"

  ## Filter of log events that is used by the LoggingAdapter before
  ## publishing log events to the eventStream.
  logging-filter = "akka.event.slf4j.Slf4jLoggingFilter"

  actor {
    provider = "cluster"

    default-dispatcher {
      ## Throughput for default Dispatcher, set to 1 for as fair as possible
      throughput = 10
    }
  }

  remote {
    ## The port clients should connect to. Default is 2552.
    netty.tcp.port = 4711
  }
}
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="394-åŒ…å«æ–‡ä»¶">3.9.4. åŒ…å«æ–‡ä»¶</h3>
<p>æœ‰æ—¶ï¼ŒåŒ…å«å¦ä¸€ä¸ªé…ç½®æ–‡ä»¶å¯èƒ½å¾ˆæœ‰ç”¨ï¼Œä¾‹å¦‚ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">application.conf</code>ï¼Œå…·æœ‰æ‰€æœ‰ä¸ç¯å¢ƒæ— å…³çš„è®¾ç½®ï¼Œç„¶åè¦†ç›–ç‰¹å®šç¯å¢ƒçš„æŸäº›è®¾ç½®ã€‚</p>

<p>ä½¿ç”¨<code class="language-plaintext highlighter-rouge">-Dconfig.resource=/dev.conf</code>æŒ‡å®šç³»ç»Ÿå±æ€§å°†åŠ è½½<code class="language-plaintext highlighter-rouge">dev.conf</code>æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…æ‹¬<code class="language-plaintext highlighter-rouge">application.conf</code></p>

<ul>
  <li><strong>dev.conf</strong></li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>include "application"

akka {
  loglevel = "DEBUG"
}
</pre></td></tr></tbody></table></code></pre></div></div>
<p>åœ¨ HOCON è§„èŒƒä¸­è§£é‡Šäº†æ›´é«˜çº§çš„åŒ…å«å’Œæ›¿æ¢æœºåˆ¶ã€‚</p>

<h3 id="395-é…ç½®æ—¥å¿—è®°å½•">3.9.5. é…ç½®æ—¥å¿—è®°å½•</h3>
<p>å¦‚æœç³»ç»Ÿæˆ–é…ç½®å±æ€§<code class="language-plaintext highlighter-rouge">akka.log-config-on-start</code>è®¾ç½®ä¸º<code class="language-plaintext highlighter-rouge">on</code>ï¼Œé‚£ä¹ˆå½“ Actor ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œå°†åœ¨<code class="language-plaintext highlighter-rouge">INFO</code>çº§åˆ«è®°å½•å®Œæ•´é…ç½®ã€‚å½“ä½ ä¸ç¡®å®šä½¿ç”¨äº†ä»€ä¹ˆé…ç½®æ—¶ï¼Œè¿™å¾ˆæœ‰ç”¨ã€‚</p>

<p>å¦‚æœæœ‰ç–‘é—®ï¼Œä½ å¯ä»¥åœ¨ä½¿ç”¨é…ç½®å¯¹è±¡æ„å»º Actor ç³»ç»Ÿä¹‹å‰æˆ–ä¹‹åæ£€æŸ¥å®ƒä»¬ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre>Welcome to Scala 2.12 (Java HotSpot(TM) 64-Bit Server VM, Java 1.8.0).
Type in expressions to have them evaluated.
Type :help for more information.

scala&gt; import com.typesafe.config._
import com.typesafe.config._

scala&gt; ConfigFactory.parseString("a.b=12")
res0: com.typesafe.config.Config = Config(SimpleConfigObject({"a" : {"b" : 12}}))

scala&gt; res0.root.render
res1: java.lang.String =
{
    ## String: 1
    "a" : {
        ## String: 1
        "b" : 12
    }
}
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ¯ä¸ªé¡¹ç›®å‰é¢çš„æ³¨é‡Šç»™å‡ºäº†æœ‰å…³è®¾ç½®èµ·ç‚¹ï¼ˆæ–‡ä»¶å’Œè¡Œå·ï¼‰çš„è¯¦ç»†ä¿¡æ¯ä»¥åŠå¯èƒ½å‡ºç°çš„æ³¨é‡Šï¼Œä¾‹å¦‚åœ¨å‚è€ƒé…ç½®ä¸­ã€‚åˆå¹¶å¼•ç”¨å’Œ Actor ç³»ç»Ÿçš„è®¾ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">final</span> <span class="nc">ActorSystem</span> <span class="n">system</span> <span class="o">=</span> <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">system</span><span class="o">.</span><span class="na">settings</span><span class="o">());</span>
<span class="c1">// this is a shortcut for system.settings().config().root().render()</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="396-å…³äºç±»åŠ è½½å™¨çš„ä¸€å¥è¯">3.9.6. å…³äºç±»åŠ è½½å™¨çš„ä¸€å¥è¯</h3>
<p>åœ¨é…ç½®æ–‡ä»¶çš„å‡ ä¸ªåœ°æ–¹ï¼Œå¯ä»¥æŒ‡å®šç”± Akka å®ä¾‹åŒ–çš„æŸä¸ªå¯¹è±¡çš„å®Œå…¨é™å®šç±»åã€‚è¿™æ˜¯ä½¿ç”¨ Java åå°„å®Œæˆçš„ï¼ŒJava åå°„åˆä½¿ç”¨ç±»åŠ è½½å™¨ã€‚åœ¨åº”ç”¨ç¨‹åºå®¹å™¨æˆ– OSGi åŒ…ç­‰å…·æœ‰æŒ‘æˆ˜æ€§çš„ç¯å¢ƒä¸­è·å¾—æ­£ç¡®çš„æ–¹æ³•å¹¶ä¸æ€»æ˜¯å¾ˆç®€å•çš„ï¼ŒAkka çš„å½“å‰æ–¹æ³•æ˜¯ï¼Œæ¯ä¸ª<code class="language-plaintext highlighter-rouge">ActorSystem</code>å®ç°å­˜å‚¨å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆå¦‚æœå¯ç”¨ï¼Œå¦åˆ™åªå­˜å‚¨å…¶è‡ªå·±çš„åŠ è½½å™¨ï¼Œå¦‚<code class="language-plaintext highlighter-rouge">this.getClass.getClassLoader</code>ï¼‰å¹¶å°†å…¶ç”¨äºæ‰€æœ‰åå°„è®¿é—®ã€‚è¿™æ„å‘³ç€å°† Akka æ”¾åœ¨å¼•å¯¼ç±»è·¯å¾„ä¸Šä¼šä»å¥‡æ€ªçš„åœ°æ–¹äº§ç”Ÿ<code class="language-plaintext highlighter-rouge">NullPointerException</code>ï¼šè¿™æ˜¯ä¸æ”¯æŒçš„ã€‚</p>

<h3 id="397-åº”ç”¨ç¨‹åºç‰¹å®šè®¾ç½®">3.9.7. åº”ç”¨ç¨‹åºç‰¹å®šè®¾ç½®</h3>
<p>é…ç½®ä¹Ÿå¯ç”¨äºç‰¹å®šäºåº”ç”¨ç¨‹åºçš„è®¾ç½®ã€‚ä¸€ä¸ªå¥½çš„åšæ³•æ˜¯å°†è¿™äº›è®¾ç½®æ”¾åœ¨ã€Œ<a href="https://github.com/guobinhit/akka-guide/blob/master/articles/index-utilities/extending-akka.md#%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%89%B9%E5%AE%9A%E8%AE%BE%E7%BD%AE">æ‰©å±•</a>ã€ä¸­ã€‚</p>

<h4 id="3971-é…ç½®å¤šä¸ª-actorsystem">3.9.7.1. é…ç½®å¤šä¸ª ActorSystem</h4>
<p>å¦‚æœä½ æœ‰å¤šä¸ª<code class="language-plaintext highlighter-rouge">ActorSystem</code>ï¼ˆæˆ–è€…ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåº“ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">ActorSystem</code>å¯èƒ½ä¸åº”ç”¨ç¨‹åºçš„<code class="language-plaintext highlighter-rouge">ActorSystem</code>åˆ†ç¦»ï¼‰ï¼Œé‚£ä¹ˆä½ å¯èƒ½éœ€è¦åˆ†ç¦»æ¯ä¸ªç³»ç»Ÿçš„é…ç½®ã€‚</p>

<p>è€ƒè™‘åˆ°<code class="language-plaintext highlighter-rouge">ConfigFactory.load()</code>ä»æ•´ä¸ªç±»è·¯å¾„ä¸­åˆå¹¶æ‰€æœ‰å…·æœ‰åŒ¹é…åç§°çš„èµ„æºï¼Œåˆ©ç”¨è¯¥åŠŸèƒ½åŒºåˆ†é…ç½®å±‚æ¬¡ç»“æ„ä¸­çš„ Actor ç³»ç»Ÿæ˜¯æœ€å®¹æ˜“ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>myapp1 {
  akka.loglevel = "WARNING"
  my.own.setting = 43
}
myapp2 {
  akka.loglevel = "ERROR"
  app2.setting = "appname"
}
my.own.setting = 42
my.other.setting = "hello"
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">val</span> <span class="n">config</span> <span class="o">=</span> <span class="nc">ConfigFactory</span><span class="o">.</span><span class="na">load</span><span class="o">()</span>
<span class="n">val</span> <span class="n">app1</span> <span class="o">=</span> <span class="nc">ActorSystem</span><span class="o">(</span><span class="s">"MyApp1"</span><span class="o">,</span> <span class="n">config</span><span class="o">.</span><span class="na">getConfig</span><span class="o">(</span><span class="s">"myapp1"</span><span class="o">).</span><span class="na">withFallback</span><span class="o">(</span><span class="n">config</span><span class="o">))</span>
<span class="n">val</span> <span class="n">app2</span> <span class="o">=</span> <span class="nc">ActorSystem</span><span class="o">(</span><span class="s">"MyApp2"</span><span class="o">,</span>
  <span class="n">config</span><span class="o">.</span><span class="na">getConfig</span><span class="o">(</span><span class="s">"myapp2"</span><span class="o">).</span><span class="na">withOnlyPath</span><span class="o">(</span><span class="s">"akka"</span><span class="o">).</span><span class="na">withFallback</span><span class="o">(</span><span class="n">config</span><span class="o">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™ä¸¤ä¸ªç¤ºä¾‹æ¼”ç¤ºäº†â€œæå‡å­æ ‘ï¼ˆ<code class="language-plaintext highlighter-rouge">lift-a-subtree</code>ï¼‰â€æŠ€å·§çš„ä¸åŒå˜åŒ–ï¼šåœ¨ç¬¬ä¸€ç§æƒ…å†µä¸‹ï¼Œä» Actor ç³»ç»Ÿä¸­è®¿é—®çš„é…ç½®æ˜¯</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>akka.loglevel = "WARNING"
my.own.setting = 43
my.other.setting = "hello"
// plus myapp1 and myapp2 subtrees
</pre></td></tr></tbody></table></code></pre></div></div>
<p>åœ¨ç¬¬äºŒç§æƒ…å†µä¸‹ï¼Œåªæå‡â€œakkaâ€å­æ ‘ï¼Œç»“æœå¦‚ä¸‹</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>akka.loglevel = "ERROR"
my.own.setting = 42
my.other.setting = "hello"
// plus myapp1 and myapp2 subtrees
</pre></td></tr></tbody></table></code></pre></div></div>
<ul>
  <li><strong>æ³¨é‡Š</strong>ï¼šé…ç½®åº“éå¸¸å¼ºå¤§ï¼Œè¯´æ˜å…¶æ‰€æœ‰åŠŸèƒ½è¶…å‡ºäº†æœ¬æ–‡çš„èŒƒå›´ã€‚å°¤å…¶ä¸åŒ…æ‹¬å¦‚ä½•å°†å…¶ä»–é…ç½®æ–‡ä»¶åŒ…å«åœ¨å…¶ä»–æ–‡ä»¶ä¸­ï¼ˆå‚è§ã€Œ<a href="https://github.com/guobinhit/akka-guide/blob/master/articles/general-concepts/configuration.md#%E5%8C%85%E5%90%AB%E6%96%87%E4%BB%B6">åŒ…å«æ–‡ä»¶</a>ã€ä¸­çš„ä¸€ä¸ªå°ç¤ºä¾‹ï¼‰ä»¥åŠé€šè¿‡è·¯å¾„æ›¿æ¢å¤åˆ¶é…ç½®æ ‘çš„éƒ¨åˆ†ã€‚</li>
</ul>

<p>åœ¨å®ä¾‹åŒ–<code class="language-plaintext highlighter-rouge">ActorSystem</code>æ—¶ï¼Œè¿˜å¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼ä»¥ç¼–ç¨‹æ–¹å¼æŒ‡å®šå’Œåˆ†æé…ç½®ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">akka.actor.ActorSystem</span>
<span class="kn">import</span> <span class="nn">com.typesafe.config.ConfigFactory</span>
<span class="n">val</span> <span class="n">customConf</span> <span class="o">=</span> <span class="nc">ConfigFactory</span><span class="o">.</span><span class="na">parseString</span><span class="o">(</span><span class="s">"""
  akka.actor.deployment {
    /my-service {
      router = round-robin-pool
      nr-of-instances = 3
    }
  }
  """</span><span class="o">)</span>
<span class="c1">// ConfigFactory.load sandwiches customConfig between default reference</span>
<span class="c1">// config and default overrides, and then resolves it.</span>
<span class="n">val</span> <span class="n">system</span> <span class="o">=</span> <span class="nc">ActorSystem</span><span class="o">(</span><span class="s">"MySystem"</span><span class="o">,</span> <span class="nc">ConfigFactory</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">customConf</span><span class="o">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="398-ä»è‡ªå®šä¹‰ä½ç½®è¯»å–é…ç½®">3.9.8. ä»è‡ªå®šä¹‰ä½ç½®è¯»å–é…ç½®</h3>
<p>ä½ å¯ä»¥åœ¨ä»£ç æˆ–ä½¿ç”¨ç³»ç»Ÿå±æ€§ä¸­æ›¿æ¢æˆ–è¡¥å……<code class="language-plaintext highlighter-rouge">application.conf</code>ã€‚</p>

<p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯<code class="language-plaintext highlighter-rouge">ConfigFactory.load()</code>ï¼ˆé»˜è®¤æƒ…å†µä¸‹ Akka ä¼šè¿™æ ·åšï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡å®šä¹‰<code class="language-plaintext highlighter-rouge">-Dconfig.resource=whatever</code>ã€<code class="language-plaintext highlighter-rouge">-Dconfig.file=whatever</code>æˆ–<code class="language-plaintext highlighter-rouge">-Dconfig.url=whatever</code>æ¥æ›¿æ¢<code class="language-plaintext highlighter-rouge">application.conf</code>ã€‚</p>

<p>åœ¨ç”¨<code class="language-plaintext highlighter-rouge">-Dconfig.resource</code>å’Œ<code class="language-plaintext highlighter-rouge">friends</code>æŒ‡å®šçš„æ›¿æ¢æ–‡ä»¶ä¸­ï¼Œå¦‚æœä½ ä»ç„¶æƒ³ä½¿ç”¨<code class="language-plaintext highlighter-rouge">application.{conf,json,properties}</code>ï¼Œå¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">include "application"</code>ã€‚åœ¨<code class="language-plaintext highlighter-rouge">include "application"</code>ä¹‹å‰æŒ‡å®šçš„è®¾ç½®å°†è¢«åŒ…å«çš„æ–‡ä»¶è¦†ç›–ï¼Œè€Œåœ¨<code class="language-plaintext highlighter-rouge">include "application"</code>ä¹‹åæŒ‡å®šçš„è®¾ç½®å°†è¦†ç›–åŒ…å«çš„æ–‡ä»¶ã€‚</p>

<p>åœ¨ä»£ç ä¸­ï¼Œæœ‰è®¸å¤šè‡ªå®šä¹‰é€‰é¡¹ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">ConfigFactory.load()</code>æœ‰å‡ ä¸ªé‡è½½ï¼›è¿™äº›é‡è½½å…è®¸ä½ æŒ‡å®šä¸€äº›å¤¹åœ¨ç³»ç»Ÿå±æ€§ï¼ˆé‡å†™ï¼‰å’Œé»˜è®¤å€¼ï¼ˆæ¥è‡ª<code class="language-plaintext highlighter-rouge">reference.conf</code>ï¼‰ä¹‹é—´çš„å†…å®¹ï¼Œæ›¿æ¢å¸¸è§„<code class="language-plaintext highlighter-rouge">application.{conf,json,properties}</code>å¹¶æ›¿æ¢<code class="language-plaintext highlighter-rouge"> -Dconfig.file</code>å’Œ<code class="language-plaintext highlighter-rouge">friends</code>ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">ConfigFactory.load()</code>çš„æœ€ç®€å•å˜ä½“é‡‡ç”¨èµ„æºåŸºåç§°ï¼ˆ<code class="language-plaintext highlighter-rouge">resource basename</code>ï¼‰ï¼Œè€Œä¸æ˜¯åº”ç”¨ç¨‹åºï¼›ç„¶åå°†ä½¿ç”¨<code class="language-plaintext highlighter-rouge">myname.conf</code>ã€<code class="language-plaintext highlighter-rouge">myname.json</code>å’Œ<code class="language-plaintext highlighter-rouge">myname.properties</code>è€Œä¸æ˜¯<code class="language-plaintext highlighter-rouge">application.{conf,json,properties}</code>ã€‚</p>

<p>æœ€çµæ´»çš„å˜ä½“é‡‡ç”¨<code class="language-plaintext highlighter-rouge">Config</code>å¯¹è±¡ï¼Œä½ å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">ConfigFactory</code>ä¸­çš„ä»»ä½•æ–¹æ³•åŠ è½½è¯¥å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">ConfigFactory.parseString()</code>åœ¨ä»£ç ä¸­æ”¾ç½®é…ç½®å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥åˆ¶ä½œæ˜ å°„å’Œ<code class="language-plaintext highlighter-rouge">ConfigFactory.parseMap()</code>ï¼Œæˆ–è€…åŠ è½½æ–‡ä»¶ã€‚</p>

<p>ä½ è¿˜å¯ä»¥å°†è‡ªå®šä¹‰é…ç½®ä¸å¸¸è§„é…ç½®ç»“åˆèµ·æ¥ï¼Œè¿™å¯èƒ½çœ‹èµ·æ¥åƒï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="c1">// make a Config with just your special setting</span>
<span class="nc">Config</span> <span class="n">myConfig</span> <span class="o">=</span> <span class="nc">ConfigFactory</span><span class="o">.</span><span class="na">parseString</span><span class="o">(</span><span class="s">"something=somethingElse"</span><span class="o">);</span>
<span class="c1">// load the normal config stack (system props,</span>
<span class="c1">// then application.conf, then reference.conf)</span>
<span class="nc">Config</span> <span class="n">regularConfig</span> <span class="o">=</span> <span class="nc">ConfigFactory</span><span class="o">.</span><span class="na">load</span><span class="o">();</span>
<span class="c1">// override regular stack with myConfig</span>
<span class="nc">Config</span> <span class="n">combined</span> <span class="o">=</span> <span class="n">myConfig</span><span class="o">.</span><span class="na">withFallback</span><span class="o">(</span><span class="n">regularConfig</span><span class="o">);</span>
<span class="c1">// put the result in between the overrides</span>
<span class="c1">// (system props) and defaults again</span>
<span class="nc">Config</span> <span class="n">complete</span> <span class="o">=</span> <span class="nc">ConfigFactory</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">combined</span><span class="o">);</span>
<span class="c1">// create ActorSystem</span>
<span class="nc">ActorSystem</span> <span class="n">system</span> <span class="o">=</span> <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">"myname"</span><span class="o">,</span> <span class="n">complete</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ä½¿ç”¨<code class="language-plaintext highlighter-rouge">Config</code>å¯¹è±¡æ—¶ï¼Œè¯·è®°ä½è›‹ç³•ä¸­æœ‰ä¸‰ä¸ªâ€œå±‚â€ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ConfigFactory.defaultOverrides()</code>ï¼ˆç³»ç»Ÿå±æ€§ï¼‰</li>
  <li>åº”ç”¨ç¨‹åºçš„è®¾ç½®</li>
  <li><code class="language-plaintext highlighter-rouge">ConfigFactory.defaultReference()</code>ï¼ˆ<code class="language-plaintext highlighter-rouge">reference.conf</code>ï¼‰</li>
</ul>

<p>é€šå¸¸çš„ç›®æ ‡æ˜¯å®šåˆ¶ä¸­é—´å±‚ï¼Œè€Œä¸è®©å…¶ä»–ä¸¤å±‚å•ç‹¬ä½¿ç”¨ã€‚</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ConfigFactory.load()</code>åŠ è½½æ•´ä¸ªå †æ ˆ</li>
  <li><code class="language-plaintext highlighter-rouge">ConfigFactory.load()</code>çš„é‡è½½å…è®¸ä½ æŒ‡å®šä¸åŒçš„ä¸­é—´å±‚</li>
  <li><code class="language-plaintext highlighter-rouge">ConfigFactory.parse()</code>å˜ä½“åŠ è½½å•ä¸ªæ–‡ä»¶æˆ–èµ„æº</li>
</ul>

<p>è¦å †å ä¸¤å±‚ï¼Œè¯·ä½¿ç”¨<code class="language-plaintext highlighter-rouge">override.withFallback(fallback)</code>ï¼›å°è¯•å°†ç³»ç»Ÿå±æ€§ï¼ˆ<code class="language-plaintext highlighter-rouge">defaultOverrides()</code>ï¼‰ä¿æŒåœ¨é¡¶éƒ¨ï¼Œå¹¶å°†<code class="language-plaintext highlighter-rouge">reference.conf</code>ï¼ˆ<code class="language-plaintext highlighter-rouge">defaultReference()</code>ï¼‰ä¿æŒåœ¨åº•éƒ¨ã€‚</p>

<p>è¯·è®°ä½ï¼Œä½ é€šå¸¸å¯ä»¥åœ¨<code class="language-plaintext highlighter-rouge">application.conf</code>ä¸­æ·»åŠ å¦ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">include</code>è¯­å¥ï¼Œè€Œä¸æ˜¯ç¼–å†™ä»£ç ã€‚<code class="language-plaintext highlighter-rouge">application.conf</code>é¡¶éƒ¨çš„<code class="language-plaintext highlighter-rouge">include</code>å°†è¢«<code class="language-plaintext highlighter-rouge">application.conf</code>çš„å…¶ä½™éƒ¨åˆ†è¦†ç›–ï¼Œè€Œåº•éƒ¨çš„<code class="language-plaintext highlighter-rouge">include</code>å°†è¦†ç›–å‰é¢çš„å†…å®¹ã€‚</p>

<h3 id="399-actor-éƒ¨ç½²é…ç½®">3.9.9. Actor éƒ¨ç½²é…ç½®</h3>
<p>ç‰¹å®š Actor çš„éƒ¨ç½²è®¾ç½®å¯ä»¥åœ¨é…ç½®çš„<code class="language-plaintext highlighter-rouge">akka.actor.deployment</code>éƒ¨åˆ†ä¸­å®šä¹‰ã€‚åœ¨éƒ¨ç½²éƒ¨åˆ†ï¼Œå¯ä»¥å®šä¹‰è°ƒåº¦ç¨‹åºã€é‚®ç®±ã€è·¯ç”±è®¾ç½®å’Œè¿œç¨‹éƒ¨ç½²ç­‰å†…å®¹ã€‚è¿™äº›åŠŸèƒ½çš„é…ç½®åœ¨è¯¦ç»†ä»‹ç»ç›¸åº”ä¸»é¢˜çš„ç« èŠ‚ä¸­è¿›è¡Œäº†æè¿°ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre>akka.actor.deployment {

  ## '/user/actorA/actorB' is a remote deployed actor
  /actorA/actorB {
    remote = "akka.tcp://sampleActorSystem@127.0.0.1:2553"
  }
  
  ## all direct children of '/user/actorC' have a dedicated dispatcher 
  "/actorC/*" {
    dispatcher = my-dispatcher
  }

  ## all descendants of '/user/actorC' (direct children, and their children recursively)
  ## have a dedicated dispatcher
  "/actorC/**" {
    dispatcher = my-dispatcher
  }
  
  ## '/user/actorD/actorE' has a special priority mailbox
  /actorD/actorE {
    mailbox = prio-mailbox
  }
  
  ## '/user/actorF/actorG/actorH' is a random pool
  /actorF/actorG/actorH {
    router = random-pool
    nr-of-instances = 5
  }
}

my-dispatcher {
  fork-join-executor.parallelism-min = 10
  fork-join-executor.parallelism-max = 10
}
prio-mailbox {
  mailbox-type = "a.b.MyPrioMailbox"
}
</pre></td></tr></tbody></table></code></pre></div></div>
<ul>
  <li><strong>æ³¨é‡Š</strong>ï¼šç‰¹å®š Actor çš„éƒ¨ç½²éƒ¨åˆ†ç”± Actor ç›¸å¯¹äº<code class="language-plaintext highlighter-rouge">/user</code>çš„è·¯å¾„æ ‡è¯†ã€‚</li>
</ul>

<p>å¯ä»¥ä½¿ç”¨æ˜Ÿå·ä½œä¸º Actor è·¯å¾„éƒ¨åˆ†çš„é€šé…ç¬¦åŒ¹é…ï¼Œå› æ­¤å¯ä»¥æŒ‡å®šï¼š<code class="language-plaintext highlighter-rouge">/*/sampleActor</code>ï¼Œå®ƒå°†åŒ¹é…å±‚æ¬¡ç»“æ„ä¸­è¯¥çº§åˆ«ä¸Šçš„æ‰€æœ‰<code class="language-plaintext highlighter-rouge">sampleActor</code>ã€‚æ­¤å¤–ï¼Œè¯·æ³¨æ„ï¼š</p>

<ul>
  <li>å¯ä»¥åœ¨æœ€åä¸€ä¸ªä½ç½®ä½¿ç”¨é€šé…ç¬¦æ¥åŒ¹é…ç‰¹å®šçº§åˆ«çš„æ‰€æœ‰ Actorï¼š<code class="language-plaintext highlighter-rouge">/someparent/*</code></li>
  <li>å¯ä»¥åœ¨æœ€åä¸€ä¸ªä½ç½®ä½¿ç”¨åŒé€šé…ç¬¦ä»¥é€’å½’æ–¹å¼åŒ¹é…æ‰€æœ‰å­ Actor åŠå…¶å­å‚ Actorï¼š<code class="language-plaintext highlighter-rouge">/someparent/**</code></li>
  <li>éé€šé…ç¬¦åŒ¹é…æ€»æ˜¯æ¯”é€šé…ç¬¦å…·æœ‰æ›´é«˜çš„åŒ¹é…ä¼˜å…ˆçº§ï¼Œå¹¶ä¸”å•ä¸ªé€šé…ç¬¦åŒ¹é…æ¯”åŒé€šé…ç¬¦å…·æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ï¼Œå› æ­¤ï¼š<code class="language-plaintext highlighter-rouge">/foo/bar</code>è¢«è®¤ä¸ºæ¯”<code class="language-plaintext highlighter-rouge">/foo/*</code>æ›´å…·ä½“ï¼Œåè€…è¢«è®¤ä¸ºæ¯”<code class="language-plaintext highlighter-rouge">/foo/**</code>æ›´å…·ä½“ï¼Œä»…ä½¿ç”¨æœ€é«˜ä¼˜å…ˆçº§åŒ¹é…ã€‚</li>
  <li>é€šé…ç¬¦ä¸èƒ½ç”¨äºéƒ¨åˆ†åŒ¹é…ï¼Œå¦‚<code class="language-plaintext highlighter-rouge">/foo*/bar</code>ã€<code class="language-plaintext highlighter-rouge">/f*o/bar</code>ç­‰ã€‚</li>
  <li>åŒé€šé…ç¬¦åªèƒ½æ”¾åœ¨æœ€åä¸€ä¸ªä½ç½®ã€‚</li>
</ul>

<h3 id="3910-å‚è€ƒé…ç½®åˆ—è¡¨">3.9.10. å‚è€ƒé…ç½®åˆ—è¡¨</h3>
<p>æ¯ä¸ª Akka æ¨¡å—éƒ½æœ‰ä¸€ä¸ªå¸¦æœ‰é»˜è®¤å€¼çš„å‚è€ƒé…ç½®æ–‡ä»¶ã€‚</p>

<ul>
  <li><a href="https://doc.akka.io/docs/akka/current/general/configuration.html#akka-actor">akka-actor</a></li>
  <li><a href="https://doc.akka.io/docs/akka/current/general/configuration.html#akka-agent">akka-agent</a></li>
  <li><a href="https://doc.akka.io/docs/akka/current/general/configuration.html#akka-camel">akka-camel</a></li>
  <li><a href="https://doc.akka.io/docs/akka/current/general/configuration.html#akka-cluster">akka-cluster</a></li>
  <li><a href="https://doc.akka.io/docs/akka/current/general/configuration.html#akka-multi-node-testkit">akka-multi-node-testkit</a></li>
  <li><a href="https://doc.akka.io/docs/akka/current/general/configuration.html#akka-persistence">akka-persistence</a></li>
  <li><a href="https://doc.akka.io/docs/akka/current/general/configuration.html#akka-remote">akka-remote</a></li>
  <li><a href="https://doc.akka.io/docs/akka/current/general/configuration.html#akka-remote-artery-">akka-remote (artery)</a></li>
  <li><a href="https://doc.akka.io/docs/akka/current/general/configuration.html#akka-testkit">akka-testkit</a></li>
  <li><a href="https://doc.akka.io/docs/akka/current/general/configuration.html#akka-cluster-metrics">akka-cluster-metrics</a></li>
  <li><a href="https://doc.akka.io/docs/akka/current/general/configuration.html#akka-cluster-tools">akka-cluster-tools</a></li>
  <li><a href="https://doc.akka.io/docs/akka/current/general/configuration.html#akka-cluster-sharding">akka-cluster-sharding</a></li>
  <li><a href="https://doc.akka.io/docs/akka/current/general/configuration.html#akka-distributed-data">akka-distributed-data</a></li>
</ul>

<hr />

<p><strong>è‹±æ–‡åŸæ–‡é“¾æ¥</strong>ï¼š<a href="https://doc.akka.io/docs/akka/current/general/configuration.html">Configuration</a>.</p>

<h1 id="4-actors">4. Actors</h1>

<blockquote>
  <p>æ ¸å¿ƒAkkaåº“æ˜¯Akka-actor-typedï¼Œä½†æ˜¯actorsæ˜¯è·¨Akkaåº“ä½¿ç”¨çš„ï¼Œæä¾›äº†ä¸€è‡´çš„ã€é›†æˆçš„æ¨¡å‹ï¼Œä½¿æ‚¨ä¸å¿…å•ç‹¬è§£å†³å¹¶å‘æˆ–åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡ä¸­å‡ºç°çš„æŒ‘æˆ˜ã€‚ä»è¡¨é¢ä¸Šçœ‹ï¼Œactoræ˜¯ä¸€ç§é‡‡ç”¨å°è£…(OOPçš„æ”¯æŸ±ä¹‹ä¸€)çš„ç¼–ç¨‹èŒƒå¼ï¼Œå®ƒè¾¾åˆ°äº†æé™ã€‚ä¸å¯¹è±¡ä¸åŒï¼Œactorä¸ä»…å°è£…äº†å®ƒä»¬çš„çŠ¶æ€ï¼Œè€Œä¸”å°è£…äº†å®ƒä»¬çš„æ‰§è¡Œã€‚ä¸Actorçš„é€šä¿¡ä¸æ˜¯é€šè¿‡æ–¹æ³•è°ƒç”¨ï¼Œè€Œæ˜¯é€šè¿‡ä¼ é€’æ¶ˆæ¯ã€‚è™½ç„¶è¿™ç§å·®å¼‚çœ‹èµ·æ¥å¾ˆå°ï¼Œä½†å®ƒå®é™…ä¸Šä½¿æˆ‘ä»¬åœ¨å¹¶å‘æ€§å’Œè¿œç¨‹é€šä¿¡æ–¹é¢æ‘†è„±äº†OOPçš„é™åˆ¶ã€‚å¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªæè¿°è¿‡äºæ·±å¥¥ï¼Œè¿˜ä¸èƒ½å®Œå…¨ç†è§£çš„è¯ï¼Œè¯·ä¸è¦æ‹…å¿ƒï¼Œåœ¨ä¸‹ä¸€ç« æˆ‘ä»¬å°†è¯¦ç»†è§£é‡Šactorã€‚ç›®å‰ï¼Œé‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œè¿™æ˜¯ä¸€ä¸ªåœ¨åŸºç¡€çº§åˆ«å¤„ç†å¹¶å‘å’Œåˆ†å‘çš„æ¨¡å‹ï¼Œè€Œä¸æ˜¯é€šè¿‡ä¸´æ—¶ä¿®è¡¥å°è¯•å°†è¿™äº›ç‰¹æ€§å¼•å…¥OOPã€‚</p>
</blockquote>

<blockquote>
  <p>Actor è§£å†³çš„æŒ‘æˆ˜åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢:</p>
  <ul>
    <li>å¦‚ä½•æ„å»ºå’Œè®¾è®¡é«˜æ€§èƒ½å¹¶å‘åº”ç”¨ç¨‹åºã€‚</li>
    <li>å¦‚ä½•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å¤„ç†é”™è¯¯ã€‚</li>
    <li>å¦‚ä½•ä¿æŠ¤æˆ‘çš„é¡¹ç›®ä¸å—å¹¶å‘é™·é˜±çš„å½±å“ã€‚</li>
  </ul>
</blockquote>

<h2 id="41-actors-åŸºç¡€">4.1. Actors åŸºç¡€</h2>

<h3 id="411-actor-mavenä¾èµ–åº“">4.1.1. Actor Mavenä¾èµ–åº“</h3>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;properties&gt;</span>
  <span class="nt">&lt;akka.version&gt;</span>2.6.8<span class="nt">&lt;/akka.version&gt;</span>
  <span class="nt">&lt;scala.binary.version&gt;</span>2.13<span class="nt">&lt;/scala.binary.version&gt;</span>
<span class="nt">&lt;/properties&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.typesafe.akka<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>akka-actor-typed_${scala.binary.version}<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>${akka.version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="412-actor-ç®€ä»‹">4.1.2. Actor ç®€ä»‹</h3>

<p>ä½¿ç”¨Akkaä½¿æ‚¨ä¸å¿…ä¸ºactorç³»ç»Ÿåˆ›å»ºåŸºç¡€è®¾æ–½ï¼Œä¹Ÿä¸å¿…ç¼–å†™æ§åˆ¶åŸºæœ¬è¡Œä¸ºæ‰€éœ€çš„åº•å±‚ä»£ç ã€‚ä¸ºäº†ç†è§£è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹æ‚¨åœ¨ä»£ç ä¸­åˆ›å»ºçš„Actorä¸Akkaåœ¨å†…éƒ¨ä¸ºæ‚¨åˆ›å»ºå’Œç®¡ç†çš„Actorä¹‹é—´çš„å…³ç³»ï¼ŒActorç”Ÿå‘½å‘¨æœŸå’Œå¤±è´¥å¤„ç†ã€‚</p>

<h3 id="413-actor-å±‚æ¬¡ç»“æ„">4.1.3. Actor å±‚æ¬¡ç»“æ„</h3>

<p>åœ¨Akkaä¸­Actoræ°¸è¿œå±äºçˆ¶Actorã€‚æ‚¨å¯ä»¥é€šè¿‡è°ƒç”¨ActorContext.spawn()æ¥åˆ›å»ºä¸€ä¸ªactorã€‚åˆ›å»ºè€…Actoræˆä¸ºæ–°åˆ›å»ºçš„å­Actorçš„çˆ¶Actorã€‚æ‚¨å¯èƒ½ä¼šé—®ï¼Œæ‚¨åˆ›å»ºçš„ç¬¬ä¸€ä¸ªactorçš„çˆ¶å…ƒç´ æ˜¯è°?</p>

<p>å¦‚ä¸‹æ‰€ç¤ºï¼Œæ‰€æœ‰Actorséƒ½æœ‰ä¸€ä¸ªå…±åŒçš„çˆ¶Actorï¼Œå³ç”¨æˆ·ç›‘æŠ¤äººï¼Œå®ƒæ˜¯åœ¨å¯åŠ¨ActorSystemæ—¶å®šä¹‰å’Œåˆ›å»ºçš„ã€‚æ­£å¦‚æˆ‘ä»¬åœ¨ã€Šå¿«é€Ÿå…¥é—¨æŒ‡å—ã€‹ä¸­æåˆ°çš„ï¼Œactorçš„åˆ›å»ºå°†è¿”å›ä¸€ä¸ªå¼•ç”¨ï¼Œè¯¥å¼•ç”¨æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„URLã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬ä»ç”¨æˆ·guardianä¸­ä½¿ç”¨<code class="language-plaintext highlighter-rouge">context.spawn(someBehavior, "someActor")</code>åˆ›å»ºä¸€ä¸ªåä¸ºsomeActorçš„actorï¼Œå…¶å¼•ç”¨å°†åŒ…æ‹¬è·¯å¾„<code class="language-plaintext highlighter-rouge">/user/someActor</code>ã€‚</p>

<p><img src="https://liulv.work/images/img/20200802224604.png" alt="20200802224604" /></p>

<p>å®é™…ä¸Šï¼Œåœ¨å¯åŠ¨ç¬¬ä¸€ä¸ªActorä¹‹å‰ï¼ŒAkkaå·²ç»åœ¨ç³»ç»Ÿä¸­åˆ›å»ºäº†ä¸¤ä¸ªActorã€‚è¿™äº›å†…ç½®Actorçš„åç§°åŒ…å«ç›‘æŠ¤äºº(guardian)ã€‚ç›‘æ§ActoråŒ…æ‹¬:</p>

<ul>
  <li>
    <p>/ æ‰€è°“çš„æ ¹ç›‘æŠ¤è€…ï¼ˆguardianï¼‰- å®ƒæ˜¯ç³»ç»Ÿä¸­æ‰€æœ‰è§’è‰²çš„çˆ¶çº§ï¼Œä¹Ÿæ˜¯ç³»ç»Ÿæœ¬èº«ç»ˆæ­¢æ—¶æœ€åä¸€ä¸ªåœæ­¢çš„è§’è‰²ã€‚</p>
  </li>
  <li>
    <p>/system ç³»ç»Ÿçš„ç›‘æŠ¤è€… - Akkaæˆ–æ„å»ºåœ¨Akkaä¹‹ä¸Šçš„å…¶ä»–åº“å¯ä»¥åœ¨ç³»ç»Ÿåç§°ç©ºé—´ä¸­åˆ›å»ºActorã€‚</p>
  </li>
  <li>
    <p>/user ç”¨æˆ·çš„ç›‘æŠ¤è€… - è¿™æ˜¯æ‚¨ä¸ºå¯åŠ¨åº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰å…¶ä»–Actorè€Œæä¾›çš„é¡¶çº§Actorã€‚</p>
  </li>
</ul>

<p>æŸ¥çœ‹actorå±‚æ¬¡ç»“æ„çš„æœ€ç®€å•æ–¹æ³•æ˜¯æ‰“å°ActorRefå®ä¾‹ã€‚åœ¨è¿™ä¸ªå°å®éªŒä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªactorï¼Œæ‰“å°å®ƒçš„å¼•ç”¨ï¼Œåˆ›å»ºè¿™ä¸ªactorçš„å­å…ƒç´ ï¼Œç„¶åæ‰“å°å­å…ƒç´ çš„å¼•ç”¨ã€‚æˆ‘ä»¬ä»Hello Worldé¡¹ç›®å¼€å§‹ï¼Œå¦‚æœæ‚¨è¿˜æ²¡æœ‰ä¸‹è½½å®ƒï¼Œè¯·ä»LightbendæŠ€æœ¯ä¸­å¿ƒä¸‹è½½Quickstarté¡¹ç›®ã€‚</p>

<p>åœ¨Hello Worldé¡¹ç›®ä¸­ï¼Œå¯¼èˆªåˆ°<code class="language-plaintext highlighter-rouge">com.tcfuture.akka.actor.architecture</code>ç¤ºä¾‹åŒ…ï¼Œå¹¶ä¸ºä¸‹é¢ä»£ç ç‰‡æ®µä¸­çš„æ¯ä¸ªç±»åˆ›å»ºä¸€ä¸ªJavaæ–‡ä»¶ï¼Œå¹¶å¤åˆ¶å„è‡ªçš„å†…å®¹ã€‚ä¿å­˜æ–‡ä»¶å¹¶è¿è¡Œ<code class="language-plaintext highlighter-rouge">com.tcfuture.akka.actor.hello.PrintMyActorRefActor.ActorHierarchyExperiments</code>ä»æ„å»ºå·¥å…·æˆ–IDEä¸­è§‚å¯Ÿè¾“å‡ºã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">akka.actor.typed.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorSystem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.Behavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.AbstractBehavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.ActorContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Behaviors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Receive</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">PrintMyActorRefActor</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">PrintMyActorRefActor:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nf">PrintMyActorRefActor</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onMessageEquals</span><span class="o">(</span><span class="s">"printit"</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">printIt</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">printIt</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">secondRef</span> <span class="o">=</span> <span class="n">getContext</span><span class="o">().</span><span class="na">spawn</span><span class="o">(</span><span class="nc">Behaviors</span><span class="o">.</span><span class="na">empty</span><span class="o">(),</span> <span class="s">"second-actor"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Second: "</span> <span class="o">+</span> <span class="n">secondRef</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Main</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">Main:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nf">Main</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onMessageEquals</span><span class="o">(</span><span class="s">"start"</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">start</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">firstRef</span> <span class="o">=</span> <span class="n">getContext</span><span class="o">().</span><span class="na">spawn</span><span class="o">(</span><span class="nc">PrintMyActorRefActor</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"first-actor"</span><span class="o">);</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"First: "</span> <span class="o">+</span> <span class="n">firstRef</span><span class="o">);</span>
    <span class="n">firstRef</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="s">"printit"</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ActorHierarchyExperiments</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">testSystem</span> <span class="o">=</span> <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">Main</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"testSystem"</span><span class="o">);</span>
    <span class="n">testSystem</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="s">"start"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¯·æ³¨æ„æ¶ˆæ¯è¦æ±‚ç¬¬ä¸€ä¸ªactoræ‰§è¡Œå…¶å·¥ä½œçš„æ–¹å¼ã€‚æˆ‘ä»¬ä½¿ç”¨çˆ¶èŠ‚ç‚¹çš„å¼•ç”¨å‘é€æ¶ˆæ¯:<code class="language-plaintext highlighter-rouge">firstRef.tell("printit", ActorRef.noSender())</code>ã€‚å½“ä»£ç æ‰§è¡Œæ—¶ï¼Œè¾“å‡ºåŒ…æ‹¬å¯¹ç¬¬ä¸€ä¸ªactorçš„å¼•ç”¨ä»¥åŠå®ƒä½œä¸ºprintitå¤§å°å†™çš„ä¸€éƒ¨åˆ†åˆ›å»ºçš„å­å…ƒç´ ã€‚æ‚¨çš„è¾“å‡ºåº”è¯¥ç±»ä¼¼äºä»¥ä¸‹å†…å®¹:</p>

<pre><code class="language-log">First: Actor[akka://testSystem/user/first-actor#1053618476]
Second: Actor[akka://testSystem/user/first-actor/second-actor#-1544706041]
</code></pre>

<p>è¾“å‡ºæ‰“å°å¦‚ä¸‹ï¼š</p>

<p><img src="https://liulv.work/images/img/20200802230207.png" alt="20200802230207" /></p>

<p>æ³¨æ„å¼•ç”¨çš„ç»“æ„:</p>

<ul>
  <li>
    <p>ä¸¤ä¸ªè·¯å¾„éƒ½ä»<code class="language-plaintext highlighter-rouge">akka://testSystem/</code>å¼€å§‹ã€‚å› ä¸ºæ‰€æœ‰çš„actorå¼•ç”¨éƒ½æ˜¯æœ‰æ•ˆçš„urlï¼Œæ‰€ä»¥akka://æ˜¯åè®®å­—æ®µçš„å€¼ã€‚</p>
  </li>
  <li>
    <p>æ¥ä¸‹æ¥ï¼Œå°±åƒåœ¨ä¸‡ç»´ç½‘ä¸Šä¸€æ ·ï¼ŒURLæ ‡è¯†ç³»ç»Ÿã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œç³»ç»Ÿè¢«å‘½åä¸ºtestSystemï¼Œä½†å®ƒå¯ä»¥æ˜¯ä»»ä½•å…¶ä»–åç§°ã€‚å¦‚æœå¯ç”¨äº†å¤šä¸ªç³»ç»Ÿä¹‹é—´çš„è¿œç¨‹é€šä¿¡ï¼ŒURLçš„è¿™ä¸€éƒ¨åˆ†å°†åŒ…å«ä¸»æœºåï¼Œä»¥ä¾¿å…¶ä»–ç³»ç»Ÿå¯ä»¥åœ¨ç½‘ç»œä¸Šæ‰¾åˆ°å®ƒã€‚</p>
  </li>
  <li>
    <p>å› ä¸ºç¬¬äºŒä¸ªActorçš„å¼•ç”¨åŒ…å«è·¯å¾„<code class="language-plaintext highlighter-rouge">/first-actor/</code>ï¼Œæ‰€ä»¥å®ƒå°†å…¶æ ‡è¯†ä¸ºç¬¬ä¸€ä¸ªActorçš„å­å…ƒç´ ã€‚</p>
  </li>
  <li>
    <p>actorå¼•ç”¨çš„æœ€åä¸€éƒ¨åˆ†#1053618476æˆ–#-1544706041æ˜¯ä¸€ä¸ªåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å¯ä»¥å¿½ç•¥çš„æƒŸä¸€æ ‡è¯†ç¬¦ã€‚</p>
  </li>
</ul>

<p>ç°åœ¨æ‚¨å·²ç»äº†è§£äº†actorå±‚æ¬¡ç»“æ„çš„æ ·å­ï¼Œæ‚¨å¯èƒ½æƒ³çŸ¥é“:ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦è¿™ä¸ªå±‚æ¬¡ç»“æ„?å®ƒæ˜¯ç”¨æ¥åšä»€ä¹ˆçš„?</p>

<p>å±‚æ¬¡ç»“æ„çš„ä¸€ä¸ªé‡è¦è§’è‰²æ˜¯å®‰å…¨åœ°ç®¡ç†Actorçš„ç”Ÿå‘½å‘¨æœŸã€‚æ¥ä¸‹æ¥è®©æˆ‘ä»¬è€ƒè™‘è¿™ä¸ªé—®é¢˜ï¼Œçœ‹çœ‹è¿™äº›çŸ¥è¯†å¦‚ä½•å¸®åŠ©æˆ‘ä»¬ç¼–å†™æ›´å¥½çš„ä»£ç ã€‚</p>

<h3 id="414-actor-ç”Ÿå‘½å‘¨æœŸ">4.1.4. Actor ç”Ÿå‘½å‘¨æœŸ</h3>

<p>Actoråœ¨åˆ›å»ºæ—¶å‡ºç°ï¼Œç„¶ååœ¨ç”¨æˆ·è¯·æ±‚æ—¶åœæ­¢ã€‚å½“ä¸€ä¸ªActorè¢«åœæ­¢æ—¶ï¼Œå®ƒçš„æ‰€æœ‰å­Actorä¹Ÿä¼šè¢«é€’å½’åœ°åœæ­¢ã€‚æ­¤è¡Œä¸ºæå¤§åœ°ç®€åŒ–äº†èµ„æºæ¸…ç†å·¥ä½œï¼Œå¹¶æœ‰åŠ©äºé¿å…èµ„æºæ³„æ¼ï¼Œæ¯”å¦‚ç”±äºæ‰“å¼€å¥—æ¥å­—å’Œæ–‡ä»¶è€Œå¯¼è‡´çš„æ³„æ¼ã€‚äº‹å®ä¸Šï¼Œåœ¨å¤„ç†ä½çº§å¤šçº¿ç¨‹ä»£ç æ—¶ï¼Œä¸€ä¸ªç»å¸¸è¢«å¿½è§†çš„å›°éš¾æ˜¯å„ç§å¹¶å‘èµ„æºçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚</p>

<p>ä¸ºäº†åœæ­¢ä¸€ä¸ªActorï¼Œæ¨èçš„æ¨¡å¼æ˜¯åœ¨actorå†…éƒ¨è¿”å›Behaviors.stopped()æ¥åœæ­¢å®ƒè‡ªå·±ï¼Œé€šå¸¸ä½œä¸ºå¯¹ä¸€äº›ç”¨æˆ·å®šä¹‰çš„åœæ­¢æ¶ˆæ¯çš„å“åº”ï¼Œæˆ–è€…å½“actorå®Œæˆå®ƒçš„å·¥ä½œæ—¶ã€‚ä»çˆ¶èŠ‚ç‚¹è°ƒç”¨context.stop(childRef)æ¥åœæ­¢å­èŠ‚ç‚¹ä»æŠ€æœ¯ä¸Šè®²æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯ä¸å¯èƒ½é€šè¿‡è¿™ç§æ–¹å¼åœæ­¢ä»»æ„çš„(éå­èŠ‚ç‚¹)èŠ‚ç‚¹ã€‚</p>

<p>Akka actor APIå…¬å¼€äº†ä¸€äº›ç”Ÿå‘½å‘¨æœŸä¿¡å·ï¼Œä¾‹å¦‚PostStopæ˜¯åœ¨actoråœæ­¢ä¹‹åå‘é€çš„ã€‚åœ¨æ­¤ä¹‹åä¸å¤„ç†ä»»ä½•æ¶ˆæ¯ã€‚</p>

<p>è®©æˆ‘ä»¬åœ¨ä¸€ä¸ªç®€å•çš„å®éªŒä¸­ä½¿ç”¨PostStopç”Ÿå‘½å‘¨æœŸä¿¡å·æ¥è§‚å¯Ÿåœæ­¢Actoræ—¶çš„è¡Œä¸ºã€‚é¦–å…ˆï¼Œåœ¨æ‚¨çš„é¡¹ç›®ä¸­æ·»åŠ ä»¥ä¸‹2ä¸ªactorç±»:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">StartStopActor1</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">StartStopActor1:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nf">StartStopActor1</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"first started"</span><span class="o">);</span>

    <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">StartStopActor2</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"second"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessageEquals</span><span class="o">(</span><span class="s">"stop"</span><span class="o">,</span> <span class="nl">Behaviors:</span><span class="o">:</span><span class="n">stopped</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onSignal</span><span class="o">(</span><span class="nc">PostStop</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">signal</span> <span class="o">-&gt;</span> <span class="n">onPostStop</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">onPostStop</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"first stopped"</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">StartStopActor2</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">StartStopActor2:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nf">StartStopActor2</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"second started"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onSignal</span><span class="o">(</span><span class="nc">PostStop</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">signal</span> <span class="o">-&gt;</span> <span class="n">onPostStop</span><span class="o">()).</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">onPostStop</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"second stopped"</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åˆ›å»ºä¸€ä¸ªåƒä¸Šé¢é‚£æ ·çš„â€œmainâ€ç±»å¯åŠ¨actorï¼Œç„¶åå‘é€ä¸€ä¸ªâ€œstopâ€æ¶ˆæ¯:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">first</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">StartStopActor1</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"first"</span><span class="o">);</span>
<span class="n">first</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="s">"stop"</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>first started
second started
second stopped
first stopped
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn.jsdelivr.net/gh/v4liulv/PicPed/img/20200803002422.png" alt="20200803002422" /></p>

<p>å½“æˆ‘ä»¬å…ˆåœæ­¢actoræ—¶ï¼Œå®ƒä¼šå…ˆåœæ­¢å®ƒçš„child actorï¼Œç„¶åå†åœæ­¢å®ƒè‡ªå·±ã€‚è¿™ç§é¡ºåºæ˜¯ä¸¥æ ¼çš„ï¼Œå­èŠ‚ç‚¹çš„æ‰€æœ‰ååœæ­¢ä¿¡å·éƒ½åœ¨çˆ¶èŠ‚ç‚¹çš„ååœæ­¢ä¿¡å·å¤„ç†ä¹‹å‰å¤„ç†ã€‚</p>

<h3 id="415-actor-æ•…éšœå¤„ç†">4.1.5. Actor æ•…éšœå¤„ç†</h3>

<p>çˆ¶Actorå’Œå­Actoråœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­éƒ½æ˜¯ç›¸äº’è”ç³»çš„ã€‚æ¯å½“ä¸€ä¸ªActorå¤±è´¥æ—¶(æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸æˆ–ä¸€ä¸ªæœªå¤„ç†çš„å¼‚å¸¸ä»æ¥æ”¶ä¸­å†’å‡º)ï¼Œå¤±è´¥ä¿¡æ¯å°±ä¼šä¼ æ’­åˆ°ç›‘ç£ç­–ç•¥ï¼Œç„¶åç”±å…¶å†³å®šå¦‚ä½•å¤„ç†ç”±Actorå¼•èµ·çš„å¼‚å¸¸ã€‚ç›‘æ§ç­–ç•¥é€šå¸¸ç”±çˆ¶actoråœ¨ç”Ÿæˆå­actoræ—¶å®šä¹‰ã€‚è¿™æ ·ï¼Œçˆ¶æ¯å°±æˆäº†å­©å­çš„ç›‘ç£è€…ã€‚é»˜è®¤çš„ç®¡ç†ç­–ç•¥æ˜¯é˜»æ­¢å­©å­ã€‚å¦‚æœä½ ä¸å®šä¹‰ç­–ç•¥ï¼Œæ‰€æœ‰çš„å¤±è´¥éƒ½ä¼šå¯¼è‡´åœæ­¢ã€‚</p>

<p>è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„å®éªŒæ¥è§‚å¯Ÿé‡å¯ç›‘ç®¡ç­–ç•¥ã€‚æ·»åŠ ä»¥ä¸‹ç±»åˆ°ä½ çš„é¡¹ç›®ï¼Œå°±åƒä½ åšçš„å‰é¢çš„:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">SupervisingActor</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">SupervisingActor:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">child</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nf">SupervisingActor</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="n">child</span> <span class="o">=</span>
        <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span>
            <span class="nc">Behaviors</span><span class="o">.</span><span class="na">supervise</span><span class="o">(</span><span class="nc">SupervisedActor</span><span class="o">.</span><span class="na">create</span><span class="o">()).</span><span class="na">onFailure</span><span class="o">(</span><span class="nc">SupervisorStrategy</span><span class="o">.</span><span class="na">restart</span><span class="o">()),</span>
            <span class="s">"supervised-actor"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onMessageEquals</span><span class="o">(</span><span class="s">"failChild"</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onFailChild</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">onFailChild</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">child</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="s">"fail"</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">SupervisedActor</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">SupervisedActor:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nf">SupervisedActor</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"supervised actor started"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessageEquals</span><span class="o">(</span><span class="s">"fail"</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">fail</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onSignal</span><span class="o">(</span><span class="nc">PreRestart</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">signal</span> <span class="o">-&gt;</span> <span class="n">preRestart</span><span class="o">())</span>
        <span class="o">.</span><span class="na">onSignal</span><span class="o">(</span><span class="nc">PostStop</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">signal</span> <span class="o">-&gt;</span> <span class="n">postStop</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">fail</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"supervised actor fails now"</span><span class="o">);</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"I failed!"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">preRestart</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"second will be restarted"</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">postStop</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"second stopped"</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¹¶è¿è¡Œï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">supervisingActor</span> <span class="o">=</span>
    <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">SupervisingActor</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"supervising-actor"</span><span class="o">);</span>
<span class="n">supervisingActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="s">"failChild"</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ‚¨åº”è¯¥ä¼šçœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹çš„è¾“å‡º:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre>First: Actor[akka://ActorSystem/user/supervising-actor#637280321]
supervised actor started
supervised actor fails now
second will be restarted
[2020-08-03 00:29:08,938] [ERROR] [akka.actor.typed.Behavior$] [ActorSystem-akka.actor.default-dispatcher-3] [akka://ActorSystem/user/supervising-actor/supervised-actor] - Supervisor RestartSupervisor saw failure: I failed!
java.lang.RuntimeException: I failed!
	at com.tcfuture.akka.actor.architecture.SupervisedActor.fail(FailureHandling.java:103)
	at akka.actor.typed.javadsl.ReceiveBuilder$$anon$2.apply(ReceiveBuilder.scala:88)
	at akka.actor.typed.javadsl.ReceiveBuilder$$anon$2.apply(ReceiveBuilder.scala:86)
	at akka.actor.typed.javadsl.BuiltReceive.receive(ReceiveBuilder.scala:213)
	at akka.actor.typed.javadsl.BuiltReceive.receiveMessage(ReceiveBuilder.scala:204)
	at akka.actor.typed.javadsl.Receive.receive(Receive.scala:53)
	at akka.actor.typed.javadsl.AbstractBehavior.receive(AbstractBehavior.scala:64)
	at akka.actor.typed.Behavior$.interpret(Behavior.scala:274)
	at akka.actor.typed.Behavior$.interpretMessage(Behavior.scala:230)
	at akka.actor.typed.internal.InterceptorImpl$$anon$2.apply(InterceptorImpl.scala:57)
	at akka.actor.typed.internal.RestartSupervisor.aroundReceive(Supervision.scala:263)
	at akka.actor.typed.internal.InterceptorImpl.receive(InterceptorImpl.scala:85)
	at akka.actor.typed.Behavior$.interpret(Behavior.scala:274)
	at akka.actor.typed.Behavior$.interpretMessage(Behavior.scala:230)
	at akka.actor.typed.internal.adapter.ActorAdapter.handleMessage(ActorAdapter.scala:129)
	at akka.actor.typed.internal.adapter.ActorAdapter.aroundReceive(ActorAdapter.scala:106)
	at akka.actor.ActorCell.receiveMessage(ActorCell.scala:577)
	at akka.actor.ActorCell.invoke(ActorCell.scala:547)
	at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:270)
	at akka.dispatch.Mailbox.run(Mailbox.scala:231)
	at akka.dispatch.Mailbox.exec(Mailbox.scala:243)
	at java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:289)
	at java.util.concurrent.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1056)
	at java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1692)
	at java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:157)
supervised actor started
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨å¤±è´¥åï¼Œè¢«ç›‘ç£çš„Actorè¢«åœæ­¢å¹¶ç«‹å³é‡æ–°å¯åŠ¨ã€‚æˆ‘ä»¬è¿˜ä¼šçœ‹åˆ°ä¸€ä¸ªæ—¥å¿—æ¡ç›®æŠ¥å‘Šæ‰€å¤„ç†çš„å¼‚å¸¸ï¼Œåœ¨æœ¬ä¾‹ä¸­æ˜¯æˆ‘ä»¬çš„æµ‹è¯•å¼‚å¸¸ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬è¿˜ä½¿ç”¨äº†PreRestartä¿¡å·ï¼Œè¯¥ä¿¡å·åœ¨é‡å¯ä¹‹å‰è¢«å¤„ç†ã€‚</p>

<h2 id="42-ä»‹ç»-actors">4.2. ä»‹ç» Actors</h2>

<h3 id="421-akka-actors">4.2.1. Akka Actors</h3>

<p>Actor<a href="https://en.wikipedia.org/wiki/Actor_model">æ¨¡å‹</a>ä¸ºç¼–å†™å¹¶å‘å’Œåˆ†å¸ƒå¼ç³»ç»Ÿæä¾›äº†æ›´é«˜å±‚æ¬¡çš„æŠ½è±¡ã€‚å®ƒå‡è½»äº†å¼€å‘äººå‘˜å¿…é¡»å¤„ç†æ˜¾å¼é”å’Œçº¿ç¨‹ç®¡ç†çš„è´Ÿæ‹…ï¼Œä½¿ç¼–å†™æ­£ç¡®çš„å¹¶å‘å’Œå¹¶è¡Œç³»ç»Ÿå˜å¾—æ›´åŠ å®¹æ˜“ã€‚actoræ˜¯Carl Hewittåœ¨1973å¹´çš„è®ºæ–‡ä¸­å®šä¹‰çš„ï¼Œä½†ç”±äºErlangè¯­è¨€çš„ä½¿ç”¨è€Œå¾—åˆ°æ¨å¹¿ï¼Œä¾‹å¦‚åœ¨Ericssonä¸­å°±æˆåŠŸåœ°ç”¨äºæ„å»ºé«˜åº¦å¹¶å‘å’Œå¯é çš„ç”µä¿¡ç³»ç»Ÿã€‚Akkaçš„actorçš„APIå€Ÿç”¨äº†Erlangçš„ä¸€äº›è¯­æ³•ã€‚</p>

<h3 id="422-ç¬¬ä¸€ä¸ªç¤ºä¾‹">4.2.2. ç¬¬ä¸€ä¸ªç¤ºä¾‹</h3>

<p>åœ¨å…¥é—¨ç¤ºä¾‹ä¸­<a href="#22-HelloWordAkka">HelloWordAkka</a>å·²ç»å­˜åœ¨å®Œæ•´çš„ç¤ºä¾‹ã€‚</p>

<p>å¦‚æœä½ æ˜¯Akkaçš„æ–°æˆå‘˜ï¼Œä½ å¯èƒ½æƒ³ä»<a href="https://doc.akka.io/docs/akka/current/typed/guide/introduction.html">å…¥é—¨æŒ‡å—</a>å¼€å§‹ï¼Œç„¶åå›æ¥è¿™é‡Œå­¦ä¹ æ›´å¤šã€‚æˆ‘ä»¬ä¹Ÿæ¨èè§‚çœ‹<a href="https://akka.io/blog/news/2019/12/03/akka-typed-actor-intro-video?_ga=2.110322695.388717210.1596435693-1352056857.1596435693">Akkaçš„ç®€çŸ­ä»‹ç»è§†é¢‘</a>ã€‚</p>

<p>ç†Ÿæ‚‰Actorçš„åŸºæœ¬çš„ã€å¤–éƒ¨çš„å’Œå†…éƒ¨çš„ç”Ÿæ€ç³»ç»Ÿæ˜¯å¾ˆæœ‰å¸®åŠ©çš„ï¼Œçœ‹çœ‹æ‚¨å¯ä»¥æ ¹æ®éœ€è¦åˆ©ç”¨å’Œå®šåˆ¶ä»€ä¹ˆï¼ŒæŸ¥çœ‹ <a href="#32-Actorç³»ç»Ÿ">Actor System</a>å’Œ <a href="#35-Actorå¼•ç”¨ã€è·¯å¾„å’Œåœ°å€">Actorå¼•ç”¨ã€è·¯å¾„å’Œåœ°å€</a>ã€‚</p>

<p>æ­£å¦‚åœ¨<a href="#32-Actorç³»ç»Ÿ">Actor Systems</a> ä¸­æ‰€è®¨è®ºçš„ï¼ŒActoræ˜¯å…³äºåœ¨ç‹¬ç«‹çš„è®¡ç®—å•å…ƒä¹‹é—´å‘é€æ¶ˆæ¯çš„ï¼Œä½†æ˜¯è¿™çœ‹èµ·æ¥åƒä»€ä¹ˆå‘¢?</p>

<p>åœ¨ä»¥ä¸‹æ‰€æœ‰è¿™äº›å¯¼å…¥éƒ½æ˜¯å‡è®¾çš„:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">akka.actor.typed.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorSystem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.Behavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.AbstractBehavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.ActorContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Behaviors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Receive</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœ‰äº†è¿™äº›ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®šä¹‰ç¬¬ä¸€ä¸ªActorï¼Œå®ƒä¼šè¯´hello!</p>

<p><img src="https://liulv.work/images/img/20200805105658.png" alt="20200805105658" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorld</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">Greet</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Greet</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">whom</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Greeted</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Greet</span><span class="o">(</span><span class="nc">String</span> <span class="n">whom</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Greeted</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">whom</span> <span class="o">=</span> <span class="n">whom</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Greeted</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">whom</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Greet</span><span class="o">&gt;</span> <span class="n">from</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Greeted</span><span class="o">(</span><span class="nc">String</span> <span class="n">whom</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Greet</span><span class="o">&gt;</span> <span class="n">from</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">whom</span> <span class="o">=</span> <span class="n">whom</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">from</span> <span class="o">=</span> <span class="n">from</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Greet</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">HelloWorld:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nf">HelloWorld</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Greet</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Greet</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Greet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onGreet</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Greet</span><span class="o">&gt;</span> <span class="nf">onGreet</span><span class="o">(</span><span class="nc">Greet</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Hello {}!"</span><span class="o">,</span> <span class="n">command</span><span class="o">.</span><span class="na">whom</span><span class="o">);</span>
    <span class="n">command</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Greeted</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">whom</span><span class="o">,</span> <span class="n">getContext</span><span class="o">().</span><span class="na">getSelf</span><span class="o">()));</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™ä¸€å°æ®µä»£ç å®šä¹‰äº†ä¸¤ç§æ¶ˆæ¯ç±»å‹ï¼Œä¸€ç§ç”¨äºå‘½ä»¤Actorå‘æŸäººæ‰“æ‹›å‘¼ï¼Œå¦ä¸€ç§ç”¨äºActorç¡®è®¤å®ƒå·²ç»è¿™æ ·åšäº†ã€‚Greetç±»å‹ä¸ä»…åŒ…å«è¦æ‰“æ‹›å‘¼çš„å¯¹è±¡çš„ä¿¡æ¯ï¼Œå®ƒè¿˜åŒ…å«æ¶ˆæ¯å‘é€æ–¹æä¾›çš„ActorRefï¼Œä»¥ä¾¿HelloWorld Actorå¯ä»¥å‘é€å›ç¡®è®¤æ¶ˆæ¯ã€‚</p>

<p>åœ¨æ¥æ”¶è¡Œä¸ºå·¥å‚çš„å¸®åŠ©ä¸‹ï¼ŒActorçš„è¡Œä¸ºè¢«å®šä¹‰ä¸ºGreeter ã€‚å¤„ç†ä¸‹ä¸€æ¡æ¶ˆæ¯ä¼šå¯¼è‡´å¯èƒ½ä¸æ­¤æ¶ˆæ¯ä¸åŒçš„æ–°è¡Œä¸ºã€‚çŠ¶æ€é€šè¿‡è¿”å›ä¸€ä¸ªæŒæœ‰æ–°çš„ä¸å¯å˜çŠ¶æ€çš„æ–°è¡Œä¸ºæ¥æ›´æ–°ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ›´æ–°ä»»ä½•çŠ¶æ€ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿”å›thisï¼Œè¿™æ„å‘³ç€ä¸‹ä¸€ä¸ªè¡Œä¸ºâ€œä¸å½“å‰è¡Œä¸ºç›¸åŒâ€ã€‚</p>

<p>æ­¤è¡Œä¸ºå¤„ç†çš„æ¶ˆæ¯ç±»å‹è¢«å£°æ˜ä¸ºç±»Greetã€‚é€šå¸¸ï¼ŒActor å¤„ç†ä¸æ­¢ä¸€ç§ç‰¹å®šçš„æ¶ˆæ¯ç±»å‹ï¼Œå…¶ä¸­æ‰€æœ‰çš„æ¶ˆæ¯ç±»å‹éƒ½ç›´æ¥æˆ–é—´æ¥å®ç°ä¸€ä¸ªå…¬å…±æ¥å£ã€‚</p>

<p>åœ¨æœ€åä¸€è¡Œï¼Œæˆ‘ä»¬çœ‹åˆ°HelloWorld Actor å‘å¦ä¸€ä¸ª Actorå‘é€æ¶ˆæ¯ï¼Œè¿™æ˜¯ä½¿ç”¨tellæ–¹æ³•å®Œæˆçš„ã€‚å®ƒæ˜¯ä¸€ä¸ªä¸é˜»å¡è°ƒç”¨è€…çº¿ç¨‹çš„å¼‚æ­¥æ“ä½œã€‚</p>

<p>ç”±äº replyTo åœ°å€è¢«å£°æ˜ä¸º ActorRef<Greeted> ç±»å‹ï¼Œç¼–è¯‘å™¨å°†åªå…è®¸æˆ‘ä»¬å‘é€è¿™ç§ç±»å‹çš„æ¶ˆæ¯ï¼Œå…¶ä»–ç”¨æ³•å°†æ˜¯ç¼–è¯‘å™¨é”™è¯¯ã€‚</Greeted></p>

<p>Actor æ¥å—çš„æ¶ˆæ¯ç±»å‹ä¸æ‰€æœ‰åº”ç­”ç±»å‹ä¸€èµ·å®šä¹‰äº†è¯¥ Actor æ‰€è¯´çš„åè®®;åœ¨æœ¬ä¾‹ä¸­ï¼Œå®ƒæ˜¯ä¸€ä¸ªç®€å•çš„è¯·æ±‚-åº”ç­”åè®®ï¼Œä½† Actor å¯ä»¥åœ¨éœ€è¦æ—¶å»ºæ¨¡ä»»æ„å¤æ‚çš„åè®®ã€‚åè®®ä¸åœ¨ HelloWorld ç±»ä¸­å®ç°å®ƒçš„è¡Œä¸ºç»‘å®šåœ¨ä¸€èµ·ã€‚</p>

<p>æ­£å¦‚å¡å°”Â·ä¼‘ä¼Šç‰¹æ‰€è¯´ï¼Œä¸€ä¸ª Actors ä¸æ˜¯ Actors â€”â€”æ²¡æœ‰äººå¯ä»¥äº¤è°ˆä¼šå¾ˆå­¤ç‹¬ã€‚æˆ‘ä»¬éœ€è¦å¦ä¸€ä¸ªä¸ Greeter äº’åŠ¨çš„ Actors ã€‚è®©æˆ‘ä»¬åˆ¶ä½œä¸€ä¸ªHelloWorldBotæ¥æ¥æ”¶æ¥è‡ªGreeter çš„å›å¤ï¼Œå¹¶å‘é€ä¸€äº›é¢å¤–çš„é—®å€™æ¶ˆæ¯ï¼Œç„¶åæ”¶é›†è¿™äº›å›å¤ï¼Œç›´åˆ°è¾¾åˆ°ç»™å®šçš„æœ€å¤§æ•°é‡çš„æ¶ˆæ¯ä¸ºæ­¢ã€‚</p>

<p><img src="https://liulv.work/images/img/20200805111011.png" alt="20200805111011" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldBot</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">Greeted</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">Greeted</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span><span class="kt">int</span> <span class="n">max</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="n">context</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">HelloWorldBot</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">max</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">max</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">greetingCounter</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nf">HelloWorldBot</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">Greeted</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span> <span class="kt">int</span> <span class="n">max</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">max</span> <span class="o">=</span> <span class="n">max</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">Greeted</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">Greeted</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onGreeted</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">Greeted</span><span class="o">&gt;</span> <span class="nf">onGreeted</span><span class="o">(</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">Greeted</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">greetingCounter</span><span class="o">++;</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Greeting {} for {}"</span><span class="o">,</span> <span class="n">greetingCounter</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">whom</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">greetingCounter</span> <span class="o">==</span> <span class="n">max</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">stopped</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">message</span><span class="o">.</span><span class="na">from</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">HelloWorld</span><span class="o">.</span><span class="na">Greet</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">whom</span><span class="o">,</span> <span class="n">getContext</span><span class="o">().</span><span class="na">getSelf</span><span class="o">()));</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¯·æ³¨æ„è¯¥ Actor æ˜¯å¦‚ä½•ä½¿ç”¨å®ä¾‹å˜é‡ç®¡ç†è®¡æ•°å™¨çš„ã€‚ç”±äºactorå®ä¾‹ä¸€æ¬¡åªå¤„ç†ä¸€æ¡æ¶ˆæ¯ï¼Œå› æ­¤ä¸éœ€è¦åƒsynchronizedæˆ–AtomicIntegerè¿™æ ·çš„å¹¶å‘ä¿æŠ¤ã€‚</p>

<p>ç¬¬ä¸‰ä¸ªActorsç”Ÿæˆäº†Greeterå’ŒHelloWorldBotï¼Œå¹¶å¼€å§‹å®ƒä»¬ä¹‹é—´çš„äº¤äº’ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldMain</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">HelloWorldMain</span><span class="o">.</span><span class="na">SayHello</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SayHello</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SayHello</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">SayHello</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">HelloWorldMain:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">Greet</span><span class="o">&gt;</span> <span class="n">greeter</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nf">HelloWorldMain</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">SayHello</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="n">greeter</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"greeter"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">SayHello</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">SayHello</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onStart</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">SayHello</span><span class="o">&gt;</span> <span class="nf">onStart</span><span class="o">(</span><span class="nc">SayHello</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">Greeted</span><span class="o">&gt;</span> <span class="n">replyTo</span> <span class="o">=</span>
        <span class="n">getContext</span><span class="o">().</span><span class="na">spawn</span><span class="o">(</span><span class="nc">HelloWorldBot</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span> <span class="n">command</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
    <span class="n">greeter</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">HelloWorld</span><span class="o">.</span><span class="na">Greet</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">));</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç°åœ¨æˆ‘ä»¬æƒ³è¦å°è¯•è¿™ä¸ª Actorï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»å¯åŠ¨ä¸€ä¸ª ActorSystem æ¥æ‰˜ç®¡å®ƒ:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">final</span> <span class="nc">ActorSystem</span><span class="o">&lt;</span><span class="nc">HelloWorldMain</span><span class="o">.</span><span class="na">SayHello</span><span class="o">&gt;</span> <span class="n">system</span> <span class="o">=</span>
    <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">HelloWorldMain</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"hello"</span><span class="o">);</span>

<span class="n">system</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">HelloWorldMain</span><span class="o">.</span><span class="na">SayHello</span><span class="o">(</span><span class="s">"World"</span><span class="o">));</span>
<span class="n">system</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">HelloWorldMain</span><span class="o">.</span><span class="na">SayHello</span><span class="o">(</span><span class="s">"Akka"</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æˆ‘ä»¬ä»å®šä¹‰çš„HelloWorldMainè¡Œä¸ºå¯åŠ¨ä¸€ä¸ªActorSystemï¼Œå¹¶å‘é€ä¸¤ä¸ªSayHelloæ¶ˆæ¯ï¼Œè¿™å°†å¯åŠ¨ä¸¤ä¸ªå•ç‹¬çš„HelloWorldBot Actorå’Œå•ä¸ªGreeter Actorä¹‹é—´çš„äº¤äº’ã€‚</p>

<p>åº”ç”¨ç¨‹åºé€šå¸¸ç”±å•ä¸ªActorSystemç»„æˆï¼Œæ¯ä¸ªJVMè¿è¡Œå¤šä¸ªActorã€‚</p>

<p>æ§åˆ¶å°è¾“å‡ºå¯èƒ½æ˜¯è¿™æ ·çš„:</p>

<pre><code class="language-log">[2020-08-05 11:40:43,073] [INFO] [akka.event.slf4j.Slf4jLogger] [hello-akka.actor.default-dispatcher-3] [] - Slf4jLogger started
[2020-08-05 11:40:43,219] [INFO] [com.tcfuture.akka.actor.helloword.nw.HelloWorld] [hello-akka.actor.default-dispatcher-5] [akka://hello/user/greeter] - Hello World!
[2020-08-05 11:40:43,221] [INFO] [com.tcfuture.akka.actor.helloword.nw.HelloWorld] [hello-akka.actor.default-dispatcher-5] [akka://hello/user/greeter] - Hello Akka!
[2020-08-05 11:40:43,222] [INFO] [com.tcfuture.akka.actor.helloword.nw.HelloWorldBot] [hello-akka.actor.default-dispatcher-6] [akka://hello/user/World] - Greeting 1 for World
[2020-08-05 11:40:43,222] [INFO] [com.tcfuture.akka.actor.helloword.nw.HelloWorldBot] [hello-akka.actor.default-dispatcher-3] [akka://hello/user/Akka] - Greeting 1 for Akka
[2020-08-05 11:40:43,222] [INFO] [com.tcfuture.akka.actor.helloword.nw.HelloWorld] [hello-akka.actor.default-dispatcher-5] [akka://hello/user/greeter] - Hello World!
[2020-08-05 11:40:43,222] [INFO] [com.tcfuture.akka.actor.helloword.nw.HelloWorld] [hello-akka.actor.default-dispatcher-5] [akka://hello/user/greeter] - Hello Akka!
[2020-08-05 11:40:43,222] [INFO] [com.tcfuture.akka.actor.helloword.nw.HelloWorldBot] [hello-akka.actor.default-dispatcher-6] [akka://hello/user/World] - Greeting 2 for World
[2020-08-05 11:40:43,222] [INFO] [com.tcfuture.akka.actor.helloword.nw.HelloWorld] [hello-akka.actor.default-dispatcher-5] [akka://hello/user/greeter] - Hello World!
[2020-08-05 11:40:43,222] [INFO] [com.tcfuture.akka.actor.helloword.nw.HelloWorldBot] [hello-akka.actor.default-dispatcher-3] [akka://hello/user/Akka] - Greeting 2 for Akka
[2020-08-05 11:40:43,222] [INFO] [com.tcfuture.akka.actor.helloword.nw.HelloWorldBot] [hello-akka.actor.default-dispatcher-6] [akka://hello/user/World] - Greeting 3 for World
[2020-08-05 11:40:43,222] [INFO] [com.tcfuture.akka.actor.helloword.nw.HelloWorld] [hello-akka.actor.default-dispatcher-5] [akka://hello/user/greeter] - Hello Akka!
[2020-08-05 11:40:43,223] [INFO] [com.tcfuture.akka.actor.helloword.nw.HelloWorldBot] [hello-akka.actor.default-dispatcher-3] [akka://hello/user/Akka] - Greeting 3 for Akka
</code></pre>

<p>æ‚¨è¿˜éœ€è¦æ·»åŠ <a href="https://doc.akka.io/docs/akka/current/typed/logging.html">æ—¥å¿—ä¾èµ–</a>é¡¹ï¼Œä»¥ä¾¿åœ¨è¿è¡Œæ—¶æŸ¥çœ‹è¾“å‡ºã€‚</p>

<h3 id="423-å¤æ‚çš„ä¾‹å­">4.2.3. å¤æ‚çš„ä¾‹å­</h3>

<p>æœ¬ä¾‹å­æ›´ç°å®ï¼Œæ¼”ç¤ºäº†ä¸€äº›é‡è¦çš„æ¨¡å¼:</p>

<ul>
  <li>ä½¿ç”¨æ¥å£å’Œå®ç°è¯¥æ¥å£çš„ç±»æ¥è¡¨ç¤º Acotor å¯ä»¥æ¥æ”¶çš„å¤šä¸ªæ¶ˆæ¯</li>
  <li>é€šè¿‡ä½¿ç”¨å­ actors å¤„ç†ä¼šè¯</li>
  <li>é€šè¿‡æ”¹å˜è¡Œä¸ºæ¥å¤„ç†çŠ¶æ€</li>
  <li>ä½¿ç”¨å¤šä¸ª actors ä»¥ç±»å‹å®‰å…¨çš„æ–¹å¼è¡¨ç¤ºåè®®çš„ä¸åŒéƒ¨åˆ†</li>
</ul>

<p><img src="https://liulv.work/images/img/20200805114627.png" alt="20200805114627" /></p>

<h4 id="4231-åŠŸèƒ½ä»‹ç»">4.2.3.1. åŠŸèƒ½ä»‹ç»</h4>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†ä»¥å‡½æ•°æ ·å¼æ˜¾ç¤ºæ­¤ç¤ºä¾‹ï¼Œç„¶åä»¥<a href="https://doc.akka.io/docs/akka/current/typed/actors.html#object-oriented-style">é¢å‘å¯¹è±¡æ ·å¼</a>æ˜¾ç¤ºç›¸åŒçš„ç¤ºä¾‹ã€‚é€‰æ‹©ä½¿ç”¨å“ªç§é£æ ¼æ˜¯ä¸€ä¸ªå“å‘³é—®é¢˜ï¼Œä¸¤ç§é£æ ¼éƒ½å¯ä»¥æ··åˆä½¿ç”¨ï¼Œè¿™å–å†³äºå“ªç§é£æ ¼å¯¹ç‰¹å®šçš„Actoræ¥è¯´æ˜¯æœ€å¥½çš„ã€‚åœ¨<a href="https://doc.akka.io/docs/akka/current/typed/style-guide.html#functional-versus-object-oriented-style">æ ·å¼æŒ‡å—</a>ä¸­æä¾›äº†é€‰æ‹©çš„æ³¨æ„äº‹é¡¹ã€‚</p>

<p>è€ƒè™‘ä¸€ä¸ªè¿è¡ŒèŠå¤©å®¤çš„ Actor:å®¢æˆ·ç«¯ Actorå¯ä»¥é€šè¿‡å‘é€ä¸€æ¡åŒ…å«ä»–ä»¬çš„å±å¹•åçš„æ¶ˆæ¯æ¥è¿æ¥ï¼Œç„¶åä»–ä»¬å¯ä»¥å‘å¸ƒæ¶ˆæ¯ã€‚èŠå¤©å®¤ Actorå°†æŠŠæ‰€æœ‰å‘å¸ƒçš„æ¶ˆæ¯å‘é€ç»™æ‰€æœ‰å½“å‰è¿æ¥çš„å®¢æˆ·ç«¯ Actorã€‚åè®®å®šä¹‰å¯ä»¥å¦‚ä¸‹æ‰€ç¤º:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="rouge-code"><pre><span class="kd">static</span> <span class="kd">interface</span> <span class="nc">RoomCommand</span> <span class="o">{}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">GetSession</span> <span class="kd">implements</span> <span class="nc">RoomCommand</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">screenName</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">SessionEvent</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">GetSession</span><span class="o">(</span><span class="nc">String</span> <span class="n">screenName</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">SessionEvent</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">screenName</span> <span class="o">=</span> <span class="n">screenName</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">interface</span> <span class="nc">SessionEvent</span> <span class="o">{}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">SessionGranted</span> <span class="kd">implements</span> <span class="nc">SessionEvent</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">PostMessage</span><span class="o">&gt;</span> <span class="n">handle</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">SessionGranted</span><span class="o">(</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">PostMessage</span><span class="o">&gt;</span> <span class="n">handle</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">SessionDenied</span> <span class="kd">implements</span> <span class="nc">SessionEvent</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">reason</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">SessionDenied</span><span class="o">(</span><span class="nc">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">reason</span> <span class="o">=</span> <span class="n">reason</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MessagePosted</span> <span class="kd">implements</span> <span class="nc">SessionEvent</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">screenName</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">message</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">MessagePosted</span><span class="o">(</span><span class="nc">String</span> <span class="n">screenName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">screenName</span> <span class="o">=</span> <span class="n">screenName</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">interface</span> <span class="nc">SessionCommand</span> <span class="o">{}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">PostMessage</span> <span class="kd">implements</span> <span class="nc">SessionCommand</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">message</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">PostMessage</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">NotifyClient</span> <span class="kd">implements</span> <span class="nc">SessionCommand</span> <span class="o">{</span>
  <span class="kd">final</span> <span class="nc">MessagePosted</span> <span class="n">message</span><span class="o">;</span>

  <span class="nc">NotifyClient</span><span class="o">(</span><span class="nc">MessagePosted</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœ€åˆï¼Œå®¢æˆ·ç«¯ Actor åªèƒ½è®¿é—®å…è®¸ä»–ä»¬è¿›è¡Œç¬¬ä¸€æ­¥çš„ ActorRef<GetSession>ã€‚ä¸€æ—¦å»ºç«‹äº†å®¢æˆ·ç«¯çš„ä¼šè¯ï¼Œå®ƒå°±ä¼šå¾—åˆ°ä¸€ä¸ªåŒ…å«å¥æŸ„çš„SessionGrantedæ¶ˆæ¯ï¼Œè¯¥å¥æŸ„ç”¨äºè§£é”ä¸‹ä¸€ä¸ªåè®®æ­¥éª¤ï¼Œå³å‘å¸ƒæ¶ˆæ¯ã€‚éœ€è¦å°†PostMessageå‘½ä»¤å‘é€åˆ°è¿™ä¸ªè¡¨ç¤ºå·²æ·»åŠ åˆ°èŠå¤©å®¤çš„ä¼šè¯çš„ç‰¹å®šåœ°å€ã€‚ä¼šè¯çš„å¦ä¸€ä¸ªæ–¹é¢æ˜¯å®¢æˆ·ç«¯é€šè¿‡replyToå‚æ•°æ˜¾ç¤ºäº†å®ƒè‡ªå·±çš„åœ°å€ï¼Œä»¥ä¾¿åç»­çš„messagepostäº‹ä»¶å¯ä»¥å‘é€ç»™å®ƒã€‚</GetSession></p>

<p>è¿™è¯´æ˜äº†actorå¦‚ä½•è¡¨è¾¾Javaå¯¹è±¡ä¸Šçš„æ–¹æ³•è°ƒç”¨ä»¥å¤–çš„å†…å®¹ã€‚å£°æ˜çš„æ¶ˆæ¯ç±»å‹åŠå…¶å†…å®¹æè¿°äº†ä¸€ä¸ªå®Œæ•´çš„åè®®ï¼Œè¯¥åè®®å¯ä»¥æ¶‰åŠå¤šä¸ªActorï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡å¤šä¸ªæ­¥éª¤è¿›è¡Œæ¼”åŒ–ã€‚ä¸‹é¢æ˜¯èŠå¤©å®¤åè®®çš„å®ç°:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChatRoom</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">PublishSessionMessage</span> <span class="kd">implements</span> <span class="nc">RoomCommand</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">screenName</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">message</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">PublishSessionMessage</span><span class="o">(</span><span class="nc">String</span> <span class="n">screenName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">screenName</span> <span class="o">=</span> <span class="n">screenName</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">RoomCommand</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span>
        <span class="n">ctx</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">ChatRoom</span><span class="o">(</span><span class="n">ctx</span><span class="o">).</span><span class="na">chatRoom</span><span class="o">(</span><span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">SessionCommand</span><span class="o">&gt;&gt;()));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">RoomCommand</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nf">ChatRoom</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">RoomCommand</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">RoomCommand</span><span class="o">&gt;</span> <span class="nf">chatRoom</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">SessionCommand</span><span class="o">&gt;&gt;</span> <span class="n">sessions</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="nc">RoomCommand</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">GetSession</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">getSession</span> <span class="o">-&gt;</span> <span class="n">onGetSession</span><span class="o">(</span><span class="n">sessions</span><span class="o">,</span> <span class="n">getSession</span><span class="o">))</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">PublishSessionMessage</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">pub</span> <span class="o">-&gt;</span> <span class="n">onPublishSessionMessage</span><span class="o">(</span><span class="n">sessions</span><span class="o">,</span> <span class="n">pub</span><span class="o">))</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">RoomCommand</span><span class="o">&gt;</span> <span class="nf">onGetSession</span><span class="o">(</span>
      <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">SessionCommand</span><span class="o">&gt;&gt;</span> <span class="n">sessions</span><span class="o">,</span> <span class="nc">GetSession</span> <span class="n">getSession</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">UnsupportedEncodingException</span> <span class="o">{</span>
    <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">SessionEvent</span><span class="o">&gt;</span> <span class="n">client</span> <span class="o">=</span> <span class="n">getSession</span><span class="o">.</span><span class="na">replyTo</span><span class="o">;</span>
    <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">SessionCommand</span><span class="o">&gt;</span> <span class="n">ses</span> <span class="o">=</span>
        <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span>
            <span class="nc">Session</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getSelf</span><span class="o">(),</span> <span class="n">getSession</span><span class="o">.</span><span class="na">screenName</span><span class="o">,</span> <span class="n">client</span><span class="o">),</span>
            <span class="nc">URLEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">getSession</span><span class="o">.</span><span class="na">screenName</span><span class="o">,</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">.</span><span class="na">name</span><span class="o">()));</span>
    <span class="c1">// narrow to only expose PostMessage</span>
    <span class="n">client</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">SessionGranted</span><span class="o">(</span><span class="n">ses</span><span class="o">.</span><span class="na">narrow</span><span class="o">()));</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">SessionCommand</span><span class="o">&gt;&gt;</span> <span class="n">newSessions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">sessions</span><span class="o">);</span>
    <span class="n">newSessions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ses</span><span class="o">);</span>
    <span class="k">return</span> <span class="nf">chatRoom</span><span class="o">(</span><span class="n">newSessions</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">RoomCommand</span><span class="o">&gt;</span> <span class="nf">onPublishSessionMessage</span><span class="o">(</span>
      <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">SessionCommand</span><span class="o">&gt;&gt;</span> <span class="n">sessions</span><span class="o">,</span> <span class="nc">PublishSessionMessage</span> <span class="n">pub</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">NotifyClient</span> <span class="n">notification</span> <span class="o">=</span>
        <span class="k">new</span> <span class="nf">NotifyClient</span><span class="o">((</span><span class="k">new</span> <span class="nc">MessagePosted</span><span class="o">(</span><span class="n">pub</span><span class="o">.</span><span class="na">screenName</span><span class="o">,</span> <span class="n">pub</span><span class="o">.</span><span class="na">message</span><span class="o">)));</span>
    <span class="n">sessions</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">notification</span><span class="o">));</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Session</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionCommand</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span>
        <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">RoomCommand</span><span class="o">&gt;</span> <span class="n">room</span><span class="o">,</span> <span class="nc">String</span> <span class="n">screenName</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">SessionEvent</span><span class="o">&gt;</span> <span class="n">client</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionCommand</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
          <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">PostMessage</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">post</span> <span class="o">-&gt;</span> <span class="n">onPostMessage</span><span class="o">(</span><span class="n">room</span><span class="o">,</span> <span class="n">screenName</span><span class="o">,</span> <span class="n">post</span><span class="o">))</span>
          <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">NotifyClient</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">notification</span> <span class="o">-&gt;</span> <span class="n">onNotifyClient</span><span class="o">(</span><span class="n">client</span><span class="o">,</span> <span class="n">notification</span><span class="o">))</span>
          <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">SessionCommand</span><span class="o">&gt;</span> <span class="nf">onPostMessage</span><span class="o">(</span>
        <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">RoomCommand</span><span class="o">&gt;</span> <span class="n">room</span><span class="o">,</span> <span class="nc">String</span> <span class="n">screenName</span><span class="o">,</span> <span class="nc">PostMessage</span> <span class="n">post</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// from client, publish to others via the room</span>
      <span class="n">room</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">PublishSessionMessage</span><span class="o">(</span><span class="n">screenName</span><span class="o">,</span> <span class="n">post</span><span class="o">.</span><span class="na">message</span><span class="o">));</span>
      <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">SessionCommand</span><span class="o">&gt;</span> <span class="nf">onNotifyClient</span><span class="o">(</span>
        <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">SessionEvent</span><span class="o">&gt;</span> <span class="n">client</span><span class="o">,</span> <span class="nc">NotifyClient</span> <span class="n">notification</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// published from the room</span>
      <span class="n">client</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">notification</span><span class="o">.</span><span class="na">message</span><span class="o">);</span>
      <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é€šè¿‡æ”¹å˜è¡Œä¸ºè€Œä¸æ˜¯ä½¿ç”¨ä»»ä½•å˜é‡æ¥ç®¡ç†çŠ¶æ€ã€‚</p>

<p>å½“ä¸€ä¸ªæ–°çš„GetSessionå‘½ä»¤è¿›æ¥æ—¶ï¼Œæˆ‘ä»¬å°†è¯¥å®¢æˆ·ç«¯æ·»åŠ åˆ°è¿”å›è¡Œä¸ºä¸­çš„åˆ—è¡¨ä¸­ã€‚ç„¶åï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ›å»ºä¼šè¯çš„ActorRefï¼Œå®ƒå°†ç”¨äºå‘å¸ƒæ¶ˆæ¯ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›åˆ›å»ºä¸€ä¸ªéå¸¸ç®€å•çš„Actorï¼Œå®ƒå°†PostMessageå‘½ä»¤é‡æ–°æ‰“åŒ…åˆ°PublishSessionMessageå‘½ä»¤ä¸­ï¼Œè¯¥å‘½ä»¤è¿˜åŒ…å«å±å¹•åã€‚</p>

<p>æˆ‘ä»¬åœ¨è¿™é‡Œå£°æ˜çš„è¡Œä¸ºå¯ä»¥å¤„ç†RoomCommandçš„ä¸¤ç§å­ç±»å‹ã€‚GetSessionå·²ç»è§£é‡Šè¿‡äº†ï¼Œæ¥è‡ªä¼šè¯Actorçš„PublishSessionMessageå‘½ä»¤å°†è§¦å‘åŒ…å«çš„èŠå¤©å®¤æ¶ˆæ¯å‘æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯ä¼ æ’­ã€‚ä½†æ˜¯æˆ‘ä»¬ä¸æƒ³ç»™PublishSessionMessageå‘½ä»¤å‘é€åˆ°ä»»æ„å®¢æˆ·çš„èƒ½åŠ›,æˆ‘ä»¬ä¿ç•™æƒåˆ©å†…éƒ¨ä¼šè¯Actoræˆ‘ä»¬create-otherwiseå®¢æˆ·å¯èƒ½ä¼šå¸¦æ¥å®Œå…¨ä¸åŒçš„å±å¹•åç§°(æƒ³è±¡ä¸€ä¸‹GetSessionåè®®è¿›ä¸€æ­¥åŒ…æ‹¬èº«ä»½éªŒè¯ä¿¡æ¯å®‰å…¨)ã€‚</p>

<p>å¦‚æœæˆ‘ä»¬ä¸å…³å¿ƒä¿æŠ¤ä¼šè¯å’Œå±å¹•åä¹‹é—´çš„é€šä¿¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ›´æ”¹åè®®ï¼Œè¿™æ ·PostMessageè¢«åˆ é™¤ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯åªè·å¾—ActorRef<PublishSessionMessage>æ¥å‘é€ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸éœ€è¦ä¼šè¯actorï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨context.getSelf()ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç±»å‹æ£€æŸ¥æ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºActorRef<T>åœ¨å…¶ç±»å‹å‚æ•°ä¸­æ˜¯ç›¸åçš„ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨éœ€è¦ActorRef<PublishSessionMessage>çš„åœ°æ–¹ä½¿ç”¨ActorRef<RoomCommand>â€”â€”è¿™æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå› ä¸ºå‰è€…ä¼šæ¯”åè€…ä½¿ç”¨æ›´å¤šçš„è¯­è¨€ã€‚åä¹‹åˆ™ä¼šå‡ºç°é—®é¢˜ï¼Œå› æ­¤åœ¨ActorRef<RoomCommand>æ˜¯å¿…éœ€çš„åœ°æ–¹ä¼ é€’ActorRef<PublishSessionMessage>å°†å¯¼è‡´ç±»å‹é”™è¯¯ã€‚</PublishSessionMessage></RoomCommand></RoomCommand></PublishSessionMessage></T></PublishSessionMessage></p>

<h4 id="4232-å°è¯•">4.2.3.2. å°è¯•</h4>

<p>ä¸ºäº†çœ‹åˆ°è¿™ä¸ªèŠå¤©å®¤åœ¨è¡ŒåŠ¨ï¼Œæˆ‘ä»¬éœ€è¦å†™ä¸€ä¸ªå®¢æˆ·ç«¯ Actorsï¼Œå¯ä»¥ä½¿ç”¨å®ƒ:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Gabbler</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionEvent</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="n">ctx</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">Gabbler</span><span class="o">(</span><span class="n">ctx</span><span class="o">).</span><span class="na">behavior</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionEvent</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nf">Gabbler</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionEvent</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionEvent</span><span class="o">&gt;</span> <span class="nf">behavior</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionEvent</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionDenied</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onSessionDenied</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionGranted</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onSessionGranted</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">MessagePosted</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onMessagePosted</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionEvent</span><span class="o">&gt;</span> <span class="nf">onSessionDenied</span><span class="o">(</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionDenied</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">context</span><span class="o">.</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"cannot start chat room session: {}"</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">reason</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">stopped</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionEvent</span><span class="o">&gt;</span> <span class="nf">onSessionGranted</span><span class="o">(</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionGranted</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">message</span><span class="o">.</span><span class="na">handle</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChatRoom</span><span class="o">.</span><span class="na">PostMessage</span><span class="o">(</span><span class="s">"Hello World!"</span><span class="o">));</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionEvent</span><span class="o">&gt;</span> <span class="nf">onMessagePosted</span><span class="o">(</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">MessagePosted</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">context</span>
        <span class="o">.</span><span class="na">getLog</span><span class="o">()</span>
        <span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"message has been posted by '{}': {}"</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">screenName</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">message</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">stopped</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é€šè¿‡è¿™ç§è¡Œä¸ºï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªActorï¼Œå®ƒå°†æ¥å—èŠå¤©å®¤ä¼šè¯ã€å‘å¸ƒæ¶ˆæ¯ã€ç­‰å¾…å®ƒçš„å‘å¸ƒï¼Œç„¶åç»ˆæ­¢ã€‚æœ€åä¸€æ­¥éœ€è¦æ”¹å˜è¡Œä¸ºçš„èƒ½åŠ›ï¼Œæˆ‘ä»¬éœ€è¦ä»æ­£å¸¸çš„è¿è¡Œè¡Œä¸ºè½¬æ¢åˆ°ç»ˆæ­¢çŠ¶æ€ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨è¿™é‡Œæˆ‘ä»¬ä¸è¿”å›ç›¸åŒçš„å€¼ï¼Œè€Œè¿”å›å¦ä¸€ä¸ªç‰¹æ®Šçš„åœæ­¢å€¼ã€‚</p>

<p>ç°åœ¨è¦å°è¯•ä¸€ä¸‹ï¼Œæˆ‘ä»¬å¿…é¡»åŒæ—¶å¯åŠ¨èŠå¤©å®¤å’Œgabblerå½“ç„¶æˆ‘ä»¬æ˜¯åœ¨Actorç³»ç»Ÿä¸­è¿›è¡Œçš„ã€‚æ—¢ç„¶åªèƒ½æœ‰ä¸€ä¸ªç”¨æˆ·ç›‘æŠ¤äººï¼Œæˆ‘ä»¬å¯ä»¥ä»èŠå¤©å®¤çš„gabbler(è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„â€”â€”å®ƒä½¿é€»è¾‘å¤æ‚åŒ–äº†)æˆ–è€…ä»èŠå¤©å®¤çš„gabbler(è¿™æ˜¯è’è°¬çš„)æˆ–è€…æˆ‘ä»¬ä»ç¬¬ä¸‰ä¸ªè§’è‰²å¼€å§‹ä»–ä»¬ä¸¤ä¸ªâ€”â€”æˆ‘ä»¬å”¯ä¸€æ˜æ™ºçš„é€‰æ‹©:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span>
        <span class="n">context</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">RoomCommand</span><span class="o">&gt;</span> <span class="n">chatRoom</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"chatRoom"</span><span class="o">);</span>
          <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionEvent</span><span class="o">&gt;</span> <span class="n">gabbler</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">Gabbler</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"gabbler"</span><span class="o">);</span>
          <span class="n">context</span><span class="o">.</span><span class="na">watch</span><span class="o">(</span><span class="n">gabbler</span><span class="o">);</span>
          <span class="n">chatRoom</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChatRoom</span><span class="o">.</span><span class="na">GetSession</span><span class="o">(</span><span class="s">"olâ€™ Gabbler"</span><span class="o">,</span> <span class="n">gabbler</span><span class="o">));</span>

          <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="nc">Void</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
              <span class="o">.</span><span class="na">onSignal</span><span class="o">(</span><span class="nc">Terminated</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">sig</span> <span class="o">-&gt;</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">stopped</span><span class="o">())</span>
              <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="o">});</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">Main</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"ChatRoomDemo"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨è‰¯å¥½çš„ä¼ ç»Ÿä¸­ï¼Œæˆ‘ä»¬ç§°ä¸» Actor ä¸ºå®ƒæ˜¯ä»€ä¹ˆï¼Œå®ƒç›´æ¥å¯¹åº”äºä¼ ç»ŸJavaåº”ç”¨ç¨‹åºä¸­çš„ä¸»æ–¹æ³•ã€‚è¿™ä¸ªActorå°†è‡ªåŠ¨æ‰§è¡Œå®ƒçš„å·¥ä½œï¼Œæˆ‘ä»¬ä¸éœ€è¦ä»å¤–éƒ¨å‘é€æ¶ˆæ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å®ƒå£°æ˜ä¸ºVoidç±»å‹ã€‚Actorä¸ä»…æ¥æ”¶å¤–éƒ¨æ¶ˆæ¯ï¼Œè¿˜ä¼šæ”¶åˆ°æŸäº›ç³»ç»Ÿäº‹ä»¶çš„é€šçŸ¥ï¼Œå³æ‰€è°“çš„ä¿¡å·ã€‚ä¸ºäº†è®¿é—®å®ƒä»¬ï¼Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨receive behavior decoratoræ¥å®ç°è¿™ä¸ªç‰¹å®šçš„æ“ä½œã€‚å¯¹äºä¿¡å·(Signalçš„å­ç±»)å°†è°ƒç”¨æä¾›çš„onSignalå‡½æ•°ï¼Œå¯¹äºç”¨æˆ·æ¶ˆæ¯å°†è°ƒç”¨onMessageå‡½æ•°ã€‚</p>

<p>è¿™ä¸ªç‰¹æ®Šçš„ä¸»è¦Actoræ˜¯ä½¿ç”¨behavioråˆ›å»ºçš„ã€‚è®¾ç½®ï¼Œå®ƒå°±åƒè¡Œä¸ºçš„å·¥å‚ã€‚ä¸è¡Œä¸ºç›¸åï¼Œè¡Œä¸ºå®ä¾‹çš„åˆ›å»ºè¢«æ¨è¿Ÿåˆ°Actorå¯åŠ¨æ—¶ã€‚åœ¨actorè¿è¡Œä¹‹å‰ç«‹å³åˆ›å»ºè¡Œä¸ºå®ä¾‹çš„æ¥æ”¶ã€‚è®¾ç½®ä¸­çš„å·¥å‚å‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’ç»™ActorContextï¼Œä¾‹å¦‚ï¼Œå®ƒå¯ä»¥ç”¨äºç”Ÿæˆå­actorã€‚è¿™ä¸ªä¸»Actoråˆ›å»ºèŠå¤©å®¤å’Œgabblerï¼Œå¹¶å¯åŠ¨å®ƒä»¬ä¹‹é—´çš„ä¼šè¯ï¼Œå½“gabblerç»“æŸæ—¶ï¼Œæˆ‘ä»¬å°†æ”¶åˆ°ç”±äºè°ƒç”¨äº†contextè€Œç»ˆæ­¢çš„äº‹ä»¶ã€‚è§‚çœ‹ã€‚è¿™å…è®¸æˆ‘ä»¬å…³é—­Actorç³»ç»Ÿ:å½“ä¸»Actorç»ˆæ­¢æ—¶ï¼Œå°±ä¸å†éœ€è¦åšä»€ä¹ˆäº†ã€‚</p>

<p>å› æ­¤ï¼Œåœ¨åˆ›å»ºå…·æœ‰ä¸» Actor è¡Œä¸ºçš„ Actor ç³»ç»Ÿä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥è®©ä¸»æ–¹æ³•è¿”å›ï¼ŒActorSystemå°†ç»§ç»­è¿è¡Œï¼ŒJVMå°†ä¿æŒæ´»åŠ¨çŠ¶æ€ï¼Œç›´åˆ°æ ¹Actoråœæ­¢ã€‚</p>

<h4 id="4233-é¢å‘å¯¹è±¡é£æ ¼">4.2.3.3. é¢å‘å¯¹è±¡é£æ ¼</h4>

<p>ä¸Šé¢çš„ç¤ºä¾‹ä½¿ç”¨äº†å‡½æ•°å¼ç¼–ç¨‹é£æ ¼ï¼Œåœ¨è¿™ç§é£æ ¼ä¸­ï¼Œæ‚¨å°†ä¸€ä¸ªå‡½æ•°ä¼ é€’ç»™å·¥å‚ï¼Œç„¶åç”±å·¥å‚æ„é€ ä¸€ä¸ªè¡Œä¸ºï¼Œå¯¹äºæœ‰çŠ¶æ€çš„Actorï¼Œè¿™æ„å‘³ç€å°†ä¸å¯å˜çš„çŠ¶æ€ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œå¹¶åœ¨éœ€è¦å¯¹æ›´æ”¹çš„çŠ¶æ€è¿›è¡Œæ“ä½œæ—¶åˆ‡æ¢åˆ°æ–°çš„è¡Œä¸ºã€‚å¦ä¸€ç§è¡¨è¾¾æ–¹å¼æ˜¯æ›´é¢å‘å¯¹è±¡çš„é£æ ¼ï¼Œå…¶ä¸­å®šä¹‰äº†actorè¡Œä¸ºçš„å…·ä½“ç±»ï¼Œå¯å˜çŠ¶æ€ä½œä¸ºå­—æ®µä¿å­˜åœ¨å…¶ä¸­ã€‚</p>

<p>é€‰æ‹©ä½¿ç”¨å“ªç§é£æ ¼æ˜¯ä¸€ä¸ªå“å‘³é—®é¢˜ï¼Œä¸¤ç§é£æ ¼éƒ½å¯ä»¥æ··åˆä½¿ç”¨ï¼Œè¿™å–å†³äºå“ªç§é£æ ¼å¯¹ç‰¹å®šçš„Actoræ¥è¯´æ˜¯æœ€å¥½çš„ã€‚åœ¨<a href="https://doc.akka.io/docs/akka/current/typed/style-guide.html#functional-versus-object-oriented-style">æ ·å¼æŒ‡å—</a>ä¸­æä¾›äº†é€‰æ‹©çš„æ³¨æ„äº‹é¡¹ã€‚</p>

<h5 id="42331-abstractbehavior-api">4.2.3.3.1. AbstractBehavior API</h5>

<p>å®šä¹‰åŸºäºactorè¡Œä¸ºçš„ç±»ä»æ‰©å±•akka.actor.type.javads.AbstractBehavior<T>å¼€å§‹ï¼Œå…¶ä¸­Tæ˜¯è¡Œä¸ºå°†æ¥å—çš„æ¶ˆæ¯ç±»å‹ã€‚</T></p>

<p>è®©æˆ‘ä»¬é‡å¤ä¸Šé¢ä½¿ç”¨AbstractBehaviorå®ç°çš„æ›´å¤æ‚ç¤ºä¾‹ä¸­çš„èŠå¤©å®¤ç¤ºä¾‹ã€‚ä¸actoräº¤äº’çš„åè®®çœ‹èµ·æ¥æ˜¯ä¸€æ ·çš„:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="rouge-code"><pre><span class="kd">static</span> <span class="kd">interface</span> <span class="nc">RoomCommand</span> <span class="o">{}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">GetSession</span> <span class="kd">implements</span> <span class="nc">RoomCommand</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">screenName</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">SessionEvent</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">GetSession</span><span class="o">(</span><span class="nc">String</span> <span class="n">screenName</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">SessionEvent</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">screenName</span> <span class="o">=</span> <span class="n">screenName</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="kd">interface</span> <span class="nc">SessionEvent</span> <span class="o">{}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">SessionGranted</span> <span class="kd">implements</span> <span class="nc">SessionEvent</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">PostMessage</span><span class="o">&gt;</span> <span class="n">handle</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">SessionGranted</span><span class="o">(</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">PostMessage</span><span class="o">&gt;</span> <span class="n">handle</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">SessionDenied</span> <span class="kd">implements</span> <span class="nc">SessionEvent</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">reason</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">SessionDenied</span><span class="o">(</span><span class="nc">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">reason</span> <span class="o">=</span> <span class="n">reason</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MessagePosted</span> <span class="kd">implements</span> <span class="nc">SessionEvent</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">screenName</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">message</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">MessagePosted</span><span class="o">(</span><span class="nc">String</span> <span class="n">screenName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">screenName</span> <span class="o">=</span> <span class="n">screenName</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="kd">interface</span> <span class="nc">SessionCommand</span> <span class="o">{}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">PostMessage</span> <span class="kd">implements</span> <span class="nc">SessionCommand</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">message</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">PostMessage</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">NotifyClient</span> <span class="kd">implements</span> <span class="nc">SessionCommand</span> <span class="o">{</span>
  <span class="kd">final</span> <span class="nc">MessagePosted</span> <span class="n">message</span><span class="o">;</span>

  <span class="nc">NotifyClient</span><span class="o">(</span><span class="nc">MessagePosted</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœ€åˆï¼Œå®¢æˆ·ç«¯Actoråªèƒ½è®¿é—®å…è®¸ä»–ä»¬è¿›è¡Œç¬¬ä¸€æ­¥çš„ActorRef<GetSession>ã€‚ä¸€æ—¦å»ºç«‹äº†å®¢æˆ·ç«¯çš„ä¼šè¯ï¼Œå®ƒå°±ä¼šå¾—åˆ°ä¸€ä¸ªåŒ…å«å¥æŸ„çš„SessionGrantedæ¶ˆæ¯ï¼Œè¯¥å¥æŸ„ç”¨äºè§£é”ä¸‹ä¸€ä¸ªåè®®æ­¥éª¤ï¼Œå³å‘å¸ƒæ¶ˆæ¯ã€‚éœ€è¦å°†PostMessageå‘½ä»¤å‘é€åˆ°è¿™ä¸ªè¡¨ç¤ºå·²æ·»åŠ åˆ°èŠå¤©å®¤çš„ä¼šè¯çš„ç‰¹å®šåœ°å€ã€‚ä¼šè¯çš„å¦ä¸€ä¸ªæ–¹é¢æ˜¯å®¢æˆ·ç«¯é€šè¿‡replyToå‚æ•°æ˜¾ç¤ºäº†å®ƒè‡ªå·±çš„åœ°å€ï¼Œä»¥ä¾¿åç»­çš„messagepostäº‹ä»¶å¯ä»¥å‘é€ç»™å®ƒã€‚</GetSession></p>

<p>è¿™è¯´æ˜äº†actorå¦‚ä½•è¡¨è¾¾Javaå¯¹è±¡ä¸Šçš„æ–¹æ³•è°ƒç”¨ä»¥å¤–çš„å†…å®¹ã€‚å£°æ˜çš„æ¶ˆæ¯ç±»å‹åŠå…¶å†…å®¹æè¿°äº†ä¸€ä¸ªå®Œæ•´çš„åè®®ï¼Œè¯¥åè®®å¯ä»¥æ¶‰åŠå¤šä¸ªActorï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡å¤šä¸ªæ­¥éª¤è¿›è¡Œæ¼”åŒ–ã€‚ä¸‹é¢æ˜¯èŠå¤©å®¤åè®®çš„AbstractBehaviorå®ç°:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChatRoom</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">PublishSessionMessage</span> <span class="kd">implements</span> <span class="nc">RoomCommand</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">screenName</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">message</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">PublishSessionMessage</span><span class="o">(</span><span class="nc">String</span> <span class="n">screenName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">screenName</span> <span class="o">=</span> <span class="n">screenName</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">RoomCommand</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">ChatRoomBehavior:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ChatRoomBehavior</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">RoomCommand</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">SessionCommand</span><span class="o">&gt;&gt;</span> <span class="n">sessions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="kd">private</span> <span class="nf">ChatRoomBehavior</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">RoomCommand</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">RoomCommand</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">ReceiveBuilder</span><span class="o">&lt;</span><span class="nc">RoomCommand</span><span class="o">&gt;</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">newReceiveBuilder</span><span class="o">();</span>

      <span class="n">builder</span><span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">GetSession</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onGetSession</span><span class="o">);</span>
      <span class="n">builder</span><span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">PublishSessionMessage</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onPublishSessionMessage</span><span class="o">);</span>

      <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">RoomCommand</span><span class="o">&gt;</span> <span class="nf">onGetSession</span><span class="o">(</span><span class="nc">GetSession</span> <span class="n">getSession</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">UnsupportedEncodingException</span> <span class="o">{</span>
      <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">SessionEvent</span><span class="o">&gt;</span> <span class="n">client</span> <span class="o">=</span> <span class="n">getSession</span><span class="o">.</span><span class="na">replyTo</span><span class="o">;</span>
      <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">SessionCommand</span><span class="o">&gt;</span> <span class="n">ses</span> <span class="o">=</span>
          <span class="n">getContext</span><span class="o">()</span>
              <span class="o">.</span><span class="na">spawn</span><span class="o">(</span>
                  <span class="nc">SessionBehavior</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">getContext</span><span class="o">().</span><span class="na">getSelf</span><span class="o">(),</span> <span class="n">getSession</span><span class="o">.</span><span class="na">screenName</span><span class="o">,</span> <span class="n">client</span><span class="o">),</span>
                  <span class="nc">URLEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">getSession</span><span class="o">.</span><span class="na">screenName</span><span class="o">,</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">.</span><span class="na">name</span><span class="o">()));</span>
      <span class="c1">// narrow to only expose PostMessage</span>
      <span class="n">client</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">SessionGranted</span><span class="o">(</span><span class="n">ses</span><span class="o">.</span><span class="na">narrow</span><span class="o">()));</span>
      <span class="n">sessions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ses</span><span class="o">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">RoomCommand</span><span class="o">&gt;</span> <span class="nf">onPublishSessionMessage</span><span class="o">(</span><span class="nc">PublishSessionMessage</span> <span class="n">pub</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">NotifyClient</span> <span class="n">notification</span> <span class="o">=</span>
          <span class="k">new</span> <span class="nf">NotifyClient</span><span class="o">((</span><span class="k">new</span> <span class="nc">MessagePosted</span><span class="o">(</span><span class="n">pub</span><span class="o">.</span><span class="na">screenName</span><span class="o">,</span> <span class="n">pub</span><span class="o">.</span><span class="na">message</span><span class="o">)));</span>
      <span class="n">sessions</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">notification</span><span class="o">));</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SessionBehavior</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionCommand</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">RoomCommand</span><span class="o">&gt;</span> <span class="n">room</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">screenName</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">SessionEvent</span><span class="o">&gt;</span> <span class="n">client</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionCommand</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span>
        <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">RoomCommand</span><span class="o">&gt;</span> <span class="n">room</span><span class="o">,</span> <span class="nc">String</span> <span class="n">screenName</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">SessionEvent</span><span class="o">&gt;</span> <span class="n">client</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="n">context</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">SessionBehavior</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">room</span><span class="o">,</span> <span class="n">screenName</span><span class="o">,</span> <span class="n">client</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nf">SessionBehavior</span><span class="o">(</span>
        <span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionCommand</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span>
        <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">RoomCommand</span><span class="o">&gt;</span> <span class="n">room</span><span class="o">,</span>
        <span class="nc">String</span> <span class="n">screenName</span><span class="o">,</span>
        <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">SessionEvent</span><span class="o">&gt;</span> <span class="n">client</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">room</span> <span class="o">=</span> <span class="n">room</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">screenName</span> <span class="o">=</span> <span class="n">screenName</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">client</span> <span class="o">=</span> <span class="n">client</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">SessionCommand</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
          <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">PostMessage</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onPostMessage</span><span class="o">)</span>
          <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">NotifyClient</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onNotifyClient</span><span class="o">)</span>
          <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">SessionCommand</span><span class="o">&gt;</span> <span class="nf">onPostMessage</span><span class="o">(</span><span class="nc">PostMessage</span> <span class="n">post</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// from client, publish to others via the room</span>
      <span class="n">room</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">PublishSessionMessage</span><span class="o">(</span><span class="n">screenName</span><span class="o">,</span> <span class="n">post</span><span class="o">.</span><span class="na">message</span><span class="o">));</span>
      <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">SessionCommand</span><span class="o">&gt;</span> <span class="nf">onNotifyClient</span><span class="o">(</span><span class="nc">NotifyClient</span> <span class="n">notification</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// published from the room</span>
      <span class="n">client</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">notification</span><span class="o">.</span><span class="na">message</span><span class="o">);</span>
      <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>çŠ¶æ€æ˜¯é€šè¿‡ç±»ä¸­çš„å­—æ®µç®¡ç†çš„ï¼Œå°±åƒå¸¸è§„çš„é¢å‘å¯¹è±¡ç±»ä¸€æ ·ã€‚ç”±äºçŠ¶æ€æ˜¯å¯å˜çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ä¼šä»æ¶ˆæ¯é€»è¾‘è¿”å›ä¸åŒçš„è¡Œä¸ºï¼Œä½†æ˜¯å¯ä»¥è¿”å›AbstractBehaviorå®ä¾‹æœ¬èº«(this)ä½œä¸ºå¤„ç†ä¼ å…¥çš„ä¸‹ä¸€ä¸ªæ¶ˆæ¯çš„è¡Œä¸ºã€‚æˆ‘ä»¬è¿˜å¯ä»¥è¿”å›Behaviorã€‚ä»¥åŒæ ·çš„æ–¹å¼è¾¾åˆ°åŒæ ·çš„ç›®çš„ã€‚</p>

<p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†å•ç‹¬çš„è¯­å¥æ¥åˆ›å»ºè¡Œä¸ºæ„å»ºå™¨ï¼Œä½†æ˜¯å®ƒä¹Ÿä¼šä»æ¯ä¸€æ­¥è¿”å›æ„å»ºå™¨æœ¬èº«ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ä½¿ç”¨æ›´æµç•…çš„è¡Œä¸ºå®šä¹‰æ ·å¼ã€‚æ‚¨åº”è¯¥é€‰æ‹©çš„å†…å®¹å–å†³äºActoræ¥å—çš„æ¶ˆæ¯é›†çš„å¤§å°ã€‚</p>

<p>ä¹Ÿå¯ä»¥è¿”å›ä¸€ä¸ªæ–°çš„ä¸åŒçš„AbstractBehavior,ä¾‹å¦‚ä»£è¡¨ä¸€ä¸ªä¸åŒçš„å›½å®¶åœ¨ä¸€ä¸ªæœ‰é™çŠ¶æ€æœº(FSM),æˆ–ä½¿ç”¨ä¸€ä¸ªåŠŸèƒ½è¡Œä¸ºçš„å·¥å‚ä¸åŠŸèƒ½ç»“åˆé¢å‘å¯¹è±¡é£æ ¼çš„ä¸åŒéƒ¨åˆ†çš„ç”Ÿå‘½å‘¨æœŸç›¸åŒçš„æ¼”å‘˜çš„è¡Œä¸ºã€‚</p>

<p>å½“æ–°çš„GetSessionå‘½ä»¤ä¼ å…¥æ—¶ï¼Œæˆ‘ä»¬å°†è¯¥å®¢æˆ·ç«¯æ·»åŠ åˆ°å½“å‰ä¼šè¯åˆ—è¡¨ä¸­ã€‚ç„¶åï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ›å»ºä¼šè¯çš„ActorRefï¼Œå®ƒå°†ç”¨äºå‘å¸ƒæ¶ˆæ¯ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›åˆ›å»ºä¸€ä¸ªéå¸¸ç®€å•çš„Actorï¼Œå®ƒå°†PostMessageå‘½ä»¤é‡æ–°æ‰“åŒ…åˆ°PublishSessionMessageå‘½ä»¤ä¸­ï¼Œè¯¥å‘½ä»¤è¿˜åŒ…å«å±å¹•åã€‚</p>

<p>ä¸ºäº†å®ç°ä¸ºä¼šè¯ç”Ÿæˆå­å…ƒç´ çš„é€»è¾‘ï¼Œæˆ‘ä»¬éœ€è¦è®¿é—®ActorContextã€‚è¿™æ˜¯åœ¨åˆ›å»ºè¡Œä¸ºæ—¶ä½œä¸ºæ„é€ å‡½æ•°å‚æ•°æ³¨å…¥çš„ï¼Œè¯·æ³¨æ„æˆ‘ä»¬æ˜¯å¦‚ä½•å°†AbstractBehaviorå’Œbehaviorç»“åˆåœ¨ä¸€èµ·çš„ã€‚åœ¨åˆ›å»ºå·¥å‚æ–¹æ³•ä¸­æ‰§è¡Œæ­¤æ“ä½œã€‚</p>

<p>æˆ‘ä»¬åœ¨è¿™é‡Œå£°æ˜çš„è¡Œä¸ºå¯ä»¥å¤„ç†RoomCommandçš„ä¸¤ç§å­ç±»å‹ã€‚GetSessionå·²ç»è§£é‡Šè¿‡äº†ï¼Œæ¥è‡ªä¼šè¯Actorçš„PublishSessionMessageå‘½ä»¤å°†è§¦å‘åŒ…å«çš„èŠå¤©å®¤æ¶ˆæ¯å‘æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯ä¼ æ’­ã€‚ä½†æ˜¯æˆ‘ä»¬ä¸æƒ³ç»™PublishSessionMessageå‘½ä»¤å‘é€åˆ°ä»»æ„å®¢æˆ·çš„èƒ½åŠ›,æˆ‘ä»¬ä¿ç•™æƒåˆ©å†…éƒ¨ä¼šè¯Actoræˆ‘ä»¬create-otherwiseå®¢æˆ·å¯èƒ½ä¼šå¸¦æ¥å®Œå…¨ä¸åŒçš„å±å¹•åç§°(æƒ³è±¡ä¸€ä¸‹GetSessionåè®®è¿›ä¸€æ­¥åŒ…æ‹¬èº«ä»½éªŒè¯ä¿¡æ¯å®‰å…¨)ã€‚</p>

<p>å¦‚æœæˆ‘ä»¬ä¸å…³å¿ƒä¿æŠ¤ä¼šè¯å’Œå±å¹•åä¹‹é—´çš„é€šä¿¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ›´æ”¹åè®®ï¼Œè¿™æ ·PostMessageè¢«åˆ é™¤ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯åªè·å¾—ActorRef<PublishSessionMessage>æ¥å‘é€ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸éœ€è¦ä¼šè¯actorï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨context.getSelf()ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç±»å‹æ£€æŸ¥æ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºActorRef<T>åœ¨å…¶ç±»å‹å‚æ•°ä¸­æ˜¯ç›¸åçš„ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨éœ€è¦ActorRef<PublishSessionMessage>çš„åœ°æ–¹ä½¿ç”¨ActorRef<RoomCommand>â€”â€”è¿™æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå› ä¸ºå‰è€…ä¼šæ¯”åè€…ä½¿ç”¨æ›´å¤šçš„è¯­è¨€ã€‚åä¹‹åˆ™ä¼šå‡ºç°é—®é¢˜ï¼Œå› æ­¤åœ¨ActorRef<RoomCommand>æ˜¯å¿…éœ€çš„åœ°æ–¹ä¼ é€’ActorRef<PublishSessionMessage>å°†å¯¼è‡´ç±»å‹é”™è¯¯ã€‚</PublishSessionMessage></RoomCommand></RoomCommand></PublishSessionMessage></T></PublishSessionMessage></p>

<h5 id="42332-å°è¯•">4.2.3.3.2. å°è¯•</h5>

<p>ä¸ºäº†çœ‹åˆ°è¿™ä¸ªèŠå¤©å®¤åœ¨è¡ŒåŠ¨ï¼Œæˆ‘ä»¬éœ€è¦å†™ä¸€ä¸ªå®¢æˆ·ç«¯æ¼”å‘˜ï¼Œå¯ä»¥ä½¿ç”¨å®ƒ:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Gabbler</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionEvent</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionEvent</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">Gabbler:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nf">Gabbler</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionEvent</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionEvent</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ReceiveBuilder</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionEvent</span><span class="o">&gt;</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">newReceiveBuilder</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">builder</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionDenied</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onSessionDenied</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionGranted</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onSessionGranted</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">MessagePosted</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onMessagePosted</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionEvent</span><span class="o">&gt;</span> <span class="nf">onSessionDenied</span><span class="o">(</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionDenied</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"cannot start chat room session: {}"</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">reason</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">stopped</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionEvent</span><span class="o">&gt;</span> <span class="nf">onSessionGranted</span><span class="o">(</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionGranted</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">message</span><span class="o">.</span><span class="na">handle</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChatRoom</span><span class="o">.</span><span class="na">PostMessage</span><span class="o">(</span><span class="s">"Hello World!"</span><span class="o">));</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionEvent</span><span class="o">&gt;</span> <span class="nf">onMessagePosted</span><span class="o">(</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">MessagePosted</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">()</span>
        <span class="o">.</span><span class="na">getLog</span><span class="o">()</span>
        <span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"message has been posted by '{}': {}"</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">screenName</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">message</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">stopped</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç°åœ¨è¦å°è¯•ä¸€ä¸‹ï¼Œæˆ‘ä»¬å¿…é¡»åŒæ—¶å¯åŠ¨èŠå¤©å®¤å’Œgabblerå½“ç„¶æˆ‘ä»¬æ˜¯åœ¨Actorç³»ç»Ÿä¸­è¿›è¡Œçš„ã€‚æ—¢ç„¶åªèƒ½æœ‰ä¸€ä¸ªç”¨æˆ·ç›‘æŠ¤äººï¼Œæˆ‘ä»¬å¯ä»¥ä»èŠå¤©å®¤çš„gabbler(è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„â€”â€”å®ƒä½¿é€»è¾‘å¤æ‚åŒ–äº†)æˆ–è€…ä»èŠå¤©å®¤çš„gabbler(è¿™æ˜¯è’è°¬çš„)æˆ–è€…æˆ‘ä»¬ä»ç¬¬ä¸‰ä¸ªè§’è‰²å¼€å§‹ä»–ä»¬ä¸¤ä¸ªâ€”â€”æˆ‘ä»¬å”¯ä¸€æ˜æ™ºçš„é€‰æ‹©:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span>
        <span class="n">context</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">RoomCommand</span><span class="o">&gt;</span> <span class="n">chatRoom</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"chatRoom"</span><span class="o">);</span>
          <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">ChatRoom</span><span class="o">.</span><span class="na">SessionEvent</span><span class="o">&gt;</span> <span class="n">gabbler</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">Gabbler</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"gabbler"</span><span class="o">);</span>
          <span class="n">context</span><span class="o">.</span><span class="na">watch</span><span class="o">(</span><span class="n">gabbler</span><span class="o">);</span>
          <span class="n">chatRoom</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChatRoom</span><span class="o">.</span><span class="na">GetSession</span><span class="o">(</span><span class="s">"olâ€™ Gabbler"</span><span class="o">,</span> <span class="n">gabbler</span><span class="o">));</span>

          <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="nc">Void</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
              <span class="o">.</span><span class="na">onSignal</span><span class="o">(</span><span class="nc">Terminated</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">sig</span> <span class="o">-&gt;</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">stopped</span><span class="o">())</span>
              <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="o">});</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">Main</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"ChatRoomDemo"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨è‰¯å¥½çš„ä¼ ç»Ÿä¸­ï¼Œæˆ‘ä»¬ç§°ä¸»Actorä¸ºå®ƒæ˜¯ä»€ä¹ˆï¼Œå®ƒç›´æ¥å¯¹åº”äºä¼ ç»ŸJavaåº”ç”¨ç¨‹åºä¸­çš„ä¸»æ–¹æ³•ã€‚è¿™ä¸ªActorå°†è‡ªåŠ¨æ‰§è¡Œå®ƒçš„å·¥ä½œï¼Œæˆ‘ä»¬ä¸éœ€è¦ä»å¤–éƒ¨å‘é€æ¶ˆæ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å®ƒå£°æ˜ä¸ºVoidç±»å‹ã€‚Actorä¸ä»…æ¥æ”¶å¤–éƒ¨æ¶ˆæ¯ï¼Œè¿˜ä¼šæ”¶åˆ°æŸäº›ç³»ç»Ÿäº‹ä»¶çš„é€šçŸ¥ï¼Œå³æ‰€è°“çš„ä¿¡å·ã€‚ä¸ºäº†è®¿é—®å®ƒä»¬ï¼Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨receive behavior decoratoræ¥å®ç°è¿™ä¸ªç‰¹å®šçš„æ“ä½œã€‚å¯¹äºä¿¡å·(Signalçš„å­ç±»)å°†è°ƒç”¨æä¾›çš„onSignalå‡½æ•°ï¼Œå¯¹äºç”¨æˆ·æ¶ˆæ¯å°†è°ƒç”¨onMessageå‡½æ•°ã€‚</p>

<p>è¿™ä¸ªç‰¹æ®Šçš„ä¸»è¦Actoræ˜¯ä½¿ç”¨behavioråˆ›å»ºçš„ã€‚è®¾ç½®ï¼Œå®ƒå°±åƒè¡Œä¸ºçš„å·¥å‚ã€‚ä¸è¡Œä¸ºç›¸åï¼Œè¡Œä¸ºå®ä¾‹çš„åˆ›å»ºè¢«æ¨è¿Ÿåˆ°Actorå¯åŠ¨æ—¶ã€‚åœ¨actorè¿è¡Œä¹‹å‰ç«‹å³åˆ›å»ºè¡Œä¸ºå®ä¾‹çš„æ¥æ”¶ã€‚è®¾ç½®ä¸­çš„å·¥å‚å‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’ç»™ActorContextï¼Œä¾‹å¦‚ï¼Œå®ƒå¯ä»¥ç”¨äºç”Ÿæˆå­actorã€‚è¿™ä¸ªä¸»Actoråˆ›å»ºèŠå¤©å®¤å’Œgabblerï¼Œå¹¶å¯åŠ¨å®ƒä»¬ä¹‹é—´çš„ä¼šè¯ï¼Œå½“gabblerç»“æŸæ—¶ï¼Œæˆ‘ä»¬å°†æ”¶åˆ°ç”±äºè°ƒç”¨äº†contextè€Œç»ˆæ­¢çš„äº‹ä»¶ã€‚è§‚çœ‹ã€‚è¿™å…è®¸æˆ‘ä»¬å…³é—­Actorç³»ç»Ÿ:å½“ä¸»Actorç»ˆæ­¢æ—¶ï¼Œå°±ä¸å†éœ€è¦åšä»€ä¹ˆäº†ã€‚</p>

<p>å› æ­¤ï¼Œåœ¨åˆ›å»ºå…·æœ‰ä¸»Actorè¡Œä¸ºçš„Actorç³»ç»Ÿä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥è®©ä¸»æ–¹æ³•è¿”å›ï¼ŒActorSystemå°†ç»§ç»­è¿è¡Œï¼ŒJVMå°†ä¿æŒæ´»åŠ¨çŠ¶æ€ï¼Œç›´åˆ°æ ¹Actoråœæ­¢ã€‚</p>

<h2 id="43-actorç”Ÿå‘½å‘¨æœŸ">4.3. Actorç”Ÿå‘½å‘¨æœŸ</h2>

<h3 id="431-ç®€ä»‹">4.3.1. ç®€ä»‹</h3>

<p>Actoræ˜¯å¿…é¡»æ˜¾å¼å¯åŠ¨å’Œåœæ­¢çš„æœ‰çŠ¶æ€èµ„æºã€‚</p>

<p>é‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œå½“ä¸å†å¼•ç”¨Actoræ—¶ï¼ŒActorä¸ä¼šè‡ªåŠ¨åœæ­¢ï¼Œåˆ›å»ºçš„æ¯ä¸ªActorä¹Ÿå¿…é¡»æ˜¾å¼åœ°é”€æ¯ã€‚æƒŸä¸€çš„ç®€åŒ–æ˜¯ï¼Œåœæ­¢çˆ¶Actorè¿˜å°†é€’å½’åœ°åœæ­¢è¯¥çˆ¶Actoråˆ›å»ºçš„æ‰€æœ‰å­Actorã€‚å½“ActorSystemå…³é—­æ—¶ï¼Œæ‰€æœ‰çš„Actorsä¹Ÿä¼šè‡ªåŠ¨åœæ­¢ã€‚</p>

<blockquote>
  <p><strong>è¯·æ³¨æ„</strong>
ActorSystemæ˜¯é‡é‡çº§ç»“æ„ï¼Œå®ƒå°†åˆ†é…çº¿ç¨‹ï¼Œå› æ­¤ä¸ºæ¯ä¸ªé€»è¾‘åº”ç”¨ç¨‹åºåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ã€‚é€šå¸¸æ¯ä¸ªJVMè¿›ç¨‹æœ‰ä¸€ä¸ª ActorSystemã€‚</p>
</blockquote>

<h3 id="432-åˆ›å»ºactors">4.3.2. åˆ›å»ºActors</h3>

<p>ä¸€ä¸ªactorå¯ä»¥åˆ›å»ºæˆ–è¡ç”Ÿä»»æ„æ•°é‡çš„å­actorï¼Œè€Œå­actoråˆå¯ä»¥è¡ç”Ÿè‡ªå·±çš„å­actorï¼Œä»è€Œå½¢æˆä¸€ä¸ªactorå±‚æ¬¡ç»“æ„ã€‚<a href="https://doc.akka.io/japi/akka/2.6/akka/actor/typed/ActorSystem.html">ActorSystem</a>æ‰˜ç®¡å±‚æ¬¡ç»“æ„ï¼Œå¹¶ä¸”åªèƒ½æœ‰ä¸€ä¸ªæ ¹Actorï¼Œå³ä½äºActorSystemå±‚æ¬¡ç»“æ„é¡¶ç«¯çš„Actorã€‚å­è§’è‰²çš„ç”Ÿå‘½å‘¨æœŸä¸çˆ¶è§’è‰²ç›¸å…³è”â€”â€”å­è§’è‰²å¯ä»¥åœæ­¢è‡ªå·±æˆ–åœ¨ä»»ä½•æ—¶å€™è¢«åœæ­¢ï¼Œä½†å®ƒæ°¸è¿œæ— æ³•æ´»è¿‡çˆ¶è§’è‰²ã€‚</p>

<h4 id="4321-actorcontext">4.3.2.1. ActorContext</h4>

<p>ActorContextå¯ä»¥è¢«å¤šç§ç›®çš„è®¿é—®ï¼Œä¾‹å¦‚:</p>

<ul>
  <li>åˆ›å»ºå­Acotrå’Œç›‘ç£</li>
  <li>è§‚å¯Ÿå…¶ä»–Actorä»¥æ¥æ”¶ä¸€ä¸ªç»ˆæ­¢çš„(å…¶ä»–Actor)äº‹ä»¶ï¼Œå¦‚æœè¢«è§‚å¯Ÿçš„Actoræ°¸ä¹…åœæ­¢</li>
  <li>æ—¥å¿—è®°å½•</li>
  <li>åˆ›å»ºæ¶ˆæ¯é€‚é…å™¨</li>
  <li>ä¸å¦ä¸€ä¸ªActorçš„è¯·æ±‚-å“åº”äº¤äº’(ask)</li>
  <li>å¯¹self ActorRefçš„è®¿é—®</li>
</ul>

<p>å¦‚æœä¸€ä¸ªè¡Œä¸ºéœ€è¦ä½¿ç”¨ActorContextï¼Œä¾‹å¦‚è¡ç”Ÿå­actorï¼Œæˆ–è€…ä½¿ç”¨context.getSelf()ï¼Œå®ƒå¯ä»¥é€šè¿‡ç”¨Behaviors.setupåŒ…è£…æ„é€ æ¥è·å¾—:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldMain</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">HelloWorldMain</span><span class="o">.</span><span class="na">SayHello</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">SayHello</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">HelloWorldMain:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">Greet</span><span class="o">&gt;</span> <span class="n">greeter</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nf">HelloWorldMain</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">SayHello</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="n">greeter</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"greeter"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="4322-actorcontextçº¿ç¨‹å®‰å…¨">4.3.2.2. ActorContextçº¿ç¨‹å®‰å…¨</h4>

<p>ActorContextä¸­çš„è®¸å¤šæ–¹æ³•éƒ½ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„</p>

<ul>
  <li>ä¸èƒ½è¢«æ¥è‡ªjava.util.concurrent.CompletionStageçš„çº¿ç¨‹è®¿é—®å›è°ƒã€‚</li>
  <li>ä¸èƒ½åœ¨å¤šä¸ªactorå®ä¾‹ä¹‹é—´å…±äº«</li>
  <li>å¿…é¡»åªåœ¨æ™®é€šactorçº¿ç¨‹ä¸­ä½¿ç”¨æ¶ˆæ¯å¤„ç†</li>
</ul>

<h3 id="433-ç›‘æŠ¤actor">4.3.3. ç›‘æŠ¤Actor</h3>

<p>é¡¶çº§Actorï¼Œä¹Ÿç§°ä¸ºç”¨æˆ·ç›‘æŠ¤Actorï¼Œæ˜¯ä¸ActorSystemä¸€èµ·åˆ›å»ºçš„ã€‚å‘é€åˆ°Actorç³»ç»Ÿçš„æ¶ˆæ¯è¢«å®šå‘åˆ°æ ¹Actorã€‚æ ¹actoræ˜¯ç”±ç”¨æ¥åˆ›å»ºActorSystemçš„è¡Œä¸ºå®šä¹‰çš„ï¼Œåœ¨ä¸‹é¢çš„ä¾‹å­ä¸­å‘½åä¸ºHelloWorldMain:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">final</span> <span class="nc">ActorSystem</span><span class="o">&lt;</span><span class="nc">HelloWorldMain</span><span class="o">.</span><span class="na">SayHello</span><span class="o">&gt;</span> <span class="n">system</span> <span class="o">=</span>
    <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">HelloWorldMain</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"hello"</span><span class="o">);</span>

<span class="n">system</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">HelloWorldMain</span><span class="o">.</span><span class="na">SayHello</span><span class="o">(</span><span class="s">"World"</span><span class="o">));</span>
<span class="n">system</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">HelloWorldMain</span><span class="o">.</span><span class="na">SayHello</span><span class="o">(</span><span class="s">"Akka"</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯¹äºéå¸¸ç®€å•çš„åº”ç”¨ç¨‹åºï¼Œguardianå¯èƒ½åŒ…å«å®é™…çš„åº”ç”¨ç¨‹åºé€»è¾‘å’Œå¤„ç†æ¶ˆæ¯ã€‚ä¸€æ—¦åº”ç”¨ç¨‹åºå¤„ç†äº†ä¸æ­¢ä¸€ä¸ªé—®é¢˜ï¼Œç›‘æŠ¤äººå°±åº”è¯¥å¼•å¯¼åº”ç”¨ç¨‹åºï¼Œå°†å„ç§å­ç³»ç»Ÿä½œä¸ºå­ç³»ç»Ÿç”Ÿæˆï¼Œå¹¶ç›‘è§†å®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>

<p>å½“guardian Actoråœæ­¢æ—¶ï¼Œå°†åœæ­¢ActorSystemã€‚</p>

<p>å½“ActorSystem.terminate <a href="https://doc.akka.io/docs/akka/current/coordinated-shutdown.html">åè°ƒå…³é—­</a>æµç¨‹å°†ä»¥ç‰¹å®šçš„é¡ºåºåœæ­¢Actorå’ŒæœåŠ¡ã€‚</p>

<h3 id="434-åˆ›å»ºå­actor">4.3.4. åˆ›å»ºå­Actor</h3>

<p>å­actoræ˜¯é€šè¿‡<a href="https://doc.akka.io/japi/akka/2.6/akka/actor/typed/javadsl/ActorContext.html">ActorContext</a>çš„è¡ç”Ÿæ¥åˆ›å»ºå’Œå¯åŠ¨çš„ã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œå½“æ ¹actorå¯åŠ¨æ—¶ï¼Œå®ƒä¼šç”Ÿæˆä¸€ä¸ªç”±HelloWorldè¡Œä¸ºæè¿°çš„å­actorã€‚æ­¤å¤–ï¼Œå½“æ ¹actoræ¥æ”¶åˆ°ä¸€ä¸ªå¼€å§‹æ¶ˆæ¯æ—¶ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªç”±è¡Œä¸ºHelloWorldBotå®šä¹‰çš„å­actor:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldMain</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">HelloWorldMain</span><span class="o">.</span><span class="na">SayHello</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SayHello</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SayHello</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">SayHello</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">HelloWorldMain:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">Greet</span><span class="o">&gt;</span> <span class="n">greeter</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nf">HelloWorldMain</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">SayHello</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="n">greeter</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"greeter"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">SayHello</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">SayHello</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onStart</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">SayHello</span><span class="o">&gt;</span> <span class="nf">onStart</span><span class="o">(</span><span class="nc">SayHello</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">Greeted</span><span class="o">&gt;</span> <span class="n">replyTo</span> <span class="o">=</span>
        <span class="n">getContext</span><span class="o">().</span><span class="na">spawn</span><span class="o">(</span><span class="nc">HelloWorldBot</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span> <span class="n">command</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
    <span class="n">greeter</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">HelloWorld</span><span class="o">.</span><span class="na">Greet</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">));</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¦åœ¨ç”Ÿæˆactoræ—¶æŒ‡å®šdispatcherï¼Œè¯·ä½¿ç”¨<a href="https://doc.akka.io/japi/akka/2.6/akka/actor/typed/DispatcherSelector.html">DispatcherSelector</a>ã€‚å¦‚æœæœªæŒ‡å®šï¼Œåˆ™Actorå°†ä½¿ç”¨é»˜è®¤åˆ†æ´¾å™¨ï¼Œæœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…defaultåˆ†æ´¾å™¨ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldMain</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">HelloWorldMain</span><span class="o">.</span><span class="na">SayHello</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="c1">// Start message...</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">SayHello</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">HelloWorldMain:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">Greet</span><span class="o">&gt;</span> <span class="n">greeter</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nf">HelloWorldMain</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">SayHello</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>

    <span class="kd">final</span> <span class="nc">String</span> <span class="n">dispatcherPath</span> <span class="o">=</span> <span class="s">"akka.actor.default-blocking-io-dispatcher"</span><span class="o">;</span>
    <span class="nc">Props</span> <span class="n">greeterProps</span> <span class="o">=</span> <span class="nc">DispatcherSelector</span><span class="o">.</span><span class="na">fromConfig</span><span class="o">(</span><span class="n">dispatcherPath</span><span class="o">);</span>
    <span class="n">greeter</span> <span class="o">=</span> <span class="n">getContext</span><span class="o">().</span><span class="na">spawn</span><span class="o">(</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"greeter"</span><span class="o">,</span> <span class="n">greeterProps</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">// createReceive ...</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¯·å‚è€ƒ<a href="#422-">Actors</a>äº†è§£ä¸Šè¿°ç¤ºä¾‹çš„å¤§è‡´å†…å®¹ã€‚</p>

<h3 id="435-spawnåè®®">4.3.5. Spawnåè®®</h3>

<p>ç›‘æŠ¤Actoråº”è¯¥è´Ÿè´£ä»»åŠ¡çš„åˆå§‹åŒ–ï¼Œå¹¶åˆ›å»ºåº”ç”¨ç¨‹åºçš„åˆå§‹å‚Actorï¼Œä½†æœ‰æ—¶æ‚¨å¯èƒ½å¸Œæœ›ä»ç›‘æŠ¤å‚Actorçš„å¤–éƒ¨æ´¾ç”Ÿæ–°çš„å‚Actorã€‚ä¾‹å¦‚ï¼Œä¸ºæ¯ä¸ªHTTPè¯·æ±‚åˆ›å»ºä¸€ä¸ªactorã€‚</p>

<p>è¿™åœ¨æ‚¨çš„è¡Œä¸ºä¸­å¹¶ä¸éš¾å®ç°ï¼Œä½†æ˜¯ç”±äºè¿™æ˜¯ä¸€ç§å¸¸è§çš„æ¨¡å¼ï¼Œå› æ­¤æœ‰ä¸€ä¸ªé¢„å®šä¹‰çš„æ¶ˆæ¯åè®®å’Œè¡Œä¸ºå®ç°ã€‚å®ƒå¯ä»¥ä½œä¸ºè¡Œä¸ºäººç³»ç»Ÿçš„ç›‘æŠ¤è¡Œä¸ºäººï¼Œä¹Ÿå¯ä»¥ä¸è¡Œä¸ºç›¸ç»“åˆã€‚è®¾ç½®ä»¥å¯åŠ¨ä¸€äº›åˆå§‹ä»»åŠ¡æˆ–Actorã€‚ç„¶åå¯ä»¥é€šè¿‡å‘Šè¯‰æˆ–è¯¢é—®SpawnProtocolä»å¤–éƒ¨å¯åŠ¨å­actorã€‚è¡ç”Ÿåˆ°ç³»ç»Ÿçš„actorå¼•ç”¨ã€‚ä½¿ç”¨askç±»ä¼¼äºå¦‚ä½•ActorSystem.actorOfå¯ä»¥åœ¨ç»å…¸çš„actorä¸­ä½¿ç”¨ï¼ŒåŒºåˆ«åœ¨äºè¿”å›ActorRefçš„CompletionStageã€‚</p>

<p>ç›‘æŠ¤äººè¡Œä¸ºå¯ä»¥å®šä¹‰ä¸º:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">akka.actor.typed.Behavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.SpawnProtocol</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Behaviors</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">HelloWorldMain</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nf">HelloWorldMain</span><span class="o">()</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">SpawnProtocol</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span>
        <span class="n">context</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="c1">// Start initial tasks</span>
          <span class="c1">// context.spawn(...)</span>

          <span class="k">return</span> <span class="nc">SpawnProtocol</span><span class="o">.</span><span class="na">create</span><span class="o">();</span>
        <span class="o">});</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å’ŒActorSystemå¯ä»¥åˆ›å»ºä¸ä¸»è¡Œä¸ºå’Œè¦æ±‚è¡ç”Ÿå…¶ä»–Actor:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">akka.actor.typed.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorSystem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.Props</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.AskPattern</span><span class="o">;</span>

<span class="kd">final</span> <span class="nc">ActorSystem</span><span class="o">&lt;</span><span class="nc">SpawnProtocol</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">system</span> <span class="o">=</span>
    <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">HelloWorldMain</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"hello"</span><span class="o">);</span>
<span class="kd">final</span> <span class="nc">Duration</span> <span class="n">timeout</span> <span class="o">=</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>

<span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">Greet</span><span class="o">&gt;&gt;</span> <span class="n">greeter</span> <span class="o">=</span>
    <span class="nc">AskPattern</span><span class="o">.</span><span class="na">ask</span><span class="o">(</span>
        <span class="n">system</span><span class="o">,</span>
        <span class="n">replyTo</span> <span class="o">-&gt;</span>
            <span class="k">new</span> <span class="nc">SpawnProtocol</span><span class="o">.</span><span class="na">Spawn</span><span class="o">&lt;&gt;(</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"greeter"</span><span class="o">,</span> <span class="nc">Props</span><span class="o">.</span><span class="na">empty</span><span class="o">(),</span> <span class="n">replyTo</span><span class="o">),</span>
        <span class="n">timeout</span><span class="o">,</span>
        <span class="n">system</span><span class="o">.</span><span class="na">scheduler</span><span class="o">());</span>

<span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">Greeted</span><span class="o">&gt;</span> <span class="n">greetedBehavior</span> <span class="o">=</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span>
        <span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">message</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="n">context</span><span class="o">.</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Greeting for {} from {}"</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">whom</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">from</span><span class="o">);</span>
          <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">stopped</span><span class="o">();</span>
        <span class="o">});</span>

<span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">HelloWorld</span><span class="o">.</span><span class="na">Greeted</span><span class="o">&gt;&gt;</span> <span class="n">greetedReplyTo</span> <span class="o">=</span>
    <span class="nc">AskPattern</span><span class="o">.</span><span class="na">ask</span><span class="o">(</span>
        <span class="n">system</span><span class="o">,</span>
        <span class="n">replyTo</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">SpawnProtocol</span><span class="o">.</span><span class="na">Spawn</span><span class="o">&lt;&gt;(</span><span class="n">greetedBehavior</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="nc">Props</span><span class="o">.</span><span class="na">empty</span><span class="o">(),</span> <span class="n">replyTo</span><span class="o">),</span>
        <span class="n">timeout</span><span class="o">,</span>
        <span class="n">system</span><span class="o">.</span><span class="na">scheduler</span><span class="o">());</span>

<span class="n">greeter</span><span class="o">.</span><span class="na">whenComplete</span><span class="o">(</span>
    <span class="o">(</span><span class="n">greeterRef</span><span class="o">,</span> <span class="n">exc</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">exc</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">greetedReplyTo</span><span class="o">.</span><span class="na">whenComplete</span><span class="o">(</span>
            <span class="o">(</span><span class="n">greetedReplyToRef</span><span class="o">,</span> <span class="n">exc2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">exc2</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">greeterRef</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">HelloWorld</span><span class="o">.</span><span class="na">Greet</span><span class="o">(</span><span class="s">"Akka"</span><span class="o">,</span> <span class="n">greetedReplyToRef</span><span class="o">));</span>
              <span class="o">}</span>
            <span class="o">});</span>
      <span class="o">}</span>
    <span class="o">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>SpawnProtocolä¹Ÿå¯ä»¥åœ¨actorå±‚æ¬¡ç»“æ„çš„å…¶ä»–åœ°æ–¹ä½¿ç”¨ã€‚å®ƒä¸å¿…æ˜¯æ ¹å®ˆæŠ¤è§’è‰²ã€‚</p>

<p>åœ¨<a href="https://doc.akka.io/docs/akka/current/typed/actor-discovery.html">Actorå‘ç°</a>ä¸­æè¿°äº†æŸ¥æ‰¾è¿è¡ŒActorçš„æ–¹æ³•ã€‚</p>

<h3 id="436-åœæ­¢actor">4.3.6. åœæ­¢Actor</h3>

<p>ä¸€ä¸ªactorå¯ä»¥é€šè¿‡è¿”å›æ¥åœæ­¢è‡ªå·±Behaviors.stoppedä½œä¸ºä¸‹ä¸€ä¸ªè¡Œä¸ºã€‚</p>

<p>é€šè¿‡ä½¿ç”¨çˆ¶actorçš„ActorContextçš„stopæ–¹æ³•ï¼Œå¯ä»¥å¼ºåˆ¶å­actoråœ¨å¤„ç†å®Œå½“å‰æ¶ˆæ¯ååœæ­¢ã€‚åªæœ‰å­Actorså¯ä»¥ç”¨è¿™ç§æ–¹å¼åœæ­¢ã€‚</p>

<p>æ‰€æœ‰çš„å­Actorå°†åœ¨å…¶çˆ¶Actorè¢«åœæ­¢æ—¶åœæ­¢ã€‚</p>

<p>å½“ä¸€ä¸ªactoråœæ­¢æ—¶ï¼Œå®ƒä¼šæ¥æ”¶åˆ°ä¸€ä¸ªPostStopä¿¡å·ï¼Œè¿™ä¸ªä¿¡å·å¯ä»¥ç”¨æ¥æ¸…ç†èµ„æºã€‚ä¸€ä¸ªå›è°ƒå‡½æ•°å¯ä»¥è¢«æŒ‡å®šä¸ºè¡Œä¸ºçš„å‚æ•°ã€‚åœ¨ä¼˜é›…åœæ­¢æ—¶å¤„ç†PostStopä¿¡å·ã€‚è¿™å…è®¸åœ¨çªç„¶åœæ­¢æ—¶åº”ç”¨ä¸åŒçš„æ“ä½œã€‚</p>

<p>ä¸‹é¢ä¸€ä¸ªåœæ­¢actorä¾‹å­ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorSystem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.Behavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.PostStop</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.AbstractBehavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.ActorContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Behaviors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Receive</span><span class="o">;</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MasterControlProgram</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">MasterControlProgram</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">SpawnJob</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SpawnJob</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">enum</span> <span class="nc">GracefulShutdown</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="no">INSTANCE</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">MasterControlProgram:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nf">MasterControlProgram</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">SpawnJob</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onSpawnJob</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">GracefulShutdown</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">message</span> <span class="o">-&gt;</span> <span class="n">onGracefulShutdown</span><span class="o">())</span>
        <span class="o">.</span><span class="na">onSignal</span><span class="o">(</span><span class="nc">PostStop</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">signal</span> <span class="o">-&gt;</span> <span class="n">onPostStop</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onSpawnJob</span><span class="o">(</span><span class="nc">SpawnJob</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getSystem</span><span class="o">().</span><span class="na">log</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Spawning job {}!"</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">spawn</span><span class="o">(</span><span class="nc">Job</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">name</span><span class="o">),</span> <span class="n">message</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onGracefulShutdown</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getSystem</span><span class="o">().</span><span class="na">log</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Initiating graceful shutdown..."</span><span class="o">);</span>

    <span class="c1">// perform graceful stop, executing cleanup before final system termination</span>
    <span class="c1">// behavior executing cleanup is passed as a parameter to Actor.stopped</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">stopped</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">getContext</span><span class="o">().</span><span class="na">getSystem</span><span class="o">().</span><span class="na">log</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Cleanup!"</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onPostStop</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getSystem</span><span class="o">().</span><span class="na">log</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Master Control Program stopped"</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Job</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Job</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="n">context</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">Job</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">name</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Job</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Job</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onSignal</span><span class="o">(</span><span class="nc">PostStop</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">postStop</span> <span class="o">-&gt;</span> <span class="n">onPostStop</span><span class="o">()).</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onPostStop</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getSystem</span><span class="o">().</span><span class="na">log</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Worker {} stopped"</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">final</span> <span class="nc">ActorSystem</span><span class="o">&lt;</span><span class="nc">MasterControlProgram</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">system</span> <span class="o">=</span>
    <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">MasterControlProgram</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"B6700"</span><span class="o">);</span>

<span class="n">system</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">MasterControlProgram</span><span class="o">.</span><span class="na">SpawnJob</span><span class="o">(</span><span class="s">"a"</span><span class="o">));</span>
<span class="n">system</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">MasterControlProgram</span><span class="o">.</span><span class="na">SpawnJob</span><span class="o">(</span><span class="s">"b"</span><span class="o">));</span>

<span class="c1">// sleep here to allow time for the new actors to be started</span>
<span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>

<span class="n">system</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="nc">MasterControlProgram</span><span class="o">.</span><span class="na">GracefulShutdown</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>

<span class="n">system</span><span class="o">.</span><span class="na">getWhenTerminated</span><span class="o">().</span><span class="na">toCompletableFuture</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨ä»PostStopæ¸…ç†èµ„æºæ—¶ï¼Œæ‚¨è¿˜åº”è¯¥è€ƒè™‘å¯¹PreRestartä¿¡å·æ‰§è¡Œç›¸åŒçš„æ“ä½œï¼Œè¯¥ä¿¡å·æ˜¯åœ¨actoré‡æ–°å¯åŠ¨æ—¶å‘å‡ºçš„ã€‚æ³¨æ„ï¼ŒPostStopä¸æ˜¯ä¸ºé‡æ–°å¯åŠ¨è€Œå‘å‡ºçš„ã€‚</p>

<h3 id="437-watching-actors">4.3.7. Watching Actors</h3>

<p>ä¸ºäº†åœ¨å¦ä¸€ä¸ªactorç»ˆæ­¢æ—¶å¾—åˆ°é€šçŸ¥(å³æ°¸ä¹…åœæ­¢ï¼Œè€Œä¸æ˜¯ä¸´æ—¶å¤±è´¥å¹¶é‡æ–°å¯åŠ¨)ï¼Œä¸€ä¸ªactorå¯ä»¥ç›‘è§†å¦ä¸€ä¸ªactorã€‚è¢«è§‚å¯ŸActorçš„ç»ˆæ­¢(è¯·æŸ¥çœ‹<a href="#436-åœæ­¢Acto">åœæ­¢Actor</a>)æ—¶ï¼Œå°†æ”¶åˆ°ç»ˆæ­¢ä¿¡å·ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MasterControlProgram</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">MasterControlProgram</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">SpawnJob</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SpawnJob</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">MasterControlProgram:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nf">MasterControlProgram</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">SpawnJob</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onSpawnJob</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onSignal</span><span class="o">(</span><span class="nc">Terminated</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onTerminated</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onSpawnJob</span><span class="o">(</span><span class="nc">SpawnJob</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getSystem</span><span class="o">().</span><span class="na">log</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Spawning job {}!"</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
    <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Job</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">job</span> <span class="o">=</span> <span class="n">getContext</span><span class="o">().</span><span class="na">spawn</span><span class="o">(</span><span class="nc">Job</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">name</span><span class="o">),</span> <span class="n">message</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">watch</span><span class="o">(</span><span class="n">job</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onTerminated</span><span class="o">(</span><span class="nc">Terminated</span> <span class="n">terminated</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getSystem</span><span class="o">().</span><span class="na">log</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Job stopped: {}"</span><span class="o">,</span> <span class="n">terminated</span><span class="o">.</span><span class="na">getRef</span><span class="o">().</span><span class="na">path</span><span class="o">().</span><span class="na">name</span><span class="o">());</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç›‘è§†çš„å¦ä¸€ç§æ–¹æ³•æ˜¯watchWithï¼Œå®ƒå…è®¸æŒ‡å®šè‡ªå®šä¹‰æ¶ˆæ¯è€Œä¸æ˜¯ç»ˆæ­¢æ¶ˆæ¯ã€‚è¿™é€šå¸¸æ¯”ä½¿ç”¨watchå’Œç»ˆæ­¢ä¿¡å·æ›´å¯å–ï¼Œå› ä¸ºå¯ä»¥åœ¨æ¶ˆæ¯ä¸­åŒ…å«å…¶ä»–ä¿¡æ¯ï¼Œä»¥ä¾¿ç¨åæ¥æ”¶æ—¶ä½¿ç”¨ã€‚</p>

<p>ä¸ä¸Šé¢çš„ç¤ºä¾‹ç±»ä¼¼ï¼Œä½†æ˜¯åœ¨ä»»åŠ¡å®Œæˆæ—¶ä½¿ç”¨watchWithå¹¶å¯¹åŸå§‹è¯·æ±‚è€…è¿›è¡Œåº”ç­”ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MasterControlProgram</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">MasterControlProgram</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">SpawnJob</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">JobDone</span><span class="o">&gt;</span> <span class="n">replyToWhenDone</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SpawnJob</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">JobDone</span><span class="o">&gt;</span> <span class="n">replyToWhenDone</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyToWhenDone</span> <span class="o">=</span> <span class="n">replyToWhenDone</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">JobDone</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">JobDone</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">JobTerminated</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">JobDone</span><span class="o">&gt;</span> <span class="n">replyToWhenDone</span><span class="o">;</span>

    <span class="nc">JobTerminated</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">JobDone</span><span class="o">&gt;</span> <span class="n">replyToWhenDone</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyToWhenDone</span> <span class="o">=</span> <span class="n">replyToWhenDone</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">MasterControlProgram:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nf">MasterControlProgram</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">SpawnJob</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onSpawnJob</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">JobTerminated</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onJobTerminated</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onSpawnJob</span><span class="o">(</span><span class="nc">SpawnJob</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getSystem</span><span class="o">().</span><span class="na">log</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Spawning job {}!"</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
    <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Job</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">job</span> <span class="o">=</span> <span class="n">getContext</span><span class="o">().</span><span class="na">spawn</span><span class="o">(</span><span class="nc">Job</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">name</span><span class="o">),</span> <span class="n">message</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">watchWith</span><span class="o">(</span><span class="n">job</span><span class="o">,</span> <span class="k">new</span> <span class="nc">JobTerminated</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">replyToWhenDone</span><span class="o">));</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onJobTerminated</span><span class="o">(</span><span class="nc">JobTerminated</span> <span class="n">terminated</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getSystem</span><span class="o">().</span><span class="na">log</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Job stopped: {}"</span><span class="o">,</span> <span class="n">terminated</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
    <span class="n">terminated</span><span class="o">.</span><span class="na">replyToWhenDone</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">JobDone</span><span class="o">(</span><span class="n">terminated</span><span class="o">.</span><span class="na">name</span><span class="o">));</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¯·æ³¨æ„replyToWhenDoneæ˜¯å¦‚ä½•åŒ…å«åœ¨watchWithæ¶ˆæ¯ä¸­ï¼Œç„¶ååœ¨ç¨åæ¥æ”¶ç»ˆæ­¢ä½œä¸šçš„æ¶ˆæ¯æ—¶ä½¿ç”¨çš„ã€‚</p>

<p>è¢«è§‚å¯Ÿçš„actorå¯ä»¥æ˜¯ä»»ä½•ActorRefï¼Œå®ƒä¸å¿…æ˜¯ä¸Šé¢ç¤ºä¾‹ä¸­çš„å­actorã€‚</p>

<p>åº”è¯¥æ³¨æ„ï¼Œç»ˆæ­¢æ¶ˆæ¯çš„ç”Ÿæˆä¸æ³¨å†Œå’Œç»ˆæ­¢å‘ç”Ÿçš„é¡ºåºæ— å…³ã€‚ç‰¹åˆ«æ˜¯ï¼Œå³ä½¿è¢«ç›‘è§†çš„Actoråœ¨æ³¨å†Œæ—¶å·²ç»è¢«ç»ˆæ­¢ï¼Œç›‘è§†çš„Actorä¹Ÿä¼šæ”¶åˆ°ç»ˆæ­¢æ¶ˆæ¯ã€‚</p>

<p>å¤šæ¬¡æ³¨å†Œå¹¶ä¸ä¸€å®šå¯¼è‡´äº§ç”Ÿå¤šæ¡æ¶ˆæ¯,ä½†æ²¡æœ‰ä¿è¯åªæœ‰ä¸€ä¸ªæ”¶åˆ°è¿™æ ·çš„æ¶ˆæ¯:å¦‚æœç»ˆæ­¢è§‚çœ‹æ¼”å‘˜çš„ç”Ÿæˆå’Œæ¶ˆæ¯æ’é˜Ÿ,å’Œå¦ä¸€ä¸ªæ³¨å†Œè¿™ä¸ªæ¶ˆæ¯è¢«å¤„ç†ä¹‹å‰å®Œæˆ,ç„¶åç¬¬äºŒä¸ªæ¶ˆæ¯å°†è¢«æ’é˜Ÿ,å› ä¸ºæ³¨å†Œçš„ç›‘æ§å·²ç»ç»ˆæ­¢çš„æ¼”å‘˜ä¼šå¯¼è‡´ç«‹å³ç»ˆæ­¢æ¶ˆæ¯çš„ä¸€ä»£ã€‚</p>

<p>å®ƒä¹Ÿå¯ä»¥å–æ¶ˆè§‚çœ‹å¦ä¸€ä¸ªæ¼”å‘˜çš„åŠ¨æ€ä½¿ç”¨èƒŒæ™¯ã€‚unwatch(ç›®æ ‡)ã€‚å³ä½¿ç»ˆæ­¢çš„æ¶ˆæ¯å·²ç»åœ¨é‚®ç®±ä¸­æ’é˜Ÿï¼Œè¿™ä¹Ÿå¯ä»¥å·¥ä½œ;åœ¨è°ƒç”¨unwatchåï¼Œä¸ä¼šå†å¤„ç†è¯¥actorçš„ç»ˆæ­¢æ¶ˆæ¯ã€‚</p>

<p>å½“è¢«ç›‘è§†çš„actorä½äºå·²ä»<a href="https://doc.akka.io/docs/akka/current/typed/cluster.html">é›†ç¾¤</a>ä¸­åˆ é™¤çš„èŠ‚ç‚¹ä¸Šæ—¶ï¼Œä¹Ÿä¼šå‘é€ç»ˆæ­¢çš„æ¶ˆæ¯ã€‚</p>

<h2 id="44-äº’åŠ¨æ¨¡å¼">4.4. äº’åŠ¨æ¨¡å¼</h2>

<h3 id="441-ç®€ä»‹">4.4.1. ç®€ä»‹</h3>

<p>åœ¨Akkaä¸­ä¸Actorçš„äº¤äº’æ˜¯é€šè¿‡ActorRef<T>å®Œæˆçš„ï¼Œå…¶ä¸­Tæ˜¯Actoræ¥å—çš„æ¶ˆæ¯ç±»å‹ï¼Œä¹Ÿç§°ä¸ºâ€œåè®®â€ã€‚è¿™ç¡®ä¿äº†åªæœ‰æ­£ç¡®ç±»å‹çš„æ¶ˆæ¯å¯ä»¥å‘é€ç»™actorï¼Œè€Œä¸”é™¤äº†actoræœ¬èº«ä¹‹å¤–ï¼Œæ²¡æœ‰å…¶ä»–äººå¯ä»¥è®¿é—®actorå®ä¾‹çš„å†…éƒ¨ã€‚</T></p>

<p>ä¸Actorçš„æ¶ˆæ¯äº¤æ¢éµå¾ªä¸€äº›å¸¸è§çš„æ¨¡å¼ï¼Œè®©æˆ‘ä»¬é€ä¸€ä»‹ç»å…¶ä¸­çš„æ¯ä¸€ä¸ªæ¨¡å¼ã€‚</p>

<h3 id="442-fire-forget">4.4.2. Fire-forget</h3>

<p>ä¸Actoräº¤äº’çš„åŸºæœ¬æ–¹æ³•æ˜¯é€šè¿‡actorRef.tell(message)ã€‚ä½¿ç”¨tellå‘é€æ¶ˆæ¯å¯ä»¥ä»ä»»ä½•çº¿ç¨‹å®‰å…¨åœ°å®Œæˆã€‚</p>

<p>Tellæ˜¯å¼‚æ­¥çš„ï¼Œè¿™æ„å‘³ç€è¯¥æ–¹æ³•ç«‹å³è¿”å›ã€‚è¯­å¥æ‰§è¡Œåï¼Œä¸èƒ½ä¿è¯æ¥æ”¶æ–¹å·²ç»å¤„ç†äº†æ¶ˆæ¯ã€‚å®ƒè¿˜æ„å‘³ç€æ— æ³•çŸ¥é“æ¶ˆæ¯æ˜¯å¦è¢«æ¥æ”¶ã€å¤„ç†æ˜¯å¦æˆåŠŸã€‚</p>

<p>Example:</p>

<p><img src="https://liulv.work/images/img/20200805205635.png" alt="20200805205635" /></p>

<p>ç»™å®šåè®®å’ŒActorè¡Œä¸º:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Printer</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">PrintMe</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">message</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">PrintMe</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">PrintMe</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span>
        <span class="n">context</span> <span class="o">-&gt;</span>
            <span class="nc">Behaviors</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="nc">PrintMe</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span>
                    <span class="nc">PrintMe</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                    <span class="n">printMe</span> <span class="o">-&gt;</span> <span class="o">{</span>
                      <span class="n">context</span><span class="o">.</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="n">printMe</span><span class="o">.</span><span class="na">message</span><span class="o">);</span>
                      <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
                    <span class="o">})</span>
                <span class="o">.</span><span class="na">build</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¼‚æ­¥å‘é€æ¶ˆæ¯å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kd">final</span> <span class="nc">ActorSystem</span><span class="o">&lt;</span><span class="nc">Printer</span><span class="o">.</span><span class="na">PrintMe</span><span class="o">&gt;</span> <span class="n">system</span> <span class="o">=</span>
    <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">Printer</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"printer-sample-system"</span><span class="o">);</span>

<span class="c1">// note that system is also the ActorRef to the guardian actor</span>
<span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Printer</span><span class="o">.</span><span class="na">PrintMe</span><span class="o">&gt;</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">system</span><span class="o">;</span>

<span class="c1">// these are all fire and forget</span>
<span class="n">ref</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Printer</span><span class="o">.</span><span class="na">PrintMe</span><span class="o">(</span><span class="s">"message 1"</span><span class="o">));</span>
<span class="n">ref</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Printer</span><span class="o">.</span><span class="na">PrintMe</span><span class="o">(</span><span class="s">"message 2"</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>æœ‰ç”¨çš„æ—¶å€™ï¼š</strong></p>

<ul>
  <li>ç¡®ä¿æ¶ˆæ¯å·²è¢«å¤„ç†å¹¶ä¸é‡è¦</li>
  <li>æ²¡æœ‰åŠæ³•å¯¹ä¸æˆåŠŸçš„äº¤ä»˜æˆ–å¤„ç†é‡‡å–è¡ŒåŠ¨</li>
  <li>æˆ‘ä»¬å¸Œæœ›æœ€å°åŒ–åˆ›å»ºçš„æ¶ˆæ¯æ•°é‡ï¼Œä»¥è·å¾—æ›´é«˜çš„ååé‡(å‘é€å“åº”å°†éœ€è¦åˆ›å»ºä¸¤å€äºæ­¤çš„æ¶ˆæ¯æ•°é‡)</li>
</ul>

<p><strong>å­˜åœ¨é—®é¢˜ï¼š</strong></p>

<ul>
  <li>å¦‚æœæ¶ˆæ¯çš„æµå…¥è¶…è¿‡äº†Actorçš„å¤„ç†èƒ½åŠ›ï¼Œé‚£ä¹ˆæ”¶ä»¶ç®±å°†è¢«å¡«æ»¡ï¼Œåœ¨æœ€åçš„æƒ…å†µä¸‹ä¼šå¯¼è‡´JVMå´©æºƒï¼Œå¹¶äº§ç”ŸOutOfMemoryErroré”™è¯¯</li>
  <li>å¦‚æœæ¶ˆæ¯ä¸¢å¤±ï¼Œå‘é€è€…å°†ä¸çŸ¥é“</li>
</ul>

<h3 id="443-è¯·æ±‚-å“åº”">4.4.3. è¯·æ±‚-å“åº”</h3>

<p>Actorä¹‹é—´çš„è®¸å¤šäº¤äº’éƒ½éœ€è¦ä»æ¥æ”¶Actorå‘å›ä¸€æ¡æˆ–å¤šæ¡å“åº”æ¶ˆæ¯ã€‚å“åº”æ¶ˆæ¯å¯ä»¥æ˜¯æŸ¥è¯¢çš„ç»“æœã€æ¥æ”¶å’Œå¤„ç†æ¶ˆæ¯çš„æŸç§å½¢å¼çš„ç¡®è®¤æˆ–è¯·æ±‚è®¢é˜…çš„äº‹ä»¶ã€‚</p>

<p>åœ¨Akkaä¸­ï¼Œå“åº”çš„æ¥æ”¶æ–¹å¿…é¡»è¢«ç¼–ç ä¸ºæ¶ˆæ¯æœ¬èº«ä¸­çš„ä¸€ä¸ªå­—æ®µï¼Œç„¶åæ¥æ”¶æ–¹å¯ä»¥ä½¿ç”¨è¯¥å­—æ®µå‘é€(å‘ŠçŸ¥)å›å“åº”ã€‚</p>

<p>Example:</p>

<p><img src="https://liulv.work/images/img/20200805210650.png" alt="20200805210650" /></p>

<p>æ ¹æ®ä»¥ä¸‹åè®®:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Request</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">query</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Response</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Request</span><span class="o">(</span><span class="nc">String</span> <span class="n">query</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Response</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Response</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">result</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Response</span><span class="o">(</span><span class="nc">String</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å‘é€æ–¹å°†ä½¿ç”¨è‡ªå·±çš„ActorRef<Response>ï¼Œå®ƒå¯ä»¥é€šè¿‡ActorContext.getSelf()å¯¹replyToè¿›è¡Œè®¿é—®ã€‚</Response></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">cookieFabric</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Request</span><span class="o">(</span><span class="s">"give me cookies"</span><span class="o">,</span> <span class="n">context</span><span class="o">.</span><span class="na">getSelf</span><span class="o">()));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨æ¥æ”¶æ–¹çš„ActorRef<Response>å¯ä»¥ç”¨æ¥å‘é€ä¸€ä¸ªæˆ–å¤šä¸ªå“åº”å›æ¥:</Response></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="c1">// actor behavior</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Request</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="nc">Request</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
      <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Request</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nl">CookieFabric:</span><span class="o">:</span><span class="n">onRequest</span><span class="o">)</span>
      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Request</span><span class="o">&gt;</span> <span class="nf">onRequest</span><span class="o">(</span><span class="nc">Request</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// ... process request ...</span>
  <span class="n">request</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Response</span><span class="o">(</span><span class="s">"Here are the cookies for "</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">query</span><span class="o">));</span>
  <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœ‰ç”¨çš„æ—¶å€™:</p>

<p>è®¢é˜…å°†å‘å›è®¸å¤šå“åº”æ¶ˆæ¯çš„Actor</p>

<p>é¢ä¸´é—®é¢˜ï¼š</p>

<ul>
  <li>Actorå¾ˆå°‘æœ‰æ¥è‡ªå¦ä¸€ä¸ªActorçš„å“åº”æ¶ˆæ¯ä½œä¸ºå…¶åè®®çš„ä¸€éƒ¨åˆ†(å‚è§<a href="https://doc.akka.io/docs/akka/current/typed/interaction-patterns.html#adapted-response">é€‚åº”å“åº”</a>)</li>
  <li>å¾ˆéš¾æ£€æµ‹åˆ°æ²¡æœ‰å‘é€æˆ–å¤„ç†æ¶ˆæ¯è¯·æ±‚(å‚è§<a href="https://doc.akka.io/docs/akka/current/typed/interaction-patterns.html#request-response-with-ask-between-two-actors">ask</a>)</li>
  <li>é™¤éåè®®å·²ç»åŒ…å«äº†æä¾›ä¸Šä¸‹æ–‡çš„æ–¹æ³•ï¼Œä¾‹å¦‚åœ¨å“åº”ä¸­å‘é€çš„è¯·æ±‚idï¼Œå¦åˆ™ä¸å¯èƒ½åœ¨ä¸å¼•å…¥æ–°çš„ã€å•ç‹¬çš„Actorçš„æƒ…å†µä¸‹å°†äº¤äº’ä¸ç‰¹å®šçš„ä¸Šä¸‹æ–‡ç»‘å®š(å‚è§askæˆ–<a href="https://doc.akka.io/docs/akka/current/typed/interaction-patterns.html#per-session-child-actor">per sessionå­Actor</a>)ã€‚</li>
</ul>

<h3 id="444-é€‚åº”å“åº”">4.4.4. é€‚åº”å“åº”</h3>

<p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå‘é€actorä¸æ”¯æŒï¼Œä¹Ÿä¸åº”è¯¥æ”¯æŒæ¥æ”¶å¦ä¸€ä¸ªactorçš„å“åº”æ¶ˆæ¯ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦æä¾›æ­£ç¡®ç±»å‹çš„ActorRefï¼Œå¹¶å°†å“åº”æ¶ˆæ¯è°ƒæ•´ä¸ºå‘é€actorå¯ä»¥å¤„ç†çš„ç±»å‹ã€‚</p>

<p>Example:</p>

<p><img src="https://liulv.work/images/img/20200805212210.png" alt="20200805212210" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Backend</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Request</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">StartTranslationJob</span> <span class="kd">implements</span> <span class="nc">Request</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">taskId</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="no">URI</span> <span class="n">site</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Response</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">StartTranslationJob</span><span class="o">(</span><span class="kt">int</span> <span class="n">taskId</span><span class="o">,</span> <span class="no">URI</span> <span class="n">site</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Response</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">taskId</span> <span class="o">=</span> <span class="n">taskId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">site</span> <span class="o">=</span> <span class="n">site</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Response</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">JobStarted</span> <span class="kd">implements</span> <span class="nc">Response</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">taskId</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">JobStarted</span><span class="o">(</span><span class="kt">int</span> <span class="n">taskId</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">taskId</span> <span class="o">=</span> <span class="n">taskId</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">JobProgress</span> <span class="kd">implements</span> <span class="nc">Response</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">taskId</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">double</span> <span class="n">progress</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">JobProgress</span><span class="o">(</span><span class="kt">int</span> <span class="n">taskId</span><span class="o">,</span> <span class="kt">double</span> <span class="n">progress</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">taskId</span> <span class="o">=</span> <span class="n">taskId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">progress</span> <span class="o">=</span> <span class="n">progress</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">JobCompleted</span> <span class="kd">implements</span> <span class="nc">Response</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">taskId</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="no">URI</span> <span class="n">result</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">JobCompleted</span><span class="o">(</span><span class="kt">int</span> <span class="n">taskId</span><span class="o">,</span> <span class="no">URI</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">taskId</span> <span class="o">=</span> <span class="n">taskId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Frontend</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Translate</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="no">URI</span> <span class="n">site</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="no">URI</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Translate</span><span class="o">(</span><span class="no">URI</span> <span class="n">site</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="no">URI</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">site</span> <span class="o">=</span> <span class="n">site</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">WrappedBackendResponse</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">Backend</span><span class="o">.</span><span class="na">Response</span> <span class="n">response</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">WrappedBackendResponse</span><span class="o">(</span><span class="nc">Backend</span><span class="o">.</span><span class="na">Response</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Translator</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Backend</span><span class="o">.</span><span class="na">Request</span><span class="o">&gt;</span> <span class="n">backend</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Backend</span><span class="o">.</span><span class="na">Response</span><span class="o">&gt;</span> <span class="n">backendResponseAdapter</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">taskIdCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="no">URI</span><span class="o">&gt;&gt;</span> <span class="n">inProgress</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

    <span class="kd">public</span> <span class="nf">Translator</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Backend</span><span class="o">.</span><span class="na">Request</span><span class="o">&gt;</span> <span class="n">backend</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">backend</span> <span class="o">=</span> <span class="n">backend</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">backendResponseAdapter</span> <span class="o">=</span>
          <span class="n">context</span><span class="o">.</span><span class="na">messageAdapter</span><span class="o">(</span><span class="nc">Backend</span><span class="o">.</span><span class="na">Response</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nl">WrappedBackendResponse:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
          <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Translate</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onTranslate</span><span class="o">)</span>
          <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">WrappedBackendResponse</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onWrappedBackendResponse</span><span class="o">)</span>
          <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onTranslate</span><span class="o">(</span><span class="nc">Translate</span> <span class="n">cmd</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">taskIdCounter</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">;</span>
      <span class="n">inProgress</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">taskIdCounter</span><span class="o">,</span> <span class="n">cmd</span><span class="o">.</span><span class="na">replyTo</span><span class="o">);</span>
      <span class="n">backend</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span>
          <span class="k">new</span> <span class="nc">Backend</span><span class="o">.</span><span class="na">StartTranslationJob</span><span class="o">(</span><span class="n">taskIdCounter</span><span class="o">,</span> <span class="n">cmd</span><span class="o">.</span><span class="na">site</span><span class="o">,</span> <span class="n">backendResponseAdapter</span><span class="o">));</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onWrappedBackendResponse</span><span class="o">(</span><span class="nc">WrappedBackendResponse</span> <span class="n">wrapped</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Backend</span><span class="o">.</span><span class="na">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">wrapped</span><span class="o">.</span><span class="na">response</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">response</span> <span class="k">instanceof</span> <span class="nc">Backend</span><span class="o">.</span><span class="na">JobStarted</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Backend</span><span class="o">.</span><span class="na">JobStarted</span> <span class="n">rsp</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Backend</span><span class="o">.</span><span class="na">JobStarted</span><span class="o">)</span> <span class="n">response</span><span class="o">;</span>
        <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Started {}"</span><span class="o">,</span> <span class="n">rsp</span><span class="o">.</span><span class="na">taskId</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">response</span> <span class="k">instanceof</span> <span class="nc">Backend</span><span class="o">.</span><span class="na">JobProgress</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Backend</span><span class="o">.</span><span class="na">JobProgress</span> <span class="n">rsp</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Backend</span><span class="o">.</span><span class="na">JobProgress</span><span class="o">)</span> <span class="n">response</span><span class="o">;</span>
        <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Progress {}"</span><span class="o">,</span> <span class="n">rsp</span><span class="o">.</span><span class="na">taskId</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">response</span> <span class="k">instanceof</span> <span class="nc">Backend</span><span class="o">.</span><span class="na">JobCompleted</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Backend</span><span class="o">.</span><span class="na">JobCompleted</span> <span class="n">rsp</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Backend</span><span class="o">.</span><span class="na">JobCompleted</span><span class="o">)</span> <span class="n">response</span><span class="o">;</span>
        <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Completed {}"</span><span class="o">,</span> <span class="n">rsp</span><span class="o">.</span><span class="na">taskId</span><span class="o">);</span>
        <span class="n">inProgress</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">rsp</span><span class="o">.</span><span class="na">taskId</span><span class="o">).</span><span class="na">tell</span><span class="o">(</span><span class="n">rsp</span><span class="o">.</span><span class="na">result</span><span class="o">);</span>
        <span class="n">inProgress</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">rsp</span><span class="o">.</span><span class="na">taskId</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">unhandled</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ‚¨å¯ä»¥ä¸ºä¸åŒçš„æ¶ˆæ¯ç±»æ³¨å†Œå¤šä¸ªæ¶ˆæ¯é€‚é…å™¨ã€‚æ¯ä¸ªæ¶ˆæ¯ç±»åªèƒ½æœ‰ä¸€ä¸ªæ¶ˆæ¯é€‚é…å™¨ï¼Œä»¥ç¡®ä¿é‡å¤æ³¨å†Œåé€‚é…å™¨çš„æ•°é‡ä¸ä¼šæ— é™åˆ¶åœ°å¢é•¿ã€‚è¿™ä¹Ÿæ„å‘³ç€æ³¨å†Œçš„é€‚é…å™¨å°†æ›¿æ¢åŒä¸€æ¶ˆæ¯ç±»çš„ç°æœ‰é€‚é…å™¨ã€‚</p>

<p>å¦‚æœæ¶ˆæ¯ç±»ä¸ç»™å®šçš„ç±»åŒ¹é…ï¼Œæˆ–è€…æ˜¯è¯¥ç±»çš„å­ç±»ï¼Œåˆ™å°†ä½¿ç”¨æ¶ˆæ¯é€‚é…å™¨ã€‚å·²æ³¨å†Œçš„é€‚é…å™¨å°†æŒ‰ç…§ä¸å®ƒä»¬çš„æ³¨å†Œé¡ºåºç›¸åçš„é¡ºåºè¿›è¡Œå°è¯•ï¼Œå³æœ€åä¸€ä¸ªå…ˆæ³¨å†Œã€‚</p>

<p>æ¶ˆæ¯é€‚é…å™¨(ä»¥åŠè¿”å›çš„ActorRef)å…·æœ‰ä¸æ¥æ”¶actorç›¸åŒçš„ç”Ÿå‘½å‘¨æœŸã€‚å»ºè®®åœ¨é¡¶çº§çš„Behaviors.setupä¸­æ³¨å†Œé€‚é…å™¨ã€‚AbstractBehaviorçš„è®¾ç½®æˆ–æ„é€ å‡½æ•°ï¼Œä½†å¦‚æœéœ€è¦ï¼Œå¯ä»¥ç¨åæ³¨å†Œå®ƒä»¬ã€‚</p>

<p>é€‚é…å™¨å‡½æ•°åœ¨æ¥æ”¶actorä¸­è¿è¡Œï¼Œå¯ä»¥å®‰å…¨åœ°è®¿é—®å®ƒçš„çŠ¶æ€ï¼Œä½†æ˜¯å¦‚æœå®ƒæŠ›å‡ºå¼‚å¸¸ï¼Œactorå°†åœæ­¢ã€‚</p>

<p>æœ‰ç”¨çš„æ—¶å€™:</p>

<ul>
  <li>åœ¨ä¸åŒçš„actoræ¶ˆæ¯åè®®ä¹‹é—´è¿›è¡Œè½¬æ¢</li>
  <li>è®¢é˜…å°†å‘bacå‘é€è®¸å¤šå“åº”æ¶ˆæ¯çš„Actor</li>
</ul>

<p>å­˜åœ¨é—®é¢˜ï¼š</p>

<ul>
  <li>å¾ˆéš¾æ£€æµ‹åˆ°æ²¡æœ‰å‘é€æˆ–å¤„ç†æ¶ˆæ¯è¯·æ±‚(å‚è§ask)</li>
  <li>æ¯ä¸ªå“åº”æ¶ˆæ¯ç±»å‹åªèƒ½è¿›è¡Œä¸€ç§é€‚åº”ï¼Œå¦‚æœæ³¨å†Œäº†æ–°çš„ï¼Œæ—§çš„å°±ä¼šè¢«æ›¿æ¢ï¼Œä¾‹å¦‚ï¼Œå¦‚æœä¸åŒçš„ç›®æ ‡Actorä½¿ç”¨ç›¸åŒçš„å“åº”ç±»å‹ï¼Œå®ƒä»¬å°±ä¸èƒ½æœ‰ä¸åŒçš„é€‚åº”ï¼Œé™¤éåœ¨æ¶ˆæ¯ä¸­ç¼–ç äº†æŸç§ç›¸å…³æ€§</li>
  <li>é™¤éåè®®å·²ç»åŒ…å«äº†æä¾›ä¸Šä¸‹æ–‡çš„æ–¹æ³•ï¼Œä¾‹å¦‚åœ¨å“åº”ä¸­ä¹Ÿå‘é€çš„è¯·æ±‚idï¼Œå¦åˆ™ä¸å¯èƒ½åœ¨ä¸å¼•å…¥æ–°çš„ã€å•ç‹¬çš„Actorçš„æƒ…å†µä¸‹å°†äº¤äº’ç»‘å®šåˆ°æŸä¸ªç‰¹å®šçš„ä¸Šä¸‹æ–‡ã€‚</li>
</ul>

<h3 id="445-ä¸¤ä¸ªactorè¯·æ±‚-å“åº”ä¹‹é—´ä½¿ç”¨ask">4.4.5. ä¸¤ä¸ªActorè¯·æ±‚-å“åº”ä¹‹é—´ä½¿ç”¨ask</h3>

<p>åœ¨è¯·æ±‚å’Œå“åº”ä¹‹é—´å­˜åœ¨1:1æ˜ å°„çš„äº¤äº’ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ActorContextä¸Šä½¿ç”¨askæ¥ä¸å¦ä¸€ä¸ªActoräº¤äº’ã€‚</p>

<p>äº¤äº’æœ‰ä¸¤ä¸ªæ­¥éª¤ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦æ„é€ ä¼ å‡ºæ¶ˆæ¯ï¼Œä¸ºæ­¤æˆ‘ä»¬éœ€è¦ä¸€ä¸ªActorRef<Response>ä½œä¸ºä¼ å‡ºæ¶ˆæ¯ä¸­çš„æ¥æ”¶æ–¹ã€‚ç¬¬äºŒæ­¥æ˜¯å°†æˆåŠŸå“åº”æˆ–å¤±è´¥è½¬æ¢ä¸ºæ¶ˆæ¯ï¼Œè¯¥æ¶ˆæ¯æ˜¯å‘é€Actoråè®®çš„ä¸€éƒ¨åˆ†ã€‚è¿˜è¯·å‚é˜…[é€šç”¨å“åº”åŒ…è£…å™¨](https://doc.akka.io/docs/akka/current/typed/interaction-patterns.html#generic-response-wrapper)ï¼Œäº†è§£æˆåŠŸæˆ–é”™è¯¯çš„å“åº”ã€‚</Response></p>

<p>Example:</p>

<p><img src="https://liulv.work/images/img/20200805212908.png" alt="20200805212908" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hal</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Hal</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Hal</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">Hal:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nf">Hal</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">OpenThePodBayDoorsPlease</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">HalResponse</span><span class="o">&gt;</span> <span class="n">respondTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">OpenThePodBayDoorsPlease</span><span class="o">(</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">HalResponse</span><span class="o">&gt;</span> <span class="n">respondTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">respondTo</span> <span class="o">=</span> <span class="n">respondTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">HalResponse</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">message</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">HalResponse</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">OpenThePodBayDoorsPlease</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onOpenThePodBayDoorsPlease</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onOpenThePodBayDoorsPlease</span><span class="o">(</span><span class="nc">OpenThePodBayDoorsPlease</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">message</span><span class="o">.</span><span class="na">respondTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">HalResponse</span><span class="o">(</span><span class="s">"I'm sorry, Dave. I'm afraid I can't do that."</span><span class="o">));</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Dave</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Dave</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="c1">// this is a part of the protocol that is internal to the actor itself</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">AdaptedResponse</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">message</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">AdaptedResponse</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Hal</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">hal</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="n">context</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">Dave</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">hal</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nf">Dave</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Hal</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">hal</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>

    <span class="c1">// asking someone requires a timeout, if the timeout hits without response</span>
    <span class="c1">// the ask is failed with a TimeoutException</span>
    <span class="kd">final</span> <span class="nc">Duration</span> <span class="n">timeout</span> <span class="o">=</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>

    <span class="n">context</span><span class="o">.</span><span class="na">ask</span><span class="o">(</span>
        <span class="nc">Hal</span><span class="o">.</span><span class="na">HalResponse</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
        <span class="n">hal</span><span class="o">,</span>
        <span class="n">timeout</span><span class="o">,</span>
        <span class="c1">// construct the outgoing message</span>
        <span class="o">(</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Hal</span><span class="o">.</span><span class="na">HalResponse</span><span class="o">&gt;</span> <span class="n">ref</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">Hal</span><span class="o">.</span><span class="na">OpenThePodBayDoorsPlease</span><span class="o">(</span><span class="n">ref</span><span class="o">),</span>
        <span class="c1">// adapt the response (or failure to respond)</span>
        <span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">response</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">AdaptedResponse</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">message</span><span class="o">);</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">AdaptedResponse</span><span class="o">(</span><span class="s">"Request failed"</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">});</span>

    <span class="c1">// we can also tie in request context into an interaction, it is safe to look at</span>
    <span class="c1">// actor internal state from the transformation function, but remember that it may have</span>
    <span class="c1">// changed at the time the response arrives and the transformation is done, best is to</span>
    <span class="c1">// use immutable state we have closed over like here.</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">requestId</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="n">context</span><span class="o">.</span><span class="na">ask</span><span class="o">(</span>
        <span class="nc">Hal</span><span class="o">.</span><span class="na">HalResponse</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
        <span class="n">hal</span><span class="o">,</span>
        <span class="n">timeout</span><span class="o">,</span>
        <span class="c1">// construct the outgoing message</span>
        <span class="o">(</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Hal</span><span class="o">.</span><span class="na">HalResponse</span><span class="o">&gt;</span> <span class="n">ref</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">Hal</span><span class="o">.</span><span class="na">OpenThePodBayDoorsPlease</span><span class="o">(</span><span class="n">ref</span><span class="o">),</span>
        <span class="c1">// adapt the response (or failure to respond)</span>
        <span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">response</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">AdaptedResponse</span><span class="o">(</span><span class="n">requestId</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">message</span><span class="o">);</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">AdaptedResponse</span><span class="o">(</span><span class="n">requestId</span> <span class="o">+</span> <span class="s">": Request failed"</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">});</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="c1">// the adapted message ends up being processed like any other</span>
        <span class="c1">// message sent to the actor</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">AdaptedResponse</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onAdaptedResponse</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onAdaptedResponse</span><span class="o">(</span><span class="nc">AdaptedResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Got response from HAL: {}"</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">message</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å“åº”é€‚åº”å‡½æ•°åœ¨æ¥æ”¶actorä¸­è¿è¡Œï¼Œå¯ä»¥å®‰å…¨åœ°è®¿é—®å®ƒçš„çŠ¶æ€ï¼Œä½†æ˜¯å¦‚æœå®ƒæŠ›å‡ºå¼‚å¸¸ï¼Œactorå°†åœæ­¢ã€‚</p>

<p>æœ‰ç”¨çš„æ—¶å€™:</p>

<ul>
  <li>å•å“åº”æŸ¥è¯¢</li>
  <li>åœ¨ç»§ç»­ä¹‹å‰ï¼ŒActoréœ€è¦çŸ¥é“æ¶ˆæ¯å·²è¢«å¤„ç†</li>
  <li>å¦‚æœæ²¡æœ‰äº§ç”ŸåŠæ—¶çš„å“åº”ï¼Œå…è®¸Actoré‡æ–°å‘é€</li>
  <li>è·Ÿè¸ªæœªå®Œæˆçš„è¯·æ±‚ï¼Œè€Œä¸æ˜¯ç”¨æ¶ˆæ¯æ·¹æ²¡æ”¶ä»¶äºº(â€œbackpressureâ€)</li>
  <li>ä¸Šä¸‹æ–‡åº”è¯¥é™„åŠ åˆ°äº¤äº’ä¸­ï¼Œä½†æ˜¯åè®®ä¸æ”¯æŒ(è¯·æ±‚idï¼Œå“åº”çš„æ˜¯ä»€ä¹ˆæŸ¥è¯¢)</li>
</ul>

<p>å­˜åœ¨é—®é¢˜:</p>

<ul>
  <li>å¯¹ä¸€ä¸ªè¯·æ±‚åªèƒ½æœ‰ä¸€ä¸ªå•ä¸€çš„å“åº”(å‚è§<a href="https://doc.akka.io/docs/akka/current/typed/interaction-patterns.html#per-session-child-actor">æ¯ä¸ªä¼šè¯child Actor</a>)</li>
  <li>å½“è¯·æ±‚è¶…æ—¶æ—¶ï¼Œæ¥æ”¶æ–¹å¹¶ä¸çŸ¥é“ï¼Œå¯èƒ½ä»ç„¶å¤„ç†å®ƒç›´åˆ°å®Œæˆï¼Œç”šè‡³åœ¨äº‹åå¼€å§‹å¤„ç†å®ƒ</li>
  <li>ä¸ºè¶…æ—¶å¯»æ‰¾ä¸€ä¸ªåˆé€‚çš„å€¼ï¼Œç‰¹åˆ«æ˜¯å½“åœ¨æ¥æ”¶actorä¸­è¢«é“¾æ¥çš„askè§¦å‘å™¨è¯·æ±‚æ—¶ã€‚æ‚¨å¸Œæœ›æœ‰ä¸€ä¸ªçŸ­çš„è¶…æ—¶æ—¶é—´æ¥å“åº”è¯·æ±‚ç¨‹åºï¼Œä½†åŒæ—¶åˆä¸å¸Œæœ›å‡ºç°è®¸å¤šè¯¯æŠ¥ã€‚</li>
</ul>

<h3 id="446-ä¸å¤–éƒ¨actorçš„è¯·æ±‚-å“åº”ask">4.4.6. ä¸å¤–éƒ¨Actorçš„è¯·æ±‚-å“åº”ask</h3>

<p>æœ‰æ—¶ä½ éœ€è¦ä¸å¤–éƒ¨ç³»ç»Ÿçš„Actorè¿›è¡Œäº¤äº’ï¼Œè¿™å¯ä»¥ç”¨â€œå³å‘å³å¼ƒâ€å¦‚ä¸Šæ‰€è¿°æˆ–é€šè¿‡å¦ä¸€ä¸ªç‰ˆæœ¬çš„è¦æ±‚è¿”å›ä¸€ä¸ªCompletionStage <ååº”>æ˜¯å®Œæˆä¸€ä¸ªæˆåŠŸæˆ–å¤±è´¥çš„å“åº”ï¼ˆTimeoutExceptionï¼‰ã€‚</ååº”></p>

<p>ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨akka.actor.type.javadsl.askpattern.askã€‚è¯·æ±‚å‘é€ä¸€æ¡æ¶ˆæ¯ç»™ä¸€ä¸ªActorå¹¶è·å¾—ä¸€ä¸ªCompletionState[Response] è¿”å›ã€‚</p>

<p>Example:</p>

<p><img src="https://liulv.work/images/img/20200805213553.png" alt="20200805213553" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CookieFabric</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">GiveMeCookies</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">GiveMeCookies</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">interface</span> <span class="nc">Reply</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Cookies</span> <span class="kd">implements</span> <span class="nc">Reply</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Cookies</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">InvalidRequest</span> <span class="kd">implements</span> <span class="nc">Reply</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">reason</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">InvalidRequest</span><span class="o">(</span><span class="nc">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">reason</span> <span class="o">=</span> <span class="n">reason</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">CookieFabric:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nf">CookieFabric</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">GiveMeCookies</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onGiveMeCookies</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onGiveMeCookies</span><span class="o">(</span><span class="nc">GiveMeCookies</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">count</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="o">)</span> <span class="n">request</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">InvalidRequest</span><span class="o">(</span><span class="s">"Too many cookies."</span><span class="o">));</span>
    <span class="k">else</span> <span class="n">request</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Cookies</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">count</span><span class="o">));</span>

    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">askAndPrint</span><span class="o">(</span>
      <span class="nc">ActorSystem</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">system</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">cookieFabric</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Reply</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span>
        <span class="nc">AskPattern</span><span class="o">.</span><span class="na">ask</span><span class="o">(</span>
            <span class="n">cookieFabric</span><span class="o">,</span>
            <span class="n">replyTo</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="na">GiveMeCookies</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">),</span>
            <span class="c1">// asking someone requires a timeout and a scheduler, if the timeout hits without</span>
            <span class="c1">// response the ask is failed with a TimeoutException</span>
            <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span>
            <span class="n">system</span><span class="o">.</span><span class="na">scheduler</span><span class="o">());</span>

    <span class="n">result</span><span class="o">.</span><span class="na">whenComplete</span><span class="o">(</span>
        <span class="o">(</span><span class="n">reply</span><span class="o">,</span> <span class="n">failure</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">reply</span> <span class="k">instanceof</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Cookies</span><span class="o">)</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Yay, "</span> <span class="o">+</span> <span class="o">((</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Cookies</span><span class="o">)</span> <span class="n">reply</span><span class="o">).</span><span class="na">count</span> <span class="o">+</span> <span class="s">" cookies!"</span><span class="o">);</span>
          <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">reply</span> <span class="k">instanceof</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="na">InvalidRequest</span><span class="o">)</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span>
                <span class="s">"No cookies for me. "</span> <span class="o">+</span> <span class="o">((</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">InvalidRequest</span><span class="o">)</span> <span class="n">reply</span><span class="o">).</span><span class="na">reason</span><span class="o">);</span>
          <span class="k">else</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Boo! didn't get cookies in time. "</span> <span class="o">+</span> <span class="n">failure</span><span class="o">);</span>
        <span class="o">});</span>
  <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ³¨æ„ï¼ŒéªŒè¯é”™è¯¯åœ¨æ¶ˆæ¯åè®®ä¸­ä¹Ÿæ˜¯æ˜¾å¼çš„ã€‚GiveMeCookiesè¯·æ±‚å¯ä»¥ç”¨cookieæˆ–InvalidRequestè¿›è¡Œå“åº”ã€‚è¯·æ±‚è€…å¿…é¡»å†³å®šå¦‚ä½•å¤„ç†InvalidRequeståº”ç­”ã€‚æœ‰æ—¶åº”è¯¥å°†å…¶è§†ä¸ºå¤±è´¥çš„æœªæ¥ï¼Œå› æ­¤å¯ä»¥å°†åº”ç­”æ˜ å°„åˆ°è¯·æ±‚è€…ç«¯ã€‚è¿˜è¯·å‚é˜…<a href="https://doc.akka.io/docs/akka/current/typed/interaction-patterns.html#generic-response-wrapper">é€šç”¨å“åº”åŒ…è£…å™¨</a>ï¼Œäº†è§£æˆåŠŸæˆ–é”™è¯¯çš„å“åº”ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Reply</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span>
    <span class="nc">AskPattern</span><span class="o">.</span><span class="na">ask</span><span class="o">(</span>
        <span class="n">cookieFabric</span><span class="o">,</span>
        <span class="n">replyTo</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="na">GiveMeCookies</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">),</span>
        <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span>
        <span class="n">system</span><span class="o">.</span><span class="na">scheduler</span><span class="o">());</span>

<span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Cookies</span><span class="o">&gt;</span> <span class="n">cookies</span> <span class="o">=</span>
    <span class="n">result</span><span class="o">.</span><span class="na">thenCompose</span><span class="o">(</span>
        <span class="o">(</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Reply</span> <span class="n">reply</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">reply</span> <span class="k">instanceof</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Cookies</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">completedFuture</span><span class="o">((</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Cookies</span><span class="o">)</span> <span class="n">reply</span><span class="o">);</span>
          <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">reply</span> <span class="k">instanceof</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="na">InvalidRequest</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Cookies</span><span class="o">&gt;</span> <span class="n">failed</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CompletableFuture</span><span class="o">&lt;&gt;();</span>
            <span class="n">failed</span><span class="o">.</span><span class="na">completeExceptionally</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(((</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">InvalidRequest</span><span class="o">)</span> <span class="n">reply</span><span class="o">).</span><span class="na">reason</span><span class="o">));</span>
            <span class="k">return</span> <span class="n">failed</span><span class="o">;</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Unexpected reply: "</span> <span class="o">+</span> <span class="n">reply</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
          <span class="o">}</span>
        <span class="o">});</span>

<span class="n">cookies</span><span class="o">.</span><span class="na">whenComplete</span><span class="o">(</span>
    <span class="o">(</span><span class="n">cookiesReply</span><span class="o">,</span> <span class="n">failure</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">cookies</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Yay, "</span> <span class="o">+</span> <span class="n">cookiesReply</span><span class="o">.</span><span class="na">count</span> <span class="o">+</span> <span class="s">" cookies!"</span><span class="o">);</span>
      <span class="k">else</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Boo! didn't get cookies in time. "</span> <span class="o">+</span> <span class="n">failure</span><span class="o">);</span>
    <span class="o">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<dl>
  <dt>æœ‰ç”¨çš„æ—¶å€™</dt>
  <dd>ä»Actorç³»ç»Ÿå¤–éƒ¨æŸ¥è¯¢Actor</dd>
  <dt>å­˜åœ¨é—®é¢˜</dt>
  <dd>
    <ul>
      <li>åœ¨è¿”å›çš„CompletionStageä¸Šçš„å›è°ƒå¾ˆå®¹æ˜“æ„å¤–åœ°å…³é—­å’Œä¸å®‰å…¨çš„å¯å˜çŠ¶æ€ï¼Œå› ä¸ºè¿™äº›å›è°ƒå°†åœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚</li>
    </ul>
  </dd>
  <dd>
    <ul>
      <li>å¯¹ä¸€ä¸ªè¯·æ±‚åªèƒ½æœ‰ä¸€ä¸ªå•ä¸€çš„å“åº”(å‚è§<a href="https://doc.akka.io/docs/akka/current/typed/interaction-patterns.html#per-session-child-actor">æ¯ä¸ªä¼šè¯child Actor</a>)ã€‚</li>
      <li>å½“è¯·æ±‚è¶…æ—¶æ—¶ï¼Œæ¥æ”¶æ–¹å¹¶ä¸çŸ¥é“ï¼Œå¯èƒ½ä»ç„¶å¤„ç†å®ƒç›´åˆ°å®Œæˆï¼Œç”šè‡³åœ¨äº‹åå¼€å§‹å¤„ç†å®ƒã€‚</li>
    </ul>
  </dd>
</dl>

<h3 id="447-ä¸€èˆ¬ååº”åŒ…è£…">4.4.7. ä¸€èˆ¬ååº”åŒ…è£…</h3>

<p>åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œå“åº”å¯ä»¥æ˜¯ä¸€ä¸ªæˆåŠŸçš„ç»“æœï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªé”™è¯¯(ä¾‹å¦‚ï¼Œå‘½ä»¤æ— æ•ˆçš„éªŒè¯é”™è¯¯)ã€‚å¿…é¡»ä¸ºæ¯ä¸ªè¯·æ±‚ç±»å‹å®šä¹‰ä¸¤ä¸ªå“åº”ç±»å’Œä¸€ä¸ªå…±äº«è¶…ç±»å‹ï¼Œè¿™å¯èƒ½æ˜¯é‡å¤çš„ï¼Œç‰¹åˆ«æ˜¯åœ¨é›†ç¾¤ä¸Šä¸‹æ–‡ä¸­ï¼Œæ‚¨è¿˜å¿…é¡»ç¡®ä¿æ¶ˆæ¯å¯ä»¥åºåˆ—åŒ–ä»¥é€šè¿‡ç½‘ç»œå‘é€ã€‚</p>

<p>ä¸ºäº†å¸®åŠ©è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªé€šç”¨çš„çŠ¶æ€-å“åº”ç±»å‹åŒ…æ‹¬åœ¨Akka: StatusReplyä¸­ï¼Œåœ¨ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨askï¼Œè¿˜æœ‰ç¬¬äºŒä¸ªæ–¹æ³•askWithStatusï¼Œå‡è®¾å“åº”æ˜¯StatusReplyï¼Œå®ƒå°†æ‰“å¼€æˆåŠŸçš„å“åº”å¹¶å¸®åŠ©å¤„ç†éªŒè¯é”™è¯¯ã€‚AkkaåŒ…å«è¯¥ç±»å‹çš„é¢„æ„å»ºåºåˆ—åŒ–å™¨ï¼Œå› æ­¤åœ¨é€šå¸¸çš„ç”¨ä¾‹ä¸­ï¼Œé›†ç¾¤åº”ç”¨ç¨‹åºåªéœ€è¦ä¸ºæˆåŠŸçš„ç»“æœæä¾›ä¸€ä¸ªåºåˆ—åŒ–å™¨ã€‚</p>

<p>å¯¹äºæˆåŠŸçš„åº”ç­”ä¸åŒ…å«å®é™…å€¼ä½†æ›´å¤šçš„æ˜¯ç¡®è®¤çš„æƒ…å†µï¼Œæœ‰ä¸€ä¸ªé¢„å®šä¹‰çš„StatusReply.ack()ï¼Œå…¶ç±»å‹ä¸ºStatusReply<Done>ã€‚</Done></p>

<p>é”™è¯¯æœ€å¥½ä½œä¸ºæè¿°é”™è¯¯çš„æ–‡æœ¬å‘é€ï¼Œä½†ä¹Ÿå¯ä»¥ä½¿ç”¨å¼‚å¸¸é™„åŠ ç±»å‹ã€‚</p>

<p>ç¤ºä¾‹actorå¯¹actor ask:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">akka.pattern.StatusReply</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hal</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Hal</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Hal</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">Hal:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nf">Hal</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Hal</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">OpenThePodBayDoorsPlease</span> <span class="kd">implements</span> <span class="nc">Hal</span><span class="o">.</span><span class="na">Command</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">StatusReply</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">respondTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">OpenThePodBayDoorsPlease</span><span class="o">(</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">StatusReply</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">respondTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">respondTo</span> <span class="o">=</span> <span class="n">respondTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Hal</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Hal</span><span class="o">.</span><span class="na">OpenThePodBayDoorsPlease</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onOpenThePodBayDoorsPlease</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Hal</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">onOpenThePodBayDoorsPlease</span><span class="o">(</span>
      <span class="nc">Hal</span><span class="o">.</span><span class="na">OpenThePodBayDoorsPlease</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">message</span><span class="o">.</span><span class="na">respondTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="nc">StatusReply</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"I'm sorry, Dave. I'm afraid I can't do that."</span><span class="o">));</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Dave</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Dave</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="c1">// this is a part of the protocol that is internal to the actor itself</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">AdaptedResponse</span> <span class="kd">implements</span> <span class="nc">Dave</span><span class="o">.</span><span class="na">Command</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">message</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">AdaptedResponse</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Dave</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Hal</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">hal</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="n">context</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">Dave</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">hal</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nf">Dave</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Dave</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Hal</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">hal</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>

    <span class="c1">// asking someone requires a timeout, if the timeout hits without response</span>
    <span class="c1">// the ask is failed with a TimeoutException</span>
    <span class="kd">final</span> <span class="nc">Duration</span> <span class="n">timeout</span> <span class="o">=</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>

    <span class="n">context</span><span class="o">.</span><span class="na">askWithStatus</span><span class="o">(</span>
        <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
        <span class="n">hal</span><span class="o">,</span>
        <span class="n">timeout</span><span class="o">,</span>
        <span class="c1">// construct the outgoing message</span>
        <span class="o">(</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">StatusReply</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">ref</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">Hal</span><span class="o">.</span><span class="na">OpenThePodBayDoorsPlease</span><span class="o">(</span><span class="n">ref</span><span class="o">),</span>
        <span class="c1">// adapt the response (or failure to respond)</span>
        <span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">response</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// a ReponseWithStatus.success(m) is unwrapped and passed as response</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">Dave</span><span class="o">.</span><span class="na">AdaptedResponse</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// a ResponseWithStatus.error will end up as a StatusReply.ErrorMessage()</span>
            <span class="c1">// exception here</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">Dave</span><span class="o">.</span><span class="na">AdaptedResponse</span><span class="o">(</span><span class="s">"Request failed: "</span> <span class="o">+</span> <span class="n">throwable</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
          <span class="o">}</span>
        <span class="o">});</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Dave</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="c1">// the adapted message ends up being processed like any other</span>
        <span class="c1">// message sent to the actor</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Dave</span><span class="o">.</span><span class="na">AdaptedResponse</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onAdaptedResponse</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Dave</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">onAdaptedResponse</span><span class="o">(</span><span class="nc">Dave</span><span class="o">.</span><span class="na">AdaptedResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Got response from HAL: {}"</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">message</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯¹äºæ¶ˆæ¯é€‚é…å™¨ï¼ŒéªŒè¯é”™è¯¯å°†è½¬åŒ–ä¸ºå¤±è´¥ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†æ˜¾å¼åœ°åˆ†åˆ«å¤„ç†valdationé”™è¯¯å’Œå…¶ä»–askå¤±è´¥ã€‚</p>

<p>ç¤ºä¾‹ä»å¤–éƒ¨ask</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CookieFabric</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">GiveMeCookies</span> <span class="kd">implements</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Command</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">StatusReply</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Cookies</span><span class="o">&gt;&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">GiveMeCookies</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">StatusReply</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Cookies</span><span class="o">&gt;&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Cookies</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Cookies</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">CookieFabric:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nf">CookieFabric</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">GiveMeCookies</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onGiveMeCookies</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">onGiveMeCookies</span><span class="o">(</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">GiveMeCookies</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">count</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="o">)</span> <span class="n">request</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="nc">StatusReply</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Too many cookies."</span><span class="o">));</span>
    <span class="k">else</span> <span class="n">request</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="nc">StatusReply</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="k">new</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Cookies</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">count</span><span class="o">)));</span>

    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">askAndPrint</span><span class="o">(</span>
      <span class="nc">ActorSystem</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">system</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">cookieFabric</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Cookies</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span>
        <span class="nc">AskPattern</span><span class="o">.</span><span class="na">askWithStatus</span><span class="o">(</span>
            <span class="n">cookieFabric</span><span class="o">,</span>
            <span class="n">replyTo</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="na">GiveMeCookies</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">),</span>
            <span class="c1">// asking someone requires a timeout and a scheduler, if the timeout hits without</span>
            <span class="c1">// response the ask is failed with a TimeoutException</span>
            <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span>
            <span class="n">system</span><span class="o">.</span><span class="na">scheduler</span><span class="o">());</span>

    <span class="n">result</span><span class="o">.</span><span class="na">whenComplete</span><span class="o">(</span>
        <span class="o">(</span><span class="n">reply</span><span class="o">,</span> <span class="n">failure</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">reply</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Yay, "</span> <span class="o">+</span> <span class="n">reply</span><span class="o">.</span><span class="na">count</span> <span class="o">+</span> <span class="s">" cookies!"</span><span class="o">);</span>
          <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">failure</span> <span class="k">instanceof</span> <span class="nc">StatusReply</span><span class="o">.</span><span class="na">ErrorMessage</span><span class="o">)</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"No cookies for me. "</span> <span class="o">+</span> <span class="n">failure</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
          <span class="k">else</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Boo! didn't get cookies in time. "</span> <span class="o">+</span> <span class="n">failure</span><span class="o">);</span>
        <span class="o">});</span>
  <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ³¨æ„ï¼ŒéªŒè¯é”™è¯¯åœ¨æ¶ˆæ¯åè®®ä¸­ä¹Ÿæ˜¯æ˜¾å¼çš„ï¼Œä½†è¢«ç¼–ç ä¸ºåŒ…è£…ç±»å‹ï¼Œä½¿ç”¨StatusReply.error(text)æ„é€ :</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Cookies</span><span class="o">&gt;</span> <span class="n">cookies</span> <span class="o">=</span>
    <span class="nc">AskPattern</span><span class="o">.</span><span class="na">askWithStatus</span><span class="o">(</span>
        <span class="n">cookieFabric</span><span class="o">,</span>
        <span class="n">replyTo</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="na">GiveMeCookies</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">),</span>
        <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span>
        <span class="n">system</span><span class="o">.</span><span class="na">scheduler</span><span class="o">());</span>

<span class="n">cookies</span><span class="o">.</span><span class="na">whenComplete</span><span class="o">(</span>
    <span class="o">(</span><span class="n">cookiesReply</span><span class="o">,</span> <span class="n">failure</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">cookies</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Yay, "</span> <span class="o">+</span> <span class="n">cookiesReply</span><span class="o">.</span><span class="na">count</span> <span class="o">+</span> <span class="s">" cookies!"</span><span class="o">);</span>
      <span class="k">else</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Boo! didn't get cookies in time. "</span> <span class="o">+</span> <span class="n">failure</span><span class="o">);</span>
    <span class="o">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="448-å¿½ç•¥å›å¤">4.4.8. å¿½ç•¥å›å¤</h3>

<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒActorå¯¹ç‰¹å®šè¯·æ±‚æ¶ˆæ¯æœ‰å“åº”ï¼Œä½†æ‚¨å¯¹å“åº”ä¸æ„Ÿå…´è¶£ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ä¼ é€’system.ignoreRef()ï¼Œå°†è¯·æ±‚-å“åº”è½¬æ¢ä¸ºâ€œå‘å°„-å¿˜è®°â€ã€‚</p>

<p>é¡¾åæ€ä¹‰ï¼Œsystem.ignoreRef()è¿”å›ä¸€ä¸ªå¿½ç•¥å‘é€ç»™å®ƒçš„ä»»ä½•æ¶ˆæ¯çš„ActorRefã€‚</p>

<p>å¯¹äºä¸ä¸Šé¢çš„è¯·æ±‚å“åº”ç›¸åŒçš„åè®®ï¼Œå¦‚æœå‘é€æ–¹å¸Œæœ›å¿½ç•¥åº”ç­”ï¼Œå®ƒå¯ä»¥ä¸ºreplyToä¼ é€’system.ignoreRef()ï¼Œå®ƒå¯ä»¥é€šè¿‡ActorContext.getSystem().ignoreref()è®¿é—®è¯¥åº”ç­”ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">cookieFabric</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span>
    <span class="k">new</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="na">Request</span><span class="o">(</span><span class="s">"don't send cookies back"</span><span class="o">,</span> <span class="n">context</span><span class="o">.</span><span class="na">getSystem</span><span class="o">().</span><span class="na">ignoreRef</span><span class="o">()));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœ‰ç”¨çš„æ—¶å€™:</p>

<p>å‘é€åè®®ä¸ºå…¶å®šä¹‰åº”ç­”çš„æ¶ˆæ¯ï¼Œä½†æ‚¨å¯¹è·å–åº”ç­”ä¸æ„Ÿå…´è¶£</p>

<p>å­˜åœ¨é—®é¢˜ï¼š</p>

<p>è¿”å›çš„ActorRefä¼šå¿½ç•¥å‘é€ç»™å®ƒçš„æ‰€æœ‰æ¶ˆæ¯ï¼Œå› æ­¤åº”è¯¥è°¨æ…ä½¿ç”¨ã€‚</p>

<ul>
  <li>å°†å…¶éšæ„ä¼ é€’ï¼Œå°±åƒå®ƒæ˜¯ä¸€ä¸ªæ­£å¸¸çš„ActorRefä¸€æ ·ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç ´åè§’è‰²åˆ°è§’è‰²çš„äº¤äº’ã€‚</li>
  <li>å½“ä»Actorç³»ç»Ÿå¤–éƒ¨æ‰§è¡Œè¯·æ±‚æ—¶ä½¿ç”¨å®ƒå°†å¯¼è‡´è¯·æ±‚è¿”å›çš„CompletionStageè¶…æ—¶ï¼Œå› ä¸ºå®ƒæ°¸è¿œä¸ä¼šå®Œæˆã€‚</li>
  <li>æœ€åï¼Œè§‚çœ‹å®ƒæ˜¯åˆæ³•çš„ï¼Œä½†ç”±äºå®ƒæ˜¯ä¸€ç§ç‰¹æ®Šçš„ç±»å‹ï¼Œå®ƒæ°¸è¿œä¸ä¼šç»ˆæ­¢ï¼Œå› æ­¤ä½ æ°¸è¿œä¸ä¼šä»å®ƒé‚£é‡Œæ¥æ”¶åˆ°ç»ˆæ­¢ä¿¡å·ã€‚</li>
</ul>

<h3 id="449-å°†æœªæ¥çš„ç»“æœå‘é€ç»™è‡ªå·±">4.4.9. å°†æœªæ¥çš„ç»“æœå‘é€ç»™è‡ªå·±</h3>

<p>å½“ä½¿ç”¨ä»actorè¿”å›CompletionStageçš„APIæ—¶ï¼Œé€šå¸¸æ‚¨ä¼šå¸Œæœ›åœ¨CompletionStageå®Œæˆæ—¶ä½¿ç”¨actorä¸­å“åº”çš„å€¼ã€‚ä¸ºæ­¤ï¼ŒActorContextæä¾›äº†ä¸€ä¸ªpipeToSelfæ–¹æ³•ã€‚</p>

<p>Example:</p>

<p><img src="https://liulv.work/images/img/20200805214503.png" alt="20200805214503" /></p>

<p>ä¸€ä¸ªActorCustomerRepositoryæ­£åœ¨è°ƒç”¨CustomerDataAccessä¸Šçš„ä¸€ä¸ªæ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªCompletionStageã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CustomerDataAccess</span> <span class="o">{</span>
  <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Done</span><span class="o">&gt;</span> <span class="nf">update</span><span class="o">(</span><span class="nc">Customer</span> <span class="n">customer</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Customer</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">version</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">address</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Customer</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">,</span> <span class="kt">long</span> <span class="n">version</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">version</span> <span class="o">=</span> <span class="n">version</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomerRepository</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">CustomerRepository</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MAX_OPERATIONS_IN_PROGRESS</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>

  <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Update</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Customer</span> <span class="n">customer</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">OperationResult</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Update</span><span class="o">(</span><span class="nc">Customer</span> <span class="n">customer</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">OperationResult</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">customer</span> <span class="o">=</span> <span class="n">customer</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">interface</span> <span class="nc">OperationResult</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">UpdateSuccess</span> <span class="kd">implements</span> <span class="nc">OperationResult</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">UpdateSuccess</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">UpdateFailure</span> <span class="kd">implements</span> <span class="nc">OperationResult</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">reason</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">UpdateFailure</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">reason</span> <span class="o">=</span> <span class="n">reason</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">WrappedUpdateResult</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">OperationResult</span> <span class="n">result</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">OperationResult</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">WrappedUpdateResult</span><span class="o">(</span><span class="nc">OperationResult</span> <span class="n">result</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">OperationResult</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span><span class="nc">CustomerDataAccess</span> <span class="n">dataAccess</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="n">context</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">CustomerRepository</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">dataAccess</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">CustomerDataAccess</span> <span class="n">dataAccess</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">operationsInProgress</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nf">CustomerRepository</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span> <span class="nc">CustomerDataAccess</span> <span class="n">dataAccess</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">dataAccess</span> <span class="o">=</span> <span class="n">dataAccess</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Update</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onUpdate</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">WrappedUpdateResult</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onUpdateResult</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onUpdate</span><span class="o">(</span><span class="nc">Update</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">operationsInProgress</span> <span class="o">==</span> <span class="no">MAX_OPERATIONS_IN_PROGRESS</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">command</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span>
          <span class="k">new</span> <span class="nf">UpdateFailure</span><span class="o">(</span>
              <span class="n">command</span><span class="o">.</span><span class="na">customer</span><span class="o">.</span><span class="na">id</span><span class="o">,</span>
              <span class="s">"Max "</span> <span class="o">+</span> <span class="no">MAX_OPERATIONS_IN_PROGRESS</span> <span class="o">+</span> <span class="s">" concurrent operations supported"</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="c1">// increase operationsInProgress counter</span>
      <span class="n">operationsInProgress</span><span class="o">++;</span>
      <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Done</span><span class="o">&gt;</span> <span class="n">futureResult</span> <span class="o">=</span> <span class="n">dataAccess</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">customer</span><span class="o">);</span>
      <span class="n">getContext</span><span class="o">()</span>
          <span class="o">.</span><span class="na">pipeToSelf</span><span class="o">(</span>
              <span class="n">futureResult</span><span class="o">,</span>
              <span class="o">(</span><span class="n">ok</span><span class="o">,</span> <span class="n">exc</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">exc</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                  <span class="k">return</span> <span class="k">new</span> <span class="nf">WrappedUpdateResult</span><span class="o">(</span>
                      <span class="k">new</span> <span class="nf">UpdateSuccess</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">customer</span><span class="o">.</span><span class="na">id</span><span class="o">),</span> <span class="n">command</span><span class="o">.</span><span class="na">replyTo</span><span class="o">);</span>
                <span class="k">else</span>
                  <span class="k">return</span> <span class="k">new</span> <span class="nf">WrappedUpdateResult</span><span class="o">(</span>
                      <span class="k">new</span> <span class="nf">UpdateFailure</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">customer</span><span class="o">.</span><span class="na">id</span><span class="o">,</span> <span class="n">exc</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()),</span>
                      <span class="n">command</span><span class="o">.</span><span class="na">replyTo</span><span class="o">);</span>
              <span class="o">});</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onUpdateResult</span><span class="o">(</span><span class="nc">WrappedUpdateResult</span> <span class="n">wrapped</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// decrease operationsInProgress counter</span>
    <span class="n">operationsInProgress</span><span class="o">--;</span>
    <span class="c1">// send result to original requestor</span>
    <span class="n">wrapped</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">wrapped</span><span class="o">.</span><span class="na">result</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨CompletionStageä¸Šä½¿ç”¨å›è°ƒå¯èƒ½å¾ˆè¯±äººï¼Œä½†æ˜¯è¿™ä¼šå¸¦æ¥ä»å¤–éƒ¨çº¿ç¨‹è®¿é—®ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„actorçš„å†…éƒ¨çŠ¶æ€çš„é£é™©ã€‚ä¾‹å¦‚ï¼Œä¸Šé¢ä¾‹å­ä¸­çš„numberOfPendingOperationsè®¡æ•°å™¨ä¸èƒ½ä»è¿™æ ·çš„å›è°ƒè®¿é—®ã€‚å› æ­¤ï¼Œæœ€å¥½å°†ç»“æœæ˜ å°„åˆ°æ¶ˆæ¯å¹¶åœ¨æ¥æ”¶è¯¥æ¶ˆæ¯æ—¶æ‰§è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚</p>

<p>æœ‰ç”¨çš„æ—¶å€™:</p>
<ul>
  <li>è®¿é—®ä»Actorè¿”å›CompletionStageçš„apiï¼Œä¾‹å¦‚æ•°æ®åº“æˆ–å¤–éƒ¨æœåŠ¡</li>
  <li>å½“CompletionStageå®Œæˆæ—¶ï¼Œactoréœ€è¦ç»§ç»­å¤„ç†</li>
  <li>ä¿æŒä¸Šä¸‹æ–‡ä¸åŸå§‹è¯·æ±‚çš„å…³ç³»ï¼Œå¹¶åœ¨CompletionStageå®Œæˆæ—¶ä½¿ç”¨å®ƒï¼Œä¾‹å¦‚replyTo actorå¼•ç”¨</li>
</ul>

<p>é—®é¢˜:
ä¸ºç»“æœæ·»åŠ åŒ…è£…å™¨æ¶ˆæ¯çš„æ ·æ¿æ–‡ä»¶ã€‚</p>

<h3 id="4410-æ¯ä¸ªå­actorä¼šè¯">4.4.10. æ¯ä¸ªå­Actorä¼šè¯</h3>

<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œåªæœ‰åœ¨ä»å…¶ä»–Actoræ”¶é›†å¤šä¸ªç­”æ¡ˆä¹‹åï¼Œæ‰èƒ½åˆ›å»ºå¹¶å‘å›å¯¹è¯·æ±‚çš„å®Œæ•´å“åº”ã€‚å¯¹äºè¿™äº›ç±»å‹çš„äº¤äº’ï¼Œæœ€å¥½å°†å·¥ä½œå§”æ‰˜ç»™æ¯ä¸ªâ€œä¼šè¯â€çš„å­actorã€‚å­actorè¿˜å¯ä»¥åŒ…å«å®ç°é‡è¯•ã€è¶…æ—¶å¤±è´¥ã€å°¾éƒ¨æˆªæ–­ã€è¿›åº¦æ£€æŸ¥ç­‰çš„ä»»æ„é€»è¾‘ã€‚</p>

<p>è¯·æ³¨æ„ï¼Œè¿™æœ¬è´¨ä¸Šå°±æ˜¯askçš„å®ç°æ–¹å¼ï¼Œå¦‚æœæ‚¨æ‰€éœ€è¦çš„åªæ˜¯ä¸€ä¸ªå¸¦æœ‰è¶…æ—¶çš„å“åº”ï¼Œé‚£ä¹ˆæœ€å¥½ä½¿ç”¨askã€‚</p>

<p>å­å…ƒç´ æ˜¯ç”¨å®ƒæ‰§è¡Œå·¥ä½œæ‰€éœ€çš„ä¸Šä¸‹æ–‡åˆ›å»ºçš„ï¼ŒåŒ…æ‹¬å®ƒå¯ä»¥å“åº”çš„ActorRefã€‚å½“å®Œæ•´çš„ç»“æœå‡ºç°æ—¶ï¼Œå­©å­ä¼šä»¥ç»“æœåšå‡ºååº”ï¼Œç„¶ååœæ­¢ã€‚</p>

<p>ç”±äºä¼šè¯Actorçš„åè®®ä¸æ˜¯å…¬å…±APIï¼Œè€Œæ˜¯çˆ¶Actorçš„å®ç°ç»†èŠ‚ï¼Œå› æ­¤ä½¿ç”¨æ˜¾å¼åè®®å¹¶è°ƒæ•´ä¼šè¯Actorä¸ä¹‹äº¤äº’çš„Actorçš„æ¶ˆæ¯å¯èƒ½å¹¶ä¸æ€»æ˜¯æœ‰æ„ä¹‰çš„ã€‚å¯¹äºè¿™ä¸ªç”¨ä¾‹ï¼Œå¯ä»¥è¡¨ç¤ºActorå¯ä»¥æ¥æ”¶ä»»ä½•æ¶ˆæ¯(å¯¹è±¡)ã€‚</p>

<p>Example:</p>

<p><img src="https://liulv.work/images/img/20200805214912.png" alt="20200805214912" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
</pre></td><td class="rouge-code"><pre><span class="c1">// dummy data types just for this sample</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Keys</span> <span class="o">{}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Wallet</span> <span class="o">{}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">KeyCabinet</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">GetKeys</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">whoseKeys</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Keys</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">GetKeys</span><span class="o">(</span><span class="nc">String</span> <span class="n">whoseKeys</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Keys</span><span class="o">&gt;</span> <span class="n">respondTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">whoseKeys</span> <span class="o">=</span> <span class="n">whoseKeys</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">respondTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">GetKeys</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">(</span><span class="nl">KeyCabinet:</span><span class="o">:</span><span class="n">onGetKeys</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">GetKeys</span><span class="o">&gt;</span> <span class="nf">onGetKeys</span><span class="o">(</span><span class="nc">GetKeys</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">message</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Keys</span><span class="o">());</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Drawer</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">GetWallet</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">whoseWallet</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Wallet</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">GetWallet</span><span class="o">(</span><span class="nc">String</span> <span class="n">whoseWallet</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Wallet</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">whoseWallet</span> <span class="o">=</span> <span class="n">whoseWallet</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">GetWallet</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">(</span><span class="nl">Drawer:</span><span class="o">:</span><span class="n">onGetWallet</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">GetWallet</span><span class="o">&gt;</span> <span class="nf">onGetWallet</span><span class="o">(</span><span class="nc">GetWallet</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">message</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Wallet</span><span class="o">());</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Home</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LeaveHome</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">who</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">ReadyToLeaveHome</span><span class="o">&gt;</span> <span class="n">respondTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">LeaveHome</span><span class="o">(</span><span class="nc">String</span> <span class="n">who</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">ReadyToLeaveHome</span><span class="o">&gt;</span> <span class="n">respondTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">who</span> <span class="o">=</span> <span class="n">who</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">respondTo</span> <span class="o">=</span> <span class="n">respondTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ReadyToLeaveHome</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">who</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Keys</span> <span class="n">keys</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Wallet</span> <span class="n">wallet</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ReadyToLeaveHome</span><span class="o">(</span><span class="nc">String</span> <span class="n">who</span><span class="o">,</span> <span class="nc">Keys</span> <span class="n">keys</span><span class="o">,</span> <span class="nc">Wallet</span> <span class="n">wallet</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">who</span> <span class="o">=</span> <span class="n">who</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">keys</span> <span class="o">=</span> <span class="n">keys</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">wallet</span> <span class="o">=</span> <span class="n">wallet</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">KeyCabinet</span><span class="o">.</span><span class="na">GetKeys</span><span class="o">&gt;</span> <span class="n">keyCabinet</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Drawer</span><span class="o">.</span><span class="na">GetWallet</span><span class="o">&gt;</span> <span class="n">drawer</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nf">Home</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">keyCabinet</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">KeyCabinet</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"key-cabinet"</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">drawer</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">Drawer</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"drawer"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">behavior</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="nc">Command</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">LeaveHome</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onLeaveHome</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onLeaveHome</span><span class="o">(</span><span class="nc">LeaveHome</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span>
        <span class="nc">PrepareToLeaveHome</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">who</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">respondTo</span><span class="o">,</span> <span class="n">keyCabinet</span><span class="o">,</span> <span class="n">drawer</span><span class="o">),</span>
        <span class="s">"leaving"</span> <span class="o">+</span> <span class="n">message</span><span class="o">.</span><span class="na">who</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="c1">// actor behavior</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="n">context</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">Home</span><span class="o">(</span><span class="n">context</span><span class="o">).</span><span class="na">behavior</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// per session actor behavior</span>
<span class="kd">class</span> <span class="nc">PrepareToLeaveHome</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span>
      <span class="nc">String</span> <span class="n">whoIsLeaving</span><span class="o">,</span>
      <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Home</span><span class="o">.</span><span class="na">ReadyToLeaveHome</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">,</span>
      <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">KeyCabinet</span><span class="o">.</span><span class="na">GetKeys</span><span class="o">&gt;</span> <span class="n">keyCabinet</span><span class="o">,</span>
      <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Drawer</span><span class="o">.</span><span class="na">GetWallet</span><span class="o">&gt;</span> <span class="n">drawer</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span>
        <span class="n">context</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">PrepareToLeaveHome</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">whoIsLeaving</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">,</span> <span class="n">keyCabinet</span><span class="o">,</span> <span class="n">drawer</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">whoIsLeaving</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Home</span><span class="o">.</span><span class="na">ReadyToLeaveHome</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">KeyCabinet</span><span class="o">.</span><span class="na">GetKeys</span><span class="o">&gt;</span> <span class="n">keyCabinet</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Drawer</span><span class="o">.</span><span class="na">GetWallet</span><span class="o">&gt;</span> <span class="n">drawer</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Wallet</span><span class="o">&gt;</span> <span class="n">wallet</span> <span class="o">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
  <span class="kd">private</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Keys</span><span class="o">&gt;</span> <span class="n">keys</span> <span class="o">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>

  <span class="kd">private</span> <span class="nf">PrepareToLeaveHome</span><span class="o">(</span>
      <span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span>
      <span class="nc">String</span> <span class="n">whoIsLeaving</span><span class="o">,</span>
      <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Home</span><span class="o">.</span><span class="na">ReadyToLeaveHome</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">,</span>
      <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">KeyCabinet</span><span class="o">.</span><span class="na">GetKeys</span><span class="o">&gt;</span> <span class="n">keyCabinet</span><span class="o">,</span>
      <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Drawer</span><span class="o">.</span><span class="na">GetWallet</span><span class="o">&gt;</span> <span class="n">drawer</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">whoIsLeaving</span> <span class="o">=</span> <span class="n">whoIsLeaving</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">keyCabinet</span> <span class="o">=</span> <span class="n">keyCabinet</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">drawer</span> <span class="o">=</span> <span class="n">drawer</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Wallet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onWallet</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Keys</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onKeys</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">onWallet</span><span class="o">(</span><span class="nc">Wallet</span> <span class="n">wallet</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">wallet</span> <span class="o">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">wallet</span><span class="o">);</span>
    <span class="k">return</span> <span class="nf">completeOrContinue</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">onKeys</span><span class="o">(</span><span class="nc">Keys</span> <span class="n">keys</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">keys</span> <span class="o">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">keys</span><span class="o">);</span>
    <span class="k">return</span> <span class="nf">completeOrContinue</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">completeOrContinue</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">wallet</span><span class="o">.</span><span class="na">isPresent</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">keys</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Home</span><span class="o">.</span><span class="na">ReadyToLeaveHome</span><span class="o">(</span><span class="n">whoIsLeaving</span><span class="o">,</span> <span class="n">keys</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span> <span class="n">wallet</span><span class="o">.</span><span class="na">get</span><span class="o">()));</span>
      <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">stopped</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨å®é™…çš„ä¼šè¯å­èŠ‚ç‚¹ä¸­ï¼Œæ‚¨å¯èƒ½è¿˜å¸Œæœ›åŒ…æ‹¬æŸç§å½¢å¼çš„è¶…æ—¶(è¯·å‚é˜…<a href="https://doc.akka.io/docs/akka/current/typed/interaction-patterns.html#scheduling-messages-to-self">å°†æ¶ˆæ¯è°ƒåº¦åˆ°self</a>)ã€‚</p>

<p>æœ‰ç”¨çš„æ—¶å€™:</p>
<ul>
  <li>åœ¨æ„å»ºç»“æœä¹‹å‰ï¼Œå•ä¸ªä¼ å…¥è¯·æ±‚åº”è¯¥ä¸å…¶ä»–Actorè¿›è¡Œå¤šæ¬¡äº¤äº’ï¼Œä¾‹å¦‚å¤šä¸ªç»“æœçš„èšåˆ</li>
  <li>æ‚¨éœ€è¦å¤„ç†ç¡®è®¤å’Œé‡è¯•æ¶ˆæ¯ï¼Œä»¥ä¾¿è‡³å°‘ä¼ é€’ä¸€æ¬¡</li>
</ul>

<p>é—®é¢˜:</p>
<ul>
  <li>å¿…é¡»å¯¹å­èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸè¿›è¡Œç®¡ç†ï¼Œä»¥é¿å…é€ æˆèµ„æºæ³„æ¼ï¼Œå› æ­¤å¾ˆå®¹æ˜“å¿½ç•¥æœªåœæ­¢ä¼šè¯Actorçš„åœºæ™¯</li>
  <li>å®ƒå¢åŠ äº†å¤æ‚æ€§ï¼Œå› ä¸ºæ¯ä¸ªè¿™æ ·çš„å­èŠ‚ç‚¹éƒ½å¯ä»¥ä¸å…¶ä»–å­èŠ‚ç‚¹å’Œçˆ¶èŠ‚ç‚¹å¹¶å‘æ‰§è¡Œ</li>
</ul>

<h3 id="4411-é€šç”¨å“åº”èšåˆå™¨">4.4.11. é€šç”¨å“åº”èšåˆå™¨</h3>

<p>è¿™ç±»ä¼¼äºä¸Šé¢çš„<a href="#4410-æ¯ä¸ªå­—Actorä¼šè¯">æ¯ä¸ªä¼šè¯å­Actoræ¨¡å¼</a>ã€‚æœ‰æ—¶ï¼Œæ‚¨å¯èƒ½ä¼šé‡å¤ä»¥ç›¸åŒçš„æ–¹å¼èšåˆåº”ç­”ï¼Œå¹¶å¸Œæœ›å°†å…¶æå–åˆ°å¯é‡ç”¨çš„Actorã€‚</p>

<p>æ­¤æ¨¡å¼æœ‰è®¸å¤šå˜ä½“ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå°†å…¶ä½œä¸ºæ–‡æ¡£ç¤ºä¾‹è€Œä¸æ˜¯Akkaä¸­çš„å†…å»ºè¡Œä¸ºæä¾›çš„åŸå› ã€‚å®ƒæ—¨åœ¨æ ¹æ®æ‚¨çš„å…·ä½“éœ€è¦è¿›è¡Œè°ƒæ•´ã€‚</p>

<p>ç¤ºä¾‹ï¼š</p>

<p><img src="https://liulv.work/images/img/20200826141327.png" alt="20200826141327" /></p>

<p>æ­¤ç¤ºä¾‹æ˜¯é¢„æœŸåº”ç­”æ•°é‡çš„èšåˆå™¨ã€‚æŠ¥ä»·è¯·æ±‚é€šè¿‡ç»™å®šçš„sendrequestå‡½æ•°å‘é€ç»™ä¸¤ä¸ªé…’åº—Actorï¼Œå®ƒä»¬ä½¿ç”¨ä¸åŒçš„åè®®ã€‚å½“ä¸¤ä¸ªé¢„æœŸçš„å“åº”éƒ½è¢«æ”¶é›†ä¹‹åï¼Œå®ƒä»¬å°†ä½¿ç”¨ç»™å®šçš„aggregateReplieså‡½æ•°è¿›è¡Œèšåˆå¹¶å‘é€å›replyToã€‚å¦‚æœå“åº”æ²¡æœ‰åœ¨è¶…æ—¶å†…åˆ°è¾¾ï¼Œåˆ™èšåˆåˆ°ç›®å‰ä¸ºæ­¢çš„å“åº”å¹¶å‘é€å›replyToã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hotel1</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">RequestQuote</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Quote</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">RequestQuote</span><span class="o">(</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Quote</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Quote</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">hotel</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">BigDecimal</span> <span class="n">price</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Quote</span><span class="o">(</span><span class="nc">String</span> <span class="n">hotel</span><span class="o">,</span> <span class="nc">BigDecimal</span> <span class="n">price</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">hotel</span> <span class="o">=</span> <span class="n">hotel</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">price</span> <span class="o">=</span> <span class="n">price</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hotel2</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">RequestPrice</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Price</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">RequestPrice</span><span class="o">(</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Price</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Price</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">hotel</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">BigDecimal</span> <span class="n">price</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Price</span><span class="o">(</span><span class="nc">String</span> <span class="n">hotel</span><span class="o">,</span> <span class="nc">BigDecimal</span> <span class="n">price</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">hotel</span> <span class="o">=</span> <span class="n">hotel</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">price</span> <span class="o">=</span> <span class="n">price</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HotelCustomer</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">HotelCustomer</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Quote</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">hotel</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">BigDecimal</span> <span class="n">price</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Quote</span><span class="o">(</span><span class="nc">String</span> <span class="n">hotel</span><span class="o">,</span> <span class="nc">BigDecimal</span> <span class="n">price</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">hotel</span> <span class="o">=</span> <span class="n">hotel</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">price</span> <span class="o">=</span> <span class="n">price</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AggregatedQuotes</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Quote</span><span class="o">&gt;</span> <span class="n">quotes</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">AggregatedQuotes</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Quote</span><span class="o">&gt;</span> <span class="n">quotes</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">quotes</span> <span class="o">=</span> <span class="n">quotes</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span>
      <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Hotel1</span><span class="o">.</span><span class="na">RequestQuote</span><span class="o">&gt;</span> <span class="n">hotel1</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Hotel2</span><span class="o">.</span><span class="na">RequestPrice</span><span class="o">&gt;</span> <span class="n">hotel2</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="n">context</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">HotelCustomer</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">hotel1</span><span class="o">,</span> <span class="n">hotel2</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nf">HotelCustomer</span><span class="o">(</span>
      <span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span>
      <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Hotel1</span><span class="o">.</span><span class="na">RequestQuote</span><span class="o">&gt;</span> <span class="n">hotel1</span><span class="o">,</span>
      <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Hotel2</span><span class="o">.</span><span class="na">RequestPrice</span><span class="o">&gt;</span> <span class="n">hotel2</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>

    <span class="nc">Consumer</span><span class="o">&lt;</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">sendRequests</span> <span class="o">=</span>
        <span class="n">replyTo</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="n">hotel1</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Hotel1</span><span class="o">.</span><span class="na">RequestQuote</span><span class="o">(</span><span class="n">replyTo</span><span class="o">.</span><span class="na">narrow</span><span class="o">()));</span>
          <span class="n">hotel2</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Hotel2</span><span class="o">.</span><span class="na">RequestPrice</span><span class="o">(</span><span class="n">replyTo</span><span class="o">.</span><span class="na">narrow</span><span class="o">()));</span>
        <span class="o">};</span>

    <span class="kt">int</span> <span class="n">expectedReplies</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
    <span class="c1">// Object since no common type between Hotel1 and Hotel2</span>
    <span class="n">context</span><span class="o">.</span><span class="na">spawnAnonymous</span><span class="o">(</span>
        <span class="nc">Aggregator</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
            <span class="nc">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">sendRequests</span><span class="o">,</span>
            <span class="n">expectedReplies</span><span class="o">,</span>
            <span class="n">context</span><span class="o">.</span><span class="na">getSelf</span><span class="o">(),</span>
            <span class="k">this</span><span class="o">::</span><span class="n">aggregateReplies</span><span class="o">,</span>
            <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">5</span><span class="o">)));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">AggregatedQuotes</span> <span class="nf">aggregateReplies</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">replies</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Quote</span><span class="o">&gt;</span> <span class="n">quotes</span> <span class="o">=</span>
        <span class="n">replies</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
            <span class="o">.</span><span class="na">map</span><span class="o">(</span>
                <span class="n">r</span> <span class="o">-&gt;</span> <span class="o">{</span>
                  <span class="c1">// The hotels have different protocols with different replies,</span>
                  <span class="c1">// convert them to `HotelCustomer.Quote` that this actor understands.</span>
                  <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="k">instanceof</span> <span class="nc">Hotel1</span><span class="o">.</span><span class="na">Quote</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">Hotel1</span><span class="o">.</span><span class="na">Quote</span> <span class="n">q</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Hotel1</span><span class="o">.</span><span class="na">Quote</span><span class="o">)</span> <span class="n">r</span><span class="o">;</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nf">Quote</span><span class="o">(</span><span class="n">q</span><span class="o">.</span><span class="na">hotel</span><span class="o">,</span> <span class="n">q</span><span class="o">.</span><span class="na">price</span><span class="o">);</span>
                  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="k">instanceof</span> <span class="nc">Hotel2</span><span class="o">.</span><span class="na">Price</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">Hotel2</span><span class="o">.</span><span class="na">Price</span> <span class="n">p</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Hotel2</span><span class="o">.</span><span class="na">Price</span><span class="o">)</span> <span class="n">r</span><span class="o">;</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nf">Quote</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">hotel</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">price</span><span class="o">);</span>
                  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Unknown reply "</span> <span class="o">+</span> <span class="n">r</span><span class="o">);</span>
                  <span class="o">}</span>
                <span class="o">})</span>
            <span class="o">.</span><span class="na">sorted</span><span class="o">((</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="na">price</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">b</span><span class="o">.</span><span class="na">price</span><span class="o">))</span>
            <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nf">AggregatedQuotes</span><span class="o">(</span><span class="n">quotes</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">AggregatedQuotes</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onAggregatedQuotes</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onAggregatedQuotes</span><span class="o">(</span><span class="nc">AggregatedQuotes</span> <span class="n">aggregated</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">aggregated</span><span class="o">.</span><span class="na">quotes</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Best Quote N/A"</span><span class="o">);</span>
    <span class="k">else</span> <span class="nf">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Best {}"</span><span class="o">,</span> <span class="n">aggregated</span><span class="o">.</span><span class="na">quotes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Aggregatorèšåˆå™¨çš„å®ç°:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">akka.actor.typed.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.Behavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.AbstractBehavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.ActorContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Behaviors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Receive</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.Duration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.function.Consumer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.function.Function</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Aggregator</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">,</span> <span class="nc">Aggregate</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Aggregator</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">private</span> <span class="kd">enum</span> <span class="nc">ReceiveTimeout</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="no">INSTANCE</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">class</span> <span class="nc">WrappedReply</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">Reply</span> <span class="n">reply</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">WrappedReply</span><span class="o">(</span><span class="nc">Reply</span> <span class="n">reply</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">reply</span> <span class="o">=</span> <span class="n">reply</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">R</span><span class="o">,</span> <span class="no">A</span><span class="o">&gt;</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span>
      <span class="nc">Class</span><span class="o">&lt;</span><span class="no">R</span><span class="o">&gt;</span> <span class="n">replyClass</span><span class="o">,</span>
      <span class="nc">Consumer</span><span class="o">&lt;</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="no">R</span><span class="o">&gt;&gt;</span> <span class="n">sendRequests</span><span class="o">,</span>
      <span class="kt">int</span> <span class="n">expectedReplies</span><span class="o">,</span>
      <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="no">A</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">,</span>
      <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="no">R</span><span class="o">&gt;,</span> <span class="no">A</span><span class="o">&gt;</span> <span class="n">aggregateReplies</span><span class="o">,</span>
      <span class="nc">Duration</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span>
        <span class="n">context</span> <span class="o">-&gt;</span>
            <span class="k">new</span> <span class="nc">Aggregator</span><span class="o">&lt;</span><span class="no">R</span><span class="o">,</span> <span class="no">A</span><span class="o">&gt;(</span>
                <span class="n">replyClass</span><span class="o">,</span>
                <span class="n">context</span><span class="o">,</span>
                <span class="n">sendRequests</span><span class="o">,</span>
                <span class="n">expectedReplies</span><span class="o">,</span>
                <span class="n">replyTo</span><span class="o">,</span>
                <span class="n">aggregateReplies</span><span class="o">,</span>
                <span class="n">timeout</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">expectedReplies</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Aggregate</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">&gt;,</span> <span class="nc">Aggregate</span><span class="o">&gt;</span> <span class="n">aggregateReplies</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">&gt;</span> <span class="n">replies</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

  <span class="kd">private</span> <span class="nf">Aggregator</span><span class="o">(</span>
      <span class="nc">Class</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">&gt;</span> <span class="n">replyClass</span><span class="o">,</span>
      <span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span>
      <span class="nc">Consumer</span><span class="o">&lt;</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">&gt;&gt;</span> <span class="n">sendRequests</span><span class="o">,</span>
      <span class="kt">int</span> <span class="n">expectedReplies</span><span class="o">,</span>
      <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Aggregate</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">,</span>
      <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">&gt;,</span> <span class="nc">Aggregate</span><span class="o">&gt;</span> <span class="n">aggregateReplies</span><span class="o">,</span>
      <span class="nc">Duration</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">expectedReplies</span> <span class="o">=</span> <span class="n">expectedReplies</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">aggregateReplies</span> <span class="o">=</span> <span class="n">aggregateReplies</span><span class="o">;</span>

    <span class="n">context</span><span class="o">.</span><span class="na">setReceiveTimeout</span><span class="o">(</span><span class="n">timeout</span><span class="o">,</span> <span class="nc">ReceiveTimeout</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>

    <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">&gt;</span> <span class="n">replyAdapter</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">messageAdapter</span><span class="o">(</span><span class="n">replyClass</span><span class="o">,</span> <span class="nl">WrappedReply:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
    <span class="n">sendRequests</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">replyAdapter</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">WrappedReply</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onReply</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">ReceiveTimeout</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">notUsed</span> <span class="o">-&gt;</span> <span class="n">onReceiveTimeout</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onReply</span><span class="o">(</span><span class="nc">WrappedReply</span> <span class="n">wrappedReply</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Reply</span> <span class="n">reply</span> <span class="o">=</span> <span class="n">wrappedReply</span><span class="o">.</span><span class="na">reply</span><span class="o">;</span>
    <span class="n">replies</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">reply</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">replies</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="n">expectedReplies</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Aggregate</span> <span class="n">result</span> <span class="o">=</span> <span class="n">aggregateReplies</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">replies</span><span class="o">);</span>
      <span class="n">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
      <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">stopped</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onReceiveTimeout</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Aggregate</span> <span class="n">result</span> <span class="o">=</span> <span class="n">aggregateReplies</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">replies</span><span class="o">);</span>
    <span class="n">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">stopped</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä½¿ç”¨åœºæ™¯ï¼š</p>

<ul>
  <li>èšåˆå“åº”åœ¨å¤šä¸ªä½ç½®ä»¥ç›¸åŒçš„æ–¹å¼æ‰§è¡Œï¼Œåº”è¯¥å°†å…¶æå–åˆ°ä¸€ä¸ªæ›´é€šç”¨çš„actorã€‚</li>
  <li>åœ¨æ„å»ºç»“æœä¹‹å‰ï¼Œå•ä¸ªä¼ å…¥è¯·æ±‚åº”è¯¥ä¸å…¶ä»–Actorè¿›è¡Œå¤šæ¬¡äº¤äº’ï¼Œä¾‹å¦‚å¤šä¸ªç»“æœçš„èšåˆ</li>
  <li>æ‚¨éœ€è¦å¤„ç†ç¡®è®¤å’Œé‡è¯•æ¶ˆæ¯ï¼Œä»¥ä¾¿è‡³å°‘ä¼ é€’ä¸€æ¬¡</li>
</ul>

<p>é—®é¢˜ï¼š</p>

<ul>
  <li>å…·æœ‰æ³›å‹ç±»å‹çš„æ¶ˆæ¯åè®®å¾ˆå›°éš¾ï¼Œå› ä¸ºæ³›å‹ç±»å‹åœ¨è¿è¡Œæ—¶è¢«æ“¦é™¤</li>
  <li>å¿…é¡»å¯¹å­èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸè¿›è¡Œç®¡ç†ï¼Œä»¥é¿å…é€ æˆèµ„æºæ³„æ¼ï¼Œå› æ­¤å¾ˆå®¹æ˜“å¿½ç•¥æœªåœæ­¢ä¼šè¯Actorçš„åœºæ™¯</li>
  <li>å®ƒå¢åŠ äº†å¤æ‚æ€§ï¼Œå› ä¸ºæ¯ä¸ªè¿™æ ·çš„å­èŠ‚ç‚¹éƒ½å¯ä»¥ä¸å…¶ä»–å­èŠ‚ç‚¹å’Œçˆ¶èŠ‚ç‚¹å¹¶å‘æ‰§è¡Œ</li>
</ul>

<h3 id="4412-latency-tail-chopping">4.4.12. Latency tail chopping</h3>

<p>è¿™æ˜¯ä¸Šè¿°<a href="#4411-é€šç”¨å“åº”èšåˆå™¨">é€šç”¨å“åº”èšåˆå™¨æ¨¡å¼</a>çš„å˜ä½“ã€‚</p>

<p>æ­¤ç®—æ³•çš„ç›®æ ‡æ˜¯åœ¨å¤šä¸ªç›®æ ‡Actorå¯ä»¥æ‰§è¡Œç›¸åŒçš„å·¥ä½œï¼Œå¹¶ä¸”æŸä¸ªActorçš„å“åº”æœ‰æ—¶å¯èƒ½æ¯”é¢„æœŸçš„è¦æ…¢çš„æƒ…å†µä¸‹ï¼Œå‡å°‘å°¾éƒ¨å»¶è¿Ÿ(â€œåˆ‡æ–­å°¾éƒ¨å»¶è¿Ÿâ€)ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‘å¦ä¸€ä¸ªActorå‘é€ç›¸åŒçš„å·¥ä½œè¯·æ±‚(ä¹Ÿç§°ä¸ºâ€œå¤‡ä»½è¯·æ±‚â€)ä¼šå‡å°‘å“åº”æ—¶é—´â€”â€”å› ä¸ºå¤šä¸ªActorä¸å¤ªå¯èƒ½åŒæ—¶å¤„äºé«˜è´Ÿè½½ä¸‹ã€‚Jeff Dean<a href="https://static.googleusercontent.com/media/research.google.com/en//people/jeff/Berkeley-Latency-Mar2012.pdf">å…³äºåœ¨å¤§å‹åœ¨çº¿æœåŠ¡ä¸­å®ç°å¿«é€Ÿå“åº”æ—¶é—´</a>çš„æ¼”è®²ä¸­å¯¹è¯¥æŠ€æœ¯è¿›è¡Œäº†æ·±å…¥çš„è§£é‡Šã€‚</p>

<p>æ­¤æ¨¡å¼æœ‰è®¸å¤šå˜ä½“ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå°†å…¶ä½œä¸ºæ–‡æ¡£ç¤ºä¾‹è€Œä¸æ˜¯Akkaä¸­çš„å†…å»ºè¡Œä¸ºæä¾›çš„åŸå› ã€‚å®ƒæ—¨åœ¨æ ¹æ®æ‚¨çš„å…·ä½“éœ€è¦è¿›è¡Œè°ƒæ•´ã€‚</p>

<p>ç¤ºä¾‹ï¼š</p>

<p><img src="https://liulv.work/images/img/20200826142401.png" alt="20200826142401" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
</pre></td><td class="rouge-code"><pre><span class="cm">/*
 * Copyright (C) 2019-2020 Lightbend Inc. &lt;https://www.lightbend.com&gt;
 */</span>

<span class="kn">package</span> <span class="nn">jdocs.akka.typed</span><span class="o">;</span>

<span class="c1">// #behavior</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.Behavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.AbstractBehavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.ActorContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Behaviors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Receive</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.TimerScheduler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.Duration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.function.BiFunction</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TailChopping</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">TailChopping</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

  <span class="kd">private</span> <span class="kd">enum</span> <span class="nc">RequestTimeout</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="no">INSTANCE</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">enum</span> <span class="nc">FinalTimeout</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="no">INSTANCE</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">class</span> <span class="nc">WrappedReply</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">Reply</span> <span class="n">reply</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">WrappedReply</span><span class="o">(</span><span class="nc">Reply</span> <span class="n">reply</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">reply</span> <span class="o">=</span> <span class="n">reply</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">R</span><span class="o">&gt;</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span>
      <span class="nc">Class</span><span class="o">&lt;</span><span class="no">R</span><span class="o">&gt;</span> <span class="n">replyClass</span><span class="o">,</span>
      <span class="nc">BiFunction</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="no">R</span><span class="o">&gt;,</span> <span class="nc">Boolean</span><span class="o">&gt;</span> <span class="n">sendRequest</span><span class="o">,</span>
      <span class="nc">Duration</span> <span class="n">nextRequestAfter</span><span class="o">,</span>
      <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="no">R</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">,</span>
      <span class="nc">Duration</span> <span class="n">finalTimeout</span><span class="o">,</span>
      <span class="no">R</span> <span class="n">timeoutReply</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span>
        <span class="n">context</span> <span class="o">-&gt;</span>
            <span class="nc">Behaviors</span><span class="o">.</span><span class="na">withTimers</span><span class="o">(</span>
                <span class="n">timers</span> <span class="o">-&gt;</span>
                    <span class="k">new</span> <span class="nc">TailChopping</span><span class="o">&lt;</span><span class="no">R</span><span class="o">&gt;(</span>
                        <span class="n">replyClass</span><span class="o">,</span>
                        <span class="n">context</span><span class="o">,</span>
                        <span class="n">timers</span><span class="o">,</span>
                        <span class="n">sendRequest</span><span class="o">,</span>
                        <span class="n">nextRequestAfter</span><span class="o">,</span>
                        <span class="n">replyTo</span><span class="o">,</span>
                        <span class="n">finalTimeout</span><span class="o">,</span>
                        <span class="n">timeoutReply</span><span class="o">)));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TimerScheduler</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">timers</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">BiFunction</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">&gt;,</span> <span class="nc">Boolean</span><span class="o">&gt;</span> <span class="n">sendRequest</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Duration</span> <span class="n">nextRequestAfter</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Duration</span> <span class="n">finalTimeout</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Reply</span> <span class="n">timeoutReply</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">&gt;</span> <span class="n">replyAdapter</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kt">int</span> <span class="n">requestCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nf">TailChopping</span><span class="o">(</span>
      <span class="nc">Class</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">&gt;</span> <span class="n">replyClass</span><span class="o">,</span>
      <span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span>
      <span class="nc">TimerScheduler</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">timers</span><span class="o">,</span>
      <span class="nc">BiFunction</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">&gt;,</span> <span class="nc">Boolean</span><span class="o">&gt;</span> <span class="n">sendRequest</span><span class="o">,</span>
      <span class="nc">Duration</span> <span class="n">nextRequestAfter</span><span class="o">,</span>
      <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Reply</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">,</span>
      <span class="nc">Duration</span> <span class="n">finalTimeout</span><span class="o">,</span>
      <span class="nc">Reply</span> <span class="n">timeoutReply</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">timers</span> <span class="o">=</span> <span class="n">timers</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">sendRequest</span> <span class="o">=</span> <span class="n">sendRequest</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">nextRequestAfter</span> <span class="o">=</span> <span class="n">nextRequestAfter</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">finalTimeout</span> <span class="o">=</span> <span class="n">finalTimeout</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">timeoutReply</span> <span class="o">=</span> <span class="n">timeoutReply</span><span class="o">;</span>

    <span class="n">replyAdapter</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">messageAdapter</span><span class="o">(</span><span class="n">replyClass</span><span class="o">,</span> <span class="nl">WrappedReply:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>

    <span class="n">sendNextRequest</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">WrappedReply</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onReply</span><span class="o">)</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">RequestTimeout</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">notUsed</span> <span class="o">-&gt;</span> <span class="n">onRequestTimeout</span><span class="o">())</span>
        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">FinalTimeout</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">notUsed</span> <span class="o">-&gt;</span> <span class="n">onFinalTimeout</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onReply</span><span class="o">(</span><span class="nc">WrappedReply</span> <span class="n">wrappedReply</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Reply</span> <span class="n">reply</span> <span class="o">=</span> <span class="n">wrappedReply</span><span class="o">.</span><span class="na">reply</span><span class="o">;</span>
    <span class="n">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">reply</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">stopped</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onRequestTimeout</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">sendNextRequest</span><span class="o">();</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onFinalTimeout</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">timeoutReply</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">stopped</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">sendNextRequest</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">requestCount</span><span class="o">++;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">sendRequest</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">requestCount</span><span class="o">,</span> <span class="n">replyAdapter</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">timers</span><span class="o">.</span><span class="na">startSingleTimer</span><span class="o">(</span><span class="nc">RequestTimeout</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">,</span> <span class="nc">RequestTimeout</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">,</span> <span class="n">nextRequestAfter</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">timers</span><span class="o">.</span><span class="na">startSingleTimer</span><span class="o">(</span><span class="nc">FinalTimeout</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">,</span> <span class="nc">FinalTimeout</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">,</span> <span class="n">finalTimeout</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="c1">// #behavior</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä½¿ç”¨åœºæ™¯ï¼š</p>

<ul>
  <li>å‡å°‘è¾ƒé«˜çš„å»¶è¿Ÿç™¾åˆ†æ¯”å’Œå»¶è¿Ÿçš„å˜åŒ–éå¸¸é‡è¦</li>
  <li>â€œå·¥ä½œâ€å¯ä»¥åœ¨ç›¸åŒçš„ç»“æœä¸‹è¿›è¡Œå¤šæ¬¡ï¼Œä¾‹å¦‚è¯·æ±‚æ£€ç´¢ä¿¡æ¯</li>
</ul>

<p>é—®é¢˜ï¼š</p>

<ul>
  <li>ç”±äºå‘é€æ›´å¤šæ¶ˆæ¯å’Œå¤šæ¬¡æ‰§è¡Œâ€œå·¥ä½œâ€ï¼Œè´Ÿè½½å¢åŠ </li>
  <li>å½“â€œåŠŸâ€ä¸æ˜¯å¹‚ç­‰ä¸”åªèƒ½æ‰§è¡Œä¸€æ¬¡æ—¶ä¸èƒ½ä½¿ç”¨</li>
  <li>å…·æœ‰æ³›å‹ç±»å‹çš„æ¶ˆæ¯åè®®å¾ˆå›°éš¾ï¼Œå› ä¸ºæ³›å‹ç±»å‹åœ¨è¿è¡Œæ—¶è¢«æ“¦é™¤</li>
  <li>å¿…é¡»å¯¹å­èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸè¿›è¡Œç®¡ç†ï¼Œä»¥é¿å…é€ æˆèµ„æºæ³„æ¼ï¼Œå› æ­¤å¾ˆå®¹æ˜“å¿½ç•¥æœªåœæ­¢ä¼šè¯Actorçš„åœºæ™¯</li>
</ul>

<h3 id="4413-å°†æ¶ˆæ¯è°ƒåº¦åˆ°è‡ªå·±">4.4.13. å°†æ¶ˆæ¯è°ƒåº¦åˆ°è‡ªå·±</h3>

<p>ä¸‹é¢çš„ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨è®¡æ—¶å™¨å°†æ¶ˆæ¯è°ƒåº¦åˆ°actorã€‚</p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>

<p><img src="https://liulv.work/images/img/20200826143653.png" alt="20200826143653" /></p>

<p>Buncher actorç¼“å†²å¤§é‡ä¼ å…¥æ¶ˆæ¯ï¼Œå¹¶åœ¨è¶…æ—¶åæˆ–æ‰¹å¤„ç†çš„æ¶ˆæ¯æ•°é‡è¶…è¿‡æœ€å¤§å¤§å°æ—¶å°†å…¶ä½œä¸ºæ‰¹å¤„ç†äº¤ä»˜ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
</pre></td><td class="rouge-code"><pre> <span class="c1">// #timer</span>
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Buncher</span> <span class="o">{</span>

      <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

      <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Batch</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">messages</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Batch</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">messages</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">this</span><span class="o">.</span><span class="na">messages</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">unmodifiableList</span><span class="o">(</span><span class="n">messages</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">getMessages</span><span class="o">()</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">messages</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// #timer</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">o</span><span class="o">)</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">getClass</span><span class="o">()</span> <span class="o">!=</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
          <span class="nc">Batch</span> <span class="n">batch</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Batch</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
          <span class="k">return</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">messages</span><span class="o">,</span> <span class="n">batch</span><span class="o">.</span><span class="na">messages</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
          <span class="k">return</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">hash</span><span class="o">(</span><span class="n">messages</span><span class="o">);</span>
        <span class="o">}</span> <span class="c1">// #timer</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ExcitingMessage</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">message</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">ExcitingMessage</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Object</span> <span class="no">TIMER_KEY</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>

      <span class="kd">private</span> <span class="kd">enum</span> <span class="nc">Timeout</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
        <span class="no">INSTANCE</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Batch</span><span class="o">&gt;</span> <span class="n">target</span><span class="o">,</span> <span class="nc">Duration</span> <span class="n">after</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxSize</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">withTimers</span><span class="o">(</span><span class="n">timers</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">Buncher</span><span class="o">(</span><span class="n">timers</span><span class="o">,</span> <span class="n">target</span><span class="o">,</span> <span class="n">after</span><span class="o">,</span> <span class="n">maxSize</span><span class="o">).</span><span class="na">idle</span><span class="o">());</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TimerScheduler</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">timers</span><span class="o">;</span>
      <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Batch</span><span class="o">&gt;</span> <span class="n">target</span><span class="o">;</span>
      <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Duration</span> <span class="n">after</span><span class="o">;</span>
      <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">maxSize</span><span class="o">;</span>

      <span class="kd">private</span> <span class="nf">Buncher</span><span class="o">(</span>
          <span class="nc">TimerScheduler</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">timers</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Batch</span><span class="o">&gt;</span> <span class="n">target</span><span class="o">,</span> <span class="nc">Duration</span> <span class="n">after</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxSize</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">timers</span> <span class="o">=</span> <span class="n">timers</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">after</span> <span class="o">=</span> <span class="n">after</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">maxSize</span> <span class="o">=</span> <span class="n">maxSize</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">idle</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="nc">Command</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Command</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onIdleCommand</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onIdleCommand</span><span class="o">(</span><span class="nc">Command</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">timers</span><span class="o">.</span><span class="na">startSingleTimer</span><span class="o">(</span><span class="no">TIMER_KEY</span><span class="o">,</span> <span class="nc">Timeout</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">,</span> <span class="n">after</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="n">context</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">Active</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">message</span><span class="o">));</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kd">class</span> <span class="nc">Active</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

        <span class="nc">Active</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span> <span class="nc">Command</span> <span class="n">firstCommand</span><span class="o">)</span> <span class="o">{</span>
          <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
          <span class="n">buffer</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">firstCommand</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
          <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
              <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Timeout</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">message</span> <span class="o">-&gt;</span> <span class="n">onTimeout</span><span class="o">())</span>
              <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Command</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onCommand</span><span class="o">)</span>
              <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onTimeout</span><span class="o">()</span> <span class="o">{</span>
          <span class="n">target</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Batch</span><span class="o">(</span><span class="n">buffer</span><span class="o">));</span>
          <span class="k">return</span> <span class="nf">idle</span><span class="o">();</span> <span class="c1">// switch to idle</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onCommand</span><span class="o">(</span><span class="nc">Command</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">buffer</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="n">maxSize</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">timers</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="no">TIMER_KEY</span><span class="o">);</span>
            <span class="n">target</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Batch</span><span class="o">(</span><span class="n">buffer</span><span class="o">));</span>
            <span class="k">return</span> <span class="nf">idle</span><span class="o">();</span> <span class="c1">// switch to idle</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span> <span class="c1">// stay Active</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// #timer</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™é‡Œæœ‰å‡ ä»¶äº‹å€¼å¾—æ³¨æ„:</p>

<ul>
  <li>è¦è®¿é—®è®¡æ—¶å™¨ï¼Œé¦–å…ˆä»è¡Œä¸ºå¼€å§‹ã€‚å°†TimerSchedulerå®ä¾‹ä¼ é€’ç»™å‡½æ•°çš„withtimerã€‚è¿™å¯ä»¥ç”¨äºä»»ä½•ç±»å‹çš„è¡Œä¸ºï¼ŒåŒ…æ‹¬æ¥æ”¶ã€receiveMessageï¼Œä½†ä¹Ÿå¯ä»¥ç”¨äºè®¾ç½®æˆ–ä»»ä½•å…¶ä»–è¡Œä¸ºã€‚</li>
  <li>æ¯ä¸ªè®¡æ—¶å™¨éƒ½æœ‰ä¸€ä¸ªé”®ï¼Œå¦‚æœå¯åŠ¨äº†å…·æœ‰ç›¸åŒé”®çš„æ–°è®¡æ—¶å™¨ï¼Œåˆ™å–æ¶ˆä¹‹å‰çš„è®¡æ—¶å™¨ã€‚å®ƒä¿è¯ä¸ä¼šæ”¶åˆ°æ¥è‡ªå‰ä¸€ä¸ªè®¡æ—¶å™¨çš„æ¶ˆæ¯ï¼Œå³ä½¿å®ƒåœ¨æ–°è®¡æ—¶å™¨å¯åŠ¨æ—¶å·²ç»åœ¨é‚®ç®±ä¸­æ’é˜Ÿã€‚</li>
  <li>æ”¯æŒå®šæœŸè®¡æ—¶å™¨å’Œå•æ¶ˆæ¯è®¡æ—¶å™¨ã€‚</li>
  <li>TimerScheduleræœ¬èº«æ˜¯å¯å˜çš„ï¼Œå› ä¸ºå®ƒæ‰§è¡Œå’Œç®¡ç†æ³¨å†Œè®¡åˆ’ä»»åŠ¡çš„å‰¯ä½œç”¨ã€‚</li>
  <li>TimerSchedulerç»‘å®šåˆ°æ‹¥æœ‰å®ƒçš„Actorçš„ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶åœ¨Actoråœæ­¢æ—¶è‡ªåŠ¨å–æ¶ˆã€‚</li>
  <li>è¡Œä¸ºã€‚withtimerä¹Ÿå¯ä»¥åœ¨è¡Œä¸ºå†…éƒ¨ä½¿ç”¨ã€‚ç›‘ç£ï¼Œå®ƒå°†åœ¨actoré‡æ–°å¯åŠ¨æ—¶è‡ªåŠ¨æ­£ç¡®åœ°å–æ¶ˆå·²å¯åŠ¨çš„è®¡æ—¶å™¨ï¼Œä»¥ä¾¿æ–°çš„åŒ–èº«å°†ä¸ä¼šæ¥æ”¶æ¥è‡ªå‰ä¸€ä¸ªåŒ–èº«çš„é¢„å®šæ¶ˆæ¯ã€‚</li>
</ul>

<p><strong>å®šæœŸæ‰§è¡Œ</strong></p>

<p>å¾ªç¯æ¶ˆæ¯çš„è°ƒåº¦å¯ä»¥æœ‰ä¸¤ä¸ªä¸åŒçš„ç‰¹å¾:</p>

<ul>
  <li>å›ºå®šå»¶è¿Ÿâ€”â€”å‘é€åç»­æ¶ˆæ¯ä¹‹é—´çš„å»¶è¿Ÿå°†æ€»æ˜¯(è‡³å°‘)ç»™å®šçš„å»¶è¿Ÿã€‚ä½¿ç”¨startTimerWithFixedDelayã€‚</li>
  <li>å›ºå®šæ¯”ç‡-æ‰§è¡Œçš„é¢‘ç‡åœ¨ä¸€æ®µæ—¶é—´å†…å°†æ»¡è¶³ç»™å®šçš„æ—¶é—´é—´éš”ã€‚ä½¿ç”¨startTimerAtFixedRateã€‚</li>
</ul>

<p>å¦‚æœæ‚¨ä¸ç¡®å®šä½¿ç”¨å“ªä¸€ä¸ªï¼Œæ‚¨åº”è¯¥é€‰æ‹©startTimerWithFixedDelayã€‚</p>

<p>å½“ä½¿ç”¨å›ºå®šå»¶è¿Ÿæ—¶ï¼Œå¦‚æœè°ƒåº¦ç”±äºæŸç§åŸå› å»¶è¿Ÿçš„æ—¶é—´è¶…è¿‡äº†æŒ‡å®šçš„æ—¶é—´ï¼Œå®ƒå°†ä¸ä¼šè¡¥å¿æ¶ˆæ¯ä¹‹é—´çš„å»¶è¿Ÿã€‚å‘é€åç»­æ¶ˆæ¯ä¹‹é—´çš„å»¶è¿Ÿå°†å§‹ç»ˆ(è‡³å°‘)æ˜¯ç»™å®šçš„å»¶è¿Ÿã€‚ä»é•¿è¿œæ¥çœ‹ï¼Œæ¶ˆæ¯çš„é¢‘ç‡é€šå¸¸ä¼šç•¥ä½äºæŒ‡å®šå»¶è¿Ÿçš„å€’æ•°ã€‚
å›ºå®šå»¶è¿Ÿæ‰§è¡Œé€‚ç”¨äºéœ€è¦â€œå¹³æ»‘æ€§â€çš„é‡å¤æ´»åŠ¨ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒé€‚ç”¨äºé‚£äº›çŸ­æœŸå†…ä¿æŒé¢‘ç‡å‡†ç¡®æ¯”é•¿æœŸæ›´é‡è¦çš„æ´»åŠ¨ã€‚</p>

<p>å½“ä½¿ç”¨å›ºå®šé€Ÿç‡æ—¶ï¼Œå¦‚æœå…ˆå‰çš„æ¶ˆæ¯å»¶è¿Ÿå¤ªä¹…ï¼Œå®ƒå°†è¡¥å¿åç»­ä»»åŠ¡çš„å»¶è¿Ÿã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®é™…çš„å‘é€æ—¶é—´é—´éš”å°†ä¸ä¼ é€’ç»™scheduleAtFixedRateæ–¹æ³•çš„æ—¶é—´é—´éš”ä¸åŒã€‚
å¦‚æœä»»åŠ¡çš„å»¶è¿Ÿæ—¶é—´è¶…è¿‡äº†æ—¶é—´é—´éš”ï¼Œåˆ™éšåçš„æ¶ˆæ¯å°†ç«‹å³åœ¨å‰ä¸€æ¡æ¶ˆæ¯ä¹‹åå‘é€ã€‚è¿™è¿˜ä¼šé€ æˆè¿™æ ·çš„åæœ:åœ¨é•¿æ—¶é—´çš„åƒåœ¾æ”¶é›†æš‚åœä¹‹åï¼Œæˆ–è€…JVMè¢«æŒ‚èµ·æ—¶ï¼Œæ‰€æœ‰â€œé”™è¿‡çš„â€ä»»åŠ¡éƒ½å°†åœ¨è¿›ç¨‹å†æ¬¡å”¤é†’æ—¶æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œä»¥1ç§’é—´éš”çš„scheduleAtFixedRateè¿›ç¨‹è¢«æŒ‚èµ·30ç§’å°†å¯¼è‡´30æ¡æ¶ˆæ¯è¢«å¿«é€Ÿè¿ç»­åœ°å‘é€ä»¥èµ¶ä¸Šã€‚åœ¨é•¿æœŸè¿è¡Œä¸­ï¼Œæ‰§è¡Œçš„é¢‘ç‡å°†æ°å¥½æ˜¯æŒ‡å®šæ—¶é—´é—´éš”çš„å€’æ•°ã€‚</p>

<p>å›ºå®šé€Ÿç‡æ‰§è¡Œé€‚åˆäºå¯¹ç»å¯¹æ—¶é—´æ•æ„Ÿçš„é‡å¤æ´»åŠ¨ï¼Œæˆ–è€…æ‰§è¡Œå›ºå®šæ¬¡æ•°æ‰§è¡Œçš„æ€»æ—¶é—´å¾ˆé‡è¦çš„æƒ…å†µï¼Œä¾‹å¦‚æ¯ç§’é’Ÿè®¡æ—¶ä¸€æ¬¡ï¼ŒæŒç»­10ç§’çš„å€’è®¡æ—¶è®¡æ—¶å™¨ã€‚</p>

<blockquote>
  <p>è­¦å‘Š</p>
</blockquote>

<blockquote>
  <p>åœ¨é•¿æ—¶é—´çš„åƒåœ¾æ”¶é›†æš‚åœä¹‹åï¼ŒscheduleAtFixedRateè­¦å‘Šå¯èƒ½ä¼šå¯¼è‡´è®¡åˆ’æ¶ˆæ¯çˆ†å‘ï¼Œåœ¨æœ€åçš„æƒ…å†µä¸‹ï¼Œè¿™å¯èƒ½ä¼šåœ¨ç³»ç»Ÿä¸Šé€ æˆä¸éœ€è¦çš„è´Ÿè½½ã€‚æœ‰å›ºå®šå»¶è¿Ÿçš„æ—¥ç¨‹å®‰æ’é€šå¸¸æ˜¯é¦–é€‰ã€‚</p>
</blockquote>

<h3 id="4414-å›åº”ä¸€ä¸ªåˆ†ç‰‡çš„actor">4.4.14. å›åº”ä¸€ä¸ªåˆ†ç‰‡çš„actor</h3>

<p>å½“ä½¿ç”¨Akkaé›†ç¾¤å¯¹actorè¿›è¡Œåˆ†ç‰‡æ—¶ï¼Œæ‚¨éœ€è¦è€ƒè™‘åˆ°actorå¯èƒ½ä¼šç§»åŠ¨æˆ–è¢«é’åŒ–ã€‚</p>

<p>é¢„æœŸåº”ç­”çš„æ­£å¸¸æ¨¡å¼æ˜¯åœ¨æ¶ˆæ¯ä¸­åŒ…å«ä¸€ä¸ªActorRefï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªæ¶ˆæ¯é€‚é…å™¨ã€‚è¿™å¯ä»¥ç”¨äºåˆ‡åˆ†çš„actorï¼Œä½†æ˜¯å¦‚æœå‘é€äº†ctx.getSelf()ï¼Œå¹¶ä¸”åˆ‡åˆ†çš„actorè¢«ç§»åŠ¨æˆ–é’åŒ–ï¼Œé‚£ä¹ˆå›å¤å°†å‘é€åˆ°æ­»å­—æ¯ã€‚</p>

<p>å¦ä¸€ç§æ–¹æ³•æ˜¯åœ¨æ¶ˆæ¯ä¸­å‘é€entityIdï¼Œå¹¶é€šè¿‡åˆ†ç‰‡å‘é€åº”ç­”ã€‚</p>

<p><strong>ç¤ºä¾‹</strong></p>

<p><img src="https://liulv.work/images/img/20200826143633.png" alt="20200826143633" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
</pre></td><td class="rouge-code"><pre><span class="cm">/*
 * Copyright (C) 2018-2020 Lightbend Inc. &lt;https://www.lightbend.com&gt;
 */</span>

<span class="kn">package</span> <span class="nn">jdocs.akka.cluster.sharding.typed</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">akka.actor.typed.Behavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.AbstractBehavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.ActorContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Behaviors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Receive</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.cluster.sharding.typed.javadsl.ClusterSharding</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.cluster.sharding.typed.javadsl.EntityRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.cluster.sharding.typed.javadsl.EntityTypeKey</span><span class="o">;</span>

<span class="kd">interface</span> <span class="nc">ShardingReplyCompileOnlyTest</span> <span class="o">{</span>

  <span class="c1">// #sharded-response</span>
  <span class="c1">// a sharded actor that needs counter updates</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">CounterConsumer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">EntityTypeKey</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">typeKey</span> <span class="o">=</span>
        <span class="nc">EntityTypeKey</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">Command</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"example-sharded-response"</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">NewCount</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">value</span><span class="o">;</span>

      <span class="kd">public</span> <span class="nf">NewCount</span><span class="o">(</span><span class="kt">long</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1">// a sharded counter that sends responses to another sharded actor</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Counter</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Counter</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">EntityTypeKey</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">typeKey</span> <span class="o">=</span>
        <span class="nc">EntityTypeKey</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">Command</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"example-sharded-counter"</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

    <span class="kd">public</span> <span class="kd">enum</span> <span class="nc">Increment</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
      <span class="no">INSTANCE</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">GetValue</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">replyToEntityId</span><span class="o">;</span>

      <span class="kd">public</span> <span class="nf">GetValue</span><span class="o">(</span><span class="nc">String</span> <span class="n">replyToEntityId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">replyToEntityId</span> <span class="o">=</span> <span class="n">replyToEntityId</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">Counter:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ClusterSharding</span> <span class="n">sharding</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">Counter</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">sharding</span> <span class="o">=</span> <span class="nc">ClusterSharding</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getSystem</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
          <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Increment</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="n">onIncrement</span><span class="o">())</span>
          <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">GetValue</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onGetValue</span><span class="o">)</span>
          <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onIncrement</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">value</span><span class="o">++;</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onGetValue</span><span class="o">(</span><span class="nc">GetValue</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">EntityRef</span><span class="o">&lt;</span><span class="nc">CounterConsumer</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">entityRef</span> <span class="o">=</span>
          <span class="n">sharding</span><span class="o">.</span><span class="na">entityRefFor</span><span class="o">(</span><span class="nc">CounterConsumer</span><span class="o">.</span><span class="na">typeKey</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">replyToEntityId</span><span class="o">);</span>
      <span class="n">entityRef</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">CounterConsumer</span><span class="o">.</span><span class="na">NewCount</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="c1">// #sharded-response</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç¼ºç‚¹æ˜¯ä¸èƒ½ä½¿ç”¨æ¶ˆæ¯é€‚é…å™¨ï¼Œå› æ­¤å“åº”å¿…é¡»ä½äºè¢«å“åº”çš„actorçš„åè®®ä¸­ã€‚å¦å¤–ï¼Œå¦‚æœä¸çŸ¥é“EntityTypeKeyæ˜¯é™æ€çš„ï¼Œåˆ™å¯ä»¥å°†å…¶åŒ…å«åœ¨æ¶ˆæ¯ä¸­ã€‚</p>

<h2 id="45-actorå®¹é”™">4.5. Actorå®¹é”™</h2>

<p>å½“actoråœ¨å¤„ç†æ¶ˆæ¯æˆ–åˆå§‹åŒ–è¿‡ç¨‹ä¸­æŠ›å‡ºæ„å¤–å¼‚å¸¸æˆ–å¤±è´¥æ—¶, actorå°†é»˜è®¤åœæ­¢ã€‚</p>

<blockquote>
  <p><strong>è¯·æ³¨æ„</strong></p>

  <p>ç±»å‹actorå’Œç»å…¸actorä¹‹é—´çš„ä¸€ä¸ªé‡è¦åŒºåˆ«æ˜¯ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹:å‰è€…åœ¨æŠ›å‡ºå¼‚å¸¸æ—¶åœæ­¢ï¼Œå¹¶ä¸”åœ¨ç»å…¸ä¸­é‡æ–°å¯åŠ¨æ—¶æ²¡æœ‰å®šä¹‰ç›‘æ§ç­–ç•¥ã€‚</p>
</blockquote>

<p>æ³¨æ„ï¼Œå¤±è´¥å’ŒéªŒè¯é”™è¯¯ä¹‹é—´æœ‰ä¸€ä¸ªé‡è¦çš„åŒºåˆ«:</p>

<p>éªŒè¯é”™è¯¯æ„å‘³ç€å‘é€ç»™Actorçš„å‘½ä»¤æ•°æ®æ˜¯æ— æ•ˆçš„ï¼Œè¿™åº”è¯¥è¢«å»ºæ¨¡ä¸ºActoråè®®çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯è®©ActoræŠ›å‡ºå¼‚å¸¸ã€‚</p>

<p>ç›¸åï¼Œå¤±è´¥æ˜¯Actorè‡ªèº«æ— æ³•æ§åˆ¶çš„æ„å¤–äº‹ä»¶ï¼Œä¾‹å¦‚æ•°æ®åº“è¿æ¥ä¸­æ–­ã€‚ä¸éªŒè¯é”™è¯¯ç›¸åï¼Œå®ƒå¾ˆå°‘å¯¹ä½œä¸ºåè®®ä¸€éƒ¨åˆ†çš„å¤±è´¥å»ºæ¨¡æœ‰ç”¨ï¼Œå› ä¸ºå‘é€æ–¹å¾ˆå°‘èƒ½å¯¹å®ƒåšä»»ä½•æœ‰ç”¨çš„äº‹æƒ…ã€‚
å¯¹äºå¤±è´¥ï¼Œåº”ç”¨â€œè®©å®ƒå´©æºƒâ€çš„å“²å­¦æ˜¯æœ‰ç”¨çš„:æˆ‘ä»¬å°†è´£ä»»è½¬ç§»åˆ°å…¶ä»–åœ°æ–¹ï¼Œè€Œä¸æ˜¯å°†ç”±äºå¤±è´¥è€Œéƒ¨åˆ†å¤±æ•ˆçš„å†…éƒ¨çŠ¶æ€çš„ç»†ç²’åº¦æ¢å¤å’Œä¿®æ­£ä¸ä¸šåŠ¡é€»è¾‘æ··åˆåœ¨ä¸€èµ·ã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œè§£å†³æ–¹æ³•å¯ä»¥æ˜¯â€œå´©æºƒâ€Actorï¼Œç„¶åä½¿ç”¨æˆ‘ä»¬çŸ¥é“æœ‰æ•ˆçš„æ–°çŠ¶æ€å¯åŠ¨ä¸€ä¸ªæ–°çš„Actorã€‚</p>

<h4 id="4501-ç›‘ç®¡">4.5.0.1. ç›‘ç®¡</h4>

<p>åœ¨Akkaï¼Œè¿™ä¸ªâ€œæŸå¤„â€è¢«ç§°ä¸ºç›‘ç£ã€‚ç›‘è§†å…è®¸æ‚¨ä»¥å£°æ˜çš„æ–¹å¼æè¿°åœ¨actorä¸­æŠ›å‡ºæŸäº›ç±»å‹çš„å¼‚å¸¸æ—¶åº”è¯¥å‘ç”Ÿä»€ä¹ˆã€‚
é»˜è®¤çš„ç›‘æ§ç­–ç•¥æ˜¯åœ¨æŠ›å‡ºå¼‚å¸¸æ—¶åœæ­¢actorã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œæ‚¨éœ€è¦è¿›ä¸€æ­¥å®šåˆ¶æ­¤è¡Œä¸ºã€‚è¦ä½¿ç”¨ç›‘ç£ï¼Œå®é™…çš„å‚ä¸è€…è¡Œä¸ºæ˜¯ç”¨behaviors . supervisionæ¥åŒ…è£…çš„ã€‚é€šå¸¸ï¼Œå½“å°†actorä½œä¸ºå­å…ƒç´ ç”Ÿæˆæ—¶ï¼Œæ‚¨ä¼šåœ¨çˆ¶å…ƒç´ ä¸­å°è£…å¸¦æœ‰ç›‘ç£çš„actorã€‚</p>

<p>è¿™ä¸ªä¾‹å­åœ¨actorå¤±è´¥æ—¶é€šè¿‡IllegalStateExceptioné‡æ–°å¯åŠ¨å®ƒ:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nc">Behaviors</span><span class="o">.</span><span class="na">supervise</span><span class="o">(</span><span class="n">behavior</span><span class="o">)</span>
    <span class="o">.</span><span class="na">onFailure</span><span class="o">(</span><span class="nc">IllegalStateException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">SupervisorStrategy</span><span class="o">.</span><span class="na">restart</span><span class="o">());</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æˆ–è€…ç»§ç»­ï¼Œå¿½ç•¥å¤±è´¥å¹¶å¤„ç†ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nc">Behaviors</span><span class="o">.</span><span class="na">supervise</span><span class="o">(</span><span class="n">behavior</span><span class="o">)</span>
    <span class="o">.</span><span class="na">onFailure</span><span class="o">(</span><span class="nc">IllegalStateException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">SupervisorStrategy</span><span class="o">.</span><span class="na">resume</span><span class="o">());</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥ä½¿ç”¨æ›´å¤æ‚çš„é‡å¯ç­–ç•¥ï¼Œä¾‹å¦‚åœ¨10ç§’å†…é‡å¯ä¸è¶…è¿‡10æ¬¡:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nc">Behaviors</span><span class="o">.</span><span class="na">supervise</span><span class="o">(</span><span class="n">behavior</span><span class="o">)</span>
    <span class="o">.</span><span class="na">onFailure</span><span class="o">(</span>
        <span class="nc">IllegalStateException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
        <span class="nc">SupervisorStrategy</span><span class="o">.</span><span class="na">restart</span><span class="o">().</span><span class="na">withLimit</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">10</span><span class="o">)));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¤„ç†ä¸åŒçš„å¼‚å¸¸ä¸ä¸åŒçš„ç­–ç•¥ï¼Œè°ƒç”¨ç›‘ç£å¯ä»¥åµŒå¥—:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nc">Behaviors</span><span class="o">.</span><span class="na">supervise</span><span class="o">(</span>
        <span class="nc">Behaviors</span><span class="o">.</span><span class="na">supervise</span><span class="o">(</span><span class="n">behavior</span><span class="o">)</span>
            <span class="o">.</span><span class="na">onFailure</span><span class="o">(</span><span class="nc">IllegalStateException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">SupervisorStrategy</span><span class="o">.</span><span class="na">restart</span><span class="o">()))</span>
    <span class="o">.</span><span class="na">onFailure</span><span class="o">(</span><span class="nc">IllegalArgumentException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">SupervisorStrategy</span><span class="o">.</span><span class="na">stop</span><span class="o">());</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¦‚éœ€å®Œæ•´çš„ç­–ç•¥åˆ—è¡¨ï¼Œè¯·å‚é˜…<a href="https://doc.akka.io/japi/akka/2.6/akka/actor/typed/SupervisorStrategy.html">ç›‘ç®¡ç­–ç•¥</a>ä¸­çš„å…¬å…±æ–¹æ³•ã€‚</p>

<blockquote>
  <p><strong>è¯·æ³¨æ„</strong>
å½“è¡Œä¸ºè¢«é‡æ–°å¯åŠ¨æ—¶ï¼ŒåŸæ¥çš„è¡Œä¸ºè¢«ç»™äºˆè¡Œä¸ºã€‚superviseè¢«é‡æ–°å®‰è£…ï¼Œè¿™æ„å‘³ç€å¦‚æœå®ƒåŒ…å«å¯å˜çŠ¶æ€ï¼Œé‚£ä¹ˆå®ƒå¿…é¡»æ˜¯é€šè¿‡Behaviors.setupå®ç°çš„å·¥å‚ã€‚å½“å¯¹æ‰©å±•AbstractBehaviorçš„ç±»ä½¿ç”¨é¢å‘å¯¹è±¡é£æ ¼æ—¶ï¼Œæ€»æ˜¯å»ºè®®é€šè¿‡è¡Œä¸ºæ¥åˆ›å»ºå®ƒã€‚æŒ‰ç…§è¡Œä¸ºå·¥å‚æ–¹æ³•ä¸­æè¿°çš„è®¾ç½®ã€‚å¯¹äºå‡½æ•°æ ·å¼ï¼Œå¦‚æœçŠ¶æ€åœ¨ä¸å¯å˜å‚æ•°ä¸­æ•è·ï¼Œåˆ™é€šå¸¸ä¸éœ€è¦ä½¿ç”¨å·¥å‚ã€‚</p>
</blockquote>

<p><strong>åŒ…è£…è¡Œä¸º</strong></p>

<p>å¯¹äºå‡½æ•°æ ·å¼ï¼Œé€šè¿‡æ”¹å˜è¡Œä¸ºæ¥å­˜å‚¨çŠ¶æ€æ˜¯å¾ˆå¸¸è§çš„ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre></td><td class="rouge-code"><pre><span class="cm">/*
 * Copyright (C) 2018-2020 Lightbend Inc. &lt;https://www.lightbend.com&gt;
 */</span>

<span class="kn">package</span> <span class="nn">jdocs.akka.typed.supervision</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">akka.actor.typed.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Behaviors</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.Duration</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SupervisionCompileOnlyTest</span> <span class="o">{</span>
  <span class="c1">// #wrap</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Counter</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Increase</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Get</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Got</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

      <span class="kd">public</span> <span class="nf">Get</span><span class="o">(</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Got</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Got</span> <span class="o">{</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">n</span><span class="o">;</span>

      <span class="kd">public</span> <span class="nf">Got</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// #top-level</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">supervise</span><span class="o">(</span><span class="n">counter</span><span class="o">(</span><span class="mi">1</span><span class="o">)).</span><span class="na">onFailure</span><span class="o">(</span><span class="nc">SupervisorStrategy</span><span class="o">.</span><span class="na">restart</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="c1">// #top-level</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">counter</span><span class="o">(</span><span class="kt">int</span> <span class="n">currentValue</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="nc">Command</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
          <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Increase</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">o</span> <span class="o">-&gt;</span> <span class="n">onIncrease</span><span class="o">(</span><span class="n">currentValue</span><span class="o">))</span>
          <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Get</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">command</span> <span class="o">-&gt;</span> <span class="n">onGet</span><span class="o">(</span><span class="n">currentValue</span><span class="o">,</span> <span class="n">command</span><span class="o">))</span>
          <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onIncrease</span><span class="o">(</span><span class="kt">int</span> <span class="n">currentValue</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nf">counter</span><span class="o">(</span><span class="n">currentValue</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">onGet</span><span class="o">(</span><span class="kt">int</span> <span class="n">currentValue</span><span class="o">,</span> <span class="nc">Get</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">command</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Got</span><span class="o">(</span><span class="n">currentValue</span><span class="o">));</span>
      <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>


<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åšè¿™ä¸ªç›‘ç£æ—¶åªéœ€è¦æ·»åŠ åˆ°é¡¶å±‚:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">supervise</span><span class="o">(</span><span class="n">counter</span><span class="o">(</span><span class="mi">1</span><span class="o">)).</span><span class="na">onFailure</span><span class="o">(</span><span class="nc">SupervisorStrategy</span><span class="o">.</span><span class="na">restart</span><span class="o">());</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ¯ä¸ªè¿”å›çš„è¡Œä¸ºéƒ½å°†ä¸ç›‘æ§å™¨è‡ªåŠ¨é‡æ–°åŒ…è£…ã€‚</p>

<h3 id="451-å½“çˆ¶actoré‡æ–°å¯åŠ¨æ—¶å­actoråœæ­¢">4.5.1. å½“çˆ¶actoré‡æ–°å¯åŠ¨æ—¶ï¼Œå­actoråœæ­¢</h3>

<p>å­actoré€šå¸¸åœ¨setupå—ä¸­å¯åŠ¨ï¼Œè¯¥è®¾ç½®å—åœ¨çˆ¶actoré‡æ–°å¯åŠ¨æ—¶å†æ¬¡è¿è¡Œã€‚åœæ­¢å­actoræ˜¯ä¸ºäº†é¿å…æ¯æ¬¡é‡æ–°å¯åŠ¨çˆ¶actoræ—¶åˆ›å»ºæ–°çš„å­actoræ—¶çš„èµ„æºæ³„æ¼ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre>  <span class="c1">// #restart-stop-children</span>
  <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">child</span><span class="o">(</span><span class="kt">long</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">(</span><span class="n">msg</span> <span class="o">-&gt;</span> <span class="n">child</span><span class="o">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">length</span><span class="o">()));</span>
  <span class="o">}</span>

  <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">parent</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.&lt;</span><span class="nc">String</span><span class="o">&gt;</span><span class="n">supervise</span><span class="o">(</span>
            <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span>
                <span class="n">ctx</span> <span class="o">-&gt;</span> <span class="o">{</span>
                  <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">child1</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="n">child</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="s">"child1"</span><span class="o">);</span>
                  <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">child2</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="n">child</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="s">"child2"</span><span class="o">);</span>

                  <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">(</span>
                      <span class="n">msg</span> <span class="o">-&gt;</span> <span class="o">{</span>
                        <span class="c1">// message handling that might throw an exception</span>
                        <span class="nc">String</span><span class="o">[]</span> <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">" "</span><span class="o">);</span>
                        <span class="n">child1</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
                        <span class="n">child2</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">parts</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
                        <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
                      <span class="o">});</span>
                <span class="o">}))</span>
        <span class="o">.</span><span class="na">onFailure</span><span class="o">(</span><span class="nc">SupervisorStrategy</span><span class="o">.</span><span class="na">restart</span><span class="o">());</span>
  <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥é‡å†™è¿™ä¸€ç‚¹ï¼Œè¿™æ ·å½“çˆ¶actoré‡æ–°å¯åŠ¨æ—¶ï¼Œå­actorå°±ä¸ä¼šå—åˆ°å½±å“ã€‚ç„¶åï¼Œé‡æ–°å¯åŠ¨çš„çˆ¶å®ä¾‹å°†æ‹¥æœ‰ä¸å¤±è´¥ä¹‹å‰ç›¸åŒçš„å­å®ä¾‹ã€‚</p>

<p>å¦‚æœå­è§’è‰²æ˜¯ä»å‰é¢çš„ä¾‹å­ä¸­åˆ›å»ºçš„ï¼Œå½“çˆ¶è§’è‰²è¢«é‡æ–°å¯åŠ¨æ—¶ï¼Œå®ƒä»¬åº”è¯¥ä¿æŒåŸæ ·(ä¸åœæ­¢)ï¼Œé‚£ä¹ˆç›‘ç£åº”è¯¥æ”¾åœ¨è®¾ç½®ä¸­ï¼Œä½¿ç”¨supervise strategy .restart().withStopChildren(false):</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">parent2</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span>
      <span class="n">ctx</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">child1</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="n">child</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="s">"child1"</span><span class="o">);</span>
        <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">child2</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="n">child</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="s">"child2"</span><span class="o">);</span>

        <span class="c1">// supervision strategy inside the setup to not recreate children on restart</span>
        <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.&lt;</span><span class="nc">String</span><span class="o">&gt;</span><span class="n">supervise</span><span class="o">(</span>
                <span class="nc">Behaviors</span><span class="o">.</span><span class="na">receiveMessage</span><span class="o">(</span>
                    <span class="n">msg</span> <span class="o">-&gt;</span> <span class="o">{</span>
                      <span class="c1">// message handling that might throw an exception</span>
                      <span class="nc">String</span><span class="o">[]</span> <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">" "</span><span class="o">);</span>
                      <span class="n">child1</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
                      <span class="n">child2</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">parts</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
                      <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
                    <span class="o">}))</span>
            <span class="o">.</span><span class="na">onFailure</span><span class="o">(</span><span class="nc">SupervisorStrategy</span><span class="o">.</span><span class="na">restart</span><span class="o">().</span><span class="na">withStopChildren</span><span class="o">(</span><span class="kc">false</span><span class="o">));</span>
      <span class="o">});</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™æ„å‘³ç€setupå—å°†åªåœ¨çˆ¶actorç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶è¿è¡Œï¼Œè€Œä¸æ˜¯åœ¨å®ƒé‡æ–°å¯åŠ¨æ—¶è¿è¡Œã€‚</p>

<h3 id="452-prerestartä¿¡å·">4.5.2. PreRestartä¿¡å·</h3>

<p>ï¼šåœ¨ä¸€ä¸ªå—ç›‘ç£çš„actoré‡æ–°å¯åŠ¨ä¹‹å‰ï¼Œå®ƒä¼šè¢«å‘é€PreRestartä¿¡å·ï¼Œè®©å®ƒæœ‰æœºä¼šæ¸…ç†å®ƒåˆ›å»ºçš„èµ„æºï¼Œè¿™å¾ˆåƒactoråœæ­¢æ—¶çš„PostStopä¿¡å·ã€‚ä»PreRestartä¿¡å·è¿”å›çš„è¡Œä¸ºå°†è¢«å¿½ç•¥ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="nc">Behaviors</span><span class="o">.</span><span class="na">supervise</span><span class="o">(</span>
        <span class="nc">Behaviors</span><span class="o">.&lt;</span><span class="nc">String</span><span class="o">&gt;</span><span class="n">setup</span><span class="o">(</span>
            <span class="n">ctx</span> <span class="o">-&gt;</span> <span class="o">{</span>
              <span class="kd">final</span> <span class="nc">Resource</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">claimResource</span><span class="o">();</span>

              <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span>
                      <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                      <span class="n">msg</span> <span class="o">-&gt;</span> <span class="o">{</span>
                        <span class="c1">// message handling that might throw an exception</span>
                        <span class="nc">String</span><span class="o">[]</span> <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">" "</span><span class="o">);</span>
                        <span class="n">resource</span><span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">parts</span><span class="o">);</span>
                        <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
                      <span class="o">})</span>
                  <span class="o">.</span><span class="na">onSignal</span><span class="o">(</span>
                      <span class="nc">PreRestart</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                      <span class="n">signal</span> <span class="o">-&gt;</span> <span class="o">{</span>
                        <span class="n">resource</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                        <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
                      <span class="o">})</span>
                  <span class="o">.</span><span class="na">onSignal</span><span class="o">(</span>
                      <span class="nc">PostStop</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                      <span class="n">signal</span> <span class="o">-&gt;</span> <span class="o">{</span>
                        <span class="n">resource</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                        <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
                      <span class="o">})</span>
                  <span class="o">.</span><span class="na">build</span><span class="o">();</span>
            <span class="o">}))</span>
    <span class="o">.</span><span class="na">onFailure</span><span class="o">(</span><span class="nc">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">SupervisorStrategy</span><span class="o">.</span><span class="na">restart</span><span class="o">());</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ³¨æ„ï¼ŒPostStopä¸æ˜¯ä¸ºé‡æ–°å¯åŠ¨è€Œå‘å‡ºçš„ï¼Œå› æ­¤é€šå¸¸éœ€è¦åŒæ—¶å¤„ç†PreRestartå’ŒPostStopæ¥æ¸…ç†èµ„æºã€‚</p>

<h3 id="453-bubbleåœ¨å±‚çº§ä¸Šå¤±è´¥äº†">4.5.3. Bubbleåœ¨å±‚çº§ä¸Šå¤±è´¥äº†</h3>

<p>åœ¨æŸäº›åœºæ™¯ä¸­ï¼Œåœ¨Actorå±‚æ¬¡ç»“æ„ä¸­å‘ä¸Šæ¨åŠ¨å…³äºåœ¨å¤±è´¥æ—¶åº”è¯¥åšä»€ä¹ˆçš„å†³ç­–ï¼Œå¹¶è®©çˆ¶Actorå¤„ç†åœ¨å¤±è´¥æ—¶åº”è¯¥å‘ç”Ÿçš„äº‹æƒ…å¯èƒ½ä¼šå¾ˆæœ‰ç”¨(åœ¨ç»å…¸çš„Akka Actorä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹å®ƒå°±æ˜¯è¿™æ ·å·¥ä½œçš„)ã€‚</p>

<p>å¦‚æœçˆ¶èŠ‚ç‚¹åœ¨å­èŠ‚ç‚¹ç»ˆæ­¢æ—¶è¢«é€šçŸ¥ï¼Œçˆ¶èŠ‚ç‚¹å¿…é¡»ç›‘è§†å­èŠ‚ç‚¹ã€‚å¦‚æœchild failedå› ä¸ºå¤±è´¥è€Œåœæ­¢ï¼Œåˆ™ä¼šæ¥æ”¶åˆ°åŒ…å«åŸå› çš„child failedä¿¡å·ã€‚ChildFailedæ‰©å±•Terminatedæ‰€ä»¥ï¼Œå¦‚æœä½ çš„ç”¨ä¾‹ä¸éœ€è¦åŒºåˆ†åœæ­¢å’Œå¤±è´¥ï¼Œä½ å¯ä»¥ç”¨Terminatedä¿¡å·æ¥å¤„ç†è¿™ä¸¤ç§æƒ…å†µ.</p>

<p>å¦‚æœçˆ¶èŠ‚ç‚¹ä¸å¤„ç†ç»ˆæ­¢çš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆå®ƒæœ¬èº«å°†å¤±è´¥ï¼Œå¹¶å‡ºç°akka.actor.type . deathpactexceptionå¼‚å¸¸ã€‚</p>

<p>è¿™æ„å‘³ç€æ¼”å‘˜çš„å±‚æ¬¡ç»“æ„å¯ä»¥æœ‰ä¸€ä¸ªå­©å­å¤±è´¥æ³¡æ²«ä½¿æ¯ä¸ªæ¼”å‘˜åœ¨è·¯ä¸Šåœæ­¢ä½†é€šçŸ¥æœ€é¡¶éƒ¨çš„çˆ¶æ¯æœ‰å¤±è´¥å’Œå¦‚ä½•å¤„ç†å®ƒ,ç„¶è€Œ,åŸå§‹å¼‚å¸¸å¯¼è‡´å¤±è´¥åªä¼šç›´æ¥çˆ¶å¯ç”¨çš„(è¿™é€šå¸¸æ˜¯ä¸€ä»¶å¥½äº‹,è€Œä¸æ˜¯å®ç°ç»†èŠ‚æ³„æ¼)ã€‚</p>

<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½å¸Œæœ›åŸå§‹å¼‚å¸¸åœ¨å±‚æ¬¡ç»“æ„ä¸­å‘ä¸Šå†’æ°”æ³¡ï¼Œè¿™å¯ä»¥é€šè¿‡å¤„ç†ç»ˆæ­¢ä¿¡å·å¹¶åœ¨æ¯ä¸ªactorä¸­é‡æ–°æŠ›å‡ºå¼‚å¸¸æ¥å®ç°ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
</pre></td><td class="rouge-code"><pre><span class="cm">/*
 * Copyright (C) 2018-2020 Lightbend Inc. &lt;https://www.lightbend.com&gt;
 */</span>

<span class="kn">package</span> <span class="nn">jdocs.akka.typed</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorSystem</span><span class="o">;</span>

<span class="c1">// #bubbling-example</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.Behavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.DeathPactException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.SupervisorStrategy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.AbstractBehavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.ActorContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Behaviors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Receive</span><span class="o">;</span>

<span class="c1">// #bubbling-example</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BubblingSample</span> <span class="o">{</span>
  <span class="c1">// #bubbling-example</span>
  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Protocol</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Fail</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">text</span><span class="o">;</span>

      <span class="kd">public</span> <span class="nf">Fail</span><span class="o">(</span><span class="nc">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Hello</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">text</span><span class="o">;</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>

      <span class="kd">public</span> <span class="nf">Hello</span><span class="o">(</span><span class="nc">String</span> <span class="n">text</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">replyTo</span> <span class="o">=</span> <span class="n">replyTo</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Worker</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">Worker:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nf">Worker</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
          <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Fail</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onFail</span><span class="o">)</span>
          <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Hello</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onHello</span><span class="o">)</span>
          <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">onFail</span><span class="o">(</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Fail</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">text</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">onHello</span><span class="o">(</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Hello</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">message</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">text</span><span class="o">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MiddleManagement</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">MiddleManagement:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">child</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">MiddleManagement</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>

      <span class="n">context</span><span class="o">.</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Middle management starting up"</span><span class="o">);</span>
      <span class="c1">// default supervision of child, meaning that it will stop on failure</span>
      <span class="n">child</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">Worker</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"child"</span><span class="o">);</span>

      <span class="c1">// we want to know when the child terminates, but since we do not handle</span>
      <span class="c1">// the Terminated signal, we will in turn fail on child termination</span>
      <span class="n">context</span><span class="o">.</span><span class="na">watch</span><span class="o">(</span><span class="n">child</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
      <span class="c1">// here we don't handle Terminated at all which means that</span>
      <span class="c1">// when the child fails or stops gracefully this actor will</span>
      <span class="c1">// fail with a DeathPactException</span>
      <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onCommand</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">onCommand</span><span class="o">(</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// just pass messages on to the child</span>
      <span class="n">child</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Boss</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">supervise</span><span class="o">(</span><span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">Boss:</span><span class="o">:</span><span class="k">new</span><span class="o">))</span>
          <span class="o">.</span><span class="na">onFailure</span><span class="o">(</span><span class="nc">DeathPactException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">SupervisorStrategy</span><span class="o">.</span><span class="na">restart</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">middleManagement</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">Boss</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
      <span class="n">context</span><span class="o">.</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Boss starting up"</span><span class="o">);</span>
      <span class="c1">// default supervision of child, meaning that it will stop on failure</span>
      <span class="n">middleManagement</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">MiddleManagement</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"middle-management"</span><span class="o">);</span>
      <span class="n">context</span><span class="o">.</span><span class="na">watch</span><span class="o">(</span><span class="n">middleManagement</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
      <span class="c1">// here we don't handle Terminated at all which means that</span>
      <span class="c1">// when middle management fails with a DeathPactException</span>
      <span class="c1">// this actor will also fail</span>
      <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">().</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onCommand</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="nf">onCommand</span><span class="o">(</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// just pass messages on to the child</span>
      <span class="n">middleManagement</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1">// #bubbling-example</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">ActorSystem</span><span class="o">&lt;</span><span class="nc">Protocol</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">system</span> <span class="o">=</span> <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">Boss</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"boss"</span><span class="o">);</span>

    <span class="n">system</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Protocol</span><span class="o">.</span><span class="na">Fail</span><span class="o">(</span><span class="s">"boom"</span><span class="o">));</span>
    <span class="c1">// this will now bubble up all the way to the boss, which will be restarted</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="46-actorå‘ç°">4.6. Actorå‘ç°</h2>

<h3 id="ä¾èµ–å…³ç³»">ä¾èµ–å…³ç³»</h3>

<p>è¦ä½¿ç”¨Akka Actorç±»å‹ï¼Œæ‚¨å¿…é¡»åœ¨é¡¹ç›®ä¸­æ·»åŠ ä»¥ä¸‹ä¾èµ–é¡¹:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;properties&gt;</span>
  <span class="nt">&lt;akka.version&gt;</span>2.6.8<span class="nt">&lt;/akka.version&gt;</span>
  <span class="nt">&lt;scala.binary.version&gt;</span>2.13<span class="nt">&lt;/scala.binary.version&gt;</span>
<span class="nt">&lt;/properties&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.typesafe.akka<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>akka-actor-typed_${scala.binary.version}<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>${akka.version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="è·å–actorçš„å¼•ç”¨">è·å–Actorçš„å¼•ç”¨</h3>

<p>æœ‰ä¸¤ç§è·å–Actorå¼•ç”¨çš„ä¸€èˆ¬æ–¹æ³•:é€šè¿‡åˆ›å»ºActorå’Œä½¿ç”¨å‰å°è¿›è¡Œå‘ç°ã€‚</p>

<p>æ‚¨å¯ä»¥å°†actorå¼•ç”¨ä½œä¸ºæ„é€ å‡½æ•°å‚æ•°æˆ–æ¶ˆæ¯çš„ä¸€éƒ¨åˆ†åœ¨actorä¹‹é—´ä¼ é€’ã€‚</p>

<p>æœ‰æ—¶å€™ï¼Œæ‚¨éœ€è¦ä¸€äº›ä¸œè¥¿æ¥å¼•å¯¼äº¤äº’ï¼Œä¾‹å¦‚å½“actoråœ¨é›†ç¾¤ä¸­çš„ä¸åŒèŠ‚ç‚¹ä¸Šè¿è¡Œæ—¶ï¼Œæˆ–è€…å½“ä¸é€‚ç”¨å¸¦æœ‰æ„é€ å‡½æ•°å‚æ•°çš„â€œä¾èµ–æ³¨å…¥â€æ—¶ã€‚</p>

<h3 id="å‰å°">å‰å°</h3>

<p>å½“éœ€è¦å¦ä¸€ä¸ªactorå‘ç°æŸä¸ªactorï¼Œä½†æ‚¨æ— æ³•åœ¨ä¼ å…¥æ¶ˆæ¯ä¸­å¯¹å…¶è¿›è¡Œå¼•ç”¨æ—¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å‰å°ã€‚å®ƒåŒæ—¶æ”¯æŒæœ¬åœ°å’Œé›†ç¾¤(å‚è§é›†ç¾¤)ã€‚æ‚¨æ³¨å†Œäº†å¯ä»¥ä»æœ¬åœ°å‰å°å®ä¾‹ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ä¸­å‘ç°çš„ç‰¹å®šactorã€‚Akkaçš„APIä¹ŸåŸºäºactoræ¶ˆæ¯ã€‚ç„¶åï¼Œåœ¨é›†ç¾¤ä¸­ï¼Œactorå¼•ç”¨çš„æ³¨å†Œè¡¨è‡ªåŠ¨åˆ†å¸ƒåˆ°æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹ã€‚æ‚¨å¯ä»¥ä½¿ç”¨æ³¨å†Œæ—¶ä½¿ç”¨çš„é”®æŸ¥æ‰¾è¿™æ ·çš„actorã€‚å¯¹è¿™æ ·ä¸€ä¸ªæŸ¥æ‰¾è¯·æ±‚çš„å“åº”æ˜¯ä¸€ä¸ªæ¸…å•ï¼Œå…¶ä¸­åŒ…å«ä¸€ç»„ä¸ºé”®æ³¨å†Œçš„actorå¼•ç”¨ã€‚æ³¨æ„ï¼Œå‡ ä¸ªactorå¯ä»¥æ³¨å†Œåˆ°åŒä¸€ä¸ªé”®ã€‚</p>

<p>æ³¨å†Œè¡¨æ˜¯åŠ¨æ€çš„ã€‚å¯ä»¥åœ¨ç³»ç»Ÿçš„ç”Ÿå‘½å‘¨æœŸä¸­æ³¨å†Œæ–°çš„å‚ä¸è€…ã€‚å½“å·²æ³¨å†Œçš„actorè¢«åœæ­¢ã€æ‰‹åŠ¨å–æ¶ˆæ³¨å†Œæˆ–ä»é›†ç¾¤ä¸­åˆ é™¤å®ƒä»¬æ‰€åœ¨çš„èŠ‚ç‚¹æ—¶ï¼Œæ¡ç›®å°†è¢«åˆ é™¤ã€‚ä¸ºäº†ä¿ƒè¿›è¿™ä¸€åŠ¨æ€æ–¹é¢ï¼Œæ‚¨è¿˜å¯ä»¥è®¢é˜…å‰å°çš„æ›´æ”¹ã€‚è®¢é˜…æ¶ˆæ¯ã€‚å®ƒå°†å‘è®¢é˜…æ–¹å‘é€æ¸…å•æ¶ˆæ¯ï¼Œé¦–å…ˆåœ¨è®¢é˜…æ—¶å‘é€æ¡ç›®é›†ï¼Œç„¶ååœ¨é”®çš„æ¡ç›®å‘ç”Ÿæ›´æ”¹æ—¶å‘é€æ¸…å•æ¶ˆæ¯ã€‚</p>

<p>è¿™äº›å¯¼å…¥åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ä½¿ç”¨:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">akka.actor.typed.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.Behavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.ActorContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Behaviors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.receptionist.Receptionist</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.receptionist.ServiceKey</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªPingService actorï¼Œå¹¶æ ¹æ®ServiceKeyå‘å‰å°æ³¨å†Œå®ƒï¼ŒServiceKeyç¨åå°†ç”¨äºæŸ¥æ‰¾å¼•ç”¨:</p>

<h1 id="5-remoteæ¨¡å—">5. Remoteæ¨¡å—</h1>

<h2 id="51-remoteç®€ä»‹">5.1. Remoteç®€ä»‹</h2>

<p>Remotingä½¿ç”Ÿæ´»åœ¨ä¸åŒè®¡ç®—æœºä¸Šçš„Actorèƒ½å¤Ÿæ— ç¼åœ°äº¤æ¢æ¶ˆæ¯ã€‚å½“ä½œä¸ºJARå·¥ä»¶åˆ†å‘æ—¶ï¼ŒRemotingæ›´åƒæ˜¯ä¸€ä¸ªæ¨¡å—è€Œä¸æ˜¯ä¸€ä¸ªåº“ã€‚æ‚¨ä¸»è¦é€šè¿‡é…ç½®æ¥å¯ç”¨å®ƒï¼Œå®ƒåªæœ‰å‡ ä¸ªapiã€‚ç”±äºæœ‰äº†Actoræ¨¡å‹ï¼Œè¿œç¨‹å’Œæœ¬åœ°æ¶ˆæ¯å‘é€çœ‹èµ·æ¥å®Œå…¨ç›¸åŒã€‚æ‚¨åœ¨æœ¬åœ°ç³»ç»Ÿä¸Šä½¿ç”¨çš„æ¨¡å¼å¯ä»¥ç›´æ¥è½¬æ¢ä¸ºè¿œç¨‹ç³»ç»Ÿã€‚æ‚¨å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨Remotingï¼Œä½†æ˜¯å®ƒæä¾›äº†æ„å»ºé›†ç¾¤å­ç³»ç»Ÿçš„åŸºç¡€ã€‚</p>

<p>Remoting è§£å†³çš„æŒ‘æˆ˜åŒ…æ‹¬:</p>

<ul>
  <li>å¦‚ä½•å¯»å€é©»ç•™åœ¨è¿œç¨‹ä¸»æœºä¸Šçš„actorç³»ç»Ÿã€‚</li>
  <li>å¦‚ä½•åœ¨è¿œç¨‹Actorç³»ç»Ÿä¸Šå¤„ç†å•ä¸ªActorã€‚</li>
  <li>å¦‚ä½•åœ¨ç½‘ç»œä¸Šå°†æ¶ˆæ¯è½¬æ¢æˆå­—èŠ‚ã€‚</li>
  <li>å¦‚ä½•ç®¡ç†ä¸»æœºä¹‹é—´çš„ä½çº§ç½‘ç»œè¿æ¥(å’Œé‡è¿æ¥)ï¼Œæ£€æµ‹å´©æºƒçš„Actorç³»ç»Ÿå’Œä¸»æœºï¼Œæ‰€æœ‰è¿™äº›éƒ½æ˜¯é€æ˜çš„ã€‚</li>
  <li>å¦‚ä½•åœ¨åŒä¸€ç½‘ç»œè¿æ¥ä¸Šé€æ˜åœ°å¤šè·¯ä¼ è¾“æ¥è‡ªä¸€ç»„ä¸ç›¸å…³çš„Actorçš„é€šä¿¡ã€‚</li>
</ul>

<h2 id="52-remote-mavenåº“">5.2. Remote Mavenåº“</h2>

<p>```xml</p>
<properties>
  <akka.version>2.6.8</akka.version>
  <scala.binary.version>2.13</scala.binary.version>
</properties>
<dependency>
  <groupId>com.typesafe.akka</groupId>
  <artifactId>akka-remote_${scala.binary.version}</artifactId>
  <version>${akka.version}</version>
</dependency>

:ET