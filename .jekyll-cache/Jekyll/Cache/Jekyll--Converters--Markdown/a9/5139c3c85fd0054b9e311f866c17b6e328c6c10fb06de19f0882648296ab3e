I"Èb<h1 id="1-mavenä¾èµ–">1. Mavenä¾èµ–</h1>

<p>å½“å‰akkaæœ€æ–°ç‰ˆæœ¬2.6.8ã€akka httpæœ€æ–°ç‰ˆæœ¬ä¸º10.2.0</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre>    <span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;akka.version&gt;</span>2.6.8<span class="nt">&lt;/akka.version&gt;</span>
        <span class="nt">&lt;akka.http.version&gt;</span>10.2.0<span class="nt">&lt;/akka.http.version&gt;</span>
        <span class="nt">&lt;scala.binary.version&gt;</span>2.13<span class="nt">&lt;/scala.binary.version&gt;</span>
        <span class="nt">&lt;lombok.version&gt;</span>1.18.12<span class="nt">&lt;/lombok.version&gt;</span>
        <span class="nt">&lt;logback.version&gt;</span>1.2.3<span class="nt">&lt;/logback.version&gt;</span>
        <span class="nt">&lt;junit.version&gt;</span>4.12<span class="nt">&lt;/junit.version&gt;</span>
    <span class="nt">&lt;/properties&gt;</span>

    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!-- akka stream --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.typesafe.akka<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>akka-stream_${scala.binary.version}<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${akka.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- akka http --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.typesafe.akka<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>akka-http_${scala.binary.version}<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${akka.http.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.typesafe.akka<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>akka-http-core_${scala.binary.version}<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${akka.http.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- akka http jackson--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.typesafe.akka<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>akka-http-jackson_${scala.binary.version}<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${akka.http.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- akka http test--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.typesafe.akka<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>akka-http-testkit_${scala.binary.version}<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${akka.http.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="2-akka-httpç®€ä»‹">2. Akka httpç®€ä»‹</h1>

<p>Akka HTTPçš„é«˜çº§è·¯ç”±APIæä¾›äº†ä¸€ä¸ªDSLï¼Œç”¨äºæè¿°HTTP â€œè·¯ç”±â€ ä»¥åŠå¦‚ä½•å¤„ç†å®ƒä»¬, æ¯ä¸ªè·¯ç”±ç”±ä¸€ä¸ªæˆ–å¤šä¸ªçº§åˆ«ç»„æˆï¼ŒèŒƒå›´ç¼©å°åˆ°å¤„ç†ä¸€ç§ç‰¹å®šç±»å‹çš„è¯·æ±‚ã€‚</p>

<p>ä¾‹å¦‚</p>
<ul>
  <li>ä¸€æ¡è·¯ç”±å¯èƒ½ä»¥åŒ¹é…pathè¯·æ±‚çš„å¼€å¤´ï¼Œåªæœ‰åœ¨è¯·æ±‚åœ°å€åŒ¹é…â€œ/helloâ€æ—¶æ‰åŒ¹é…ï¼Œ</li>
  <li>ç„¶åå°†å…¶èŒƒå›´ç¼©å°ä¸ºä»…å¤„ç†HTTP getè¯·æ±‚</li>
  <li>ç„¶åå°†å…¶å¤„ç†ä¸ºcompleteå¸¦æœ‰å­—ç¬¦ä¸²æ–‡å­—çš„è¯·æ±‚ï¼Œè¿™äº›è¯·æ±‚å°†ä»¥HTTP OKçš„å½¢å¼å‘é€å›å­—ç¬¦ä¸²ä½œä¸ºå“åº”ä¸»ä½“</li>
  <li>ç„¶åï¼Œä½¿ç”¨Routeè·¯ç”±DSLåˆ›å»ºçš„å†…å®¹è¢«â€œç»‘å®šâ€åˆ°ç«¯å£ä»¥å¼€å§‹æœåŠ¡HTTPè¯·æ±‚</li>
</ul>

<blockquote>
  <p><strong>æ³¨æ„</strong>
è‡ªå®šä¹‰HTTPè·¯ç”±ç±»è®°å¾—ç»§æ‰¿AllDirectives</p>
  <blockquote>
    <p>AllDirectives ï¼š å°†æ‰€æœ‰é»˜è®¤æŒ‡ä»¤æ”¶é›†åˆ°ä¸€ä¸ªç±»ä¸­ï¼Œä»¥ä¾¿ç®€å•åœ°å¯¼å…¥é™æ€å‡½æ•°ã€‚
JavaDSL See [[akka.http.javadsl.server.AllDirectives]]
ScalaDSLSee [[akka.http.scaladsl.server.Directives]]</p>
  </blockquote>
</blockquote>

<p>å¦‚ä¸‹ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HttpServerMinimal</span> <span class="kd">extends</span> <span class="nc">AllDirectives</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="3-hello-akka-http">3. Hello Akka HTTP</h1>

<p>ç¬¬ä¸€ä¸ªæœ€å°çº§åˆ«å…¥é—¨ç¤ºä¾‹Hello Akka Http</p>

<h2 id="31-è¯´æ˜">3.1. è¯´æ˜</h2>

<p>ä½¿ç”¨Akka æ„å»ºæœ¬åœ°localhost:8080çš„Httpè·¯ç”±ï¼Œæ·»åŠ è¯·æ±‚åœ°å€/hello, å°†å¤„ç†ä¸ºæ¶ˆæ¯Completeå¸¦æœ‰å­—ç¬¦ä¸²æ–‡å­—çš„è¯·æ±‚,è¯·æ±‚å°†ä»¥HTTP OKçš„å½¢å¼å‘é€å›å­—ç¬¦ä¸²ä½œä¸ºå“åº”ä¸»ä½“ã€‚</p>

<p>å³ä¸ºç»‘å®š<code class="language-plaintext highlighter-rouge">http://localhost:8080</code>çš„getè¯·æ±‚ï¼Œè¯·æ±‚è·¯å¾„æ·»åŠ â€œ/helloâ€å“åº”ä¸»ä½“<code class="language-plaintext highlighter-rouge">complete("&lt;h1&gt;Say hello to akka-http&lt;/h1&gt;"))</code>, æœ€ç»ˆå“åº”ä½“ä¸º<code class="language-plaintext highlighter-rouge">&lt;h1&gt;Say hello to akka-http&lt;/h1&gt;"</code></p>

<h2 id="32-akkaé…ç½®">3.2. akkaé…ç½®</h2>

<p>resourceåˆ›å»ºæ–‡ä»¶http_test.confå¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="n">akka</span> {
  <span class="n">loggers</span> = [<span class="s2">"akka.event.slf4j.Slf4jLogger"</span>]
  <span class="n">loglevel</span> = <span class="n">debug</span>
  <span class="n">actor</span> {
    <span class="n">provider</span> = <span class="n">cluster</span>
    <span class="n">allow</span>-<span class="n">java</span>-<span class="n">serialization</span> = <span class="n">off</span>
  }
  <span class="n">remote</span> {
    <span class="n">artery</span> {
      <span class="c"># transport = tcp
</span>      <span class="n">canonical</span>.<span class="n">hostname</span> = <span class="s2">"127.0.0.1"</span>
      <span class="n">canonical</span>.<span class="n">port</span> = <span class="m">25520</span>
    }
  }
   <span class="n">cluster</span> {
      <span class="c"># seed-nodes = [
</span>       <span class="c"># "akka://ClusterSystem@127.0.0.1:25251",
</span>       <span class="c"># "akka://ClusterSystem@127.0.0.1:25252"]
</span>      <span class="n">downing</span>-<span class="n">provider</span>-<span class="n">class</span> = <span class="s2">"akka.cluster.sbr.SplitBrainResolverProvider"</span>
    }
}
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="33-è·¯ç”±routeä»£ç ">3.3. è·¯ç”±Routeä»£ç </h2>

<p>é€šè¿‡concatæ–¹æ³•pathåˆ›å»º<code class="language-plaintext highlighter-rouge">/hello</code>è·¯ç”±å¹¶ä¸”ç»‘å®šgetè¯·æ±‚ï¼Œå°†å…¶å¤„ç†ä¸ºcompleteå¸¦æœ‰å­—ç¬¦ä¸²æ–‡å­—çš„è¯·æ±‚ï¼Œè¿™äº›è¯·æ±‚å°†ä»¥HTTP OKçš„å½¢å¼å‘é€å›å­—ç¬¦ä¸²ä½œä¸ºå“åº”ä¸»ä½“ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre> <span class="kd">private</span> <span class="nc">Route</span> <span class="nf">createRoute</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">concat</span><span class="o">(</span>
                <span class="n">path</span><span class="o">(</span><span class="s">"hello"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span>
                        <span class="n">get</span><span class="o">(()</span> <span class="o">-&gt;</span>
                                <span class="n">complete</span><span class="o">(</span><span class="s">"&lt;h1&gt;Say hello to akka-http&lt;/h1&gt;"</span><span class="o">))));</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="34-åˆ›å»ºactor-system">3.4. åˆ›å»ºActor System</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c1">//è‡ªå®šä¹‰é…ç½®</span>
<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">overrides</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="c1">//å¯é€‰çš„ï¼Œå¦‚æœä¸é…ç½®åˆ™é»˜è®¤ç«¯å£ä¸º27700</span>
<span class="n">overrides</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"akka.remote.artery.canonical.port"</span><span class="o">,</span> <span class="s">"27702"</span><span class="o">);</span>
<span class="c1">//overrides.put("akka.cluster.roles", Collections.singletonList(role));</span>
    <span class="c1">//ä½¿ç”¨è¦†ç›–çš„é…ç½®åŠ ä¸Šhttp_test.conf</span>
<span class="nc">Config</span> <span class="n">config</span> <span class="o">=</span> <span class="nc">ConfigFactory</span><span class="o">.</span><span class="na">parseMap</span><span class="o">(</span><span class="n">overrides</span><span class="o">).</span><span class="na">withFallback</span><span class="o">(</span><span class="nc">ConfigFactory</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="s">"http_test"</span><span class="o">));</span>
<span class="c1">//åˆ›å»ºç©ºç±»å‹ActorySystem</span>
<span class="nc">ActorSystem</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">system</span> <span class="o">=</span> <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">Behaviors</span><span class="o">.</span><span class="na">empty</span><span class="o">(),</span> <span class="s">"routes"</span><span class="o">,</span> <span class="n">config</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="35-é€šè¿‡actor-systemåˆ›å»ºhttp">3.5. é€šè¿‡Actor Systemåˆ›å»ºHttp</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">final</span> <span class="nc">Http</span> <span class="n">http</span> <span class="o">=</span> <span class="nc">Http</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="36-åˆ›å»ºè·¯ç”±">3.6. åˆ›å»ºè·¯ç”±</h2>

<p>é€šè¿‡åº”ç”¨å®ä¾‹è°ƒç”¨ä¸Šé¢çš„<a href="#åˆ›å»ºè·¯ç”±">createRoute</a>åˆ›å»ºè·¯ç”±æ–¹æ³•åˆ›å»ºè·¯ç”±ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">Route</span> <span class="n">route</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HttpServerMinimal</span><span class="o">().</span><span class="na">createRoute</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="37-httpæ„å»ºserverç»‘å®šipå’Œç«¯å£">3.7. httpæ„å»ºServerç»‘å®šipå’Œç«¯å£</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre> <span class="kd">final</span> <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">ServerBinding</span><span class="o">&gt;</span> <span class="n">binding</span> <span class="o">=</span>
                <span class="n">http</span><span class="o">.</span><span class="na">newServerAt</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">route</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="38-æ ¹æ®å®é™…æƒ…å†µæ¸…é™¤ç»‘å®šå’Œåœæ­¢actor-system">3.8. æ ¹æ®å®é™…æƒ…å†µæ¸…é™¤ç»‘å®šå’Œåœæ­¢Actor System</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c1">//ä»ç«¯å£è§£é™¤ç»‘å®šçš„è§¦å‘å™¨,è§£é™¤ååœæ­¢ActorSystem</span>
<span class="n">binding</span><span class="o">.</span><span class="na">thenCompose</span><span class="o">(</span><span class="nl">ServerBinding:</span><span class="o">:</span><span class="n">unbind</span><span class="o">).</span><span class="na">thenAccept</span><span class="o">(</span><span class="n">unbound</span> <span class="o">-&gt;</span> <span class="n">system</span><span class="o">.</span><span class="na">terminate</span><span class="o">());</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="39-å®Œæ•´ç¤ºä¾‹ä»£ç ">3.9. å®Œæ•´ç¤ºä¾‹ä»£ç </h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.tcfuture.akka.http.minisample</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorSystem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Behaviors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.Http</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.ServerBinding</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.server.AllDirectives</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.server.Route</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.typesafe.config.Config</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.typesafe.config.ConfigFactory</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.CompletionStage</span><span class="o">;</span>

<span class="cm">/**
 * æœ€å°å…¥é—¨ç¤ºä¾‹ Hello Akka Http
 *
 * @author liulv
 * @since 1.0.0
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HttpServerMinimal</span> <span class="kd">extends</span> <span class="nc">AllDirectives</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">//è‡ªå®šä¹‰é…ç½®</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">overrides</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="c1">//å¯é€‰çš„ï¼Œå¦‚æœä¸é…ç½®åˆ™é»˜è®¤ç«¯å£ä¸º27700</span>
        <span class="n">overrides</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"akka.remote.artery.canonical.port"</span><span class="o">,</span> <span class="s">"27702"</span><span class="o">);</span>
        <span class="c1">//overrides.put("akka.cluster.roles", Collections.singletonList(role));</span>
         <span class="c1">//ä½¿ç”¨è¦†ç›–çš„é…ç½®åŠ ä¸Šhttp_test.conf</span>
        <span class="nc">Config</span> <span class="n">config</span> <span class="o">=</span> <span class="nc">ConfigFactory</span><span class="o">.</span><span class="na">parseMap</span><span class="o">(</span><span class="n">overrides</span><span class="o">).</span><span class="na">withFallback</span><span class="o">(</span><span class="nc">ConfigFactory</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="s">"http_test"</span><span class="o">));</span>
        <span class="c1">//åˆ›å»ºç©ºç±»å‹ActorySystem</span>
        <span class="nc">ActorSystem</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">system</span> <span class="o">=</span> <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">Behaviors</span><span class="o">.</span><span class="na">empty</span><span class="o">(),</span> <span class="s">"routes"</span><span class="o">,</span> <span class="n">config</span><span class="o">);</span>

        <span class="kd">final</span> <span class="nc">Http</span> <span class="n">http</span> <span class="o">=</span> <span class="nc">Http</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>

        <span class="c1">//åˆ›å»ºè·¯ç”±</span>
        <span class="nc">Route</span> <span class="n">route</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HttpServerMinimal</span><span class="o">().</span><span class="na">createRoute</span><span class="o">();</span>

        <span class="kd">final</span> <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">ServerBinding</span><span class="o">&gt;</span> <span class="n">binding</span> <span class="o">=</span>
                <span class="n">http</span><span class="o">.</span><span class="na">newServerAt</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">route</span><span class="o">);</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Server online at http://localhost:8080/\nPress RETURN to stop..."</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span> <span class="c1">// let it run until user presses return</span>

        <span class="n">binding</span><span class="o">.</span><span class="na">thenCompose</span><span class="o">(</span><span class="nl">ServerBinding:</span><span class="o">:</span><span class="n">unbind</span><span class="o">)</span> <span class="c1">//ä»ç«¯å£è§£é™¤ç»‘å®šçš„è§¦å‘å™¨</span>
                <span class="o">.</span><span class="na">thenAccept</span><span class="o">(</span><span class="n">unbound</span> <span class="o">-&gt;</span> <span class="n">system</span><span class="o">.</span><span class="na">terminate</span><span class="o">());</span> <span class="c1">// å®Œæˆåå…³é—­</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Route</span> <span class="nf">createRoute</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">concat</span><span class="o">(</span>
                <span class="n">path</span><span class="o">(</span><span class="s">"hello"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span>
                        <span class="n">get</span><span class="o">(()</span> <span class="o">-&gt;</span>
                                <span class="n">complete</span><span class="o">(</span><span class="s">"&lt;h1&gt;Say hello to akka-http&lt;/h1&gt;"</span><span class="o">))));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="310-ç¤ºä¾‹æµ‹è¯•">3.10. ç¤ºä¾‹æµ‹è¯•</h2>

<ol>
  <li>è¿è¡Œmainæ–¹æ³•å³å¯å¯åŠ¨Akka Httpã€‚</li>
</ol>

<p><img src="https://liulv.work/images/img/20200914114137.png" alt="20200914114137" /></p>

<ol>
  <li>é€šè¿‡http getè¯·æ±‚/hello,è¯·æ±‚å“åº”ä¸º<code class="language-plaintext highlighter-rouge">&lt;h1&gt;Say hello to akka-http&lt;/h1&gt;</code></li>
</ol>

<blockquote>
  <ul>
    <li>a. http getè¯·æ±‚å¯é€šè¿‡æµè§ˆå™¨è¯·æ±‚<code class="language-plaintext highlighter-rouge">http://localhost:8080/hello</code>æµ‹è¯•ï¼Œå¦‚ä¸‹</li>
  </ul>
</blockquote>

<p><img src="https://liulv.work/images/img/20200914113900.png" alt="20200914113900" /></p>

<p>è¯·æ±‚å“åº”å¦‚ä¸‹ï¼š</p>

<p><img src="https://liulv.work/images/img/20200914114430.png" alt="20200914114430" /></p>

<blockquote>
  <ul>
    <li>é€šè¿‡curl æµ‹è¯•ï¼Œgit bash æˆ– shellè¾“å…¥<code class="language-plaintext highlighter-rouge">curl http://localhost:8080/hello</code></li>
  </ul>
</blockquote>

<p><img src="https://liulv.work/images/img/20200914114743.png" alt="20200914114743" /></p>

<h1 id="4-jackson-example">4. Jackson Example</h1>

<h2 id="41-ç¤ºä¾‹ç®€ä»‹">4.1. ç¤ºä¾‹ç®€ä»‹</h2>

<p>ä¸€ä¸ªå¸¸è§çš„ç”¨ä¾‹æ˜¯ä½¿ç”¨æ¨¡å‹å¯¹è±¡æ¥ç­”å¤è¯·æ±‚ï¼Œè¯¥æ¨¡å‹å¯¹è±¡å°†ç¼–ç»„å™¨å°†å…¶è½¬æ¢ä¸ºJSONã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ˜¾ç¤ºä¸ºä¸¤æ¡å•ç‹¬çš„è·¯çº¿ã€‚</p>
<ul>
  <li>ç¬¬ä¸€æ¡è·¯ç”±æŸ¥è¯¢å¼‚æ­¥æ•°æ®åº“ï¼Œå¹¶å°†ç»“æœç¼–ç»„ä¸ºJSONå“åº”ã€‚</li>
  <li>ç¬¬äºŒä¸ªä»æ”¶åˆ°çš„è¯·æ±‚ä¸­è§£ç»„ä¸€ä¸ªan ï¼Œå°†å…¶ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œå¹¶åœ¨å®Œæˆåå•å‡»OKè¿›è¡Œå›å¤ã€‚CompletionStage&lt;Optional<Item>&gt;Order</Item></li>
</ul>

<p>è¿è¡Œæ­¤æœåŠ¡å™¨æ—¶ï¼Œå¯ä»¥é€šè¿‡ curl http://localhost:8080/create-order -H â€œContent-Type: application/jsonâ€ -X POST -d â€˜{â€œitemsâ€:[{â€œnameâ€:â€hhgtgâ€,â€idâ€:42}]}â€™
ç»ˆç«¯ä¸Šçš„åº“å­˜æ›´æ–°-æ·»åŠ åä¸ºâ€hhgtgâ€å¹¶å…·æœ‰çš„é¡¹ç›®id=42ã€‚</p>

<p>ç„¶ååœ¨æµè§ˆå™¨ä¸­é€šè¿‡ç±»ä¼¼http://localhost:8080/item/42çš„URL æˆ–åœ¨ç»ˆç«¯ä¸Šé€šè¿‡æ¥æŸ¥çœ‹æ¸…å•curl http://localhost:8080/item/42ã€‚</p>

<p>åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œç”¨äºç¼–ç»„å’Œè§£ç»„JSONçš„é€»è¾‘ç”±â€œJacksonâ€åº“æä¾›ã€‚è§JSONæ”¯æŒï¼‰ï¼Œä»¥è·å–æœ‰å…³è¯¥åº“é›†æˆçš„è¯¦ç»†ä¿¡æ¯, éœ€è¦æ·»åŠ akka-http-jacksonçš„mavenä¾èµ–ã€‚</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre> <span class="c">&lt;!-- akka http jackson--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.typesafe.akka<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>akka-http-jackson_${scala.binary.version}<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>${akka.http.version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>ç‰¹åˆ«è¯´æ˜</strong></p>

<p>onSuccess å‚æ•°ä½¿ç”¨å¼‚æ­¥ç¼–ç¨‹æ–¹å¼CompletionStageï¼Œ f(completionStage.v) =  â€¦ complete(respons_body) )</p>

<p>åˆ›å»ºCompletionStageæ–¹å¼ï¼Œè¿™é‡Œä½¿ç”¨CompletableFuture.completedFuture(â€¦)</p>

<p>å¦‚æœæ²¡æœ‰å®Œæˆå€¼å¯ä½¿ç”¨ä¸‹é¢æ–¹å¼ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">completedFuture</span><span class="o">(</span><span class="nc">Done</span><span class="o">.</span><span class="na">getInstance</span><span class="o">());</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Doneé€šå¸¸ä¸â€œFutureæœªæ¥â€ä¸€èµ·ä½¿ç”¨ä»¥è¡¨ç¤ºå®Œæˆï¼Œä½†æ²¡æœ‰å®Œæˆçš„å®é™…å€¼ã€‚æ›´æ¸…æ¥šåœ°è¡¨æ˜æ„å›¾æ¯”<code class="language-plaintext highlighter-rouge">Unit</code>ï¼Œå¹¶ä¸”åœ¨Scalaå’ŒJavaä¸­éƒ½å¯ç”¨ï¼ˆè€Œ<code class="language-plaintext highlighter-rouge">Unit</code>ä¸æ˜¯ï¼‰ã€‚</p>

<h2 id="42-åˆ›å»ºè·¯ç”±">4.2. åˆ›å»ºè·¯ç”±</h2>

<p>ç¼–ç»„å’Œè§£æjsonä½¿ç”¨å¦‚ä¸‹æ–¹å¼</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>  <span class="n">path</span><span class="o">(</span><span class="s">"..pathName"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">entity</span><span class="o">(</span><span class="nc">Jackson</span><span class="o">.</span><span class="na">unmarshaller</span><span class="o">(</span><span class="nc">Order</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">order</span> <span class="o">-&gt;</span>
<span class="nc">CompletionStage</span> <span class="n">completionStage</span> <span class="o">=</span> <span class="o">..</span>
<span class="n">returu</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="n">completionStage</span><span class="o">,</span> <span class="n">evn</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="o">..</span> <span class="n">complete</span><span class="o">(</span><span class="n">body</span><span class="o">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç¤ºä¾‹åˆ›å»ºè·¯ç”±</p>
<ul>
  <li>postè¯·æ±‚â€create-orderâ€ï¼Œè§£æå®ä½“çš„jsonå­—ç¬¦ä¸²è¯·æ±‚å‚æ•°è½¬æ¢ä¸ºOrder, è°ƒç”¨ä¿å­˜orderçš„é€»è¾‘ï¼Œè¿”å›CompletionStageï¼Œ ä¿å­˜å®ŒæˆåonSuccesså“åº”completeçš„å“åº”ä½“ã€‚</li>
  <li>getè¯·æ±‚ï¼Œè·¯å¾„å‰ç¼€<code class="language-plaintext highlighter-rouge">/item</code>, è·¯å¾„æ·»åŠ <code class="language-plaintext highlighter-rouge">/idå€¼</code>,æŸ¥è¯¢åº“æŸ¥è¯¢åˆ°ç»“æœè¿”å›CompletionStage&lt;Optional<Item>&gt;ï¼ŒonSuccesså“åº”å¦‚æœå­˜åœ¨å€¼å“åº”æ¯ä¸ªitem, å¦åˆ™orElseGetå“åº”StatusCodes.NOT_FOUNDï¼Œå“åº”ä½“"Not Found"å­—ç¬¦</Item></li>
  <li></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">Route</span> <span class="nf">createRoute</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">concat</span><span class="o">(</span>
                <span class="n">get</span><span class="o">(()</span> <span class="o">-&gt;</span>
                        <span class="n">pathPrefix</span><span class="o">(</span><span class="s">"item"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span>
                                <span class="n">path</span><span class="o">(</span><span class="n">longSegment</span><span class="o">(),</span> <span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                                    <span class="kd">final</span> <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Item</span><span class="o">&gt;&gt;</span> <span class="n">futureMaybeItem</span> <span class="o">=</span> <span class="n">fetchItem</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
                                    <span class="k">return</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="n">futureMaybeItem</span><span class="o">,</span> <span class="n">maybeItem</span> <span class="o">-&gt;</span>
                                            <span class="n">maybeItem</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">item</span> <span class="o">-&gt;</span> <span class="n">completeOK</span><span class="o">(</span><span class="n">item</span><span class="o">,</span> <span class="nc">Jackson</span><span class="o">.</span><span class="na">marshaller</span><span class="o">()))</span>
                                                    <span class="o">.</span><span class="na">orElseGet</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">complete</span><span class="o">(</span><span class="nc">StatusCodes</span><span class="o">.</span><span class="na">NOT_FOUND</span><span class="o">,</span> <span class="s">"Not Found"</span><span class="o">))</span>
                                    <span class="o">);</span>
                                <span class="o">}))),</span>
                <span class="n">post</span><span class="o">(()</span> <span class="o">-&gt;</span>
                        <span class="n">path</span><span class="o">(</span><span class="s">"create-order"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span>
                                <span class="n">entity</span><span class="o">(</span><span class="nc">Jackson</span><span class="o">.</span><span class="na">unmarshaller</span><span class="o">(</span><span class="nc">Order</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">order</span> <span class="o">-&gt;</span> <span class="o">{</span>
                                    <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Done</span><span class="o">&gt;</span> <span class="n">futureSaved</span> <span class="o">=</span> <span class="n">saveOrder</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
                                    <span class="k">return</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="n">futureSaved</span><span class="o">,</span> <span class="n">done</span> <span class="o">-&gt;</span>
                                            <span class="n">complete</span><span class="o">(</span><span class="s">"order created"</span><span class="o">)</span>
                                    <span class="o">);</span>
                                <span class="o">})))</span>
        <span class="o">);</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="43-åˆ›å»ºactorsystemhttpå¹¶ç»‘å®šç«¯å£å’Œè·¯ç”±">4.3. åˆ›å»ºActorSystemã€httpå¹¶ç»‘å®šç«¯å£å’Œè·¯ç”±</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">overrides</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">overrides</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"akka.remote.artery.canonical.port"</span><span class="o">,</span> <span class="s">"27701"</span><span class="o">);</span>
        <span class="c1">//overrides.put("akka.cluster.roles", Collections.singletonList(role));</span>
        <span class="nc">Config</span> <span class="n">config</span> <span class="o">=</span> <span class="nc">ConfigFactory</span><span class="o">.</span><span class="na">parseMap</span><span class="o">(</span><span class="n">overrides</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withFallback</span><span class="o">(</span><span class="nc">ConfigFactory</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="s">"http_test"</span><span class="o">));</span>
        <span class="nc">ActorSystem</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">system</span> <span class="o">=</span> <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">Behaviors</span><span class="o">.</span><span class="na">empty</span><span class="o">(),</span> <span class="s">"routes"</span><span class="o">,</span> <span class="n">config</span><span class="o">);</span>

        <span class="kd">final</span> <span class="nc">Http</span> <span class="n">http</span> <span class="o">=</span> <span class="nc">Http</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>

        <span class="c1">//In order to access all directives we need an instance where the routes are define.</span>
        <span class="nc">JacksonExample</span> <span class="n">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JacksonExample</span><span class="o">();</span>

        <span class="kd">final</span> <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">ServerBinding</span><span class="o">&gt;</span> <span class="n">binding</span> <span class="o">=</span>
                <span class="n">http</span><span class="o">.</span><span class="na">newServerAt</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">createRoute</span><span class="o">());</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="44-è·¯ç”±ä½¿ç”¨æŸ¥è¯¢æ•°æ®å’Œä¿å­˜æ•°æ®">4.4. è·¯ç”±ä½¿ç”¨æŸ¥è¯¢æ•°æ®å’Œä¿å­˜æ•°æ®</h2>

<p>åˆ›å»ºPOJ, æ³¨æ„è¿™é‡Œéœ€è¦è§£æjsonå­—ç¬¦ï¼Œæ„é€ æ–¹æ³•éœ€è¦ä½¿ç”¨@JsonCreator</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre>    <span class="nd">@Getter</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>

        <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Item</span><span class="o">&gt;</span> <span class="n">items</span><span class="o">;</span>

        <span class="nd">@JsonCreator</span>
        <span class="nc">Order</span><span class="o">(</span><span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"items"</span><span class="o">)</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Item</span><span class="o">&gt;</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">items</span> <span class="o">=</span> <span class="n">items</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>


    <span class="nd">@Getter</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Item</span> <span class="o">{</span>

        <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>

        <span class="nd">@JsonCreator</span>
        <span class="nc">Item</span><span class="o">(</span><span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span>
             <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™é‡Œæ¨¡æ‹ŸæŸ¥è¯¢æ•°æ®å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Item</span><span class="o">&gt;&gt;</span> <span class="nf">fetchItem</span><span class="o">(</span><span class="kt">long</span> <span class="n">itemId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">completedFuture</span><span class="o">(</span><span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="k">new</span> <span class="nc">Item</span><span class="o">(</span><span class="s">"foo"</span><span class="o">,</span> <span class="n">itemId</span><span class="o">)));</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ¨¡æ‹Ÿä¿å­˜æ•°æ®</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="c1">// (fake) async database query api</span>
    <span class="kd">private</span> <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Done</span><span class="o">&gt;</span> <span class="nf">saveOrder</span><span class="o">(</span><span class="kd">final</span> <span class="nc">Order</span> <span class="n">order</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">completedFuture</span><span class="o">(</span><span class="nc">Done</span><span class="o">.</span><span class="na">getInstance</span><span class="o">());</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="45-å®Œæˆä»£ç ">4.5. å®Œæˆä»£ç </h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.tcfuture.akka.http.jsonsample</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">akka.Done</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorSystem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Behaviors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.Http</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.ServerBinding</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.marshallers.jackson.Jackson</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.model.StatusCodes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.server.AllDirectives</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.server.Route</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonCreator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonProperty</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.typesafe.config.Config</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.typesafe.config.ConfigFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Getter</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.CompletableFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.CompletionStage</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">akka</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">javadsl</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">PathMatchers</span><span class="o">.</span><span class="na">longSegment</span><span class="o">;</span>

<span class="cm">/**
 * @author liulv
 *
 * ä¸€ä¸ªå¸¸è§çš„ç”¨ä¾‹æ˜¯ä½¿ç”¨æ¨¡å‹å¯¹è±¡æ¥ç­”å¤è¯·æ±‚ï¼Œè¯¥æ¨¡å‹å¯¹è±¡å°†ç¼–ç»„å™¨å°†å…¶è½¬æ¢ä¸ºJSONã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ˜¾ç¤ºä¸ºä¸¤æ¡å•ç‹¬çš„è·¯çº¿ã€‚
 * ç¬¬ä¸€æ¡è·¯ç”±æŸ¥è¯¢å¼‚æ­¥æ•°æ®åº“ï¼Œå¹¶å°†ç»“æœç¼–ç»„ä¸ºJSONå“åº”ã€‚ç¬¬äºŒä¸ªä»æ”¶åˆ°çš„è¯·æ±‚ä¸­è§£ç»„ä¸€ä¸ªan ï¼Œå°†å…¶ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œå¹¶åœ¨
 * å®Œæˆåå•å‡»OKè¿›è¡Œå›å¤ã€‚CompletionStage&lt;Optional&lt;Item&gt;&gt;Order
 *
 * è¿è¡Œæ­¤æœåŠ¡å™¨æ—¶ï¼Œå¯ä»¥é€šè¿‡ curl http://localhost:8080/create-order -H "Content-Type: application/json" -X POST -d '{"items":[{"name":"hhgtg","id":42}]}'
 * ç»ˆç«¯ä¸Šçš„åº“å­˜æ›´æ–°-æ·»åŠ åä¸º"hhgtg"å¹¶å…·æœ‰çš„é¡¹ç›®id=42ã€‚ç„¶ååœ¨æµè§ˆå™¨ä¸­é€šè¿‡ç±»ä¼¼http://localhost:8080/item/42
 * çš„URL æˆ–åœ¨ç»ˆç«¯ä¸Šé€šè¿‡æ¥æŸ¥çœ‹æ¸…å•curl http://localhost:8080/item/42ã€‚
 *
 * åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œç”¨äºç¼–ç»„å’Œè§£ç»„JSONçš„é€»è¾‘ç”±â€œ Jacksonâ€åº“æä¾›ã€‚è§JSONæ”¯æŒï¼‰ï¼Œä»¥è·å–æœ‰å…³è¯¥åº“é›†æˆçš„è¯¦ç»†ä¿¡æ¯
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JacksonExample</span> <span class="kd">extends</span> <span class="nc">AllDirectives</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// boot up server using the route as defined below</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">overrides</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">overrides</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"akka.remote.artery.canonical.port"</span><span class="o">,</span> <span class="s">"27701"</span><span class="o">);</span>
        <span class="c1">//overrides.put("akka.cluster.roles", Collections.singletonList(role));</span>
        <span class="nc">Config</span> <span class="n">config</span> <span class="o">=</span> <span class="nc">ConfigFactory</span><span class="o">.</span><span class="na">parseMap</span><span class="o">(</span><span class="n">overrides</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withFallback</span><span class="o">(</span><span class="nc">ConfigFactory</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="s">"http_test"</span><span class="o">));</span>
        <span class="nc">ActorSystem</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">system</span> <span class="o">=</span> <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">Behaviors</span><span class="o">.</span><span class="na">empty</span><span class="o">(),</span> <span class="s">"routes"</span><span class="o">,</span> <span class="n">config</span><span class="o">);</span>

        <span class="kd">final</span> <span class="nc">Http</span> <span class="n">http</span> <span class="o">=</span> <span class="nc">Http</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>

        <span class="c1">//In order to access all directives we need an instance where the routes are define.</span>
        <span class="nc">JacksonExample</span> <span class="n">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JacksonExample</span><span class="o">();</span>

        <span class="kd">final</span> <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">ServerBinding</span><span class="o">&gt;</span> <span class="n">binding</span> <span class="o">=</span>
                <span class="n">http</span><span class="o">.</span><span class="na">newServerAt</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">createRoute</span><span class="o">());</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Server online at http://localhost:8080/\nPress RETURN to stop..."</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span> <span class="c1">// let it run until user presses return</span>

        <span class="n">binding</span>
                <span class="o">.</span><span class="na">thenCompose</span><span class="o">(</span><span class="nl">ServerBinding:</span><span class="o">:</span><span class="n">unbind</span><span class="o">)</span> <span class="c1">// trigger unbinding from the port</span>
                <span class="o">.</span><span class="na">thenAccept</span><span class="o">(</span><span class="n">unbound</span> <span class="o">-&gt;</span> <span class="n">system</span><span class="o">.</span><span class="na">terminate</span><span class="o">());</span> <span class="c1">// and shutdown when done</span>
    <span class="o">}</span>

    <span class="c1">// (fake) async database query api</span>
    <span class="kd">private</span> <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Item</span><span class="o">&gt;&gt;</span> <span class="nf">fetchItem</span><span class="o">(</span><span class="kt">long</span> <span class="n">itemId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">completedFuture</span><span class="o">(</span><span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="k">new</span> <span class="nc">Item</span><span class="o">(</span><span class="s">"foo"</span><span class="o">,</span> <span class="n">itemId</span><span class="o">)));</span>
    <span class="o">}</span>

    <span class="c1">// (fake) async database query api</span>
    <span class="kd">private</span> <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Done</span><span class="o">&gt;</span> <span class="nf">saveOrder</span><span class="o">(</span><span class="kd">final</span> <span class="nc">Order</span> <span class="n">order</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">completedFuture</span><span class="o">(</span><span class="nc">Done</span><span class="o">.</span><span class="na">getInstance</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Route</span> <span class="nf">createRoute</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">concat</span><span class="o">(</span>
                <span class="n">get</span><span class="o">(()</span> <span class="o">-&gt;</span>
                        <span class="n">pathPrefix</span><span class="o">(</span><span class="s">"item"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span>
                                <span class="n">path</span><span class="o">(</span><span class="n">longSegment</span><span class="o">(),</span> <span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                                    <span class="kd">final</span> <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Item</span><span class="o">&gt;&gt;</span> <span class="n">futureMaybeItem</span> <span class="o">=</span> <span class="n">fetchItem</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
                                    <span class="k">return</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="n">futureMaybeItem</span><span class="o">,</span> <span class="n">maybeItem</span> <span class="o">-&gt;</span>
                                            <span class="n">maybeItem</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">item</span> <span class="o">-&gt;</span> <span class="n">completeOK</span><span class="o">(</span><span class="n">item</span><span class="o">,</span> <span class="nc">Jackson</span><span class="o">.</span><span class="na">marshaller</span><span class="o">()))</span>
                                                    <span class="o">.</span><span class="na">orElseGet</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">complete</span><span class="o">(</span><span class="nc">StatusCodes</span><span class="o">.</span><span class="na">NOT_FOUND</span><span class="o">,</span> <span class="s">"Not Found"</span><span class="o">))</span>
                                    <span class="o">);</span>
                                <span class="o">}))),</span>
                <span class="n">post</span><span class="o">(()</span> <span class="o">-&gt;</span>
                        <span class="n">path</span><span class="o">(</span><span class="s">"create-order"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span>
                                <span class="n">entity</span><span class="o">(</span><span class="nc">Jackson</span><span class="o">.</span><span class="na">unmarshaller</span><span class="o">(</span><span class="nc">Order</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">order</span> <span class="o">-&gt;</span> <span class="o">{</span>
                                    <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Done</span><span class="o">&gt;</span> <span class="n">futureSaved</span> <span class="o">=</span> <span class="n">saveOrder</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
                                    <span class="k">return</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="n">futureSaved</span><span class="o">,</span> <span class="n">done</span> <span class="o">-&gt;</span>
                                            <span class="n">complete</span><span class="o">(</span><span class="s">"order created"</span><span class="o">)</span>
                                    <span class="o">);</span>
                                <span class="o">})))</span>
        <span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Getter</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Item</span> <span class="o">{</span>

        <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>

        <span class="nd">@JsonCreator</span>
        <span class="nc">Item</span><span class="o">(</span><span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span>
             <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Getter</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>

        <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Item</span><span class="o">&gt;</span> <span class="n">items</span><span class="o">;</span>

        <span class="nd">@JsonCreator</span>
        <span class="nc">Order</span><span class="o">(</span><span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"items"</span><span class="o">)</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Item</span><span class="o">&gt;</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">items</span> <span class="o">=</span> <span class="n">items</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="46-æµ‹è¯•">4.6. æµ‹è¯•</h2>

<p>è¿è¡Œ</p>

<p><img src="https://liulv.work/images/img/20200914140822.png" alt="20200914140822" /></p>

<p>è¿è¡Œæ­¤æœåŠ¡å™¨åï¼Œå¯ä»¥é€šè¿‡ curl http://localhost:8080/create-order -H â€œContent-Type: application/jsonâ€ -X POST -d â€˜{â€œitemsâ€:[{â€œnameâ€:â€hhgtgâ€,â€idâ€:42}]}â€™
ç»ˆç«¯ä¸Šçš„åº“å­˜æ›´æ–°-æ·»åŠ åä¸ºâ€hhgtgâ€å¹¶å…·æœ‰çš„é¡¹ç›®id=42, å¦‚ä¸‹å›¾</p>

<p><img src="https://liulv.work/images/img/20200914141043.png" alt="20200914141043" /></p>

<p>ç„¶ååœ¨æµè§ˆå™¨ä¸­é€šè¿‡ç±»ä¼¼http://localhost:8080/item/42çš„URL æˆ–åœ¨ç»ˆç«¯ä¸Šé€šè¿‡æ¥æŸ¥çœ‹æ¸…å•curl http://localhost:8080/item/42ã€‚</p>

<p>curlæµ‹è¯•å¦‚ä¸‹ï¼š</p>

<p><img src="https://liulv.work/images/img/20200914141238.png" alt="20200914141238" /></p>

<p>æµè§ˆå™¨è¯·æ±‚ï¼š</p>

<p><img src="https://liulv.work/images/img/20200914141431.png" alt="20200914141431" /></p>

<h1 id="5-streaming">5. Streaming</h1>

<p>Akka HTTPçš„ä¼˜åŠ¿ä¹‹ä¸€æ˜¯æµæ•°æ®æ˜¯å…¶æ ¸å¿ƒï¼Œè¿™æ„å‘³ç€è¯·æ±‚å’Œå“åº”ä¸»ä½“éƒ½å¯ä»¥é€šè¿‡æœåŠ¡å™¨è¿›è¡Œæµä¼ è¾“ï¼Œå³ä½¿å¯¹äºéå¸¸å¤§çš„è¯·æ±‚æˆ–å“åº”ï¼Œä¹Ÿå¯ä»¥å®ç°æ’å®šçš„å†…å­˜ä½¿ç”¨ç‡ã€‚æµå“åº”å°†ç”±è¿œç¨‹å®¢æˆ·ç«¯æ–½åŠ å‹åŠ›ï¼Œå› æ­¤æœåŠ¡å™¨å°†ä¸ä¼šä»¥æ¯”å®¢æˆ·ç«¯å¯ä»¥å¤„ç†çš„é€Ÿåº¦æ›´å¿«åœ°æ¨é€æ•°æ®ï¼Œæµè¯·æ±‚æ„å‘³ç€æœåŠ¡å™¨å†³å®šè¿œç¨‹å®¢æˆ·ç«¯å¯ä»¥ä»¥å¤šå¿«çš„é€Ÿåº¦æ¨é€è¯·æ±‚ä¸»ä½“çš„æ•°æ®ã€‚</p>

<p>åªè¦å®¢æˆ·ç«¯æ¥å—éšæœºæµçš„ç¤ºä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">Route</span> <span class="nf">createRoute</span><span class="o">(){</span>
        <span class="c1">//éšæœºæ•°</span>
        <span class="kd">final</span> <span class="nc">Random</span> <span class="n">rnd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">();</span>
        <span class="c1">// æµæ˜¯å¯é‡ç”¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œå®šä¹‰å®ƒ</span>
        <span class="c1">// å¹¶å¯¹æ¯ä¸ªè¯·æ±‚ä½¿ç”¨å®ƒ</span>
        <span class="nc">Source</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">NotUsed</span><span class="o">&gt;</span> <span class="n">numbers</span> <span class="o">=</span> <span class="nc">Source</span><span class="o">.</span><span class="na">fromIterator</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">Stream</span><span class="o">.</span><span class="na">generate</span><span class="o">(</span><span class="nl">rnd:</span><span class="o">:</span><span class="n">nextInt</span><span class="o">).</span><span class="na">iterator</span><span class="o">());</span>

        <span class="k">return</span> <span class="nf">concat</span><span class="o">(</span><span class="n">path</span><span class="o">(</span><span class="s">"random"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span>
                <span class="n">get</span><span class="o">(()</span> <span class="o">-&gt;</span>
                        <span class="n">complete</span><span class="o">(</span><span class="nc">HttpEntities</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">ContentTypes</span><span class="o">.</span><span class="na">TEXT_PLAIN_UTF8</span><span class="o">,</span>
                                <span class="c1">//å°†æ¯ä¸ªæ•°å­—è½¬æ¢ä¸ºå­—èŠ‚å—</span>
                                <span class="n">numbers</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="nc">ByteString</span><span class="o">.</span><span class="na">fromString</span><span class="o">(</span><span class="n">x</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">))</span>
                                <span class="o">))</span>
                        <span class="o">)</span>
        <span class="o">));</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä½¿ç”¨æ…¢é€Ÿçš„HTTPå®¢æˆ·ç«¯è¿æ¥åˆ°è¯¥æœåŠ¡å°†äº§ç”Ÿåå‹åŠ›ï¼Œä»¥ä¾¿æ ¹æ®éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šä¿æŒä¸å˜çš„å†…å­˜ä½¿ç”¨æƒ…å†µä¸‹ç”Ÿæˆä¸‹ä¸€ä¸ªéšæœºæ•°ã€‚ä½¿ç”¨å·æ›²å’Œé™åˆ¶é€Ÿç‡å¯ä»¥çœ‹å‡ºè¿™ä¸€ç‚¹curl â€“limit-rate 50b 127.0.0.1:8080/random</p>

<h1 id="6-httpä¸actoräº¤äº’">6. Httpä¸Actoräº¤äº’</h1>

<p>è¿™ä¸ªæ˜¯æˆ‘ä»¬çš„æ ¸å¿ƒå†…å®¹ï¼Œæˆ‘ä»¬é€šè¿‡å‘å¸ƒhttpï¼Œæœ€ç»ˆé€šè¿‡askè¯·æ±‚actè·å–responseï¼Œè¿”å›HTTP OK æˆ– KOçš„å“åº”ä½“ï¼Œæ¥è¾¾åˆ°ä¸åŒAkka é›†ç¾¤ä¹‹é—´actoræ¶ˆæ¯äº¤äº’æ•ˆæœã€‚</p>

<h2 id="61-ç¤ºä¾‹1-auction">6.1. ç¤ºä¾‹1-Auction</h2>

<h3 id="611-ç¤ºä¾‹è¯´æ˜">6.1.1. ç¤ºä¾‹è¯´æ˜</h3>

<p>Akka HTTPè·¯ç”±å¯ä»¥è½»æ¾åœ°ä¸å‚ä¸è€…è¿›è¡Œäº¤äº’ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œä¸€æ¡è·¯çº¿å…è®¸ä»¥å³å‘å³å¼ƒ(actor.tell)çš„æ–¹å¼å‘é€å‡ºä»·ç«æ ‡ï¼Œè€Œç¬¬äºŒæ¡è·¯çº¿åŒ…å«ä¸æ¼”å‘˜çš„è¯·æ±‚-å“åº”äº¤äº’ï¼Œç»“æœå“åº”å°†å‘ˆç°ä¸ºjsonï¼Œå¹¶åœ¨å“åº”ä»actoråˆ°è¾¾æ—¶è¿”å›ã€‚</p>

<p>æ­¤ç¤ºä¾‹æ˜¯æ¨¡æ‹Ÿä¸€ä¸ªæ‹å–ç«æ ‡ä¿¡æ¯ï¼Œéœ€è¦æ„å»ºä¸€ä¸ªå†…éƒ¨ç±»æ‹å–ç±»Auctionç”¨äºæ„å»ºActor, Actorä¹‹é—´äº¤äº’çš„ä¿¡æ¯POJOåŒ…å«: ç«æ ‡è€…ä¿¡æ¯Bidï¼ˆç”¨æˆ·IDå’Œä¸­æ ‡æ•°offerï¼‰ã€è·å–ç«æ ‡ä¿¡æ¯GetBidsï¼ˆActorRef<Bids>ï¼‰ã€å­˜å‚¨æ‹å–ä¿¡æ¯Bidsï¼ˆlist<Bid>ï¼‰ã€‚
è¿˜éœ€è¦æ·»åŠ Actorå®ä¾‹å­˜å‚¨æ‹å–ä¿¡æ¯çš„å‚æ•°List<Bid> bids;</Bid></Bid></Bids></p>

<h3 id="612-actorå¤„ç†">6.1.2. Actorå¤„ç†</h3>

<p><strong>ä¸ºæ­¤ç»™å‡ºå†…éƒ¨æ‹å–ä¿¡æ¯Actorå¯¹è±¡å¦‚ä¸‹, ä¸ä½¿ç”¨å†…éƒ¨ç±»ä¹Ÿå¯ä»¥</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</pre></td><td class="rouge-code"><pre><span class="kd">static</span> <span class="kd">class</span> <span class="nc">Auction</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Auction</span><span class="o">.</span><span class="na">Message</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">//ç«æ ‡åˆ—è¡¨</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Bid</span><span class="o">&gt;</span> <span class="n">bids</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="kd">interface</span> <span class="nc">Message</span> <span class="o">{}</span>

    <span class="c1">//ç«æ ‡è€…ä¿¡æ¯</span>
    <span class="nd">@AllArgsConstructor</span>
    <span class="nd">@Getting</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Bid</span> <span class="kd">implements</span> <span class="nc">Message</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">userId</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">offer</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//è·å–ç«æ ‡ä¿¡æ¯</span>
    <span class="nd">@AllArgsConstructor</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">GetBids</span> <span class="kd">implements</span> <span class="nc">Message</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Bids</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//å…¨éƒ¨ç«æ ‡ä¿¡æ¯</span>
    <span class="nd">@AllArgsConstructor</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Bids</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Bid</span><span class="o">&gt;</span> <span class="n">bids</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">Auction</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">Auction:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Bid</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onBid</span><span class="o">)</span>
                <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">GetBids</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onGetBids</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
        * å¼€å§‹ç«æ ‡æ¶ˆæ¯å›å¤ï¼Œå°†ç«æ ‡ä¿¡æ¯æ·»åŠ åˆ°ç«æ ‡é›†åˆä¸­
        *
        * @param bid Bid
        * @return
        */</span>
    <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="nf">onBid</span><span class="o">(</span><span class="nc">Bid</span> <span class="n">bid</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">bids</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">bid</span><span class="o">);</span>
        <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Bid complete: {}, {}"</span><span class="o">,</span> <span class="n">bid</span><span class="o">.</span><span class="na">userId</span><span class="o">,</span> <span class="n">bid</span><span class="o">.</span><span class="na">offer</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
        * è·å–å½“å‰å…¨éƒ¨çš„ç«æ ‡ä¿¡æ¯
        *
        * @param getBids GetBids
        * @return Bids-ç¤ºä¾‹ä¸­å­˜å‚¨çš„ç«æ ‡é›†åˆæ„å»ºBidså®ä¾‹è¿”å›
        */</span>
    <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="nf">onGetBids</span><span class="o">(</span><span class="nc">GetBids</span> <span class="n">getBids</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">getBids</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Bids</span><span class="o">(</span><span class="n">bids</span><span class="o">));</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="613-åˆ›å»ºroute">6.1.3. åˆ›å»ºRoute</h3>

<p>Routeä¸»è¦æœ‰ä¸¤ç§æƒ…å†µå¤„ç†ï¼šæ·»åŠ ç«æ ‡ä¿¡æ¯ã€è·å–å½“å‰æ‹å–ä¿¡æ¯ï¼Œåˆ†åˆ«å¯¹åº”Actoræ¶ˆæ¯å¤„ç†Auction.Bidã€Auction.GetBidsã€‚</p>
<ul>
  <li>æ·»åŠ ç«æ ‡ä¿¡æ¯åªæ˜¯å³å‘å³å¼ƒtellæ–¹å¼ï¼Œä¸éœ€è¦è¿”å›å€¼</li>
  <li>è€Œè·å–å½“å‰æ‹å–ä¿¡æ¯éœ€è¦è·å–actorå“åº”ï¼Œä½¿ç”¨askæ–¹æ³•ï¼Œä½¿ç”¨å¼‚æ­¥å¤„ç†CompletionStage<Auction.Bids>ï¼Œ ä½¿ç”¨completeOKWithFuture(bids, Jackson.marshaller())è¿”å›POJOè½¬æ¢ä¸ºJSONæ•°æ®å“åº”ã€‚</Auction.Bids></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre> <span class="kd">private</span> <span class="nc">Route</span> <span class="nf">createRoute</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">concat</span><span class="o">(</span>
            <span class="n">path</span><span class="o">(</span><span class="s">"auction"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">concat</span><span class="o">(</span>
                    <span class="n">put</span><span class="o">(()</span> <span class="o">-&gt;</span>
                            <span class="n">parameter</span><span class="o">(</span><span class="nc">StringUnmarshallers</span><span class="o">.</span><span class="na">INTEGER</span><span class="o">,</span> <span class="s">"bid"</span><span class="o">,</span> <span class="n">bid</span> <span class="o">-&gt;</span>
                                    <span class="n">parameter</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="n">user</span> <span class="o">-&gt;</span> <span class="o">{</span>
                                        <span class="c1">//ç«æ ‡ï¼Œå‘å®Œå³ä¸¢å¼ƒï¼Œä¸ç”¨ç­‰å¾…å“åº”</span>
                                        <span class="n">auction</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Auction</span><span class="o">.</span><span class="na">Bid</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">bid</span><span class="o">));</span>
                                        <span class="k">return</span> <span class="nf">complete</span><span class="o">(</span><span class="nc">StatusCodes</span><span class="o">.</span><span class="na">ACCEPTED</span><span class="o">,</span> <span class="s">"bid placed"</span><span class="o">);</span>
                                    <span class="o">})</span>
                            <span class="o">)),</span>
                    <span class="n">get</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                        <span class="c1">//å‘actoræŸ¥è¯¢å½“å‰æ‹å–çŠ¶æ€</span>
                        <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Auction</span><span class="o">.</span><span class="na">Bids</span><span class="o">&gt;</span> <span class="n">bids</span> <span class="o">=</span> <span class="n">ask</span><span class="o">(</span><span class="n">auction</span><span class="o">,</span> <span class="nc">Auction</span><span class="o">.</span><span class="na">GetBids</span><span class="o">::</span><span class="k">new</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">5</span><span class="o">),</span> <span class="n">system</span><span class="o">.</span><span class="na">scheduler</span><span class="o">());</span>
                        <span class="k">return</span> <span class="nf">completeOKWithFuture</span><span class="o">(</span><span class="n">bids</span><span class="o">,</span> <span class="nc">Jackson</span><span class="o">.</span><span class="na">marshaller</span><span class="o">());</span>
                    <span class="o">}))));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="614-å®Œæ•´ç¤ºä¾‹ä»£ç ">6.1.4. å®Œæ•´ç¤ºä¾‹ä»£ç </h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.tcfuture.akka.http.interaction</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorSystem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.Behavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.AbstractBehavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.ActorContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Behaviors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Receive</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.Http</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.ServerBinding</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.marshallers.jackson.Jackson</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.model.StatusCodes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.server.AllDirectives</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.server.Route</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.unmarshalling.StringUnmarshallers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.typesafe.config.Config</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.typesafe.config.ConfigFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.Duration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.CompletionStage</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">akka</span><span class="o">.</span><span class="na">actor</span><span class="o">.</span><span class="na">typed</span><span class="o">.</span><span class="na">javadsl</span><span class="o">.</span><span class="na">AskPattern</span><span class="o">.</span><span class="na">ask</span><span class="o">;</span>

<span class="cm">/**
 * Akka HTTPè·¯ç”±å¯ä»¥è½»æ¾åœ°ä¸Actorè¿›è¡Œäº¤äº’ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œä¸€æ¡è·¯çº¿å…è®¸ä»¥å³å‘å³å¼ƒçš„æ–¹å¼æ”¾ç½®å‡ºä»·ï¼Œè€Œç¬¬äºŒæ¡è·¯çº¿åŒ…å«
 * ä¸actorçš„è¯·æ±‚-å“åº”äº¤äº’ã€‚ç»“æœå“åº”å°†å‘ˆç°ä¸ºjsonï¼Œå¹¶åœ¨å“åº”ä»actoråˆ°è¾¾æ—¶è¿”å›ã€‚
 *
 * @author liulv
 * @since 1.0.0
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HttpServerActorInteractionExample</span> <span class="kd">extends</span> <span class="nc">AllDirectives</span> <span class="o">{</span>

    <span class="c1">//ActorSystemå±æ€§</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorSystem</span><span class="o">&lt;</span><span class="nc">Auction</span><span class="o">.</span><span class="na">Message</span><span class="o">&gt;</span> <span class="n">system</span><span class="o">;</span>
    <span class="c1">//ActorRef æ‹å–</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Auction</span><span class="o">.</span><span class="na">Message</span><span class="o">&gt;</span> <span class="n">auction</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">Config</span> <span class="n">config</span> <span class="o">=</span> <span class="nc">ConfigFactory</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="s">"http_test"</span><span class="o">);</span>
        <span class="c1">// boot up server using the route as defined below</span>
        <span class="nc">ActorSystem</span><span class="o">&lt;</span><span class="nc">Auction</span><span class="o">.</span><span class="na">Message</span><span class="o">&gt;</span> <span class="n">system</span> <span class="o">=</span> <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">Auction</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"routes"</span><span class="o">,</span> <span class="n">config</span><span class="o">);</span>

        <span class="kd">final</span> <span class="nc">Http</span> <span class="n">http</span> <span class="o">=</span> <span class="nc">Http</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>

        <span class="c1">//In order to access all directives we need an instance where the routes are define.</span>
        <span class="nc">HttpServerActorInteractionExample</span> <span class="n">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HttpServerActorInteractionExample</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>

        <span class="kd">final</span> <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">ServerBinding</span><span class="o">&gt;</span> <span class="n">binding</span> <span class="o">=</span>
                <span class="n">http</span><span class="o">.</span><span class="na">newServerAt</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">createRoute</span><span class="o">());</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Server online at http://localhost:8080/\nPress RETURN to stop..."</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span> <span class="c1">// let it run until user presses return</span>

        <span class="n">binding</span>
                <span class="o">.</span><span class="na">thenCompose</span><span class="o">(</span><span class="nl">ServerBinding:</span><span class="o">:</span><span class="n">unbind</span><span class="o">)</span> <span class="c1">// trigger unbinding from the port</span>
                <span class="o">.</span><span class="na">thenAccept</span><span class="o">(</span><span class="n">unbound</span> <span class="o">-&gt;</span> <span class="n">system</span><span class="o">.</span><span class="na">terminate</span><span class="o">());</span> <span class="c1">// and shutdown when done</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nf">HttpServerActorInteractionExample</span><span class="o">(</span><span class="kd">final</span> <span class="nc">ActorSystem</span><span class="o">&lt;</span><span class="nc">Auction</span><span class="o">.</span><span class="na">Message</span><span class="o">&gt;</span> <span class="n">system</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">system</span> <span class="o">=</span> <span class="n">system</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">auction</span> <span class="o">=</span> <span class="n">system</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Route</span> <span class="nf">createRoute</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">concat</span><span class="o">(</span>
                <span class="n">path</span><span class="o">(</span><span class="s">"auction"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">concat</span><span class="o">(</span>
                        <span class="n">put</span><span class="o">(()</span> <span class="o">-&gt;</span>
                                <span class="n">parameter</span><span class="o">(</span><span class="nc">StringUnmarshallers</span><span class="o">.</span><span class="na">INTEGER</span><span class="o">,</span> <span class="s">"bid"</span><span class="o">,</span> <span class="n">bid</span> <span class="o">-&gt;</span>
                                        <span class="n">parameter</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="n">user</span> <span class="o">-&gt;</span> <span class="o">{</span>
                                            <span class="c1">//ç«æ ‡ï¼Œå‘å®Œå³ä¸¢å¼ƒï¼Œä¸ç”¨ç­‰å¾…å“åº”</span>
                                            <span class="n">auction</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Auction</span><span class="o">.</span><span class="na">Bid</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">bid</span><span class="o">));</span>
                                            <span class="k">return</span> <span class="nf">complete</span><span class="o">(</span><span class="nc">StatusCodes</span><span class="o">.</span><span class="na">ACCEPTED</span><span class="o">,</span> <span class="s">"bid placed"</span><span class="o">);</span>
                                        <span class="o">})</span>
                                <span class="o">)),</span>
                        <span class="n">get</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                            <span class="c1">//å‘actoræŸ¥è¯¢å½“å‰æ‹å–çŠ¶æ€</span>
                            <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Auction</span><span class="o">.</span><span class="na">Bids</span><span class="o">&gt;</span> <span class="n">bids</span> <span class="o">=</span> <span class="n">ask</span><span class="o">(</span><span class="n">auction</span><span class="o">,</span> <span class="nc">Auction</span><span class="o">.</span><span class="na">GetBids</span><span class="o">::</span><span class="k">new</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">5</span><span class="o">),</span> <span class="n">system</span><span class="o">.</span><span class="na">scheduler</span><span class="o">());</span>
                            <span class="k">return</span> <span class="nf">completeOKWithFuture</span><span class="o">(</span><span class="n">bids</span><span class="o">,</span> <span class="nc">Jackson</span><span class="o">.</span><span class="na">marshaller</span><span class="o">());</span>
                        <span class="o">}))));</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Auction</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">Auction</span><span class="o">.</span><span class="na">Message</span><span class="o">&gt;</span> <span class="o">{</span>

        <span class="c1">//ç«æ ‡åˆ—è¡¨</span>
        <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Bid</span><span class="o">&gt;</span> <span class="n">bids</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

        <span class="kd">interface</span> <span class="nc">Message</span> <span class="o">{}</span>

        <span class="c1">//ç«æ ‡è€…ä¿¡æ¯</span>
        <span class="nd">@AllArgsConstructor</span>
        <span class="nd">@Getter</span>
        <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Bid</span> <span class="kd">implements</span> <span class="nc">Message</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">String</span> <span class="n">userId</span><span class="o">;</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">offer</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">//è·å–ç«æ ‡ä¿¡æ¯</span>
        <span class="nd">@AllArgsConstructor</span>
        <span class="kd">static</span> <span class="kd">class</span> <span class="nc">GetBids</span> <span class="kd">implements</span> <span class="nc">Message</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Bids</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">//å…¨éƒ¨ç«æ ‡ä¿¡æ¯</span>
        <span class="nd">@AllArgsConstructor</span>
        <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Bids</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Bid</span><span class="o">&gt;</span> <span class="n">bids</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nf">Auction</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="nl">Auction:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Bid</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onBid</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">GetBids</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onGetBids</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="cm">/**
         * å¼€å§‹ç«æ ‡æ¶ˆæ¯å›å¤ï¼Œå°†ç«æ ‡ä¿¡æ¯æ·»åŠ åˆ°ç«æ ‡é›†åˆä¸­
         *
         * @param bid Bid
         * @return
         */</span>
        <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="nf">onBid</span><span class="o">(</span><span class="nc">Bid</span> <span class="n">bid</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">bids</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">bid</span><span class="o">);</span>
            <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Bid complete: {}, {}"</span><span class="o">,</span> <span class="n">bid</span><span class="o">.</span><span class="na">userId</span><span class="o">,</span> <span class="n">bid</span><span class="o">.</span><span class="na">offer</span><span class="o">);</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
         * è·å–å½“å‰å…¨éƒ¨çš„ç«æ ‡ä¿¡æ¯
         *
         * @param getBids GetBids
         * @return Bids-ç¤ºä¾‹ä¸­å­˜å‚¨çš„ç«æ ‡é›†åˆæ„å»ºBidså®ä¾‹è¿”å›
         */</span>
        <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="nf">onGetBids</span><span class="o">(</span><span class="nc">GetBids</span> <span class="n">getBids</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">getBids</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Bids</span><span class="o">(</span><span class="n">bids</span><span class="o">));</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="615-è¿è¡Œæµ‹è¯•">6.1.5. è¿è¡Œæµ‹è¯•</h3>

<p><strong>è¿è¡Œmainæ–¹æ³•è¿›è¡Œæµ‹è¯•</strong></p>

<p>è¿è¡Œå¦‚ä¸‹å›¾ï¼š</p>

<p><img src="https://liulv.work/images/img/20200914162930.png" alt="20200914162930" /></p>

<p><strong>æ·»åŠ æ‹å–å‡ºä»·ï¼ˆç«æ ‡ä¿¡æ¯ï¼‰æµ‹è¯•</strong></p>

<p>å¯ä»¥curl -X PUT â€œhttp://localhost:8080/auction?bid=22&amp;user=MartinOâ€åœ¨ç»ˆç«¯ä¸Šé€šè¿‡æ·»åŠ æ‹å–å‡ºä»·(ç«æ ‡ä¿¡æ¯)ã€‚</p>

<p><img src="https://liulv.work/images/img/20200914163223.png" alt="20200914163223" /></p>

<p><strong>æŸ¥çœ‹æ‹å–ä¿¡æ¯ï¼ˆå…¨éƒ¨çš„ç«æ ‡ä¿¡æ¯ï¼‰æµ‹è¯•</strong></p>

<p>ç„¶åæ‚¨å¯ä»¥åœ¨æµè§ˆå™¨ä¸­ï¼ŒURL http//localhost:8080/auctionä¸Šæˆ–åœ¨ç»ˆç«¯ä¸Šé€šè¿‡æ¥æŸ¥çœ‹æ‹å–çŠ¶æ€curl http://localhost:8080/auctionã€‚</p>

<p><img src="https://liulv.work/images/img/20200915103120.png" alt="20200915103120" /></p>

<p><img src="https://liulv.work/images/img/20200915103210.png" alt="20200915103210" /></p>

<p>**é‡åˆ°BUGï¼šå°†Bis POJOè§£æjsonæŠ¥é”™æ— æ³•è§£æå…¶ä¸­å±æ€§List<big>ï¼Œæç¤ºæ— æ³•ç³»åˆ—åŒ–Big POJOç±»**</big></p>

<p>Big POJOè¦ä½œä¸ºBidsä¸­listé›†åˆå±æ€§, éœ€è¦æ·»åŠ @Getter, ä¸ç„¶ä¼šæ— æ³•è§£æBidsä¸­çš„Bidé›†åˆ, æŠ¥é”™æ— æ³•ç³»åˆ—åŒ–Bigç±»ã€‚</p>

<p><img src="https://liulv.work/images/img/20200915103653.png" alt="20200915103653" /></p>

<p><strong>æœ‰å…³JSONç¼–ç»„å’Œè§£ç¼–</strong></p>

<p>æœ‰å…³JSONç¼–ç»„å’Œè§£ç¼–å·¥ä½œæ–¹å¼çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§<a href="https://doc.akka.io/docs/akka-http/current/common/json-support.html">JSONæ”¯æŒ</a>éƒ¨åˆ†ã€‚</p>

<p>åœ¨â€œé«˜çº§æœåŠ¡å™¨ç«¯APIâ€å°èŠ‚ä¸­äº†è§£æœ‰å…³é«˜çº§APIçš„è¯¦ç»†ä¿¡æ¯ã€‚</p>

<h2 id="62-ç¤ºä¾‹2-jobæ“ä½œ">6.2. ç¤ºä¾‹2-Jobæ“ä½œ</h2>

<h3 id="621-ç¤ºä¾‹ç®€ä»‹">6.2.1. ç¤ºä¾‹ç®€ä»‹</h3>

<p>æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå°å‹WebæœåŠ¡å™¨ï¼ˆJobä½œä¸šç®¡ç†ï¼‰ï¼Œè¯¥æœåŠ¡å™¨è´Ÿè´£å†…å®¹æœ‰ä»¥ä¸‹3æ–¹é¢å†…å®¹ï¼š</p>
<ol>
  <li>è®°å½•å…¶çŠ¶æ€å’ŒæŒç»­æ—¶é—´çš„æ„å»ºä½œä¸šJob</li>
  <li>æŒ‰IDå’ŒçŠ¶æ€æŸ¥è¯¢ä½œä¸š</li>
  <li>æ¸…é™¤ä½œä¸šJobå†å²è®°å½•ã€‚</li>
</ol>

<h3 id="622-æ„å»ºjobä¿¡æ¯çš„å­˜å‚¨åº“-ä¸å®é™…actoräº¤äº’">6.2.2. æ„å»ºJobä¿¡æ¯çš„å­˜å‚¨åº“-ä¸å®é™…Actoräº¤äº’</h3>

<p>æ„å»ºActor-JobRepositoryï¼ŒActoräº¤äº’å¿…ä¸å¯å°‘å¿…é¡»å…ˆæ·»åŠ æ¶ˆæ¯äº¤ä»˜éœ€è¦çš„POJO.</p>

<p><strong>Job POJO</strong></p>

<p>è¿™é‡Œé¦–å…ˆéœ€è¦å®šä¹‰Job POJOï¼ŒåŒ…å«ä¸»é”®IDã€é¡¹ç›®åç§°ã€çŠ¶æ€ã€æŒç»­æ—¶é—´ç­‰å±æ€§ï¼Œå¹¶æ·»åŠ Jacksonç¼–ç»„å’Œè§£ç»„JSONæ”¯æŒçš„é…ç½®@JsonFormatã€ @JsonPropertyã€@JsonCreatorç­‰æ³¨è§£ã€‚Jsonå‚æ•°æ¨¡å¼ä½¿ç”¨JsonCreator.Mode.PROPERTIESå³æŒ‡ç¤ºåˆ›å»ºè€…çš„å‚æ•°å°†ä¸å—åŒ¹é…çº¦æŸï¼Œä½¿ç”¨åˆ›å»ºè€…å‚æ•°åç§°ï¼ˆæ˜¾å¼æˆ–éšå¼ï¼‰çš„ä¼ å…¥å¯¹è±¡å€¼çš„å±æ€§ä½¿ä¼ å…¥çš„ Objectå±æ€§ä¸å‚æ•°åŒ¹é…ã€‚</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre>   <span class="cm">/**
     * Job jsonå¯¹è±¡
     */</span>
    <span class="nd">@AllArgsConstructor</span>
    <span class="nd">@JsonFormat</span>
    <span class="nd">@ToString</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Job</span> <span class="o">{</span>
        <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span>
        <span class="kd">final</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
        <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"project-name"</span><span class="o">)</span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">projectName</span><span class="o">;</span>
        <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"status"</span><span class="o">)</span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">status</span><span class="o">;</span>
        <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"duration"</span><span class="o">)</span>
        <span class="kd">final</span> <span class="nc">Long</span> <span class="n">duration</span><span class="o">;</span>

        <span class="nd">@JsonCreator</span><span class="o">(</span><span class="n">mode</span> <span class="o">=</span> <span class="nc">JsonCreator</span><span class="o">.</span><span class="na">Mode</span><span class="o">.</span><span class="na">PROPERTIES</span><span class="o">)</span>
        <span class="kd">public</span> <span class="nf">Job</span><span class="o">(</span><span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"project-name"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">projectName</span><span class="o">,</span>
                   <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"duration"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">duration</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">projectName</span><span class="o">,</span> <span class="s">"Success"</span><span class="o">,</span> <span class="n">duration</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>Actoræ¶ˆæ¯ç±»å‹Actorè¯·æ±‚æˆåŠŸæˆ–å¤±è´¥çš„å“åº”-Response</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre>  <span class="c1">// æˆåŠŸå’Œå¤±è´¥å“åº”</span>
    <span class="kd">interface</span> <span class="nc">Response</span> <span class="o">{}</span>

    <span class="cm">/**
     * æˆåŠŸå“åº”OK
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">OK</span> <span class="kd">implements</span> <span class="nc">Response</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="no">OK</span> <span class="no">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="no">OK</span><span class="o">();</span>

        <span class="kd">private</span> <span class="nf">OK</span><span class="o">()</span> <span class="o">{}</span>

        <span class="kd">public</span> <span class="kd">static</span> <span class="no">OK</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="no">INSTANCE</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * å¤±è´¥å“åº”
     */</span>
    <span class="nd">@AllArgsConstructor</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">KO</span> <span class="kd">implements</span> <span class="nc">Response</span> <span class="o">{</span>
        <span class="c1">//å¤±è´¥åŸå› </span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">reason</span><span class="o">;</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>Actorè¡Œä¸ºç±»å‹</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre>    <span class="c1">//å¯ä»¥å‘é€åˆ°æ­¤è¡Œä¸ºçš„æ‰€æœ‰å¯èƒ½çš„æ¶ˆæ¯æ¥å£, æ­¤actoréœ€è¦æ¥æ”¶çš„æ¶ˆæ¯éƒ½å¿…é¡»ç»§æ‰¿Commandæ¥å£</span>
    <span class="kd">interface</span> <span class="nc">Command</span> <span class="o">{}</span>

     <span class="cm">/**
     * æ·»åŠ job
     */</span>
    <span class="nd">@AllArgsConstructor</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">AddJob</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Job</span> <span class="n">job</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Response</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * æ ¹æ®job IDè·å–Jobä¿¡æ¯
     */</span>
    <span class="nd">@AllArgsConstructor</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">GetJobById</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Job</span><span class="o">&gt;&gt;</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * åˆ›å»ºjob å®ä¾‹
     */</span>
    <span class="nd">@AllArgsConstructor</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ClearJobs</span> <span class="kd">implements</span> <span class="nc">Command</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">Response</span><span class="o">&gt;</span> <span class="n">replyTo</span><span class="o">;</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>Actorå®ä¾‹-AbstractBehavior</strong></p>

<p>ä¸Šé¢å·²ç»åˆ›å»ºæ¶ˆæ¯äº¤äº’ç›¸å…³çš„æ¶ˆæ¯POJOå’Œå“åº”POJO, é‚£ä¹ˆæ¥ä¸‹æ¥éœ€è¦åˆ›å»ºæŠ½è±¡è¡Œä¸ºAbstractBehavioråˆ›å»ºActorå¹¶æ¥æ”¶å¤„ç†AddJobã€GetJobByIdã€ClearJobsæ¶ˆæ¯ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JobRepository</span> <span class="kd">extends</span> <span class="nc">AbstractBehavior</span><span class="o">&lt;</span><span class="nc">JobRepository</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="cm">/**
     * jobså±æ€§ï¼Œæ·»åŠ æ‰€æœ‰æ·»åŠ jobä¿¡æ¯: Map&lt;jobId, Job&gt;
     */</span>
    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">Job</span><span class="o">&gt;</span> <span class="n">jobs</span><span class="o">;</span>

    <span class="cm">/**
     * åˆ›å»º Behavior
     * @return Behavior&lt;Command&gt;
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">create</span><span class="o">(</span><span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">Job</span><span class="o">&gt;());</span>
    <span class="o">}</span>

     <span class="cm">/**
     * åˆ›å»ºBehavior æ–¹æ³•
     * @param jobs Map&lt;Long, Job&gt;
     * @return Behavior&lt;Command&gt;
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">Job</span><span class="o">&gt;</span> <span class="n">jobs</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="n">context</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">JobRepository</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">jobs</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Actor æ„é€ å‡½æ•°
     *
     * @param context ActorContext&lt;Command&gt;
     * @param jobs jobçš„mapé›†åˆ
     */</span>
    <span class="kd">private</span> <span class="nf">JobRepository</span><span class="o">(</span><span class="nc">ActorContext</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">Job</span><span class="o">&gt;</span> <span class="n">jobs</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">jobs</span> <span class="o">=</span> <span class="n">jobs</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// æ¥æ”¶å¤„ç†æ‰€æœ‰å¯èƒ½çš„ä¼ å…¥æ¶ˆæ¯å¹¶å°†çŠ¶æ€jobä¿ç•™åœ¨actorä¸­</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Receive</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">newReceiveBuilder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">AddJob</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">addJob</span><span class="o">)</span>
                <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">GetJobById</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">getJobById</span><span class="o">)</span>
                <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">ClearJobs</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">clearJobs</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">//æ¶ˆæ¯å¤„ç†..</span>
     <span class="cm">/**
     * å¤„ç†AddJobæ¶ˆæ¯ï¼Œ å¦‚æœjobå·²ç»å­˜åœ¨jobé›†åˆä¸­ï¼Œå“åº”jobå·²ç»å­˜åœ¨
     *
     * @param msg AddJob
     * @return
     */</span>
    <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">addJob</span><span class="o">(</span><span class="nc">AddJob</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">jobId</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">job</span><span class="o">.</span><span class="na">id</span><span class="o">;</span>
        <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"actor æ·»åŠ job {}"</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">job</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">jobs</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">jobId</span><span class="o">))</span>
            <span class="n">msg</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="no">KO</span><span class="o">(</span><span class="s">"Job-"</span> <span class="o">+</span> <span class="n">jobId</span> <span class="o">+</span> <span class="s">" å·²ç»å­˜åœ¨"</span><span class="o">));</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="n">jobs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">jobId</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">job</span><span class="o">);</span>
            <span class="n">msg</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="no">OK</span><span class="o">.</span><span class="na">getInstance</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">getJobById</span><span class="o">(</span><span class="nc">GetJobById</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">getContext</span><span class="o">().</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"actor æ ¹æ®id-{}æŸ¥è¯¢job "</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">id</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">jobs</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">id</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">msg</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">jobs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">id</span><span class="o">)));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">msg</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Command</span><span class="o">&gt;</span> <span class="nf">clearJobs</span><span class="o">(</span><span class="nc">ClearJobs</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">replyTo</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="no">OK</span><span class="o">.</span><span class="na">getInstance</span><span class="o">());</span>
        <span class="n">jobs</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="623-å®šä¹‰route">6.2.3. å®šä¹‰Route</h3>

<p>å®šä¹‰ä¸å…ˆå‰å®šä¹‰çš„Actorè¡Œä¸ºè¿›è¡Œé€šä¿¡å¹¶å¤„ç†å…¶æ‰€æœ‰å¯èƒ½å“åº”çš„Route.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.tcfuture.akka.http.interaction</span><span class="o">;</span>

<span class="c1">//#route</span>

<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorSystem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.AskPattern</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.marshallers.jackson.Jackson</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.model.StatusCodes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.server.AllDirectives</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.server.Route</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.Duration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.CompletionStage</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">akka</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">javadsl</span><span class="o">.</span><span class="na">unmarshalling</span><span class="o">.</span><span class="na">StringUnmarshallers</span><span class="o">.</span><span class="na">LONG</span><span class="o">;</span>

<span class="cm">/**
 * @author liulv
 * @since 1.0.0
 *
 * å®šä¹‰ä¸å…ˆå‰å®šä¹‰çš„Actorè¡Œä¸ºè¿›è¡Œé€šä¿¡å¹¶å¤„ç†å…¶æ‰€æœ‰å¯èƒ½å“åº”çš„Route.
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JobRoutes</span> <span class="kd">extends</span> <span class="nc">AllDirectives</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorSystem</span><span class="o">&lt;?&gt;</span> <span class="n">system</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">JobRepository</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">buildJobRepository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">JobRoutes</span><span class="o">(</span><span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">JobRepository</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">buildJobRepository</span><span class="o">,</span> <span class="nc">ActorSystem</span><span class="o">&lt;?&gt;</span> <span class="n">system</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">system</span> <span class="o">=</span> <span class="n">system</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">buildJobRepository</span> <span class="o">=</span> <span class="n">buildJobRepository</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Route</span> <span class="nf">addOrDelete</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">concat</span><span class="o">(</span>
                <span class="n">post</span><span class="o">(()</span> <span class="o">-&gt;</span>
                        <span class="n">entity</span><span class="o">(</span><span class="nc">Jackson</span><span class="o">.</span><span class="na">unmarshaller</span><span class="o">(</span><span class="nc">JobRepository</span><span class="o">.</span><span class="na">Job</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">job</span> <span class="o">-&gt;</span>
                                <span class="n">onSuccess</span><span class="o">(</span><span class="n">add</span><span class="o">(</span><span class="n">job</span><span class="o">),</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">complete</span><span class="o">(</span><span class="s">"Job added"</span><span class="o">))</span>
                        <span class="o">)),</span>
                <span class="c1">//åˆ é™¤</span>
                <span class="n">delete</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">onSuccess</span><span class="o">(</span><span class="n">deleteAll</span><span class="o">(),</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">complete</span><span class="o">(</span><span class="s">"Jobs cleared"</span><span class="o">)))</span>
        <span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * æ ¹æ®Jobæ„å»ºAddJobæ¶ˆæ¯è¯·æ±‚Ask, Askå“åº”é€šè¿‡handleKOæ–¹æ³•å¤„ç†åè¿”å›
     *
     * @param job Job
     * @return CompletionStage CompletionStage&lt;JobRepository.OK&gt;
     */</span>
    <span class="kd">private</span> <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">JobRepository</span><span class="o">.</span><span class="na">OK</span><span class="o">&gt;</span> <span class="nf">add</span><span class="o">(</span><span class="nc">JobRepository</span><span class="o">.</span><span class="na">Job</span> <span class="n">job</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">handleKO</span><span class="o">(</span><span class="nc">AskPattern</span><span class="o">.</span><span class="na">ask</span><span class="o">(</span>
                <span class="n">buildJobRepository</span><span class="o">,</span>
                <span class="n">replyTo</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">JobRepository</span><span class="o">.</span><span class="na">AddJob</span><span class="o">(</span><span class="n">job</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">),</span>
                <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span>
                <span class="n">system</span><span class="o">.</span><span class="na">scheduler</span><span class="o">()));</span>
    <span class="o">}</span>

    <span class="cm">/**
     * æ„å»ºClearJobsæ¶ˆæ¯è¯·æ±‚Ask, Askå“åº”é€šè¿‡handleKOæ–¹æ³•å¤„ç†åè¿”å›
     *
     * @return CompletionStage CompletionStage&lt;JobRepository.OK&gt;
     */</span>
    <span class="kd">private</span> <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">JobRepository</span><span class="o">.</span><span class="na">OK</span><span class="o">&gt;</span> <span class="nf">deleteAll</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">handleKO</span><span class="o">(</span><span class="nc">AskPattern</span><span class="o">.</span><span class="na">ask</span><span class="o">(</span>
                <span class="n">buildJobRepository</span><span class="o">,</span>
                <span class="nc">JobRepository</span><span class="o">.</span><span class="na">ClearJobs</span><span class="o">::</span><span class="k">new</span><span class="o">,</span>
                <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span>
                <span class="n">system</span><span class="o">.</span><span class="na">scheduler</span><span class="o">()));</span>
    <span class="o">}</span>

    <span class="cm">/**
     * æ„å»ºAskè¯·æ±‚çš„è·¯ç”±Route
     *
     * @return Route
     */</span>
    <span class="kd">public</span> <span class="nc">Route</span> <span class="nf">jobRoutes</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">pathPrefix</span><span class="o">(</span><span class="s">"jobs"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span>
                <span class="n">concat</span><span class="o">(</span>
                        <span class="n">pathEnd</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">addOrDelete</span><span class="o">),</span> <span class="c1">//å­è·¯ç”±</span>
                        <span class="n">get</span><span class="o">(()</span> <span class="o">-&gt;</span>     <span class="c1">//jobs/longè·¯ç”±</span>
                                <span class="n">path</span><span class="o">(</span><span class="no">LONG</span><span class="o">,</span> <span class="n">jobId</span> <span class="o">-&gt;</span>
                                        <span class="n">onSuccess</span><span class="o">(</span><span class="n">getJob</span><span class="o">(</span><span class="n">jobId</span><span class="o">),</span> <span class="n">jobOption</span> <span class="o">-&gt;</span> <span class="o">{</span>
                                            <span class="k">if</span> <span class="o">(</span><span class="n">jobOption</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
                                                <span class="k">return</span> <span class="nf">complete</span><span class="o">(</span><span class="nc">StatusCodes</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span> <span class="n">jobOption</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span> <span class="nc">Jackson</span><span class="o">.&lt;</span><span class="nc">JobRepository</span><span class="o">.</span><span class="na">Job</span><span class="o">&gt;</span><span class="n">marshaller</span><span class="o">());</span>
                                            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                                                <span class="k">return</span> <span class="nf">complete</span><span class="o">(</span><span class="nc">StatusCodes</span><span class="o">.</span><span class="na">NOT_FOUND</span><span class="o">,</span> <span class="s">"job-"</span> <span class="o">+</span> <span class="n">jobId</span> <span class="o">+</span>
                                                        <span class="s">"ä¸å­˜åœ¨"</span><span class="o">);</span>
                                            <span class="o">}</span>
                                        <span class="o">})</span>
                                <span class="o">)</span>
                        <span class="o">)</span>
                <span class="o">)</span>
        <span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * æ ¹æ®JobIdæ„å»ºActor Askçš„è¯·æ±‚
     *
     * @param jobId Job ID
     * @return CompletionStage&lt;Optional&lt;JobRepository.Job&gt;&gt;
     */</span>
    <span class="kd">private</span> <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">JobRepository</span><span class="o">.</span><span class="na">Job</span><span class="o">&gt;&gt;</span> <span class="nf">getJob</span><span class="o">(</span><span class="nc">Long</span> <span class="n">jobId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">AskPattern</span><span class="o">.</span><span class="na">ask</span><span class="o">(</span>
                <span class="n">buildJobRepository</span><span class="o">,</span>
                <span class="n">replyTo</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">JobRepository</span><span class="o">.</span><span class="na">GetJobById</span><span class="o">(</span><span class="n">jobId</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">),</span>
                <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span>
                <span class="n">system</span><span class="o">.</span><span class="na">scheduler</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="cm">/**
     *  å¤„ç†Actor Askè¯·æ±‚çš„å“åº”ï¼Œå¼‚å¸¸å¤„ç†å¤±è´¥åŸå› æˆ–è¿”å›CompletionStage&lt;JobRepository.OK&gt;
     *
     * @param stage Actor Askå“åº” CompletionStage&lt;JobRepository.Response&gt;
     * @return CompletionStage&lt;JobRepository.OK&gt;
     */</span>
    <span class="kd">private</span> <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">JobRepository</span><span class="o">.</span><span class="na">OK</span><span class="o">&gt;</span> <span class="nf">handleKO</span><span class="o">(</span><span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">JobRepository</span><span class="o">.</span><span class="na">Response</span><span class="o">&gt;</span> <span class="n">stage</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">stage</span><span class="o">.</span><span class="na">thenApply</span><span class="o">(</span><span class="n">response</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">response</span> <span class="k">instanceof</span> <span class="nc">JobRepository</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="o">(</span><span class="nc">JobRepository</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span><span class="n">response</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">response</span> <span class="k">instanceof</span> <span class="nc">JobRepository</span><span class="o">.</span><span class="na">KO</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(((</span><span class="nc">JobRepository</span><span class="o">.</span><span class="na">KO</span><span class="o">)</span> <span class="n">response</span><span class="o">).</span><span class="na">reason</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Invalid response"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="624-åˆ›å»ºæ ¹actor">6.2.4. åˆ›å»ºæ ¹Actor</h3>

<p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªactorç³»ç»Ÿçš„æ ¹è¡Œä¸ºBehaviorç”¨äºå¼•å¯¼WebæœåŠ¡å™¨å¹¶ä½¿ç”¨å®ƒè¿è¡Œã€‚</p>
<ol>
  <li>mainæ–¹æ³•åˆ›å»ºäº†Configä½œä¸ºå‚æ•°</li>
  <li>ç„¶åé€šè¿‡ActorSystem.createæ–¹æ³•åˆ›å»ºActorSyste</li>
  <li>è°ƒç”¨create()åˆ›å»ºBehaviorå¹¶åˆ›å»ºHttpServer</li>
  <li>å¹¶å°†åˆ›å»ºçš„CompletionStage<ServerBinding> æƒ…å†µå‘é€ç»™è‡ªå·±ï¼Œå¦‚æœServerBindingä¸ä¸ºç©ºåˆ™å‘é€Started(binding)æ¶ˆæ¯ç»™è‡ªå·±ï¼Œå¦åˆ™å‘é€StartFailed(failure)ç»™è‡ªå·±ã€‚</ServerBinding></li>
  <li>æœ€ç»ˆè°ƒç”¨starting(false)åˆ›å»ºBehavior
    <ul>
      <li>æ¥æ”¶StartFailedæ¶ˆæ¯åˆ™æŠ›å‡ºå¼‚å¸¸-æœåŠ¡å™¨å¯åŠ¨å¤±è´¥</li>
      <li>æ¥æ”¶Startedæ¶ˆæ¯åˆ™æ‰“å°æœåŠ¡å¯åŠ¨æƒ…å†µï¼Œå¦‚æœå‚æ•°ä¸ºwasStoppedä¸ºtrueåˆ™å‘é€Stopæ¶ˆæ¯ç»™è‡ªå·±ï¼Œè·å–Startedæ¶ˆæ¯ä¸­ServerBindingä¼ é€’ç»™runningæ–¹æ³•åˆ›å»ºActor</li>
      <li>æ¥æ”¶Stopæ¶ˆæ¯ï¼Œè°ƒç”¨starting(true)æ–¹æ³•</li>
    </ul>
  </li>
  <li>5æ­¥éª¤è°ƒç”¨äº†runningæ–¹æ³•åœæ­¢Actorï¼Œæ¥æ”¶åˆ°Stopæ¶ˆæ¯ï¼Œåˆ™åœæ­¢Actorå¹¶ï¼ŒonSignal(PostStop..å³ä¸ºåœæ­¢actoråå¤„ç†ï¼Œè¿™é‡Œè§£ç»‘ServerBinding</li>
</ol>

<p>æ³¨æ„ï¼š</p>
<ul>
  <li>æœ€ç»ˆåˆ›å»ºActoræ˜¯é€šè¿‡runningæ–¹æ³•ï¼Œä¸­é—´éƒ½æ˜¯æ¥æ”¶æ¶ˆæ¯å¤„ç†ç­‰</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.tcfuture.akka.http.interaction</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.ActorSystem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.Behavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.PostStop</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.BehaviorBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.typed.javadsl.Behaviors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.Http</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.ServerBinding</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.http.javadsl.server.Route</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.typesafe.config.Config</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.typesafe.config.ConfigFactory</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.CompletionStage</span><span class="o">;</span>

<span class="cm">/**
 * ä¾èµ–JobRoutesã€JobRepository
 *
 * æœ€åï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¼•å¯¼WebæœåŠ¡å™¨å¹¶ä½¿ç”¨å®ƒä½œä¸ºactorç³»ç»Ÿçš„æ ¹è¡Œä¸ºï¼šBehavior
 *
 * @author liulv
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JobAppSample</span> <span class="o">{</span>

    <span class="kd">interface</span> <span class="nc">Message</span> <span class="o">{}</span>

    <span class="cm">/**
     * å¯åŠ¨å¤±è´¥æ¶ˆæ¯
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">StartFailed</span> <span class="kd">implements</span> <span class="nc">Message</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Throwable</span> <span class="n">ex</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">StartFailed</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">ex</span> <span class="o">=</span> <span class="n">ex</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * å·²å¯åŠ¨
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Started</span> <span class="kd">implements</span> <span class="nc">Message</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ServerBinding</span> <span class="n">binding</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Started</span><span class="o">(</span><span class="nc">ServerBinding</span> <span class="n">binding</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">binding</span> <span class="o">=</span> <span class="n">binding</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Stop</span> <span class="kd">implements</span> <span class="nc">Message</span> <span class="o">{}</span>

    <span class="cm">/**
     * åˆ›å»ºroot Actor - ActorSystem
     * å¹¶åˆ›å»ºå­JobRepositoryã€JobRoutesæ„å»ºRoute
     *
     * @param host httpçš„ipåœ°å€
     * @param port httpçš„ç«¯å£
     * @return Behavior&lt;Message&gt;
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span><span class="nc">String</span> <span class="n">host</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="n">context</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">ActorSystem</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">system</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getSystem</span><span class="o">();</span>
            <span class="nc">ActorRef</span><span class="o">&lt;</span><span class="nc">JobRepository</span><span class="o">.</span><span class="na">Command</span><span class="o">&gt;</span> <span class="n">buildJobRepository</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">spawn</span><span class="o">(</span><span class="nc">JobRepository</span><span class="o">.</span><span class="na">create</span><span class="o">(),</span> <span class="s">"JobRepository"</span><span class="o">);</span>
            <span class="nc">Route</span> <span class="n">routes</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JobRoutes</span><span class="o">(</span><span class="n">buildJobRepository</span><span class="o">,</span> <span class="n">context</span><span class="o">.</span><span class="na">getSystem</span><span class="o">()).</span><span class="na">jobRoutes</span><span class="o">();</span>

            <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">ServerBinding</span><span class="o">&gt;</span> <span class="n">serverBinding</span> <span class="o">=</span>
                    <span class="nc">Http</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">system</span><span class="o">).</span><span class="na">newServerAt</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">).</span><span class="na">bind</span><span class="o">(</span><span class="n">routes</span><span class="o">);</span>

            <span class="c1">//ä¿®æ”¹åï¼Œå°†ç»™å®šçš„ç¬¬ä¸€ä¸ªå‚æ•°CompletionStageçš„ç»“æœå‘é€ç»™è¯¥Actorï¼ˆâ€œselfâ€ï¼‰ç»™å®šçš„åŠŸèƒ½ã€‚</span>
            <span class="n">context</span><span class="o">.</span><span class="na">pipeToSelf</span><span class="o">(</span><span class="n">serverBinding</span><span class="o">,</span> <span class="o">(</span><span class="n">binding</span><span class="o">,</span> <span class="n">failure</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">binding</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="k">new</span> <span class="nc">Started</span><span class="o">(</span><span class="n">binding</span><span class="o">);</span>
                <span class="k">else</span> <span class="k">return</span> <span class="k">new</span> <span class="nf">StartFailed</span><span class="o">(</span><span class="n">failure</span><span class="o">);</span>
            <span class="o">});</span>

            <span class="k">return</span> <span class="nf">starting</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="cm">/**
     * å¯åŠ¨Actoræ–¹æ³•ï¼Œæ¥æ”¶å„ç§æ¶ˆæ¯å¹¶æœ€ç»ˆè°ƒç”¨è‡ªå·±æˆ–runningæ–¹æ³•åˆ›å»ºBehaviorï¼Œå…¶æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨runningæ–¹æ³•åˆ›å»º
     * Behavior
     *
     * @param wasStopped æ˜¯å¦åœæ­¢Actorï¼Œä¸ºtrueæ˜¯åœæ­¢actoræš‚æ—¶æ— æ„ä¹‰ï¼Œå¯åŠ¨å°±é©¬ä¸Šåœæ­¢æœ‰ä»€ä¹ˆæ„ä¹‰
     * @return Behavior&lt;Message&gt;
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="nf">starting</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">wasStopped</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="n">context</span> <span class="o">-&gt;</span>
                <span class="nc">BehaviorBuilder</span><span class="o">.&lt;</span><span class="nc">Message</span><span class="o">&gt;</span><span class="n">create</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">StartFailed</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">failed</span> <span class="o">-&gt;</span> <span class="o">{</span>
                            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"æœåŠ¡å™¨å¯åŠ¨å¤±è´¥"</span><span class="o">,</span> <span class="n">failed</span><span class="o">.</span><span class="na">ex</span><span class="o">);</span>
                        <span class="o">})</span>
                        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Started</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="o">{</span>
                            <span class="n">context</span><span class="o">.</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span>
                                    <span class="s">"Server online at http://{}:{}"</span><span class="o">,</span>
                                    <span class="n">msg</span><span class="o">.</span><span class="na">binding</span><span class="o">.</span><span class="na">localAddress</span><span class="o">().</span><span class="na">getAddress</span><span class="o">(),</span>
                                    <span class="n">msg</span><span class="o">.</span><span class="na">binding</span><span class="o">.</span><span class="na">localAddress</span><span class="o">().</span><span class="na">getPort</span><span class="o">());</span>

                            <span class="k">if</span> <span class="o">(</span><span class="n">wasStopped</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">getSelf</span><span class="o">().</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Stop</span><span class="o">());</span>

                            <span class="k">return</span> <span class="nf">running</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">binding</span><span class="o">);</span>
                        <span class="o">})</span>
                        <span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Stop</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="o">{</span>
                            <span class="c1">//æˆ‘ä»¬æ”¶åˆ°äº†åœæ­¢æ¶ˆæ¯ï¼Œä½†å°šæœªå®Œæˆå¼€å§‹ï¼Œ</span>
                            <span class="c1">//æˆ‘ä»¬æ— æ³•åœæ­¢ï¼Œç›´åˆ°å¼€å§‹å®Œæˆ</span>
                            <span class="k">return</span> <span class="nf">starting</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                        <span class="o">})</span>
                        <span class="o">.</span><span class="na">build</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="cm">/**
     * æœ€ç»ˆåˆ›å»ºBehavior Actor
     *
     * @param binding ServerBinding HttpæœåŠ¡ç»‘å®šä¿¡æ¯
     * @return Behavior&lt;Message&gt;
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Behavior</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="nf">running</span><span class="o">(</span><span class="nc">ServerBinding</span> <span class="n">binding</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">setup</span><span class="o">(</span><span class="n">context</span> <span class="o">-&gt;</span>
                    <span class="nc">BehaviorBuilder</span><span class="o">.&lt;</span><span class="nc">Message</span><span class="o">&gt;</span><span class="n">create</span><span class="o">().</span><span class="na">onMessage</span><span class="o">(</span><span class="nc">Stop</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="n">context</span><span class="o">.</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Behaviors åœæ­¢..."</span><span class="o">);</span>
                    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">stopped</span><span class="o">();</span>
                <span class="o">}).</span><span class="na">onSignal</span><span class="o">(</span><span class="nc">PostStop</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="n">context</span><span class="o">.</span><span class="na">getLog</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"ServerBinding è§£ç»‘..."</span><span class="o">);</span>
                    <span class="n">binding</span><span class="o">.</span><span class="na">unbind</span><span class="o">();</span>
                    <span class="k">return</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="na">same</span><span class="o">();</span>
                <span class="o">}).</span><span class="na">build</span><span class="o">()</span>
        <span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">overrides</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">overrides</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"akka.remote.artery.canonical.port"</span><span class="o">,</span> <span class="mi">27703</span><span class="o">);</span>
        <span class="c1">//overrides.put("akka.cluster.roles", Collections.singletonList(role));</span>

        <span class="nc">Config</span> <span class="n">config</span> <span class="o">=</span> <span class="nc">ConfigFactory</span><span class="o">.</span><span class="na">parseMap</span><span class="o">(</span><span class="n">overrides</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withFallback</span><span class="o">(</span><span class="nc">ConfigFactory</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="s">"http_test"</span><span class="o">));</span>


        <span class="nc">ActorSystem</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="n">system</span> <span class="o">=</span> <span class="nc">ActorSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
                <span class="nc">JobAppSample</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">),</span> <span class="s">"BuildJobsServer"</span><span class="o">,</span> <span class="n">config</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="625-è¿è¡Œæµ‹è¯•">6.2.5. è¿è¡Œæµ‹è¯•</h3>

<p><strong>è¿è¡Œå¯åŠ¨</strong></p>

<p>ç›´æ¥è¿è¡Œæ ¹actorç±»ä¸Šçš„mainæ–¹æ³•å³å¯ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹å›¾ï¼š
<img src="https://liulv.work/images/img/20200915150830.png" alt="20200915150830" /></p>

<p><strong>æ–°å¢Jobæµ‹è¯•</strong></p>

<p>åˆ›å»ºJob JSONæ–‡ä»¶http_job.json, å†…å®¹å¦‚ä¸‹</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="nl">"project-name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"æµ‹è¯•2"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"duration"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>é€šè¿‡CDå‘½ä»¤åˆ°jsonæ–‡ä»¶ç›®å½•ï¼Œç„¶åæ‰§è¡Œå¦‚curlå‘½ä»¤</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">cd</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">dirname</span> <span class="nv">$0</span><span class="si">)</span><span class="s2">"</span>
curl http://localhost:8080/jobs <span class="nt">-X</span> POST <span class="nt">-d</span> @http_job.json <span class="nt">--header</span> <span class="s2">"Content-Type:application/json"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ‰§è¡Œå‡ ä¸ªå¦‚ä¸‹å›¾ï¼Œæ–°å¢æˆåŠŸ</p>

<p><img src="https://liulv.work/images/img/20200915151330.png" alt="20200915151330" /></p>

<p><strong>é€šè¿‡IDæŸ¥è¯¢Jobä¿¡æ¯</strong></p>

<p>ç›´æ¥é€šè¿‡æµè§ˆå™¨æˆ–è€…curlå‘½ä»¤<code class="language-plaintext highlighter-rouge">curl http://localhost:8080/jobs/2</code>, å…¶ä¸­çš„2ä¸ºjobIdæ ¹æ®å®é™…åˆ›å»ºçš„jsonä¸­idè°ƒæ•´ï¼Œç»“æœå‡ºä¸‹å›¾ï¼š</p>

<p><img src="https://liulv.work/images/img/20200915151652.png" alt="20200915151652" /></p>

<p><strong>åˆ é™¤Jobä¿¡æ¯</strong></p>

<p>è°ƒç”¨<code class="language-plaintext highlighter-rouge">curl http://localhost:8080/jobs -X DELETE</code></p>

<p><img src="https://liulv.work/images/img/20200915152121.png" alt="20200915152121" /></p>

<p>å†æ¬¡è°ƒç”¨é€šè¿‡IDæŸ¥è¯¢Jobä¿¡æ¯<code class="language-plaintext highlighter-rouge">curl http://localhost:8080/jobs/2</code>æ£€æŸ¥ï¼Œæ­£å¸¸æƒ…å†µä¼šæç¤ºæŸ¥è¯¢çš„IDçš„Jobä¸å­˜åœ¨ï¼Œå¦‚ä¸‹å›¾</p>

<p><img src="https://liulv.work/images/img/20200915152646.png" alt="20200915152646" /></p>

:ET