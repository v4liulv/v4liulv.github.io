I"Q<h1 id="1-安装启动访问">1. 安装启动访问</h1>

<p><strong>Step 1: 下载</strong></p>

<p>下载地址：https://www.apache.org/dyn/closer.cgi?path=/druid/
下载最新版的Druid</p>

<p><strong>Step 2: 上传并解压</strong></p>

<p>上传到部署服务器下，在终端中运行以下命令来提取Druid</p>

<p>mkdir /var/lib/druid
tar -xzf apache-druid-0.20.0-bin.tar.gz -C /var/lib/druid</p>

<p><strong>Step 3:设置环境变量</strong></p>

<p>sudo echo ‘export DRUID_HOME=/var/lib/druid’ » /etc/profile
source /etc/profile</p>

<p><strong>Step 4：启动</strong>
cd $DRUID_HOME
./bin/start-micro-quickstart</p>

<p><strong>Step 4：访问Druid控制台</strong></p>

<p>可以访问http://ip:8888/unified-console.html来Druid控制台，控制台由Druid Router进程启动。</p>

<h1 id="2-从本地导入数据">2. 从本地导入数据</h1>

<h2 id="21-使用druid控制台-data-loader来加载数据">2.1. 使用Druid控制台-Data Loader来加载数据</h2>

<p><strong>Step 1：进入Load data</strong></p>

<p>点击控制台中的 Load data</p>

<p><img src="https://liulv.work/images/img/20201209161135.png" alt="20201209161135" /></p>

<p><strong>Step 2：选择本地磁盘</strong></p>

<p>选择 Local disk 然后点击 Connect data</p>

<p><img src="https://liulv.work/images/img/20201209161340.png" alt="20201209161340" /></p>

<p><strong>Step 3: 设置Connect</strong></p>

<p>在 Base directory 中输入 quickstart/tutorial/, 在 File filter 中输入 wikiticker-2015-09-12-sampled.json.gz。 Base directory 和 File filter 分开是因为可能需要同时从多个文件中摄取数据。然后点击apply确保您看到的数据是正确的，再点击Next: Parse data</p>

<p><img src="https://liulv.work/images/img/20201209161603.png" alt="20201209161603" /></p>

<p><img src="https://liulv.work/images/img/20201209161703.png" alt="20201209161703" /></p>

<p><strong>Step 4: 设置Parse data</strong></p>

<p>输入格式设置json, 点击下一步</p>

<p><img src="https://liulv.work/images/img/20201209161858.png" alt="20201209161858" /></p>

<p><strong>Step 5: 设置Parse time</strong></p>

<p>设置的分区列，这是默认设置time列即可，点击下一步</p>

<p><img src="https://liulv.work/images/img/20201209162047.png" alt="20201209162047" /></p>

<p><strong>Step 6: 设置转换</strong></p>

<p>可点击对应列，进行调整转换，这里不需要任何转换，可直接下一步</p>

<p><img src="https://liulv.work/images/img/20201209162311.png" alt="20201209162311" /></p>

<p><strong>Step 7: 设置过滤</strong></p>

<p>可点击对应列进行过滤设置，设置过滤值，这里不需要任何过滤，可直接下一步</p>

<p><img src="https://liulv.work/images/img/20201209162435.png" alt="20201209162435" /></p>

<p><strong>Step 7: 调整schema-列名和类型等</strong></p>

<p>可选择对应列进行修改，这里全部使用json默认的，可直接下一步</p>

<p><img src="https://liulv.work/images/img/20201209162654.png" alt="20201209162654" /></p>

<p><strong>Step 8: 设置分区</strong></p>

<p>分区类型可设置统一的和任意的，这里设置统一的，并且按天进行分区</p>

<p><img src="https://liulv.work/images/img/20201209162852.png" alt="20201209162852" /></p>

<p><strong>Step 9: 调优设置</strong></p>

<p>这里不进行任何优化，直接下一步提交</p>

<p><img src="https://liulv.work/images/img/20201209163005.png" alt="20201209163005" /></p>

<p><strong>Step 10: 提交设置</strong></p>

<p>修改数据源名称</p>

<p><img src="https://liulv.work/images/img/20201209163119.png" alt="20201209163119" /></p>

<p><strong>Step 11: 修改json规范</strong></p>

<p>这里暂时不需要修改，直接提交即可</p>

<p><img src="https://liulv.work/images/img/20201209163217.png" alt="20201209163217" /></p>

<p><strong>Step 12: 提交完成会进入到任务列表</strong></p>

<p><img src="https://liulv.work/images/img/20201209163811.png" alt="20201209163811" /></p>

<p>可点击详情按钮查看运行情况</p>

<p><img src="https://liulv.work/images/img/20201209163914.png" alt="20201209163914" /></p>

<p><img src="https://liulv.work/images/img/20201209164006.png" alt="20201209164006" /></p>

<p><strong>Step 13: 查看数据源并查询数据</strong></p>

<p>点击Datasource是否已经新增wikiticker-test</p>

<p><img src="https://liulv.work/images/img/20201209164137.png" alt="20201209164137" /></p>

<p>点击Query进行数据查询</p>

<p><img src="https://liulv.work/images/img/20201209164235.png" alt="20201209164235" /></p>

<h2 id="22-使用命令行方式加载数据">2.2. 使用命令行方式加载数据</h2>

<p>为了方便，在Druid的软件包中提供了一个批摄取的帮助脚本 bin/post-index-task</p>

<p>该脚本会将数据摄取任务发布到Druid Overlord并轮询Druid，直到可以查询数据为止。</p>

<p>在Druid根目录运行以下命令：</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">bin/post-index-task</span><span class="w"> </span><span class="nt">--file</span><span class="w"> </span><span class="nx">quickstart/tutorial/wikipedia-index.json</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>可以看到以下的输出：</p>

<pre><code class="language-log">Beginning indexing data for wikipedia
Task started: index_wikipedia_2018-07-27T06:37:44.323Z
Task log:     http://localhost:8081/druid/indexer/v1/task/index_wikipedia_2018-07-27T06:37:44.323Z/log
Task status:  http://localhost:8081/druid/indexer/v1/task/index_wikipedia_2018-07-27T06:37:44.323Z/status
Task index_wikipedia_2018-07-27T06:37:44.323Z still running...
Task index_wikipedia_2018-07-27T06:37:44.323Z still running...
Task finished with status: SUCCESS
Completed indexing data for wikipedia. Now loading indexed data onto the cluster...
wikipedia loading complete! You may now query your data
</code></pre>

<p>提交任务规范后，您可以按照上述相同的规范等待数据加载然后查询</p>

<h2 id="23-使用http请求加载数据">2.3. 使用HTTP请求加载数据</h2>

<p>我们简短地讨论一下如何在不使用脚本的情况下提交数据摄取任务，您将不需要运行这些命令。</p>

<p>要提交任务，可以在一个新的终端中通过以下方式提交任务到Druid：</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">curl</span><span class="w"> </span><span class="nt">-X</span><span class="w"> </span><span class="s1">'POST'</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="s1">'Content-Type:application/json'</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="err">@</span><span class="nx">quickstart/tutorial/wikipedia-index.json</span><span class="w"> </span><span class="nx">http://localhost:8081/druid/indexer/v1/task</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>当任务提交成功后会打印出来任务的ID</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre> {"task":"index_wikipedia_2018-06-09T21:30:32.802Z"}
</pre></td></tr></tbody></table></code></pre></div></div>

<p>您可以如上所述从控制台监视此任务的状态</p>

<h1 id="3-从hadoop加载数据">3. 从Hadoop加载数据</h1>

<p>本章节介绍如何使用远程Hadoop集群将数据文件加载到Apache Druid中。</p>

<h2 id="31-前提">3.1. 前提</h2>

<p>已经在同一可以互通网络<a href="#1-安装启动访问">安装了Druid</a>和<a href="https://liulv.work/2020/12/15/hadoop-install/">安装了Hadoop</a> 并且都已经启动</p>

<h2 id="32-拷贝数据到shared目录">3.2. 拷贝数据到shared目录</h2>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">cp</span><span class="w"> </span><span class="nv">$DRUID_HOME</span><span class="nx">/quickstart/tutorial/wikiticker-2015-09-12-sampled.json.gz</span><span class="w"> </span><span class="nx">/tmp/shared/wikiticker-2015-09-12-sampled.json.gz</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="33-设置hadoop目录">3.3. 设置Hadoop目录</h2>

<p>在Hadoop容器shell中，运行以下命令来设置本次教程需要的HDFS目录，同时拷贝输入数据到HDFS上</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nf">hdfs</span><span class="w"> </span><span class="nx">dfs</span><span class="w"> </span><span class="nt">-mkdir</span><span class="w"> </span><span class="nx">/druid</span><span class="w">
</span><span class="nf">hdfs</span><span class="w"> </span><span class="nx">dfs</span><span class="w"> </span><span class="nt">-mkdir</span><span class="w"> </span><span class="nx">/druid/segments</span><span class="w">
</span><span class="nf">hdfs</span><span class="w"> </span><span class="nx">dfs</span><span class="w"> </span><span class="nt">-mkdir</span><span class="w"> </span><span class="nx">/quickstart</span><span class="w">
</span><span class="nf">hdfs</span><span class="w"> </span><span class="nx">dfs</span><span class="w"> </span><span class="nt">-chmod</span><span class="w"> </span><span class="nx">777</span><span class="w"> </span><span class="nx">/druid</span><span class="w">
</span><span class="nf">hdfs</span><span class="w"> </span><span class="nx">dfs</span><span class="w"> </span><span class="nt">-chmod</span><span class="w"> </span><span class="nx">777</span><span class="w"> </span><span class="nx">/druid/segments</span><span class="w">
</span><span class="nf">hdfs</span><span class="w"> </span><span class="nx">dfs</span><span class="w"> </span><span class="nt">-chmod</span><span class="w"> </span><span class="nx">777</span><span class="w"> </span><span class="nx">/quickstart</span><span class="w">
</span><span class="nf">hdfs</span><span class="w"> </span><span class="nx">dfs</span><span class="w"> </span><span class="nt">-chmod</span><span class="w"> </span><span class="nt">-R</span><span class="w"> </span><span class="nx">777</span><span class="w"> </span><span class="nx">/tmp</span><span class="w">
</span><span class="nf">hdfs</span><span class="w"> </span><span class="nx">dfs</span><span class="w"> </span><span class="nt">-chmod</span><span class="w"> </span><span class="nt">-R</span><span class="w"> </span><span class="nx">777</span><span class="w"> </span><span class="nx">/user</span><span class="w">
</span><span class="nf">hdfs</span><span class="w"> </span><span class="nx">dfs</span><span class="w"> </span><span class="nt">-put</span><span class="w"> </span><span class="nx">/shared/wikiticker-2015-09-12-sampled.json.gz</span><span class="w"> </span><span class="nx">/quickstart/wikiticker-2015-09-12-sampled.json.gz</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="34-配置使用hadoop的druid">3.4. 配置使用Hadoop的Druid</h2>

<p>配置用于Hadoop批加载的Druid集群还需要额外的一些步骤。</p>

<p><strong>拷贝Hadoop配置到Druid classpath</strong></p>

<p>从Hadoop容器shell中，运行以下命令将Hadoop.xml配置文件拷贝到共享文件夹中</p>

<p>mkdir -p $DRUID_HOME/conf/druid/single-server/micro-quickstart/_common/hadoop-xml
cp $HADOOP_HOME/etc/hadoop/*.xml  $DRUID_HOME/conf/druid/single-server/micro-quickstart/_common/hadoop-xml</p>

<h2 id="35-更新druid段与日志的存储">3.5. 更新Druid段与日志的存储</h2>

<p>在常用的文本编辑器中，打开 $DRUID_HOME/conf/druid/single-server/micro-quickstart/_common/common.runtime.properties 文件做如下修改：</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c">#
# Deep storage
#
</span>
<span class="c"># For local disk (only viable in a cluster if this is a network mount):
#druid.storage.type=local
#druid.storage.storageDirectory=var/druid/segments
</span>
<span class="c"># For HDFS:
</span><span class="py">druid.storage.type</span><span class="p">=</span><span class="s">hdfs</span>
<span class="py">druid.storage.storageDirectory</span><span class="p">=</span><span class="s">/druid/segments</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c">#
# Indexing service logs
#
</span>
<span class="c"># For local disk (only viable in a cluster if this is a network mount):
#druid.indexer.logs.type=file
#druid.indexer.logs.directory=var/druid/indexing-logs
</span>
<span class="c"># For HDFS:
</span><span class="py">druid.indexer.logs.type</span><span class="p">=</span><span class="s">hdfs</span>
<span class="py">druid.indexer.logs.directory</span><span class="p">=</span><span class="s">/druid/indexing-logs</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="36-重启druid集群">3.6. 重启Druid集群</h2>

<p>Hadoop.xml文件拷贝到Druid集群、段和日志存储配置更新为HDFS后，Druid集群需要重启才可以让配置生效。</p>

<p>如果集群正在运行，CTRL-C 终止 bin/start-micro-quickstart脚本，重新执行它使得Druid服务恢复。</p>

<h2 id="加载批数据">加载批数据</h2>

<p>我们提供了2015年9月12日起对Wikipedia编辑的示例数据，以帮助您入门。</p>

<p>要将数据加载到Druid中，可以提交指向该文件的摄取任务。我们已经包含了一个任务，该任务会加载存档中包含 wikiticker-2015-09-12-sampled.json.gz文件。</p>

<p>通过以下命令进行提交 wikipedia-index-hadoop.json 任务：</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">bin/post-index-task</span><span class="w"> </span><span class="nt">--file</span><span class="w"> </span><span class="nv">$DRUID_HOME</span><span class="nx">/quickstart/tutorial/wikipedia-index-hadoop.json</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="4-查询数据">4. 查询数据</h1>

<p>本教程将以Druid SQL和Druid的原生查询格式的示例演示如何在Apache Druid中查询数据。</p>

<p>本教程假定您已经完成了摄取教程之一，因为我们将查询Wikipedia编辑样例数据。</p>

<p>Druid支持SQL查询。</p>

<p>该查询检索了2015年9月12日被编辑最多的10个维基百科页面</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">SELECT</span> <span class="n">page</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Edits</span>
<span class="k">FROM</span> <span class="n">wikipedia</span>
<span class="k">WHERE</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2015-09-12 00:00:00'</span> <span class="o">&lt;=</span> <span class="nv">"__time"</span> <span class="k">AND</span> <span class="nv">"__time"</span> <span class="o">&lt;</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2015-09-13 00:00:00'</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">page</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">Edits</span> <span class="k">DESC</span>
<span class="k">LIMIT</span> <span class="mi">10</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>让我们来看几种不同的查询方法</p>

<h2 id="41-通过控制台query查询">4.1. 通过控制台Query查询</h2>

<p><img src="https://liulv.work/images/img/20201209165417.png" alt="20201209165417" /></p>

<h2 id="42-通过dsql查询sql">4.2. 通过dsql查询SQL</h2>

<p>为方便起见，Druid软件包中包括了一个SQL命令行客户端，位于Druid根目录中的 bin/dsql</p>

<p>运行 bin/dsql, 可以看到如下：</p>

<p>Welcome to dsql, the command-line client for Druid SQL.
Type “\h” for help.
dsql&gt;</p>

<p><img src="https://liulv.work/images/img/20201209165626.png" alt="20201209165626" /></p>

<h2 id="43-通过http查询sql">4.3. 通过HTTP查询SQL</h2>

<p>SQL查询作为JSON通过HTTP提交</p>

<p>教程包括一个示例文件, 该文件quickstart/tutorial/wikipedia-top-pages-sql.json包含上面显示的SQL查询, 我们将该查询提交给Druid Broker。</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="err">curl -X 'POST' -H 'Content-Type:application/json' -d @quickstart/tutorial/wikipedia-top-pages-sql.json http://localhost:8888/druid/v2/sql
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="44-更多druid-sql示例">4.4. 更多Druid SQL示例</h2>

<h3 id="441-时间查询">4.4.1. 时间查询</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">SELECT</span> <span class="n">FLOOR</span><span class="p">(</span><span class="n">__time</span> <span class="k">to</span> <span class="n">HOUR</span><span class="p">)</span> <span class="k">AS</span> <span class="n">HourTime</span><span class="p">,</span> <span class="k">SUM</span><span class="p">(</span><span class="n">deleted</span><span class="p">)</span> <span class="k">AS</span> <span class="n">LinesDeleted</span>
<span class="k">FROM</span> <span class="n">wikipedia</span> <span class="k">WHERE</span> <span class="nv">"__time"</span> <span class="k">BETWEEN</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2015-09-12 00:00:00'</span> <span class="k">AND</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2015-09-13 00:00:00'</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://liulv.work/images/img/20201209165956.png" alt="20201209165956" /></p>

<h3 id="442-聚合查询">4.4.2. 聚合查询</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="k">SELECT</span> <span class="n">channel</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="k">SUM</span><span class="p">(</span><span class="n">added</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">wikipedia</span> <span class="k">WHERE</span> <span class="nv">"__time"</span> <span class="k">BETWEEN</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2015-09-12 00:00:00'</span> <span class="k">AND</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2015-09-13 00:00:00'</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">channel</span><span class="p">,</span> <span class="n">page</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">SUM</span><span class="p">(</span><span class="n">added</span><span class="p">)</span> <span class="k">DESC</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://liulv.work/images/img/20201209170146.png" alt="20201209170146" /></p>

<h3 id="443-查询原始数据">4.4.3. 查询原始数据</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">SELECT</span> <span class="k">user</span><span class="p">,</span> <span class="n">page</span>
<span class="k">FROM</span> <span class="n">wikipedia</span> <span class="k">WHERE</span> <span class="nv">"__time"</span> <span class="k">BETWEEN</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2015-09-12 02:00:00'</span> <span class="k">AND</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2015-09-12 03:00:00'</span>
<span class="k">LIMIT</span> <span class="mi">5</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://liulv.work/images/img/20201209172941.png" alt="20201209172941" /></p>

<h3 id="444-查看执行计划">4.4.4. 查看执行计划</h3>

<p>点击运行旁边… Explain SQL query</p>

<p><img src="https://liulv.work/images/img/20201209173045.png" alt="20201209173045" /></p>

<p><img src="https://liulv.work/images/img/20201209173114.png" alt="20201209173114" /></p>

<p>如果您以其他方式查询，则可以通过在Druid SQL查询之前添加 EXPLAIN PLAN FOR 来获得查询计划。</p>

<p>使用上边的一个示例：</p>

<p>EXPLAIN PLAN FOR SELECT page, COUNT(*) AS Edits FROM wikipedia WHERE “__time” BETWEEN TIMESTAMP ‘2015-09-12 00:00:00’ AND TIMESTAMP ‘2015-09-13 00:00:00’ GROUP BY page ORDER BY Edits DESC LIMIT 10;</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="n">dsql</span><span class="o">&gt;</span> <span class="k">EXPLAIN</span> <span class="n">PLAN</span> <span class="k">FOR</span> <span class="k">SELECT</span> <span class="n">page</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Edits</span> <span class="k">FROM</span> <span class="n">wikipedia</span> <span class="k">WHERE</span> <span class="nv">"__time"</span> <span class="k">BETWEEN</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2015-09-12 00:00:00'</span> <span class="k">AND</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2015-09-13 00:00:00'</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">page</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">Edits</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
<span class="err">┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐</span>
<span class="err">│</span> <span class="n">PLAN</span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <span class="err">│</span>
<span class="err">├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤</span>
<span class="err">│</span> <span class="n">DruidQueryRel</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="p">[</span><span class="err">{</span><span class="nv">"queryType"</span><span class="p">:</span><span class="nv">"topN"</span><span class="p">,</span><span class="nv">"dataSource"</span><span class="p">:</span><span class="err">{</span><span class="nv">"type"</span><span class="p">:</span><span class="nv">"table"</span><span class="p">,</span><span class="nv">"name"</span><span class="p">:</span><span class="nv">"wikipedia"</span><span class="err">}</span><span class="p">,</span><span class="nv">"virtualColumns"</span><span class="p">:[],</span><span class="nv">"dimension"</span><span class="p">:</span><span class="err">{</span><span class="nv">"type"</span><span class="p">:</span><span class="nv">"default"</span><span class="p">,</span><span class="nv">"dimension"</span><span class="p">:</span><span class="nv">"page"</span><span class="p">,</span><span class="nv">"outputName"</span><span class="p">:</span><span class="nv">"d0"</span><span class="p">,</span><span class="nv">"outputType"</span><span class="p">:</span><span class="nv">"STRING"</span><span class="err">}</span><span class="p">,</span><span class="nv">"metric"</span><span class="p">:</span><span class="err">{</span><span class="nv">"type"</span><span class="p">:</span><span class="nv">"numeric"</span><span class="p">,</span><span class="nv">"metric"</span><span class="p">:</span><span class="nv">"a0"</span><span class="err">}</span><span class="p">,</span><span class="nv">"threshold"</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="nv">"intervals"</span><span class="p">:</span><span class="err">{</span><span class="nv">"type"</span><span class="p">:</span><span class="nv">"intervals"</span><span class="p">,</span><span class="nv">"intervals"</span><span class="p">:[</span><span class="nv">"2015-09-12T00:00:00.000Z/2015-09-13T00:00:00.001Z"</span><span class="p">]</span><span class="err">}</span><span class="p">,</span><span class="nv">"filter"</span><span class="p">:</span><span class="k">null</span><span class="p">,</span><span class="nv">"granularity"</span><span class="p">:</span><span class="err">{</span><span class="nv">"type"</span><span class="p">:</span><span class="nv">"all"</span><span class="err">}</span><span class="p">,</span><span class="nv">"aggregations"</span><span class="p">:[</span><span class="err">{</span><span class="nv">"type"</span><span class="p">:</span><span class="nv">"count"</span><span class="p">,</span><span class="nv">"name"</span><span class="p">:</span><span class="nv">"a0"</span><span class="err">}</span><span class="p">],</span><span class="nv">"postAggregations"</span><span class="p">:[],</span><span class="nv">"context"</span><span class="p">:</span><span class="err">{}</span><span class="p">,</span><span class="nv">"descending"</span><span class="p">:</span><span class="k">false</span><span class="err">}</span><span class="p">],</span> <span class="n">signature</span><span class="o">=</span><span class="p">[</span><span class="err">{</span><span class="n">d0</span><span class="p">:</span><span class="n">STRING</span><span class="p">,</span> <span class="n">a0</span><span class="p">:</span><span class="n">LONG</span><span class="err">}</span><span class="p">])</span> <span class="err">│</span>
<span class="err">└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘</span>
<span class="n">Retrieved</span> <span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="mi">0</span><span class="p">.</span><span class="mi">03</span><span class="n">s</span><span class="p">.</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="5-特别注意1">5. 特别注意1</h1>

<p>Druid Hadoop Docker安装之前需要关闭SELinux</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>getenforce
</pre></td></tr></tbody></table></code></pre></div></div>

<p>返回
Enforcing</p>

<p>执行关闭SELinux</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>setenforce 0
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/SELINUX=enforcing/SELINUX=disabled/g'</span> /etc/selinux/config
</pre></td></tr></tbody></table></code></pre></div></div>

<p>检查SELinux</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>getenforce
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="6-roll-up聚合操作">6. Roll-up聚合操作</h1>

<p>Apache Druid可以通过roll-up在数据摄取阶段对原始数据进行汇总。 Roll-up是对选定列集的一级聚合操作，它可以减小存储数据的大小。</p>

<p>本教程中将讨论在一个示例数据集上进行roll-up的结果。</p>

<p>本教程我们假设您已经按照单服务器部署中描述下载了Druid，并运行在本地机器上。</p>

<p>完成加载本地文件和数据查询两部分内容也是非常有帮助的。</p>

<h2 id="61-数据准备">6.1. 数据准备</h2>

<p>使用一个网络流事件数据的小样本，表示在特定时间内从源到目标IP地址的流量的数据包和字节计数。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T01:01:35Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">9024</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T01:01:51Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">255</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">21133</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T01:01:59Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">5780</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T01:02:14Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">38</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">6289</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T01:02:29Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">377</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">359971</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T01:03:29Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">49</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">10204</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-02T21:33:14Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"7.7.7.7"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"8.8.8.8"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">38</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">6289</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-02T21:33:45Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"7.7.7.7"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"8.8.8.8"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">123</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">93999</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-02T21:35:45Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"7.7.7.7"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"8.8.8.8"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">2818</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>示例数据在Druid安装目录<code class="language-plaintext highlighter-rouge">quickstart/tutorial/rollup-data.json</code>下，我们将使用此接入数据规范来接入数据。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"spec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dataSchema"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"dataSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"rollup-tutorial"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"dimensionsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"dimensions"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"srcIP"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"dstIP"</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"timestampSpec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"column"</span><span class="p">:</span><span class="w"> </span><span class="s2">"timestamp"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"iso"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"metricsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"uniform"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"segmentGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"week"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"queryGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"minute"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"intervals"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"2018-01-01/2018-01-03"</span><span class="p">],</span><span class="w">
        </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"ioConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"inputSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"local"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"baseDir"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"quickstart/tutorial"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"filter"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"rollup-data.json"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"inputFormat"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"json"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"appendToExisting"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"tuningConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxRowsPerSegment"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">5000000</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxRowsInMemory"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">25000</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>通过在 granularitySpec 选项中设置 rollup : true 来启用Roll-up</p>

<p>注意，我们将srcIP和dstIP定义为维度，将packets和bytes列定义为了longSum类型的指标，并将 queryGranularity 配置定义为 minute。</p>

<p>加载这些数据后，我们将看到如何使用这些定义。</p>

<h2 id="62-加载数据">6.2. 加载数据</h2>

<p>在Druid的根目录下运行以下命令：</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">bin/post-index-task</span><span class="w"> </span><span class="nt">--file</span><span class="w"> </span><span class="nx">quickstart/tutorial/rollup-index.json</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>脚本运行完成以后，我们将查询数据。</p>

<p><img src="https://liulv.work/images/img/20201210145621.png" alt="20201210145621" /></p>

<h2 id="63-查询数据">6.3. 查询数据</h2>

<p>现在运行 bin/dsql 然后执行查询 select * from “rollup-tutorial”; 来查看已经被摄入的数据</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="kt">root</span><span class="err">@</span><span class="kt">localhost</span><span class="w"> </span><span class="kt">apache</span><span class="nt">-druid-0</span><span class="mf">.20.0</span><span class="p">]</span><span class="c"># bin/dsql</span><span class="w">
</span><span class="nf">Welcome</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">dsql</span><span class="p">,</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">command-line</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">Druid</span><span class="w"> </span><span class="nx">SQL.</span><span class="w">
</span><span class="nf">Connected</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="p">[</span><span class="kt">http</span><span class="p">:</span><span class="nf">//localhost:8082/</span><span class="p">]</span><span class="o">.</span><span class="w">

</span><span class="kt">Type</span><span class="w"> </span><span class="s2">"\h"</span><span class="w"> </span><span class="kt">for</span><span class="w"> </span><span class="no">help.</span><span class="w">
</span><span class="kt">dsql</span><span class="err">&gt;</span><span class="w"> </span><span class="kt">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kt">from</span><span class="w"> </span><span class="s2">"rollup-tutorial"</span><span class="p">;</span><span class="w">
</span><span class="err">┌──────────────────────────┬────────┬───────┬─────────┬─────────┬─────────┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="nf">__time</span><span class="w">                   </span><span class="err">│</span><span class="w"> </span><span class="nx">bytes</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">dstIP</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="nx">packets</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">srcIP</span><span class="w">   </span><span class="err">│</span><span class="w">
</span><span class="err">├──────────────────────────┼────────┼───────┼─────────┼─────────┼─────────┤</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="mi">2018</span><span class="nt">-01-01T01</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mf">00.000</span><span class="nf">Z</span><span class="w"> </span><span class="err">│</span><span class="w">  </span><span class="nx">35937</span><span class="w"> </span><span class="err">│</span><span class="w">     </span><span class="nx">3</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">2.2.2.2</span><span class="w"> </span><span class="err">│</span><span class="w">     </span><span class="nx">286</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">1.1.1.1</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="mi">2018</span><span class="nt">-01-01T01</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mf">00.000</span><span class="nf">Z</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">366260</span><span class="w"> </span><span class="err">│</span><span class="w">     </span><span class="nx">2</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">2.2.2.2</span><span class="w"> </span><span class="err">│</span><span class="w">     </span><span class="nx">415</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">1.1.1.1</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="mi">2018</span><span class="nt">-01-01T01</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mf">00.000</span><span class="nf">Z</span><span class="w"> </span><span class="err">│</span><span class="w">  </span><span class="nx">10204</span><span class="w"> </span><span class="err">│</span><span class="w">     </span><span class="nx">1</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">2.2.2.2</span><span class="w"> </span><span class="err">│</span><span class="w">      </span><span class="nx">49</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">1.1.1.1</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="mi">2018</span><span class="nt">-01-02T21</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">00.000</span><span class="nf">Z</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">100288</span><span class="w"> </span><span class="err">│</span><span class="w">     </span><span class="nx">2</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">8.8.8.8</span><span class="w"> </span><span class="err">│</span><span class="w">     </span><span class="nx">161</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">7.7.7.7</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="mi">2018</span><span class="nt">-01-02T21</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mf">00.000</span><span class="nf">Z</span><span class="w"> </span><span class="err">│</span><span class="w">   </span><span class="nx">2818</span><span class="w"> </span><span class="err">│</span><span class="w">     </span><span class="nx">1</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">8.8.8.8</span><span class="w"> </span><span class="err">│</span><span class="w">      </span><span class="nx">12</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">7.7.7.7</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">└──────────────────────────┴────────┴───────┴─────────┴─────────┴─────────┘</span><span class="w">
</span><span class="kt">Retrieved</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="kt">rows</span><span class="w"> </span><span class="kt">in</span><span class="w"> </span><span class="mf">0.18</span><span class="nf">s.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>我们来看发生在 2018-01-01T01:01 的三条原始数据：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T01:01:35Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">9024</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T01:01:51Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">255</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">21133</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T01:01:59Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">5780</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>这三条数据已经被roll up为以下一行数据：</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="err">┌──────────────────────────┬────────┬───────┬─────────┬─────────┬─────────┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="nf">__time</span><span class="w">                   </span><span class="err">│</span><span class="w"> </span><span class="nx">bytes</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">dstIP</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="nx">packets</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">srcIP</span><span class="w">   </span><span class="err">│</span><span class="w">
</span><span class="err">├──────────────────────────┼────────┼───────┼─────────┼─────────┼─────────┤</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="mi">2018</span><span class="nt">-01-01T01</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mf">00.000</span><span class="nf">Z</span><span class="w"> </span><span class="err">│</span><span class="w">  </span><span class="nx">35937</span><span class="w"> </span><span class="err">│</span><span class="w">     </span><span class="nx">3</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">2.2.2.2</span><span class="w"> </span><span class="err">│</span><span class="w">     </span><span class="nx">286</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="nx">1.1.1.1</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">└──────────────────────────┴────────┴───────┴─────────┴─────────┴─────────┘</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>这输入的数据行已经被按照时间列和维度列 {timestamp, srcIP, dstIP} 在指标列 {packages, bytes} 上做求和聚合.</p>

<p>在进行分组之前，原始输入数据的时间戳按分钟进行标记/布局，这是由于摄取规范中的 “queryGranularity”：”minute” 设置造成的。 同样，2018-01-01T01:02 期间发生的这两起事件也已经汇总。</p>

<h1 id="7-配置数据保留规则">7. 配置数据保留规则</h1>

<p>假设我们想删除2015年9月12日前12小时的数据，保留2015年9月12日后12小时的数据。</p>

<p>进入到Datasources视图，点击编辑按钮-然后再点击Edit retention rules</p>

<p><img src="https://liulv.work/images/img/20201210150714.png" alt="20201210150714" /></p>

<p>一个规则配置窗口出现了：</p>

<p><img src="https://liulv.work/images/img/20201210150821.png" alt="20201210150821" /></p>

<p>现在点击 + New rule 按钮两次</p>

<p>在上边的规则框中，选择 Load 和 by Interval 然后输入在 by Interval 旁边的输入框中输入 2015-09-12T12:00:00.000Z/2015-09-13T00:00:00.000Z, 副本可以选择保持2，在 _default_tier 中</p>

<p>在下边的规则框中，选择 Drop 和 forever</p>

<p>规则看上去是这样的：</p>

<p><img src="https://liulv.work/images/img/20201210151143.png" alt="20201210151143" /></p>

<p>现在点击 Next, 规则配置过程将要求提供用户名和注释，以便进行更改日志记录。您可以同时输入教程。</p>

<p>现在点击 Save, 可以在Datasources视图中看到新的规则</p>

<p><img src="https://liulv.work/images/img/20201210151757.png" alt="20201210151757" /></p>

<p>给集群几分钟时间应用规则更改，然后转到Druid控制台中的segments视图。2015年9月12日前12小时的段文件现已消失</p>

<p><img src="https://liulv.work/images/img/20201210151931.png" alt="20201210151931" /></p>

<p>生成的保留规则链如下:</p>

<p>loadByInterval 2015-09-12T12/2015-09-13 (12 hours)
dropForever
loadForever (默认规则)
规则链是自上而下计算的，默认规则链始终添加在底部</p>

<p>我们刚刚创建的教程规则链在指定的12小时间隔内加载数据</p>

<p>如果数据不在12小时的间隔内，则规则链下一步将计算 dropForever，这将删除任何数据</p>

<p>dropForever 终止了规则链，有效地覆盖了默认的 loadForever 规则，在这个规则链中永远不会到达该规则</p>

<p>注意，在本教程中，我们定义了一个特定间隔的加载规则</p>

<p>相反，如果希望根据数据的生命周期保留数据（例如，保留从过去3个月到现在3个月的数据），则应定义一个周期性加载规则</p>

<h1 id="8-数据更新">8. 数据更新</h1>

<p>本教程演示如何更新现有数据，同时展示覆盖(Overwrite)和追加(append)的两个方式。</p>

<h2 id="81-数据覆盖overwrite">8.1. 数据覆盖Overwrite</h2>

<h3 id="811-加载初始数据">8.1.1. 加载初始数据</h3>

<p>本节教程使用的任务摄取规范位于 quickstart/tutorial/updates-init-index.json, 本规范从 quickstart/tutorial/updates-data.json 输入文件创建一个名称为 updates-tutorial 的数据源</p>

<p>提交任务：</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">bin/post-index-task</span><span class="w"> </span><span class="nt">--file</span><span class="w"> </span><span class="nx">quickstart/tutorial/updates-init-index.json</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>我们有三个包含”动物”维度和”数字”指标的初始行：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="nv">"updates-tutorial"</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://liulv.work/images/img/20201210153051.png" alt="20201210153051" /></p>

<h3 id="812-将旧数据与新数据合并并覆盖">8.1.2. 将旧数据与新数据合并并覆盖</h3>

<p>现在我们尝试在 updates-tutorial 数据源追加一些新的数据，我们将从 quickstart/tutorial/updates-data3.json 增加新的数据</p>

<p>quickstart/tutorial/updates-append-index.json 任务规范配置为从现有的 updates-tutorial 数据源和 quickstart/tutorial/updates-data3.json 文件读取数据，该任务将组合来自两个输入源的数据，然后用新的组合数据覆盖原始数据。</p>

<p>提交任务：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">bin</span><span class="o">/</span><span class="n">post</span><span class="o">-</span><span class="k">index</span><span class="o">-</span><span class="n">task</span> <span class="c1">--file quickstart/tutorial/updates-append-index.json --url http://localhost:8081</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>查询合并后的数据</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="nv">"updates-tutorial"</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>当Druid完成从这个覆盖任务加载新段时，新行将被添加到数据源中。请注意，“Lion”行发生了roll up：</p>

<pre><code class="language-log">[root@localhost apache-druid-0.20.0]# bin/dsql

Welcome to dsql, the command-line client for Druid SQL.
Connected to [http://localhost:8082/].

Type "\h" for help.
dsql&gt; 
dsql&gt; 
dsql&gt; select * from "updates-tutorial";
┌──────────────────────────┬──────────┬───────┬────────┐
│ __time                   │ animal   │ count │ number │
├──────────────────────────┼──────────┼───────┼────────┤
│ 2018-01-01T01:01:00.000Z │ lion     │     1 │    300 │
│ 2018-01-01T01:01:00.000Z │ tiger    │     1 │    100 │
│ 2018-01-01T03:01:00.000Z │ aardvark │     1 │     42 │
│ 2018-01-01T03:01:00.000Z │ giraffe  │     1 │  14124 │
│ 2018-01-01T05:01:00.000Z │ mongoose │     1 │    737 │
│ 2018-01-01T06:01:00.000Z │ snake    │     1 │   1234 │
│ 2018-01-01T07:01:00.000Z │ octopus  │     1 │    115 │
└──────────────────────────┴──────────┴───────┴────────┘
Retrieved 7 rows in 0.13s.
</code></pre>

<h3 id="813-追加数据">8.1.3. 追加数据</h3>

<p>现在尝试另一种追加数据的方式</p>

<p>quickstart/tutorial/updates-append-index2.json 任务规范从 quickstart/tutorial/updates-data4.json 文件读取数据，然后追加到 updates-tutorial 数据源。注意到在规范中 appendToExisting 设置为 true</p>

<p>提交任务：</p>

<p>bin/post-index-task –file quickstart/tutorial/updates-append-index2.json –url http://localhost:8081</p>

<p>加载新数据后，我们可以看到”octopus”后面额外的两行。请注意，编号为222的新”bear”行尚未与现有的bear-111行合并，因为新数据保存在单独的段中。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="nv">"updates-tutorial"</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="9-合并段文件">9. 合并段文件</h1>

<p>因为每一个段都有一些内存和处理开销，所以有时减少段的总数是有益的，有关详细信息，请查阅段大小优化，所以需要合并段文件。</p>

<h2 id="91-加载初始化文件">9.1. 加载初始化文件</h2>

<p>我们将使用Wikipedia编辑数据，并使用创建每小时段的索引规范</p>

<p>这份规范位于 quickstart/tutorial/ompaction-init-index.json, 它将创建一个名称为 ompaction-tutorial 的数据源</p>

<p>现在加载这份初始数据：</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">bin/post-index-task</span><span class="w"> </span><span class="nt">--file</span><span class="w"> </span><span class="nx">quickstart/tutorial/compaction-init-index.json</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>![WARNING] 请注意，摄取规范中的 maxRowsPerSegment 设置为1000, 这是为了每小时生成多个段，不建议在生产中使用。默认为5000000，可能需要进行调整以优化您的段文件。</p>
</blockquote>

<p>提前数据完成后，可以到 http://localhost:8888/unified-console.html#datasources Druid控制台查看新的数据源。</p>

<p><img src="https://liulv.work/images/img/20201214151548.png" alt="20201214151548" /></p>

<p>查看Availability栏，点击对应的数据源的segment查看段</p>

<p><img src="https://liulv.work/images/img/20201214151916.png" alt="20201214151916" /></p>

<p>该数据源有51个段文件，输入数据每小时1-3个段</p>

<p><img src="https://liulv.work/images/img/20201214152009.png" alt="20201214152009" /></p>

<p>对该数据源执行一个 COUNT(*) 查询可以看到39244行数据：</p>

<p><img src="https://liulv.work/images/img/20201214152151.png" alt="20201214152151" /></p>

<h2 id="92-合并数据按小时">9.2. 合并数据（按小时）</h2>

<p>现在我们将合并这51个小的段，在 quickstart/tutorial/compaction-keep-granularity.json 文件中我们包含了一个本教程数据源的合并任务规范。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"compact"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"dataSource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"compaction-tutorial"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"interval"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-09-12/2015-09-13"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"tuningConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"maxRowsPerSegment"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">5000000</span><span class="p">,</span><span class="w">
    </span><span class="nl">"maxRowsInMemory"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">25000</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>该任务会合并 compaction-tutorial 数据源在 2015-09-12/2015-09-13 时间范围内的所有的段</p>

<p>tuningConfig 中的参数控制合并后的段文件集合中有多少个段。</p>

<p>在本教程示例中，每小时只创建一个合并段，因为每小时的行数少于5000000 maxRowsPerSegment（请注意，行总数为39244）。</p>

<p>现在提交这个任务：</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">bin/post-index-task</span><span class="w"> </span><span class="nt">--file</span><span class="w"> </span><span class="nx">quickstart/tutorial/compaction-keep-granularity.json</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>任务运行结束后，查看datasource,发现只有24个segments</p>

<p><img src="https://liulv.work/images/img/20201214152843.png" alt="20201214152843" /></p>

<p>刷新 Segments 视图, “Segments”视图应显示有24个分段，每小时一个：</p>

<p><img src="https://liulv.work/images/img/20201214152909.png" alt="20201214152909" /></p>

<h2 id="93-用新的段粒度合并数据按天">9.3. 用新的段粒度合并数据(按天)</h2>

<p>合并任务还可以生成不同于输入段粒度的合并段</p>

<p>我们在 quickstart/tutorial/compaction-day-granularity.json 文件中包含了一个可以创建 DAY 粒度的合并任务摄取规范：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"compact"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"dataSource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"compaction-tutorial"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"interval"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-09-12/2015-09-13"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"segmentGranularity"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DAY"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"tuningConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"maxRowsPerSegment"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">5000000</span><span class="p">,</span><span class="w">
    </span><span class="nl">"maxRowsInMemory"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">25000</span><span class="p">,</span><span class="w">
    </span><span class="nl">"forceExtendableShardSpecs"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>请注意这个合并任务规范中 segmentGranularity 配置项设置为了 DAY, 现在提交这个任务：</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">bin/post-index-task</span><span class="w"> </span><span class="nt">--file</span><span class="w"> </span><span class="nx">quickstart/tutorial/compaction-day-granularity.json</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>Coordinator将旧的输入段标记为未使用需要一段时间，因此您可能会看到总共有25个段的中间状态。最终，只有一个天粒度的段</p>

<p><img src="https://liulv.work/images/img/20201214154047.png" alt="20201214154047" /></p>

<h1 id="10-数据删除">10. 数据删除</h1>

<h2 id="101-加载初始数据">10.1. 加载初始数据</h2>

<p>我们将使用Wikipedia编辑数据，并使用创建每小时段的索引规范, 这份规范位于 quickstart/tutorial/deletion-index.json, 它将创建一个名称为 deletion-tutorial 的数据源</p>

<p>现在加载这份初始数据：</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">bin/post-index-task</span><span class="w"> </span><span class="nt">--file</span><span class="w"> </span><span class="nx">quickstart/tutorial/deletion-index.json</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>当加载完成后，在浏览器中访问http://localhost:8888/unified-console.html#datasources</p>

<p><img src="https://liulv.work/images/img/20201214154326.png" alt="20201214154326" /></p>

<h2 id="102-如何永久删除数据">10.2. 如何永久删除数据</h2>

<p>永久删除一个段需要两步：</p>

<ol>
  <li>段必须首先标记为”未使用”。当用户通过Coordinator API手动禁用段时，就会发生这种情况</li>
  <li>在段被标记为”未使用”之后，一个Kill任务将从Druid的元数据存储和深层存储中删除任何“未使用”的段</li>
</ol>

<p>现在让我们通过使用Coordinator API按时间间隔和段id删除一些段。</p>

<h2 id="103-通过时间间隔禁用段">10.3. 通过时间间隔禁用段</h2>

<p>让我们在指定的时间间隔内禁用段。这会将间隔中的所有段标记为”未使用”，但不会将它们从深层存储中移除。让我们禁用间隔 2015-09-12T18:00:00.000Z/2015-09-12T20:00:00.000Z中的段，即在18到20小时之间</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">curl</span><span class="w"> </span><span class="nt">-X</span><span class="w"> </span><span class="s1">'POST'</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="s1">'Content-Type:application/json'</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="s1">'{ "interval" : "2015-09-12T18:00:00.000Z/2015-09-12T20:00:00.000Z" }'</span><span class="w"> </span><span class="nx">http://localhost:8081/druid/coordinator/v1/datasources/deletion-tutorial/markUnused</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>该命令完成后，您应该看到第18和19小时的段已被禁用：</p>

<p><img src="https://liulv.work/images/img/20201214154809.png" alt="20201214154809" /></p>

<p>请注意，第18小时和第19小时的数据段仍在深层存储中命令:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">ls</span><span class="w"> </span><span class="nt">-l1</span><span class="w"> </span><span class="nx">var/druid/segments/deletion-tutorial/</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://liulv.work/images/img/20201214154902.png" alt="20201214154902" /></p>

<h2 id="104-通过段id禁用段">10.4. 通过段ID禁用段</h2>

<p>让我们按段id禁用一些段。这将再次将段标记为“未使用”，但不会将它们从深层存储中移除。您可以从UI中看到完整的段id，如下所述。</p>

<p>在”Segments”视图中，单击…操作按钮进入View SQL query for table</p>

<p><img src="https://liulv.work/images/img/20201214155933.png" alt="20201214155933" /></p>

<p>查询结果页拉伸segment_id</p>

<p><img src="https://liulv.work/images/img/1607932812(1).png" alt="1607932812(1)" /></p>

<p><img src="https://liulv.work/images/img/1607932900(1).png" alt="1607932900(1)" /></p>

<p>信息框的顶部显示完整的段ID，例如 deletion-tutorial_2015-09-12T14:00:00.000Z_2015-09-12T15:00:00.000Z_2019-02-28T01:11:51.606Z，第14小时的段。</p>

<p>让我们向Coordinator发送一个POST请求来禁用13点和14点的段</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"segmentIds"</span><span class="p">:</span><span class="w">
  </span><span class="p">[</span><span class="w">
    </span><span class="s2">"deletion-tutorial_2015-09-12T13:00:00.000Z_2015-09-12T14:00:00.000Z_2019-05-01T17:38:46.961Z"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"deletion-tutorial_2015-09-12T14:00:00.000Z_2015-09-12T15:00:00.000Z_2019-05-01T17:38:46.961Z"</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>json文件位于quickstart/tutorial/deletion-disable-segments.json, 如下向Coordinator提交一个POST请求：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="s1">'POST'</span> <span class="o">-</span><span class="n">H</span> <span class="s1">'Content-Type:application/json'</span> <span class="o">-</span><span class="n">d</span> <span class="o">@</span><span class="n">quickstart</span><span class="o">/</span><span class="n">tutorial</span><span class="o">/</span><span class="n">deletion</span><span class="o">-</span><span class="n">disable</span><span class="o">-</span><span class="n">segments</span><span class="p">.</span><span class="n">json</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8081</span><span class="o">/</span><span class="n">druid</span><span class="o">/</span><span class="n">coordinator</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">datasources</span><span class="o">/</span><span class="n">deletion</span><span class="o">-</span><span class="n">tutorial</span><span class="o">/</span><span class="n">markUnused</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://liulv.work/images/img/1607933017(1).png" alt="1607933017(1)" /></p>

<p>命令执行完成后，可以看到13时和14时的段已经被禁用：</p>

<p><strong>但是 但是， 我这里执行禁用不了</strong></p>

<h2 id="105-运行kill任务">10.5. 运行Kill任务</h2>

<p>现在我们已经禁用了一些段，我们可以提交一个Kill任务，它将从元数据和深层存储中删除禁用的段。</p>

<p>在 quickstart/tutorial/deletion-kill.json 提供了一个Kill任务的规范</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kill"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"dataSource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"deletion-tutorial"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"interval"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-09-12/2015-09-13"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>通过以下的命令将任务提交到Overlord：</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">curl</span><span class="w"> </span><span class="nt">-X</span><span class="w"> </span><span class="s1">'POST'</span><span class="w"> </span><span class="nt">-H</span><span class="w"> </span><span class="s1">'Content-Type:application/json'</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="err">@</span><span class="nx">quickstart/tutorial/deletion-kill.json</span><span class="w"> </span><span class="nx">http://localhost:8081/druid/indexer/v1/task</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>任务执行完成后，可以看到已经禁用的段已经被从深度存储中移除了：</p>

<p><img src="https://liulv.work/images/img/1607933796(1).png" alt="1607933796(1)" /></p>

<h1 id="11-数据接入的规范">11. 数据接入的规范</h1>

<p>本章节将指导读者定义摄取规范的过程，指出关键的注意事项和指导原则。</p>

<h2 id="111-示例数据">11.1. 示例数据</h2>

<p>假设我们有如下的网络流数据：</p>

<ul>
  <li>srcIP: 发送端的IP地址</li>
  <li>srcPort: 发送端的端口</li>
  <li>dstIP: 接收端的IP地址</li>
  <li>dstPort: 接收端的端口</li>
  <li>protocol: IP协议号码</li>
  <li>packets: 传输的数据包数</li>
  <li>bytes: 传输的字节数</li>
  <li>cost: 发送流量的成本</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T01:01:35Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">2000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">3000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.4</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T01:01:51Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">2000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">3000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">2000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">3.1</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T01:01:59Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">2000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">3000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">3000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.4</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T01:02:14Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">7000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">4000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">7.9</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T01:02:29Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">7000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">10.2</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T01:03:29Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">7000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">6000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">4.3</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T02:33:14Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"7.7.7.7"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"8.8.8.8"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">4000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">17</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">10000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">22.4</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T02:33:45Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"7.7.7.7"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"8.8.8.8"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">4000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">17</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">20000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">34.5</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T02:35:45Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"7.7.7.7"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"8.8.8.8"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">4000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">17</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">300</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">30000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">46.3</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>将上面的JSON内容保存到 quickstart/ 中名为insertion-tutorial-data.json 的文件中。</p>

<p>让我们来了解一下定义可加载此数据的摄取规范的过程。</p>

<p>对于本教程，我们将使用本地批索引任务。使用其他任务类型时，摄取规范的某些方面会有所不同，本教程将指出这些方面。</p>

<h2 id="112-定义schema">11.2. 定义schema</h2>

<p>Druid摄取规范中最核心的元素是 dataSchema。 dataSchema 定义了如何将输入数据解析为一组列，这些列将存储在Druid中。</p>

<p>让我们从一个空的 dataSchema 开始，并在完成教程的过程中向它添加字段。</p>

<p>在 quickstart/ 中创建一个名为 insertion-tutorial-index.json 的新文件，其中包含以下内容：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nl">"dataSchema"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="1121-数据源名称">11.2.1. 数据源名称</h3>

<p>数据源的名称通过 dataSource 字段来在 dataSchema 中被指定：</p>

<p>“dataSchema” : {
  “dataSource” : “ingestion-tutorial”,
}</p>

<h3 id="1122-时间列">11.2.2. 时间列</h3>

<p>dataSchema 需要知道如何从输入数据中提取主时间戳字段。</p>

<p>输入数据中的timestamp列名为”ts”，包含ISO 8601时间戳，因此让我们将包含该信息的 timestampSpec 添加到 dataSchema：</p>

<p>“dataSchema” : {
  “dataSource” : “ingestion-tutorial”,
  “timestampSpec” : {
    “format” : “iso”,
    “column” : “ts”
  }
}</p>

<h2 id="113-rollup">11.3. Rollup</h2>
<p>在接收数据时，我们必须考虑是否要使用rollup</p>

<ul>
  <li>如果启用了rollup，我们需要将输入列分为两类，”dimensions”和”metrics”。”dimensions” 是用于rollup的分组列，”metrics”是将要聚合的列。</li>
  <li>如果禁用了rollup，则所有列都被视为”dimensions”，并且不会发生预聚合。</li>
</ul>

<p>对于本教程，让我们启用rollup。这是用 dataSchema 上granularitySpec 指定的。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>综合</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="err">'</span><span class="nl">"dataSchema"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"dataSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ingestion-tutorial"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timestampSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"format"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"iso"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"column"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ts"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="1131-选择dimension和metrics">11.3.1. 选择dimension和Metrics</h3>

<p>对于这个示例数据集，以下是对”dimensions”和”metrics”的合理划分：</p>

<ul>
  <li>Dimensions: srcIP, srcPort, dstIP, dstPort, protocol</li>
  <li>Metrics: packets, bytes, cost</li>
</ul>

<p>这里的维度是一组属性，用于标识IP流量的单向流，而度量则表示由维度分组指定的IP流量的事实。</p>

<p>让我们看看如何在摄取规范中定义这些维度和度量。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="nl">"dimensionsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dimensions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"srcIP"</span><span class="p">,</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"srcPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstIP"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"protocol"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="err">,</span><span class="w">
  </span><span class="nl">"metricsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"doubleSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cost"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cost"</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="err">,</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>每个维度都有一个 名称 和一个 类型，其中 类型 可以是”long”、”float”、”double”或”string”。</p>

<p>注意，srcIP 是一个”string”维度；对于string维度，只需指定一个维度名称就足够了，因为”string”是默认的维度类型。</p>

<p>还要注意，protocol 是输入数据中的一个数值，但我们将其作为”string”列摄取；Druid将在摄取期间将输入long强制为string。</p>

<p>定义Metrics时，需要指定在rollup期间对该列执行何种类型的聚合</p>

<p>在这里，我们在两个Long类型的Metrics列（数据包和字节）上定义了longSum聚合，并为cost列定义了一个doubleSum聚合</p>

<p>注意，metricsSpec 与 dimensionSpec 或 parseSpec 位于不同的嵌套级别；它与 dataSchema 中的 parser 属于相同的嵌套级别</p>

<p>注意，我们还定义了一个 count 聚合器。计数聚合器将跟踪原始输入数据中有多少行贡献给最终接收数据中的”roll up”行。</p>

<p>综合</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="nl">"dataSchema"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"dataSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ingestion-tutorial"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timestampSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"format"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"iso"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"column"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ts"</span><span class="w">
  </span><span class="p">},</span><span class="w">
    </span><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"dimensionsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dimensions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"srcIP"</span><span class="p">,</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"srcPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstIP"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"protocol"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"metricsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"doubleSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cost"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cost"</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">

</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="114-no-rollup">11.4. No Rollup</h2>

<p>如果我们没使用rollup，所有的列都将在 dimensionsSpec 中指定：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="w">   </span><span class="nl">"dimensionsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"dimensions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"srcIP"</span><span class="p">,</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"srcPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstIP"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"protocol"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"srcPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"double"</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="err">,</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>综合</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="nl">"dataSchema"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"dataSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ingestion-tutorial"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timestampSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"format"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"iso"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"column"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ts"</span><span class="w">
  </span><span class="p">},</span><span class="w">
    </span><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"dimensionsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dimensions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"srcIP"</span><span class="p">,</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"srcPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstIP"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"protocol"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"srcPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"double"</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="115-定义粒度">11.5. 定义粒度</h2>

<p>在这一点上，我们已经在 dataSchema 中定义了 parser 和metricsSpec，并且我们几乎已经完成了摄取规范的编写</p>

<p>我们需要在 granularitySpec 中设置一些属性：</p>

<ul>
  <li>granularitySpec类型：uniform 和 arbitrary 是两种支持的类型。在本教程中，我们将使用 uniform 粒度规范，其中所有段都具有统一的间隔（例如：所有段都包含一小时的数据）</li>
  <li>段粒度：单个段中包含的数据的时间间隔大小？例如：DAY, WEEK</li>
  <li>时间列中时间戳的bucketing粒度（称为queryGranularity)</li>
</ul>

<h3 id="1151-段粒度">11.5.1. 段粒度</h3>

<p>段粒度由 granularitySpec 中的 SegmentGranularity 属性配置。对于本教程，我们将创建小时段：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"uniform"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"segmentGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"HOUR"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>我们的输入数据有两个独立小时的事件，因此此任务将生成两个段。</p>

<h3 id="1152-查询粒度">11.5.2. 查询粒度</h3>

<p>查询粒度由 granularitySpec 中的 queryGranularity 属性配置。对于本教程，我们使用分钟粒度:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"uniform"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"segmentGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"HOUR"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"queryGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"MINUTE"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>要查看查询粒度的影响，让我们从原始输入数据中查看这一行:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T01:03:29Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">7000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">6000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">4.3</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>当这一行以分钟查询粒度摄取时，Druid会将该行的时间戳设置为分钟桶：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="nl">"ts"</span><span class="p">:</span><span class="s2">"2018-01-01T01:03:00Z"</span><span class="p">,</span><span class="nl">"srcIP"</span><span class="p">:</span><span class="s2">"1.1.1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstIP"</span><span class="p">:</span><span class="s2">"2.2.2.2"</span><span class="p">,</span><span class="w"> </span><span class="nl">"srcPort"</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nl">"dstPort"</span><span class="p">:</span><span class="mi">7000</span><span class="p">,</span><span class="w"> </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="nl">"packets"</span><span class="p">:</span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="nl">"bytes"</span><span class="p">:</span><span class="mi">6000</span><span class="p">,</span><span class="w"> </span><span class="nl">"cost"</span><span class="p">:</span><span class="w"> </span><span class="mf">4.3</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="1153-定义时间间隔batch-only">11.5.3. 定义时间间隔（batch only）</h3>

<p>对于批处理任务，需要定义时间间隔。时间戳超出时间间隔的输入行将不会被接收。</p>

<p>时间间隔指定在 granularitySpec 配置项中intervals的配置时间范围：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"uniform"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"segmentGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"HOUR"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"queryGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"MINUTE"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"intervals"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"2018-01-01/2018-01-02"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>综合</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="nl">"dataSchema"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"dataSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ingestion-tutorial"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timestampSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"format"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"iso"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"column"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ts"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"dimensionsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dimensions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"srcIP"</span><span class="p">,</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"srcPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstIP"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"protocol"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"metricsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"doubleSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cost"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cost"</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"uniform"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"segmentGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"HOUR"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"queryGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"MINUTE"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"intervals"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"2018-01-01/2018-01-02"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="116-定义任务类型">11.6. 定义任务类型</h2>

<p>我们现在已经完成了 dataSchema 的定义。剩下的步骤是将我们创建的数据模式放入一个摄取任务规范中，并指定输入源。</p>

<p>dataSchema 在所有任务类型之间共享，但每个任务类型都有自己的规范格式。对于本教程，我们将使用本机批处理摄取任务type类型定义为：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"spec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dataSchema"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="err">....</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="117-定义输入源">11.7. 定义输入源</h2>

<p>现在让我们定义输入源，它在 ioConfig 对象中指定。每个任务类型都有自己的 ioConfig 类型。要读取输入数据，我们需要指定一个inputSource。我们前面保存的示例网络流数据需要从本地文件中读取，该文件配置如下：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="nl">"ioConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"inputSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"local"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"baseDir"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"quickstart/"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"filter"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ingestion-tutorial-data.json"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="118-定义数据格式">11.8. 定义数据格式</h2>

<p>定义数据格式也是在 ioConfig 对象中指定，因为我们的输入数据为JSON字符串，我们使用json的 inputFormat:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="w"> </span><span class="nl">"ioConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"inputFormat"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"json"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>综合：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"spec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dataSchema"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"dataSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ingestion-tutorial"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"timestampSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"format"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"iso"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"column"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ts"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"dimensionsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"dimensions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"srcIP"</span><span class="p">,</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"srcPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstIP"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"protocol"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"metricsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"doubleSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cost"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cost"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"uniform"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"segmentGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"HOUR"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"queryGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"MINUTE"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"intervals"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"2018-01-01/2018-01-02"</span><span class="p">],</span><span class="w">
        </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"ioConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"inputSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"local"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"baseDir"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"quickstart/"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"filter"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ingestion-tutorial-data.json"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"inputFormat"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"json"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="119-额外的调整">11.9. 额外的调整</h2>

<p>每一个摄入任务都有一个 tuningConfig 部分，该部分允许用户可以调整不同的摄入参数</p>

<p>例如，我们添加一个 tuningConfig，它为本地批处理摄取任务设置目标段大小：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nl">"tuningConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"maxRowsPerSegment"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">5000000</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>注意：每一类摄入任务都有自己的 tuningConfig 类型</p>

<h2 id="1110-最终形成的规范">11.10. 最终形成的规范</h2>

<p>我们已经定义了摄取规范，现在应该如下所示：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"spec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dataSchema"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"dataSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ingestion-tutorial"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"timestampSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"format"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"iso"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"column"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ts"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"dimensionsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"dimensions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"srcIP"</span><span class="p">,</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"srcPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstIP"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"dstPort"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"protocol"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"metricsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"packets"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"bytes"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"doubleSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cost"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cost"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"uniform"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"segmentGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"HOUR"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"queryGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"MINUTE"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"intervals"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"2018-01-01/2018-01-02"</span><span class="p">],</span><span class="w">
        </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"ioConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"inputSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"local"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"baseDir"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"quickstart/"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"filter"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ingestion-tutorial-data.json"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"inputFormat"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"json"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"tuningConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxRowsPerSegment"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">5000000</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="1111-提交任务和查询数据">11.11. 提交任务和查询数据</h2>

<p>在Druid根目录下执行下面命令：</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">bin/post-index-task</span><span class="w"> </span><span class="nt">--file</span><span class="w"> </span><span class="nx">quickstart/ingestion-tutorial-index.json</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>脚本运行完成后我们可以查询数据。</p>

<p>运行 bin/dsql 中运行 select * from “ingestion-tutorial” 查询我们摄入什么样的数据</p>

<p><img src="https://liulv.work/images/img/20201215115911.png" alt="20201215115911" /></p>

<h1 id="12-输入数据变换">12. 输入数据变换</h1>

<p>本章节将介绍如何使用转换规范在接收期间过滤和转换输入数据。</p>

<h2 id="121-样例数据">12.1. 样例数据</h2>

<p>我们在 quickstart/tutorial/transform-data.json 中包括了样例数据，为了方便我们展示一下：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T07:01:35Z"</span><span class="p">,</span><span class="nl">"animal"</span><span class="p">:</span><span class="s2">"octopus"</span><span class="p">,</span><span class="w">  </span><span class="nl">"location"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nl">"number"</span><span class="p">:</span><span class="mi">100</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T05:01:35Z"</span><span class="p">,</span><span class="nl">"animal"</span><span class="p">:</span><span class="s2">"mongoose"</span><span class="p">,</span><span class="w"> </span><span class="nl">"location"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nl">"number"</span><span class="p">:</span><span class="mi">200</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T06:01:35Z"</span><span class="p">,</span><span class="nl">"animal"</span><span class="p">:</span><span class="s2">"snake"</span><span class="p">,</span><span class="w"> </span><span class="nl">"location"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nl">"number"</span><span class="p">:</span><span class="mi">300</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="s2">"2018-01-01T01:01:35Z"</span><span class="p">,</span><span class="nl">"animal"</span><span class="p">:</span><span class="s2">"lion"</span><span class="p">,</span><span class="w"> </span><span class="nl">"location"</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nl">"number"</span><span class="p">:</span><span class="mi">300</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="122-使用转换规范加载数据">12.2. 使用转换规范加载数据</h2>

<p>在转换规范中，我们有两个表达式转换：</p>

<ul>
  <li>super-animal: 在 “animal” 列的值前加上”super-“。这将用转换后的版本覆盖 animal 列，因为转换的名称是 animal</li>
  <li>triple-number: 将数字列乘以3, 这将创建一个新的三位数列。注意，我们同时接收原始列和转换列</li>
</ul>

<p>另外，我们有一个包含三个子句的OR过滤器：</p>

<ul>
  <li>super-animal 值匹配”super-mongoose”</li>
  <li>triple-number 值匹配300</li>
  <li>location值匹配3</li>
</ul>

<p>这个过滤器选择前3行，它将排除输入数据中的最后一个”lion”行。请注意，过滤器是在转换之后应用的。这个在spec - dataSchema -transformSpec 节点下配置，如下：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="nl">"transformSpec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"transforms"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"expression"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"animal"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"expression"</span><span class="p">:</span><span class="w"> </span><span class="s2">"concat('super-', animal)"</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"expression"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"triple-number"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"expression"</span><span class="p">:</span><span class="w"> </span><span class="s2">"number * 3"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"filter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"or"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"selector"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dimension"</span><span class="p">:</span><span class="w"> </span><span class="s2">"animal"</span><span class="p">,</span><span class="w"> </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"super-mongoose"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"selector"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dimension"</span><span class="p">:</span><span class="w"> </span><span class="s2">"triple-number"</span><span class="p">,</span><span class="w"> </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"300"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"selector"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dimension"</span><span class="p">:</span><span class="w"> </span><span class="s2">"location"</span><span class="p">,</span><span class="w"> </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3"</span><span class="w"> </span><span class="p">}</span><span class="w">
          </span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>完整</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"spec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dataSchema"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"dataSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"transform-tutorial"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"timestampSpec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"column"</span><span class="p">:</span><span class="w"> </span><span class="s2">"timestamp"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"iso"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"dimensionsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"dimensions"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"animal"</span><span class="p">,</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"location"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"metricsSpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"number"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"number"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"longSum"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"triple-number"</span><span class="p">,</span><span class="w"> </span><span class="nl">"fieldName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"triple-number"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"granularitySpec"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"uniform"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"segmentGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"week"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"queryGranularity"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"minute"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"intervals"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"2018-01-01/2018-01-03"</span><span class="p">],</span><span class="w">
        </span><span class="nl">"rollup"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"transformSpec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"transforms"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"expression"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"animal"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"expression"</span><span class="p">:</span><span class="w"> </span><span class="s2">"concat('super-', animal)"</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"expression"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"triple-number"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"expression"</span><span class="p">:</span><span class="w"> </span><span class="s2">"number * 3"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"filter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"or"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"selector"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dimension"</span><span class="p">:</span><span class="w"> </span><span class="s2">"animal"</span><span class="p">,</span><span class="w"> </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"super-mongoose"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"selector"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dimension"</span><span class="p">:</span><span class="w"> </span><span class="s2">"triple-number"</span><span class="p">,</span><span class="w"> </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"300"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"selector"</span><span class="p">,</span><span class="w"> </span><span class="nl">"dimension"</span><span class="p">:</span><span class="w"> </span><span class="s2">"location"</span><span class="p">,</span><span class="w"> </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3"</span><span class="w"> </span><span class="p">}</span><span class="w">
          </span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"ioConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"inputSource"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"local"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"baseDir"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"quickstart/tutorial"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"filter"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"transform-data.json"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"inputFormat"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="s2">"json"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"appendToExisting"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"tuningConfig"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"index_parallel"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxRowsPerSegment"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">5000000</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxRowsInMemory"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">25000</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="123-提交任务">12.3. 提交任务</h2>

<p>现在提交位于 quickstart/tutorial/transform-index.json 的任务：</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">bin/post-index-task</span><span class="w"> </span><span class="nt">--file</span><span class="w"> </span><span class="nx">quickstart/tutorial/transform-index.json</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="124-查询已转换的数据">12.4. 查询已转换的数据</h2>

<p>运行 bin/dsql 提交 select * from “transform-tutorial” 查询来看摄入的数据：</p>

<p><img src="https://liulv.work/images/img/20201215161618.png" alt="20201215161618" /></p>

<h1 id="13-架构设计">13. 架构设计</h1>

<p>Druid有一个多进程、分布式的架构，该架构设计为云友好且易于操作。每个Druid进程都可以独立配置和扩展，在集群上提供最大的灵活性。这种设计还提供了增强的容错能力：一个组件的中断不会立即影响其他组件。</p>

<h2 id="131-进程与服务">13.1. 进程与服务</h2>

<p>Druid有若干不同类型的进程，简单描述如下：</p>

<ul>
  <li><a href="#">Coordinator</a> 进程管理集群中数据的可用性</li>
  <li><a href="#">Overlord</a> 进程控制数据摄取负载的分配</li>
  <li><a href="#">Broker</a> 进程处理来自外部客户端的查询请求</li>
  <li><a href="#">Router</a> 进程是一个可选进程，可以将请求路由到Brokers、Coordinators和Overlords</li>
  <li><a href="#">Historical</a> 进程存储可查询的数据</li>
  <li><a href="#">MiddleManager</a> 进程负责摄取数据</li>
</ul>

<p>Druid进程可以按照您喜欢的方式部署，但是为了便于部署，我们建议将它们组织成三种服务器类型：Master、Query和Data。</p>

<ul>
  <li><strong>Master</strong>: 运行Coordinator和Overlord进程，管理数据可用性和摄取</li>
  <li><strong>Query:</strong> 运行Broker和可选的Router进程，处理来自外部客户端的请求</li>
  <li><strong>Data:</strong> 运行Historical和MiddleManager进程，执行摄取负载和存储所有可查询的数据</li>
</ul>

<p>关于进程和服务组织的更多信息，可以查看Druid<a href="#">进程与服务</a></p>

<h2 id="132-外部依赖">13.2. 外部依赖</h2>

<p>除了内置的进程类型外，Druid同时有三个外部依赖，它们旨在利用现有的基础设施（如果有的话）。</p>

<h2 id="133-深度存储">13.3. 深度存储</h2>

<p>每个Druid服务器都可以访问的共享文件存储。在集群部署中，通常使用一个像S3或HDFS这样的分布式对象存储，或者是一个网络挂载的文件系统。在单服务器部署中，通常使用本地磁盘。Druid使用深度存储来存储任何已被系统接收的数据。</p>

<p>Druid只使用深度存储作为数据备份，并作为在后台Druid进程之间传输数据的一种方式。为了响应查询，Historical进程不会从深层存储中读取数据，而是从本地磁盘读取在执行任何查询之前预缓存的段，这意味着Druid在查询期间不需要访问深层存储，这有助于它提供尽可能最好的查询延迟。这也意味着您必须在深层存储和所有Historical进程中都有足够的磁盘空间来存储计划加载的数据。</p>

<p>深度存储是Druid弹性、容错设计的重要组成部分。即使每个数据服务器都丢失并重新配置，Druid也可以从深层存储启动。</p>

<p>有关更多详细信息，请参见深度存储</p>

<h2 id="134-元数据存储">13.4. 元数据存储</h2>

<p>元数据存储包含各种共享的系统元数据，如段可用性信息和任务信息。在集群部署中，通常使用像PostgreSQL或MySQL这样的传统RDBMS。在单服务器部署中，通常使用本地存储的Apache Derby数据库。</p>

<p>有关更多详细信息，请参见元数据存储.</p>

<h2 id="135-zookeeper">13.5. Zookeeper</h2>

<p>用于内部服务发现、协调和领导选举。</p>

<p>有关更多详细信息，请参见Zookeeper</p>

<h2 id="136-架构图">13.6. 架构图</h2>

<p>下图显示了使用建议的Master/Query/Data服务组织，查询和数据如何通过此体系结构流动：</p>

<p><img src="https://liulv.work/images/img/20201215180836.png" alt="20201215180836" /></p>

<h2 id="137-存储设计">13.7. 存储设计</h2>

<p><strong>数据源和段</strong></p>

<p>Druid数据被存储在”datasources”中，类似于传统RDBMS中的表。每一个数据源可以根据时间进行分区，可选地还可以进一步根据其他属性进行分区。每一个时间范围称为一个”块（chunk）”(例如，如果数据源按天分区，则为一天)。在一个块中，数据被分为一个或者多个”段（segments）”。每个段是一个单独的文件，一般情况下由数百万条数据组成。由于段被组织成时间块，因此有时将段视为存在于如下时间线上是有帮助的：</p>

<p><img src="https://liulv.work/images/img/20201215181028.png" alt="20201215181028" /></p>

<p>一个数据源可能有几个段到几十万甚至几百万个段。每个段都是在MiddleManager上创建的，但此时段是可变的和未提交的。段构建过程包括以下步骤，旨在生成一个紧凑且支持快速查询的数据文件：</p>

<ul>
  <li>转换为列格式</li>
  <li>构建位图索引</li>
  <li>使用不同的算法进行压缩
    <ul>
      <li>字符串列id存储最小化的字典编码</li>
      <li>对位图索引做压缩</li>
      <li>所有列的类型感知压缩</li>
    </ul>
  </li>
</ul>

:ET