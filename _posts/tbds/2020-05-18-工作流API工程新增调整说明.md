---
title: 工作流 API 工程 DEMO 新增调整说明
tags: TBDS
---

## 新增调整概述

主要针对新增的工作流和现场环境进行调整，以下满足现状的情况，并开发对应测试类，主要有以下调整来满足现状：

- [x] 内网 Maven 缺包问题
- [x] 新增获取工作流任务实例列表接口
- [x] 新增获取工作流任务实例日志列表接口
- [x] 新增获取工作流任务实例日志详情接口
- [x] 新增根据工作流和任务名获取某一个数据时间运行日志详情
- [x] 单独分离测试代码
- [ ] 需求是会逐渐增长的！

### 调整内容

调整内容主要包含以下内容：

>- 测试全部分离到 test 下
>- DEMO 类独立作为 API 借口实现
>- Maven 支持外网环境打包把依赖包全部打包到 lib 目录下
>- 内网环境可注释到 Maven 依赖，通过导入本地包方式导入 lib 目录下依赖包

### 新增内容

新增内容主要包含以下内容：

>- DEMO 类新增查看任务实例运行情况 taskInstanceList 方法
>- DEMO 类新增获取任务 ID 方法 getTaskID
>- DEMO 类新增任务实例日志列表方法
>- DEMO 串联通过工作流 ID 和任务 ID 获取某一具体任务实例的日志信息
>- 测试新增获取任务实例列表测试方法 taskInstanceTest
>- 测试新增获取任务实例日志详情测试方法 taskInstanceLog

## 版本信息

当前版本为 1.0.1

历史版本为 1.0.0

## 调整详情

### 测试代码调整

之前代码测试代码和 DEMO 业务实现代码内，现在测试代码必须放到 test 下。

1. junit 依赖 scope 设置为 test，如下
![scop test](https://v4liulv.github.io/assets/image/20200518_1.png)

2. 新增测试类 WorkFlowTest，并且迁移测试代码块到该类下
![workFlowTest](https://v4liulv.github.io/assets/image/20200518_2.png)

迁移的测试方法包含：

- 创建工作流 createTest
- 启动工作流 startTest
- 停止工作流 stopTest
- 删除工作流 deleteTest
- 工作流串联 workflowSeries
- 重跑工作流任务实例 triggerTaskTest

### 测试 resources 调整

之前版本直接 mian 进行测试，那么配置 main 的 resources 即可，但是现在测试全部调整到 test 下，那么需要复制一份 main 下 resource 到测试的 resources 下。

**main 下 resources**
![main-resources](https://v4liulv.github.io/assets/image/20200518_3.png)

**复制到 test 的 resources 后**
![test-resources](https://v4liulv.github.io/assets/image/20200518_4.png)

### maven 打包调整

中行现场都是内网开发，内网私库还不完善，每次折腾这个包消耗大量时间。基于这个问题 maven 打包进行了调整可以在外面把全部的依赖包下载到工程的 lib 下，这样内网即可直接注释掉 maven 依赖部分，直接使用 lib 下依赖包即可。

要实现这功能需要调整的部分有：

1. maven 新增打包依赖包下载到 lib 目录下
![新增package-lib](https://v4liulv.github.io/assets/image/20200518_5.png)

2. 外网环境进行编译打包（可不执行），因提供包的时候已经打好依赖包到 lib 下
![检查编译](https://v4liulv.github.io/assets/image/20200518_6.png)
![lib](https://v4liulv.github.io/assets/image/20200518_8.png)

3. 内网环境注释掉 maven 全部依赖配置
![注释依赖1](https://v4liulv.github.io/assets/image/20200518_9.png)

4. Project Structure 的 Libraries 添加 Java 配置 lib 目录，并且选择 Model
![注释依赖2](https://v4liulv.github.io/assets/image/20200518_10.png)

5. 查看包并检查是否已经可编译
![编译](https://v4liulv.github.io/assets/image/20200518_11.png)
![日志列表测试](https://v4liulv.github.io/assets/image/20200518_13.png)

## 新增详情

新增的内容主要是基于上传版本没有，现在比较确定的需求接口，比如任务实例列表、任务实例日志列表、任务实例日志详情等。

相关新增工作流 API 接口说明可参考**工作流 API 任务实例和日志接口说明。doc**相关文档。

### 获取任务 ID 方法

获取任务 ID 方法的方法名为 getTaskID，实现功能是通过工作流名和任务名称获取对应的任务 ID。

方法说明
|  所属类   | 方法名  |  参数说明   | 返回值  |
|  ----  | ----  |  ----  | ----  |
| WorkflowDemo  | getTaskID | 参数有两个工作流名和任务名  | 任务 ID |

参数说明
|  参数名   | 参数类型  |  参数说明   |
|  ----  | ----  |  ----  |
| workflowName  | String | 工作流名称  |
| taskName  | String | 任务名称  |

**功能实现：**

1. 通过工作流名调用获取任务列表方法，解析结果报文获取到任务列表数组。
2. 循环任务列表数组获取到任务名是否跟输入值任务名是否相同。
3. 匹配上的解析报文中获取到任务 ID。

**代码实现：**

```java
  /**
     * 获取taskID
     *
     * @param workflowName 工作流名称
     * @param taskName task 名称
     * @return 请求报文json
     */
    public static String getTaskID(String workflowName, String taskName) throws Exception {
        String taskList = queryTaskList(workflowName);
        String taskId = null;

        JSONObject jsonObject  = JSONObject.parseObject(taskList);
        JSONObject resultData = jsonObject.getJSONObject("resultData");
        JSONArray content = resultData.getJSONArray("content");

        for (int i = 0; i< content.size(); i++){
            JSONObject jsonObject1 = content.getJSONObject(i);
            String taskName1 = jsonObject1.getString("taskName");
            if(taskName.equals(taskName1)){
                taskId = jsonObject1.getString("taskId");
            }
        }
        return taskId;
    }
```

### 任务实例列表方法和测试方法

任务实例列表方法通过工作流名和任务名获取的全部的任务实例列表情况。

#### 任务实例列表方法

方法说明

|  所属类   | 方法名  |  参数说明   | 返回值  |
|  ----  | ----  |  ----  | ----  |
| WorkflowDemo  | taskInstanceList | 参数有两个工作流名和任务名  | 结果报文 |

参数说明

|  参数名   | 参数类型  |  参数说明   |
|  ----  | ----  |  ----  |
| workflowName  | String | 工作流名称  |
| taskName  | String | 任务名称  |

**功能实现：**

1. 先通过获取任务 ID 方法获取任务 ID。
2. 通过任务 ID 获取和其他请求参数查询获取任务实例列表 API 接口。
3. 返回结果任务实例列表结果报文。

**代码实现：**

```java
   /**
     * 查看任务实例情况
     *
     * @param workflowName 工作流名
     * @param taskName 任务名称
     */
    public static String taskInstanceList(String workflowName, String taskName) throws Exception {
        String taskID = getTaskID(workflowName, taskName);
        String method = "GET";
        Map<String, String> params = new HashMap<>();
        params.put("pageIndex", "0");
        params.put("pageSize", "5");
        params.put("condition[taskParam]", taskID);
        //params.put("condition[status]", "2");
        String url = properties.getProperty("tbds_proter_ip") + properties.getProperty("tbds_task_instance_url");
        return publicHttps(url, method, params);
    }
```

特别注意：接口的 URL 地址、请求参数、结果报文说明请查阅**工作流 API 任务实例和日志接口说明。doc**文档。

#### 任务实例列表测试方法

是进行任务列表方法的测试验证的测试方法，测试方法中工作流名和任务名称请根据实际情况调整。

**测试代码：**

```java
    @Test
    public void taskInstanceTest() throws Exception {
        String workflowName = "doc";
        String taskName = "compress-doc";
        WorkflowDemo.taskInstanceList(workflowName, taskName);
    }

```

**特别注意：** 测试方法后续都在 test 目录下，并且测试类统一都一样为 WorkFlowTest，后续不作说明。

**测试情况如下图：**
![日志列表测试](https://v4liulv.github.io/assets/image/20200518_14.png)


### 任务实例日志列表方法和测试方法

#### 任务实例日志列表方法

任务实例下可能存在多个日志情况，可能是人工重跑或异常重跑，如正常情况是一个任务实例是只有一个日志情况。

如需要获取某个任务实例的日志详情首先得需要获取对应的任务实例的对应的日志列表，按需求获取某个或全部的日志详情信息。
**功能实现**

1. 通过工作流名和任务名获取任务 ID
2. 根据任务 ID 获取对应的任务实例列表
3. 如获取第一个任务实例的获取数据时间
4. 根据 1 中 taskID 和 3 的数据时间获取到对应任务实例全部的日志类别

***代码实现***

```java
 /**
     *
     * @param workflowName 工作流名
     * @param taskName 任务名
     *
     * @return 任务实例日志列表结果报文
     */
    public static String taskInstanceLogList(String workflowName, String taskName) throws Exception {
        String method = "GET";
        Map<String, String> params = new HashMap<>();
        params.put("taskId", getTaskID(workflowName, taskName));
        String listLogListURL = properties.getProperty("tbds_proter_ip") + properties.getProperty("tbds_task_instance_log_list");
        String taskInstanceList = taskInstanceList(workflowName, taskName);

        JSONObject rRoot = JSONObject.parseObject(taskInstanceList);
        //任务实例JSONArray
        JSONArray content = rRoot.getJSONObject("resultData").getJSONArray("content");

        //最新的那个任务实例getJSONObject(1)
        String dataTime = content.getJSONObject(1).get("dataTime").toString();
        params.put("dataTime", dataTime);
        return publicHttps(listLogListURL, method, params);
    }
```

#### 任务实例日志列表测试方法

测试任务实例日志类别，其中的参数工作流名和任务名称根据实际情况调整。

**测试代码：**

```java

    @Test
    public void taskInstanceLogList() throws Exception {
        String workflowName = "doc";
        String taskName = "compress-doc";
        WorkflowDemo.taskInstanceLogList(workflowName, taskName);
    }
```

**测试情况如下图：**
![日志列表测试](https://v4liulv.github.io/assets/image/20200518_15.png)

### 任务实例日志详情方法和测试方法

需要获取根据工作流名和任务名获取任务实例的某个或多个日志详情。

#### 任务实例日志详情方法

功能实现

1. 根据任务实例日志列表方法获取到任务实例
2. 通过任务 ID 和数据时间获取任务实例日志列表
3. 根据日志列表获取某个日志列表的 IP 和尝试次数值
4. 根据任务 ID、数据时间、IP、尝试次数值获取详细日志

代码实现

```java
 String taskID = getTaskID(workflowName, taskName);
        String method = "GET";

        Map<String, String> params = new HashMap<>();
        params.put("taskId", taskID);
        String listLogListURL = properties.getProperty("tbds_proter_ip") + properties.getProperty("tbds_task_instance_log_list");
        String taskInstanceList = taskInstanceList(workflowName, taskName);

        JSONObject rRoot = JSONObject.parseObject(taskInstanceList);
        //任务实例JSONArray
        JSONArray content = rRoot.getJSONObject("resultData").getJSONArray("content");

//////////////////////////////////////////////////////////////////////////////////////////////////////
        //最新的那个任务实例getJSONObject(1)
        String dataTime = content.getJSONObject(1).get("dataTime").toString();
        params.put("dataTime", dataTime);
        String listLogList = publicHttps(listLogListURL, method, params);
        //{
        //   "resultCode":"0",
        //   "message":null,
        //   "resultData":
        //   [
        //      "18K,
        //      2020-05-13 09:01:22,
        //      172.27.0.124,
        //      1"
        //   ],

        //   "markInfo":null
        //}
        // --------------------------------------

        //params.put("condition[status]", "2");
        String url = properties.getProperty("tbds_proter_ip") + properties.getProperty("tbds_task_instance_log_info");
        //查询单个任务实例下的任务列表
        String resultData = JSONObject.parseObject(listLogList).getJSONArray("resultData").get(0).toString();

        //任务调度器的代理服务器IP，也就是任务实例执行的客户端IP
        params.put("ip", resultData.split(",")[2]);
        params.put("tries", resultData.split(",")[3]);

        String resultResponse = publicHttps(url, method, params);
        System.out.println(resultResponse);

        return resultResponse;

```

#### 任务实例日志详情测试方法

测试方法主要测试获取到的某个任务实例的某个日志的日志详情。

测试代码

```java
    @Test
    public void taskInstanceLog() throws Exception {
        String workflowName = "doc";
        String taskName = "compress-doc";
        WorkflowDemo.taskInstanceLogInfo(workflowName, taskName);
    }
```

**测试情况如下图：**
![日志详情测试](https://v4liulv.github.io/assets/image/20200518_16.png)
